# 🎯 模板列表功能文档

## 📋 功能概述

模板列表功能为记忆学习模态窗的侧边栏添加了模板信息查看和管理能力。用户可以在编辑模式下查看当前卡片使用的模板，浏览所有可用模板，并获得模板不匹配的友好提示。

## ✨ 核心特性

### 1. 智能模板状态检测
- **完全匹配**: 卡片使用插件模板系统中的标准模板
- **模板不存在**: 卡片使用的模板ID在系统中不存在
- **外部模板**: 卡片使用非插件模板系统的模板
- **自动推荐**: 为不匹配的卡片推荐合适的模板

### 2. 直观的视觉指示
- **⭐ 符号**: 标识当前卡片使用的模板
- **⚠️ 警告**: 显示模板不匹配状态
- **官方/用户标签**: 区分模板来源
- **推荐标识**: 突出显示推荐模板

### 3. 友好的用户体验
- **编辑模式限制**: 仅在编辑模式下显示模板按钮
- **非侵入式提示**: 警告不会阻断正常学习流程
- **键盘支持**: 支持ESC键关闭菜单
- **点击外部关闭**: 点击菜单外部自动关闭

## 🎨 界面设计

### 模板按钮状态

#### 正常状态
```
┌─────────┐
│ 📋 模板  │
└─────────┘
```

#### 警告状态
```
┌─────────┐
│ 📋 模板  │🔴
└─────────┘
```

### 模板菜单布局

```
┌─────────────────────────────┐
│ 📋 模板信息                  │
├─────────────────────────────┤
│ 当前模板                     │
│ ⭐ 通用问答题 (当前) [官方]  │
│ ⚠️ 当前模板不在系统中        │
│   建议选择合适的模板        │
├─────────────────────────────┤
│ 可用模板                     │
│   通用问答题        [官方]  │
│   选择题            [官方]  │
│   挖空题            [官方]  │
│   自定义模板1       [用户]  │
└─────────────────────────────┘
```

## 🔧 技术实现

### 核心组件

#### 1. TemplateStatusService
```typescript
// 模板状态检测服务
export class TemplateStatusService {
  checkTemplateStatus(card: Card, templates: ParseTemplate[]): TemplateStatusInfo
  getTemplateDisplayName(template: ParseTemplate | null): string
  getStatusDisplayText(status: TemplateMatchStatus): string
}
```

#### 2. VerticalToolbar 扩展
```typescript
// 新增props
interface Props {
  templates?: ParseTemplate[];  // 模板列表数据
  // ... 其他现有props
}

// 新增状态
let showTemplateMenu = $state(false);
let templateStatusInfo = $state<TemplateStatusInfo | null>(null);
```

#### 3. StudyModal 集成
```typescript
// 模板数据传递
<VerticalToolbar
  templates={availableTemplates}
  // ... 其他props
/>
```

### 数据流架构

```
StudyModal
    ↓ (获取模板数据)
TemplateStore/Settings
    ↓ (传递模板列表)
VerticalToolbar
    ↓ (检测模板状态)
TemplateStatusService
    ↓ (返回状态信息)
模板菜单UI
```

## 📊 模板状态类型

### TemplateMatchStatus 枚举

| 状态 | 描述 | 视觉指示 | 用户提示 |
|------|------|----------|----------|
| `PERFECT_MATCH` | 完全匹配 | ⭐ | 无 |
| `NOT_FOUND` | 模板不存在 | ⚠️ | "当前卡片使用的模板不存在于插件模板系统中" |
| `SYSTEM_EXTERNAL` | 外部模板 | ⚠️ | "当前模板不是插件模板系统中的标准模板" |
| `PARTIAL_MATCH` | 部分匹配 | ⚠️ | 自定义提示信息 |
| `DEPRECATED` | 已废弃 | ⚠️ | "当前模板已废弃，建议更换" |

## 🎯 使用场景

### 场景1: 正常学习流程
1. 用户进入记忆学习模态窗
2. 在预览模式下正常学习
3. 模板按钮不显示，不干扰学习

### 场景2: 编辑模式查看模板
1. 用户点击编辑按钮进入编辑模式
2. 模板按钮出现在侧边栏
3. 点击模板按钮查看当前模板信息
4. 浏览所有可用模板

### 场景3: 模板不匹配处理
1. 系统检测到模板不匹配
2. 模板按钮显示警告指示器
3. 用户点击查看详细信息
4. 系统提供推荐模板和友好提示

## 🔍 测试验证

### 测试用例

#### 1. 功能测试
- [ ] 编辑模式下模板按钮正确显示
- [ ] 预览模式下模板按钮正确隐藏
- [ ] 模板菜单正确显示当前模板信息
- [ ] 可用模板列表完整显示
- [ ] 模板状态检测准确

#### 2. 交互测试
- [ ] 点击模板按钮打开/关闭菜单
- [ ] 点击外部区域关闭菜单
- [ ] ESC键关闭菜单
- [ ] 模板状态指示器正确显示

#### 3. 状态测试
- [ ] 官方模板显示⭐标识
- [ ] 不存在模板显示⚠️警告
- [ ] 外部模板显示⚠️警告
- [ ] 推荐模板正确标识

### 测试数据

```typescript
// 测试卡片
const testCards = [
  { templateId: 'official-qa' },      // 正常匹配
  { templateId: 'external-template' }, // 外部模板
  { templateId: 'non-existent' }      // 不存在
];

// 测试模板
const testTemplates = [
  { id: 'official-qa', isOfficial: true },
  { id: 'user-custom', isOfficial: false }
];
```

## 🚀 性能优化

### 缓存策略
- **模板状态缓存**: 避免重复计算模板状态
- **模板数据缓存**: 减少模板数据查询
- **按需加载**: 仅在编辑模式下加载模板功能

### 内存管理
- **事件监听器清理**: 组件销毁时清理事件监听器
- **缓存清理**: 提供缓存清理机制
- **防抖处理**: 优化用户交互响应

## 🔮 未来扩展

### 可能的增强功能
1. **模板切换**: 允许用户直接切换卡片模板
2. **模板预览**: 显示模板的渲染效果预览
3. **模板统计**: 显示模板使用统计信息
4. **批量操作**: 支持批量修改卡片模板
5. **模板验证**: 实时验证模板兼容性

### 集成扩展
1. **设置页面集成**: 从模板菜单直接跳转到设置页面
2. **模板编辑器**: 内联模板编辑功能
3. **导入导出**: 模板导入导出功能
4. **版本管理**: 模板版本控制和回滚

## 📝 开发注意事项

### 代码规范
- 遵循 Svelte 5 Runes 模式
- 使用 TypeScript 严格类型检查
- 保持组件职责单一
- 实现适当的错误处理

### 可访问性
- 添加适当的 ARIA 属性
- 支持键盘导航
- 提供屏幕阅读器支持
- 确保颜色对比度符合标准

### 兼容性
- 保持向后兼容性
- 优雅降级处理
- 错误边界保护
- 性能监控和优化

---

**版本**: v1.0  
**创建日期**: 2025年1月  
**最后更新**: 2025年1月  
**维护者**: Tuanki开发团队
