"use strict";var e,t,n,i,a,r,s,o,l,c,d,u,h,p,g,v,f,m,y,b,w,k,S,x,_,C,I,D,T,M,A,E,z,P,R,$,O,L,N,F,B,j,U,V,q,H,W,G,Q=Object.create,K=Object.defineProperty,Z=Object.getOwnPropertyDescriptor,Y=(Object.getOwnPropertyNames,Object.getPrototypeOf,Object.prototype.hasOwnProperty,(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e)),X=e=>{throw TypeError(e)},J=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ee=(e,t)=>K(e,"name",{value:t,configurable:!0}),te=e=>{var t;return[,,,Q(null!=(t=null==e?void 0:e[Y("metadata")])?t:null)]},ne=["class","method","getter","setter","accessor","field","value","get","set"],ie=e=>void 0!==e&&"function"!=typeof e?X("Function expected"):e,ae=(e,t,n,i,a)=>({kind:ne[e],name:t,metadata:i,addInitializer:e=>n._?X("Already initialized"):a.push(ie(e||null))}),re=(e,t,n,i)=>{for(var a=0,r=e[t>>1],s=r&&r.length;a<s;a++)1&t?r[a].call(n):i=r[a].call(n,i);return i},se=(e,t,n,i,a,r)=>{var s,o,l,c,d,u=7&t,h=!!(8&t),p=!!(16&t),g=u>3?e.length+1:u?h?1:2:0,v=ne[u+5],f=u>3&&(e[g-1]=[]),m=e[g]||(e[g]=[]),y=u&&(!p&&!h&&(a=a.prototype),u<5&&(u>3||!p)&&Z(u<4?a:{get[n](){return de(this,r)},set[n](e){return he(this,r,e)}},n));u?p&&u<4&&ee(r,(u>2?"set ":u>1?"get ":"")+n):ee(a,n);for(var b=i.length-1;b>=0;b--)c=ae(u,n,l={},e[3],m),u&&(c.static=h,c.private=p,d=c.access={has:p?e=>ce(a,e):e=>n in e},3^u&&(d.get=p?e=>(1^u?de:pe)(e,a,4^u?r:y.get):e=>e[n]),u>2&&(d.set=p?(e,t)=>he(e,a,t,4^u?r:y.set):(e,t)=>e[n]=t)),o=(0,i[b])(u?u<4?p?r:y[v]:u>4?void 0:{get:y.get,set:y.set}:a,c),l._=1,4^u||void 0===o?ie(o)&&(u>4?f.unshift(o):u?p?r=o:y[v]=o:a=o):"object"!=typeof o||null===o?X("Object expected"):(ie(s=o.get)&&(y.get=s),ie(s=o.set)&&(y.set=s),ie(s=o.init)&&f.unshift(s));return u||((e,t)=>{J(t,Y("metadata"),e[3])})(e,a),y&&K(a,n,y),p?4^u?r:y:a},oe=(e,t,n)=>J(e,"symbol"!=typeof t?t+"":t,n),le=(e,t,n)=>t.has(e)||X("Cannot "+n),ce=(e,t)=>Object(t)!==t?X('Cannot use the "in" operator on this value'):e.has(t),de=(e,t,n)=>(le(e,t,"read from private field"),n?n.call(e):t.get(e)),ue=(e,t,n)=>t.has(e)?X("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),he=(e,t,n,i)=>(le(e,t,"write to private field"),i?i.call(e,n):t.set(e,n),n),pe=(e,t,n)=>(le(e,t,"access private method"),n);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const ge=require("obsidian"),ve=require("child_process"),fe=require("fs");require("path");const me=require("crypto");function ye(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e)for(const n in e)if("default"!==n){const i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:()=>e[n]})}return t.default=e,Object.freeze(t)}const be=ye(ge),we=ye(ve),ke=ye(me),Se=class e{constructor(){oe(this,"debugMode",!1),oe(this,"enableTimestamp",!0),oe(this,"performanceMarks",new Map)}static getInstance(){return e.instance||(e.instance=new e),e.instance}setDebugMode(e){this.debugMode=e}isDebugMode(){return this.debugMode}debug(e,...t){if(this.debugMode&&"undefined"!=typeof console&&console.log){this.formatPrefix("DEBUG")}}info(e,...t){if(this.debugMode&&"undefined"!=typeof console&&console.info){this.formatPrefix("INFO")}}warn(e,...t){if("undefined"!=typeof console&&console.warn){this.formatPrefix("WARN")}}error(e,...t){if("undefined"!=typeof console&&console.error){this.formatPrefix("ERROR")}}debugWithTag(e,t,...n){if(this.debugMode&&"undefined"!=typeof console&&console.log){this.formatPrefix("DEBUG",e)}}infoWithTag(e,t,...n){if(this.debugMode&&"undefined"!=typeof console&&console.info){this.formatPrefix("INFO",e)}}formatPrefix(e,t){return`${this.enableTimestamp?`[${(new Date).toISOString().substring(11,23)}]`:""}[${e}]${t?`[${t}]`:""}`}startTimer(e){this.debugMode&&this.performanceMarks.set(e,performance.now())}endTimer(e){if(!this.debugMode)return-1;const t=this.performanceMarks.get(e);if(void 0===t)return this.warn(`Performance timer "${e}" was not started`),-1;const n=performance.now()-t;return this.performanceMarks.delete(e),this.debug(`⏱️ ${e}: ${n.toFixed(2)}ms`),n}};oe(Se,"instance",null);let xe=Se;const _e=xe.getInstance(),Ce=(e,t,...n)=>_e.debugWithTag(e,t,...n),Ie=Object.freeze(Object.defineProperty({__proto__:null,Logger:xe,logDebugWithTag:Ce,logger:_e},Symbol.toStringTag,{value:"Module"})),De="weave-view";class Te extends ge.ItemView{constructor(e,t){super(e),oe(this,"component",null),oe(this,"plugin"),oe(this,"isClosing",!1),this.plugin=t}getViewType(){return De}getDisplayText(){return"Weave"}getIcon(){return"brain"}allowNoFile(){return!0}getNavigationType(){return"tab"}async onOpen(){this.contentEl.empty(),this.contentEl.classList.add("tuanki-view-content"),this.contentEl.classList.add("tuanki-main-editor-mode"),this.showLoadingPlaceholder(),this.loadComponentAsync()}showLoadingPlaceholder(){this.contentEl.createDiv({cls:"tuanki-view-loading",text:"正在初始化 Tuanki..."})}async loadComponentAsync(){try{await this.waitForDataStorage(),this.contentEl.empty(),this.contentEl.classList.add("tuanki-view-content"),this.contentEl.classList.add("tuanki-main-editor-mode"),await this.createMainComponent()}catch(e){_e.error("[WeaveView] 组件加载失败:",e),this.contentEl.empty(),this.contentEl.innerHTML='<div class="error">Tuanki 初始化失败</div>'}}async waitForDataStorage(){if(this.plugin.dataStorage)return;_e.debug("[WeaveView] 等待 dataStorage 初始化...");for(let e=0;e<100;e++){if(this.plugin.dataStorage)return void _e.debug(`[WeaveView] dataStorage 已就绪（耗时 ${100*e}ms）`);await new Promise(e=>setTimeout(e,100))}throw new Error("dataStorage 初始化超时")}async createMainComponent(){try{const{mount:e}=await Promise.resolve().then(()=>Or),{default:t}=await Promise.resolve().then(()=>Tbe);this.component=e(t,{target:this.contentEl,props:{plugin:this.plugin,dataStorage:this.plugin.dataStorage,fsrs:this.plugin.fsrs}})}catch(e){_e.error("Failed to create WeaveView component:",e),this.contentEl.innerHTML='<div class="error">Failed to load Weave interface</div>'}}async onClose(){if(this.isClosing)_e.debug("[WeaveView] 防止重复关闭");else{if(this.isClosing=!0,this.component)try{const{unmount:e}=await Promise.resolve().then(()=>Or);e(this.component),this.component=null}catch(e){_e.error("[WeaveView] 组件销毁失败:",e)}this.contentEl.empty()}}}const Me=Object.freeze(Object.defineProperty({__proto__:null,VIEW_TYPE_WEAVE:De,WeaveView:Te},Symbol.toStringTag,{value:"Module"})),Ae=!1;var Ee=Array.isArray,ze=Array.prototype.indexOf,Pe=Array.from,Re=Object.defineProperty,$e=Object.getOwnPropertyDescriptor,Oe=Object.getOwnPropertyDescriptors,Le=Object.prototype,Ne=Array.prototype,Fe=Object.getPrototypeOf,Be=Object.isExtensible;const je=()=>{};function Ue(e){for(var t=0;t<e.length;t++)e[t]()}function Ve(){var e,t;return{promise:new Promise((n,i)=>{e=n,t=i}),resolve:e,reject:t}}function qe(e,t){if(Array.isArray(e))return e;if(!(Symbol.iterator in e))return Array.from(e);const n=[];for(const i of e)if(n.push(i),n.length===t)break;return n}const He=16,We=32,Ge=64,Qe=128,Ke=256,Ze=512,Ye=1024,Xe=2048,Je=4096,et=8192,tt=16384,nt=32768,it=65536,at=1<<17,rt=1<<19,st=1<<21,ot=1<<23,lt=Symbol("$state"),ct=Symbol("legacy props"),dt=Symbol(""),ut=new class extends Error{constructor(){super(...arguments),oe(this,"name","StaleReactionError"),oe(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function ht(e){return e===this.v}function pt(e,t){return e!=e?t==t:e!==t||null!==e&&"object"==typeof e||"function"==typeof e}function gt(e){return!pt(e,this.v)}function vt(e){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}const ft="[!",mt={},yt=Symbol();let bt=null;function wt(e){bt=e}function kt(e,t=!1,n){bt={p:bt,c:null,e:null,s:e,x:null,l:null}}function St(e){var t=bt,n=t.e;if(null!==n)for(var i of(t.e=null,n))Mi(i);return void 0!==e&&(t.x=e),bt=t.p,null!=e?e:{}}let xt=[];function _t(){var e=xt;xt=[],Ue(e)}function Ct(e){if(0===xt.length&&!dn){var t=xt;queueMicrotask(()=>{t===xt&&_t()})}xt.push(e)}function It(){for(;xt.length>0;)_t()}let Dt,Tt=!1;function Mt(e){Tt=e}function At(e){if(null===e)throw mt;return Dt=e}function Et(){return At(Wt(Dt))}function zt(e){if(Tt){if(null!==Wt(Dt))throw mt;Dt=e}}function Pt(e=1){if(Tt){for(var t=e,n=Dt;t--;)n=Wt(n);Dt=n}}function Rt(e=!0){for(var t=0,n=Dt;;){if(8===n.nodeType){var i=n.data;if("]"===i){if(0===t)return n;t-=1}else"["!==i&&i!==ft||(t+=1)}var a=Wt(n);e&&n.remove(),n=a}}function $t(e){if(!e||8!==e.nodeType)throw mt;return e.data}function Ot(e){if("object"!=typeof e||null===e||lt in e)return e;const t=Fe(e);if(t!==Le&&t!==Ne)return e;var n=new Map,i=Ee(e),a=Pn(0),r=li,s=e=>{if(li===r)return e();var t=Zn,n=li;Xn(null),ci(r);var i=e();return Xn(t),ci(n),i};return i&&n.set("length",Pn(e.length)),new Proxy(e,{defineProperty(e,t,i){"value"in i&&!1!==i.configurable&&!1!==i.enumerable&&!1!==i.writable||function(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}();var a=n.get(t);return void 0===a?a=s(()=>{var e=Pn(i.value);return n.set(t,e),e}):$n(a,i.value,!0),!0},deleteProperty(e,t){var i=n.get(t);if(void 0===i){if(t in e){const e=s(()=>Pn(yt));n.set(t,e),Nn(a)}}else $n(i,yt),Nn(a);return!0},get(t,i,a){var r;if(i===lt)return e;var o=n.get(i),l=i in t;if(void 0!==o||l&&!(null==(r=$e(t,i))?void 0:r.writable)||(o=s(()=>Pn(Ot(l?t[i]:yt))),n.set(i,o)),void 0!==o){var c=bi(o);return c===yt?void 0:c}return Reflect.get(t,i,a)},getOwnPropertyDescriptor(e,t){var i=Reflect.getOwnPropertyDescriptor(e,t);if(i&&"value"in i){var a=n.get(t);a&&(i.value=bi(a))}else if(void 0===i){var r=n.get(t),s=null==r?void 0:r.v;if(void 0!==r&&s!==yt)return{enumerable:!0,configurable:!0,value:s,writable:!0}}return i},has(e,t){var i;if(t===lt)return!0;var a=n.get(t),r=void 0!==a&&a.v!==yt||Reflect.has(e,t);if((void 0!==a||null!==Jn&&(!r||(null==(i=$e(e,t))?void 0:i.writable)))&&(void 0===a&&(a=s(()=>Pn(r?Ot(e[t]):yt)),n.set(t,a)),bi(a)===yt))return!1;return r},set(e,t,r,o){var l,c=n.get(t),d=t in e;if(i&&"length"===t)for(var u=r;u<c.v;u+=1){var h=n.get(u+"");void 0!==h?$n(h,yt):u in e&&(h=s(()=>Pn(yt)),n.set(u+"",h))}void 0===c?d&&!(null==(l=$e(e,t))?void 0:l.writable)||($n(c=s(()=>Pn(void 0)),Ot(r)),n.set(t,c)):(d=c.v!==yt,$n(c,s(()=>Ot(r))));var p=Reflect.getOwnPropertyDescriptor(e,t);if((null==p?void 0:p.set)&&p.set.call(o,r),!d){if(i&&"string"==typeof t){var g=n.get("length"),v=Number(t);Number.isInteger(v)&&v>=g.v&&$n(g,v+1)}Nn(a)}return!0},ownKeys(e){bi(a);var t=Reflect.ownKeys(e).filter(e=>{var t=n.get(e);return void 0===t||t.v!==yt});for(var[i,r]of n)r.v===yt||i in e||t.push(i);return t},setPrototypeOf(){!function(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}()}})}function Lt(e){try{if(null!==e&&"object"==typeof e&&lt in e)return e[lt]}catch(t){}return e}function Nt(e,t){return Object.is(Lt(e),Lt(t))}var Ft,Bt,jt,Ut;function Vt(){if(void 0===Ft){Ft=window,Bt=/Firefox/.test(navigator.userAgent);var e=Element.prototype,t=Node.prototype,n=Text.prototype;jt=$e(t,"firstChild").get,Ut=$e(t,"nextSibling").get,Be(e)&&(e.__click=void 0,e.__className=void 0,e.__attributes=null,e.__style=void 0,e.__e=void 0),Be(n)&&(n.__t=void 0)}}function qt(e=""){return document.createTextNode(e)}function Ht(e){return jt.call(e)}function Wt(e){return Ut.call(e)}function Gt(e,t){if(!Tt)return Ht(e);var n=Ht(Dt);if(null===n)n=Dt.appendChild(qt());else if(t&&3!==n.nodeType){var i=qt();return null==n||n.before(i),At(i),i}return At(n),n}function Qt(e,t=!1){if(!Tt){var n=Ht(e);return n instanceof Comment&&""===n.data?Wt(n):n}if(t&&3!==(null==Dt?void 0:Dt.nodeType)){var i=qt();return null==Dt||Dt.before(i),At(i),i}return Dt}function Kt(e,t=1,n=!1){let i=Tt?Dt:e;for(var a;t--;)a=i,i=Wt(i);if(!Tt)return i;if(n&&3!==(null==i?void 0:i.nodeType)){var r=qt();return null===i?null==a||a.after(r):i.before(r),At(r),r}return At(i),i}function Zt(e){e.textContent=""}const Yt=new WeakMap;function Xt(e){var t=Jn;if(null===t)return Zn.f|=ot,e;if(0===(t.f&nt)){if(0===(t.f&Qe))throw!t.parent&&e instanceof Error&&en(e),e;t.b.error(e)}else Jt(e,t)}function Jt(e,t){for(;null!==t;){if(0!==(t.f&Qe))try{return void t.b.error(e)}catch(n){e=n}t=t.parent}throw e instanceof Error&&en(e),e}function en(e){const t=Yt.get(e);t&&(Re(e,"message",{value:t.message}),Re(e,"stack",{value:t.stack}))}const tn=new Set;let nn=null,an=null,rn=null,sn=new Set,on=[],ln=null,cn=!1,dn=!1;e=new WeakMap,t=new WeakMap,n=new WeakMap,i=new WeakMap,a=new WeakMap,r=new WeakMap,s=new WeakMap,o=new WeakSet,l=function(e,t){var n;e.f^=Ye;for(var i=e.first;null!==i;){var a=i.f,r=!!(96&a),s=r&&0!==(a&Ye)||0!==(a&et)||this.skipped_effects.has(i);if(0!==(i.f&Qe)&&(null==(n=i.b)?void 0:n.is_pending())&&(t={parent:t,effect:i,effects:[],render_effects:[],block_effects:[]}),!s&&null!==i.fn){r?i.f^=Ye:4&a?t.effects.push(i):hi(i)&&(0!==(i.f&He)&&t.block_effects.push(i),mi(i));var l=i.first;if(null!==l){i=l;continue}}var d=i.parent;for(i=i.next;null===i&&null!==d;)d===t.effect&&(pe(this,o,c).call(this,t.effects),pe(this,o,c).call(this,t.render_effects),pe(this,o,c).call(this,t.block_effects),t=t.parent),i=d.next,d=d.parent}},c=function(e){for(const t of e){(0!==(t.f&Xe)?de(this,r):de(this,s)).push(t),xi(t,Ye)}},d=function(){if(0===de(this,i)){for(const e of de(this,t))e();de(this,t).clear()}0===de(this,n)&&pe(this,o,u).call(this)},u=function(){var t,n;if(tn.size>1){de(this,e).clear();var i=rn,r=!0,s={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const e of tn){if(e===this){r=!1;continue}const n=[];for(const[t,a]of this.current){if(e.current.has(t)){if(!r||a===e.current.get(t))continue;e.current.set(t,a)}n.push(t)}if(0===n.length)continue;const i=[...e.current.keys()].filter(e=>!this.current.has(e));if(i.length>0){for(const e of n)mn(e,i);if(on.length>0){nn=e,e.apply();for(const n of on)pe(t=e,o,l).call(t,n,s);on=[],e.deactivate()}}}nn=null,rn=i}this.committed=!0,tn.delete(this),null==(n=de(this,a))||n.resolve()};let un=class u{constructor(){ue(this,o),oe(this,"committed",!1),oe(this,"current",new Map),ue(this,e,new Map),ue(this,t,new Set),ue(this,n,0),ue(this,i,0),ue(this,a,null),ue(this,r,[]),ue(this,s,[]),oe(this,"skipped_effects",new Set)}process(e){on=[],an=null,this.apply();var t={parent:null,effect:null,effects:[],render_effects:[],block_effects:[]};for(const n of e)pe(this,o,l).call(this,n,t);pe(this,o,d).call(this),de(this,i)>0?(pe(this,o,c).call(this,t.effects),pe(this,o,c).call(this,t.render_effects),pe(this,o,c).call(this,t.block_effects)):(an=this,nn=null,fn(t.render_effects),fn(t.effects),an=null),rn=null}capture(t,n){de(this,e).has(t)||de(this,e).set(t,n),this.current.set(t,t.v),null==rn||rn.set(t,t.v)}activate(){nn=this}deactivate(){nn=null,rn=null}flush(){if(on.length>0){if(this.activate(),pn(),null!==nn&&nn!==this)return}else pe(this,o,d).call(this);this.deactivate();for(const e of sn)if(sn.delete(e),e(),null!==nn)break}increment(e){he(this,n,de(this,n)+1),e&&he(this,i,de(this,i)+1)}decrement(e){he(this,n,de(this,n)-1),e&&he(this,i,de(this,i)-1);for(const t of de(this,r))xi(t,Xe),bn(t);for(const t of de(this,s))xi(t,Je),bn(t);he(this,r,[]),he(this,s,[]),this.flush()}add_callback(e){de(this,t).add(e)}settled(){var e;return(null!=(e=de(this,a))?e:he(this,a,Ve())).promise}static ensure(){if(null===nn){const e=nn=new u;tn.add(nn),dn||u.enqueue(()=>{nn===e&&e.flush()})}return nn}static enqueue(e){Ct(e)}apply(){}};function hn(e){var t=dn;dn=!0;try{for(;;){if(It(),0===on.length&&(null==nn||nn.flush(),0===on.length))return void(ln=null);pn()}}finally{dn=t}}function pn(){var e=Wn;cn=!0;try{var t=0;for(Gn(!0);on.length>0;){var n=un.ensure();if(t++>1e3)Ae,gn();n.process(on),En.clear()}}finally{cn=!1,Gn(e),ln=null}}function gn(){try{!function(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}()}catch(e){Jt(e,ln)}}let vn=null;function fn(e){var t=e.length;if(0!==t){for(var n=0;n<t;){var i=e[n++];if(!(24576&i.f)&&hi(i)&&(vn=new Set,mi(i),null===i.deps&&null===i.first&&null===i.nodes_start&&(null===i.teardown&&null===i.ac?Fi(i):i.fn=null),(null==vn?void 0:vn.size)>0)){En.clear();for(const e of vn){if(24576&e.f)continue;const t=[e];let n=e.parent;for(;null!==n;)vn.has(n)&&(vn.delete(n),t.push(n)),n=n.parent;for(let e=t.length-1;e>=0;e--){const n=t[e];24576&n.f||mi(n)}}vn.clear()}}vn=null}}function mn(e,t){if(null!==e.reactions)for(const n of e.reactions){const e=n.f;2&e?mn(n,t):4194320&e&&yn(n,t)&&(xi(n,Xe),bn(n))}}function yn(e,t){if(null!==e.deps)for(const n of e.deps){if(t.includes(n))return!0;if(2&n.f&&yn(n,t))return!0}return!1}function bn(e){for(var t=ln=e;null!==t.parent;){var n=(t=t.parent).f;if(cn&&t===Jn&&0!==(n&He))return;if(96&n){if(0===(n&Ye))return;t.f^=Ye}}on.push(t)}function wn(e){let t,n=0,i=zn(0);return()=>{null===Zn||Yn||(bi(i),Ei(()=>(0===n&&(t=ki(()=>e(()=>Nn(i)))),n+=1,()=>{Ct(()=>{n-=1,0===n&&(null==t||t(),t=void 0,Nn(i))})})))}}class kn{constructor(e,t,n){ue(this,T),oe(this,"parent"),ue(this,h,!1),ue(this,p),ue(this,g,Tt?Dt:null),ue(this,v),ue(this,f),ue(this,m),ue(this,y,null),ue(this,b,null),ue(this,w,null),ue(this,k,null),ue(this,S,0),ue(this,x,0),ue(this,_,!1),ue(this,C,null),ue(this,I,()=>{de(this,C)&&On(de(this,C),de(this,S))}),ue(this,D,wn(()=>(he(this,C,zn(de(this,S))),()=>{he(this,C,null)}))),he(this,p,e),he(this,v,t),he(this,f,n),this.parent=Jn.b,he(this,h,!!de(this,v).pending),he(this,m,Pi(()=>{if(Jn.b=this,Tt){const e=de(this,g);Et();8===e.nodeType&&e.data===ft?pe(this,T,A).call(this):pe(this,T,M).call(this)}else{try{he(this,y,Ri(()=>n(de(this,p))))}catch(e){this.error(e)}de(this,x)>0?pe(this,T,z).call(this):he(this,h,!1)}},589952)),Tt&&he(this,p,Dt)}is_pending(){return de(this,h)||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!de(this,v).pending}update_pending_count(e){pe(this,T,P).call(this,e),he(this,S,de(this,S)+e),sn.add(de(this,I))}get_effect_pending(){return de(this,D).call(this),bi(de(this,C))}error(e){var t=de(this,v).onerror;let n=de(this,v).failed;if(de(this,_)||!t&&!n)throw e;de(this,y)&&(Li(de(this,y)),he(this,y,null)),de(this,b)&&(Li(de(this,b)),he(this,b,null)),de(this,w)&&(Li(de(this,w)),he(this,w,null)),Tt&&(At(de(this,g)),Pt(),At(Rt()));var i=!1,a=!1;const r=()=>{i||(i=!0,a&&function(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}(),un.ensure(),he(this,S,0),null!==de(this,w)&&Bi(de(this,w),()=>{he(this,w,null)}),he(this,h,this.has_pending_snippet()),he(this,y,pe(this,T,E).call(this,()=>(he(this,_,!1),Ri(()=>de(this,f).call(this,de(this,p)))))),de(this,x)>0?pe(this,T,z).call(this):he(this,h,!1))};var s=Zn;try{Xn(null),a=!0,null==t||t(e,r),a=!1}catch(o){Jt(o,de(this,m)&&de(this,m).parent)}finally{Xn(s)}n&&Ct(()=>{he(this,w,pe(this,T,E).call(this,()=>{he(this,_,!0);try{return Ri(()=>{n(de(this,p),()=>e,()=>r)})}catch(o){return Jt(o,de(this,m).parent),null}finally{he(this,_,!1)}}))})}}function Sn(e,t,n){const i=_n;if(0!==t.length){var a=nn,r=Jn,s=function(){var e=Jn,t=Zn,n=bt,i=nn,a=Tt;if(a)var r=Dt;return function(){ei(e),Xn(t),wt(n),null==i||i.activate(),a&&(Mt(!0),At(r))}}(),o=Tt;Promise.all(t.map(e=>Cn(e))).then(t=>{s();try{n([...e.map(i),...t])}catch(l){0===(r.f&tt)&&Jt(l,r)}o&&Mt(!1),null==a||a.deactivate(),xn()}).catch(e=>{Jt(e,r)})}else n(e.map(i))}function xn(){ei(null),Xn(null),wt(null)}function _n(e){var t=2050,n=null!==Zn&&2&Zn.f?Zn:null;null===Jn||null!==n&&0!==(n.f&Ke)?t|=Ke:Jn.f|=rt;return{ctx:bt,deps:null,effects:null,equals:ht,f:t,fn:e,reactions:null,rv:0,v:yt,wv:0,parent:null!=n?n:Jn,ac:null}}function Cn(e,t){let n=Jn;null===n&&function(){throw new Error("https://svelte.dev/e/async_derived_orphan")}();var i=n.b,a=void 0,r=zn(yt),s=!Zn,o=new Map;return function(e){Ii(4718592,e,!0)}(()=>{var t,n=Ve();a=n.promise;try{Promise.resolve(e()).then(n.resolve,n.reject).then(()=>{l===nn&&l.committed&&l.deactivate(),xn()})}catch(u){n.reject(u),xn()}var l=nn;if(s){var c=!i.is_pending();i.update_pending_count(1),l.increment(c),null==(t=o.get(l))||t.reject(ut),o.delete(l),o.set(l,n)}const d=(e,t=void 0)=>{if(l.activate(),t)t!==ut&&(r.f|=ot,On(r,t));else{0!==(r.f&ot)&&(r.f^=ot),On(r,e);for(const[e,t]of o){if(o.delete(e),e===l)break;t.reject(ut)}}s&&(i.update_pending_count(-1),l.decrement(c))};n.promise.then(d,e=>d(null,e||"unknown"))}),Di(()=>{for(const e of o.values())e.reject(ut)}),new Promise(e=>{!function t(n){function i(){n===a?e(r):t(a)}n.then(i,i)}(a)})}function In(e){const t=_n(e);return ni(t),t}function Dn(e){const t=_n(e);return t.equals=gt,t}function Tn(e){var t=e.effects;if(null!==t){e.effects=null;for(var n=0;n<t.length;n+=1)Li(t[n])}}function Mn(e){var t,n=Jn;ei(function(e){for(var t=e.parent;null!==t;){if(!(2&t.f))return t;t=t.parent}return null}(e));try{Tn(e),t=gi(e)}finally{ei(n)}return t}function An(e){var t=Mn(e);(e.equals(t)||(e.v=t,e.wv=ui()),Qn)||(null!==rn?rn.set(e,e.v):xi(e,!di&&0===(e.f&Ke)||null===e.deps?Ye:Je))}h=new WeakMap,p=new WeakMap,g=new WeakMap,v=new WeakMap,f=new WeakMap,m=new WeakMap,y=new WeakMap,b=new WeakMap,w=new WeakMap,k=new WeakMap,S=new WeakMap,x=new WeakMap,_=new WeakMap,C=new WeakMap,I=new WeakMap,D=new WeakMap,T=new WeakSet,M=function(){try{he(this,y,Ri(()=>de(this,f).call(this,de(this,p))))}catch(e){this.error(e)}he(this,h,!1)},A=function(){const e=de(this,v).pending;e&&(he(this,b,Ri(()=>e(de(this,p)))),un.enqueue(()=>{he(this,y,pe(this,T,E).call(this,()=>(un.ensure(),Ri(()=>de(this,f).call(this,de(this,p)))))),de(this,x)>0?pe(this,T,z).call(this):(Bi(de(this,b),()=>{he(this,b,null)}),he(this,h,!1))}))},E=function(e){var t=Jn,n=Zn,i=bt;ei(de(this,m)),Xn(de(this,m)),wt(de(this,m).ctx);try{return e()}catch(a){return Xt(a),null}finally{ei(t),Xn(n),wt(i)}},z=function(){const e=de(this,v).pending;null!==de(this,y)&&(he(this,k,document.createDocumentFragment()),Hi(de(this,y),de(this,k))),null===de(this,b)&&he(this,b,Ri(()=>e(de(this,p))))},P=function(e){var t;this.has_pending_snippet()?(he(this,x,de(this,x)+e),0===de(this,x)&&(he(this,h,!1),de(this,b)&&Bi(de(this,b),()=>{he(this,b,null)}),de(this,k)&&(de(this,p).before(de(this,k)),he(this,k,null)))):this.parent&&pe(t=this.parent,T,P).call(t,e)};const En=new Map;function zn(e,t){return{f:0,v:e,reactions:null,equals:ht,rv:0,wv:0}}function Pn(e,t){const n=zn(e);return ni(n),n}function Rn(e,t=!1,n=!0){const i=zn(e);return t||(i.equals=gt),i}function $n(e,t,n=!1){return null===Zn||Yn&&0===(Zn.f&at)||!(4325394&Zn.f)||(null==ti?void 0:ti.includes(e))||function(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}(),On(e,n?Ot(t):t)}function On(e,t){if(!e.equals(t)){var n=e.v;Qn?En.set(e,t):En.set(e,n),e.v=t,un.ensure().capture(e,n),2&e.f&&(0!==(e.f&Xe)&&Mn(e),xi(e,0===(e.f&Ke)?Ye:Je)),e.wv=ui(),Fn(e,Xe),null===Jn||0===(Jn.f&Ye)||96&Jn.f||(null===ri?function(e){ri=e}([e]):ri.push(e))}return t}function Ln(e,t=1){var n=bi(e),i=1===t?n++:n--;return $n(e,n),i}function Nn(e){$n(e,e.v+1)}function Fn(e,t){var n=e.reactions;if(null!==n)for(var i=n.length,a=0;a<i;a++){var r=n[a],s=r.f,o=0===(s&Xe);o&&xi(r,t),2&s?Fn(r,Je):o&&(0!==(s&He)&&null!==vn&&vn.add(r),bn(r))}}function Bn(e,t){if(t){const t=document.body;e.autofocus=!0,Ct(()=>{document.activeElement===t&&e.focus()})}}function jn(e){Tt&&null!==Ht(e)&&Zt(e)}let Un=!1;function Vn(){Un||(Un=!0,document.addEventListener("reset",e=>{Promise.resolve().then(()=>{var t;if(!e.defaultPrevented)for(const n of e.target.elements)null==(t=n.__on_r)||t.call(n)})},{capture:!0}))}function qn(e){var t=Zn,n=Jn;Xn(null),ei(null);try{return e()}finally{Xn(t),ei(n)}}function Hn(e,t,n,i=n){e.addEventListener(t,()=>qn(n));const a=e.__on_r;e.__on_r=a?()=>{a(),i(!0)}:()=>i(!0),Vn()}let Wn=!1;function Gn(e){Wn=e}let Qn=!1;function Kn(e){Qn=e}let Zn=null,Yn=!1;function Xn(e){Zn=e}let Jn=null;function ei(e){Jn=e}let ti=null;function ni(e){null!==Zn&&(null===ti?ti=[e]:ti.push(e))}let ii=null,ai=0,ri=null;let si=1,oi=0,li=oi;function ci(e){li=e}let di=!1;function ui(){return++si}function hi(e){var t,n,i=e.f;if(0!==(i&Xe))return!0;if(0!==(i&Je)){var a=e.deps,r=0!==(i&Ke);if(null!==a){var s,o,l=0!==(i&Ze),c=r&&null!==Jn&&!di,d=a.length;if((l||c)&&(null===Jn||0===(Jn.f&tt))){var u=e,h=u.parent;for(s=0;s<d;s++)o=a[s],!l&&(null==(t=null==o?void 0:o.reactions)?void 0:t.includes(u))||(null!=(n=o.reactions)?n:o.reactions=[]).push(u);l&&(u.f^=Ze),c&&null!==h&&0===(h.f&Ke)&&(u.f^=Ke)}for(s=0;s<d;s++)if(hi(o=a[s])&&An(o),o.wv>e.wv)return!0}r&&(null===Jn||di)||xi(e,Ye)}return!1}function pi(e,t,n=!0){var i=e.reactions;if(null!==i&&!(null==ti?void 0:ti.includes(e)))for(var a=0;a<i.length;a++){var r=i[a];2&r.f?pi(r,t,!1):t===r&&(n?xi(r,Xe):0!==(r.f&Ye)&&xi(r,Je),bn(r))}}function gi(e){var t,n,i=ii,a=ai,r=ri,s=Zn,o=di,l=ti,c=bt,d=Yn,u=li,h=e.f;ii=null,ai=0,ri=null,di=0!==(h&Ke)&&(Yn||!Wn||null===Zn),Zn=96&h?null:e,ti=null,wt(e.ctx),Yn=!1,li=++oi,null!==e.ac&&(qn(()=>{e.ac.abort(ut)}),e.ac=null);try{e.f|=st;var p=(0,e.fn)(),g=e.deps;if(null!==ii){var v;if(fi(e,ai),null!==g&&ai>0)for(g.length=ai+ii.length,v=0;v<ii.length;v++)g[ai+v]=ii[v];else e.deps=g=ii;if(!di||2&h&&null!==e.reactions)for(v=ai;v<g.length;v++)(null!=(n=(t=g[v]).reactions)?n:t.reactions=[]).push(e)}else null!==g&&ai<g.length&&(fi(e,ai),g.length=ai);if(!(null===ri||Yn||null===g||6146&e.f))for(v=0;v<ri.length;v++)pi(ri[v],e);return null!==s&&s!==e&&(oi++,null!==ri&&(null===r?r=ri:r.push(...ri))),0!==(e.f&ot)&&(e.f^=ot),p}catch(f){return Xt(f)}finally{e.f^=st,ii=i,ai=a,ri=r,Zn=s,di=o,ti=l,wt(c),Yn=d,li=u}}function vi(e,t){let n=t.reactions;if(null!==n){var i=ze.call(n,e);if(-1!==i){var a=n.length-1;0===a?n=t.reactions=null:(n[i]=n[a],n.pop())}}null===n&&2&t.f&&(null===ii||!ii.includes(t))&&(xi(t,Je),768&t.f||(t.f^=Ze),Tn(t),fi(t,0))}function fi(e,t){var n=e.deps;if(null!==n)for(var i=t;i<n.length;i++)vi(e,n[i])}function mi(e){var t=e.f;if(0===(t&tt)){xi(e,Ye);var n=Jn,i=Wn;Jn=e,Wn=!0;try{0!==(t&He)?function(e){var t=e.first;for(;null!==t;){var n=t.next;0===(t.f&We)&&Li(t),t=n}}(e):Oi(e),$i(e);var a=gi(e);e.teardown="function"==typeof a?a:null,e.wv=si}finally{Wn=i,Jn=n}}}async function yi(){await Promise.resolve(),hn()}function bi(e){var t,n=!!(2&e.f);if(null===Zn||Yn){if(n&&null===e.deps&&null===e.effects){var i=e,a=i.parent;null!==a&&0===(a.f&Ke)&&(i.f^=Ke)}}else if(!(null!==Jn&&0!==(Jn.f&tt))&&!(null==ti?void 0:ti.includes(e))){var r=Zn.deps;if(0!==(Zn.f&st))e.rv<oi&&(e.rv=oi,null===ii&&null!==r&&r[ai]===e?ai++:null===ii?ii=[e]:di&&ii.includes(e)||ii.push(e));else{(null!=(t=Zn.deps)?t:Zn.deps=[]).push(e);var s=e.reactions;null===s?e.reactions=[Zn]:s.includes(Zn)||s.push(Zn)}}if(Qn){if(En.has(e))return En.get(e);if(n){var o=(i=e).v;return(0===(i.f&Ye)&&null!==i.reactions||wi(i))&&(o=Mn(i)),En.set(i,o),o}}else if(n){if(i=e,null==rn?void 0:rn.has(i))return rn.get(i);hi(i)&&An(i)}if(null==rn?void 0:rn.has(e))return rn.get(e);if(0!==(e.f&ot))throw e.v;return e.v}function wi(e){if(e.v===yt)return!0;if(null===e.deps)return!1;for(const t of e.deps){if(En.has(t))return!0;if(2&t.f&&wi(t))return!0}return!1}function ki(e){var t=Yn;try{return Yn=!0,e()}finally{Yn=t}}const Si=-7169;function xi(e,t){e.f=e.f&Si|t}function _i(e,t=new Set){if(!("object"!=typeof e||null===e||e instanceof EventTarget||t.has(e))){t.add(e),e instanceof Date&&e.getTime();for(let a in e)try{_i(e[a],t)}catch(n){}const i=Fe(e);if(i!==Object.prototype&&i!==Array.prototype&&i!==Map.prototype&&i!==Set.prototype&&i!==Date.prototype){const t=Oe(i);for(let i in t){const a=t[i].get;if(a)try{a.call(e)}catch(n){}}}}}function Ci(e){null===Jn&&null===Zn&&function(){throw new Error("https://svelte.dev/e/effect_orphan")}(),null!==Zn&&0!==(Zn.f&Ke)&&null===Jn&&function(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}(),Qn&&function(){throw new Error("https://svelte.dev/e/effect_in_teardown")}()}function Ii(e,t,n,i=!0){var a,r=Jn;null!==r&&0!==(r.f&et)&&(e|=et);var s={ctx:bt,deps:null,nodes_start:null,nodes_end:null,f:e|Xe,first:null,fn:t,last:null,next:null,parent:r,b:r&&r.b,prev:null,teardown:null,transitions:null,wv:0,ac:null};if(n)try{mi(s),s.f|=nt}catch(c){throw Li(s),c}else null!==t&&bn(s);if(i){var o=s;if(n&&null===o.deps&&null===o.teardown&&null===o.nodes_start&&o.first===o.last&&0===(o.f&rt)&&(o=o.first),null!==o&&(o.parent=r,null!==r&&function(e,t){var n=t.last;null===n?t.last=t.first=e:(n.next=e,e.prev=n,t.last=e)}(o,r),null!==Zn&&2&Zn.f&&0===(e&Ge))){var l=Zn;(null!=(a=l.effects)?a:l.effects=[]).push(o)}}return s}function Di(e){const t=Ii(8,null,!1);return xi(t,Ye),t.teardown=e,t}function Ti(e){var t;Ci();var n=Jn.f;if(!(!Zn&&0!==(n&We)&&0===(n&nt)))return Mi(e);var i=bt;(null!=(t=i.e)?t:i.e=[]).push(e)}function Mi(e){return Ii(1048580,e,!1)}function Ai(e){return Ii(4,e,!1)}function Ei(e,t=0){return Ii(8|t,e,!0)}function zi(e,t=[],n=[]){Sn(t,n,t=>{Ii(8,()=>e(...t.map(bi)),!0)})}function Pi(e,t=0){return Ii(He|t,e,!0)}function Ri(e,t=!0){return Ii(524320,e,!0,t)}function $i(e){var t=e.teardown;if(null!==t){const e=Qn,n=Zn;Kn(!0),Xn(null);try{t.call(null)}finally{Kn(e),Xn(n)}}}function Oi(e,t=!1){var n=e.first;for(e.first=e.last=null;null!==n;){const e=n.ac;null!==e&&qn(()=>{e.abort(ut)});var i=n.next;0!==(n.f&Ge)?n.parent=null:Li(n,t),n=i}}function Li(e,t=!0){var n=!1;(t||262144&e.f)&&null!==e.nodes_start&&null!==e.nodes_end&&(Ni(e.nodes_start,e.nodes_end),n=!0),Oi(e,t&&!n),fi(e,0),xi(e,tt);var i=e.transitions;if(null!==i)for(const r of i)r.stop();$i(e);var a=e.parent;null!==a&&null!==a.first&&Fi(e),e.next=e.prev=e.teardown=e.ctx=e.deps=e.fn=e.nodes_start=e.nodes_end=e.ac=null}function Ni(e,t){for(;null!==e;){var n=e===t?null:Wt(e);e.remove(),e=n}}function Fi(e){var t=e.parent,n=e.prev,i=e.next;null!==n&&(n.next=i),null!==i&&(i.prev=n),null!==t&&(t.first===e&&(t.first=i),t.last===e&&(t.last=n))}function Bi(e,t,n=!0){var i=[];Ui(e,i,!0),ji(i,()=>{n&&Li(e),t&&t()})}function ji(e,t){var n=e.length;if(n>0){var i=()=>--n||t();for(var a of e)a.out(i)}else t()}function Ui(e,t,n){if(0===(e.f&et)){if(e.f^=et,null!==e.transitions)for(const i of e.transitions)(i.is_global||n)&&t.push(i);for(var i=e.first;null!==i;){var a=i.next;Ui(i,t,!!(0!==(i.f&it)||0!==(i.f&We))&&n),i=a}}}function Vi(e){qi(e,!0)}function qi(e,t){if(0!==(e.f&et)){e.f^=et,0===(e.f&Ye)&&(xi(e,Xe),bn(e));for(var n=e.first;null!==n;){var i=n.next;qi(n,!!(0!==(n.f&it)||0!==(n.f&We))&&t),n=i}if(null!==e.transitions)for(const n of e.transitions)(n.is_global||t)&&n.in()}}function Hi(e,t){for(var n=e.nodes_start,i=e.nodes_end;null!==n;){var a=n===i?null:Wt(n);t.append(n),n=a}}function Wi(e){return e.endsWith("capture")&&"gotpointercapture"!==e&&"lostpointercapture"!==e}const Gi=["beforeinput","click","change","dblclick","contextmenu","focusin","focusout","input","keydown","keyup","mousedown","mousemove","mouseout","mouseover","mouseup","pointerdown","pointermove","pointerout","pointerover","pointerup","touchend","touchmove","touchstart"];function Qi(e){return Gi.includes(e)}const Ki={formnovalidate:"formNoValidate",ismap:"isMap",nomodule:"noModule",playsinline:"playsInline",readonly:"readOnly",defaultvalue:"defaultValue",defaultchecked:"defaultChecked",srcobject:"srcObject",novalidate:"noValidate",allowfullscreen:"allowFullscreen",disablepictureinpicture:"disablePictureInPicture",disableremoteplayback:"disableRemotePlayback"};function Zi(e){var t;return e=e.toLowerCase(),null!=(t=Ki[e])?t:e}const Yi=["touchstart","touchmove"];function Xi(e){return Yi.includes(e)}const Ji=new Set,ea=new Set;function ta(e,t,n,i={}){function a(e){if(i.capture||ra.call(t,e),!e.cancelBubble)return qn(()=>null==n?void 0:n.call(this,e))}return e.startsWith("pointer")||e.startsWith("touch")||"wheel"===e?Ct(()=>{t.addEventListener(e,a,i)}):t.addEventListener(e,a,i),a}function na(e,t,n,i,a){var r={capture:i,passive:a},s=ta(e,t,n,r);(t===document.body||t===window||t===document||t instanceof HTMLMediaElement)&&Di(()=>{t.removeEventListener(e,s,r)})}function ia(e){for(var t=0;t<e.length;t++)Ji.add(e[t]);for(var n of ea)n(e)}let aa=null;function ra(e){var t,n=this,i=n.ownerDocument,a=e.type,r=(null==(t=e.composedPath)?void 0:t.call(e))||[],s=r[0]||e.target;aa=e;var o=0,l=aa===e&&e.__root;if(l){var c=r.indexOf(l);if(-1!==c&&(n===document||n===window))return void(e.__root=n);var d=r.indexOf(n);if(-1===d)return;c<=d&&(o=c)}if((s=r[o]||e.target)!==n){Re(e,"currentTarget",{configurable:!0,get:()=>s||i});var u=Zn,h=Jn;Xn(null),ei(null);try{for(var p,g=[];null!==s;){var v=s.assignedSlot||s.parentNode||s.host||null;try{var f=s["__"+a];if(null!=f&&(!s.disabled||e.target===s))if(Ee(f)){var[m,...y]=f;m.apply(s,[e,...y])}else f.call(s,e)}catch(b){p?g.push(b):p=b}if(e.cancelBubble||v===n||null===v)break;s=v}if(p){for(let e of g)queueMicrotask(()=>{throw e});throw p}}finally{e.__root=n,delete e.currentTarget,Xn(u),ei(h)}}}function sa(e){var t=document.createElement("template");return t.innerHTML=e.replaceAll("<!>","\x3c!----\x3e"),t.content}function oa(e,t){var n=Jn;null===n.nodes_start&&(n.nodes_start=e,n.nodes_end=t)}function la(e,t){var n,i=!!(1&t),a=!!(2&t),r=!e.startsWith("<!>");return()=>{if(Tt)return oa(Dt,null),Dt;void 0===n&&(n=sa(r?e:"<!>"+e),i||(n=Ht(n)));var t=a||Bt?document.importNode(n,!0):n.cloneNode(!0);i?oa(Ht(t),t.lastChild):oa(t,t);return t}}function ca(e,t,n="svg"){var i,a=!e.startsWith("<!>"),r=!!(1&t),s=`<${n}>${a?e:"<!>"+e}</${n}>`;return()=>{if(Tt)return oa(Dt,null),Dt;if(!i){var e=Ht(sa(s));if(r)for(i=document.createDocumentFragment();Ht(e);)i.appendChild(Ht(e));else i=Ht(e)}var t=i.cloneNode(!0);r?oa(Ht(t),t.lastChild):oa(t,t);return t}}function da(e,t){return ca(e,t,"svg")}function ua(e=""){if(!Tt){var t=qt(e+"");return oa(t,t),t}var n=Dt;return 3!==n.nodeType&&(n.before(n=qt()),At(n)),oa(n,n),n}function ha(){if(Tt)return oa(Dt,null),Dt;var e=document.createDocumentFragment(),t=document.createComment(""),n=qt();return e.append(t,n),oa(t,n),e}function pa(e,t){if(Tt)return Jn.nodes_end=Dt,void Et();null!==e&&e.before(t)}let ga=!0;function va(e,t){var n,i=null==t?"":"object"==typeof t?t+"":t;i!==(null!=(n=e.__t)?n:e.__t=e.nodeValue)&&(e.__t=i,e.nodeValue=i+"")}function fa(e,t){return ba(e,t)}function ma(e,t){var n;Vt(),t.intro=null!=(n=t.intro)&&n;const i=t.target,a=Tt,r=Dt;try{for(var s=Ht(i);s&&(8!==s.nodeType||"["!==s.data);)s=Wt(s);if(!s)throw mt;Mt(!0),At(s);const n=ba(e,{...t,anchor:s});return Mt(!1),n}catch(o){if(o instanceof Error&&o.message.split("\n").some(e=>e.startsWith("https://svelte.dev/e/")))throw o;return!1===t.recover&&function(){throw new Error("https://svelte.dev/e/hydration_failed")}(),Vt(),Zt(i),Mt(!1),fa(e,t)}finally{Mt(a),At(r)}}const ya=new Map;function ba(e,{target:t,anchor:n,props:i={},events:a,context:r,intro:s=!0}){Vt();var o=new Set,l=e=>{for(var n=0;n<e.length;n++){var i=e[n];if(!o.has(i)){o.add(i);var a=Xi(i);t.addEventListener(i,ra,{passive:a});var r=ya.get(i);void 0===r?(document.addEventListener(i,ra,{passive:a}),ya.set(i,1)):ya.set(i,r+1)}}};l(Pe(Ji)),ea.add(l);var c=void 0,d=function(e){un.ensure();const t=Ii(524352,e,!0);return(e={})=>new Promise(n=>{e.outro?Bi(t,()=>{Li(t),n(void 0)}):(Li(t),n(void 0))})}(()=>{var d=null!=n?n:t.appendChild(qt());return function(e,t,n){new kn(e,t,n)}(d,{pending:()=>{}},t=>{r&&(kt({}),bt.c=r);if(a&&(i.$$events=a),Tt&&oa(t,null),ga=s,c=e(t,i)||{},ga=!0,Tt&&(Jn.nodes_end=Dt,null===Dt||8!==Dt.nodeType||"]"!==Dt.data))throw mt;r&&St()}),()=>{var e;for(var i of o){t.removeEventListener(i,ra);var a=ya.get(i);0===--a?(document.removeEventListener(i,ra),ya.delete(i)):ya.set(i,a)}ea.delete(l),d!==n&&(null==(e=d.parentNode)||e.removeChild(d))}});return wa.set(c,d),c}let wa=new WeakMap;function ka(e,t){const n=wa.get(e);return n?(wa.delete(e),n(t)):Promise.resolve()}class Sa{constructor(e,t=!0){oe(this,"anchor"),ue(this,R,new Map),ue(this,$,new Map),ue(this,O,new Map),ue(this,L,!0),ue(this,N,()=>{var e=nn;if(de(this,R).has(e)){var t=de(this,R).get(e),n=de(this,$).get(t);if(n)Vi(n);else{var i=de(this,O).get(t);i&&(de(this,$).set(t,i.effect),de(this,O).delete(t),i.fragment.lastChild.remove(),this.anchor.before(i.fragment),n=i.effect)}for(const[t,n]of de(this,R)){if(de(this,R).delete(t),t===e)break;const i=de(this,O).get(n);i&&(Li(i.effect),de(this,O).delete(n))}for(const[e,i]of de(this,$)){if(e===t)continue;const a=()=>{if(Array.from(de(this,R).values()).includes(e)){var t=document.createDocumentFragment();Hi(i,t),t.append(qt()),de(this,O).set(e,{effect:i,fragment:t})}else Li(i);de(this,$).delete(e)};de(this,L)||!n?Bi(i,a,!1):a()}}}),this.anchor=e,he(this,L,t)}ensure(e,t){var n=nn;!t||de(this,$).has(e)||de(this,O).has(e)||de(this,$).set(e,Ri(()=>t(this.anchor)));de(this,R).set(n,e),Tt&&(this.anchor=Dt),de(this,N).call(this)}}function xa(e,t,n=!1){Tt&&Et();var i=new Sa(e);function a(t,n){if(Tt){if(t===($t(e)===ft)){var a=Rt();return At(a),i.anchor=a,Mt(!1),i.ensure(t,n),void Mt(!0)}}i.ensure(t,n)}Pi(()=>{var e=!1;t((t,n=!0)=>{e=!0,a(n,t)}),e||a(!1,null)},n?it:0)}function _a(e,t){return t}function Ca(e,t,n,i,a,r=null){var s=e,o={flags:t,items:new Map,first:null};if(!!(4&t)){var l=e;s=Tt?At(Ht(l)):l.appendChild(qt())}Tt&&Et();var c,d,u=null,h=!1,p=new Map,g=Dn(()=>{var e=n();return Ee(e)?e:null==e?[]:Pe(e)});function v(){!function(e,t,n,i,a,r,s,o,l){var c,d,u,h,p,g,v,f,m,y,b=!!(8&s),w=!!(3&s),k=t.length,S=n.items,x=n.first,_=x,C=null,I=[],D=[];if(b)for(y=0;y<k;y+=1)f=o(v=t[y],y),void 0!==(m=S.get(f))&&(null==(c=m.a)||c.measure(),(null!=g?g:g=new Set).add(m));for(y=0;y<k;y+=1)if(f=o(v=t[y],y),void 0!==(m=S.get(f))){if(w&&Ia(m,v,y,s),0!==(m.e.f&et)&&(Vi(m.e),b&&(null==(d=m.a)||d.unfix(),(null!=g?g:g=new Set).delete(m))),m!==_){if(void 0!==p&&p.has(m)){if(I.length<D.length){var T,M=D[0];C=M.prev;var A=I[0],E=I[I.length-1];for(T=0;T<I.length;T+=1)Ta(I[T],M,a);for(T=0;T<D.length;T+=1)p.delete(D[T]);Ma(n,A.prev,E.next),Ma(n,C,A),Ma(n,E,M),_=M,C=E,y-=1,I=[],D=[]}else p.delete(m),Ta(m,_,a),Ma(n,m.prev,m.next),Ma(n,m,null===C?n.first:C.next),Ma(n,C,m),C=m;continue}for(I=[],D=[];null!==_&&_.k!==f;)0===(_.e.f&et)&&(null!=p?p:p=new Set).add(_),D.push(_),_=_.next;if(null===_)continue;m=_}I.push(m),C=m,_=m.next}else{var z=i.get(f);if(void 0!==z){i.delete(f),S.set(f,z);var P=C?C.next:_;Ma(n,C,z),Ma(n,z,P),Ta(z,P,a),C=z}else{C=Da(_?_.e.nodes_start:a,n,C,null===C?n.first:C.next,v,f,y,r,s,l)}S.set(f,C),I=[],D=[],_=C.next}if(null!==_||void 0!==p){for(var R=void 0===p?[]:Pe(p);null!==_;)0===(_.e.f&et)&&R.push(_),_=_.next;var $=R.length;if($>0){var O=4&s&&0===k?a:null;if(b){for(y=0;y<$;y+=1)null==(u=R[y].a)||u.measure();for(y=0;y<$;y+=1)null==(h=R[y].a)||h.fix()}!function(e,t,n){for(var i=e.items,a=[],r=t.length,s=0;s<r;s++)Ui(t[s].e,a,!0);var o=r>0&&0===a.length&&null!==n;if(o){var l=n.parentNode;Zt(l),l.append(n),i.clear(),Ma(e,t[0].prev,t[r-1].next)}ji(a,()=>{for(var n=0;n<r;n++){var a=t[n];o||(i.delete(a.k),Ma(e,a.prev,a.next)),Li(a.e,!o)}})}(n,R,O)}}b&&Ct(()=>{var e;if(void 0!==g)for(m of g)null==(e=m.a)||e.apply()});for(var L of(e.first=n.first&&n.first.e,e.last=C&&C.e,i.values()))Li(L.e);i.clear()}(d,c,o,p,s,a,t,i,n),null!==r&&(0===c.length?u?Vi(u):u=Ri(()=>r(s)):null!==u&&Bi(u,()=>{u=null}))}Pi(()=>{null!=d||(d=Jn);var e=(c=bi(g)).length;if(h&&0===e)return;h=0===e;let l=!1;Tt&&($t(s)===ft!==(0===e)&&(At(s=Rt()),Mt(!1),l=!0));if(Tt){for(var p,f=null,m=0;m<e;m++){if(8===Dt.nodeType&&"]"===Dt.data){s=Dt,l=!0,Mt(!1);break}var y=c[m],b=i(y,m);p=Da(Dt,o,f,null,y,b,m,a,t,n),o.items.set(b,p),f=p}e>0&&At(Rt())}Tt?0===e&&r&&(u=Ri(()=>r(s))):v();l&&Mt(!0),bi(g)}),Tt&&(s=Dt)}function Ia(e,t,n,i){1&i&&On(e.v,t),2&i?On(e.i,n):e.i=n}function Da(e,t,n,i,a,r,s,o,l,c,d){var u=!!(1&l)?!(16&l)?Rn(a,!1,!1):zn(a):a,h=2&l?zn(s):s,p={i:h,v:u,k:r,a:null,e:null,prev:n,next:i};try{if(null===e)document.createDocumentFragment().append(e=qt());return p.e=Ri(()=>o(e,u,h,c),Tt),p.e.prev=n&&n.e,p.e.next=i&&i.e,null===n?d||(t.first=p):(n.next=p,n.e.next=p.e),null!==i&&(i.prev=p,i.e.prev=p.e),p}finally{}}function Ta(e,t,n){for(var i=e.next?e.next.e.nodes_start:n,a=t?t.e.nodes_start:n,r=e.e.nodes_start;null!==r&&r!==i;){var s=Wt(r);a.before(r),r=s}}function Ma(e,t,n){null===t?e.first=n:(t.next=n,t.e.next=n&&n.e),null!==n&&(n.prev=t,n.e.prev=t&&t.e)}function Aa(e,t,n=!1,i=!1,a=!1){var r=e,s="";zi(()=>{var e,a=Jn;if(s!==(s=null!=(e=t())?e:"")){if(null!==a.nodes_start&&(Ni(a.nodes_start,a.nodes_end),a.nodes_start=a.nodes_end=null),""!==s){if(Tt){Dt.data;for(var o=Et(),l=o;null!==o&&(8!==o.nodeType||""!==o.data);)l=o,o=Wt(o);if(null===o)throw mt;return oa(Dt,l),void(r=At(o))}var c=s+"";n?c=`<svg>${c}</svg>`:i&&(c=`<math>${c}</math>`);var d=sa(c);if((n||i)&&(d=Ht(d)),oa(Ht(d),d.lastChild),n||i)for(;Ht(d);)r.before(Ht(d));else r.before(d)}}else Tt&&Et()})}function Ea(e,t,...n){var i=new Sa(e);Pi(()=>{var e;const a=null!=(e=t())?e:null;i.ensure(a,a&&(e=>a(e,...n)))},it)}function za(e,t,n){Ai(()=>{var i=ki(()=>t(e,null==n?void 0:n())||{});if(n&&(null==i?void 0:i.update)){var a=!1,r={};Ei(()=>{var e=n();!function(e){if("object"==typeof e&&e&&!(e instanceof EventTarget))if(lt in e)_i(e);else if(!Array.isArray(e))for(let t in e){const n=e[t];"object"==typeof n&&n&&lt in n&&_i(n)}}(e),a&&pt(r,e)&&(r=e,i.update(e))}),a=!0}if(null==i?void 0:i.destroy)return()=>i.destroy()})}function Pa(e,t){var n,i=void 0;Pi(()=>{i!==(i=t())&&(n&&(Li(n),n=null),i&&(n=Ri(()=>{Ai(()=>i(e))})))})}function Ra(e){var t,n,i="";if("string"==typeof e||"number"==typeof e)i+=e;else if("object"==typeof e)if(Array.isArray(e)){var a=e.length;for(t=0;t<a;t++)e[t]&&(n=Ra(e[t]))&&(i&&(i+=" "),i+=n)}else for(n in e)e[n]&&(i&&(i+=" "),i+=n);return i}function $a(e){return"object"==typeof e?function(){for(var e,t,n=0,i="",a=arguments.length;n<a;n++)(e=arguments[n])&&(t=Ra(e))&&(i&&(i+=" "),i+=t);return i}(e):null!=e?e:""}R=new WeakMap,$=new WeakMap,O=new WeakMap,L=new WeakMap,N=new WeakMap;const Oa=[..." \t\n\r\f \v\ufeff"];function La(e,t=!1){var n=t?" !important;":";",i="";for(var a in e){var r=e[a];null!=r&&""!==r&&(i+=" "+a+": "+r+n)}return i}function Na(e){return"-"!==e[0]||"-"!==e[1]?e.toLowerCase():e}function Fa(e,t,n,i,a,r){var s=e.__className;if(Tt||s!==n||void 0===s){var o=function(e,t,n){var i=null==e?"":""+e;if(t&&(i=i?i+" "+t:t),n)for(var a in n)if(n[a])i=i?i+" "+a:a;else if(i.length)for(var r=a.length,s=0;(s=i.indexOf(a,s))>=0;){var o=s+r;0!==s&&!Oa.includes(i[s-1])||o!==i.length&&!Oa.includes(i[o])?s=o:i=(0===s?"":i.substring(0,s))+i.substring(o+1)}return""===i?null:i}(n,i,r);Tt&&o===e.getAttribute("class")||(null==o?e.removeAttribute("class"):t?e.className=o:e.setAttribute("class",o)),e.__className=n}else if(r&&a!==r)for(var l in r){var c=!!r[l];null!=a&&c===!!a[l]||e.classList.toggle(l,c)}return r}function Ba(e,t={},n,i){for(var a in n){var r=n[a];t[a]!==r&&(null==n[a]?e.style.removeProperty(a):e.style.setProperty(a,r,i))}}function ja(e,t,n,i){var a=e.__style;if(Tt||a!==t){var r=function(e,t){if(t){var n,i,a="";if(Array.isArray(t)?(n=t[0],i=t[1]):n=t,e){e=String(e).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var r=!1,s=0,o=!1,l=[];n&&l.push(...Object.keys(n).map(Na)),i&&l.push(...Object.keys(i).map(Na));var c=0,d=-1;const t=e.length;for(var u=0;u<t;u++){var h=e[u];if(o?"/"===h&&"*"===e[u-1]&&(o=!1):r?r===h&&(r=!1):"/"===h&&"*"===e[u+1]?o=!0:'"'===h||"'"===h?r=h:"("===h?s++:")"===h&&s--,!o&&!1===r&&0===s)if(":"===h&&-1===d)d=u;else if(";"===h||u===t-1){if(-1!==d){var p=Na(e.substring(c,d).trim());l.includes(p)||(";"!==h&&u++,a+=" "+e.substring(c,u).trim()+";")}c=u+1,d=-1}}}return n&&(a+=La(n)),i&&(a+=La(i,!0)),""===(a=a.trim())?null:a}return null==e?null:String(e)}(t,i);Tt&&r===e.getAttribute("style")||(null==r?e.removeAttribute("style"):e.style.cssText=r),e.__style=t}else i&&(Array.isArray(i)?(Ba(e,null==n?void 0:n[0],i[0]),Ba(e,null==n?void 0:n[1],i[1],"important")):Ba(e,n,i));return i}function Ua(e,t,n=!1){if(e.multiple){if(null==t)return;if(!Ee(t))return;for(var i of e.options)i.selected=t.includes(Ha(i))}else{for(i of e.options){if(Nt(Ha(i),t))return void(i.selected=!0)}n&&void 0===t||(e.selectedIndex=-1)}}function Va(e){var t=new MutationObserver(()=>{Ua(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Di(()=>{t.disconnect()})}function qa(e,t,n=t){var i=new WeakSet,a=!0;Hn(e,"change",t=>{var a,r,s=t?"[selected]":":checked";if(e.multiple)r=[].map.call(e.querySelectorAll(s),Ha);else{var o=null!=(a=e.querySelector(s))?a:e.querySelector("option:not([disabled])");r=o&&Ha(o)}n(r),null!==nn&&i.add(nn)}),Ai(()=>{var r=t();if(e===document.activeElement){var s=null!=an?an:nn;if(i.has(s))return}if(Ua(e,r,a),a&&void 0===r){var o=e.querySelector(":checked");null!==o&&(r=Ha(o),n(r))}e.__value=r,a=!1}),Va(e)}function Ha(e){return"__value"in e?e.__value:e.value}const Wa=Symbol("class"),Ga=Symbol("style"),Qa=Symbol("is custom element"),Ka=Symbol("is html");function Za(e){if(Tt){var t=!1,n=()=>{if(!t){if(t=!0,e.hasAttribute("value")){var n=e.value;er(e,"value",null),e.value=n}if(e.hasAttribute("checked")){var i=e.checked;er(e,"checked",null),e.checked=i}}};e.__on_r=n,Ct(n),Vn()}}function Ya(e,t){var n=nr(e);n.value!==(n.value=null!=t?t:void 0)&&(e.value!==t||0===t&&"PROGRESS"===e.nodeName)&&(e.value=null!=t?t:"")}function Xa(e,t){var n=nr(e);n.checked!==(n.checked=null!=t?t:void 0)&&(e.checked=t)}function Ja(e,t){t?e.hasAttribute("selected")||e.setAttribute("selected",""):e.removeAttribute("selected")}function er(e,t,n,i){var a=nr(e);Tt&&(a[t]=e.getAttribute(t),"src"===t||"srcset"===t||"href"===t&&"LINK"===e.nodeName)||a[t]!==(a[t]=n)&&("loading"===t&&(e[dt]=n),null==n?e.removeAttribute(t):"string"!=typeof n&&ar(e).includes(t)?e[t]=n:e.setAttribute(t,n))}function tr(e,t,n=[],i=[],a,r=!1,s=!1){Sn(n,i,n=>{var i=void 0,o={},l="SELECT"===e.nodeName,c=!1;if(Pi(()=>{var d=t(...n.map(bi)),u=function(e,t,n,i,a=!1){if(Tt&&a&&"INPUT"===e.tagName){var r=e;("checkbox"===r.type?"defaultChecked":"defaultValue")in n||Za(r)}var s=nr(e),o=s[Qa],l=!s[Ka];let c=Tt&&o;c&&Mt(!1);var d=t||{},u="OPTION"===e.tagName;for(var h in t)h in n||(n[h]=null);n.class?n.class=$a(n.class):(i||n[Wa])&&(n.class=null),n[Ga]&&(null!=n.style||(n.style=null));var p=ar(e);for(const b in n){let a=n[b];if(u&&"value"===b&&null==a)e.value=e.__value="",d[b]=a;else if("class"!==b)if("style"!==b){var g=d[b];if(a!==g||void 0===a&&e.hasAttribute(b)){d[b]=a;var v=b[0]+b[1];if("$$"!==v)if("on"===v){const t={},n="$$"+b;let i=b.slice(2);var f=Qi(i);if(Wi(i)&&(i=i.slice(0,-7),t.capture=!0),!f&&g){if(null!=a)continue;e.removeEventListener(i,d[n],t),d[n]=null}if(null!=a)if(f)e[`__${i}`]=a,ia([i]);else{let a=function(e){d[b].call(this,e)};d[n]=ta(i,e,a,t)}else f&&(e[`__${i}`]=void 0)}else if("style"===b)er(e,b,a);else if("autofocus"===b)Bn(e,Boolean(a));else if(o||"__value"!==b&&("value"!==b||null==a))if("selected"===b&&u)Ja(e,a);else{var m=b;l||(m=Zi(m));var y="defaultValue"===m||"defaultChecked"===m;if(null!=a||o||y)y||p.includes(m)&&(o||"string"!=typeof a)?(e[m]=a,m in s&&(s[m]=yt)):"function"!=typeof a&&er(e,m,a);else if(s[b]=null,"value"===m||"checked"===m){let n=e;const i=void 0===t;if("value"===m){let e=n.defaultValue;n.removeAttribute(m),n.defaultValue=e,n.value=n.__value=i?e:null}else{let e=n.defaultChecked;n.removeAttribute(m),n.defaultChecked=e,n.checked=!!i&&e}}else e.removeAttribute(b)}else e.value=e.__value=a}}else ja(e,a,null==t?void 0:t[Ga],n[Ga]),d[b]=a,d[Ga]=n[Ga];else Fa(e,"http://www.w3.org/1999/xhtml"===e.namespaceURI,a,i,null==t?void 0:t[Wa],n[Wa]),d[b]=a,d[Wa]=n[Wa]}return c&&Mt(!0),d}(e,i,d,a,r,s);c&&l&&"value"in d&&Ua(e,d.value);for(let e of Object.getOwnPropertySymbols(o))d[e]||Li(o[e]);for(let t of Object.getOwnPropertySymbols(d)){var h=d[t];"@attach"!==t.description||i&&h===i[t]||(o[t]&&Li(o[t]),o[t]=Ri(()=>Pa(e,()=>h))),u[t]=h}i=u}),l){var d=e;Ai(()=>{Ua(d,i.value,!0),Va(d)})}c=!0})}function nr(e){var t;return null!=(t=e.__attributes)?t:e.__attributes={[Qa]:e.nodeName.includes("-"),[Ka]:"http://www.w3.org/1999/xhtml"===e.namespaceURI}}var ir=new Map;function ar(e){var t,n=e.getAttribute("is")||e.nodeName,i=ir.get(n);if(i)return i;ir.set(n,i=[]);for(var a=e,r=Element.prototype;r!==a;){for(var s in t=Oe(a))t[s].set&&i.push(s);a=Fe(a)}return i}const rr={tick:e=>requestAnimationFrame(e),now:()=>performance.now(),tasks:new Set};function sr(){const e=rr.now();rr.tasks.forEach(t=>{t.c(e)||(rr.tasks.delete(t),t.f())}),0!==rr.tasks.size&&rr.tick(sr)}function or(e,t){qn(()=>{e.dispatchEvent(new CustomEvent(t))})}function lr(e){if("float"===e)return"cssFloat";if("offset"===e)return"cssOffset";if(e.startsWith("--"))return e;const t=e.split("-");return 1===t.length?t[0]:t[0]+t.slice(1).map(e=>e[0].toUpperCase()+e.slice(1)).join("")}function cr(e){const t={},n=e.split(";");for(const i of n){const[e,n]=i.split(":");if(!e||void 0===n)break;t[lr(e.trim())]=n.trim()}return t}const dr=e=>e;function ur(e,t,n,i){var a,r,s,o,l=!!(4&e),c=t.inert,d=t.style.overflow;function u(){return qn(()=>{var e;return null!=r?r:r=n()(t,null!=(e=null==i?void 0:i())?e:{},{direction:"both"})})}var h={is_global:l,in(){t.inert=c,or(t,"introstart"),s=hr(t,u(),o,1,()=>{or(t,"introend"),null==s||s.abort(),s=r=void 0,t.style.overflow=d})},out(e){t.inert=!0,or(t,"outrostart"),o=hr(t,u(),s,0,()=>{or(t,"outroend"),null==e||e()})},stop:()=>{null==s||s.abort(),null==o||o.abort()}},p=Jn;if((null!=(a=p.transitions)?a:p.transitions=[]).push(h),ga){var g=l;if(!g){for(var v=p.parent;v&&0!==(v.f&it);)for(;(v=v.parent)&&0===(v.f&He););g=!v||0!==(v.f&nt)}g&&Ai(()=>{ki(()=>h.in())})}}function hr(e,t,n,i,a){var r=1===i;if("function"==typeof t){var s,o=!1;return Ct(()=>{if(!o){var l=t({direction:r?"in":"out"});s=hr(e,l,n,i,a)}}),{abort:()=>{o=!0,null==s||s.abort()},deactivate:()=>s.deactivate(),reset:()=>s.reset(),t:()=>s.t()}}if(null==n||n.deactivate(),!(null==t?void 0:t.duration))return a(),{abort:je,deactivate:je,reset:je,t:()=>i};const{delay:l=0,css:c,tick:d,easing:u=dr}=t;var h=[];if(r&&void 0===n&&(d&&d(0,1),c)){var p=cr(c(0,1));h.push(p,p)}var g=()=>1-i,v=e.animate(h,{duration:l,fill:"forwards"});return v.onfinish=()=>{var r;v.cancel();var s=null!=(r=null==n?void 0:n.t())?r:1-i;null==n||n.abort();var o=i-s,l=t.duration*Math.abs(o),h=[];if(l>0){var p=!1;if(c)for(var f=Math.ceil(l/(1e3/60)),m=0;m<=f;m+=1){var y=s+o*u(m/f),b=cr(c(y,1-y));h.push(b),p||(p="hidden"===b.overflow)}p&&(e.style.overflow="hidden"),g=()=>{var e=v.currentTime;return s+o*u(e/l)},d&&function(e){let t;0===rr.tasks.size&&rr.tick(sr),new Promise(n=>{rr.tasks.add(t={c:e,f:n})})}(()=>{if("running"!==v.playState)return!1;var e=g();return d(e,1-e),!0})}(v=e.animate(h,{duration:l,fill:"forwards"})).onfinish=()=>{g=()=>i,null==d||d(i,1-i),a()}},{abort:()=>{v&&(v.cancel(),v.effect=null,v.onfinish=je)},deactivate:()=>{a=je},reset:()=>{0===i&&(null==d||d(1,0))},t:()=>g()}}function pr(e,t,n=t){var i=new WeakSet;Hn(e,"input",async a=>{var r=a?e.defaultValue:e.value;if(r=yr(e)?br(r):r,n(r),null!==nn&&i.add(nn),await yi(),r!==(r=t())){var s=e.selectionStart,o=e.selectionEnd,l=e.value.length;if(e.value=null!=r?r:"",null!==o){var c=e.value.length;s===o&&o===l&&c>l?(e.selectionStart=c,e.selectionEnd=c):(e.selectionStart=s,e.selectionEnd=Math.min(o,c))}}}),(Tt&&e.defaultValue!==e.value||null==ki(t)&&e.value)&&(n(yr(e)?br(e.value):e.value),null!==nn&&i.add(nn)),Ei(()=>{var n=t();if(e===document.activeElement){var a=null!=an?an:nn;if(i.has(a))return}yr(e)&&n===br(e.value)||("date"!==e.type||n||e.value)&&n!==e.value&&(e.value=null!=n?n:"")})}const gr=new Set;function vr(e,t,n,i,a=i){var r,s="checkbox"===n.getAttribute("type"),o=e;let l=!1;if(null!==t)for(var c of t)o=null!=(r=o[c])?r:o[c]=[];o.push(n),Hn(n,"change",()=>{var e=n.__value;s&&(e=mr(o,e,n.checked)),a(e)},()=>a(s?[]:null)),Ei(()=>{var e=i();Tt&&n.defaultChecked!==n.checked?l=!0:s?(e=e||[],n.checked=e.includes(n.__value)):n.checked=Nt(n.__value,e)}),Di(()=>{var e=o.indexOf(n);-1!==e&&o.splice(e,1)}),gr.has(o)||(gr.add(o),Ct(()=>{o.sort((e,t)=>4===e.compareDocumentPosition(t)?-1:1),gr.delete(o)})),Ct(()=>{if(l){var e;if(s)e=mr(o,e,n.checked);else{var t=o.find(e=>e.checked);e=null==t?void 0:t.__value}a(e)}})}function fr(e,t,n=t){Hn(e,"change",t=>{var i=t?e.defaultChecked:e.checked;n(i)}),(Tt&&e.defaultChecked!==e.checked||null==ki(t))&&n(e.checked),Ei(()=>{var n=t();e.checked=Boolean(n)})}function mr(e,t,n){for(var i=new Set,a=0;a<e.length;a+=1)e[a].checked&&i.add(e[a].__value);return n||i.delete(t),Array.from(i)}function yr(e){var t=e.type;return"number"===t||"range"===t}function br(e){return""===e?null:+e}function wr(e,t){return e===t||(null==e?void 0:e[lt])===t}function kr(e={},t,n,i){return Ai(()=>{var i,a;return Ei(()=>{i=a,a=[],ki(()=>{e!==n(...a)&&(t(e,...a),i&&wr(n(...i),e)&&t(null,...i))})}),()=>{Ct(()=>{a&&wr(n(...a),e)&&t(null,...a)})}}),e}function Sr(e,t,n){var i;e.$$events||(e.$$events={}),(i=e.$$events)[t]||(i[t]=[]),e.$$events[t].push(n)}function xr(e){for(var t in e)t in this&&(this[t]=e[t])}let _r=!1,Cr=Symbol();function Ir(e,t,n){var i;const a=null!=(i=n[t])?i:n[t]={store:null,source:Rn(void 0),unsubscribe:je};if(a.store!==e&&!(Cr in n))if(a.unsubscribe(),a.store=null!=e?e:null,null==e)a.source.v=void 0,a.unsubscribe=je;else{var r=!0;a.unsubscribe=Lr(e,e=>{r?a.source.v=e:$n(a.source,e)}),r=!1}return e&&Cr in n?jr(e):bi(a.source)}function Dr(){const e={};return[e,function(){Di(()=>{for(var t in e){e[t].unsubscribe()}Re(e,Cr,{enumerable:!1,value:!0})})}]}const Tr={get(e,t){if(!e.exclude.includes(t))return e.props[t]},set:(e,t)=>!1,getOwnPropertyDescriptor(e,t){if(!e.exclude.includes(t))return t in e.props?{enumerable:!0,configurable:!0,value:e.props[t]}:void 0},has:(e,t)=>!e.exclude.includes(t)&&t in e.props,ownKeys:e=>Reflect.ownKeys(e.props).filter(t=>!e.exclude.includes(t))};function Mr(e,t,n){return new Proxy({props:e,exclude:t},Tr)}function Ar(e,t,n,i){var a,r,s,o,l=!!(8&n),c=!!(16&n),d=i,u=!0,h=()=>(u&&(u=!1,d=c?ki(i):i),d);if(l){var p=lt in e||ct in e;s=null!=(r=null==(a=$e(e,t))?void 0:a.set)?r:p&&t in e?n=>e[t]=n:void 0}var g,v=!1;if(l?[o,v]=function(e){var t=_r;try{return _r=!1,[e(),_r]}finally{_r=t}}(()=>e[t]):o=e[t],void 0===o&&void 0!==i&&(o=h(),s&&(!function(){throw new Error("https://svelte.dev/e/props_invalid_value")}(),s(o))),g=()=>{var n=e[t];return void 0===n?h():(u=!0,n)},!(4&n))return g;if(s){var f=e.$$legacy;return function(e,t){return arguments.length>0?((!t||f||v)&&s(t?g():e),e):g()}}var m=!1,y=(1&n?_n:Dn)(()=>(m=!1,g()));l&&bi(y);var b=Jn;return function(e,t){if(arguments.length>0){const n=t?bi(y):l?Ot(e):e;return $n(y,n),m=!0,void 0!==d&&(d=n),e}return Qn&&m||0!==(b.f&tt)?y.v:bi(y)}}function Er(e){return new zr(e)}class zr{constructor(e){var t,n;ue(this,F),ue(this,B);var i=new Map,a=(e,t)=>{var n=Rn(t,!1,!1);return i.set(e,n),n};const r=new Proxy({...e.props||{},$$events:{}},{get(e,t){var n;return bi(null!=(n=i.get(t))?n:a(t,Reflect.get(e,t)))},has(e,t){var n;return t===ct||(bi(null!=(n=i.get(t))?n:a(t,Reflect.get(e,t))),Reflect.has(e,t))},set(e,t,n){var r;return $n(null!=(r=i.get(t))?r:a(t,n),n),Reflect.set(e,t,n)}});he(this,B,(e.hydrate?ma:fa)(e.component,{target:e.target,anchor:e.anchor,props:r,context:e.context,intro:null!=(t=e.intro)&&t,recover:e.recover})),(null==(n=null==e?void 0:e.props)?void 0:n.$$host)&&!1!==e.sync||hn(),he(this,F,r.$$events);for(const s of Object.keys(de(this,B)))"$set"!==s&&"$destroy"!==s&&"$on"!==s&&Re(this,s,{get(){return de(this,B)[s]},set(e){de(this,B)[s]=e},enumerable:!0});de(this,B).$set=e=>{Object.assign(r,e)},de(this,B).$destroy=()=>{ka(de(this,B))}}$set(e){de(this,B).$set(e)}$on(e,t){de(this,F)[e]=de(this,F)[e]||[];const n=(...e)=>t.call(this,...e);return de(this,F)[e].push(n),()=>{de(this,F)[e]=de(this,F)[e].filter(e=>e!==n)}}$destroy(){de(this,B).$destroy()}}function Pr(e){null===bt&&vt(),Ti(()=>{const t=ki(e);if("function"==typeof t)return t})}function Rr(e){null===bt&&vt(),Pr(()=>()=>ki(e))}function $r(){const e=bt;return null===e&&vt(),(t,n,i)=>{var a;const r=null==(a=e.s.$$events)?void 0:a[t];if(r){const a=Ee(r)?r.slice():[r],s=function(e,t,{bubbles:n=!1,cancelable:i=!1}={}){return new CustomEvent(e,{detail:t,bubbles:n,cancelable:i})}(t,n,i);for(const t of a)t.call(e.x,s);return!s.defaultPrevented}return!0}}F=new WeakMap,B=new WeakMap;const Or=Object.freeze(Object.defineProperty({__proto__:null,createEventDispatcher:$r,flushSync:hn,hydrate:ma,mount:fa,onDestroy:Rr,onMount:Pr,tick:yi,unmount:ka,untrack:ki},Symbol.toStringTag,{value:"Module"}));function Lr(e,t,n){if(null==e)return t(void 0),n&&n(void 0),je;const i=ki(()=>e.subscribe(t,n));return i.unsubscribe?()=>i.unsubscribe():i}const Nr=[];function Fr(e,t=je){let n=null;const i=new Set;function a(t){if(pt(e,t)&&(e=t,n)){const t=!Nr.length;for(const n of i)n[1](),Nr.push(n,e);if(t){for(let e=0;e<Nr.length;e+=2)Nr[e][0](Nr[e+1]);Nr.length=0}}}function r(t){a(t(e))}return{set:a,update:r,subscribe:function(s,o=je){const l=[s,o];return i.add(l),1===i.size&&(n=t(a,r)||je),s(e),()=>{i.delete(l),0===i.size&&n&&(n(),n=null)}}}}function Br(e,t,n){const i=!Array.isArray(e),a=i?[e]:e;if(!a.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const r=t.length<2;return s=(e,n)=>{let s=!1;const o=[];let l=0,c=je;const d=()=>{if(l)return;c();const a=t(i?o[0]:o,e,n);r?e(a):c="function"==typeof a?a:je},u=a.map((e,t)=>Lr(e,e=>{o[t]=e,l&=~(1<<t),s&&d()},()=>{l|=1<<t}));return s=!0,d(),function(){Ue(u),c(),s=!1}},{subscribe:Fr(n,s).subscribe};var s}function jr(e){let t;return Lr(e,e=>t=e)(),t}const Ur={activeInstanceId:null,isStudying:!1};const Vr=function(){const{subscribe:e,set:t,update:n}=Fr(Ur);return{subscribe:e,registerInstance:t=>{const i=jr({subscribe:e});return i.activeInstanceId&&i.activeInstanceId!==t?(_e.warn("[StudyModeStore] 已存在活跃的学习会话，拒绝注册:",i.activeInstanceId),!1):(n(e=>({...e,activeInstanceId:t,isStudying:!0})),_e.debug("[StudyModeStore] 学习会话已注册:",t),!0)},unregisterInstance:e=>{n(t=>t.activeInstanceId===e?(_e.debug("[StudyModeStore] 学习会话已注销:",e),{...t,activeInstanceId:null,isStudying:!1}):t)},getState:()=>jr({subscribe:e}),hasActiveInstance:()=>null!==jr({subscribe:e}).activeInstanceId,getActiveInstance:()=>{const t=jr({subscribe:e});return t.activeInstanceId?{id:t.activeInstanceId}:null},reset:()=>{t(Ur),_e.debug("[StudyModeStore] 状态已重置")}}}();function qr(e){return Vr.registerInstance(e)}function Hr(e){Vr.unregisterInstance(e)}Br(Vr,e=>e.isStudying);const Wr=Object.freeze(Object.defineProperty({__proto__:null,endStudySession:Hr,studyModeStore:Vr,tryStartStudySession:qr},Symbol.toStringTag,{value:"Module"}));var Gr=(e=>(e[e.New=0]="New",e[e.Learning=1]="Learning",e[e.Review=2]="Review",e[e.Relearning=3]="Relearning",e))(Gr||{}),Qr=(e=>(e[e.Again=1]="Again",e[e.Hard=2]="Hard",e[e.Good=3]="Good",e[e.Easy=4]="Easy",e))(Qr||{}),Kr=(e=>(e.Basic="basic",e.Cloze="cloze",e.Multiple="multiple",e.Code="code",e.ProgressiveParent="progressive-parent",e.ProgressiveChild="progressive-child",e))(Kr||{});const Zr=[{id:"basic",name:"基础",colorStart:"#ef4444",colorEnd:"#dc2626",order:0,isDefault:!0,created:(new Date).toISOString(),modified:(new Date).toISOString()},{id:"reading",name:"阅读",colorStart:"#3b82f6",colorEnd:"#2563eb",order:1,isDefault:!0,created:(new Date).toISOString(),modified:(new Date).toISOString()},{id:"interest",name:"兴趣",colorStart:"#f59e0b",colorEnd:"#d97706",order:2,isDefault:!0,created:(new Date).toISOString(),modified:(new Date).toISOString()}],Yr=Object.freeze(Object.defineProperty({__proto__:null,CardState:Gr,CardType:Kr,DEFAULT_CATEGORIES:Zr,Rating:Qr},Symbol.toStringTag,{value:"Module"}));class Xr{static calculate(e,t,n=[10]){if(!e.fsrs)return _e.warn("[StepIndexCalculator] 卡片缺少FSRS数据，返回stepIndex=0"),0;const i=e.fsrs.state;if(i!==Gr.Learning&&i!==Gr.Relearning)return 0;const a=i===Gr.Relearning?n:t;if(0===a.length)return _e.warn("[StepIndexCalculator] learningSteps为空，返回stepIndex=0"),0;const r=24*(e.fsrs.scheduledDays||0)*60,s=this.findMatchingStepIndex(r,a);return _e.debug("[StepIndexCalculator] 计算stepIndex:",{cardId:e.uuid.slice(0,8),state:Gr[i],scheduledDays:e.fsrs.scheduledDays,scheduledMinutes:r.toFixed(2),steps:a,calculatedIndex:s,matchedStep:a[s]}),s}static findMatchingStepIndex(e,t){if(0===t.length)return 0;let n=0,i=1/0;for(let a=0;a<t.length;a++){const r=t[a],s=Math.abs(e-r);if(s<=.1*r)return _e.debug(`[StepIndexCalculator] 精确匹配: index=${a}, step=${r}分钟, diff=${s.toFixed(2)}分钟`),a;s<i&&(i=s,n=a)}return _e.debug(`[StepIndexCalculator] 最近邻匹配: index=${n}, step=${t[n]}分钟, diff=${i.toFixed(2)}分钟`),n}static calculateNext(e,t,n){switch(t){case 1:return 0;case 2:return e;case 3:const i=e+1;return i<n.length?i:-1;case 4:return-1;default:return _e.warn(`[StepIndexCalculator] 未知评分: ${t}`),e}}static validate(e,t,n){var i;const a=this.calculate(e,n),r=a===t;return r||_e.warn("[StepIndexCalculator] 一致性验证失败:",{cardId:e.uuid.slice(0,8),expected:t,calculated:a,scheduledDays:null==(i=e.fsrs)?void 0:i.scheduledDays,steps:n}),r}static getStepInfo(e,t,n=[10]){var i,a,r;const s=this.calculate(e,t,n),o=(null==(i=e.fsrs)?void 0:i.state)===Gr.Relearning?n:t;return{stepIndex:s,currentStep:null!=(a=o[s])?a:null,nextStep:null!=(r=o[s+1])?r:null,isLastStep:s===o.length-1,willGraduate:s>=o.length-1}}}const Jr=class e{constructor(){oe(this,"sessions",new Map),oe(this,"SESSION_TIMEOUT",72e5),oe(this,"cleanupTimer",null),oe(this,"persistedSession",null),oe(this,"learningStepsConfig",new Map),this.startAutoCleanup()}static getInstance(){return e.instance||(e.instance=new e),e.instance}createSession(e,t=[1,10],n=[10]){const i=`${e.uuid}-${Date.now()}`;e.fsrs||(_e.warn(`[StudySessionManager] 卡片 ${e.uuid} 缺少FSRS数据，自动初始化`),e.fsrs={due:(new Date).toISOString(),stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:0,lastReview:(new Date).toISOString()});const a=Xr.calculate(e,t,n);this.learningStepsConfig.set(i,{learningSteps:t,relearningSteps:n});const r={sessionId:i,cardId:e.uuid,learningStepIndex:a,startTime:Date.now(),interactionCount:0,currentState:e.fsrs.state};return this.sessions.set(i,r),_e.debug(`[StudySessionManager] 创建会话: ${i}, stepIndex: ${a} (从FSRS推断)`),i}getSessionState(e){return this.sessions.get(e)||null}updateStepIndex(e,t){const n=this.sessions.get(e);n?(n.learningStepIndex=t,n.interactionCount++,_e.debug(`[StudySessionManager] 更新步骤索引: ${e}, stepIndex: ${t}`)):_e.warn(`[StudySessionManager] 会话不存在: ${e}`)}updateSession(e,t){const n=this.sessions.get(e);n?Object.assign(n,t):_e.warn(`[StudySessionManager] 会话不存在: ${e}`)}finalizeSession(e){const t=this.sessions.get(e);if(!t)return _e.warn(`[StudySessionManager] 会话不存在: ${e}`),{};const n=Date.now()-t.startTime,i={learningStepIndex:t.learningStepIndex,interactionCount:t.interactionCount,sessionDuration:n};return _e.debug(`[StudySessionManager] 会话完成: ${e}, 时长: ${n}ms`),i}dispose(e){const t=this.sessions.delete(e);this.learningStepsConfig.delete(e),t&&_e.debug(`[StudySessionManager] 销毁会话: ${e}`)}clearAll(){const e=this.sessions.size;this.sessions.clear(),this.learningStepsConfig.clear(),_e.debug(`[StudySessionManager] 清理所有会话，共 ${e} 个`)}startAutoCleanup(){this.cleanupTimer=setInterval(()=>{this.cleanupExpiredSessions()},18e5)}cleanupExpiredSessions(){const e=Date.now(),t=[];for(const[n,i]of this.sessions.entries())e-i.startTime>this.SESSION_TIMEOUT&&t.push(n);t.length>0&&(t.forEach(e=>this.sessions.delete(e)),_e.debug(`[StudySessionManager] 清理过期会话: ${t.length} 个`))}stopAutoCleanup(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}getActiveSessionCount(){return this.sessions.size}debugPrintSessions(){_e.debug(`[StudySessionManager] 活跃会话数: ${this.sessions.size}`);for(const[e,t]of this.sessions.entries())_e.debug(`  - ${e}: cardId=${t.cardId}, stepIndex=${t.learningStepIndex}`)}persistSession(e,t){const n=this.sessions.get(e);if(!n)throw new Error(`[StudySessionManager] 无法持久化：会话不存在 ${e}`);return this.persistedSession={sessionId:e,deckId:t.deckId,currentCardIndex:t.currentCardIndex,currentCardId:t.currentCardId,remainingCardIds:t.remainingCardIds,startTime:n.startTime,pauseTime:Date.now(),stats:t.stats,isPaused:!0,sessionType:t.sessionType},_e.debug("[StudySessionManager] 会话已持久化:",e),this.persistedSession}restoreSession(e){const t=`restored-${Date.now()}`,n={sessionId:t,cardId:e.currentCardId,learningStepIndex:0,startTime:e.startTime,interactionCount:e.stats.completed,currentState:Gr.New};return this.sessions.set(t,n),this.persistedSession=null,_e.debug("[StudySessionManager] 会话已恢复:",t),t}pauseSession(e){this.sessions.get(e)?_e.debug("[StudySessionManager] 会话已暂停:",e):_e.warn(`[StudySessionManager] 无法暂停：会话不存在 ${e}`)}resumeSession(e){this.sessions.get(e)?_e.debug("[StudySessionManager] 会话已恢复:",e):_e.warn(`[StudySessionManager] 无法恢复：会话不存在 ${e}`)}hasPersistedSession(){return null!==this.persistedSession}getPersistedSession(){return this.persistedSession}clearPersistedSession(){this.persistedSession&&(_e.debug("[StudySessionManager] 持久化会话已清除:",this.persistedSession.sessionId),this.persistedSession=null)}setPersistedSession(e){this.persistedSession=e,_e.debug("[StudySessionManager] 持久化会话已设置:",e.sessionId)}};oe(Jr,"instance");let es=Jr;const ts="tuanki-study-view";class ns extends ge.ItemView{constructor(e,t){super(e),oe(this,"component",null),oe(this,"plugin"),oe(this,"instanceId"),oe(this,"isPaused",!1),oe(this,"studySessionManager"),oe(this,"isPauseHandling",!1),oe(this,"isClosing",!1),oe(this,"deckId"),oe(this,"mode"),oe(this,"cardIds"),this.plugin=t,this.instanceId=`study-view-${Date.now()}`,this.studySessionManager=es.getInstance(),_e.debug("[StudyView] 视图实例已创建:",this.instanceId)}getViewType(){return ts}getDisplayText(){return"Tuanki 学习"}getState(){const e={deckId:this.deckId,mode:this.mode,cardIds:this.cardIds};return _e.debug("[StudyView] 序列化状态:",e),e}async setState(e,t){var n;if(await super.setState(e,t),e){const t=this.deckId,i=this.mode,a=this.cardIds;if(this.deckId=e.deckId,this.mode=e.mode,this.cardIds=e.cardIds,_e.debug("[StudyView] ✅ 接收到学习参数:",{deckId:this.deckId,mode:this.mode,cardIds:null==(n=this.cardIds)?void 0:n.length}),this.component){(t!==this.deckId||i!==this.mode||JSON.stringify(a)!==JSON.stringify(this.cardIds))&&(_e.debug("[StudyView] 🔄 检测到参数变化，通知组件更新"),"function"==typeof this.component.updateStudyParams&&await this.component.updateStudyParams({deckId:this.deckId,mode:this.mode,cardIds:this.cardIds}))}else{_e.debug("[StudyView] 🔧 组件未创建，现在创建");this.studySessionManager.hasPersistedSession()?_e.debug("[StudyView] 等待用户选择恢复会话"):await this.createStudyComponent({deckId:this.deckId,mode:this.mode,cardIds:this.cardIds})}}}getIcon(){return"graduation-cap"}allowNoFile(){return!0}async waitForDataStorage(){if(this.plugin.dataStorage)return;_e.debug("[StudyView] 等待 dataStorage 初始化...");for(let e=0;e<100;e++){if(this.plugin.dataStorage)return void _e.debug(`[StudyView] dataStorage 已就绪（耗时 ${100*e}ms）`);await new Promise(e=>setTimeout(e,100))}throw new Error("dataStorage 初始化超时")}showLoadingState(){this.contentEl.createDiv({cls:"tuanki-study-loading",text:"正在初始化学习界面..."})}getNavigationType(){return"tab"}async onOpen(){_e.debug("[StudyView] 视图正在打开...",this.instanceId),this.contentEl.empty(),this.contentEl.addClass("tuanki-study-view-content"),this.contentEl.addClass("tuanki-main-editor-mode"),this.showLoadingState(),this.initializeAsync()}async initializeAsync(){try{await this.waitForDataStorage();const e=(await Promise.resolve().then(()=>Wr)).studyModeStore.getActiveInstance();e&&e.id!==this.instanceId&&(_e.debug("[StudyView] 检测到残留的学习实例，清理中...",e.id),Hr(e.id));if(!qr(this.instanceId))return _e.warn("[StudyView] 已有活跃的学习会话，阻止打开"),this.contentEl.empty(),void this.contentEl.createDiv({cls:"tuanki-study-view-blocked",text:"⚠️ 已有学习会话正在进行中。为保持专注，请先完成或关闭当前会话。"});this.studySessionManager.hasPersistedSession()&&await this.showRestoreSessionPrompt(),this.registerViewEvents()}catch(e){_e.error("[StudyView] 初始化失败:",e),this.contentEl.empty(),this.contentEl.createDiv({cls:"error",text:"学习视图初始化失败"})}}async showRestoreSessionPrompt(){const e=this.contentEl.createDiv({cls:"tuanki-study-restore-prompt"});e.createEl("h3",{text:"发现未完成的学习会话"}),e.createEl("p",{text:"是否恢复上次的学习进度？"});const t=e.createDiv({cls:"button-container"});t.createEl("button",{text:"恢复会话",cls:"mod-cta"}).addEventListener("click",async()=>{await this.restoreSession()});t.createEl("button",{text:"开始新会话"}).addEventListener("click",async()=>{this.studySessionManager.clearPersistedSession(),await this.createStudyComponent({deckId:this.deckId,mode:this.mode,cardIds:this.cardIds})})}async restoreSession(){const e=this.studySessionManager.getPersistedSession();if(!e)return _e.warn("[StudyView] 无法恢复：持久化会话不存在"),void(await this.createStudyComponent({deckId:this.deckId,mode:this.mode,cardIds:this.cardIds}));_e.debug("[StudyView] 正在恢复会话...",e),this.studySessionManager.restoreSession(e),await this.createStudyComponent({deckId:e.deckId||this.deckId,resumeData:e})}async createStudyComponent(e){var t;try{if(!(null==e?void 0:e.resumeData)){if(!((null==e?void 0:e.deckId)||(null==e?void 0:e.cardIds)&&0!==e.cardIds.length))return _e.error("[StudyView] 缺少必要的学习参数"),this.contentEl.empty(),void this.contentEl.createDiv({cls:"tuanki-study-view-error",text:"⚠️ 学习参数无效，请重新选择牌组进入学习。"});if((null==e?void 0:e.deckId)&&(!(null==e?void 0:e.cardIds)||0===e.cardIds.length)){_e.debug("[StudyView] 🔍 验证牌组是否有可学习的卡片...");const{loadDeckCardsForStudy:t,getLearnedNewCardsCountToday:n}=await Promise.resolve().then(()=>_ie),i=this.plugin.dataStorage;if(!i)return _e.error("[StudyView] DataStorage 未初始化"),this.contentEl.empty(),void this.contentEl.createDiv({cls:"tuanki-study-view-error",text:"⚠️ 数据服务未就绪，请稍后重试。"});const a=this.plugin.settings.newCardsPerDay||20,r=this.plugin.settings.reviewsPerDay||20,s=(await n(i,e.deckId),await t(i,e.deckId,a,r));if(_e.debug("[StudyView] 🎯 预检查结果:",{deckId:e.deckId.slice(0,8),cardsFound:s.length}),0===s.length)return _e.warn("[StudyView] ⚠️ 牌组无可学习的卡片，关闭学习界面"),this.contentEl.empty(),void this.close()}}this.contentEl.empty(),this.contentEl.addClass("tuanki-study-view-content"),this.contentEl.addClass("tuanki-main-editor-mode");const{mount:n}=await Promise.resolve().then(()=>Or),{default:i}=await Promise.resolve().then(()=>Pbe);this.component=n(i,{target:this.contentEl,props:{plugin:this.plugin,viewInstance:this,deckId:null==e?void 0:e.deckId,mode:null==e?void 0:e.mode,cardIds:null==e?void 0:e.cardIds,resumeData:null==e?void 0:e.resumeData,onClose:()=>{this.close()},onPause:()=>{this.handlePause()},onResume:()=>{this.handleResume()}}}),_e.debug("[StudyView] ✅ 学习组件已挂载",{deckId:null==e?void 0:e.deckId,mode:null==e?void 0:e.mode,cardIds:null==(t=null==e?void 0:e.cardIds)?void 0:t.length})}catch(n){_e.error("[StudyView] 创建学习组件失败:",n),this.contentEl.empty(),this.contentEl.createDiv({cls:"error",text:"加载学习界面失败"})}}registerViewEvents(){this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{e===this.leaf?this.handleActivate():this.leaf&&e!==this.leaf&&this.handleDeactivate()}))}handleActivate(){this.isPaused&&this.component&&(_e.debug("[StudyView] 视图激活 - 恢复学习"),this.handleResume())}handleDeactivate(){!this.isPaused&&this.component&&(_e.debug("[StudyView] 视图失活 - 暂停学习"),this.handlePause())}handlePause(){if(this.isPauseHandling)_e.debug("[StudyView] 防止重入：暂停处理中");else{this.isPauseHandling=!0;try{this.isPaused=!0,_e.debug("[StudyView] 学习已暂停"),this.component&&"function"==typeof this.component.pause&&this.component.pause()}finally{this.isPauseHandling=!1}}}handleResume(){this.isPaused=!1,_e.debug("[StudyView] 学习已恢复"),this.component&&"function"==typeof this.component.resume&&this.component.resume()}persistCurrentSession(e){if(_e.debug("[StudyView] 持久化会话状态"),this.component&&"function"==typeof this.component.getSessionData){const e=this.component.getSessionData();_e.debug("[StudyView] 会话数据已准备持久化:",e)}}async onClose(){if(_e.debug("[StudyView] 视图正在关闭...",this.instanceId),this.component){try{const{unmount:e}=await Promise.resolve().then(()=>Or);e(this.component),_e.debug("[StudyView] 学习组件已销毁")}catch(e){_e.error("[StudyView] 销毁学习组件失败:",e)}this.component=null}Hr(this.instanceId),_e.debug("[StudyView] 学习实例已注销:",this.instanceId),this.studySessionManager.clearPersistedSession(),_e.debug("[StudyView] 视图已完全关闭，所有状态已清理")}close(){this.isClosing?_e.debug("[StudyView] 防止重入：视图正在关闭中"):(this.isClosing=!0,this.leaf.detach())}}const is="tuanki-filter-view";class as extends ge.ItemView{constructor(e,t){super(e),oe(this,"component",null),oe(this,"plugin"),this.plugin=t}getViewType(){return is}getDisplayText(){return"Tuanki 筛选器"}getIcon(){return"filter"}async onOpen(){_e.debug("[FilterView] Opening filter view");const{contentEl:e}=this;e.empty(),e.addClass("tuanki-filter-view"),e.createDiv({cls:"tuanki-filter-loading",text:"正在加载筛选器..."}),this.loadComponentAsync()}async loadComponentAsync(){try{await this.waitForDataStorage(),this.contentEl.empty();const{mount:e}=await Promise.resolve().then(()=>Or),{default:t}=await Promise.resolve().then(()=>Cke);this.component=e(t,{target:this.contentEl,props:{plugin:this.plugin}}),_e.debug("[FilterView] Filter panel component mounted")}catch(e){_e.error("[FilterView] Failed to mount filter panel:",e),this.contentEl.empty(),this.contentEl.innerHTML='<div class="error">筛选器加载失败</div>'}}async waitForDataStorage(){if(this.plugin.dataStorage)return;_e.debug("[FilterView] 等待 dataStorage 初始化...");for(let e=0;e<100;e++){if(this.plugin.dataStorage)return void _e.debug(`[FilterView] dataStorage 已就绪（耗时 ${100*e}ms）`);await new Promise(e=>setTimeout(e,100))}throw new Error("dataStorage 初始化超时")}async onClose(){if(_e.debug("[FilterView] Closing filter view"),this.component){const{unmount:e}=await Promise.resolve().then(()=>Or);e(this.component),this.component=null}}getDisplayTextExtra(){if(!this.plugin.filterStateService)return"";return this.plugin.filterStateService.hasActiveFilters()?"●":""}}const rs="tuanki-question-bank-view";class ss extends ge.ItemView{constructor(e,t){super(e),oe(this,"component",null),oe(this,"plugin"),oe(this,"instanceId"),oe(this,"isClosing",!1),oe(this,"bankId"),oe(this,"bankName"),oe(this,"questions"),oe(this,"mode"),oe(this,"config"),this.plugin=t,this.instanceId=`question-bank-view-${Date.now()}`,_e.debug("[QuestionBankView] 视图实例已创建:",this.instanceId)}getViewType(){return rs}getDisplayText(){return this.bankName||"Tuanki 刷题"}getIcon(){return"clipboard-list"}allowNoFile(){return!0}getNavigationType(){return"tab"}getState(){return{}}async setState(e,t){if(await super.setState(e,t),!e||!e.bankId)return _e.debug("[QuestionBankView] 检测到空状态或无效 bankId，关闭视图"),void setTimeout(()=>{this.leaf.detach()},100);const n=this.bankId;this.bankId=e.bankId,this.bankName=e.bankName,this.mode=e.mode,this.config=e.config,_e.debug("[QuestionBankView] ✅ 接收到刷题参数:",{bankId:this.bankId,bankName:this.bankName,mode:this.mode}),this.component?n!==this.bankId&&(_e.debug("[QuestionBankView] 🔄 题库ID变化，重新加载"),await this.loadQuestionsAndCreateComponent()):(_e.debug("[QuestionBankView] 🔧 组件未创建，现在创建"),await this.loadQuestionsAndCreateComponent())}async waitForQuestionBankService(){if(this.plugin.questionBankService)return;_e.debug("[QuestionBankView] 等待题库服务初始化...");for(let e=0;e<300;e++){if(this.plugin.questionBankService)return void _e.debug(`[QuestionBankView] 题库服务已就绪（耗时 ${100*e}ms）`);await new Promise(e=>setTimeout(e,100))}throw new Error("题库服务初始化超时")}showLoadingState(){this.contentEl.empty(),this.contentEl.createDiv({cls:"tuanki-study-loading",text:"正在加载题库..."})}showError(e){this.contentEl.empty(),this.contentEl.createDiv({cls:"tuanki-study-view-error",text:`⚠️ ${e}`})}async loadQuestionsAndCreateComponent(){var e;if(!this.bankId)return _e.error("[QuestionBankView] 缺少 bankId"),void this.showError("题库ID无效，请重新选择题库");try{this.showLoadingState(),await this.waitForQuestionBankService();const t=await(null==(e=this.plugin.questionBankService)?void 0:e.getQuestionsByBank(this.bankId));if(!t||0===t.length)return void this.showError("题库为空，请先添加题目");this.questions=t,_e.debug("[QuestionBankView] 已加载题目:",t.length),await this.createStudyComponent()}catch(t){_e.error("[QuestionBankView] 加载题目失败:",t),this.showError("加载题目失败: "+(t instanceof Error?t.message:"未知错误"))}}async createStudyComponent(){try{this.contentEl.empty(),this.contentEl.addClass("tuanki-question-bank-view-content"),this.contentEl.addClass("tuanki-main-editor-mode");const{mount:e}=await Promise.resolve().then(()=>Or),{default:t}=await Promise.resolve().then(()=>y_e);this.component=e(t,{target:this.contentEl,props:{plugin:this.plugin,bankId:this.bankId,bankName:this.bankName,questions:this.questions,mode:this.mode||"practice",config:this.config,onBack:()=>{this.close()}}}),_e.debug("[QuestionBankView] ✅ 刷题组件已挂载（保持模态窗风格）")}catch(e){_e.error("[QuestionBankView] 创建组件失败:",e),this.showError("加载界面失败")}}async onOpen(){_e.debug("[QuestionBankView] 视图正在打开...",this.instanceId),this.contentEl.empty(),this.contentEl.addClass("tuanki-question-bank-view-content"),this.contentEl.addClass("tuanki-main-editor-mode"),this.showLoadingState(),this.initializeAsync()}async initializeAsync(){try{this.bankId?await this.loadQuestionsAndCreateComponent():_e.debug("[QuestionBankView] 等待接收刷题参数...")}catch(e){_e.error("[QuestionBankView] 初始化失败:",e),this.showError("初始化失败")}}async onClose(){if(_e.debug("[QuestionBankView] 视图正在关闭...",this.instanceId),this.component){try{const{unmount:e}=await Promise.resolve().then(()=>Or);e(this.component),_e.debug("[QuestionBankView] 刷题组件已销毁")}catch(e){_e.error("[QuestionBankView] 销毁组件失败:",e)}this.component=null}_e.debug("[QuestionBankView] 视图已完全关闭")}close(){this.isClosing?_e.debug("[QuestionBankView] 防止重入：视图正在关闭中"):(this.isClosing=!0,this.leaf.detach())}}const os="tuanki",ls=".tuanki",cs="tuanki-data",ds="media",us={root:os,decks:`${os}/decks`,indices:`${os}/indices`,temp:`${os}/temp`,profile:`${os}/profile`,questionBank:`${os}/question-bank`,media:`${os}/${ds}`},hs=".obsidian/plugins/tuanki/backups";function ps(){return us.media}function gs(e){return hs}function vs(e){return us}const fs="default",ms=Object.freeze(Object.defineProperty({__proto__:null,BACKUP_FOLDER:hs,DEFAULT_DATA_SOURCE:fs,DEFAULT_MEDIA_FOLDER_NAME:ds,LEGACY_TUANKI_DATA_V1:ls,LEGACY_TUANKI_DATA_V2:cs,PATHS:us,TUANKI_DATA:os,getBackupPath:gs,getDataSourcePaths:vs,getMediaFolder:ps},Symbol.toStringTag,{value:"Module"}));class ys{static async ensureDir(e,t){if(!t||"string"!=typeof t||""===t.trim())throw new Error("目录路径不能为空");const n=t.trim();if(!(await e.exists(n)))try{await e.mkdir(n),_e.debug(`✅ 目录已创建: ${n}`)}catch(i){const e=i instanceof Error?i.message:String(i);if(e.toLowerCase().includes("exist"))return void _e.debug(`ℹ️ 目录已存在: ${n}`);throw new Error(`创建目录失败 ${n}: ${e}`)}}static async ensureDirRecursive(e,t){if(!t||"string"!=typeof t||""===t.trim())throw new Error("目录路径不能为空");const n=t.trim().split("/").filter(e=>e&&""!==e.trim());if(0===n.length)throw new Error("无效的目录路径");let i="";for(const a of n)i+=(i?"/":"")+a,await this.ensureDir(e,i)}static async exists(e,t){return!(!t||"string"!=typeof t||""===t.trim())&&await e.exists(t.trim())}static async ensureDirForFile(e,t){if(!t||"string"!=typeof t||""===t.trim())throw new Error("文件路径不能为空");const n=t.trim(),i=n.lastIndexOf("/");if(-1===i)return;const a=n.substring(0,i);await this.ensureDirRecursive(e,a)}}class bs{constructor(e){oe(this,"plugin"),oe(this,"deckWriteQueue",new Map),this.plugin=e}get dataFolder(){return us.root}async initialize(){try{_e.info("🚀 Initializing Anki data storage..."),_e.info(`📁 Data folder: ${this.dataFolder}`),_e.info("📂 Creating data directories..."),await this.ensureDataFolder(),_e.info("📄 Creating data files..."),await this.ensureDataFiles(),_e.info("🎯 Ensuring default deck..."),await this.ensureDefaultDeck();const e=await this.getDecks();_e.info(`✅ Anki data storage initialized successfully! Found ${e.length} deck(s)`)}catch(e){_e.error("❌ Failed to initialize data storage:",e),_e.warn("Plugin will continue running with default data...")}}async ensureDataFolder(){try{await ys.ensureDirRecursive(this.plugin.app.vault.adapter,this.dataFolder),_e.debug(`✅ 数据根目录已确保存在: ${this.dataFolder}`)}catch(e){throw _e.error(`❌ 创建数据根目录失败: ${this.dataFolder}`,e),e}}async ensureDataFiles(){const e=this.plugin.app.vault.adapter,t=[`${this.dataFolder}/decks`,`${this.dataFolder}/learning`,`${this.dataFolder}/learning/sessions`,`${this.dataFolder}/profile`];for(const a of t)try{await ys.ensureDirRecursive(e,a),_e.debug(`✅ 目录已确保存在: ${a}`)}catch(i){_e.warn(`⚠️ 创建目录失败: ${a}`,i)}const n=[{path:`${this.dataFolder}/decks/decks.json`,key:"decks.json"},{path:`${this.dataFolder}/profile/user-profile.json`,key:"user-profile.json"}];for(const{path:a,key:r}of n)try{if(await e.exists(a))_e.debug(`Data file already exists: ${a}`);else{const t=this.getDefaultData(r);await e.write(a,JSON.stringify(t,null,2)),_e.debug(`Created data file: ${a}`)}}catch(i){const e=extractErrorMessage(i);if(e.includes("already exists")||e.includes("File already exists")){_e.debug(`Data file creation skipped (already exists): ${a}`);continue}_e.warn(`Data file creation warning for ${a}:`,i)}}getDefaultData(e){switch(e){case"decks.json":return{decks:[]};case"user-profile.json":return this.createDefaultUserProfile();default:return{}}}async ensureDefaultDeck(){var e,t;try{const t=await this.getDecks();if(Array.isArray(t)&&t.length>0)return void _e.debug(`✅ Default deck check passed: ${t.length} deck(s) found`);_e.info("🔄 Creating default deck for first-time use...");const n=new Date,i=(null==(e=this.plugin.settings)?void 0:e.defaultDeck)||"默认牌组",a=this.createDefaultUserProfile().profile.globalSettings.defaultDeckSettings,r={id:`deck_${Date.now().toString(36)}`,name:i,description:"",category:"默认",path:i,level:0,order:0,inheritSettings:!1,created:n.toISOString(),modified:n.toISOString(),settings:a,includeSubdecks:!1,stats:{totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:0,forecastDays:{}},tags:[],metadata:{}};await this.writeJsonFile("decks/decks.json",{decks:[r]}),_e.info("✅ Successfully created default deck:",i);const s=this.plugin.fsrs;if(s){const{generateUUID:e}=await Promise.resolve().then(()=>Xu),t={uuid:e(),deckId:r.id,content:"Obsidian 是什么？\n\n---div---\n\nObsidian 是一款强大的知识管理和笔记软件，支持双向链接和插件扩展。",type:Kr.Basic,tags:["入门"],created:n.toISOString(),modified:n.toISOString(),fsrs:s.createCard(),reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0}};await this.saveDeckCards(r.id,[t]),_e.info("✅ Added a sample card to the default deck.")}}catch(n){const e=extractErrorMessage(n);if(e.includes("already exists")||e.includes("File already exists")){_e.debug("ℹ️ Default deck file already exists, checking content...");try{const e=await this.getDecks();if(Array.isArray(e)&&e.length>0)_e.debug("✅ Existing deck file is valid with",e.length,"deck(s)");else{_e.warn("⚠️ Existing deck file is empty or invalid, updating content...");try{const e=new Date,n=(null==(t=this.plugin.settings)?void 0:t.defaultDeck)||"默认牌组",i=this.createDefaultUserProfile().profile.globalSettings.defaultDeckSettings,a={id:`deck_${Date.now().toString(36)}`,name:n,description:"自动创建的默认牌组",category:"默认",path:n,level:0,order:0,inheritSettings:!1,created:e.toISOString(),modified:e.toISOString(),settings:i,includeSubdecks:!1,stats:{totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:0,forecastDays:{}},tags:[],metadata:{autoCreated:!0}};await this.updateExistingDeckFile("decks/decks.json",{decks:[a]}),_e.info("✅ Successfully updated deck file with default deck")}catch(i){_e.error("❌ Failed to update deck file:",i),_e.info("ℹ️ Continuing with plugin initialization despite deck file issue")}}}catch(a){_e.warn("⚠️ Could not validate existing deck file:",a)}}else _e.warn("⚠️ ensureDefaultDeck failed:",n)}}createDefaultUserProfile(){return{profile:{id:"default-user",name:"Default User",created:(new Date).toISOString(),globalSettings:{timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:"zh-CN",theme:"auto",defaultDeckSettings:{newCardsPerDay:20,maxReviewsPerDay:100,enableAutoAdvance:!0,showAnswerTime:0,fsrsParams:{w:[.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,.1542],requestRetention:.9,maximumInterval:36500,enableFuzz:!0},learningSteps:[1,10],relearningSteps:[10],graduatingInterval:1,easyInterval:4},enableNotifications:!0,enableSounds:!1,enableDebugMode:!1,dataBackupInterval:24},overallStats:{totalDecks:0,totalCards:0,totalStudyTime:0,streakDays:0}}}}async getDecks(){try{const e="decks/decks.json";if(!(await this.exists(`${this.dataFolder}/${e}`)))return[];return(await this.readJsonFile(e)).decks||[]}catch(e){return[]}}async getDeck(e){try{return(await this.getDecks()).find(t=>t.id===e)||null}catch(t){return _e.error("Failed to get deck:",t),null}}async getAllDecks(){return this.getDecks()}async getCardsByDeck(e){return this.getDeckCards(e)}async saveDeck(e){try{const t=await this.getDecks(),n=t.findIndex(t=>t.id===e.id),i=n<0;n>=0?t[n]={...e,modified:(new Date).toISOString()}:t.push({...e,created:(new Date).toISOString(),modified:(new Date).toISOString()}),await this.writeJsonFile("decks/decks.json",{decks:t}),await new Promise(e=>setTimeout(e,50));const a=this.plugin.dataSyncService;return a&&"function"==typeof a.notifyChange&&await a.notifyChange({type:"decks",action:i?"create":"update",ids:[e.id]}),{success:!0,data:e,timestamp:(new Date).toISOString()}}catch(t){return _e.error("Failed to save deck:",t),{success:!1,error:extractErrorMessage(t),timestamp:(new Date).toISOString()}}}async deleteDeck(e){try{_e.debug(`🗑️ 开始删除牌组: ${e}`);const n=await this.getDeckCards(e);if(n.length>0){const{Notice:e}=be.default||be;new e(`🧹 正在清理 ${n.length} 张卡片的源文档...`)}const i=(await this.getDecks()).filter(t=>t.id!==e);await this.writeJsonFile("decks/decks.json",{decks:i}),_e.debug(`✅ 已从牌组索引中移除: ${e}`),await this.deleteCardsByDeck(e);try{const t=this.plugin.app.vault.adapter;t.rmdir&&(await t.rmdir(`${this.dataFolder}/decks/${e}/media`,!0),_e.debug(`✅ 已删除媒体目录: ${e}`))}catch(t){}try{const t=this.plugin.app.vault.adapter;t.rmdir&&(await t.rmdir(`${this.dataFolder}/decks/${e}`,!0),_e.debug(`✅ 已删除牌组目录: ${e}`))}catch(t){}await this.cleanupStudySessionsByDeck(e),await this.cleanupDeckMediaFiles(e),await this.notifyDeckDeletion(e),_e.info(`🎉 牌组删除完成: ${e}`),await new Promise(e=>setTimeout(e,50));const a=this.plugin.dataSyncService;return a&&"function"==typeof a.notifyChange&&await a.notifyChange({type:"decks",action:"delete",ids:[e]}),{success:!0,data:!0,timestamp:(new Date).toISOString()}}catch(n){return _e.error("Failed to delete deck:",n),{success:!1,error:extractErrorMessage(n),timestamp:(new Date).toISOString()}}}async getCards(e){try{if(null==e?void 0:e.deckId){const t=await this.getDeckCards(e.deckId);return e?this.filterCards(t,e):t}const n=await this.getDecks();let i=[];for(const e of n)try{const t=await this.getDeckCards(e.id);i=i.concat(t)}catch(t){}return e?this.filterCards(i,e):i}catch(n){return _e.error("Failed to get cards:",n),[]}}async saveCard(e){try{const{getProgressiveClozeGateway:t}=await Promise.resolve().then(()=>k_e),n=t(),i=(await this.getDeckCards(e.deckId)).find(t=>t.uuid===e.uuid);if(!i){const t=await n.processNewCard(e);if(t.converted){_e.info(`检测到渐进式挖空，保存${t.cards.length}张卡片（1父 + ${t.cards.length-1}子）`);const e=[];for(const n of t.cards){const t=this.normalizeCardData(n);await this.saveCardInternal(t),e.push(t)}return{success:!0,data:e[0],timestamp:(new Date).toISOString()}}let i=this.normalizeCardData(t.cards[0]);return await this.saveCardInternal(i)}if("progressive-parent"===i.type&&i.content!==e.content){_e.info("[Storage] 检测到父卡片内容变化，开始同步...");const t=await n.processContentChange(i,e.content,{deleteCard:async e=>{await this.deleteCard(e)},saveCard:async e=>{const t=this.normalizeCardData(e);await this.saveCardInternal(t)},getDeckCards:async e=>await this.getDeckCards(e)});return _e.info(`[Storage] ✅ 内容同步完成，更新了${t.length}张卡片`),{success:!0,data:t[0],timestamp:(new Date).toISOString()}}let a=this.normalizeCardData(e);return await this.saveCardInternal(a)}catch(t){return _e.error("Failed to save card:",t),{success:!1,error:extractErrorMessage(t),timestamp:(new Date).toISOString()}}}async saveCardInternal(e){const{isValidUUID:t}=await Promise.resolve().then(()=>Xu);if(!t(e.uuid))return _e.error("[Storage] 卡片UUID格式无效:",e.uuid),{success:!1,error:`卡片UUID格式无效: ${e.uuid}`,timestamp:(new Date).toISOString()};const n=e.deckId;if(!n)throw new Error("saveCard requires deckId");const i=await this.getDeckCards(n),a=i.findIndex(t=>t.uuid===e.uuid),r=new Date,s=a<0;a>=0?i[a]={...e,modified:r.toISOString()}:i.push({...e,created:r.toISOString(),modified:r.toISOString()}),await this.saveDeckCards(n,i),await new Promise(e=>setTimeout(e,50));const o=this.plugin.dataSyncService;o&&"function"==typeof o.notifyChange&&await o.notifyChange({type:"cards",action:s?"create":"update",ids:[e.uuid],metadata:{deckId:e.deckId}});const l=this.plugin.autoSyncManager;if(l&&"function"==typeof l.onCardChange&&l.onCardChange(e.deckId),this.plugin.directFileReader&&this.plugin.directFileReader.updateCardIndex(e),this.plugin.cardIndexService&&this.plugin.cardIndexService.updateCardIndex(e.uuid,e.deckId),"progressive-child"===e.type&&!s)try{const{getSiblingDispersionService:t}=await Promise.resolve().then(()=>C_e);t().adjustSiblingsAfterReview(e,this).catch(e=>{_e.warn("[Storage] 兄弟卡片分散调整失败（不影响保存）:",e)})}catch(c){_e.warn("[Storage] 无法加载兄弟分散服务:",c)}return{success:!0,data:e,timestamp:(new Date).toISOString()}}async addCard(e){return this.saveCard(e)}async updateCard(e){return this.saveCard(e)}async addDeck(e){return this.saveDeck(e)}async updateDeck(e){return this.saveDeck(e)}async deleteCard(e){try{let n,i,a,r=[];if(this.plugin.cardIndexService&&(n=this.plugin.cardIndexService.getDeckIdByUUID(e)),n)r=await this.getDeckCards(n),i=r.find(t=>t.uuid===e);else{_e.debug("[Storage] CardIndexService未找到卡片，使用遍历方式");const t=await this.getDecks();for(const a of t){const t=await this.getDeckCards(a.id);if(i=t.find(t=>t.uuid===e),i){n=a.id,r=t;break}}}if(i&&"progressive-parent"===i.type){_e.info(`[Storage] 检测到渐进式挖空父卡片: ${e}，开始级联删除子卡片`);const t=r.filter(t=>"progressive-child"===t.type&&t.parentCardId===e);_e.debug(`[Storage] 找到 ${t.length} 个子卡片需要删除`);for(const e of t){_e.debug(`[Storage] 删除子卡片: ${e.uuid} (clozeOrd: ${e.clozeOrd})`);const t=r.findIndex(t=>t.uuid===e.uuid);t>=0&&r.splice(t,1)}_e.info(`[Storage] ✅ 已级联删除 ${t.length} 个子卡片`)}if(n&&i&&r.length>0){const t=r.filter(t=>t.uuid!==e);await this.saveDeckCards(n,t),a=n}if(a){await new Promise(e=>setTimeout(e,50));const n=this.plugin.dataSyncService;if(n&&"function"==typeof n.notifyChange&&await n.notifyChange({type:"cards",action:"delete",ids:[e],metadata:{deckId:a}}),i){try{_e.debug(`[Storage] 开始清理卡片源文档: ${e}`);const t=this.plugin.blockLinkCleanupService;if(t)if("function"!=typeof t.cleanupAfterCardDeletion)_e.warn("[Storage] ⚠️ 清理服务方法不存在，跳过源文档清理");else{_e.debug(`[Storage] 调用清理服务: 文件=${i.sourceFile}, 块=${i.sourceBlock}`);const n=await t.cleanupAfterCardDeletion(i);if(n.success){if(_e.info(`[Storage] ✅ 已清理卡片源文档: ${e}, 清理项目: ${n.cleanedItems.length}`),n.cleanedItems.length>0){const{Notice:e}=be.default||be;new e(`🧹 已清理源文档中 ${n.cleanedItems.length} 项残留信息`)}}else _e.warn(`[Storage] ⚠️ 清理卡片源文档部分失败: ${n.error||"未知错误"}`)}else _e.warn("[Storage] ⚠️ 清理服务未初始化，跳过源文档清理")}catch(t){_e.error("[Storage] 清理块链接失败:",t),_e.error("[存储] 清理错误详情:",{cardUuid:e,sourceFile:i.sourceFile,sourceBlock:i.sourceBlock,error:t})}this.plugin.directFileReader&&this.plugin.directFileReader.removeCardIndex(e,i.uuid),this.plugin.cardIndexService&&this.plugin.cardIndexService.removeCardIndex(i.uuid)}return{success:!0,data:!0,timestamp:(new Date).toISOString()}}return{success:!0,data:!1,timestamp:(new Date).toISOString()}}catch(n){return _e.error("Failed to delete card:",n),{success:!1,error:extractErrorMessage(n),timestamp:(new Date).toISOString()}}}async getCardsByUUIDs(e){try{if(0===e.length)return[];_e.debug(`[WeaveDataStorage] 🔍 批量查询 ${e.length} 个UUID...`);const t=[],n=new Set(e),i=await this.getDecks();for(const e of i){const i=await this.getDeckCards(e.id);for(const e of i)if(n.has(e.uuid)&&(t.push(e),n.delete(e.uuid),0===n.size))break;if(0===n.size)break}return _e.debug(`[WeaveDataStorage] ✅ 批量查询完成: 找到${t.length}/${e.length}张卡片`),t}catch(t){return _e.error("[WeaveDataStorage] 批量查询失败:",t),[]}}async getCardByUUID(e){try{const t=await this.getCardsByUUIDs([e]);return t.length>0?t[0]:null}catch(t){return _e.error("[WeaveDataStorage] 根据UUID查询卡片失败:",t),null}}async markCardAsDeleted(e,t){try{_e.debug(`[WeaveDataStorage] 🗑️ 标记卡片为已删除: ${e} (来源: ${t})`);const n=await this.getCardByUUID(e);if(!n)return _e.warn(`[WeaveDataStorage] 卡片不存在: ${e}`),!1;n.deletedAt=Date.now(),n.deletionSource=t;const i=await this.saveCard(n);return i.success?(_e.info(`[WeaveDataStorage] ✅ 卡片已标记为删除: ${e}`),!0):(_e.error(`[WeaveDataStorage] ❌ 标记删除失败: ${i.error}`),!1)}catch(n){return _e.error("[WeaveDataStorage] 标记删除失败:",n),!1}}async markCardsAsDeleted(e,t){if(0===e.length)return 0;_e.debug(`[WeaveDataStorage] 🗑️ 批量标记 ${e.length} 张卡片为已删除...`);let n=0;for(const i of e){await this.markCardAsDeleted(i,t)&&n++}return _e.info(`[WeaveDataStorage] ✅ 批量标记完成: ${n}/${e.length} 张卡片`),n}async deleteCardsByDeck(e){_e.debug(`🗑️ 开始删除牌组中的所有卡片并清理源文档: ${e}`);try{const n=await this.getDeckCards(e);_e.debug(`📋 牌组包含 ${n.length} 张卡片，需要清理源文档`);let i=0,a=0;for(const e of n)try{const t=await this.deleteCard(e.uuid);t.success?(i++,_e.debug(`✅ 已删除并清理卡片: ${e.uuid}`)):(a++,_e.warn(`⚠️ 删除卡片失败: ${e.uuid}, 错误: ${t.error}`))}catch(t){a++,_e.error(`❌ 删除卡片异常: ${e.uuid}`,t)}if(_e.info(`🎉 牌组删除完成: 成功清理 ${i} 张卡片，失败 ${a} 张`),i>0){const{Notice:e}=be.default||be;new e(`✅ 已清理 ${i} 张卡片的源文档`)}const r=`${this.dataFolder}/decks/${e}/cards.json`,s=this.plugin.app.vault.adapter;await this.exists(r)&&s.remove&&(await s.remove(r),_e.debug(`🧹 已清理牌组文件: ${r}`))}catch(t){throw _e.error(`❌ 删除牌组卡片失败: ${e}`,t),t}}async cleanupStudySessionsByDeck(e){try{_e.debug(`🧹 开始清理牌组学习会话数据: ${e}`);const n=`${this.dataFolder}/learning/sessions`,i=this.plugin.app.vault.adapter,a=i.list?await i.list(n):{files:[],folders:[]},r=((null==a?void 0:a.files)||[]).filter(e=>/learning\/sessions\/\d{4}-\d{2}\.json$/.test(e));let s=0;for(const o of r)try{const t=await this.plugin.app.vault.adapter.read(o),n=JSON.parse(t),i=(null==n?void 0:n.sessions)||[],a=i.length,r=i.filter(t=>t.deckId!==e),l=a-r.length;if(l>0){const e={...n,sessions:r};await this.plugin.app.vault.adapter.write(o,JSON.stringify(e,null,2)),s+=l,_e.debug(`✅ 从 ${o} 清理了 ${l} 个会话记录`)}}catch(t){_e.warn(`⚠️ 清理会话文件失败: ${o}`,t)}_e.info(`🎉 学习会话数据清理完成，共清理 ${s} 个记录`)}catch(t){_e.error(`❌ 清理学习会话数据失败: ${e}`,t)}}async cleanupDeckMediaFiles(e){try{const t=this.plugin.mediaFileHandler;t&&"function"==typeof t.cleanupDeckMedia&&(await t.cleanupDeckMedia(e),_e.debug(`✅ 媒体文件清理完成: ${e}`))}catch(t){_e.warn(`⚠️ 媒体文件清理失败: ${e}`,t)}}async notifyDeckDeletion(e){try{const t=this.plugin.analyticsService;t&&"function"==typeof t.onDeckDeleted&&(t.onDeckDeleted(e),_e.debug(`✅ 已通知分析服务清理缓存: ${e}`));const n=this.plugin.autoSyncManager;n&&"function"==typeof n.onDeckDeleted&&(n.onDeckDeleted(e),_e.debug(`✅ 已通知同步管理器: ${e}`))}catch(t){_e.warn(`⚠️ 通知服务失败: ${e}`,t)}}async saveStudySession(e){try{const n=new Date(e.startTime||(new Date).toISOString()),i=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`,a=`learning/sessions/${i}.json`;try{await this.ensureFolder(`${this.dataFolder}/learning`)}catch(t){}try{await this.ensureFolder(`${this.dataFolder}/learning/sessions`)}catch(t){}let r={_schemaVersion:"1.0.0",yearMonth:i,sessions:[]};try{r=await this.readJsonFile(a)}catch(t){}const s=Array.isArray(r.sessions)?r.sessions:[],o=s.findIndex(t=>t.id===e.id),l=o<0;o>=0?s[o]=e:s.push(e),await this.writeJsonFile(a,{_schemaVersion:"1.0.0",yearMonth:i,sessions:s}),await new Promise(e=>setTimeout(e,50));const c=this.plugin.dataSyncService;return c&&"function"==typeof c.notifyChange&&await c.notifyChange({type:"sessions",action:l?"create":"update",ids:[e.id],metadata:{deckId:e.deckId}}),{success:!0,data:e,timestamp:(new Date).toISOString()}}catch(n){return _e.error("Failed to save study session:",n),{success:!1,error:extractErrorMessage(n),timestamp:(new Date).toISOString()}}}async getUserProfile(){try{return(await this.readJsonFile("profile/user-profile.json")).profile}catch(e){return _e.error("Failed to get user profile:",e),this.createDefaultUserProfile().profile}}async saveUserProfile(e){try{return await this.writeJsonFile("profile/user-profile.json",{profile:e}),{success:!0,data:e,timestamp:(new Date).toISOString()}}catch(t){return _e.error("Failed to save user profile:",t),{success:!1,error:extractErrorMessage(t),timestamp:(new Date).toISOString()}}}async exportData(){const[e,t,n]=await Promise.all([this.getDecks(),this.getCards(),this.getUserProfile()]);return{version:"1.0.0",exportDate:(new Date).toISOString(),decks:e,cards:t,userProfile:n}}async importData(e){try{await this.createBackup(),await this.writeJsonFile("decks/decks.json",{decks:e.decks});const t=new Map;for(const n of e.cards||[]){const e=t.get(n.deckId)||[];e.push(n),t.set(n.deckId,e)}for(const[e,n]of t.entries())await this.saveDeckCards(e,n);return await this.writeJsonFile("profile/user-profile.json",{profile:e.userProfile}),{success:!0,data:!0,timestamp:(new Date).toISOString()}}catch(t){return _e.error("Failed to import data:",t),{success:!1,error:extractErrorMessage(t),timestamp:(new Date).toISOString()}}}async createBackup(){const e=(new Date).toISOString().replace(/[:.]/g,"-"),t=`${gs()}/${e}`,n=this.plugin.app.vault.adapter;_e.debug(`[createBackup] 创建备份到: ${t}`),await this.ensureFolder(t);const i=[{source:"decks/decks.json",target:"decks.json"},{source:"cards/cards.json",target:"cards.json"},{source:"profile/user-profile.json",target:"profile.json"}];for(const{source:r,target:s}of i)try{const e=await this.readFileContent(r);await n.write(`${t}/${s}`,e)}catch(a){_e.warn(`备份文件失败: ${r}`,a),await n.write(`${t}/${s}`,"[]")}return await this.pruneBackups(),t}async exportAsAnkiRevlog(){const e=await this.getCards(),t=[];for(const n of e)for(const e of n.reviewHistory||[])t.push({id:new Date(e.review).getTime(),cid:n.uuid,button:e.rating,ivl:Math.round(e.scheduledDays||0),lastIvl:Math.round(e.lastElapsedDays||0),time:0,type:(()=>{switch(e.state){case 0:case 1:return 0;case 2:default:return 1;case 3:return 2}})()});return t}async rebuildStatesFromLogs(){const e=await this.getCards();for(const t of e){if(t.reviewHistory&&t.reviewHistory.length>0&&t.fsrs){const e=t.reviewHistory[t.reviewHistory.length-1];t.fsrs.elapsedDays=e.lastElapsedDays,t.fsrs.scheduledDays=e.scheduledDays,t.fsrs.lastReview=e.review;const n=new Date(e.review);n.setDate(n.getDate()+Math.max(0,Math.round(e.scheduledDays||0))),t.fsrs.due=n.toISOString()}await this.saveCard(t)}}async pruneBackups(){var e,t,n;const i=null!=(t=null==(e=this.plugin.settings)?void 0:e.backupRetentionCount)?t:10,a=gs();try{const e=this.plugin.app.vault.adapter,t=e.list?await e.list(a):{files:[],folders:[]},s=null!=(n=null==t?void 0:t.folders)?n:[];if(!Array.isArray(s)||s.length<=i)return;const o=s.slice().sort().slice(0,Math.max(0,s.length-i));for(const n of o){const e=["decks/decks.json","profile/user-profile.json"];for(const i of e){const e=`${n}/${i}`;await this.exists(e)&&await this.plugin.app.vault.adapter.remove(e)}const t=this.plugin.app.vault.adapter;if(t.rmdir)await t.rmdir(n,!0);else try{await this.plugin.app.vault.adapter.remove(n)}catch(r){}}}catch(r){_e.warn("Backup pruning skipped:",r)}}async exists(e){try{const t=this.plugin.app.vault.adapter;if(t.stat){return!!(await t.stat(e))}return!1}catch(t){return!1}}async readJsonFile(e){const t=await this.readFileContent(e);return JSON.parse(t)}async writeJsonFile(e,t){const n=JSON.stringify(t,null,2),i=`${this.dataFolder}/${e}`,a=this.plugin.app.vault.adapter;await a.write(i,n),_e.debug(`Written JSON file: ${i}`)}async updateExistingDeckFile(e,t){const n=`${this.dataFolder}/${e}`,i=this.plugin.app.vault.adapter;if(await i.exists(n)){const a=JSON.stringify(t,null,2);await i.write(n,a),_e.debug(`✅ 成功更新文件内容: ${e}`)}else _e.debug(`ℹ️ 文件不存在，使用常规创建: ${e}`),await this.writeJsonFile(e,t)}async getStudySessions(e){const t=`${this.dataFolder}/learning/sessions`;let n=[];try{const e=this.plugin.app.vault.adapter,a=e.list?await e.list(t):{files:[],folders:[]},r=((null==a?void 0:a.files)||[]).filter(e=>/learning\/sessions\/\d{4}-\d{2}\.json$/.test(e));for(const t of r)try{const e=await this.plugin.app.vault.adapter.read(t),i=JSON.parse(e),a=(null==i?void 0:i.sessions)||[];n.push(...a)}catch(i){}}catch(i){}return((null==e?void 0:e.since)||(null==e?void 0:e.until))&&(n=n.filter(t=>{const n=new Date(t.startTime).getTime();return!((null==e?void 0:e.since)&&n<new Date(e.since).getTime())&&!((null==e?void 0:e.until)&&n>new Date(e.until).getTime())})),n}async getDeckCards(e){try{return((await this.readJsonFile(`decks/${e}/cards.json`)).cards||[]).map(e=>this.normalizeCardData(e))}catch(t){return[]}}normalizeCardData(e){if(e.tags)if("string"==typeof e.tags){const n=e.tags;try{const t=JSON.parse(n);e.tags=Array.isArray(t)?t:[]}catch(t){e.tags=n.split(/[,;\s]+/).filter(e=>e.length>0)}}else Array.isArray(e.tags)||(e.tags=[]);else e.tags=[];return e}async ensureFolder(e){try{const t=this.plugin.app.vault.adapter;await ys.ensureDirRecursive(t,e),_e.debug(`✅ [ensureFolder] 文件夹已确保存在: ${e}`)}catch(t){_e.debug(`[ensureFolder] 创建文件夹失败（可能已存在）: ${e}`,t)}}async enqueueDeckWrite(e,t){const n=(this.deckWriteQueue.get(e)||Promise.resolve()).then(t).catch(e=>{throw _e.error("Deck write failed",e),e});this.deckWriteQueue.set(e,n),await n}async updateDeckIndexStats(e,t){try{const n=(await this.readJsonFile("decks/decks.json")).decks||[],i=n.findIndex(t=>t.id===e);i>=0&&(n[i].stats=n[i].stats||{},n[i].stats.cardCount=t,n[i].modified=(new Date).toISOString()),await this.writeJsonFile("decks/decks.json",{decks:n})}catch(n){_e.warn("updateDeckIndexStats failed",n)}}async saveDeckCards(e,t){await this.ensureFolder(`${this.dataFolder}/decks/${e}`),await this.enqueueDeckWrite(e,async()=>{const n={_schemaVersion:"1.0.0",deckId:e,cards:t},i=JSON.stringify(n,null,2),a=`${this.dataFolder}/decks/${e}/cards.json`,r=`${a}.tmp`,s=this.plugin.app.vault.adapter,o=await s.exists(a);await s.write(r,i),o&&await s.remove(a),await s.rename(r,a),await this.updateDeckIndexStats(e,t.length)})}async readFileContent(e){const t=`${this.dataFolder}/${e}`;try{const e=this.plugin.app.vault.adapter;if(await e.exists(t))return await e.read(t)}catch(n){_e.debug(`Adapter read failed for ${t}, trying vault API:`,n)}try{const e=this.plugin.app.vault.getAbstractFileByPath(t);if(e instanceof ge.TFile)return await this.plugin.app.vault.read(e)}catch(n){_e.debug(`Vault read failed for ${t}:`,n)}throw new Error(`File not found: ${t}`)}filterCards(e,t){return e.filter(e=>{var n,i;if(t.deckId&&e.deckId!==t.deckId)return!1;if(t.cardIds&&!t.cardIds.includes(e.uuid))return!1;if(void 0!==t.state&&(null==(n=e.fsrs)?void 0:n.state)!==t.state)return!1;if(t.tags&&(!e.tags||!t.tags.some(t=>{var n;return null==(n=e.tags)?void 0:n.includes(t)})))return!1;if(t.dueDate){if(!(null==(i=e.fsrs)?void 0:i.due)||Number.isNaN(Date.parse(String(e.fsrs.due))))return!1;const n=new Date(e.fsrs.due);if(t.dueDate.from&&n<new Date(t.dueDate.from))return!1;if(t.dueDate.to&&n>new Date(t.dueDate.to))return!1}return!0})}async getCardsBySourceFile(e){try{return(await this.getCards()).filter(t=>t.sourceFile===e)}catch(t){return _e.error("Failed to get cards by source file:",t),[]}}async getAllCards(){return this.getCards()}async getCardsByTemplate(e){try{return(await this.getCards()).filter(t=>t.templateId===e)}catch(t){return _e.error("Failed to get cards by template:",t),[]}}}class ws extends Error{constructor(e,t,n){super(e),this.code=t,this.context=n,this.name="FSRS6Error"}}class ks extends ws{constructor(e,t,n){super(e,"PARAMETER_ERROR",{parameterName:t,value:n}),this.parameterName=t,this.value=n,this.name="FSRS6ParameterError"}}class Ss extends ws{constructor(e,t,n){super(e,"COMPUTATION_ERROR",{operation:t,input:n}),this.operation=t,this.input=n,this.name="FSRS6ComputationError"}}const xs={VERSION:"6.1.1",PARAMETER_COUNT:21,DEFAULT_WEIGHTS:[.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,.1542],REQUEST_RETENTION:.9,MAXIMUM_INTERVAL:365,ENABLE_FUZZ:!0,SHORT_TERM_MEMORY_ENABLED:!0,LONG_TERM_STABILITY_ENABLED:!0},_s={w0:{min:.1,max:2},w1:{min:.5,max:3},w2:{min:1,max:5},w3:{min:3,max:15},w4:{min:3,max:10},w5:{min:.5,max:2},w6:{min:.5,max:5},w7:{min:0,max:.5},w8:{min:.5,max:3},w9:{min:0,max:1},w10:{min:.5,max:2},w11:{min:.5,max:3},w12:{min:0,max:2},w13:{min:0,max:1},w14:{min:0,max:2},w15:{min:.5,max:1.5},w16:{min:1,max:3},w17:{min:0,max:1},w18:{min:0,max:.5},w19:{min:0,max:.5},w20:{min:0,max:.5}};class Cs{constructor(e){oe(this,"params"),oe(this,"state"),oe(this,"performanceMetrics"),this.params=this.initializeParameters(e),this.state=this.initializeState(),this.performanceMetrics=this.initializeMetrics(),this.validateParameters()}getVersionInfo(){return{version:"6.1.1",algorithmName:"FSRS6",parameterCount:21,implementationDate:(new Date).toISOString(),compatibilityLevel:"standard"}}createCard(){const e=performance.now();try{const t={version:"6.1.1",due:(new Date).toISOString(),stability:0,difficulty:this.calculateInitialDifficulty(),elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:Gr.New,lastReview:void 0,retrievability:1,shortTermMemoryFactor:this.params.shortTermMemoryEnabled?1:void 0,longTermStabilityFactor:this.params.longTermStabilityEnabled?1:void 0};return this.updatePerformanceMetrics("createCard",performance.now()-e),t}catch(t){const e=t instanceof Error?t.message:String(t);throw new Ss(`Failed to create FSRS6 card: ${e}`,"createCard",{params:this.params})}}review(e,t,n){const i=performance.now();try{this.validateCard(e),this.validateRating(t);const a=n?new Date(n):new Date,r=e.state,s=e.stability,o=e.difficulty,l=e.lastReview?this.calculateElapsedDays(e.lastReview,a.toISOString()):0;let c={...e,lastReview:a.toISOString(),elapsedDays:l,reps:e.reps+1};c=this.updateCardByRating(c,t);const d=this.calculateNextDue(c,a);c.due=d.toISOString(),c.retrievability=this.calculateRetrievability(c),this.params.shortTermMemoryEnabled&&(c.shortTermMemoryFactor=this.calculateShortTermMemoryFactor(c,t)),this.params.longTermStabilityEnabled&&(c.longTermStabilityFactor=this.calculateLongTermStabilityFactor(c,t));const u={rating:t,state:r,due:e.due,stability:s,difficulty:o,elapsedDays:e.elapsedDays,lastElapsedDays:l,scheduledDays:c.scheduledDays,review:a.toISOString()};return this.updateState(c,t),this.updatePerformanceMetrics("review",performance.now()-i),{card:c,log:u}}catch(a){const i=a instanceof Error?a.message:String(a);throw new Ss(`Failed to review card: ${i}`,"review",{card:e,rating:t,reviewTime:n})}}calculateInitialDifficulty(){const e=this.params.w[4]-3*this.params.w[5];return Math.max(Math.min(e,10),1)}updateCardByRating(e,t){switch(t){case Qr.Again:return this.handleAgainRating(e);case Qr.Hard:return this.handleHardRating(e);case Qr.Good:return this.handleGoodRating(e);case Qr.Easy:return this.handleEasyRating(e);default:throw new ks("Invalid rating value","rating",t)}}handleAgainRating(e){const t={...e};return t.lapses+=1,t.difficulty=this.calculateNextDifficulty(e.difficulty,Qr.Again),t.stability=this.calculateForgetStability(e),t.state=e.state===Gr.New?Gr.Learning:Gr.Relearning,t.scheduledDays=0,t}handleHardRating(e){const t={...e};return t.difficulty=this.calculateNextDifficulty(e.difficulty,Qr.Hard),e.state===Gr.New?(t.stability=this.calculateInitialStability(Qr.Hard),t.state=Gr.Learning,t.scheduledDays=this.calculateNextInterval(t.stability)):(t.stability=this.calculateRecallStability(e,Qr.Hard),t.state=Gr.Review,t.scheduledDays=this.calculateNextInterval(.85*t.stability)),t}handleGoodRating(e){const t={...e};return t.difficulty=this.calculateNextDifficulty(e.difficulty,Qr.Good),e.state===Gr.New?(t.stability=this.calculateInitialStability(Qr.Good),t.state=Gr.Review,t.scheduledDays=this.calculateNextInterval(t.stability)):(t.stability=this.calculateRecallStability(e,Qr.Good),t.state=Gr.Review,t.scheduledDays=this.calculateNextInterval(t.stability)),t}handleEasyRating(e){const t={...e};return t.difficulty=this.calculateNextDifficulty(e.difficulty,Qr.Easy),e.state===Gr.New?(t.stability=this.calculateInitialStability(Qr.Easy),t.state=Gr.Review,t.scheduledDays=this.calculateNextInterval(t.stability)):(t.stability=this.calculateRecallStability(e,Qr.Easy),t.state=Gr.Review,t.scheduledDays=this.calculateNextInterval(1.15*t.stability)),t}calculateInitialStability(e){const t=this.params.w;return Math.max(t[e-1],.1)}calculateNextDifficulty(e,t){const n=this.params.w,i=e+-n[6]*(t-3)+n[4]*(this.calculateInitialDifficulty()-e);return Math.max(Math.min(i,10),1)}calculateForgetStability(e){const t=this.params.w,n=Math.exp(t[11]*(e.difficulty-t[4])),i=e.stability**t[12]*Math.max(e.elapsedDays,1)**t[13];return Math.max(t[10]*i*n,.01)}calculateRecallStability(e,t){const n=this.params.w,i=t===Qr.Hard?n[15]:1,a=t===Qr.Easy?n[16]:1,r=this.calculateRetrievability(e),s=Math.exp(n[8]*(t-3+n[9]*(1-r)));let o=e.stability*s*i*a;if(this.params.shortTermMemoryEnabled&&e.elapsedDays<=3){o*=1+n[17]*Math.exp(-n[18]*e.elapsedDays)}if(this.params.longTermStabilityEnabled&&e.elapsedDays>=30){o*=1+n[19]*Math.log(1+n[20]*e.elapsedDays/30)}return Math.max(o,.01)}calculateRetrievability(e){return e.elapsedDays<=0||e.stability<=0?1:Math.exp(-e.elapsedDays/e.stability)}calculateNextInterval(e){const t=Math.max(1,Math.round(e)),n=Math.min(Math.max(this.params.requestRetention,.5),.99),i=Math.log(n)/Math.log(.9),a=Math.max(1,Math.round(t*Math.abs(i)));return Math.min(a,this.params.maximumInterval)}calculateNextDue(e,t){const n=new Date(t);if(n.setDate(n.getDate()+e.scheduledDays),this.params.enableFuzz){return this.applyFuzz(n,e.scheduledDays)}return n}applyFuzz(e,t){if(t<2.5)return e;const n=Math.min(.05*t,1),i=2*(Math.random()-.5)*n,a=new Date(e);return a.setDate(a.getDate()+Math.round(i)),a}calculateShortTermMemoryFactor(e,t){const n=this.params.w,i=e.shortTermMemoryFactor||1;if(e.elapsedDays<=3){const e=t>=3?n[17]:-n[17];return Math.max(.5,Math.min(2,i+e))}return i}calculateLongTermStabilityFactor(e,t){const n=this.params.w,i=e.longTermStabilityFactor||1;if(e.elapsedDays>=30){const e=t>=3?n[19]:-n[19];return Math.max(.5,Math.min(2,i+e))}return i}calculateElapsedDays(e,t){const n=new Date(e),i=new Date(t),a=Math.abs(i.getTime()-n.getTime());return Math.floor(a/864e5)}initializeParameters(e){var t,n,i;const a=this.sanitizeInputParameters(e);return{version:"6.1.1",w:a.w||xs.DEFAULT_WEIGHTS,requestRetention:a.requestRetention||xs.REQUEST_RETENTION,maximumInterval:a.maximumInterval||xs.MAXIMUM_INTERVAL,enableFuzz:null!=(t=a.enableFuzz)?t:xs.ENABLE_FUZZ,shortTermMemoryEnabled:null!=(n=a.shortTermMemoryEnabled)?n:xs.SHORT_TERM_MEMORY_ENABLED,longTermStabilityEnabled:null!=(i=a.longTermStabilityEnabled)?i:xs.LONG_TERM_STABILITY_ENABLED}}sanitizeInputParameters(e){var t;if(!e)return{};const n={...e};if(e.w)if(Array.isArray(e.w)&&21===e.w.length){const t=e.w.map((e,t)=>{const n=_s[`w${t}`];return"number"!=typeof e||Number.isNaN(e)||e<n.min||e>n.max?(_e.warn(`Invalid weight w${t}: ${e}. Using default: ${xs.DEFAULT_WEIGHTS[t]}`),xs.DEFAULT_WEIGHTS[t]):e});n.w=t}else _e.warn(`Invalid weight array length: ${null==(t=e.w)?void 0:t.length}. Using defaults.`),n.w=xs.DEFAULT_WEIGHTS;return void 0!==e.requestRetention&&("number"!=typeof e.requestRetention||Number.isNaN(e.requestRetention)||e.requestRetention<.5||e.requestRetention>.99)&&(_e.warn(`Invalid request retention: ${e.requestRetention}. Using default: ${xs.REQUEST_RETENTION}`),n.requestRetention=xs.REQUEST_RETENTION),void 0!==e.maximumInterval&&("number"!=typeof e.maximumInterval||Number.isNaN(e.maximumInterval)||e.maximumInterval<1||e.maximumInterval>1825)&&(_e.warn(`Invalid maximum interval: ${e.maximumInterval}. Using default: ${xs.MAXIMUM_INTERVAL}`),n.maximumInterval=xs.MAXIMUM_INTERVAL),n}initializeState(){return{isInitialized:!0,parametersLoaded:!0,personalizationEnabled:!1,totalReviews:0,averageAccuracy:0,currentWeights:[...this.params.w]}}initializeMetrics(){return{algorithmVersion:"6.1.1",executionTime:0,memoryUsage:0,predictionAccuracy:0,parameterStability:1,convergenceRate:0,cacheHitRate:0}}validateParameters(){21!==this.params.w.length&&(_e.warn(`FSRS6 parameter count mismatch: expected 21, got ${this.params.w.length}. Auto-fixing...`),this.params.w=xs.DEFAULT_WEIGHTS);let e=!1;this.params.w.forEach((t,n)=>{const i=`w${n}`,a=_s[i];(t<a.min||t>a.max||Number.isNaN(t))&&(_e.warn(`Parameter ${i} (${t}) is outside valid range [${a.min}, ${a.max}]. Auto-fixing...`),e=!0)}),e&&(_e.warn("Detected invalid FSRS6 parameters. Resetting to defaults..."),this.params.w=xs.DEFAULT_WEIGHTS),(this.params.requestRetention<.5||this.params.requestRetention>.99||Number.isNaN(this.params.requestRetention))&&(_e.warn(`Invalid request retention: ${this.params.requestRetention}. Resetting to default...`),this.params.requestRetention=xs.REQUEST_RETENTION),(this.params.maximumInterval<1||this.params.maximumInterval>1825||Number.isNaN(this.params.maximumInterval))&&(_e.warn(`Invalid maximum interval: ${this.params.maximumInterval}. Resetting to default...`),this.params.maximumInterval=xs.MAXIMUM_INTERVAL)}validateCard(e){if(!e||"object"!=typeof e)throw new ws("Invalid card data","INVALID_CARD");if("6.1.1"!==e.version)throw new ws(`Card version mismatch: expected 6.1.1, got ${e.version}`,"VERSION_MISMATCH")}validateRating(e){if(![1,2,3,4].includes(e))throw new ks("Rating must be 1, 2, 3, or 4","rating",e)}updateState(e,t){this.state.totalReviews++;const n=t>=3?1:0;this.state.averageAccuracy=(this.state.averageAccuracy*(this.state.totalReviews-1)+n)/this.state.totalReviews}updatePerformanceMetrics(e,t){this.performanceMetrics.executionTime=(this.performanceMetrics.executionTime+t)/2}getParameters(){return{...this.params}}updateParameters(e){this.params={...this.params,...e},this.validateParameters(),this.state.currentWeights=[...this.params.w]}getState(){return{...this.state}}getPerformanceMetrics(){return{...this.performanceMetrics}}}class Is{constructor(e){var t,n;oe(this,"core"),oe(this,"params");const i=(null==e?void 0:e.w)?e.w:xs.DEFAULT_WEIGHTS,a={version:"6.1.1",w:i,requestRetention:(null==e?void 0:e.requestRetention)||xs.REQUEST_RETENTION,maximumInterval:(null==e?void 0:e.maximumInterval)||xs.MAXIMUM_INTERVAL,enableFuzz:null!=(t=null==e?void 0:e.enableFuzz)?t:xs.ENABLE_FUZZ,shortTermMemoryEnabled:!0,longTermStabilityEnabled:!0};this.core=new Cs(a),this.params={w:i,requestRetention:a.requestRetention||xs.REQUEST_RETENTION,maximumInterval:a.maximumInterval||xs.MAXIMUM_INTERVAL,enableFuzz:null!=(n=a.enableFuzz)?n:xs.ENABLE_FUZZ}}createCard(){const e=this.core.createCard();return this.convertFromFSRS6Card(e)}review(e,t,n){const i=this.convertToFSRS6Card(e),a=this.core.review(i,t,n);return{card:this.convertFromFSRS6Card(a.card),log:a.log}}convertToFSRS6Card(e){return{...e,version:"6.1.1",shortTermMemoryFactor:1,longTermStabilityFactor:1}}convertFromFSRS6Card(e){const{version:t,shortTermMemoryFactor:n,longTermStabilityFactor:i,memoryPrediction:a,personalizedWeights:r,...s}=e;return s}getParameters(){return{...this.params}}updateParameters(e){const t={version:"6.1.1",w:e.w?e.w:void 0,requestRetention:e.requestRetention,maximumInterval:e.maximumInterval,enableFuzz:e.enableFuzz};this.core.updateParameters(t),this.params={...this.params,...e}}getVersionInfo(){return this.core.getVersionInfo()}getPerformanceMetrics(){return this.core.getPerformanceMetrics()}predictMemoryState(e,t){const n=this.convertToFSRS6Card(e),i=n.elapsedDays+t;return n.stability<=0?0:Math.exp(-i/n.stability)}calculateProgress(e){if(e.state===Gr.New)return 0;if(e.state===Gr.Review&&e.stability>100)return 1;return(Math.min(e.stability/100,1)+Math.min(e.reps/10,1))/2}getRecommendedStudyTime(e,t){const n=Math.min(e,t);return Math.ceil(30*n/60)}}class Ds extends ge.PluginSettingTab{constructor(e,t){super(e,t),oe(this,"plugin"),this.plugin=t}async display(){const{containerEl:e}=this;e.empty(),this.plugin.settingsTab=this;const{mount:t}=await Promise.resolve().then(()=>Or),{default:n}=await Promise.resolve().then(()=>nme);t(n,{target:e,props:{plugin:this.plugin}})}createBasicSettings(e){e.createEl("h2",{text:"基础设置"}),new ge.Setting(e).setName("默认牌组").setDesc("新建卡片时的默认牌组名称").addText(e=>e.setPlaceholder("请输入默认牌组名称").setValue(this.plugin.settings.defaultDeck).onChange(async e=>{this.plugin.settings.defaultDeck=e,await this.plugin.saveSettings()})),new ge.Setting(e).setName("每日复习数量").setDesc("每天希望复习的卡片数量").addSlider(e=>e.setLimits(10,200,10).setValue(this.plugin.settings.reviewsPerDay).setDynamicTooltip().onChange(async e=>{this.plugin.settings.reviewsPerDay=e,await this.plugin.saveSettings()})),new ge.Setting(e).setName("启用通知").setDesc("在有卡片需要复习时显示通知").addToggle(e=>e.setValue(this.plugin.settings.enableNotifications).onChange(async e=>{this.plugin.settings.enableNotifications=e,await this.plugin.saveSettings()}))}createLearningSettings(e){e.createEl("h2",{text:"学习设置"}),new ge.Setting(e).setName("自动显示答案").setDesc("学习时自动显示答案的时间（秒，0表示手动显示）").addSlider(e=>e.setLimits(0,10,1).setValue(this.plugin.settings.autoShowAnswerSeconds).setDynamicTooltip().onChange(async e=>{this.plugin.settings.autoShowAnswerSeconds=e,await this.plugin.saveSettings()})),new ge.Setting(e).setName("学习步骤").setDesc("新卡片的学习步骤（分钟，用空格分隔）").addText(e=>e.setPlaceholder("1 10").setValue(this.plugin.settings.learningSteps.join(" ")).onChange(async e=>{const t=e.split(/\s+/).map(e=>parseInt(e,10)).filter(e=>!Number.isNaN(e)&&e>=0);this.plugin.settings.learningSteps=t.length?t:[1,10],await this.plugin.saveSettings()})),new ge.Setting(e).setName("毕业间隔").setDesc("卡片从学习阶段毕业后的初始间隔（天）").addSlider(e=>e.setLimits(1,7,1).setValue(this.plugin.settings.graduatingInterval).setDynamicTooltip().onChange(async e=>{this.plugin.settings.graduatingInterval=e,await this.plugin.saveSettings()}))}createFSRSSettings(e){e.createEl("h2",{text:"FSRS算法设置"});const t=e.createEl("p",{text:"FSRS（Free Spaced Repetition Scheduler）是一个基于记忆模型的间隔重复算法，能够更精确地预测遗忘时间。更多高级设置请在插件主界面的设置标签页中配置。"});t.style.color="var(--text-muted)",t.style.fontSize="0.9em",t.style.marginBottom="1rem",new ge.Setting(e).setName("目标记忆率").setDesc("希望达到的记忆成功率（建议85%-95%）").addSlider(e=>e.setLimits(.8,.98,.01).setValue(this.plugin.settings.fsrsParams.requestRetention).setDynamicTooltip().onChange(async e=>{var t;this.plugin.settings.fsrsParams.requestRetention=e,await this.plugin.saveSettings(),null==(t=this.plugin.fsrs)||t.updateParameters({requestRetention:e})})),new ge.Setting(e).setName("最大间隔").setDesc("复习间隔的最大天数（建议1-5年，参考Anki社区实践）。注意：修改此设置后需要重启Obsidian才能生效。").addSlider(e=>e.setLimits(30,1825,5).setValue(Math.min(this.plugin.settings.fsrsParams.maximumInterval||365,1825)).setDynamicTooltip().onChange(async e=>{var t;this.plugin.settings.fsrsParams.maximumInterval=e,await this.plugin.saveSettings(),null==(t=this.plugin.fsrs)||t.updateParameters({maximumInterval:e}),new ge.Notice("⚠️ 最大间隔已更改，请重启Obsidian以应用新设置",5e3)})),new ge.Setting(e).setName("启用随机化").setDesc("在复习时间上添加小幅随机化，避免复习扎堆").addToggle(e=>e.setValue(this.plugin.settings.fsrsParams.enableFuzz).onChange(async e=>{var t;this.plugin.settings.fsrsParams.enableFuzz=e,await this.plugin.saveSettings(),null==(t=this.plugin.fsrs)||t.updateParameters({enableFuzz:e})})),new ge.Setting(e).setName("算法权重参数").setDesc("FSRS算法的权重参数（高级用户使用，用逗号分隔）。更多参数管理功能请在插件主界面的设置标签页中使用。").addTextArea(e=>e.setPlaceholder("0.5701, 1.4436, 4.1386, ...").setValue(this.plugin.settings.fsrsParams.w.join(", ")||"").onChange(async e=>{var t;try{const n=e.split(",").map(e=>parseFloat(e.trim())).filter(e=>!Number.isNaN(e));21===n.length?(this.plugin.settings.fsrsParams.w=n,await this.plugin.saveSettings(),null==(t=this.plugin.fsrs)||t.updateParameters({w:n})):n.length>0&&_e.warn(`FSRS权重参数数量错误：需要21个参数，但提供了${n.length}个`)}catch(n){_e.error("FSRS参数解析错误:",n)}})),e.createEl("h3",{text:"🎯 个性化算法优化（新功能）",attr:{style:"margin-top: 2rem; color: var(--text-accent);"}});const n=e.createEl("p",{text:"启用基于您学习数据的智能算法优化。系统会在收集足够数据后自动调整参数，提升记忆效率25-40%。包含回溯保护机制，确保优化安全可靠。"});n.style.color="var(--text-muted)",n.style.fontSize="0.9em",n.style.marginBottom="1rem",new ge.Setting(e).setName("启用个性化优化").setDesc("根据您的学习表现自动优化FSRS算法参数").addToggle(e=>{var t;return e.setValue(null==(t=this.plugin.settings.enablePersonalization)||t).onChange(async e=>{this.plugin.settings.enablePersonalization=e,await this.plugin.saveSettings()})}),new ge.Setting(e).setName("启用回溯保护").setDesc("当检测到性能下降时自动回退到稳定参数").addToggle(e=>{var t,n;return e.setValue(null==(n=null==(t=this.plugin.settings.personalizationSettings)?void 0:t.enableBacktracking)||n).onChange(async e=>{this.plugin.settings.personalizationSettings||(this.plugin.settings.personalizationSettings={enabled:!0,minDataPoints:50,enableBacktracking:!0,checkpointInterval:50,performanceThreshold:.1,autoOptimization:!0}),this.plugin.settings.personalizationSettings.enableBacktracking=e,await this.plugin.saveSettings()})}),new ge.Setting(e).setName("最小数据点").setDesc("开始优化前需要收集的复习次数（默认50）").addText(e=>{var t,n;return e.setPlaceholder("50").setValue(String(null!=(n=null==(t=this.plugin.settings.personalizationSettings)?void 0:t.minDataPoints)?n:50)).onChange(async e=>{const t=parseInt(e);!Number.isNaN(t)&&t>=20&&t<=200&&(this.plugin.settings.personalizationSettings||(this.plugin.settings.personalizationSettings={enabled:!0,minDataPoints:50,enableBacktracking:!0,checkpointInterval:50,performanceThreshold:.1,autoOptimization:!0}),this.plugin.settings.personalizationSettings.minDataPoints=t,await this.plugin.saveSettings())})})}createUISettings(e){e.createEl("h2",{text:"界面设置"}),new ge.Setting(e).setName("启用键盘快捷键").setDesc("启用学习模式的键盘快捷键（1-4评分，空格显示答案）").addToggle(e=>e.setValue(this.plugin.settings.enableShortcuts).onChange(async e=>{this.plugin.settings.enableShortcuts=e,await this.plugin.saveSettings()}))}createAdvancedSettings(e){e.createEl("h2",{text:"高级设置"}),new ge.Setting(e).setName("调试模式").setDesc("启用调试模式，在控制台显示详细日志").addToggle(e=>e.setValue(!1).onChange(async e=>{})),new ge.Setting(e).setName("备份保留数量").setDesc("最多保留的备份数量，超过后将清理最早的备份").addSlider(e=>{var t,n;return e.setLimits(1,50,1).setValue(null!=(n=null==(t=this.plugin.settings)?void 0:t.backupRetentionCount)?n:10).setDynamicTooltip().onChange(async e=>{this.plugin.settings.backupRetentionCount=e,await this.plugin.saveSettings()})}),e.createEl("h2",{text:"关于"});const t=e.createEl("div");t.innerHTML='\n      <p><strong>Anki for Obsidian</strong> v1.0.0</p>\n      <p>一个功能强大的间隔重复学习插件，集成了FSRS算法和现代化界面设计。</p>\n      <p>\n        <a href="https://github.com/anki-obsidian-plugin" style="color: var(--text-accent);">GitHub仓库</a> | \n        <a href="https://github.com/anki-obsidian-plugin/issues" style="color: var(--text-accent);">问题反馈</a> | \n        <a href="https://github.com/anki-obsidian-plugin/wiki" style="color: var(--text-accent);">使用文档</a>\n      </p>\n    ',t.style.color="var(--text-muted)",t.style.fontSize="0.9em"}}class Ts{constructor(){oe(this,"apiUrl","https://ahwhophvla.bja.sealos.run"),oe(this,"cacheKey","tuanki_cloud_cache"),oe(this,"cacheTTL",6048e5)}async activate(e,t,n,i){try{const a=await fetch(`${this.apiUrl}/activate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({activation_code:e,device_fingerprint:t,email:n.toLowerCase().trim(),platform:i}),signal:AbortSignal.timeout(1e4)}),r=await a.json();return a.ok&&r.success?{success:!0,message:r.message,devices_count:r.devices_count,max_devices:r.max_devices}:{success:!1,error:r.error||"激活失败",is_network_error:!1}}catch(a){_e.error("激活请求失败:",a);const e=a instanceof TypeError||a instanceof Error&&"AbortError"===a.name;return{success:!1,error:e?"网络连接失败":"激活失败",is_network_error:e}}}async validate(e,t,n){try{const i=this.getCache();if(i&&this.isCacheValid(i))return i.result;const a=await fetch(`${this.apiUrl}/validate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({activation_code:e,device_fingerprint:t,email:n.toLowerCase().trim()}),signal:AbortSignal.timeout(1e4)}),r=await a.json();if(!a.ok||!r.valid)return{valid:!1,error:r.error||"验证失败",is_network_error:!1};const s={valid:!0,expires_at:r.expires_at,devices_count:r.devices_count,max_devices:r.max_devices};return this.setCache(s),s}catch(i){_e.error("验证请求失败:",i);const e=i instanceof TypeError||i instanceof Error&&"AbortError"===i.name;return{valid:!1,error:e?"网络连接失败":"验证失败",is_network_error:e}}}getCache(){try{const e=localStorage.getItem(this.cacheKey);return e?JSON.parse(e):null}catch(e){return null}}isCacheValid(e){return Date.now()-e.cached_at<this.cacheTTL}setCache(e){try{localStorage.setItem(this.cacheKey,JSON.stringify({result:e,cached_at:Date.now()}))}catch(t){}}clearCache(){try{localStorage.removeItem(this.cacheKey)}catch(e){}}}class Ms{constructor(){oe(this,"cloudValidator"),oe(this,"PUBLIC_KEY","-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuFbE7080dfi90uTpCncI\nn9wCXxPwz2r485ckXN0HO7yawwZTcSPf9I03GUg0EeyCj378AgnFUcj7GZ14Cnox\naCFhKje/u9PwBkUGiEb9Cgu6KkY29S1BPFZC9FBYE/N9Ymkw/vPZbR+0/4c8Uhu7\nou+Do+2e+C7s3UVBKRnXea4E54v/mGPOWttjvF+vwStg/x3hvDjIcfMqg3s74OVt\n2vJqfOoVvqNnEVzx4wEPnAi5xD5p4Bxz2gXDlzRL+6HV2n55fdBJou+avIihxwUM\nKiqnLPDZDoj1QmooLvpFj3j7/9dWyUfbKmJv3D1+hmdbeltKDYZJc9WdIU+v7Bmi\n+wIDAQAB\n-----END PUBLIC KEY-----"),oe(this,"PRODUCT_ID","tuanki-obsidian-plugin"),oe(this,"CURRENT_VERSION","0.5.0"),this.cloudValidator=new Ts}async generateDeviceFingerprint(){const e=(await this.collectDeviceComponents()).join("|");return this.sha256(e)}async collectDeviceComponents(){var e,t,n,i,a;const r=[];r.push(navigator.userAgent||"unknown"),r.push(navigator.language||"unknown"),r.push((null==(e=navigator.languages)?void 0:e.join(","))||"unknown"),r.push(navigator.platform||"unknown"),r.push(`${screen.width}x${screen.height}`),r.push(`${screen.colorDepth}bit`),r.push(`${screen.pixelDepth}px`),r.push(`${window.devicePixelRatio||1}dpr`),r.push((new Date).getTimezoneOffset().toString()),r.push(Intl.DateTimeFormat().resolvedOptions().timeZone||"unknown"),r.push((null==(t=navigator.hardwareConcurrency)?void 0:t.toString())||"0"),r.push((null==(n=navigator.maxTouchPoints)?void 0:n.toString())||"0");const s=navigator.deviceMemory;s&&r.push(`${s}GB`);const o=navigator.connection;o&&(r.push(o.effectiveType||"unknown"),r.push((null==(i=o.downlink)?void 0:i.toString())||"unknown"));const l=window.app;l&&r.push(l.appId||"obsidian");try{const e=null==(a=window.require)?void 0:a.call(window,"os");e&&(r.push(e.platform()||"unknown"),r.push(e.arch()||"unknown"),r.push(e.hostname()||"unknown"))}catch(d){r.push("no-os-info")}try{const e=document.createElement("canvas"),t=e.getContext("2d");t&&(t.textBaseline="top",t.font="14px Arial",t.fillText("Tuanki Device Fingerprint",2,2),r.push(e.toDataURL().substring(0,50)))}catch(d){r.push("no-canvas")}try{const e=document.createElement("canvas").getContext("webgl");if(e){const t=e.getParameter(e.RENDERER),n=e.getParameter(e.VENDOR);r.push(t||"unknown-renderer"),r.push(n||"unknown-vendor")}}catch(d){r.push("no-webgl")}try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createAnalyser(),i=e.createGain();t.connect(n),n.connect(i),i.connect(e.destination),r.push(e.sampleRate.toString()),r.push(n.frequencyBinCount.toString()),e.close()}catch(d){r.push("no-audio")}const c=Array.from(navigator.plugins||[]).map(e=>e.name).slice(0,5);return r.push(c.join(",")||"no-plugins"),r.filter(e=>e&&"undefined"!==e)}async sha256(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}base64Decode(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n}async verifySignature(e,t){try{const n=await crypto.subtle.importKey("spki",new Uint8Array(this.base64Decode(this.PUBLIC_KEY.replace(/-----[^-]+-----/g,"").replace(/\s/g,""))),{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!1,["verify"]),i=(new TextEncoder).encode(e),a=this.base64Decode(t);return await crypto.subtle.verify("RSASSA-PKCS1-v1_5",n,new Uint8Array(a),i)}catch(n){return _e.error("签名验证失败:",n),!1}}parseActivationCode(e){try{const t=e.split(".");if(2!==t.length)return null;const[n,i]=t;return{data:atob(n),signature:i}}catch(t){return _e.error("激活码解析失败:",t),null}}async validateActivationCode(e,t){try{const t=this.parseActivationCode(e);if(!t)return{isValid:!1,error:"激活码格式无效"};if(!(await this.verifySignature(t.data,t.signature)))return{isValid:!1,error:"激活码签名验证失败"};const n=JSON.parse(t.data);if(n.productId!==this.PRODUCT_ID)return{isValid:!1,error:"激活码不适用于当前产品"};return new Date>new Date(n.expiresAt)?{isValid:!1,error:"激活码已过期"}:{isValid:!0,data:n}}catch(n){return _e.error("激活码验证失败:",n),{isValid:!1,error:"激活码验证过程中发生错误"}}}async activateLicense(e,t){try{if(!t||!this.isValidEmail(t))return{success:!1,error:"请输入有效的邮箱地址"};const n=await this.generateDeviceFingerprint(),i=await this.validateActivationCode(e,n);if(!i.isValid||!i.data)return{success:!1,error:i.error};const a=i.data,r=await this.cloudValidator.activate(e,n,t,navigator.platform);let s;if(!r.success)return r.is_network_error?{success:!1,error:"网络连接失败，无法完成云端激活。\n\n请检查网络后重试。云端激活需要联网完成邮箱绑定。"}:{success:!1,error:r.error||"云端激活失败"};s={status:"synced",syncedAt:(new Date).toISOString(),lastValidatedAt:(new Date).toISOString(),devicesUsed:r.devices_count,devicesMax:r.max_devices};return{success:!0,licenseInfo:{activationCode:e,isActivated:!0,activatedAt:(new Date).toISOString(),deviceFingerprint:n,expiresAt:a.expiresAt,productVersion:this.CURRENT_VERSION,licenseType:a.licenseType,fingerprintVersion:2,boundEmail:t.toLowerCase().trim(),cloudSync:s},cloudInfo:{devicesUsed:r.devices_count,devicesMax:r.max_devices}}}catch(n){return _e.error("许可证激活失败:",n),{success:!1,error:"激活过程中发生错误"}}}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}async validateCurrentLicense(e){const t=[];try{if(!e.isActivated)return{isValid:!1,error:"许可证未激活"};if(!e.activationCode)return{isValid:!1,error:"激活码信息缺失"};const n=["activationCode","activatedAt","deviceFingerprint","expiresAt","productVersion"];for(const t of n)if(!e[t])return{isValid:!1,error:`许可证数据不完整，缺少${t}字段`};const i=new Date,a=new Date(e.activatedAt),r=new Date(e.expiresAt);if(a>i)return{isValid:!1,error:"许可证激活时间异常"};if(i>r)return{isValid:!1,error:"许可证已过期"};const s=Math.ceil((r.getTime()-i.getTime())/864e5);"lifetime"!==e.licenseType&&s<=30&&t.push(`许可证将在${s}天后过期`);const o=await this.generateDeviceFingerprint();if(e.fingerprintVersion&&1!==e.fingerprintVersion||(_e.debug("检测到旧版本设备指纹，正在迁移到新版本..."),e.deviceFingerprint=o,e.fingerprintVersion=2,t.push("设备指纹已自动更新到新版本")),!e.boundEmail)return{isValid:!1,error:"检测到旧版本许可证，请重新激活以绑定邮箱。\n\n新版本采用云端激活系统，步骤如下：\n1. 使用您原有的激活码（仍然有效）\n2. 输入您的邮箱地址\n3. 完成云端激活\n\n激活后可在多设备间切换使用。"};await this.performCloudValidation(e,o,t);const l=await this.validateActivationCode(e.activationCode);if(!l.isValid)return{isValid:!1,error:l.error};e.productVersion&&e.productVersion!==this.CURRENT_VERSION&&t.push(`许可证版本(${e.productVersion})与当前版本(${this.CURRENT_VERSION})不匹配`);return Math.ceil((i.getTime()-a.getTime())/864e5)>3650&&t.push("许可证激活时间异常久远，请检查系统时间"),{isValid:!0,warnings:t.length>0?t:void 0}}catch(n){return _e.error("许可证验证失败:",n),{isValid:!1,error:"验证过程中发生错误"}}}calculateFingerprintSimilarity(e,t){return e===t?1:0}async performPeriodicValidation(e){var t,n,i;const a=await this.validateCurrentLicense(e);if(!a.isValid){return{isValid:!1,shouldReactivate:!!((null==(t=a.error)?void 0:t.includes("设备指纹"))||(null==(n=a.error)?void 0:n.includes("数据不完整"))||(null==(i=a.error)?void 0:i.includes("激活码"))),error:a.error,warnings:a.warnings}}return{isValid:!0,shouldReactivate:!1,warnings:a.warnings}}getLicenseRemainingDays(e){const t=new Date,n=new Date(e.expiresAt).getTime()-t.getTime();return Math.ceil(n/864e5)}isTrialVersion(e){return!e.isActivated||""===e.activationCode}async performCloudValidation(e,t,n){try{if(!this.shouldPerformCloudValidation(e))return;const i=await this.cloudValidator.validate(e.activationCode,t,e.boundEmail);if(i.valid)e.cloudSync&&(e.cloudSync.lastValidatedAt=(new Date).toISOString(),e.cloudSync.devicesUsed=i.devices_count,e.cloudSync.status="synced");else{if(!i.is_network_error)throw new Error(i.error||"云端验证失败，此设备可能已被移除");_e.warn("云端验证失败（网络错误），使用本地验证"),n.push("云端验证暂时不可用，当前使用离线模式")}}catch(i){_e.error("云端验证错误:",i),n.push(i instanceof Error?i.message:"云端验证异常")}}shouldPerformCloudValidation(e){if(!e.cloudSync)return!0;const t=new Date(e.cloudSync.lastValidatedAt).getTime();return(Date.now()-t)/36e5>168}}class As{static async canAttemptActivation(){const e=await this.generateSimpleFingerprint(),t=this.getAttempts(),n=Date.now(),i=t.filter(e=>n-e.timestamp<this.ATTEMPT_WINDOW),a=i.filter(t=>t.deviceFingerprint===e),r=a.filter(e=>!e.success).sort((e,t)=>t.timestamp-e.timestamp)[0];if(r){const e=n-r.timestamp;if(a.filter(e=>!e.success&&n-e.timestamp<this.LOCKOUT_DURATION).length>=this.MAX_ATTEMPTS){const t=this.LOCKOUT_DURATION-e;if(t>0)return{canAttempt:!1,error:`激活尝试次数过多，请等待 ${Math.ceil(t/6e4)} 分钟后重试`,remainingTime:t}}}return this.saveAttempts(i),{canAttempt:!0}}static async recordAttempt(e){const t=await this.generateSimpleFingerprint(),n=this.getAttempts();n.push({timestamp:Date.now(),success:e,deviceFingerprint:t}),this.saveAttempts(n)}static getAttempts(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}static saveAttempts(e){try{const t=e.slice(-50);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}catch(t){}}static async generateSimpleFingerprint(){const e=[navigator.userAgent,`${screen.width}x${screen.height}`,(new Date).getTimezoneOffset().toString()].join("|"),t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("").substring(0,16)}static resetAttempts(){localStorage.removeItem(this.STORAGE_KEY)}}oe(As,"MAX_ATTEMPTS",5),oe(As,"LOCKOUT_DURATION",9e5),oe(As,"ATTEMPT_WINDOW",3e5),oe(As,"STORAGE_KEY","tuanki_activation_attempts");const Es=new Ms,zs=Object.freeze(Object.defineProperty({__proto__:null,ActivationAttemptLimiter:As,LicenseManager:Ms,licenseManager:Es},Symbol.toStringTag,{value:"Module"}));class Ps{constructor(e,t){oe(this,"notice",null),oe(this,"isDestroyed",!1);try{this.notice=ki(()=>new ge.Notice(e,t))}catch(n){_e.warn("[SafeNotice] 创建 Notice 失败:",n),this.notice=null}}hide(){if(!this.isDestroyed&&this.notice)try{if(this.notice&&"function"==typeof this.notice.hide)ki(()=>{var e;null==(e=this.notice)||e.hide()});else if(this.notice&&"isShown"in this.notice){const e=this.notice.isShown;"boolean"==typeof e&&e&&this.hideViaDom()}}catch(e){!function(e){const t=e.message||"",n=e.stack||"";return[/isShown is not a function/,/hide is not a function/,/show is not a function/,/Cannot read properties of undefined \(reading 'isShown'\)/,/Cannot read properties of undefined \(reading 'hide'\)/,/Cannot read properties of undefined \(reading 'show'\)/].some(e=>e.test(t)||e.test(n))}(e)?_e.error("[SafeNotice] 隐藏失败:",e):(_e.warn("[SafeNotice] 兼容性问题，尝试替代方案:",e),this.hideViaDom())}}hideViaDom(){try{document.querySelectorAll(".notice").forEach(e=>{const t=e;"none"!==t.style.display&&(t.style.display="none")})}catch(e){_e.warn("[SafeNotice] DOM 操作失败:",e)}}isShown(){if(this.isDestroyed||!this.notice)return!1;try{if("isShown"in this.notice){const e=this.notice.isShown;if("function"==typeof e)return ki(()=>e.call(this.notice));if("boolean"==typeof e)return e}return!0}catch(e){return _e.warn("[SafeNotice] 检查显示状态失败:",e),!1}}destroy(){this.isDestroyed||(this.hide(),this.isDestroyed=!0,this.notice=null)}}const Rs=class e{constructor(){oe(this,"activePluginEditor",null),_e.debug("[EditorContextManager] 初始化")}static getInstance(){return this.instance||(this.instance=new e),this.instance}registerActive(e){_e.debug("[EditorContextManager] 注册活动编辑器"),this.activePluginEditor=e}unregisterActive(e){this.activePluginEditor===e&&(_e.debug("[EditorContextManager] 取消注册活动编辑器"),this.activePluginEditor=null)}getActivePluginEditor(){return this.activePluginEditor}hasActivePluginEditor(){return null!==this.activePluginEditor}getCompatibleEditor(){if(!this.activePluginEditor)return null;const e=this.activePluginEditor.getCM();return e?{getSelection:()=>{try{const t=e.state,n=t.selection.main;return t.sliceDoc(n.from,n.to)}catch(t){return _e.error("[EditorContextManager] getSelection 失败:",t),""}},replaceSelection:t=>{try{const n=e.state.selection.main;e.dispatch({changes:{from:n.from,to:n.to,insert:t},selection:{anchor:n.from+t.length}})}catch(n){_e.error("[EditorContextManager] replaceSelection 失败:",n)}},getValue:()=>{try{return e.state.doc.toString()}catch(t){return _e.error("[EditorContextManager] getValue 失败:",t),""}},setValue:t=>{try{e.dispatch({changes:{from:0,to:e.state.doc.length,insert:t}})}catch(n){_e.error("[EditorContextManager] setValue 失败:",n)}}}:(_e.warn("[EditorContextManager] CodeMirror 实例不存在"),null)}};oe(Rs,"instance");let $s=Rs;const Os={activationCode:"",isActivated:!1,activatedAt:"",deviceFingerprint:"",expiresAt:"",productVersion:"",licenseType:"lifetime"};var Ls=(e=>(e.SINGLETON="singleton",e.TRANSIENT="transient",e.SCOPED="scoped",e))(Ls||{});class Ns{constructor(e){oe(this,"services",new Map),oe(this,"instances",new Map),oe(this,"scopes",new Set),oe(this,"parent"),oe(this,"isDisposed",!1),this.parent=e}register(e){if(this.isDisposed)throw new Error("容器已被释放，无法注册服务");this.validateServiceDescriptor(e),this.services.set(e.token.name,e),_e.debug(`✅ 服务已注册: ${e.token.name} (${e.lifetime})`)}resolve(e){if(this.isDisposed)throw new Error("容器已被释放，无法解析服务");const t=this.resolveInternal(e);if(void 0===t)throw new Error(`服务未注册: ${e.name}`);return t}resolveOptional(e){if(!this.isDisposed)return this.resolveInternal(e)}createScope(){if(this.isDisposed)throw new Error("容器已被释放，无法创建作用域");const e=new Ns(this);return this.scopes.add(e),e}dispose(){if(!this.isDisposed){for(const e of this.scopes)e.dispose();this.scopes.clear();for(const[t,n]of this.instances)if(n&&"function"==typeof n.dispose)try{n.dispose()}catch(e){_e.error(`释放服务实例失败: ${t}`,e)}this.instances.clear(),this.parent&&this.parent.scopes.delete(this),this.isDisposed=!0,_e.debug("🗑️ 依赖注入容器已释放")}}resolveInternal(e){const t=e.name;if(this.instances.has(t))return this.instances.get(t);const n=this.services.get(t);return n?this.createInstance(n):this.parent?this.parent.resolveInternal(e):void 0}createInstance(e){const t=e.token.name;try{let n;if(e.instance)n=e.instance;else if(e.factory)n=e.factory(this);else{if(!e.implementation)throw new Error(`服务描述符无效: ${t}`);{const t=this.resolveDependencies(e.dependencies||[]);n=new e.implementation(...t)}}return("singleton"===e.lifetime||"scoped"===e.lifetime)&&this.instances.set(t,n),n}catch(n){const e=n instanceof Error?n.message:String(n);throw new Error(`创建服务实例失败: ${t} - ${e}`)}}resolveDependencies(e){return e.map(e=>this.resolve(e))}validateServiceDescriptor(e){if(!e.token||!e.token.name)throw new Error("服务令牌无效");if(!e.implementation&&!e.factory&&!e.instance)throw new Error("必须提供实现、工厂函数或实例");this.services.has(e.token.name)&&_e.warn(`⚠️ 服务已存在，将被覆盖: ${e.token.name}`)}getContainerInfo(){return{servicesCount:this.services.size,instancesCount:this.instances.size,scopesCount:this.scopes.size,isDisposed:this.isDisposed,services:Array.from(this.services.values()).map(e=>({name:e.token.name,lifetime:e.lifetime,hasInstance:this.instances.has(e.token.name),layer:e.layer,type:e.type}))}}}function Fs(e,t){return{name:e,description:t}}const Bs={DATA_STORAGE:Fs("DataStorage","数据存储服务"),ANALYTICS_SERVICE:Fs("AnalyticsService","分析服务"),FSRS_SERVICE:Fs("FSRSService","FSRS算法服务"),ENHANCED_FSRS:Fs("EnhancedFSRS","增强FSRS服务"),CARD_SERVICE:Fs("CardService","卡片服务"),DECK_SERVICE:Fs("DeckService","牌组服务"),TEMPLATE_SERVICE:Fs("TemplateService","模板服务"),SYNC_SERVICE:Fs("SyncService","同步服务"),DATA_MANAGEMENT_SERVICE:Fs("DataManagementService","数据管理服务"),BACKUP_MANAGEMENT_SERVICE:Fs("BackupManagementService","备份管理服务"),ERROR_HANDLER:Fs("ErrorHandler","错误处理器"),PERFORMANCE_MONITOR:Fs("PerformanceMonitor","性能监控器"),LICENSE_MANAGER:Fs("LicenseManager","许可证管理器"),STATE_MANAGER:Fs("StateManager","状态管理器"),NOTIFICATION_SERVICE:Fs("NotificationService","通知服务"),MODAL_SERVICE:Fs("ModalService","模态框服务")};function js(e){return function(t){return t.__injectable__={lifetime:(null==e?void 0:e.lifetime)||"transient",layer:null==e?void 0:e.layer,type:null==e?void 0:e.type},t}}const Us=class e{static getInstance(){return e.instance||(e.instance=new Ns),e.instance}static reset(){e.instance&&e.instance.dispose(),e.instance=new Ns}static dispose(){e.instance&&(e.instance.dispose(),e.instance=void 0)}};oe(Us,"instance");let Vs=Us;function qs(e){Vs.getInstance().register(e)}function Hs(e){return Vs.getInstance().resolve(e)}var Ws=(e=>(e.PRESENTATION="presentation",e.APPLICATION="application",e.DOMAIN="domain",e.INFRASTRUCTURE="infrastructure",e))(Ws||{}),Gs=(e=>(e.VIEW_COMPONENT="view_component",e.MODAL_COMPONENT="modal_component",e.UI_WIDGET="ui_widget",e.APPLICATION_SERVICE="application_service",e.USE_CASE_HANDLER="use_case_handler",e.WORKFLOW_ORCHESTRATOR="workflow_orchestrator",e.DOMAIN_SERVICE="domain_service",e.DOMAIN_MODEL="domain_model",e.REPOSITORY_INTERFACE="repository_interface",e.DATA_REPOSITORY="data_repository",e.EXTERNAL_SERVICE="external_service",e.INFRASTRUCTURE_SERVICE="infrastructure_service",e))(Gs||{});class Qs{static validateDependency(e,t){return(this.ALLOWED_DEPENDENCIES.get(e)||[]).includes(t)}static getDependencyDescription(e){const t=this.ALLOWED_DEPENDENCIES.get(e)||[];return 0===t.length?`${e} 层不依赖任何其他层`:`${e} 层只能依赖: ${t.join(", ")}`}}oe(Qs,"ALLOWED_DEPENDENCIES",new Map([["presentation",["application"]],["application",["domain","infrastructure"]],["domain",[]],["infrastructure",["domain"]]]));const Ks=class e{constructor(){oe(this,"components",new Map),oe(this,"dependencyGraph",new Map)}static getInstance(){return e.instance||(e.instance=new e),e.instance}registerComponent(e){this.validateComponentDependencies(e),this.components.set(e.id,e),this.dependencyGraph.set(e.id,new Set(e.dependencies)),_e.debug(`✅ 组件已注册: ${e.name} (${e.layer}/${e.type})`)}getComponent(e){return this.components.get(e)}getComponentsByLayer(e){return Array.from(this.components.values()).filter(t=>t.layer===e)}validateComponentDependencies(e){for(const t of e.dependencies){const n=this.components.get(t);if(n){if(!Qs.validateDependency(e.layer,n.layer))throw new Error(`❌ 非法依赖关系: ${e.name}(${e.layer}) -> ${n.name}(${n.layer})\n规则: ${Qs.getDependencyDescription(e.layer)}`)}else _e.warn(`⚠️ 依赖组件未找到: ${t}`)}}detectCircularDependencies(){const e=new Set,t=new Set,n=[],i=(a,r)=>{if(t.has(a)){const e=r.indexOf(a),t=r.slice(e).concat(a);return void n.push(t.join(" -> "))}if(e.has(a))return;e.add(a),t.add(a);const s=this.dependencyGraph.get(a)||new Set;for(const e of s)i(e,[...r,a]);t.delete(a)};for(const a of this.components.keys())e.has(a)||i(a,[]);return n}generateArchitectureReport(){const e=new Map;for(const i of Object.values(Ws))e.set(i,this.getComponentsByLayer(i));const t=this.detectCircularDependencies(),n=this.findOrphanedComponents();return{totalComponents:this.components.size,componentsByLayer:e,circularDependencies:t,orphanedComponents:n,dependencyViolations:this.findDependencyViolations(),generatedAt:(new Date).toISOString()}}findOrphanedComponents(){const e=new Set;for(const t of this.dependencyGraph.values())for(const n of t)e.add(n);return Array.from(this.components.keys()).filter(t=>!e.has(t))}findDependencyViolations(){const e=[];for(const[t,n]of this.components)for(const i of n.dependencies){const a=this.components.get(i);a&&(Qs.validateDependency(n.layer,a.layer)||e.push({from:t,to:i,fromLayer:n.layer,toLayer:a.layer,description:`${n.name} 不应该依赖 ${a.name}`}))}return e}};oe(Ks,"instance");let Zs=Ks;class Ys{constructor(){oe(this,"registry",Zs.getInstance())}async performHealthCheck(){const e=Date.now(),t=this.registry.generateArchitectureReport(),n=[];t.circularDependencies.length>0&&n.push({severity:"critical",type:"circular_dependency",description:`发现 ${t.circularDependencies.length} 个循环依赖`,details:t.circularDependencies}),t.dependencyViolations.length>0&&n.push({severity:"error",type:"dependency_violation",description:`发现 ${t.dependencyViolations.length} 个依赖违规`,details:t.dependencyViolations.map(e=>e.description)}),t.orphanedComponents.length>0&&n.push({severity:"warning",type:"orphaned_component",description:`发现 ${t.orphanedComponents.length} 个孤立组件`,details:t.orphanedComponents});const i=Date.now();return{status:n.some(e=>"critical"===e.severity)?"critical":n.some(e=>"error"===e.severity)?"error":n.some(e=>"warning"===e.severity)?"warning":"healthy",issues:n,report:t,checkDuration:i-e,checkedAt:(new Date).toISOString()}}}const Xs=class e{constructor(){oe(this,"_state"),oe(this,"middlewares",[]),oe(this,"eventHistory",[]),oe(this,"subscribers",new Set),this._state=Fr(this.createInitialState()),this.setupDefaultMiddlewares()}static getInstance(){return e.instance||(e.instance=new e),e.instance}get state(){return this._state}dispatch(e){this.processEventThroughMiddlewares(e,e=>{this.applyStateChange(e),this.addToHistory(e),this.notifySubscribers()})}getSnapshot(){return jr(this._state)}subscribe(e){return this.subscribers.add(e),e(this.getSnapshot()),()=>{this.subscribers.delete(e)}}addMiddleware(e){this.middlewares.push(e)}removeMiddleware(e){this.middlewares=this.middlewares.filter(t=>t.name!==e)}createInitialState(){return{ui:{currentPage:"deck-study",activeModal:null,loading:!1,notifications:[],theme:"auto",sidebarCollapsed:!1},data:{decks:new Map,cards:new Map,templates:new Map,lastSyncTime:null,isDirty:!1},learning:{currentSession:null,studyQueue:[],statistics:{},fsrsParameters:{}},system:{isOnline:navigator.onLine,performance:{memoryUsage:0,renderTime:0,apiLatency:0},errors:[],debugMode:!1},feedback:{activeFeedbacks:[],recentStatistics:[],smartSuggestions:[],userPatterns:[],currentSessionId:null},monitoring:{currentMetrics:{},recentReports:[],activeBottlenecks:[],monitoringStatus:!1,performanceScore:100},deployment:{currentDeployment:null,deploymentHistory:[],isDeploying:!1,lastDeploymentResult:null},ux:{userPreferences:{theme:"auto",animationSpeed:"normal",compactMode:!1,autoSave:!0,showTooltips:!0,keyboardShortcuts:!0,accessibilityMode:!1,language:"zh-CN"},behaviors:[],recommendations:[],currentSession:null}}}setupDefaultMiddlewares(){this.addMiddleware(new eo),this.addMiddleware(new to),this.addMiddleware(new no)}processEventThroughMiddlewares(e,t){let n=0;const i=e=>{if(n>=this.middlewares.length)return void t(e);this.middlewares[n++].process(e,i)};i(e)}applyStateChange(e){this._state.update(t=>this.reduceState(t,e))}reduceState(e,t){const[n,i]=t.type.split("/");switch(n){case"ui":return{...e,ui:this.reduceUIState(e.ui,i,t.payload)};case"data":return{...e,data:this.reduceDataState(e.data,i,t.payload)};case"learning":return{...e,learning:this.reduceLearningState(e.learning,i,t.payload)};case"system":return{...e,system:this.reduceSystemState(e.system,i,t.payload)};case"feedback":return{...e,feedback:this.reduceFeedbackState(e.feedback,i,t.payload)};case"monitoring":return{...e,monitoring:this.reduceMonitoringState(e.monitoring,i,t.payload)};case"deployment":return{...e,deployment:this.reduceDeploymentState(e.deployment,i,t.payload)};case"ux":return{...e,ux:this.reduceUXState(e.ux,i,t.payload)};default:return _e.warn(`未知的状态域: ${n}`),e}}reduceUIState(e,t,n){switch(t){case"SET_CURRENT_PAGE":return{...e,currentPage:n};case"SET_ACTIVE_MODAL":return{...e,activeModal:n};case"SET_LOADING":return{...e,loading:n};case"ADD_NOTIFICATION":return{...e,notifications:[...e.notifications,n]};case"REMOVE_NOTIFICATION":return{...e,notifications:e.notifications.filter(e=>e.id!==n)};case"SET_THEME":return{...e,theme:n};case"TOGGLE_SIDEBAR":return{...e,sidebarCollapsed:!e.sidebarCollapsed};default:return e}}reduceDataState(e,t,n){switch(t){case"SET_DECKS":return{...e,decks:new Map(n),isDirty:!0};case"ADD_DECK":{const t=new Map(e.decks);return t.set(n.id,n),{...e,decks:t,isDirty:!0}}case"UPDATE_DECK":{const t=new Map(e.decks);return t.set(n.id,{...t.get(n.id),...n}),{...e,decks:t,isDirty:!0}}case"DELETE_DECK":{const t=new Map(e.decks);return t.delete(n),{...e,decks:t,isDirty:!0}}case"SET_SYNC_TIME":return{...e,lastSyncTime:n,isDirty:!1};default:return e}}reduceLearningState(e,t,n){switch(t){case"START_SESSION":return{...e,currentSession:n};case"END_SESSION":return{...e,currentSession:null};case"UPDATE_QUEUE":return{...e,studyQueue:n};case"UPDATE_STATISTICS":return{...e,statistics:{...e.statistics,...n}};case"UPDATE_FSRS_PARAMS":return{...e,fsrsParameters:{...e.fsrsParameters,...n}};default:return e}}reduceSystemState(e,t,n){switch(t){case"SET_ONLINE_STATUS":return{...e,isOnline:n};case"UPDATE_PERFORMANCE":return{...e,performance:{...e.performance,...n}};case"ADD_ERROR":return{...e,errors:[...e.errors,n]};case"RESOLVE_ERROR":return{...e,errors:e.errors.map(e=>e.id===n?{...e,resolved:!0}:e)};case"SET_DEBUG_MODE":return{...e,debugMode:n};case"ENABLE_GRACEFUL_DEGRADATION":return{...e,performance:{...e.performance,gracefulDegradation:!0,degradationReason:n.reason}};default:return e}}reduceFeedbackState(e,t,n){switch(t){case"ADD_FEEDBACK":return{...e,activeFeedbacks:[...e.activeFeedbacks,n]};case"REMOVE_FEEDBACK":return{...e,activeFeedbacks:e.activeFeedbacks.filter(e=>e.id!==n)};case"UPDATE_STATISTICS":return{...e,recentStatistics:n};case"SET_SUGGESTIONS":return{...e,smartSuggestions:n};case"ADD_SUGGESTION":return{...e,smartSuggestions:[...e.smartSuggestions,n]};case"DISMISS_SUGGESTION":return{...e,smartSuggestions:e.smartSuggestions.map(e=>e.id===n?{...e,dismissed:!0}:e)};case"UPDATE_PATTERNS":return{...e,userPatterns:n};case"SET_SESSION_ID":return{...e,currentSessionId:n};default:return e}}reduceMonitoringState(e,t,n){switch(t){case"UPDATE_METRICS":return{...e,currentMetrics:{...e.currentMetrics,...n}};case"ADD_REPORT":return{...e,recentReports:[...e.recentReports,n]};case"ADD_BOTTLENECK":return{...e,activeBottlenecks:[...e.activeBottlenecks,n]};case"RESOLVE_BOTTLENECK":return{...e,activeBottlenecks:e.activeBottlenecks.filter(e=>e.id!==n)};case"SET_MONITORING_STATUS":return{...e,monitoringStatus:n};case"UPDATE_PERFORMANCE_SCORE":return{...e,performanceScore:n};case"CLEAR_REPORTS":return{...e,recentReports:[]};default:return e}}reduceDeploymentState(e,t,n){switch(t){case"START_DEPLOYMENT":return{...e,currentDeployment:n,isDeploying:!0};case"UPDATE_DEPLOYMENT":return{...e,currentDeployment:e.currentDeployment?{...e.currentDeployment,...n}:null};case"COMPLETE_DEPLOYMENT":return{...e,currentDeployment:null,isDeploying:!1,deploymentHistory:[...e.deploymentHistory,n],lastDeploymentResult:n.result};case"FAIL_DEPLOYMENT":return{...e,currentDeployment:null,isDeploying:!1,lastDeploymentResult:n};case"CLEAR_DEPLOYMENT_HISTORY":return{...e,deploymentHistory:[]};default:return e}}reduceUXState(e,t,n){switch(t){case"UPDATE_PREFERENCES":return{...e,userPreferences:{...e.userPreferences,...n}};case"ADD_BEHAVIOR":return{...e,behaviors:[...e.behaviors,n]};case"ADD_RECOMMENDATION":return{...e,recommendations:[...e.recommendations,n]};case"IMPLEMENT_RECOMMENDATION":return{...e,recommendations:e.recommendations.map(e=>e.id===n?{...e,implemented:!0}:e)};case"START_SESSION":return{...e,currentSession:n};case"END_SESSION":return{...e,currentSession:e.currentSession?{...e.currentSession,endTime:Date.now()}:null};case"CLEAR_BEHAVIORS":return{...e,behaviors:[]};default:return e}}addToHistory(e){this.eventHistory.push(e),this.eventHistory.length>1e3&&this.eventHistory.splice(0,this.eventHistory.length-1e3)}notifySubscribers(){const e=this.getSnapshot();this.subscribers.forEach(t=>{try{t(e)}catch(n){_e.error("状态订阅者执行错误:",n)}})}};oe(Xs,"instance");let Js=Xs;class eo{constructor(){oe(this,"name","logging")}process(e,t){_e.debug(`🔄 状态变更: ${e.type}`,e.payload),t(e)}}class to{constructor(){oe(this,"name","validation")}process(e,t){e.type&&"string"==typeof e.type?e.type.includes("/")?t(e):_e.error("❌ 事件类型必须包含域名和动作:",e.type):_e.error("❌ 无效的事件类型:",e)}}class no{constructor(){oe(this,"name","performance")}process(e,t){const n=performance.now();t(e);const i=performance.now()-n;i>10&&_e.warn(`⚠️ 状态变更耗时过长: ${e.type} (${i.toFixed(2)}ms)`)}}const io=Js.getInstance(),ao=(e,t)=>{io.dispatch({type:`ui/${e}`,payload:t,timestamp:Date.now(),source:"ui"})},ro=(e,t)=>{io.dispatch({type:`system/${e}`,payload:t,timestamp:Date.now(),source:"system"})},so="回收",oo="recycle",lo="搁置",co="postpone";var uo=(e=>(e.HIGH_LAPSES="high_lapses",e.HIGH_LAPSE_RATE="high_lapse_rate",e.HIGH_DIFFICULTY="high_difficulty",e.TIME_SINK="time_sink",e.REVIEW_FATIGUE="review_fatigue",e.MANUAL="manual",e.NEEDS_SPLIT="needs_split",e.NEEDS_CONTEXT="needs_context",e.CONTENT_ERROR="content_error",e))(uo||{}),ho=(e=>(e.PENDING="pending",e.IN_PROGRESS="in_progress",e.READY="ready",e.REACTIVATED="reactivated",e))(ho||{});const po=3e4,go=1e3,vo=1048576,fo=1e4,mo=3e5,yo=500,bo=25,wo=85,ko=98,So=1500,xo=5e3,_o=150,Co=500,Io="NETWORK_ERROR",Do="TIMEOUT_ERROR",To="DATA_CORRUPTION",Mo="VALIDATION_ERROR",Ao="PERMISSION_DENIED",Eo="UNKNOWN_ERROR",zo=class e{constructor(){oe(this,"recoveryStrategies",new Map),oe(this,"errorHistory",[]),oe(this,"maxHistorySize",1e3),this.setupDefaultRecoveryStrategies()}static getInstance(){return e.instance||(e.instance=new e),e.instance}async handleError(e,t){const n=this.normalizeError(e,t);this.addToHistory(n),this.updateSystemState(n);return await this.processError(n)}normalizeError(e,t){return"string"==typeof e?this.createUnifiedError(e,t):this.isUnifiedError(e)?{...e,context:{...e.context,...t}}:this.createUnifiedErrorFromError(e,t)}createUnifiedError(e,t){return{id:this.generateErrorId(),code:this.inferErrorCode(e),message:e,category:this.inferErrorCategory(e),severity:this.inferErrorSeverity(e),context:{component:"unknown",operation:"unknown",...t},timestamp:Date.now(),recoverable:this.isRecoverable(e),userMessage:this.generateUserMessage(e),actionable:this.isActionable(e)}}createUnifiedErrorFromError(e,t){return{id:this.generateErrorId(),code:this.inferErrorCode(e.message),message:e.message,category:this.inferErrorCategory(e.message),severity:this.inferErrorSeverity(e.message),context:{component:"unknown",operation:"unknown",...t},timestamp:Date.now(),stack:e.stack,cause:e,recoverable:this.isRecoverable(e.message),userMessage:this.generateUserMessage(e.message),actionable:this.isActionable(e.message)}}async processError(e){const t={handled:!1,recovered:!1,userNotified:!1,logged:!1,retryable:!1};try{return this.logError(e),t.logged=!0,e.recoverable&&(t.recovered=await this.attemptRecovery(e),t.retryable=!t.recovered),this.shouldNotifyUser(e)&&(this.notifyUser(e),t.userNotified=!0),await this.executeSpecificHandling(e),t.handled=!0,t}catch(n){return _e.error("错误处理过程中发生异常:",n),t}}async attemptRecovery(e){const t=this.getRecoveryStrategy(e);if(!t)return!1;let n=0;for(;n<t.maxAttempts;){try{if(await t.execute(e))return _e.debug(`✅ 错误恢复成功: ${e.code} (尝试 ${n+1}/${t.maxAttempts})`),!0}catch(i){_e.warn(`⚠️ 错误恢复失败: ${e.code} (尝试 ${n+1}/${t.maxAttempts})`,i)}n++,n<t.maxAttempts&&await this.delay(t.retryDelay*2**(n-1))}return!1}getRecoveryStrategy(e){const t=[e.code,e.category,"default"];for(const n of t){const e=this.recoveryStrategies.get(n);if(e)return e}}notifyUser(e){const t=e.userMessage||e.message,n=this.getNotificationDuration(e.severity);ao("ADD_NOTIFICATION",{id:e.id,type:this.mapSeverityToNotificationType(e.severity),message:t,duration:n,timestamp:e.timestamp})}logError(e){const t=this.mapSeverityToLogLevel(e.severity),n=`[${e.category.toUpperCase()}] ${e.code}: ${e.message}`;switch(t){case"error":_e.error(n,e);break;case"warn":_e.warn(n,e);break;case"info":_e.info(n,e);break;default:_e.debug(n,e)}}async executeSpecificHandling(e){switch(e.category){case"network":await this.handleNetworkError(e);break;case"data":await this.handleDataError(e);break;case"validation":await this.handleValidationError(e);break;case"permission":await this.handlePermissionError(e);break;case"system":await this.handleSystemError(e)}}async handleNetworkError(e){ro("SET_ONLINE_STATUS",!1),setTimeout(()=>{ro("SET_ONLINE_STATUS",navigator.onLine)},po)}async handleDataError(e){}async handleValidationError(e){}async handlePermissionError(e){}async handleSystemError(e){(e.message.includes("内存")||e.message.includes("memory"))&&await this.handleMemoryError(e)}async handleMemoryError(e){_e.warn("🧠 处理内存相关错误:",e.message);try{ro("TRIGGER_MEMORY_CLEANUP",{severity:e.severity,timestamp:e.timestamp}),"critical"===e.severity&&ro("ENABLE_GRACEFUL_DEGRADATION",{reason:"memory_pressure",timestamp:e.timestamp})}catch(t){_e.error("内存清理失败:",t)}}setupDefaultRecoveryStrategies(){this.addRecoveryStrategy({name:"network-retry",description:"网络错误重试策略",execute:async e=>navigator.onLine,maxAttempts:3,retryDelay:go},"network"),this.addRecoveryStrategy({name:"data-reload",description:"数据重新加载策略",execute:async e=>!1,maxAttempts:2,retryDelay:go},"data"),this.addRecoveryStrategy({name:"default-retry",description:"默认重试策略",execute:async e=>!1,maxAttempts:1,retryDelay:go},"default")}addRecoveryStrategy(e,t){this.recoveryStrategies.set(t.toString(),e)}generateErrorId(){return`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}isUnifiedError(e){return e&&"object"==typeof e&&"id"in e&&"code"in e&&"category"in e}inferErrorCode(e){return e.includes("网络")||e.includes("连接")?Io:e.includes("超时")?Do:e.includes("权限")||e.includes("访问")?Ao:e.includes("验证")||e.includes("格式")?Mo:e.includes("数据")||e.includes("解析")?To:Eo}inferErrorCategory(e){return e.includes("网络")||e.includes("连接")?"network":e.includes("权限")||e.includes("访问")?"permission":e.includes("验证")||e.includes("格式")?"validation":e.includes("数据")||e.includes("解析")?"data":"system"}inferErrorSeverity(e){return e.includes("严重")||e.includes("致命")?"critical":e.includes("错误")||e.includes("失败")?"error":e.includes("警告")||e.includes("注意")?"warning":"info"}isRecoverable(e){return e.includes("网络")||e.includes("超时")||e.includes("连接")}isActionable(e){return e.includes("验证")||e.includes("权限")||e.includes("格式")}generateUserMessage(e){return e.includes("网络")?"网络连接异常，请检查网络设置":e.includes("权限")?"权限不足，请检查相关权限设置":e.includes("验证")?"输入格式不正确，请检查后重试":e}shouldNotifyUser(e){return"info"!==e.severity||e.actionable||!1}getNotificationDuration(e){switch(e){case"critical":return 1e4;case"error":return 5e3;case"warning":return 3e3;default:return 2e3}}mapSeverityToNotificationType(e){switch(e){case"critical":case"error":return"error";case"warning":return"warning";default:return"info"}}mapSeverityToLogLevel(e){switch(e){case"critical":case"error":return"error";case"warning":return"warn";case"info":return"info";default:return"log"}}addToHistory(e){this.errorHistory.push(e),this.errorHistory.length>this.maxHistorySize&&this.errorHistory.splice(0,this.errorHistory.length-this.maxHistorySize)}updateSystemState(e){ro("ADD_ERROR",{id:e.id,message:e.message,stack:e.stack,timestamp:e.timestamp,resolved:!1})}async delay(e){return new Promise(t=>setTimeout(t,e))}getErrorHistory(){return[...this.errorHistory]}clearErrorHistory(){this.errorHistory=[]}};oe(zo,"instance");let Po=zo;const Ro=Po.getInstance(),$o=(e,t)=>Ro.handleError(e,t),Oo=(e,t,n)=>({component:e,operation:t,metadata:n}),Lo=class e{constructor(){oe(this,"isMonitoring",!1),oe(this,"metricsHistory",[]),oe(this,"warnings",[]),oe(this,"observers",[]),oe(this,"intervals",[]),oe(this,"lastLeakReportTime"),oe(this,"baselines",{memoryUsage:50*vo,renderTime:16.67,networkLatency:100,interactionDelay:100})}static getInstance(){return e.instance||(e.instance=new e),e.instance}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.setupPerformanceObservers(),this.startMetricsCollection(),_e.debug("🔍 性能监控已启动"))}stopMonitoring(){this.isMonitoring&&(this.isMonitoring=!1,this.cleanupObservers(),this.cleanupIntervals(),this.metricsHistory=[],this.warnings=[],this.lastLeakReportTime=void 0,_e.debug("⏹️ 性能监控已停止，所有资源已清理"))}setupPerformanceObservers(){try{if("PerformanceObserver"in window){const e=new PerformanceObserver(e=>{this.processRenderMetrics(e.getEntries())});e.observe({entryTypes:["paint","layout-shift","largest-contentful-paint"]}),this.observers.push(e);const t=new PerformanceObserver(e=>{this.processNetworkMetrics(e.getEntries())});t.observe({entryTypes:["navigation","resource"]}),this.observers.push(t);const n=new PerformanceObserver(e=>{this.processInteractionMetrics(e.getEntries())});n.observe({entryTypes:["event","first-input"]}),this.observers.push(n)}}catch(e){$o(e,Oo("PerformanceMonitor","setupPerformanceObservers"))}}startMetricsCollection(){const e=setInterval(()=>{this.collectMetrics()},fo);this.intervals.push(e);const t=setInterval(()=>{this.generatePerformanceReport()},mo);this.intervals.push(t)}async collectMetrics(){try{const e={memoryUsage:await this.collectMemoryMetrics(),renderMetrics:this.collectRenderMetrics(),networkMetrics:this.collectNetworkMetrics(),interactionMetrics:this.collectInteractionMetrics(),systemMetrics:this.collectSystemMetrics(),timestamp:Date.now()};this.addMetricsToHistory(e),this.analyzeMetrics(e),this.updateSystemState(e)}catch(e){$o(e,Oo("PerformanceMonitor","collectMetrics"))}}async collectMemoryMetrics(){const e=performance.memory||{};return{used:e.usedJSHeapSize||0,total:e.totalJSHeapSize||0,percentage:e.totalJSHeapSize?e.usedJSHeapSize/e.totalJSHeapSize*100:0,gcCount:this.getGCCount(),leakDetected:this.detectMemoryLeak()}}collectRenderMetrics(){const e=performance.getEntriesByType("navigation")[0];return{fps:this.calculateFPS(),frameTime:this.getAverageFrameTime(),paintTime:e?e.loadEventEnd-e.loadEventStart:0,layoutTime:this.getLayoutTime(),scriptTime:this.getScriptTime()}}collectNetworkMetrics(){const e=performance.getEntriesByType("resource"),t=e.slice(-10),n=t.reduce((e,t)=>e+(t.responseEnd-t.requestStart),0);return{latency:t.length?n/t.length:0,bandwidth:this.calculateBandwidth(t),requestCount:e.length,errorRate:this.calculateErrorRate(t)}}collectInteractionMetrics(){return{inputDelay:this.getInputDelay(),responseTime:this.getResponseTime(),clickToAction:this.getClickToActionTime(),scrollPerformance:this.getScrollPerformance()}}collectSystemMetrics(){return{cpuUsage:this.estimateCPUUsage(),diskIO:0,networkIO:this.getNetworkIO(),activeConnections:this.getActiveConnections()}}analyzeMetrics(e){e.memoryUsage.percentage>ko?this.createWarning("memory_high","critical",`内存使用率过高: ${e.memoryUsage.percentage.toFixed(1)}%`,e):e.memoryUsage.percentage>wo&&this.createWarning("memory_high","high",`内存使用率较高: ${e.memoryUsage.percentage.toFixed(1)}%`,e),e.memoryUsage.leakDetected&&this.createWarning("memory_leak","critical","检测到可能的内存泄漏",e),e.renderMetrics.frameTime>Co?this.createWarning("render_slow","critical",`渲染性能严重下降: ${e.renderMetrics.frameTime.toFixed(1)}ms/frame`,e):e.renderMetrics.frameTime>_o&&this.createWarning("render_slow","medium",`渲染性能下降: ${e.renderMetrics.frameTime.toFixed(1)}ms/frame`,e),e.networkMetrics.latency>xo&&this.createWarning("network_slow","high",`网络延迟过高: ${e.networkMetrics.latency.toFixed(0)}ms`,e),e.interactionMetrics.inputDelay>So&&this.createWarning("interaction_slow","medium",`交互响应延迟: ${e.interactionMetrics.inputDelay.toFixed(0)}ms`,e)}createWarning(e,t,n,i){const a={id:`perf_warning_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:e,severity:t,message:n,metrics:i,timestamp:Date.now(),resolved:!1};this.warnings.push(a),this.warnings.length>bo&&this.warnings.splice(0,this.warnings.length-bo),this.notifyPerformanceIssue(a)}notifyPerformanceIssue(e){ro("UPDATE_PERFORMANCE",{warning:e.message,severity:e.severity,timestamp:e.timestamp}),"critical"===e.severity&&$o(`性能严重问题: ${e.message}`,Oo("PerformanceMonitor","performanceIssue",{warningType:e.type,severity:e.severity}))}generatePerformanceReport(){if(0===this.metricsHistory.length)return;const e=this.metricsHistory.slice(-10),t=this.analyzeMetricsHistory(e);_e.debug("📊 性能报告:",t),ro("UPDATE_PERFORMANCE",{report:t,timestamp:Date.now()})}analyzeMetricsHistory(e){const t=e.reduce((e,t)=>e+t.memoryUsage.percentage,0)/e.length,n=e.reduce((e,t)=>e+t.renderMetrics.frameTime,0)/e.length,i=e.reduce((e,t)=>e+t.networkMetrics.latency,0)/e.length;return{averageMemoryUsage:`${t.toFixed(1)}%`,averageRenderTime:`${n.toFixed(1)}ms`,averageNetworkLatency:`${i.toFixed(0)}ms`,totalWarnings:this.warnings.filter(e=>!e.resolved).length,metricsCount:e.length}}addMetricsToHistory(e){this.metricsHistory.push(e),this.metricsHistory.length>yo&&this.metricsHistory.splice(0,this.metricsHistory.length-yo)}updateSystemState(e){ro("UPDATE_PERFORMANCE",{memoryUsage:e.memoryUsage.used,renderTime:e.renderMetrics.frameTime,apiLatency:e.networkMetrics.latency})}processRenderMetrics(e){}processNetworkMetrics(e){}processInteractionMetrics(e){}getGCCount(){return 0}detectMemoryLeak(){if(this.metricsHistory.length<10)return!1;const e=this.metricsHistory.slice(-10),t=e[e.length-1];if(t.memoryUsage.percentage<ko)return!1;let n=0;for(let a=1;a<e.length;a++)e[a].memoryUsage.used>e[a-1].memoryUsage.used?n++:n=0;const i=t.memoryUsage.used-e[0].memoryUsage.used;if(n>=9&&i>104857600){const e=Date.now();if(!this.lastLeakReportTime||e-this.lastLeakReportTime>6e5)return this.lastLeakReportTime=e,_e.warn(`🚨 内存泄漏检测: 使用率=${t.memoryUsage.percentage.toFixed(1)}%, 增长=${(i/1024/1024).toFixed(1)}MB, 连续增长=${n}次`),!0}return!1}calculateFPS(){return 60}getAverageFrameTime(){return 16.67}getLayoutTime(){return 0}getScriptTime(){return 0}calculateBandwidth(e){if(0===e.length)return 0;const t=e.reduce((e,t)=>e+(t.transferSize||0),0),n=e.reduce((e,t)=>e+(t.responseEnd-t.requestStart),0);return n>0?t/n*1e3:0}calculateErrorRate(e){return e.length,0}getInputDelay(){return 0}getResponseTime(){return 0}getClickToActionTime(){return 0}getScrollPerformance(){return 0}estimateCPUUsage(){return 0}getNetworkIO(){return 0}getActiveConnections(){return 0}cleanupObservers(){this.observers.forEach(e=>{try{e.disconnect(),_e.debug("🧹 性能观察器已断开")}catch(t){_e.warn("清理性能观察器失败:",t)}}),this.observers=[]}cleanupIntervals(){this.intervals.forEach(e=>{try{clearInterval(e),_e.debug("🧹 性能监控定时器已清理")}catch(t){_e.warn("清理性能监控定时器失败:",t)}}),this.intervals=[]}getMetricsHistory(){return[...this.metricsHistory]}getWarnings(){return[...this.warnings]}resolveWarning(e){const t=this.warnings.find(t=>t.id===e);t&&(t.resolved=!0)}};oe(Lo,"instance");let No=Lo;const Fo=No.getInstance();var Bo=(e=>(e.AUTO="auto",e.MANUAL="manual",e.PRE_OPERATION="pre_operation",e.SCHEDULED="scheduled",e))(Bo||{}),jo=(e=>(e.STARTUP="startup",e.BEFORE_IMPORT="before_import",e.BEFORE_RESET="before_reset",e.MANUAL_REQUEST="manual_request",e.SCHEDULED_TIME="scheduled_time",e.CARD_COUNT_THRESHOLD="card_count_threshold",e))(jo||{}),Uo=(e=>(e.DECKS="decks",e.CARDS="cards",e.SESSIONS="sessions",e.PROFILE="profile",e.TEMPLATES="templates",e.SETTINGS="settings",e))(Uo||{});class Vo{constructor(e,t){oe(this,"dataStorage"),oe(this,"plugin"),this.dataStorage=e,this.plugin=t}async getDataOverview(){var e,t;try{const[i,a,r]=await Promise.all([this.dataStorage.getDecks(),this.dataStorage.getCards(),this.calculateFolderSizes()]);let s=0;try{const n=await(null==(t=(e=this.dataStorage).getStudySessions)?void 0:t.call(e))||[];s=Array.isArray(n)?n.length:0}catch(n){_e.warn("无法获取学习会话数据:",n)}const o=this.getDataFolderPath();return{dataFolderPath:o,totalSize:r.folderSizes[o]||0,totalDecks:i.length,totalCards:a.length,totalSessions:s,lastUpdated:(new Date).toISOString()}}catch(n){throw _e.error("获取数据概览失败:",n),new Error(`获取数据概览失败: ${n instanceof Error?n.message:String(n)}`)}}async getFolderStructure(){try{const e=this.getDataFolderPath(),t=this.plugin.app.vault.adapter;if(!(await t.exists(e)))throw new Error(`数据文件夹不存在: ${e}`);const n=await this.calculateFolderSizes(),i=await this.buildFolderNode(e,n),a=this.countNodesRecursively(i);return{root:i,totalFiles:a.files,totalFolders:a.folders,scannedAt:(new Date).toISOString()}}catch(e){throw _e.error("获取文件夹结构失败:",e),new Error(`获取文件夹结构失败: ${e instanceof Error?e.message:String(e)}`)}}async exportData(e){const t=Date.now();try{const n=await this.collectExportData(e),i=this.generateExportFileName(e.format),a=await this.writeExportFile(n,i,e),r=this.plugin.app.vault.adapter,s=await r.stat(a),o=(null==s?void 0:s.size)||0;return{success:!0,timestamp:(new Date).toISOString(),duration:Date.now()-t,filePath:a,fileSize:o,dataTypes:e.dataTypes,recordCount:this.countExportRecords(n)}}catch(n){return _e.error("数据导出失败:",n),{success:!1,error:n instanceof Error?n.message:String(n),timestamp:(new Date).toISOString(),duration:Date.now()-t,dataTypes:e.dataTypes,recordCount:0}}}async importData(e,t){const n=Date.now();try{t.createBackup&&await this.dataStorage.createBackup();const i=await this.readImportFile(e),a=await this.parseImportData(i,e.name);t.validateData&&await this.validateImportData(a);const r=await this.executeImport(a,t);return{success:!0,timestamp:(new Date).toISOString(),duration:Date.now()-n,importedCount:r.imported,skippedCount:r.skipped,conflictCount:r.conflicts,dataTypes:this.detectDataTypes(a),conflicts:r.conflictDetails}}catch(i){return _e.error("数据导入失败:",i),{success:!1,error:i instanceof Error?i.message:String(i),timestamp:(new Date).toISOString(),duration:Date.now()-n,importedCount:0,skippedCount:0,conflictCount:0,dataTypes:[]}}}async resetData(e){const t=Date.now();try{if("确认重置"!==e)throw new Error("确认文本不正确");const n=await this.dataStorage.createBackup(),i=this.extractBackupId(n),a=await this.getDataOverview(),r=a.totalCards+a.totalDecks+a.totalSessions;return await this.executeReset(),{success:!0,timestamp:(new Date).toISOString(),duration:Date.now()-t,backupId:i,clearedDataTypes:[Uo.DECKS,Uo.CARDS,Uo.SESSIONS,Uo.PROFILE],clearedRecordCount:r}}catch(n){return _e.error("数据重置失败:",n),{success:!1,error:n instanceof Error?n.message:String(n),timestamp:(new Date).toISOString(),duration:Date.now()-t,clearedDataTypes:[],clearedRecordCount:0}}}async checkDataIntegrity(){var e,t;const n=[];let i=100;try{_e.debug("开始数据完整性检查...");const r=this.getDataFolderPath(),s=this.plugin.app.vault.adapter;await s.exists(r)||(n.push({id:"missing-data-folder",type:"missing_file",description:`数据文件夹不存在: ${r}`,severity:"critical",fixSuggestion:"请重新初始化插件或检查配置"}),i-=50);try{const e=await this.dataStorage.getDecks();Array.isArray(e)||(n.push({id:"invalid-decks-data",type:"corrupted_data",description:"牌组数据格式无效",severity:"error",fixSuggestion:"尝试从备份恢复数据"}),i-=20)}catch(a){n.push({id:"decks-read-error",type:"corrupted_data",description:`无法读取牌组数据: ${a instanceof Error?a.message:String(a)}`,severity:"critical",fixSuggestion:"检查数据文件是否损坏，考虑从备份恢复"}),i-=30}try{const e=await this.dataStorage.getCards();if(Array.isArray(e)){const t=e.filter(e=>!e.uuid||!e.deckId);t.length>0&&(n.push({id:"invalid-card-structure",type:"invalid_format",description:`发现 ${t.length} 张卡片缺少必要字段`,severity:"warning",fixSuggestion:"建议清理无效卡片数据"}),i-=Math.min(10,t.length))}else n.push({id:"invalid-cards-data",type:"corrupted_data",description:"卡片数据格式无效",severity:"error",fixSuggestion:"尝试从备份恢复数据"}),i-=20}catch(a){n.push({id:"cards-read-error",type:"corrupted_data",description:`无法读取卡片数据: ${a instanceof Error?a.message:String(a)}`,severity:"critical",fixSuggestion:"检查数据文件是否损坏，考虑从备份恢复"}),i-=30}try{const a=await(null==(t=(e=this.dataStorage).getStudySessions)?void 0:t.call(e))||[];Array.isArray(a)||(n.push({id:"invalid-sessions-data",type:"corrupted_data",description:"学习会话数据格式无效",severity:"warning",fixSuggestion:"会话数据可以重置，不影响卡片内容"}),i-=5)}catch(a){_e.warn("学习会话数据检查失败:",a)}i=Math.max(0,i);const o={success:0===n.filter(e=>"critical"===e.severity||"error"===e.severity).length,score:i,issues:n,timestamp:(new Date).toISOString(),checkType:"manual"};return _e.debug(`数据完整性检查完成: 得分 ${i}，发现 ${n.length} 个问题`),o}catch(a){return _e.error("数据完整性检查失败:",a),{success:!1,score:0,issues:[{id:"check-failed",type:"corrupted_data",description:`完整性检查失败: ${a instanceof Error?a.message:String(a)}`,severity:"critical",fixSuggestion:"请联系技术支持"}],timestamp:(new Date).toISOString(),checkType:"manual"}}}async openDataFolder(){try{const e=this.getDataFolderPath(),t=this.plugin.app.vault.adapter;if(!(await t.exists(e)))throw new Error(`数据文件夹不存在: ${e}`);const n=t.path.resolve(t.basePath,e);"win32"===process.platform?(we.default||we).exec(`explorer "${n}"`):"darwin"===process.platform?(we.default||we).exec(`open "${n}"`):(we.default||we).exec(`xdg-open "${n}"`)}catch(e){throw _e.error("打开数据文件夹失败:",e),new Error(`打开数据文件夹失败: ${e instanceof Error?e.message:String(e)}`)}}async calculateFolderSizes(){try{const e=this.getDataFolderPath(),t=this.plugin.app.vault.adapter,n={},i={};return await this.calculateSizeRecursively(e,n,i,t),{folderSizes:n,fileSizes:i,calculatedAt:(new Date).toISOString()}}catch(e){return _e.error("计算文件夹大小失败:",e),{folderSizes:{},fileSizes:{},calculatedAt:(new Date).toISOString()}}}getDataFolderPath(){var e;null==(e=this.plugin.settings)||e.currentDataSource;return vs().root}async getFieldTemplateCount(){return 0}async getTriadTemplateCount(){return 0}async buildFolderNode(e,t){var n,i;const a=this.plugin.app.vault.adapter,r=await a.list(e),s=e.split("/").pop()||e,o={id:e,name:s,type:"folder",path:e,children:[],description:this.getFolderDescription(s)};for(const l of r.folders||[]){const e=await this.buildFolderNode(l,t);null==(n=o.children)||n.push(e)}for(const l of r.files||[]){const e=l.split("/").pop()||l,n={id:l,name:e,type:"file",path:l,size:t.fileSizes[l]||0,description:this.getFileDescription(e)};null==(i=o.children)||i.push(n)}return o}getFolderDescription(e){return{decks:"牌组数据存储区",learning:"学习记录和进度",profile:"用户配置和设置",templates:"模板定义文件",backups:"自动备份文件",media:"媒体文件存储"}[e]||""}getFileDescription(e){var t;const n=null==(t=e.split(".").pop())?void 0:t.toLowerCase();return"decks.json"===e?"牌组数据文件":"cards.json"===e?"卡片数据文件":"settings.json"===e?"设置配置文件":"profile.json"===e?"用户配置文件":"templates.json"===e?"模板定义文件":n?{json:"JSON数据文件",md:"Markdown文档",txt:"文本文件",png:"PNG图片文件",jpg:"JPEG图片文件",jpeg:"JPEG图片文件",gif:"GIF动画文件",mp3:"MP3音频文件",mp4:"MP4视频文件"}[n]||`${n.toUpperCase()}文件`:"未知文件类型"}countNodesRecursively(e){let t=0,n=0;if("file"===e.type)t=1;else{n=1;for(const i of e.children||[]){const e=this.countNodesRecursively(i);t+=e.files,n+=e.folders}}return{files:t,folders:n}}async calculateSizeRecursively(e,t,n,i){try{const r=await i.list(e);let s=0;for(const e of r.files||[])try{const t=await i.stat(e),a=(null==t?void 0:t.size)||0;n[e]=a,s+=a}catch(a){_e.warn(`无法获取文件大小: ${e}`,a)}for(const e of r.folders||[]){s+=await this.calculateSizeRecursively(e,t,n,i)}return t[e]=s,s}catch(a){return _e.warn(`无法计算文件夹大小: ${e}`,a),0}}async collectExportData(e){var t,n,i;const a={};for(const s of e.dataTypes)switch(s){case Uo.DECKS:a.decks=await this.dataStorage.getDecks();break;case Uo.CARDS:a.cards=await this.dataStorage.getCards();break;case Uo.SESSIONS:try{a.sessions=await(null==(n=(t=this.dataStorage).getStudySessions)?void 0:n.call(t))||[]}catch(r){a.sessions=[]}break;case Uo.PROFILE:try{a.profile=await this.dataStorage.getUserProfile()}catch(r){a.profile=null}break;case Uo.TEMPLATES:a.templates={fieldTemplates:(null==(i=this.plugin.settings)?void 0:i.fieldTemplates)||[]}}return a}generateExportFileName(e){return`tuanki-export-${(new Date).toISOString().replace(/[:.]/g,"-")}.${e}`}async writeExportFile(e,t,n){const i=this.plugin.app.vault.adapter;let a;switch(n.format){case"json":a=JSON.stringify(e,null,2);break;case"csv":a=this.convertToCSV(e);break;default:throw new Error(`不支持的导出格式: ${n.format}`)}const r="tuanki/exports";try{await i.exists(r)||await this.plugin.app.vault.createFolder(r)}catch(o){_e.warn("[DataManagement] 创建导出文件夹失败，使用vault根目录:",o)}let s=`${r}/${t}`;try{await i.write(s,a),_e.debug(`[DataManagement] 导出文件已保存到: ${s}`)}catch(o){_e.warn("[DataManagement] 在插件文件夹中创建导出文件失败，尝试根目录:",o),s=t,await i.write(s,a),_e.debug(`[DataManagement] 导出文件已保存到根目录: ${s}`)}return s}convertToCSV(e){return JSON.stringify(e)}countExportRecords(e){let t=0;return e.decks&&(t+=e.decks.length),e.cards&&(t+=e.cards.length),e.sessions&&(t+=e.sessions.length),t}async readImportFile(e){return new Promise((t,n)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>n(new Error("文件读取失败")),i.readAsText(e)})}async parseImportData(e,t){try{if(t.endsWith(".json"))return JSON.parse(e);throw new Error(`不支持的文件格式: ${t}`)}catch(n){throw new Error(`文件解析失败: ${n instanceof Error?n.message:String(n)}`)}}async validateImportData(e){if(!e||"object"!=typeof e)throw new Error("导入数据格式无效")}async executeImport(e,t){let n=0;return e.decks&&(n+=e.decks.length),e.cards&&(n+=e.cards.length),{imported:n,skipped:0,conflicts:0,conflictDetails:[]}}detectDataTypes(e){const t=[];return e.decks&&t.push(Uo.DECKS),e.cards&&t.push(Uo.CARDS),e.sessions&&t.push(Uo.SESSIONS),e.profile&&t.push(Uo.PROFILE),e.templates&&t.push(Uo.TEMPLATES),t}async executeReset(){_e.debug("执行数据重置...")}extractBackupId(e){return e||(new Date).toISOString()}}class qo{constructor(e,t){oe(this,"dataStorage"),oe(this,"plugin"),oe(this,"MAX_BACKUPS",3),this.dataStorage=e,this.plugin=t}async createManualBackup(e){const t=Date.now();try{const n=await this.dataStorage.createBackup(),i=await this.createBackupInfo(n,Bo.MANUAL,jo.MANUAL_REQUEST,e),a=await this.pruneBackups();return{success:!0,timestamp:(new Date).toISOString(),duration:Date.now()-t,backupInfo:i,backupPath:n,prunedCount:a.beforeCount-a.afterCount}}catch(n){return _e.error("手动备份失败:",n),{success:!1,error:n instanceof Error?n.message:String(n),timestamp:(new Date).toISOString(),duration:Date.now()-t}}}async pruneBackups(){const e=Date.now();try{const n=await this.getBackupHistory(),i=n.length;if(i<=this.MAX_BACKUPS)return{success:!0,timestamp:(new Date).toISOString(),duration:Date.now()-e,beforeCount:i,afterCount:i,prunedBackups:[],retainedBackups:n.map(e=>e.id)};const a=this.selectBackupsToRetain(n),r=n.filter(e=>!a.some(t=>t.id===e.id)),s=[];for(const e of r)try{await this.deleteBackupFiles(e),s.push(e.id)}catch(t){_e.warn(`删除备份失败: ${e.id}`,t)}return{success:!0,timestamp:(new Date).toISOString(),duration:Date.now()-e,beforeCount:i,afterCount:i-s.length,prunedBackups:s,retainedBackups:a.map(e=>e.id)}}catch(t){return _e.error("备份清理失败:",t),{success:!1,error:t instanceof Error?t.message:String(t),timestamp:(new Date).toISOString(),duration:Date.now()-e,beforeCount:0,afterCount:0,prunedBackups:[],retainedBackups:[]}}}async validateBackupIntegrity(e){const t=Date.now();try{const i=await this.getBackupById(e);if(!i)throw new Error(`备份不存在: ${e}`);const a=[];let r=0;const s=this.plugin.app.vault.adapter;if(await s.exists(i.path)){r++;const e=await s.list(i.path),t=["decks.json","cards.json","settings.json"];for(const o of t){const t=`${i.path}/${o}`;if((e.files||[]).includes(t)){r++;try{const e=await s.read(t);JSON.parse(e)}catch(n){a.push({id:`corrupted_${o}`,type:"corrupted_data",description:`备份文件损坏: ${o}`,severity:"error"})}}else a.push({id:`missing_${o}`,type:"missing_file",description:`缺少备份文件: ${o}`,severity:"error"})}}else a.push({id:"missing_backup_folder",type:"missing_file",description:`备份文件夹不存在: ${i.path}`,severity:"critical"});return{success:0===a.filter(e=>"critical"===e.severity).length,timestamp:(new Date).toISOString(),duration:Date.now()-t,validatedCount:r,issueCount:a.length,issues:a}}catch(i){return _e.error("备份验证失败:",i),{success:!1,error:i instanceof Error?i.message:String(i),timestamp:(new Date).toISOString(),duration:Date.now()-t,validatedCount:0,issueCount:1,issues:[{id:"validation_error",type:"corrupted_data",description:i instanceof Error?i.message:String(i),severity:"critical"}]}}}async previewBackupContent(e){try{const t=await this.getBackupById(e);if(!t)throw new Error(`备份不存在: ${e}`);const n=this.plugin.app.vault.adapter,i=(await n.list(t.path)).files||[];return{backupInfo:t,files:i,statistics:await this.calculateBackupStatistics(t.path)}}catch(t){throw _e.error("预览备份内容失败:",t),new Error(`预览备份内容失败: ${t instanceof Error?t.message:String(t)}`)}}async restoreFromBackup(e,t){var n,i;const a=Date.now();try{const r=await this.getBackupById(e);if(!r)throw new Error(`备份不存在: ${e}`);const s=await this.validateBackupIntegrity(e);if(!s.success){const e=null==(n=s.issues)?void 0:n[0],t="string"==typeof e?e:null==e?void 0:e.description;throw new Error(`备份验证失败: ${t}`)}let o;if(t.createPreRestoreBackup){o=null==(i=(await this.createManualBackup("恢复前自动备份")).backupInfo)?void 0:i.id}const l=await this.executeRestore(r,t);return{success:!0,timestamp:(new Date).toISOString(),duration:Date.now()-a,restoredFileCount:l.fileCount,restoredDataTypes:l.dataTypes,preRestoreBackupId:o}}catch(r){return _e.error("备份恢复失败:",r),{success:!1,error:r instanceof Error?r.message:String(r),timestamp:(new Date).toISOString(),duration:Date.now()-a,restoredFileCount:0,restoredDataTypes:[]}}}async getBackupHistory(){try{const t=gs(),n=this.plugin.app.vault.adapter;if(!(await n.exists(t)))return _e.debug(`[getBackupHistory] 备份文件夹不存在: ${t}`),[];const i=(await n.list(t)).folders||[],a=[];for(const r of i)try{const e=await this.loadBackupInfo(r);e&&a.push(e)}catch(e){_e.warn(`加载备份信息失败: ${r}`,e)}return a.sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())}catch(e){return _e.error("获取备份历史失败:",e),[]}}getDataFolderPath(){var e;null==(e=this.plugin.settings)||e.currentDataSource;return vs().root}shouldCreateAutoBackup(e){switch(e){case jo.STARTUP:return this.shouldCreateStartupBackup();case jo.CARD_COUNT_THRESHOLD:return this.shouldCreateThresholdBackup();default:return!0}}shouldCreateStartupBackup(){var e;const t=null==(e=this.plugin.settings)?void 0:e.lastStartupBackup;if(!t)return!0;const n=new Date(t).getTime();return Date.now()-n>864e5}shouldCreateThresholdBackup(){var e,t,n;const i=(null==(e=this.plugin.settings)?void 0:e.lastBackupCardCount)||0,a=(null==(n=null==(t=this.plugin.dataStorage)?void 0:t.getCards())?void 0:n.length)||0;return Math.abs(a-i)>=100}async createBackupInfo(e,t,n,i){const a=this.plugin.app.vault.adapter,r=(new Date).toISOString(),s=this.generateBackupId(r);let o=0;try{const t=await a.list(e);for(const e of t.files||[]){const t=await a.stat(e);o+=(null==t?void 0:t.size)||0}}catch(c){_e.warn("计算备份大小失败:",c)}const l={id:s,timestamp:r,type:t,size:o,description:i,trigger:n,path:e,isValid:!0,dataTypes:[Uo.DECKS,Uo.CARDS,Uo.SESSIONS,Uo.PROFILE]};return await this.saveBackupInfo(l),l}generateBackupId(e){return e.replace(/[:.]/g,"-")}async saveBackupInfo(e){try{const t=this.plugin.app.vault.adapter,n=`${e.path}/.backup-info.json`;await t.write(n,JSON.stringify(e,null,2))}catch(t){_e.warn("保存备份信息失败:",t)}}async loadBackupInfo(e){try{const t=this.plugin.app.vault.adapter,n=`${e}/.backup-info.json`;if(!(await t.exists(n)))return this.inferBackupInfo(e);const i=await t.read(n);return JSON.parse(i)}catch(t){return _e.warn(`加载备份信息失败: ${e}`,t),null}}inferBackupInfo(e){const t=e.split("/").pop()||"";let n=t;if(t.includes("T")){const e=t.split("T");if(2===e.length){const t=e[0],i=e[1].split("-");if(i.length>=3){n=`${t}T${i[0]}:${i[1]}:${i.slice(2).join("-").replace("-",".")}`}}}return{id:t,timestamp:n,type:Bo.AUTO,size:0,path:e,isValid:!0,dataTypes:[Uo.DECKS,Uo.CARDS]}}selectBackupsToRetain(e){const t=[...e].sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime()),n=[];t.length>0&&n.push(t[0]);const i=t.find(e=>e.type===Bo.MANUAL&&!n.includes(e));i&&n.push(i);const a=t.find(e=>e.type===Bo.PRE_OPERATION&&!n.includes(e));for(a&&n.push(a);n.length<this.MAX_BACKUPS&&n.length<t.length;){const e=t.find(e=>!n.includes(e));if(!e)break;n.push(e)}return n.slice(0,this.MAX_BACKUPS)}async deleteBackupFiles(e){try{const t=this.plugin.app.vault.adapter;await t.exists(e.path)&&await this.deleteRecursively(e.path,t)}catch(t){throw _e.error(`删除备份文件失败: ${e.id}`,t),t}}async deleteRecursively(e,t){const n=await t.list(e);for(const i of n.files||[])await t.remove(i);for(const i of n.folders||[])await this.deleteRecursively(i,t);await t.rmdir(e)}async getBackupById(e){return(await this.getBackupHistory()).find(t=>t.id===e)||null}async calculateBackupStatistics(e){try{const n=this.plugin.app.vault.adapter,i={deckCount:0,cardCount:0,sessionCount:0,templateCount:0};try{const t=await n.read(`${e}/decks.json`),a=JSON.parse(t);i.deckCount=Array.isArray(a)?a.length:0}catch(t){}try{const t=await n.read(`${e}/cards.json`),a=JSON.parse(t);i.cardCount=Array.isArray(a)?a.length:0}catch(t){}return i}catch(n){return _e.warn("计算备份统计失败:",n),{deckCount:0,cardCount:0,sessionCount:0,templateCount:0}}}async executeRestore(e,t){const n=this.plugin.app.vault.adapter,i=this.getDataFolderPath();let a=0;const r=[];for(const o of t.dataTypes)try{switch(o){case Uo.DECKS:await this.restoreDataFile(e.path,i,"decks.json",n),r.push(Uo.DECKS),a++;break;case Uo.CARDS:await this.restoreDataFile(e.path,i,"cards.json",n),r.push(Uo.CARDS),a++;break;case Uo.SESSIONS:await this.restoreDataFile(e.path,i,"sessions.json",n),r.push(Uo.SESSIONS),a++}}catch(s){_e.warn(`恢复数据类型失败: ${o}`,s)}return{fileCount:a,dataTypes:r}}async restoreDataFile(e,t,n,i){const a=`${e}/${n}`,r=`${t}/${n}`;if(await i.exists(a)){const e=await i.read(a);await i.write(r,e)}}}class Ho{constructor(e){this.dataStorage=e}async createTemplate(e){return this.dataStorage.createTemplate(e)}async updateTemplate(e,t){return this.dataStorage.updateTemplate(e,t)}async deleteTemplate(e){return this.dataStorage.deleteTemplate(e)}async getTemplate(e){return this.dataStorage.getTemplate(e)}async getTemplates(){return this.dataStorage.getTemplates()}}function Wo(){_e.debug("🔧 开始注册核心服务..."),qs({token:Bs.STATE_MANAGER,factory:()=>Js.getInstance(),lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.INFRASTRUCTURE_SERVICE}),qs({token:Bs.ERROR_HANDLER,factory:()=>Po.getInstance(),lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.INFRASTRUCTURE_SERVICE}),qs({token:Bs.PERFORMANCE_MONITOR,factory:()=>No.getInstance(),lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.INFRASTRUCTURE_SERVICE}),qs({token:Bs.DATA_STORAGE,factory:()=>{const e=window.tuankiPlugin;if(!(null==e?void 0:e.dataStorage))throw new Error("DataStorage not initialized. Please ensure plugin is loaded first.");return e.dataStorage},lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.DATA_REPOSITORY}),qs({token:Bs.ANALYTICS_SERVICE,factory:()=>{const e=window.tuankiPlugin;if(!(null==e?void 0:e.analyticsService))throw new Error("AnalyticsService not initialized. Please ensure plugin is loaded first.");return e.analyticsService},lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.INFRASTRUCTURE_SERVICE}),qs({token:Bs.FSRS_SERVICE,factory:()=>{const e=window.tuankiPlugin;if(!(null==e?void 0:e.fsrs))throw new Error("FSRS not initialized. Please ensure plugin is loaded first.");return e.fsrs},lifetime:Ls.SINGLETON,layer:Ws.DOMAIN,type:Gs.DOMAIN_SERVICE}),qs({token:Bs.ENHANCED_FSRS,factory:()=>{const e=window.tuankiPlugin;if(!(null==e?void 0:e.enhancedFSRS))throw new Error("EnhancedFSRS not initialized. Please ensure plugin is loaded first.");return e.enhancedFSRS},lifetime:Ls.SINGLETON,layer:Ws.DOMAIN,type:Gs.DOMAIN_SERVICE}),qs({token:Bs.CARD_SERVICE,factory:e=>{const t=e.resolve(Bs.DATA_STORAGE),n=e.resolve(Bs.FSRS_SERVICE);return new Go(t,n)},lifetime:Ls.SINGLETON,layer:Ws.APPLICATION,type:Gs.APPLICATION_SERVICE,dependencies:[Bs.DATA_STORAGE,Bs.FSRS_SERVICE]}),qs({token:Bs.DECK_SERVICE,factory:e=>{const t=e.resolve(Bs.DATA_STORAGE);return new Qo(t)},lifetime:Ls.SINGLETON,layer:Ws.APPLICATION,type:Gs.APPLICATION_SERVICE,dependencies:[Bs.DATA_STORAGE]}),qs({token:Bs.TEMPLATE_SERVICE,factory:e=>{const t=e.resolve(Bs.DATA_STORAGE);return new Ho(t)},lifetime:Ls.SINGLETON,layer:Ws.APPLICATION,type:Gs.APPLICATION_SERVICE,dependencies:[Bs.DATA_STORAGE]}),qs({token:Bs.SYNC_SERVICE,factory:e=>{const t=e.resolve(Bs.DATA_STORAGE),n=e.resolve(Bs.ERROR_HANDLER);return new Ko(t,n)},lifetime:Ls.SINGLETON,layer:Ws.APPLICATION,type:Gs.APPLICATION_SERVICE,dependencies:[Bs.DATA_STORAGE,Bs.ERROR_HANDLER]}),qs({token:Bs.DATA_MANAGEMENT_SERVICE,factory:e=>{var t,n;const i=e.resolve(Bs.DATA_STORAGE);let a=window.tuankiPlugin;if(!a){const e=window.app;(null==(n=null==(t=null==e?void 0:e.plugins)?void 0:t.plugins)?void 0:n.tuanki)&&(a=e.plugins.plugins.tuanki)}return a||(_e.warn("Plugin instance not found, creating mock service"),a={settings:{dataFolder:"tuanki",dataBackupIntervalHours:24,backupRetentionCount:3,autoBackup:!0},app:{vault:{adapter:{exists:async()=>!1,list:async()=>({files:[],folders:[]}),stat:async()=>({size:0}),read:async()=>"{}",write:async()=>{}}}}}),new Vo(i,a)},lifetime:Ls.SINGLETON,layer:Ws.APPLICATION,type:Gs.APPLICATION_SERVICE,dependencies:[Bs.DATA_STORAGE]}),qs({token:Bs.BACKUP_MANAGEMENT_SERVICE,factory:e=>{var t,n;const i=e.resolve(Bs.DATA_STORAGE);let a=window.tuankiPlugin;if(!a){const e=window.app;(null==(n=null==(t=null==e?void 0:e.plugins)?void 0:t.plugins)?void 0:n.tuanki)&&(a=e.plugins.plugins.tuanki)}return a||(_e.warn("Plugin instance not found for backup service, creating mock service"),a={settings:{dataFolder:"tuanki",dataBackupIntervalHours:24,backupRetentionCount:3,autoBackup:!0},app:{vault:{adapter:{exists:async()=>!1,list:async()=>({files:[],folders:[]}),stat:async()=>({size:0}),read:async()=>"{}",write:async()=>{}}}}}),new qo(i,a)},lifetime:Ls.SINGLETON,layer:Ws.APPLICATION,type:Gs.APPLICATION_SERVICE,dependencies:[Bs.DATA_STORAGE]}),qs({token:Bs.LICENSE_MANAGER,factory:async()=>{const{LicenseManager:e}=await Promise.resolve().then(()=>zs);return new e},lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.INFRASTRUCTURE_SERVICE}),qs({token:Bs.NOTIFICATION_SERVICE,factory:e=>{const t=e.resolve(Bs.STATE_MANAGER);return new Zo(t)},lifetime:Ls.SINGLETON,layer:Ws.PRESENTATION,type:Gs.VIEW_COMPONENT,dependencies:[Bs.STATE_MANAGER]}),qs({token:Bs.MODAL_SERVICE,factory:e=>{const t=e.resolve(Bs.STATE_MANAGER);return new Yo(t)},lifetime:Ls.SINGLETON,layer:Ws.PRESENTATION,type:Gs.VIEW_COMPONENT,dependencies:[Bs.STATE_MANAGER]}),_e.debug("✅ 核心服务注册完成")}class Go{constructor(e,t){this.dataStorage=e,this.fsrs=t}async createCard(e){return this.dataStorage.createCard(e)}async updateCard(e,t){return this.dataStorage.updateCard(e,t)}async deleteCard(e){return this.dataStorage.deleteCard(e)}async getCard(e){return this.dataStorage.getCard(e)}async scheduleCard(e,t){const n=await this.getCard(e),i=this.fsrs.schedule(n,t);return this.updateCard(e,i)}}class Qo{constructor(e){this.dataStorage=e}async createDeck(e){return this.dataStorage.createDeck(e)}async updateDeck(e,t){return this.dataStorage.updateDeck(e,t)}async deleteDeck(e){return this.dataStorage.deleteDeck(e)}async getDeck(e){return this.dataStorage.getDeck(e)}async getDecks(){return this.dataStorage.getDecks()}}class Ko{constructor(e,t){this.dataStorage=e,this.errorHandler=t}async syncToAnki(){try{return!0}catch(e){return await this.errorHandler.handleError(e,{component:"SyncService",operation:"syncToAnki"}),!1}}async syncFromAnki(){try{return!0}catch(e){return await this.errorHandler.handleError(e,{component:"SyncService",operation:"syncFromAnki"}),!1}}}class Zo{constructor(e){this.stateManager=e}showNotification(e,t="info",n=3e3){this.stateManager.dispatch({type:"ui/ADD_NOTIFICATION",payload:{id:`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:t,message:e,duration:n,timestamp:Date.now()},timestamp:Date.now(),source:"NotificationService"})}showSuccess(e,t=3e3){this.showNotification(e,"success",t)}showError(e,t=5e3){this.showNotification(e,"error",t)}showWarning(e,t=4e3){this.showNotification(e,"warning",t)}showInfo(e,t=3e3){this.showNotification(e,"info",t)}}class Yo{constructor(e){this.stateManager=e}openModal(e,t){this.stateManager.dispatch({type:"ui/SET_ACTIVE_MODAL",payload:{modalId:e,props:t},timestamp:Date.now(),source:"ModalService"})}closeModal(){this.stateManager.dispatch({type:"ui/SET_ACTIVE_MODAL",payload:null,timestamp:Date.now(),source:"ModalService"})}}var Xo=(e=>(e.IDLE="idle",e.DETECTING="detecting",e.PROCESSING="processing",e.SYNCING="syncing",e.COMPLETED="completed",e.ERROR="error",e))(Xo||{}),Jo=(e=>(e.PARSE_ERROR="parse_error",e.DUPLICATE_UUID="duplicate_uuid",e.INVALID_FORMAT="invalid_format",e.DECK_NOT_FOUND="deck_not_found",e.TEMPLATE_NOT_FOUND="template_not_found",e.FILE_WRITE_ERROR="file_write_error",e.CARD_CREATION_ERROR="card_creation_error",e))(Jo||{}),el=(e=>(e.ANNOTATION_DETECTED="annotation_detected",e.ANNOTATION_PROCESSED="annotation_processed",e.CARD_CREATED="card_created",e.DOCUMENT_MODIFIED="document_modified",e.ERROR_OCCURRED="error_occurred",e.BATCH_COMPLETED="batch_completed",e))(el||{});let tl=[],nl=[];function il(e){if(e<768)return!1;for(let t=0,n=tl.length;;){let i=t+n>>1;if(e<tl[i])n=i;else{if(!(e>=nl[i]))return!0;t=i+1}if(t==n)return!1}}function al(e){return e>=127462&&e<=127487}(()=>{let e="lc,34,7n,7,7b,19,,,,2,,2,,,20,b,1c,l,g,,2t,7,2,6,2,2,,4,z,,u,r,2j,b,1m,9,9,,o,4,,9,,3,,5,17,3,3b,f,,w,1j,,,,4,8,4,,3,7,a,2,t,,1m,,,,2,4,8,,9,,a,2,q,,2,2,1l,,4,2,4,2,2,3,3,,u,2,3,,b,2,1l,,4,5,,2,4,,k,2,m,6,,,1m,,,2,,4,8,,7,3,a,2,u,,1n,,,,c,,9,,14,,3,,1l,3,5,3,,4,7,2,b,2,t,,1m,,2,,2,,3,,5,2,7,2,b,2,s,2,1l,2,,,2,4,8,,9,,a,2,t,,20,,4,,2,3,,,8,,29,,2,7,c,8,2q,,2,9,b,6,22,2,r,,,,,,1j,e,,5,,2,5,b,,10,9,,2u,4,,6,,2,2,2,p,2,4,3,g,4,d,,2,2,6,,f,,jj,3,qa,3,t,3,t,2,u,2,1s,2,,7,8,,2,b,9,,19,3,3b,2,y,,3a,3,4,2,9,,6,3,63,2,2,,1m,,,7,,,,,2,8,6,a,2,,1c,h,1r,4,1c,7,,,5,,14,9,c,2,w,4,2,2,,3,1k,,,2,3,,,3,1m,8,2,2,48,3,,d,,7,4,,6,,3,2,5i,1m,,5,ek,,5f,x,2da,3,3x,,2o,w,fe,6,2x,2,n9w,4,,a,w,2,28,2,7k,,3,,4,,p,2,5,,47,2,q,i,d,,12,8,p,b,1a,3,1c,,2,4,2,2,13,,1v,6,2,2,2,2,c,,8,,1b,,1f,,,3,2,2,5,2,,,16,2,8,,6m,,2,,4,,fn4,,kh,g,g,g,a6,2,gt,,6a,,45,5,1ae,3,,2,5,4,14,3,4,,4l,2,fx,4,ar,2,49,b,4w,,1i,f,1k,3,1d,4,2,2,1x,3,10,5,,8,1q,,c,2,1g,9,a,4,2,,2n,3,2,,,2,6,,4g,,3,8,l,2,1l,2,,,,,m,,e,7,3,5,5f,8,2,3,,,n,,29,,2,6,,,2,,,2,,2,6j,,2,4,6,2,,2,r,2,2d,8,2,,,2,2y,,,,2,6,,,2t,3,2,4,,5,77,9,,2,6t,,a,2,,,4,,40,4,2,2,4,,w,a,14,6,2,4,8,,9,6,2,3,1a,d,,2,ba,7,,6,,,2a,m,2,7,,2,,2,3e,6,3,,,2,,7,,,20,2,3,,,,9n,2,f0b,5,1n,7,t4,,1r,4,29,,f5k,2,43q,,,3,4,5,8,8,2,7,u,4,44,3,1iz,1j,4,1e,8,,e,,m,5,,f,11s,7,,h,2,7,,2,,5,79,7,c5,4,15s,7,31,7,240,5,gx7k,2o,3k,6o".split(",").map(e=>e?parseInt(e,36):1);for(let t=0,n=0;t<e.length;t++)(t%2?nl:tl).push(n+=e[t])})();function rl(e,t,n=!0,i=!0){return(n?sl:ol)(e,t,i)}function sl(e,t,n){if(t==e.length)return t;t&&cl(e.charCodeAt(t))&&dl(e.charCodeAt(t-1))&&t--;let i=ll(e,t);for(t+=ul(i);t<e.length;){let a=ll(e,t);if(8205==i||8205==a||n&&il(a))t+=ul(a),i=a;else{if(!al(a))break;{let n=0,i=t-2;for(;i>=0&&al(ll(e,i));)n++,i-=2;if(n%2==0)break;t+=2}}}return t}function ol(e,t,n){for(;t>0;){let i=sl(e,t-2,n);if(i<t)return i;t--}return 0}function ll(e,t){let n=e.charCodeAt(t);if(!dl(n)||t+1==e.length)return n;let i=e.charCodeAt(t+1);return cl(i)?i-56320+(n-55296<<10)+65536:n}function cl(e){return e>=56320&&e<57344}function dl(e){return e>=55296&&e<56320}function ul(e){return e<65536?1:2}let hl=class e{lineAt(e){if(e<0||e>this.length)throw new RangeError(`Invalid position ${e} in document of length ${this.length}`);return this.lineInner(e,!1,1,0)}line(e){if(e<1||e>this.lines)throw new RangeError(`Invalid line number ${e} in ${this.lines}-line document`);return this.lineInner(e,!0,1,0)}replace(e,t,n){[e,t]=kl(this,e,t);let i=[];return this.decompose(0,e,i,2),n.length&&n.decompose(0,n.length,i,3),this.decompose(t,this.length,i,1),gl.from(i,this.length-(t-e)+n.length)}append(e){return this.replace(this.length,this.length,e)}slice(e,t=this.length){[e,t]=kl(this,e,t);let n=[];return this.decompose(e,t,n,0),gl.from(n,t-e)}eq(e){if(e==this)return!0;if(e.length!=this.length||e.lines!=this.lines)return!1;let t=this.scanIdentical(e,1),n=this.length-this.scanIdentical(e,-1),i=new ml(this),a=new ml(e);for(let r=t,s=t;;){if(i.next(r),a.next(r),r=0,i.lineBreak!=a.lineBreak||i.done!=a.done||i.value!=a.value)return!1;if(s+=i.value.length,i.done||s>=n)return!0}}iter(e=1){return new ml(this,e)}iterRange(e,t=this.length){return new yl(this,e,t)}iterLines(e,t){let n;if(null==e)n=this.iter();else{null==t&&(t=this.lines+1);let i=this.line(e).from;n=this.iterRange(i,Math.max(i,t==this.lines+1?this.length:t<=1?0:this.line(t-1).to))}return new bl(n)}toString(){return this.sliceString(0)}toJSON(){let e=[];return this.flatten(e),e}constructor(){}static of(t){if(0==t.length)throw new RangeError("A document must have at least one line");return 1!=t.length||t[0]?t.length<=32?new pl(t):gl.from(pl.split(t,[])):e.empty}};class pl extends hl{constructor(e,t=function(e){let t=-1;for(let n of e)t+=n.length+1;return t}(e)){super(),this.text=e,this.length=t}get lines(){return this.text.length}get children(){return null}lineInner(e,t,n,i){for(let a=0;;a++){let r=this.text[a],s=i+r.length;if((t?n:s)>=e)return new wl(i,s,n,r);i=s+1,n++}}decompose(e,t,n,i){let a=e<=0&&t>=this.length?this:new pl(fl(this.text,e,t),Math.min(t,this.length)-Math.max(0,e));if(1&i){let e=n.pop(),t=vl(a.text,e.text.slice(),0,a.length);if(t.length<=32)n.push(new pl(t,e.length+a.length));else{let e=t.length>>1;n.push(new pl(t.slice(0,e)),new pl(t.slice(e)))}}else n.push(a)}replace(e,t,n){if(!(n instanceof pl))return super.replace(e,t,n);[e,t]=kl(this,e,t);let i=vl(this.text,vl(n.text,fl(this.text,0,e)),t),a=this.length+n.length-(t-e);return i.length<=32?new pl(i,a):gl.from(pl.split(i,[]),a)}sliceString(e,t=this.length,n="\n"){[e,t]=kl(this,e,t);let i="";for(let a=0,r=0;a<=t&&r<this.text.length;r++){let s=this.text[r],o=a+s.length;a>e&&r&&(i+=n),e<o&&t>a&&(i+=s.slice(Math.max(0,e-a),t-a)),a=o+1}return i}flatten(e){for(let t of this.text)e.push(t)}scanIdentical(){return 0}static split(e,t){let n=[],i=-1;for(let a of e)n.push(a),i+=a.length+1,32==n.length&&(t.push(new pl(n,i)),n=[],i=-1);return i>-1&&t.push(new pl(n,i)),t}}class gl extends hl{constructor(e,t){super(),this.children=e,this.length=t,this.lines=0;for(let n of e)this.lines+=n.lines}lineInner(e,t,n,i){for(let a=0;;a++){let r=this.children[a],s=i+r.length,o=n+r.lines-1;if((t?o:s)>=e)return r.lineInner(e,t,n,i);i=s+1,n=o+1}}decompose(e,t,n,i){for(let a=0,r=0;r<=t&&a<this.children.length;a++){let s=this.children[a],o=r+s.length;if(e<=o&&t>=r){let a=i&((r<=e?1:0)|(o>=t?2:0));r>=e&&o<=t&&!a?n.push(s):s.decompose(e-r,t-r,n,a)}r=o+1}}replace(e,t,n){if([e,t]=kl(this,e,t),n.lines<this.lines)for(let i=0,a=0;i<this.children.length;i++){let r=this.children[i],s=a+r.length;if(e>=a&&t<=s){let o=r.replace(e-a,t-a,n),l=this.lines-r.lines+o.lines;if(o.lines<l>>4&&o.lines>l>>6){let a=this.children.slice();return a[i]=o,new gl(a,this.length-(t-e)+n.length)}return super.replace(a,s,o)}a=s+1}return super.replace(e,t,n)}sliceString(e,t=this.length,n="\n"){[e,t]=kl(this,e,t);let i="";for(let a=0,r=0;a<this.children.length&&r<=t;a++){let s=this.children[a],o=r+s.length;r>e&&a&&(i+=n),e<o&&t>r&&(i+=s.sliceString(e-r,t-r,n)),r=o+1}return i}flatten(e){for(let t of this.children)t.flatten(e)}scanIdentical(e,t){if(!(e instanceof gl))return 0;let n=0,[i,a,r,s]=t>0?[0,0,this.children.length,e.children.length]:[this.children.length-1,e.children.length-1,-1,-1];for(;;i+=t,a+=t){if(i==r||a==s)return n;let o=this.children[i],l=e.children[a];if(o!=l)return n+o.scanIdentical(l,t);n+=o.length+1}}static from(e,t=e.reduce((e,t)=>e+t.length+1,-1)){let n=0;for(let h of e)n+=h.lines;if(n<32){let n=[];for(let t of e)t.flatten(n);return new pl(n,t)}let i=Math.max(32,n>>5),a=i<<1,r=i>>1,s=[],o=0,l=-1,c=[];function d(e){let t;if(e.lines>a&&e instanceof gl)for(let n of e.children)d(n);else e.lines>r&&(o>r||!o)?(u(),s.push(e)):e instanceof pl&&o&&(t=c[c.length-1])instanceof pl&&e.lines+t.lines<=32?(o+=e.lines,l+=e.length+1,c[c.length-1]=new pl(t.text.concat(e.text),t.length+1+e.length)):(o+e.lines>i&&u(),o+=e.lines,l+=e.length+1,c.push(e))}function u(){0!=o&&(s.push(1==c.length?c[0]:gl.from(c,l)),l=-1,o=c.length=0)}for(let h of e)d(h);return u(),1==s.length?s[0]:new gl(s,t)}}function vl(e,t,n=0,i=1e9){for(let a=0,r=0,s=!0;r<e.length&&a<=i;r++){let o=e[r],l=a+o.length;l>=n&&(l>i&&(o=o.slice(0,i-a)),a<n&&(o=o.slice(n-a)),s?(t[t.length-1]+=o,s=!1):t.push(o)),a=l+1}return t}function fl(e,t,n){return vl(e,[""],t,n)}hl.empty=new pl([""],0);class ml{constructor(e,t=1){this.dir=t,this.done=!1,this.lineBreak=!1,this.value="",this.nodes=[e],this.offsets=[t>0?1:(e instanceof pl?e.text.length:e.children.length)<<1]}nextInner(e,t){for(this.done=this.lineBreak=!1;;){let n=this.nodes.length-1,i=this.nodes[n],a=this.offsets[n],r=a>>1,s=i instanceof pl?i.text.length:i.children.length;if(r==(t>0?s:0)){if(0==n)return this.done=!0,this.value="",this;t>0&&this.offsets[n-1]++,this.nodes.pop(),this.offsets.pop()}else if((1&a)==(t>0?0:1)){if(this.offsets[n]+=t,0==e)return this.lineBreak=!0,this.value="\n",this;e--}else if(i instanceof pl){let a=i.text[r+(t<0?-1:0)];if(this.offsets[n]+=t,a.length>Math.max(0,e))return this.value=0==e?a:t>0?a.slice(e):a.slice(0,a.length-e),this;e-=a.length}else{let a=i.children[r+(t<0?-1:0)];e>a.length?(e-=a.length,this.offsets[n]+=t):(t<0&&this.offsets[n]--,this.nodes.push(a),this.offsets.push(t>0?1:(a instanceof pl?a.text.length:a.children.length)<<1))}}}next(e=0){return e<0&&(this.nextInner(-e,-this.dir),e=this.value.length),this.nextInner(e,this.dir)}}class yl{constructor(e,t,n){this.value="",this.done=!1,this.cursor=new ml(e,t>n?-1:1),this.pos=t>n?e.length:0,this.from=Math.min(t,n),this.to=Math.max(t,n)}nextInner(e,t){if(t<0?this.pos<=this.from:this.pos>=this.to)return this.value="",this.done=!0,this;e+=Math.max(0,t<0?this.pos-this.to:this.from-this.pos);let n=t<0?this.pos-this.from:this.to-this.pos;e>n&&(e=n),n-=e;let{value:i}=this.cursor.next(e);return this.pos+=(i.length+e)*t,this.value=i.length<=n?i:t<0?i.slice(i.length-n):i.slice(0,n),this.done=!this.value,this}next(e=0){return e<0?e=Math.max(e,this.from-this.pos):e>0&&(e=Math.min(e,this.to-this.pos)),this.nextInner(e,this.cursor.dir)}get lineBreak(){return this.cursor.lineBreak&&""!=this.value}}class bl{constructor(e){this.inner=e,this.afterBreak=!0,this.value="",this.done=!1}next(e=0){let{done:t,lineBreak:n,value:i}=this.inner.next(e);return t&&this.afterBreak?(this.value="",this.afterBreak=!1):t?(this.done=!0,this.value=""):n?this.afterBreak?this.value="":(this.afterBreak=!0,this.next()):(this.value=i,this.afterBreak=!1),this}get lineBreak(){return!1}}"undefined"!=typeof Symbol&&(hl.prototype[Symbol.iterator]=function(){return this.iter()},ml.prototype[Symbol.iterator]=yl.prototype[Symbol.iterator]=bl.prototype[Symbol.iterator]=function(){return this});let wl=class{constructor(e,t,n,i){this.from=e,this.to=t,this.number=n,this.text=i}get length(){return this.to-this.from}};function kl(e,t,n){return[t=Math.max(0,Math.min(e.length,t)),Math.max(t,Math.min(e.length,n))]}function Sl(e,t,n=!0,i=!0){return rl(e,t,n,i)}const xl=/\r\n?|\n/;var _l=function(e){return e[e.Simple=0]="Simple",e[e.TrackDel=1]="TrackDel",e[e.TrackBefore=2]="TrackBefore",e[e.TrackAfter=3]="TrackAfter",e}(_l||(_l={}));class Cl{constructor(e){this.sections=e}get length(){let e=0;for(let t=0;t<this.sections.length;t+=2)e+=this.sections[t];return e}get newLength(){let e=0;for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t+1];e+=n<0?this.sections[t]:n}return e}get empty(){return 0==this.sections.length||2==this.sections.length&&this.sections[1]<0}iterGaps(e){for(let t=0,n=0,i=0;t<this.sections.length;){let a=this.sections[t++],r=this.sections[t++];r<0?(e(n,i,a),i+=a):i+=r,n+=a}}iterChangedRanges(e,t=!1){Ml(this,e,t)}get invertedDesc(){let e=[];for(let t=0;t<this.sections.length;){let n=this.sections[t++],i=this.sections[t++];i<0?e.push(n,i):e.push(i,n)}return new Cl(e)}composeDesc(e){return this.empty?e:e.empty?this:El(this,e)}mapDesc(e,t=!1){return e.empty?this:Al(this,e,t)}mapPos(e,t=-1,n=_l.Simple){let i=0,a=0;for(let r=0;r<this.sections.length;){let s=this.sections[r++],o=this.sections[r++],l=i+s;if(o<0){if(l>e)return a+(e-i);a+=s}else{if(n!=_l.Simple&&l>=e&&(n==_l.TrackDel&&i<e&&l>e||n==_l.TrackBefore&&i<e||n==_l.TrackAfter&&l>e))return null;if(l>e||l==e&&t<0&&!s)return e==i||t<0?a:a+o;a+=o}i=l}if(e>i)throw new RangeError(`Position ${e} is out of range for changeset of length ${i}`);return a}touchesRange(e,t=e){for(let n=0,i=0;n<this.sections.length&&i<=t;){let a=i+this.sections[n++];if(this.sections[n++]>=0&&i<=t&&a>=e)return!(i<e&&a>t)||"cover";i=a}return!1}toString(){let e="";for(let t=0;t<this.sections.length;){let n=this.sections[t++],i=this.sections[t++];e+=(e?" ":"")+n+(i>=0?":"+i:"")}return e}toJSON(){return this.sections}static fromJSON(e){if(!Array.isArray(e)||e.length%2||e.some(e=>"number"!=typeof e))throw new RangeError("Invalid JSON representation of ChangeDesc");return new Cl(e)}static create(e){return new Cl(e)}}class Il extends Cl{constructor(e,t){super(e),this.inserted=t}apply(e){if(this.length!=e.length)throw new RangeError("Applying change set to a document with the wrong length");return Ml(this,(t,n,i,a,r)=>e=e.replace(i,i+(n-t),r),!1),e}mapDesc(e,t=!1){return Al(this,e,t,!0)}invert(e){let t=this.sections.slice(),n=[];for(let i=0,a=0;i<t.length;i+=2){let r=t[i],s=t[i+1];if(s>=0){t[i]=s,t[i+1]=r;let o=i>>1;for(;n.length<o;)n.push(hl.empty);n.push(r?e.slice(a,a+r):hl.empty)}a+=r}return new Il(t,n)}compose(e){return this.empty?e:e.empty?this:El(this,e,!0)}map(e,t=!1){return e.empty?this:Al(this,e,t,!0)}iterChanges(e,t=!1){Ml(this,e,t)}get desc(){return Cl.create(this.sections)}filter(e){let t=[],n=[],i=[],a=new zl(this);e:for(let r=0,s=0;;){let o=r==e.length?1e9:e[r++];for(;s<o||s==o&&0==a.len;){if(a.done)break e;let e=Math.min(a.len,o-s);Dl(i,e,-1);let r=-1==a.ins?-1:0==a.off?a.ins:0;Dl(t,e,r),r>0&&Tl(n,t,a.text),a.forward(e),s+=e}let l=e[r++];for(;s<l;){if(a.done)break e;let e=Math.min(a.len,l-s);Dl(t,e,-1),Dl(i,e,-1==a.ins?-1:0==a.off?a.ins:0),a.forward(e),s+=e}}return{changes:new Il(t,n),filtered:Cl.create(i)}}toJSON(){let e=[];for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t],i=this.sections[t+1];i<0?e.push(n):0==i?e.push([n]):e.push([n].concat(this.inserted[t>>1].toJSON()))}return e}static of(e,t,n){let i=[],a=[],r=0,s=null;function o(e=!1){if(!e&&!i.length)return;r<t&&Dl(i,t-r,-1);let n=new Il(i,a);s=s?s.compose(n.map(s)):n,i=[],a=[],r=0}return function e(l){if(Array.isArray(l))for(let t of l)e(t);else if(l instanceof Il){if(l.length!=t)throw new RangeError(`Mismatched change set length (got ${l.length}, expected ${t})`);o(),s=s?s.compose(l.map(s)):l}else{let{from:e,to:s=e,insert:c}=l;if(e>s||e<0||s>t)throw new RangeError(`Invalid change range ${e} to ${s} (in doc of length ${t})`);let d=c?"string"==typeof c?hl.of(c.split(n||xl)):c:hl.empty,u=d.length;if(e==s&&0==u)return;e<r&&o(),e>r&&Dl(i,e-r,-1),Dl(i,s-e,u),Tl(a,i,d),r=s}}(e),o(!s),s}static empty(e){return new Il(e?[e,-1]:[],[])}static fromJSON(e){if(!Array.isArray(e))throw new RangeError("Invalid JSON representation of ChangeSet");let t=[],n=[];for(let i=0;i<e.length;i++){let a=e[i];if("number"==typeof a)t.push(a,-1);else{if(!Array.isArray(a)||"number"!=typeof a[0]||a.some((e,t)=>t&&"string"!=typeof e))throw new RangeError("Invalid JSON representation of ChangeSet");if(1==a.length)t.push(a[0],0);else{for(;n.length<i;)n.push(hl.empty);n[i]=hl.of(a.slice(1)),t.push(a[0],n[i].length)}}}return new Il(t,n)}static createSet(e,t){return new Il(e,t)}}function Dl(e,t,n,i=!1){if(0==t&&n<=0)return;let a=e.length-2;a>=0&&n<=0&&n==e[a+1]?e[a]+=t:a>=0&&0==t&&0==e[a]?e[a+1]+=n:i?(e[a]+=t,e[a+1]+=n):e.push(t,n)}function Tl(e,t,n){if(0==n.length)return;let i=t.length-2>>1;if(i<e.length)e[e.length-1]=e[e.length-1].append(n);else{for(;e.length<i;)e.push(hl.empty);e.push(n)}}function Ml(e,t,n){let i=e.inserted;for(let a=0,r=0,s=0;s<e.sections.length;){let o=e.sections[s++],l=e.sections[s++];if(l<0)a+=o,r+=o;else{let c=a,d=r,u=hl.empty;for(;c+=o,d+=l,l&&i&&(u=u.append(i[s-2>>1])),!(n||s==e.sections.length||e.sections[s+1]<0);)o=e.sections[s++],l=e.sections[s++];t(a,c,r,d,u),a=c,r=d}}}function Al(e,t,n,i=!1){let a=[],r=i?[]:null,s=new zl(e),o=new zl(t);for(let l=-1;;){if(s.done&&o.len||o.done&&s.len)throw new Error("Mismatched change set lengths");if(-1==s.ins&&-1==o.ins){let e=Math.min(s.len,o.len);Dl(a,e,-1),s.forward(e),o.forward(e)}else if(o.ins>=0&&(s.ins<0||l==s.i||0==s.off&&(o.len<s.len||o.len==s.len&&!n))){let e=o.len;for(Dl(a,o.ins,-1);e;){let t=Math.min(s.len,e);s.ins>=0&&l<s.i&&s.len<=t&&(Dl(a,0,s.ins),r&&Tl(r,a,s.text),l=s.i),s.forward(t),e-=t}o.next()}else{if(!(s.ins>=0)){if(s.done&&o.done)return r?Il.createSet(a,r):Cl.create(a);throw new Error("Mismatched change set lengths")}{let e=0,t=s.len;for(;t;)if(-1==o.ins){let n=Math.min(t,o.len);e+=n,t-=n,o.forward(n)}else{if(!(0==o.ins&&o.len<t))break;t-=o.len,o.next()}Dl(a,e,l<s.i?s.ins:0),r&&l<s.i&&Tl(r,a,s.text),l=s.i,s.forward(s.len-t)}}}}function El(e,t,n=!1){let i=[],a=n?[]:null,r=new zl(e),s=new zl(t);for(let o=!1;;){if(r.done&&s.done)return a?Il.createSet(i,a):Cl.create(i);if(0==r.ins)Dl(i,r.len,0,o),r.next();else if(0!=s.len||s.done){if(r.done||s.done)throw new Error("Mismatched change set lengths");{let e=Math.min(r.len2,s.len),t=i.length;if(-1==r.ins){let t=-1==s.ins?-1:s.off?0:s.ins;Dl(i,e,t,o),a&&t&&Tl(a,i,s.text)}else-1==s.ins?(Dl(i,r.off?0:r.len,e,o),a&&Tl(a,i,r.textBit(e))):(Dl(i,r.off?0:r.len,s.off?0:s.ins,o),a&&!s.off&&Tl(a,i,s.text));o=(r.ins>e||s.ins>=0&&s.len>e)&&(o||i.length>t),r.forward2(e),s.forward(e)}}else Dl(i,0,s.ins,o),a&&Tl(a,i,s.text),s.next()}}class zl{constructor(e){this.set=e,this.i=0,this.next()}next(){let{sections:e}=this.set;this.i<e.length?(this.len=e[this.i++],this.ins=e[this.i++]):(this.len=0,this.ins=-2),this.off=0}get done(){return-2==this.ins}get len2(){return this.ins<0?this.len:this.ins}get text(){let{inserted:e}=this.set,t=this.i-2>>1;return t>=e.length?hl.empty:e[t]}textBit(e){let{inserted:t}=this.set,n=this.i-2>>1;return n>=t.length&&!e?hl.empty:t[n].slice(this.off,null==e?void 0:this.off+e)}forward(e){e==this.len?this.next():(this.len-=e,this.off+=e)}forward2(e){-1==this.ins?this.forward(e):e==this.ins?this.next():(this.ins-=e,this.off+=e)}}class Pl{constructor(e,t,n){this.from=e,this.to=t,this.flags=n}get anchor(){return 32&this.flags?this.to:this.from}get head(){return 32&this.flags?this.from:this.to}get empty(){return this.from==this.to}get assoc(){return 8&this.flags?-1:16&this.flags?1:0}get bidiLevel(){let e=7&this.flags;return 7==e?null:e}get goalColumn(){let e=this.flags>>6;return 16777215==e?void 0:e}map(e,t=-1){let n,i;return this.empty?n=i=e.mapPos(this.from,t):(n=e.mapPos(this.from,1),i=e.mapPos(this.to,-1)),n==this.from&&i==this.to?this:new Pl(n,i,this.flags)}extend(e,t=e){if(e<=this.anchor&&t>=this.anchor)return Rl.range(e,t);let n=Math.abs(e-this.anchor)>Math.abs(t-this.anchor)?e:t;return Rl.range(this.anchor,n)}eq(e,t=!1){return!(this.anchor!=e.anchor||this.head!=e.head||t&&this.empty&&this.assoc!=e.assoc)}toJSON(){return{anchor:this.anchor,head:this.head}}static fromJSON(e){if(!e||"number"!=typeof e.anchor||"number"!=typeof e.head)throw new RangeError("Invalid JSON representation for SelectionRange");return Rl.range(e.anchor,e.head)}static create(e,t,n){return new Pl(e,t,n)}}class Rl{constructor(e,t){this.ranges=e,this.mainIndex=t}map(e,t=-1){return e.empty?this:Rl.create(this.ranges.map(n=>n.map(e,t)),this.mainIndex)}eq(e,t=!1){if(this.ranges.length!=e.ranges.length||this.mainIndex!=e.mainIndex)return!1;for(let n=0;n<this.ranges.length;n++)if(!this.ranges[n].eq(e.ranges[n],t))return!1;return!0}get main(){return this.ranges[this.mainIndex]}asSingle(){return 1==this.ranges.length?this:new Rl([this.main],0)}addRange(e,t=!0){return Rl.create([e].concat(this.ranges),t?0:this.mainIndex+1)}replaceRange(e,t=this.mainIndex){let n=this.ranges.slice();return n[t]=e,Rl.create(n,this.mainIndex)}toJSON(){return{ranges:this.ranges.map(e=>e.toJSON()),main:this.mainIndex}}static fromJSON(e){if(!e||!Array.isArray(e.ranges)||"number"!=typeof e.main||e.main>=e.ranges.length)throw new RangeError("Invalid JSON representation for EditorSelection");return new Rl(e.ranges.map(e=>Pl.fromJSON(e)),e.main)}static single(e,t=e){return new Rl([Rl.range(e,t)],0)}static create(e,t=0){if(0==e.length)throw new RangeError("A selection needs at least one range");for(let n=0,i=0;i<e.length;i++){let a=e[i];if(a.empty?a.from<=n:a.from<n)return Rl.normalized(e.slice(),t);n=a.to}return new Rl(e,t)}static cursor(e,t=0,n,i){return Pl.create(e,e,(0==t?0:t<0?8:16)|(null==n?7:Math.min(6,n))|(null!=i?i:16777215)<<6)}static range(e,t,n,i){let a=(null!=n?n:16777215)<<6|(null==i?7:Math.min(6,i));return t<e?Pl.create(t,e,48|a):Pl.create(e,t,(t>e?8:0)|a)}static normalized(e,t=0){let n=e[t];e.sort((e,t)=>e.from-t.from),t=e.indexOf(n);for(let i=1;i<e.length;i++){let n=e[i],a=e[i-1];if(n.empty?n.from<=a.to:n.from<a.to){let r=a.from,s=Math.max(n.to,a.to);i<=t&&t--,e.splice(--i,2,n.anchor>n.head?Rl.range(s,r):Rl.range(r,s))}}return new Rl(e,t)}}function $l(e,t){for(let n of e.ranges)if(n.to>t)throw new RangeError("Selection points outside of document")}let Ol=0;class Ll{constructor(e,t,n,i,a){this.combine=e,this.compareInput=t,this.compare=n,this.isStatic=i,this.id=Ol++,this.default=e([]),this.extensions="function"==typeof a?a(this):a}get reader(){return this}static define(e={}){return new Ll(e.combine||(e=>e),e.compareInput||((e,t)=>e===t),e.compare||(e.combine?(e,t)=>e===t:Nl),!!e.static,e.enables)}of(e){return new Fl([],this,0,e)}compute(e,t){if(this.isStatic)throw new Error("Can't compute a static facet");return new Fl(e,this,1,t)}computeN(e,t){if(this.isStatic)throw new Error("Can't compute a static facet");return new Fl(e,this,2,t)}from(e,t){return t||(t=e=>e),this.compute([e],n=>t(n.field(e)))}}function Nl(e,t){return e==t||e.length==t.length&&e.every((e,n)=>e===t[n])}class Fl{constructor(e,t,n,i){this.dependencies=e,this.facet=t,this.type=n,this.value=i,this.id=Ol++}dynamicSlot(e){var t;let n=this.value,i=this.facet.compareInput,a=this.id,r=e[a]>>1,s=2==this.type,o=!1,l=!1,c=[];for(let d of this.dependencies)"doc"==d?o=!0:"selection"==d?l=!0:1&(null!==(t=e[d.id])&&void 0!==t?t:1)||c.push(e[d.id]);return{create:e=>(e.values[r]=n(e),1),update(e,t){if(o&&t.docChanged||l&&(t.docChanged||t.selection)||jl(e,c)){let t=n(e);if(s?!Bl(t,e.values[r],i):!i(t,e.values[r]))return e.values[r]=t,1}return 0},reconfigure:(e,t)=>{let o,l=t.config.address[a];if(null!=l){let a=Yl(t,l);if(this.dependencies.every(n=>n instanceof Ll?t.facet(n)===e.facet(n):!(n instanceof ql)||t.field(n,!1)==e.field(n,!1))||(s?Bl(o=n(e),a,i):i(o=n(e),a)))return e.values[r]=a,0}else o=n(e);return e.values[r]=o,1}}}}function Bl(e,t,n){if(e.length!=t.length)return!1;for(let i=0;i<e.length;i++)if(!n(e[i],t[i]))return!1;return!0}function jl(e,t){let n=!1;for(let i of t)1&Zl(e,i)&&(n=!0);return n}function Ul(e,t,n){let i=n.map(t=>e[t.id]),a=n.map(e=>e.type),r=i.filter(e=>!(1&e)),s=e[t.id]>>1;function o(e){let n=[];for(let t=0;t<i.length;t++){let r=Yl(e,i[t]);if(2==a[t])for(let e of r)n.push(e);else n.push(r)}return t.combine(n)}return{create(e){for(let t of i)Zl(e,t);return e.values[s]=o(e),1},update(e,n){if(!jl(e,r))return 0;let i=o(e);return t.compare(i,e.values[s])?0:(e.values[s]=i,1)},reconfigure(e,a){let r=jl(e,i),l=a.config.facets[t.id],c=a.facet(t);if(l&&!r&&Nl(n,l))return e.values[s]=c,0;let d=o(e);return t.compare(d,c)?(e.values[s]=c,0):(e.values[s]=d,1)}}}const Vl=Ll.define({static:!0});class ql{constructor(e,t,n,i,a){this.id=e,this.createF=t,this.updateF=n,this.compareF=i,this.spec=a,this.provides=void 0}static define(e){let t=new ql(Ol++,e.create,e.update,e.compare||((e,t)=>e===t),e);return e.provide&&(t.provides=e.provide(t)),t}create(e){let t=e.facet(Vl).find(e=>e.field==this);return((null==t?void 0:t.create)||this.createF)(e)}slot(e){let t=e[this.id]>>1;return{create:e=>(e.values[t]=this.create(e),1),update:(e,n)=>{let i=e.values[t],a=this.updateF(i,n);return this.compareF(i,a)?0:(e.values[t]=a,1)},reconfigure:(e,n)=>null!=n.config.address[this.id]?(e.values[t]=n.field(this),0):(e.values[t]=this.create(e),1)}}init(e){return[this,Vl.of({field:this,create:e})]}get extension(){return this}}const Hl=2;class Wl{constructor(e,t){this.inner=e,this.prec=t}}class Gl{of(e){return new Ql(this,e)}reconfigure(e){return Gl.reconfigure.of({compartment:this,extension:e})}get(e){return e.config.compartments.get(this)}}class Ql{constructor(e,t){this.compartment=e,this.inner=t}}class Kl{constructor(e,t,n,i,a,r){for(this.base=e,this.compartments=t,this.dynamicSlots=n,this.address=i,this.staticValues=a,this.facets=r,this.statusTemplate=[];this.statusTemplate.length<n.length;)this.statusTemplate.push(0)}staticFacet(e){let t=this.address[e.id];return null==t?e.default:this.staticValues[t>>1]}static resolve(e,t,n){let i=[],a=Object.create(null),r=new Map;for(let u of function(e,t,n){let i=[[],[],[],[],[]],a=new Map;function r(e,s){let o=a.get(e);if(null!=o){if(o<=s)return;let t=i[o].indexOf(e);t>-1&&i[o].splice(t,1),e instanceof Ql&&n.delete(e.compartment)}if(a.set(e,s),Array.isArray(e))for(let t of e)r(t,s);else if(e instanceof Ql){if(n.has(e.compartment))throw new RangeError("Duplicate use of compartment in extensions");let i=t.get(e.compartment)||e.inner;n.set(e.compartment,i),r(i,s)}else if(e instanceof Wl)r(e.inner,e.prec);else if(e instanceof ql)i[s].push(e),e.provides&&r(e.provides,s);else if(e instanceof Fl)i[s].push(e),e.facet.extensions&&r(e.facet.extensions,Hl);else{let t=e.extension;if(!t)throw new Error(`Unrecognized extension value in extension set (${e}). This sometimes happens because multiple instances of @codemirror/state are loaded, breaking instanceof checks.`);r(t,s)}}return r(e,Hl),i.reduce((e,t)=>e.concat(t))}(e,t,r))u instanceof ql?i.push(u):(a[u.facet.id]||(a[u.facet.id]=[])).push(u);let s=Object.create(null),o=[],l=[];for(let u of i)s[u.id]=l.length<<1,l.push(e=>u.slot(e));let c=null==n?void 0:n.config.facets;for(let u in a){let e=a[u],t=e[0].facet,i=c&&c[u]||[];if(e.every(e=>0==e.type))if(s[t.id]=o.length<<1|1,Nl(i,e))o.push(n.facet(t));else{let i=t.combine(e.map(e=>e.value));o.push(n&&t.compare(i,n.facet(t))?n.facet(t):i)}else{for(let t of e)0==t.type?(s[t.id]=o.length<<1|1,o.push(t.value)):(s[t.id]=l.length<<1,l.push(e=>t.dynamicSlot(e)));s[t.id]=l.length<<1,l.push(n=>Ul(n,t,e))}}let d=l.map(e=>e(s));return new Kl(e,r,d,s,o,a)}}function Zl(e,t){if(1&t)return 2;let n=t>>1,i=e.status[n];if(4==i)throw new Error("Cyclic dependency between fields and/or facets");if(2&i)return i;e.status[n]=4;let a=e.computeSlot(e,e.config.dynamicSlots[n]);return e.status[n]=2|a}function Yl(e,t){return 1&t?e.config.staticValues[t>>1]:e.values[t>>1]}const Xl=Ll.define(),Jl=Ll.define({combine:e=>e.some(e=>e),static:!0}),ec=Ll.define({combine:e=>e.length?e[0]:void 0,static:!0}),tc=Ll.define(),nc=Ll.define(),ic=Ll.define(),ac=Ll.define({combine:e=>!!e.length&&e[0]});class rc{constructor(e,t){this.type=e,this.value=t}static define(){return new sc}}class sc{of(e){return new rc(this,e)}}class oc{constructor(e){this.map=e}of(e){return new lc(this,e)}}class lc{constructor(e,t){this.type=e,this.value=t}map(e){let t=this.type.map(this.value,e);return void 0===t?void 0:t==this.value?this:new lc(this.type,t)}is(e){return this.type==e}static define(e={}){return new oc(e.map||(e=>e))}static mapEffects(e,t){if(!e.length)return e;let n=[];for(let i of e){let e=i.map(t);e&&n.push(e)}return n}}lc.reconfigure=lc.define(),lc.appendConfig=lc.define();class cc{constructor(e,t,n,i,a,r){this.startState=e,this.changes=t,this.selection=n,this.effects=i,this.annotations=a,this.scrollIntoView=r,this._doc=null,this._state=null,n&&$l(n,t.newLength),a.some(e=>e.type==cc.time)||(this.annotations=a.concat(cc.time.of(Date.now())))}static create(e,t,n,i,a,r){return new cc(e,t,n,i,a,r)}get newDoc(){return this._doc||(this._doc=this.changes.apply(this.startState.doc))}get newSelection(){return this.selection||this.startState.selection.map(this.changes)}get state(){return this._state||this.startState.applyTransaction(this),this._state}annotation(e){for(let t of this.annotations)if(t.type==e)return t.value}get docChanged(){return!this.changes.empty}get reconfigured(){return this.startState.config!=this.state.config}isUserEvent(e){let t=this.annotation(cc.userEvent);return!(!t||!(t==e||t.length>e.length&&t.slice(0,e.length)==e&&"."==t[e.length]))}}function dc(e,t){let n=[];for(let i=0,a=0;;){let r,s;if(i<e.length&&(a==t.length||t[a]>=e[i]))r=e[i++],s=e[i++];else{if(!(a<t.length))return n;r=t[a++],s=t[a++]}!n.length||n[n.length-1]<r?n.push(r,s):n[n.length-1]<s&&(n[n.length-1]=s)}}function uc(e,t,n){var i;let a,r,s;return n?(a=t.changes,r=Il.empty(t.changes.length),s=e.changes.compose(t.changes)):(a=t.changes.map(e.changes),r=e.changes.mapDesc(t.changes,!0),s=e.changes.compose(a)),{changes:s,selection:t.selection?t.selection.map(r):null===(i=e.selection)||void 0===i?void 0:i.map(a),effects:lc.mapEffects(e.effects,a).concat(lc.mapEffects(t.effects,r)),annotations:e.annotations.length?e.annotations.concat(t.annotations):t.annotations,scrollIntoView:e.scrollIntoView||t.scrollIntoView}}function hc(e,t,n){let i=t.selection,a=vc(t.annotations);return t.userEvent&&(a=a.concat(cc.userEvent.of(t.userEvent))),{changes:t.changes instanceof Il?t.changes:Il.of(t.changes||[],n,e.facet(ec)),selection:i&&(i instanceof Rl?i:Rl.single(i.anchor,i.head)),effects:vc(t.effects),annotations:a,scrollIntoView:!!t.scrollIntoView}}function pc(e,t,n){let i=hc(e,t.length?t[0]:{},e.doc.length);t.length&&!1===t[0].filter&&(n=!1);for(let r=1;r<t.length;r++){!1===t[r].filter&&(n=!1);let a=!!t[r].sequential;i=uc(i,hc(e,t[r],a?i.changes.newLength:e.doc.length),a)}let a=cc.create(e,i.changes,i.selection,i.effects,i.annotations,i.scrollIntoView);return function(e){let t=e.startState,n=t.facet(ic),i=e;for(let a=n.length-1;a>=0;a--){let r=n[a](e);r&&Object.keys(r).length&&(i=uc(i,hc(t,r,e.changes.newLength),!0))}return i==e?e:cc.create(t,e.changes,e.selection,i.effects,i.annotations,i.scrollIntoView)}(n?function(e){let t=e.startState,n=!0;for(let a of t.facet(tc)){let t=a(e);if(!1===t){n=!1;break}Array.isArray(t)&&(n=!0===n?t:dc(n,t))}if(!0!==n){let i,a;if(!1===n)a=e.changes.invertedDesc,i=Il.empty(t.doc.length);else{let t=e.changes.filter(n);i=t.changes,a=t.filtered.mapDesc(t.changes).invertedDesc}e=cc.create(t,i,e.selection&&e.selection.map(a),lc.mapEffects(e.effects,a),e.annotations,e.scrollIntoView)}let i=t.facet(nc);for(let a=i.length-1;a>=0;a--){let n=i[a](e);e=n instanceof cc?n:Array.isArray(n)&&1==n.length&&n[0]instanceof cc?n[0]:pc(t,vc(n),!1)}return e}(a):a)}cc.time=rc.define(),cc.userEvent=rc.define(),cc.addToHistory=rc.define(),cc.remote=rc.define();const gc=[];function vc(e){return null==e?gc:Array.isArray(e)?e:[e]}var fc=function(e){return e[e.Word=0]="Word",e[e.Space=1]="Space",e[e.Other=2]="Other",e}(fc||(fc={}));const mc=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;let yc;try{yc=new RegExp("[\\p{Alphabetic}\\p{Number}_]","u")}catch(gIe){}function bc(e){return t=>{if(!/\S/.test(t))return fc.Space;if(function(e){if(yc)return yc.test(e);for(let t=0;t<e.length;t++){let n=e[t];if(/\w/.test(n)||n>""&&(n.toUpperCase()!=n.toLowerCase()||mc.test(n)))return!0}return!1}(t))return fc.Word;for(let n=0;n<e.length;n++)if(t.indexOf(e[n])>-1)return fc.Word;return fc.Other}}class wc{constructor(e,t,n,i,a,r){this.config=e,this.doc=t,this.selection=n,this.values=i,this.status=e.statusTemplate.slice(),this.computeSlot=a,r&&(r._state=this);for(let s=0;s<this.config.dynamicSlots.length;s++)Zl(this,s<<1);this.computeSlot=null}field(e,t=!0){let n=this.config.address[e.id];if(null!=n)return Zl(this,n),Yl(this,n);if(t)throw new RangeError("Field is not present in this state")}update(...e){return pc(this,e,!0)}applyTransaction(e){let t,n=this.config,{base:i,compartments:a}=n;for(let s of e.effects)s.is(Gl.reconfigure)?(n&&(a=new Map,n.compartments.forEach((e,t)=>a.set(t,e)),n=null),a.set(s.value.compartment,s.value.extension)):s.is(lc.reconfigure)?(n=null,i=s.value):s.is(lc.appendConfig)&&(n=null,i=vc(i).concat(s.value));if(n)t=e.startState.values.slice();else{n=Kl.resolve(i,a,this),t=new wc(n,this.doc,this.selection,n.dynamicSlots.map(()=>null),(e,t)=>t.reconfigure(e,this),null).values}let r=e.startState.facet(Jl)?e.newSelection:e.newSelection.asSingle();new wc(n,e.newDoc,r,t,(t,n)=>n.update(t,e),e)}replaceSelection(e){return"string"==typeof e&&(e=this.toText(e)),this.changeByRange(t=>({changes:{from:t.from,to:t.to,insert:e},range:Rl.cursor(t.from+e.length)}))}changeByRange(e){let t=this.selection,n=e(t.ranges[0]),i=this.changes(n.changes),a=[n.range],r=vc(n.effects);for(let s=1;s<t.ranges.length;s++){let n=e(t.ranges[s]),o=this.changes(n.changes),l=o.map(i);for(let e=0;e<s;e++)a[e]=a[e].map(l);let c=i.mapDesc(o,!0);a.push(n.range.map(c)),i=i.compose(l),r=lc.mapEffects(r,l).concat(lc.mapEffects(vc(n.effects),c))}return{changes:i,selection:Rl.create(a,t.mainIndex),effects:r}}changes(e=[]){return e instanceof Il?e:Il.of(e,this.doc.length,this.facet(wc.lineSeparator))}toText(e){return hl.of(e.split(this.facet(wc.lineSeparator)||xl))}sliceDoc(e=0,t=this.doc.length){return this.doc.sliceString(e,t,this.lineBreak)}facet(e){let t=this.config.address[e.id];return null==t?e.default:(Zl(this,t),Yl(this,t))}toJSON(e){let t={doc:this.sliceDoc(),selection:this.selection.toJSON()};if(e)for(let n in e){let i=e[n];i instanceof ql&&null!=this.config.address[i.id]&&(t[n]=i.spec.toJSON(this.field(e[n]),this))}return t}static fromJSON(e,t={},n){if(!e||"string"!=typeof e.doc)throw new RangeError("Invalid JSON representation for EditorState");let i=[];if(n)for(let a in n)if(Object.prototype.hasOwnProperty.call(e,a)){let t=n[a],r=e[a];i.push(t.init(e=>t.spec.fromJSON(r,e)))}return wc.create({doc:e.doc,selection:Rl.fromJSON(e.selection),extensions:t.extensions?i.concat([t.extensions]):i})}static create(e={}){let t=Kl.resolve(e.extensions||[],new Map),n=e.doc instanceof hl?e.doc:hl.of((e.doc||"").split(t.staticFacet(wc.lineSeparator)||xl)),i=e.selection?e.selection instanceof Rl?e.selection:Rl.single(e.selection.anchor,e.selection.head):Rl.single(0);return $l(i,n.length),t.staticFacet(Jl)||(i=i.asSingle()),new wc(t,n,i,t.dynamicSlots.map(()=>null),(e,t)=>t.create(e),null)}get tabSize(){return this.facet(wc.tabSize)}get lineBreak(){return this.facet(wc.lineSeparator)||"\n"}get readOnly(){return this.facet(ac)}phrase(e,...t){for(let n of this.facet(wc.phrases))if(Object.prototype.hasOwnProperty.call(n,e)){e=n[e];break}return t.length&&(e=e.replace(/\$(\$|\d*)/g,(e,n)=>{if("$"==n)return"$";let i=+(n||1);return!i||i>t.length?e:t[i-1]})),e}languageDataAt(e,t,n=-1){let i=[];for(let a of this.facet(Xl))for(let r of a(this,t,n))Object.prototype.hasOwnProperty.call(r,e)&&i.push(r[e]);return i}charCategorizer(e){return bc(this.languageDataAt("wordChars",e).join(""))}wordAt(e){let{text:t,from:n,length:i}=this.doc.lineAt(e),a=this.charCategorizer(e),r=e-n,s=e-n;for(;r>0;){let e=Sl(t,r,!1);if(a(t.slice(e,r))!=fc.Word)break;r=e}for(;s<i;){let e=Sl(t,s);if(a(t.slice(s,e))!=fc.Word)break;s=e}return r==s?null:Rl.range(r+n,s+n)}}wc.allowMultipleSelections=Jl,wc.tabSize=Ll.define({combine:e=>e.length?e[0]:4}),wc.lineSeparator=ec,wc.readOnly=ac,wc.phrases=Ll.define({compare(e,t){let n=Object.keys(e),i=Object.keys(t);return n.length==i.length&&n.every(n=>e[n]==t[n])}}),wc.languageData=Xl,wc.changeFilter=tc,wc.transactionFilter=nc,wc.transactionExtender=ic,Gl.reconfigure=lc.define();class kc{eq(e){return this==e}range(e,t=e){return Sc.create(e,t,this)}}kc.prototype.startSide=kc.prototype.endSide=0,kc.prototype.point=!1,kc.prototype.mapMode=_l.TrackDel;class Sc{constructor(e,t,n){this.from=e,this.to=t,this.value=n}static create(e,t,n){return new Sc(e,t,n)}}function xc(e,t){return e.from-t.from||e.value.startSide-t.value.startSide}class _c{constructor(e,t,n,i){this.from=e,this.to=t,this.value=n,this.maxPoint=i}get length(){return this.to[this.to.length-1]}findIndex(e,t,n,i=0){let a=n?this.to:this.from;for(let r=i,s=a.length;;){if(r==s)return r;let i=r+s>>1,o=a[i]-e||(n?this.value[i].endSide:this.value[i].startSide)-t;if(i==r)return o>=0?r:s;o>=0?s=i:r=i+1}}between(e,t,n,i){for(let a=this.findIndex(t,-1e9,!0),r=this.findIndex(n,1e9,!1,a);a<r;a++)if(!1===i(this.from[a]+e,this.to[a]+e,this.value[a]))return!1}map(e,t){let n=[],i=[],a=[],r=-1,s=-1;for(let o=0;o<this.value.length;o++){let l,c,d=this.value[o],u=this.from[o]+e,h=this.to[o]+e;if(u==h){let e=t.mapPos(u,d.startSide,d.mapMode);if(null==e)continue;if(l=c=e,d.startSide!=d.endSide&&(c=t.mapPos(u,d.endSide),c<l))continue}else if(l=t.mapPos(u,d.startSide),c=t.mapPos(h,d.endSide),l>c||l==c&&d.startSide>0&&d.endSide<=0)continue;(c-l||d.endSide-d.startSide)<0||(r<0&&(r=l),d.point&&(s=Math.max(s,c-l)),n.push(d),i.push(l-r),a.push(c-r))}return{mapped:n.length?new _c(i,a,n,s):null,pos:r}}}class Cc{constructor(e,t,n,i){this.chunkPos=e,this.chunk=t,this.nextLayer=n,this.maxPoint=i}static create(e,t,n,i){return new Cc(e,t,n,i)}get length(){let e=this.chunk.length-1;return e<0?0:Math.max(this.chunkEnd(e),this.nextLayer.length)}get size(){if(this.isEmpty)return 0;let e=this.nextLayer.size;for(let t of this.chunk)e+=t.value.length;return e}chunkEnd(e){return this.chunkPos[e]+this.chunk[e].length}update(e){let{add:t=[],sort:n=!1,filterFrom:i=0,filterTo:a=this.length}=e,r=e.filter;if(0==t.length&&!r)return this;if(n&&(t=t.slice().sort(xc)),this.isEmpty)return t.length?Cc.of(t):this;let s=new Tc(this,null,-1).goto(0),o=0,l=[],c=new Ic;for(;s.value||o<t.length;)if(o<t.length&&(s.from-t[o].from||s.startSide-t[o].value.startSide)>=0){let e=t[o++];c.addInner(e.from,e.to,e.value)||l.push(e)}else 1==s.rangeIndex&&s.chunkIndex<this.chunk.length&&(o==t.length||this.chunkEnd(s.chunkIndex)<t[o].from)&&(!r||i>this.chunkEnd(s.chunkIndex)||a<this.chunkPos[s.chunkIndex])&&c.addChunk(this.chunkPos[s.chunkIndex],this.chunk[s.chunkIndex])?s.nextChunk():((!r||i>s.to||a<s.from||r(s.from,s.to,s.value))&&(c.addInner(s.from,s.to,s.value)||l.push(Sc.create(s.from,s.to,s.value))),s.next());return c.finishInner(this.nextLayer.isEmpty&&!l.length?Cc.empty:this.nextLayer.update({add:l,filter:r,filterFrom:i,filterTo:a}))}map(e){if(e.empty||this.isEmpty)return this;let t=[],n=[],i=-1;for(let r=0;r<this.chunk.length;r++){let a=this.chunkPos[r],s=this.chunk[r],o=e.touchesRange(a,a+s.length);if(!1===o)i=Math.max(i,s.maxPoint),t.push(s),n.push(e.mapPos(a));else if(!0===o){let{mapped:r,pos:o}=s.map(a,e);r&&(i=Math.max(i,r.maxPoint),t.push(r),n.push(o))}}let a=this.nextLayer.map(e);return 0==t.length?a:new Cc(n,t,a||Cc.empty,i)}between(e,t,n){if(!this.isEmpty){for(let i=0;i<this.chunk.length;i++){let a=this.chunkPos[i],r=this.chunk[i];if(t>=a&&e<=a+r.length&&!1===r.between(a,e-a,t-a,n))return}this.nextLayer.between(e,t,n)}}iter(e=0){return Mc.from([this]).goto(e)}get isEmpty(){return this.nextLayer==this}static iter(e,t=0){return Mc.from(e).goto(t)}static compare(e,t,n,i,a=-1){let r=e.filter(e=>e.maxPoint>0||!e.isEmpty&&e.maxPoint>=a),s=t.filter(e=>e.maxPoint>0||!e.isEmpty&&e.maxPoint>=a),o=Dc(r,s,n),l=new Ec(r,o,a),c=new Ec(s,o,a);n.iterGaps((e,t,n)=>zc(l,e,c,t,n,i)),n.empty&&0==n.length&&zc(l,0,c,0,0,i)}static eq(e,t,n=0,i){null==i&&(i=999999999);let a=e.filter(e=>!e.isEmpty&&t.indexOf(e)<0),r=t.filter(t=>!t.isEmpty&&e.indexOf(t)<0);if(a.length!=r.length)return!1;if(!a.length)return!0;let s=Dc(a,r),o=new Ec(a,s,0).goto(n),l=new Ec(r,s,0).goto(n);for(;;){if(o.to!=l.to||!Pc(o.active,l.active)||o.point&&(!l.point||!o.point.eq(l.point)))return!1;if(o.to>i)return!0;o.next(),l.next()}}static spans(e,t,n,i,a=-1){let r=new Ec(e,null,a).goto(t),s=t,o=r.openStart;for(;;){let e=Math.min(r.to,n);if(r.point){let n=r.activeForPoint(r.to),a=r.pointFrom<t?n.length+1:r.point.startSide<0?n.length:Math.min(n.length,o);i.point(s,e,r.point,n,a,r.pointRank),o=Math.min(r.openEnd(e),n.length)}else e>s&&(i.span(s,e,r.active,o),o=r.openEnd(e));if(r.to>n)return o+(r.point&&r.to>n?1:0);s=r.to,r.next()}}static of(e,t=!1){let n=new Ic;for(let i of e instanceof Sc?[e]:t?function(e){if(e.length>1)for(let t=e[0],n=1;n<e.length;n++){let i=e[n];if(xc(t,i)>0)return e.slice().sort(xc);t=i}return e}(e):e)n.add(i.from,i.to,i.value);return n.finish()}static join(e){if(!e.length)return Cc.empty;let t=e[e.length-1];for(let n=e.length-2;n>=0;n--)for(let i=e[n];i!=Cc.empty;i=i.nextLayer)t=new Cc(i.chunkPos,i.chunk,t,Math.max(i.maxPoint,t.maxPoint));return t}}Cc.empty=new Cc([],[],null,-1),Cc.empty.nextLayer=Cc.empty;class Ic{finishChunk(e){this.chunks.push(new _c(this.from,this.to,this.value,this.maxPoint)),this.chunkPos.push(this.chunkStart),this.chunkStart=-1,this.setMaxPoint=Math.max(this.setMaxPoint,this.maxPoint),this.maxPoint=-1,e&&(this.from=[],this.to=[],this.value=[])}constructor(){this.chunks=[],this.chunkPos=[],this.chunkStart=-1,this.last=null,this.lastFrom=-1e9,this.lastTo=-1e9,this.from=[],this.to=[],this.value=[],this.maxPoint=-1,this.setMaxPoint=-1,this.nextLayer=null}add(e,t,n){this.addInner(e,t,n)||(this.nextLayer||(this.nextLayer=new Ic)).add(e,t,n)}addInner(e,t,n){let i=e-this.lastTo||n.startSide-this.last.endSide;if(i<=0&&(e-this.lastFrom||n.startSide-this.last.startSide)<0)throw new Error("Ranges must be added sorted by `from` position and `startSide`");return!(i<0)&&(250==this.from.length&&this.finishChunk(!0),this.chunkStart<0&&(this.chunkStart=e),this.from.push(e-this.chunkStart),this.to.push(t-this.chunkStart),this.last=n,this.lastFrom=e,this.lastTo=t,this.value.push(n),n.point&&(this.maxPoint=Math.max(this.maxPoint,t-e)),!0)}addChunk(e,t){if((e-this.lastTo||t.value[0].startSide-this.last.endSide)<0)return!1;this.from.length&&this.finishChunk(!0),this.setMaxPoint=Math.max(this.setMaxPoint,t.maxPoint),this.chunks.push(t),this.chunkPos.push(e);let n=t.value.length-1;return this.last=t.value[n],this.lastFrom=t.from[n]+e,this.lastTo=t.to[n]+e,!0}finish(){return this.finishInner(Cc.empty)}finishInner(e){if(this.from.length&&this.finishChunk(!1),0==this.chunks.length)return e;let t=Cc.create(this.chunkPos,this.chunks,this.nextLayer?this.nextLayer.finishInner(e):e,this.setMaxPoint);return this.from=null,t}}function Dc(e,t,n){let i=new Map;for(let r of e)for(let e=0;e<r.chunk.length;e++)r.chunk[e].maxPoint<=0&&i.set(r.chunk[e],r.chunkPos[e]);let a=new Set;for(let r of t)for(let e=0;e<r.chunk.length;e++){let t=i.get(r.chunk[e]);null==t||(n?n.mapPos(t):t)!=r.chunkPos[e]||(null==n?void 0:n.touchesRange(t,t+r.chunk[e].length))||a.add(r.chunk[e])}return a}class Tc{constructor(e,t,n,i=0){this.layer=e,this.skip=t,this.minPoint=n,this.rank=i}get startSide(){return this.value?this.value.startSide:0}get endSide(){return this.value?this.value.endSide:0}goto(e,t=-1e9){return this.chunkIndex=this.rangeIndex=0,this.gotoInner(e,t,!1),this}gotoInner(e,t,n){for(;this.chunkIndex<this.layer.chunk.length;){let t=this.layer.chunk[this.chunkIndex];if(!(this.skip&&this.skip.has(t)||this.layer.chunkEnd(this.chunkIndex)<e||t.maxPoint<this.minPoint))break;this.chunkIndex++,n=!1}if(this.chunkIndex<this.layer.chunk.length){let i=this.layer.chunk[this.chunkIndex].findIndex(e-this.layer.chunkPos[this.chunkIndex],t,!0);(!n||this.rangeIndex<i)&&this.setRangeIndex(i)}this.next()}forward(e,t){(this.to-e||this.endSide-t)<0&&this.gotoInner(e,t,!0)}next(){for(;;){if(this.chunkIndex==this.layer.chunk.length){this.from=this.to=1e9,this.value=null;break}{let e=this.layer.chunkPos[this.chunkIndex],t=this.layer.chunk[this.chunkIndex],n=e+t.from[this.rangeIndex];if(this.from=n,this.to=e+t.to[this.rangeIndex],this.value=t.value[this.rangeIndex],this.setRangeIndex(this.rangeIndex+1),this.minPoint<0||this.value.point&&this.to-this.from>=this.minPoint)break}}}setRangeIndex(e){if(e==this.layer.chunk[this.chunkIndex].value.length){if(this.chunkIndex++,this.skip)for(;this.chunkIndex<this.layer.chunk.length&&this.skip.has(this.layer.chunk[this.chunkIndex]);)this.chunkIndex++;this.rangeIndex=0}else this.rangeIndex=e}nextChunk(){this.chunkIndex++,this.rangeIndex=0,this.next()}compare(e){return this.from-e.from||this.startSide-e.startSide||this.rank-e.rank||this.to-e.to||this.endSide-e.endSide}}class Mc{constructor(e){this.heap=e}static from(e,t=null,n=-1){let i=[];for(let a=0;a<e.length;a++)for(let r=e[a];!r.isEmpty;r=r.nextLayer)r.maxPoint>=n&&i.push(new Tc(r,t,n,a));return 1==i.length?i[0]:new Mc(i)}get startSide(){return this.value?this.value.startSide:0}goto(e,t=-1e9){for(let n of this.heap)n.goto(e,t);for(let n=this.heap.length>>1;n>=0;n--)Ac(this.heap,n);return this.next(),this}forward(e,t){for(let n of this.heap)n.forward(e,t);for(let n=this.heap.length>>1;n>=0;n--)Ac(this.heap,n);(this.to-e||this.value.endSide-t)<0&&this.next()}next(){if(0==this.heap.length)this.from=this.to=1e9,this.value=null,this.rank=-1;else{let e=this.heap[0];this.from=e.from,this.to=e.to,this.value=e.value,this.rank=e.rank,e.value&&e.next(),Ac(this.heap,0)}}}function Ac(e,t){for(let n=e[t];;){let i=1+(t<<1);if(i>=e.length)break;let a=e[i];if(i+1<e.length&&a.compare(e[i+1])>=0&&(a=e[i+1],i++),n.compare(a)<0)break;e[i]=n,e[t]=a,t=i}}class Ec{constructor(e,t,n){this.minPoint=n,this.active=[],this.activeTo=[],this.activeRank=[],this.minActive=-1,this.point=null,this.pointFrom=0,this.pointRank=0,this.to=-1e9,this.endSide=0,this.openStart=-1,this.cursor=Mc.from(e,t,n)}goto(e,t=-1e9){return this.cursor.goto(e,t),this.active.length=this.activeTo.length=this.activeRank.length=0,this.minActive=-1,this.to=e,this.endSide=t,this.openStart=-1,this.next(),this}forward(e,t){for(;this.minActive>-1&&(this.activeTo[this.minActive]-e||this.active[this.minActive].endSide-t)<0;)this.removeActive(this.minActive);this.cursor.forward(e,t)}removeActive(e){Rc(this.active,e),Rc(this.activeTo,e),Rc(this.activeRank,e),this.minActive=Oc(this.active,this.activeTo)}addActive(e){let t=0,{value:n,to:i,rank:a}=this.cursor;for(;t<this.activeRank.length&&(a-this.activeRank[t]||i-this.activeTo[t])>0;)t++;$c(this.active,t,n),$c(this.activeTo,t,i),$c(this.activeRank,t,a),e&&$c(e,t,this.cursor.from),this.minActive=Oc(this.active,this.activeTo)}next(){let e=this.to,t=this.point;this.point=null;let n=this.openStart<0?[]:null;for(;;){let i=this.minActive;if(i>-1&&(this.activeTo[i]-this.cursor.from||this.active[i].endSide-this.cursor.startSide)<0){if(this.activeTo[i]>e){this.to=this.activeTo[i],this.endSide=this.active[i].endSide;break}this.removeActive(i),n&&Rc(n,i)}else{if(!this.cursor.value){this.to=this.endSide=1e9;break}if(this.cursor.from>e){this.to=this.cursor.from,this.endSide=this.cursor.startSide;break}{let e=this.cursor.value;if(e.point){if(!(t&&this.cursor.to==this.to&&this.cursor.from<this.cursor.to)){this.point=e,this.pointFrom=this.cursor.from,this.pointRank=this.cursor.rank,this.to=this.cursor.to,this.endSide=e.endSide,this.cursor.next(),this.forward(this.to,this.endSide);break}this.cursor.next()}else this.addActive(n),this.cursor.next()}}}if(n){this.openStart=0;for(let t=n.length-1;t>=0&&n[t]<e;t--)this.openStart++}}activeForPoint(e){if(!this.active.length)return this.active;let t=[];for(let n=this.active.length-1;n>=0&&!(this.activeRank[n]<this.pointRank);n--)(this.activeTo[n]>e||this.activeTo[n]==e&&this.active[n].endSide>=this.point.endSide)&&t.push(this.active[n]);return t.reverse()}openEnd(e){let t=0;for(let n=this.activeTo.length-1;n>=0&&this.activeTo[n]>e;n--)t++;return t}}function zc(e,t,n,i,a,r){e.goto(t),n.goto(i);let s=i+a,o=i,l=i-t;for(;;){let t=e.to+l-n.to,i=t||e.endSide-n.endSide,a=i<0?e.to+l:n.to,c=Math.min(a,s);if(e.point||n.point?e.point&&n.point&&(e.point==n.point||e.point.eq(n.point))&&Pc(e.activeForPoint(e.to),n.activeForPoint(n.to))||r.comparePoint(o,c,e.point,n.point):c>o&&!Pc(e.active,n.active)&&r.compareRange(o,c,e.active,n.active),a>s)break;(t||e.openEnd!=n.openEnd)&&r.boundChange&&r.boundChange(a),o=a,i<=0&&e.next(),i>=0&&n.next()}}function Pc(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!=t[n]&&!e[n].eq(t[n]))return!1;return!0}function Rc(e,t){for(let n=t,i=e.length-1;n<i;n++)e[n]=e[n+1];e.pop()}function $c(e,t,n){for(let i=e.length-1;i>=t;i--)e[i+1]=e[i];e[t]=n}function Oc(e,t){let n=-1,i=1e9;for(let a=0;a<t.length;a++)(t[a]-i||e[a].endSide-e[n].endSide)<0&&(n=a,i=t[a]);return n}for(var Lc={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},Nc={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},Fc=0;Fc<10;Fc++)Lc[48+Fc]=Lc[96+Fc]=String(Fc);for(Fc=1;Fc<=24;Fc++)Lc[Fc+111]="F"+Fc;for(Fc=65;Fc<=90;Fc++)Lc[Fc]=String.fromCharCode(Fc+32),Nc[Fc]=String.fromCharCode(Fc);for(var Bc in Lc)Nc.hasOwnProperty(Bc)||(Nc[Bc]=Lc[Bc]);function jc(e){return 3==e.nodeType?Wc(e,0,e.nodeValue.length).getClientRects():1==e.nodeType?e.getClientRects():[]}function Uc(e){for(var t=0;;t++)if(!(e=e.previousSibling))return t}function Vc(e,t){let n=t?e.left:e.right;return{left:n,right:n,top:e.top,bottom:e.bottom}}let qc,Hc=null;function Wc(e,t,n=t){let i=qc||(qc=document.createRange());return i.setEnd(e,n),i.setStart(e,t),i}function Gc(e,t,n,i){let a={key:t,code:t,keyCode:n,which:n,cancelable:!0},r=new KeyboardEvent("keydown",a);r.synthetic=!0,e.dispatchEvent(r);let s=new KeyboardEvent("keyup",a);return s.synthetic=!0,e.dispatchEvent(s),r.defaultPrevented||s.defaultPrevented}function Qc(e){for(;e.attributes.length;)e.removeAttributeNode(e.attributes[0])}class Kc{constructor(e,t,n=!0){this.node=e,this.offset=t,this.precise=n}static before(e,t){return new Kc(e.parentNode,Uc(e),t)}static after(e,t){return new Kc(e.parentNode,Uc(e)+1,t)}}const Zc=[];class Yc{constructor(){this.parent=null,this.dom=null,this.flags=2}get overrideDOMText(){return null}get posAtStart(){return this.parent?this.parent.posBefore(this):0}get posAtEnd(){return this.posAtStart+this.length}posBefore(e){let t=this.posAtStart;for(let n of this.children){if(n==e)return t;t+=n.length+n.breakAfter}throw new RangeError("Invalid child in posBefore")}posAfter(e){return this.posBefore(e)+e.length}sync(e,t){if(2&this.flags){let n,i=this.dom,a=null;for(let r of this.children){if(7&r.flags){if(!r.dom&&(n=a?a.nextSibling:i.firstChild)){let e=Yc.get(n);(!e||!e.parent&&e.canReuseDOM(r))&&r.reuseDOM(n)}r.sync(e,t),r.flags&=-8}if(n=a?a.nextSibling:i.firstChild,t&&!t.written&&t.node==i&&n!=r.dom&&(t.written=!0),r.dom.parentNode==i)for(;n&&n!=r.dom;)n=Xc(n);else i.insertBefore(r.dom,n);a=r.dom}for(n=a?a.nextSibling:i.firstChild,n&&t&&t.node==i&&(t.written=!0);n;)n=Xc(n)}else if(1&this.flags)for(let n of this.children)7&n.flags&&(n.sync(e,t),n.flags&=-8)}reuseDOM(e){}localPosFromDOM(e,t){let n;if(e==this.dom)n=this.dom.childNodes[t];else{let i=0==function(e){return 3==e.nodeType?e.nodeValue.length:e.childNodes.length}(e)?0:0==t?-1:1;for(;;){let t=e.parentNode;if(t==this.dom)break;0==i&&t.firstChild!=t.lastChild&&(i=e==t.firstChild?-1:1),e=t}n=i<0?e:e.nextSibling}if(n==this.dom.firstChild)return 0;for(;n&&!Yc.get(n);)n=n.nextSibling;if(!n)return this.length;for(let i=0,a=0;;i++){let e=this.children[i];if(e.dom==n)return a;a+=e.length+e.breakAfter}}domBoundsAround(e,t,n=0){let i=-1,a=-1,r=-1,s=-1;for(let o=0,l=n,c=n;o<this.children.length;o++){let n=this.children[o],d=l+n.length;if(l<e&&d>t)return n.domBoundsAround(e,t,l);if(d>=e&&-1==i&&(i=o,a=l),l>t&&n.dom.parentNode==this.dom){r=o,s=c;break}c=d,l=d+n.breakAfter}return{from:a,to:s<0?n+this.length:s,startDOM:(i?this.children[i-1].dom.nextSibling:null)||this.dom.firstChild,endDOM:r<this.children.length&&r>=0?this.children[r].dom:null}}markDirty(e=!1){this.flags|=2,this.markParentsDirty(e)}markParentsDirty(e){for(let t=this.parent;t;t=t.parent){if(e&&(t.flags|=2),1&t.flags)return;t.flags|=1,e=!1}}setParent(e){this.parent!=e&&(this.parent=e,7&this.flags&&this.markParentsDirty(!0))}setDOM(e){this.dom!=e&&(this.dom&&(this.dom.cmView=null),this.dom=e,e.cmView=this)}get rootView(){for(let e=this;;){let t=e.parent;if(!t)return e;e=t}}replaceChildren(e,t,n=Zc){this.markDirty();for(let i=e;i<t;i++){let e=this.children[i];e.parent==this&&n.indexOf(e)<0&&e.destroy()}n.length<250?this.children.splice(e,t-e,...n):this.children=[].concat(this.children.slice(0,e),n,this.children.slice(t));for(let i=0;i<n.length;i++)n[i].setParent(this)}ignoreMutation(e){return!1}ignoreEvent(e){return!1}childCursor(e=this.length){return new Jc(this.children,e,this.children.length)}childPos(e,t=1){return this.childCursor().findPos(e,t)}toString(){let e=this.constructor.name.replace("View","");return e+(this.children.length?"("+this.children.join()+")":this.length?"["+("Text"==e?this.text:this.length)+"]":"")+(this.breakAfter?"#":"")}static get(e){return e.cmView}get isEditable(){return!0}get isWidget(){return!1}get isHidden(){return!1}merge(e,t,n,i,a,r){return!1}become(e){return!1}canReuseDOM(e){return e.constructor==this.constructor&&!(8&(this.flags|e.flags))}getSide(){return 0}destroy(){for(let e of this.children)e.parent==this&&e.destroy();this.parent=null}}function Xc(e){let t=e.nextSibling;return e.parentNode.removeChild(e),t}Yc.prototype.breakAfter=0;class Jc{constructor(e,t,n){this.children=e,this.pos=t,this.i=n,this.off=0}findPos(e,t=1){for(;;){if(e>this.pos||e==this.pos&&(t>0||0==this.i||this.children[this.i-1].breakAfter))return this.off=e-this.pos,this;let n=this.children[--this.i];this.pos-=n.length+n.breakAfter}}}function ed(e,t,n,i,a,r){let s=e.childCursor(),{i:o,off:l}=s.findPos(n,1),{i:c,off:d}=s.findPos(t,-1),u=t-n;for(let h of i)u+=h.length;e.length+=u,function(e,t,n,i,a,r,s,o,l){let{children:c}=e,d=c.length?c[t]:null,u=r.length?r[r.length-1]:null,h=u?u.breakAfter:s;if(!(t==i&&d&&!s&&!h&&r.length<2&&d.merge(n,a,r.length?u:null,0==n,o,l))){if(i<c.length){let e=c[i];e&&(a<e.length||e.breakAfter&&(null==u?void 0:u.breakAfter))?(t==i&&(e=e.split(a),a=0),!h&&u&&e.merge(0,a,u,!0,0,l)?r[r.length-1]=e:((a||e.children.length&&!e.children[0].length)&&e.merge(0,a,null,!1,0,l),r.push(e))):(null==e?void 0:e.breakAfter)&&(u?u.breakAfter=1:s=1),i++}for(d&&(d.breakAfter=s,n>0&&(!s&&r.length&&d.merge(n,d.length,r[0],!1,o,0)?d.breakAfter=r.shift().breakAfter:(n<d.length||d.children.length&&0==d.children[d.children.length-1].length)&&d.merge(n,d.length,null,!1,o,0),t++));t<i&&r.length;)if(c[i-1].become(r[r.length-1]))i--,r.pop(),l=r.length?0:o;else{if(!c[t].become(r[0]))break;t++,r.shift(),o=r.length?0:l}!r.length&&t&&i<c.length&&!c[t-1].breakAfter&&c[i].merge(0,0,c[t-1],!1,o,l)&&t--,(t<i||r.length)&&e.replaceChildren(t,i,r)}}(e,c,d,o,l,i,0,a,r)}let td="undefined"!=typeof navigator?navigator:{userAgent:"",vendor:"",platform:""},nd="undefined"!=typeof document?document:{documentElement:{style:{}}};const id=/Edge\/(\d+)/.exec(td.userAgent),ad=/MSIE \d/.test(td.userAgent),rd=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(td.userAgent),sd=!!(ad||rd||id),od=!sd&&/gecko\/(\d+)/i.test(td.userAgent),ld=!sd&&/Chrome\/(\d+)/.exec(td.userAgent),cd="webkitFontSmoothing"in nd.documentElement.style,dd=!sd&&/Apple Computer/.test(td.vendor),ud=dd&&(/Mobile\/\w+/.test(td.userAgent)||td.maxTouchPoints>2);var hd={mac:ud||/Mac/.test(td.platform),ie:sd,ie_version:ad?nd.documentMode||6:rd?+rd[1]:id?+id[1]:0,gecko:od,gecko_version:od?+(/Firefox\/(\d+)/.exec(td.userAgent)||[0,0])[1]:0,chrome:!!ld,chrome_version:ld?+ld[1]:0,ios:ud,android:/Android\b/.test(td.userAgent),safari:dd,webkit_version:cd?+(/\bAppleWebKit\/(\d+)/.exec(td.userAgent)||[0,0])[1]:0,tabSize:null!=nd.documentElement.style.tabSize?"tab-size":"-moz-tab-size"};class pd extends Yc{constructor(e){super(),this.text=e}get length(){return this.text.length}createDOM(e){this.setDOM(e||document.createTextNode(this.text))}sync(e,t){this.dom||this.createDOM(),this.dom.nodeValue!=this.text&&(t&&t.node==this.dom&&(t.written=!0),this.dom.nodeValue=this.text)}reuseDOM(e){3==e.nodeType&&this.createDOM(e)}merge(e,t,n){return!(8&this.flags||n&&(!(n instanceof pd)||this.length-(t-e)+n.length>256||8&n.flags))&&(this.text=this.text.slice(0,e)+(n?n.text:"")+this.text.slice(t),this.markDirty(),!0)}split(e){let t=new pd(this.text.slice(e));return this.text=this.text.slice(0,e),this.markDirty(),t.flags|=8&this.flags,t}localPosFromDOM(e,t){return e==this.dom?t:t?this.text.length:0}domAtPos(e){return new Kc(this.dom,e)}domBoundsAround(e,t,n){return{from:n,to:n+this.length,startDOM:this.dom,endDOM:this.dom.nextSibling}}coordsAt(e,t){return function(e,t,n){let i=e.nodeValue.length;t>i&&(t=i);let a=t,r=t,s=0;0==t&&n<0||t==i&&n>=0?hd.chrome||hd.gecko||(t?(a--,s=1):r<i&&(r++,s=-1)):n<0?a--:r<i&&r++;let o=Wc(e,a,r).getClientRects();if(!o.length)return null;let l=o[(s?s<0:n>=0)?0:o.length-1];hd.safari&&!s&&0==l.width&&(l=Array.prototype.find.call(o,e=>e.width)||l);return s?Vc(l,s<0):l||null}(this.dom,e,t)}}class gd extends Yc{constructor(e,t=[],n=0){super(),this.mark=e,this.children=t,this.length=n;for(let i of t)i.setParent(this)}setAttrs(e){if(Qc(e),this.mark.class&&(e.className=this.mark.class),this.mark.attrs)for(let t in this.mark.attrs)e.setAttribute(t,this.mark.attrs[t]);return e}canReuseDOM(e){return super.canReuseDOM(e)&&!(8&(this.flags|e.flags))}reuseDOM(e){e.nodeName==this.mark.tagName.toUpperCase()&&(this.setDOM(e),this.flags|=6)}sync(e,t){this.dom?4&this.flags&&this.setAttrs(this.dom):this.setDOM(this.setAttrs(document.createElement(this.mark.tagName))),super.sync(e,t)}merge(e,t,n,i,a,r){return(!n||!(!(n instanceof gd&&n.mark.eq(this.mark))||e&&a<=0||t<this.length&&r<=0))&&(ed(this,e,t,n?n.children.slice():[],a-1,r-1),this.markDirty(),!0)}split(e){let t=[],n=0,i=-1,a=0;for(let s of this.children){let r=n+s.length;r>e&&t.push(n<e?s.split(e-n):s),i<0&&n>=e&&(i=a),n=r,a++}let r=this.length-e;return this.length=e,i>-1&&(this.children.length=i,this.markDirty()),new gd(this.mark,t,r)}domAtPos(e){return md(this,e)}coordsAt(e,t){return bd(this,e,t)}}class vd extends Yc{static create(e,t,n){return new vd(e,t,n)}constructor(e,t,n){super(),this.widget=e,this.length=t,this.side=n,this.prevWidget=null}split(e){let t=vd.create(this.widget,this.length-e,this.side);return this.length-=e,t}sync(e){this.dom&&this.widget.updateDOM(this.dom,e)||(this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom),this.prevWidget=null,this.setDOM(this.widget.toDOM(e)),this.widget.editable||(this.dom.contentEditable="false"))}getSide(){return this.side}merge(e,t,n,i,a,r){return!(n&&(!(n instanceof vd&&this.widget.compare(n.widget))||e>0&&a<=0||t<this.length&&r<=0))&&(this.length=e+(n?n.length:0)+(this.length-t),!0)}become(e){return e instanceof vd&&e.side==this.side&&this.widget.constructor==e.widget.constructor&&(this.widget.compare(e.widget)||this.markDirty(!0),this.dom&&!this.prevWidget&&(this.prevWidget=this.widget),this.widget=e.widget,this.length=e.length,!0)}ignoreMutation(){return!0}ignoreEvent(e){return this.widget.ignoreEvent(e)}get overrideDOMText(){if(0==this.length)return hl.empty;let e=this;for(;e.parent;)e=e.parent;let{view:t}=e,n=t&&t.state.doc,i=this.posAtStart;return n?n.slice(i,i+this.length):hl.empty}domAtPos(e){return(this.length?0==e:this.side>0)?Kc.before(this.dom):Kc.after(this.dom,e==this.length)}domBoundsAround(){return null}coordsAt(e,t){let n=this.widget.coordsAt(this.dom,e,t);if(n)return n;let i=this.dom.getClientRects(),a=null;if(!i.length)return null;let r=this.side?this.side<0:e>0;for(let s=r?i.length-1:0;a=i[s],!(e>0?0==s:s==i.length-1||a.top<a.bottom);s+=r?-1:1);return Vc(a,!r)}get isEditable(){return!1}get isWidget(){return!0}get isHidden(){return this.widget.isHidden}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}}class fd extends Yc{constructor(e){super(),this.side=e}get length(){return 0}merge(){return!1}become(e){return e instanceof fd&&e.side==this.side}split(){return new fd(this.side)}sync(){if(!this.dom){let e=document.createElement("img");e.className="cm-widgetBuffer",e.setAttribute("aria-hidden","true"),this.setDOM(e)}}getSide(){return this.side}domAtPos(e){return this.side>0?Kc.before(this.dom):Kc.after(this.dom)}localPosFromDOM(){return 0}domBoundsAround(){return null}coordsAt(e){return this.dom.getBoundingClientRect()}get overrideDOMText(){return hl.empty}get isHidden(){return!0}}function md(e,t){let n=e.dom,{children:i}=e,a=0;for(let r=0;a<i.length;a++){let e=i[a],s=r+e.length;if(!(s==r&&e.getSide()<=0)){if(t>r&&t<s&&e.dom.parentNode==n)return e.domAtPos(t-r);if(t<=r)break;r=s}}for(let r=a;r>0;r--){let e=i[r-1];if(e.dom.parentNode==n)return e.domAtPos(e.length)}for(let r=a;r<i.length;r++){let e=i[r];if(e.dom.parentNode==n)return e.domAtPos(0)}return new Kc(n,0)}function yd(e,t,n){let i,{children:a}=e;n>0&&t instanceof gd&&a.length&&(i=a[a.length-1])instanceof gd&&i.mark.eq(t.mark)?yd(i,t.children[0],n-1):(a.push(t),t.setParent(e)),e.length+=t.length}function bd(e,t,n){let i=null,a=-1,r=null,s=-1;!function e(t,o){for(let l=0,c=0;l<t.children.length&&c<=o;l++){let d=t.children[l],u=c+d.length;u>=o&&(d.children.length?e(d,o-c):(!r||r.isHidden&&(n>0||wd(r,d)))&&(u>o||c==u&&d.getSide()>0)?(r=d,s=o-c):(c<o||c==u&&d.getSide()<0&&!d.isHidden)&&(i=d,a=o-c)),c=u}}(e,t);let o=(n<0?i:r)||i||r;return o?o.coordsAt(Math.max(0,o==i?a:s),n):function(e){let t=e.dom.lastChild;if(!t)return e.dom.getBoundingClientRect();let n=jc(t);return n[n.length-1]||null}(e)}function wd(e,t){let n=e.coordsAt(0,1),i=t.coordsAt(0,1);return n&&i&&i.top<n.bottom}function kd(e,t){for(let n in e)"class"==n&&t.class?t.class+=" "+e.class:"style"==n&&t.style?t.style+=";"+e.style:t[n]=e[n];return t}pd.prototype.children=vd.prototype.children=fd.prototype.children=Zc;const Sd=Object.create(null);function xd(e,t,n){if(e==t)return!0;e||(e=Sd),t||(t=Sd);let i=Object.keys(e),a=Object.keys(t);if(i.length-(n&&i.indexOf(n)>-1?1:0)!=a.length-(n&&a.indexOf(n)>-1?1:0))return!1;for(let r of i)if(r!=n&&(-1==a.indexOf(r)||e[r]!==t[r]))return!1;return!0}var _d=function(e){return e[e.Text=0]="Text",e[e.WidgetBefore=1]="WidgetBefore",e[e.WidgetAfter=2]="WidgetAfter",e[e.WidgetRange=3]="WidgetRange",e}(_d||(_d={}));class Cd extends kc{constructor(e,t,n,i){super(),this.startSide=e,this.endSide=t,this.widget=n,this.spec=i}get heightRelevant(){return!1}static mark(e){return new Id(e)}static widget(e){let t=Math.max(-1e4,Math.min(1e4,e.side||0)),n=!!e.block;return t+=n&&!e.inlineOrder?t>0?3e8:-4e8:t>0?1e8:-1e8,new Td(e,t,t,n,e.widget||null,!1)}static replace(e){let t,n,i=!!e.block;if(e.isBlockGap)t=-5e8,n=4e8;else{let{start:a,end:r}=Md(e,i);t=(a?i?-3e8:-1:5e8)-1,n=1+(r?i?2e8:1:-6e8)}return new Td(e,t,n,i,e.widget||null,!0)}static line(e){return new Dd(e)}static set(e,t=!1){return Cc.of(e,t)}hasHeight(){return!!this.widget&&this.widget.estimatedHeight>-1}}Cd.none=Cc.empty;class Id extends Cd{constructor(e){let{start:t,end:n}=Md(e);super(t?-1:5e8,n?1:-6e8,null,e),this.tagName=e.tagName||"span",this.class=e.class||"",this.attrs=e.attributes||null}eq(e){var t,n;return this==e||e instanceof Id&&this.tagName==e.tagName&&(this.class||(null===(t=this.attrs)||void 0===t?void 0:t.class))==(e.class||(null===(n=e.attrs)||void 0===n?void 0:n.class))&&xd(this.attrs,e.attrs,"class")}range(e,t=e){if(e>=t)throw new RangeError("Mark decorations may not be empty");return super.range(e,t)}}Id.prototype.point=!1;class Dd extends Cd{constructor(e){super(-2e8,-2e8,null,e)}eq(e){return e instanceof Dd&&this.spec.class==e.spec.class&&xd(this.spec.attributes,e.spec.attributes)}range(e,t=e){if(t!=e)throw new RangeError("Line decoration ranges must be zero-length");return super.range(e,t)}}Dd.prototype.mapMode=_l.TrackBefore,Dd.prototype.point=!0;class Td extends Cd{constructor(e,t,n,i,a,r){super(t,n,a,e),this.block=i,this.isReplace=r,this.mapMode=i?t<=0?_l.TrackBefore:_l.TrackAfter:_l.TrackDel}get type(){return this.startSide!=this.endSide?_d.WidgetRange:this.startSide<=0?_d.WidgetBefore:_d.WidgetAfter}get heightRelevant(){return this.block||!!this.widget&&(this.widget.estimatedHeight>=5||this.widget.lineBreaks>0)}eq(e){return e instanceof Td&&(t=this.widget,n=e.widget,t==n||!!(t&&n&&t.compare(n)))&&this.block==e.block&&this.startSide==e.startSide&&this.endSide==e.endSide;var t,n}range(e,t=e){if(this.isReplace&&(e>t||e==t&&this.startSide>0&&this.endSide<=0))throw new RangeError("Invalid range for replacement decoration");if(!this.isReplace&&t!=e)throw new RangeError("Widget decorations can only have zero-length ranges");return super.range(e,t)}}function Md(e,t=!1){let{inclusiveStart:n,inclusiveEnd:i}=e;return null==n&&(n=e.inclusive),null==i&&(i=e.inclusive),{start:null!=n?n:t,end:null!=i?i:t}}Td.prototype.point=!0;let Ad=class e extends Yc{constructor(){super(...arguments),this.children=[],this.length=0,this.prevAttrs=void 0,this.attrs=null,this.breakAfter=0}merge(t,n,i,a,r,s){if(i){if(!(i instanceof e))return!1;this.dom||i.transferDOM(this)}return a&&this.setDeco(i?i.attrs:null),ed(this,t,n,i?i.children.slice():[],r,s),!0}split(t){let n=new e;if(n.breakAfter=this.breakAfter,0==this.length)return n;let{i:i,off:a}=this.childPos(t);a&&(n.append(this.children[i].split(a),0),this.children[i].merge(a,this.children[i].length,null,!1,0,0),i++);for(let e=i;e<this.children.length;e++)n.append(this.children[e],0);for(;i>0&&0==this.children[i-1].length;)this.children[--i].destroy();return this.children.length=i,this.markDirty(),this.length=t,n}transferDOM(e){this.dom&&(this.markDirty(),e.setDOM(this.dom),e.prevAttrs=void 0===this.prevAttrs?this.attrs:this.prevAttrs,this.prevAttrs=void 0,this.dom=null)}setDeco(e){xd(this.attrs,e)||(this.dom&&(this.prevAttrs=this.attrs,this.markDirty()),this.attrs=e)}append(e,t){yd(this,e,t)}addLineDeco(e){let t=e.spec.attributes,n=e.spec.class;t&&(this.attrs=kd(t,this.attrs||{})),n&&(this.attrs=kd({class:n},this.attrs||{}))}domAtPos(e){return md(this,e)}reuseDOM(e){"DIV"==e.nodeName&&(this.setDOM(e),this.flags|=6)}sync(e,t){var n;this.dom?4&this.flags&&(Qc(this.dom),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0):(this.setDOM(document.createElement("div")),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0),void 0!==this.prevAttrs&&(!function(e,t,n){let i=!1;if(t)for(let a in t)n&&a in n||(i=!0,"style"==a?e.style.cssText="":e.removeAttribute(a));if(n)for(let a in n)t&&t[a]==n[a]||(i=!0,"style"==a?e.style.cssText=n[a]:e.setAttribute(a,n[a]))}(this.dom,this.prevAttrs,this.attrs),this.dom.classList.add("cm-line"),this.prevAttrs=void 0),super.sync(e,t);let i=this.dom.lastChild;for(;i&&Yc.get(i)instanceof gd;)i=i.lastChild;if(!(i&&this.length&&("BR"==i.nodeName||0!=(null===(n=Yc.get(i))||void 0===n?void 0:n.isEditable)||hd.ios&&this.children.some(e=>e instanceof pd)))){let e=document.createElement("BR");e.cmIgnore=!0,this.dom.appendChild(e)}}measureTextSize(){if(0==this.children.length||this.length>20)return null;let e,t=0;for(let n of this.children){if(!(n instanceof pd)||/[^ -~]/.test(n.text))return null;let i=jc(n.dom);if(1!=i.length)return null;t+=i[0].width,e=i[0].height}return t?{lineHeight:this.dom.getBoundingClientRect().height,charWidth:t/this.length,textHeight:e}:null}coordsAt(e,t){let n=bd(this,e,t);if(!this.children.length&&n&&this.parent){let{heightOracle:e}=this.parent.view.viewState,t=n.bottom-n.top;if(Math.abs(t-e.lineHeight)<2&&e.textHeight<t){let i=(t-e.textHeight)/2;return{top:n.top+i,bottom:n.bottom-i,left:n.left,right:n.left}}}return n}become(t){return t instanceof e&&0==this.children.length&&0==t.children.length&&xd(this.attrs,t.attrs)&&this.breakAfter==t.breakAfter}covers(){return!0}static find(t,n){for(let i=0,a=0;i<t.children.length;i++){let r=t.children[i],s=a+r.length;if(s>=n){if(r instanceof e)return r;if(s>n)break}a=s+r.breakAfter}return null}};var Ed=function(e){return e[e.LTR=0]="LTR",e[e.RTL=1]="RTL",e}(Ed||(Ed={}));Ed.LTR,Ed.RTL;const zd=Object.create(null);for(let wx of["()","[]","{}"]){let e=wx.charCodeAt(0),t=wx.charCodeAt(1);zd[e]=t,zd[t]=-e}const Pd=Ll.define(),Rd=Ll.define(),$d=Ll.define(),Od=Ll.define(),Ld=Ll.define(),Nd=Ll.define(),Fd=Ll.define();let Bd=0;const jd=Ll.define({combine:e=>e.filter((t,n)=>{for(let i=0;i<n;i++)if(e[i].plugin==t.plugin)return!1;return!0})});class Ud{constructor(e,t,n,i,a){this.id=e,this.create=t,this.domEventHandlers=n,this.domEventObservers=i,this.baseExtensions=a(this),this.extension=this.baseExtensions.concat(jd.of({plugin:this,arg:void 0}))}of(e){return this.baseExtensions.concat(jd.of({plugin:this,arg:e}))}static define(e,t){const{eventHandlers:n,eventObservers:i,provide:a,decorations:r}=t||{};return new Ud(Bd++,e,n,i,e=>{let t=[];return r&&t.push(Vd.of(t=>{let n=t.plugin(e);return n?r(n):Cd.none})),a&&t.push(a(e)),t})}static fromClass(e,t){return Ud.define((t,n)=>new e(t,n),t)}}const Vd=Ll.define(),qd=Ll.define(),Hd=Ll.define();function Wd(e,t,n){for(;;){let i=0;for(let a of e)a.between(t-1,t+1,(e,a,r)=>{if(t>e&&t<a){let r=i||n||(t-e<a-t?-1:1);t=r<0?e:a,i=r}});if(!i)return t}}function Gd(e,t,n,i=-1){if(hd.ios&&e.inputState.flushIOSKey(t))return!0;let a=e.state.selection.main;if(hd.android&&(t.to==a.to&&(t.from==a.from||t.from==a.from-1&&" "==e.state.sliceDoc(t.from,a.from))&&1==t.insert.length&&2==t.insert.lines&&Gc(e.contentDOM,"Enter",13)||(t.from==a.from-1&&t.to==a.to&&0==t.insert.length||8==i&&t.insert.length<t.to-t.from&&t.to>a.head)&&Gc(e.contentDOM,"Backspace",8)||t.from==a.from&&t.to==a.to+1&&0==t.insert.length&&Gc(e.contentDOM,"Delete",46)))return!0;let r,s=t.insert.toString();e.inputState.composing>=0&&e.inputState.composing++;let o=()=>r||(r=function(e,t){let n,i=e.state,a=i.selection.main;if(t.from>=a.from&&t.to<=a.to&&t.to-t.from>=(a.to-a.from)/3&&e.inputState.composing<0){let r=a.from<t.from?i.sliceDoc(a.from,t.from):"",s=a.to>t.to?i.sliceDoc(t.to,a.to):"";n=i.replaceSelection(e.state.toText(r+t.insert.sliceString(0,void 0,e.state.lineBreak)+s))}else{let r,s=i.changes(t);if(i.selection.ranges.length>1&&e.inputState.composing>=0&&t.to<=a.to&&t.to>=a.to-10){let r,o=e.state.sliceDoc(t.from,t.to);r=e.state.doc.lineAt(a.head);let l=a.to-t.to,c=a.to-a.from;n=i.changeByRange(n=>{if(n.from==a.from&&n.to==a.to)return{changes:s,range:n.map(s)};let d=n.to-l,u=d-o.length;if(n.to-n.from!=c||e.state.sliceDoc(u,d)!=o||n.to>=r.from&&n.from<=r.to)return{range:n};let h=i.changes({from:u,to:d,insert:t.insert});return n.to,a.to,{changes:h,range:n.map(h)}})}else n={changes:s,selection:r}}let r="input.type";(e.composing||e.inputState.compositionPendingChange&&e.inputState.compositionEndedAt>Date.now()-50)&&(e.inputState.compositionPendingChange=!1,r+=".compose",e.inputState.compositionFirstChange&&(r+=".start",e.inputState.compositionFirstChange=!1));return i.update(n,{userEvent:r,scrollIntoView:!0})}(e,t));return e.state.facet(Od).some(n=>n(e,t.from,t.to,s,o))||e.dispatch(o()),!0}const Qd=[{key:"Backspace",keyCode:8,inputType:"deleteContentBackward"},{key:"Enter",keyCode:13,inputType:"insertParagraph"},{key:"Enter",keyCode:13,inputType:"insertLineBreak"},{key:"Delete",keyCode:46,inputType:"deleteContentForward"}];function Kd(e){return.7*Math.max(0,e)+8}class Zd{constructor(e,t,n,i){this.view=e,this.startEvent=t,this.style=n,this.mustSelect=i,this.scrollSpeed={x:0,y:0},this.scrolling=-1,this.lastEvent=t,this.scrollParents=function(e){let t,n,i=e.ownerDocument;for(let a=e.parentNode;a&&!(a==i.body||t&&n);)if(1==a.nodeType)!n&&a.scrollHeight>a.clientHeight&&(n=a),!t&&a.scrollWidth>a.clientWidth&&(t=a),a=a.assignedSlot||a.parentNode;else{if(11!=a.nodeType)break;a=a.host}return{x:t,y:n}}(e.contentDOM),this.atoms=e.state.facet(qd).map(t=>t(e));let a=e.contentDOM.ownerDocument;a.addEventListener("mousemove",this.move=this.move.bind(this)),a.addEventListener("mouseup",this.up=this.up.bind(this)),this.extend=t.shiftKey,this.multiple=e.state.facet(wc.allowMultipleSelections)&&function(e,t){let n=e.state.facet(Pd);return n.length?n[0](t):hd.mac?t.metaKey:t.ctrlKey}(e,t),this.dragging=!(!function(e,t){let{main:n}=e.state.selection;if(n.empty)return!1;let i=function(e){let t;return t=11==e.nodeType?e.getSelection?e:e.ownerDocument:e,t.getSelection()}(e.root);if(!i||0==i.rangeCount)return!0;let a=i.getRangeAt(0).getClientRects();for(let r=0;r<a.length;r++){let e=a[r];if(e.left<=t.clientX&&e.right>=t.clientX&&e.top<=t.clientY&&e.bottom>=t.clientY)return!0}return!1}(e,t)||1!=du(t))&&null}start(e){!1===this.dragging&&this.select(e)}move(e){if(0==e.buttons)return this.destroy();if(this.dragging||null==this.dragging&&(t=this.startEvent,n=e,Math.max(Math.abs(t.clientX-n.clientX),Math.abs(t.clientY-n.clientY))<10))return;var t,n;this.select(this.lastEvent=e);let i=0,a=0,r=0,s=0,o=this.view.win.innerWidth,l=this.view.win.innerHeight;this.scrollParents.x&&({left:r,right:o}=this.scrollParents.x.getBoundingClientRect()),this.scrollParents.y&&({top:s,bottom:l}=this.scrollParents.y.getBoundingClientRect());let c=function(e){let t=0,n=0,i=0,a=0;for(let r of e.state.facet(Hd)){let s=r(e);s&&(null!=s.left&&(t=Math.max(t,s.left)),null!=s.right&&(n=Math.max(n,s.right)),null!=s.top&&(i=Math.max(i,s.top)),null!=s.bottom&&(a=Math.max(a,s.bottom)))}return{left:t,right:n,top:i,bottom:a}}(this.view);e.clientX-c.left<=r+6?i=-Kd(r-e.clientX):e.clientX+c.right>=o-6&&(i=Kd(e.clientX-o)),e.clientY-c.top<=s+6?a=-Kd(s-e.clientY):e.clientY+c.bottom>=l-6&&(a=Kd(e.clientY-l)),this.setScrollSpeed(i,a)}up(e){null==this.dragging&&this.select(this.lastEvent),this.dragging||e.preventDefault(),this.destroy()}destroy(){this.setScrollSpeed(0,0);let e=this.view.contentDOM.ownerDocument;e.removeEventListener("mousemove",this.move),e.removeEventListener("mouseup",this.up),this.view.inputState.mouseSelection=this.view.inputState.draggedContent=null}setScrollSpeed(e,t){this.scrollSpeed={x:e,y:t},e||t?this.scrolling<0&&(this.scrolling=setInterval(()=>this.scroll(),50)):this.scrolling>-1&&(clearInterval(this.scrolling),this.scrolling=-1)}scroll(){let{x:e,y:t}=this.scrollSpeed;e&&this.scrollParents.x&&(this.scrollParents.x.scrollLeft+=e,e=0),t&&this.scrollParents.y&&(this.scrollParents.y.scrollTop+=t,t=0),(e||t)&&this.view.win.scrollBy(e,t),!1===this.dragging&&this.select(this.lastEvent)}skipAtoms(e){let t=null;for(let n=0;n<e.ranges.length;n++){let i=e.ranges[n],a=null;if(i.empty){let e=Wd(this.atoms,i.from,0);e!=i.from&&(a=Rl.cursor(e,-1))}else{let e=Wd(this.atoms,i.from,-1),t=Wd(this.atoms,i.to,1);e==i.from&&t==i.to||(a=Rl.range(i.from==i.anchor?e:t,i.from==i.head?e:t))}a&&(t||(t=e.ranges.slice()),t[n]=a)}return t?Rl.create(t,e.mainIndex):e}select(e){let{view:t}=this,n=this.skipAtoms(this.style.get(e,this.extend,this.multiple));!this.mustSelect&&n.eq(t.state.selection,!1===this.dragging)||this.view.dispatch({selection:n,userEvent:"select.pointer"}),this.mustSelect=!1}update(e){e.transactions.some(e=>e.isUserEvent("input.type"))?this.destroy():this.style.update(e)&&setTimeout(()=>this.select(this.lastEvent),20)}}const Yd=Object.create(null),Xd=Object.create(null),Jd=hd.ie&&hd.ie_version<15||hd.ios&&hd.webkit_version<604;function eu(e,t,n){for(let i of e.facet(t))n=i(n,e);return n}function tu(e,t){t=eu(e.state,Nd,t);let n,{state:i}=e,a=1,r=i.toText(t),s=r.lines==i.selection.ranges.length;if(null!=hu&&i.selection.ranges.every(e=>e.empty)&&hu==r.toString()){let e=-1;n=i.changeByRange(n=>{let o=i.doc.lineAt(n.from);if(o.from==e)return{range:n};e=o.from;let l=i.toText((s?r.line(a++).text:t)+i.lineBreak);return{changes:{from:o.from,insert:l},range:Rl.cursor(n.from+l.length)}})}else n=s?i.changeByRange(e=>{let t=r.line(a++);return{changes:{from:e.from,to:e.to,insert:t.text},range:Rl.cursor(e.from+t.length)}}):i.replaceSelection(r);e.dispatch(n,{userEvent:"input.paste",scrollIntoView:!0})}function nu(e,t,n,i){if(1==i)return Rl.cursor(t,n);if(2==i)return function(e,t,n=1){let i=e.charCategorizer(t),a=e.doc.lineAt(t),r=t-a.from;if(0==a.length)return Rl.cursor(t);0==r?n=1:r==a.length&&(n=-1);let s=r,o=r;n<0?s=Sl(a.text,r,!1):o=Sl(a.text,r);let l=i(a.text.slice(s,o));for(;s>0;){let e=Sl(a.text,s,!1);if(i(a.text.slice(e,s))!=l)break;s=e}for(;o<a.length;){let e=Sl(a.text,o);if(i(a.text.slice(o,e))!=l)break;o=e}return Rl.range(s+a.from,o+a.from)}(e.state,t,n);{let n=Ad.find(e.docView,t),i=e.state.doc.lineAt(n?n.posAtEnd:t),a=n?n.posAtStart:i.from,r=n?n.posAtEnd:i.to;return r<e.state.doc.length&&r==i.to&&r++,Rl.range(a,r)}}Xd.scroll=e=>{e.inputState.lastScrollTop=e.scrollDOM.scrollTop,e.inputState.lastScrollLeft=e.scrollDOM.scrollLeft},Yd.keydown=(e,t)=>(e.inputState.setSelectionOrigin("select"),27==t.keyCode&&0!=e.inputState.tabFocusMode&&(e.inputState.tabFocusMode=Date.now()+2e3),!1),Xd.touchstart=(e,t)=>{e.inputState.lastTouchTime=Date.now(),e.inputState.setSelectionOrigin("select.pointer")},Xd.touchmove=e=>{e.inputState.setSelectionOrigin("select.pointer")},Yd.mousedown=(e,t)=>{if(e.observer.flush(),e.inputState.lastTouchTime>Date.now()-2e3)return!1;let n=null;for(let i of e.state.facet($d))if(n=i(e,t),n)break;if(n||0!=t.button||(n=function(e,t){let n=ru(e,t),i=du(t),a=e.state.selection;return{update(e){e.docChanged&&(n.pos=e.changes.mapPos(n.pos),a=a.map(e.changes))},get(t,r,s){let o,l=ru(e,t),c=nu(e,l.pos,l.bias,i);if(n.pos!=l.pos&&!r){let t=nu(e,n.pos,n.bias,i),a=Math.min(t.from,c.from),r=Math.max(t.to,c.to);c=a<c.from?Rl.range(a,r):Rl.range(r,a)}return r?a.replaceRange(a.main.extend(c.from,c.to)):s&&1==i&&a.ranges.length>1&&(o=function(e,t){for(let n=0;n<e.ranges.length;n++){let{from:i,to:a}=e.ranges[n];if(i<=t&&a>=t)return Rl.create(e.ranges.slice(0,n).concat(e.ranges.slice(n+1)),e.mainIndex==n?0:e.mainIndex-(e.mainIndex>n?1:0))}return null}(a,l.pos))?o:s?a.addRange(c):Rl.create([c])}}}(e,t)),n){let i=!e.hasFocus;e.inputState.startMouseSelection(new Zd(e,t,n,i)),i&&e.observer.ignore(()=>{!function(e){if(e.setActive)return e.setActive();if(Hc)return e.focus(Hc);let t=[];for(let n=e;n&&(t.push(n,n.scrollTop,n.scrollLeft),n!=n.ownerDocument);n=n.parentNode);if(e.focus(null==Hc?{get preventScroll(){return Hc={preventScroll:!0},!0}}:void 0),!Hc){Hc=!1;for(let e=0;e<t.length;){let n=t[e++],i=t[e++],a=t[e++];n.scrollTop!=i&&(n.scrollTop=i),n.scrollLeft!=a&&(n.scrollLeft=a)}}}(e.contentDOM);let t=e.root.activeElement;t&&!t.contains(e.contentDOM)&&t.blur()});let a=e.inputState.mouseSelection;if(a)return a.start(t),!1===a.dragging}return!1};let iu=(e,t,n)=>t>=n.top&&t<=n.bottom&&e>=n.left&&e<=n.right;function au(e,t,n,i){let a=Ad.find(e.docView,t);if(!a)return 1;let r=t-a.posAtStart;if(0==r)return 1;if(r==a.length)return-1;let s=a.coordsAt(r,-1);if(s&&iu(n,i,s))return-1;let o=a.coordsAt(r,1);return o&&iu(n,i,o)?1:s&&s.bottom>=i?-1:1}function ru(e,t){let n=e.posAtCoords({x:t.clientX,y:t.clientY},!1);return{pos:n,bias:au(e,n,t.clientX,t.clientY)}}const su=hd.ie&&hd.ie_version<=11;let ou=null,lu=0,cu=0;function du(e){if(!su)return e.detail;let t=ou,n=cu;return ou=e,cu=Date.now(),lu=!t||n>Date.now()-400&&Math.abs(t.clientX-e.clientX)<2&&Math.abs(t.clientY-e.clientY)<2?(lu+1)%3:1}function uu(e,t,n,i){if(!(n=eu(e.state,Nd,n)))return;let a=e.posAtCoords({x:t.clientX,y:t.clientY},!1),{draggedContent:r}=e.inputState,s=i&&r&&function(e,t){let n=e.state.facet(Rd);return n.length?n[0](t):hd.mac?!t.altKey:!t.ctrlKey}(e,t)?{from:r.from,to:r.to}:null,o={from:a,insert:n},l=e.state.changes(s?[s,o]:o);e.focus(),e.dispatch({changes:l,selection:{anchor:l.mapPos(a,-1),head:l.mapPos(a,1)},userEvent:s?"move.drop":"input.drop"}),e.inputState.draggedContent=null}Yd.dragstart=(e,t)=>{let{selection:{main:n}}=e.state;if(t.target.draggable){let i=e.docView.nearest(t.target);if(i&&i.isWidget){let e=i.posAtStart,t=e+i.length;(e>=n.to||t<=n.from)&&(n=Rl.range(e,t))}}let{inputState:i}=e;return i.mouseSelection&&(i.mouseSelection.dragging=!0),i.draggedContent=n,t.dataTransfer&&(t.dataTransfer.setData("Text",eu(e.state,Fd,e.state.sliceDoc(n.from,n.to))),t.dataTransfer.effectAllowed="copyMove"),!1},Yd.dragend=e=>(e.inputState.draggedContent=null,!1),Yd.drop=(e,t)=>{if(!t.dataTransfer)return!1;if(e.state.readOnly)return!0;let n=t.dataTransfer.files;if(n&&n.length){let i=Array(n.length),a=0,r=()=>{++a==n.length&&uu(e,t,i.filter(e=>null!=e).join(e.state.lineBreak),!1)};for(let e=0;e<n.length;e++){let t=new FileReader;t.onerror=r,t.onload=()=>{/[\x00-\x08\x0e-\x1f]{2}/.test(t.result)||(i[e]=t.result),r()},t.readAsText(n[e])}return!0}{let n=t.dataTransfer.getData("Text");if(n)return uu(e,t,n,!0),!0}return!1},Yd.paste=(e,t)=>{if(e.state.readOnly)return!0;e.observer.flush();let n=Jd?null:t.clipboardData;return n?(tu(e,n.getData("text/plain")||n.getData("text/uri-list")),!0):(function(e){let t=e.dom.parentNode;if(!t)return;let n=t.appendChild(document.createElement("textarea"));n.style.cssText="position: fixed; left: -10000px; top: 10px",n.focus(),setTimeout(()=>{e.focus(),n.remove(),tu(e,n.value)},50)}(e),!1)};let hu=null;Yd.copy=Yd.cut=(e,t)=>{let{text:n,ranges:i,linewise:a}=function(e){let t=[],n=[],i=!1;for(let a of e.selection.ranges)a.empty||(t.push(e.sliceDoc(a.from,a.to)),n.push(a));if(!t.length){let a=-1;for(let{from:i}of e.selection.ranges){let r=e.doc.lineAt(i);r.number>a&&(t.push(r.text),n.push({from:r.from,to:Math.min(e.doc.length,r.to+1)})),a=r.number}i=!0}return{text:eu(e,Fd,t.join(e.lineBreak)),ranges:n,linewise:i}}(e.state);if(!n&&!a)return!1;hu=a?n:null,"cut"!=t.type||e.state.readOnly||e.dispatch({changes:i,scrollIntoView:!0,userEvent:"delete.cut"});let r=Jd?null:t.clipboardData;return r?(r.clearData(),r.setData("text/plain",n),!0):(function(e,t){let n=e.dom.parentNode;if(!n)return;let i=n.appendChild(document.createElement("textarea"));i.style.cssText="position: fixed; left: -10000px; top: 10px",i.value=t,i.focus(),i.selectionEnd=t.length,i.selectionStart=0,setTimeout(()=>{i.remove(),e.focus()},50)}(e,n),!1)};const pu=rc.define();function gu(e){setTimeout(()=>{let t=e.hasFocus;if(t!=e.inputState.notifiedFocused){let n=function(e,t){let n=[];for(let i of e.facet(Ld)){let a=i(e,t);a&&n.push(a)}return n.length?e.update({effects:n,annotations:pu.of(!0)}):null}(e.state,t);n?e.dispatch(n):e.update([])}},10)}Xd.focus=e=>{e.inputState.lastFocusTime=Date.now(),e.scrollDOM.scrollTop||!e.inputState.lastScrollTop&&!e.inputState.lastScrollLeft||(e.scrollDOM.scrollTop=e.inputState.lastScrollTop,e.scrollDOM.scrollLeft=e.inputState.lastScrollLeft),gu(e)},Xd.blur=e=>{e.observer.clearSelectionRange(),gu(e)},Xd.compositionstart=Xd.compositionupdate=e=>{e.observer.editContext||(null==e.inputState.compositionFirstChange&&(e.inputState.compositionFirstChange=!0),e.inputState.composing<0&&(e.inputState.composing=0))},Xd.compositionend=e=>{e.observer.editContext||(e.inputState.composing=-1,e.inputState.compositionEndedAt=Date.now(),e.inputState.compositionPendingKey=!0,e.inputState.compositionPendingChange=e.observer.pendingRecords().length>0,e.inputState.compositionFirstChange=null,hd.chrome&&hd.android?e.observer.flushSoon():e.inputState.compositionPendingChange?Promise.resolve().then(()=>e.observer.flush()):setTimeout(()=>{e.inputState.composing<0&&e.docView.hasComposition&&e.update([])},50))},Xd.contextmenu=e=>{e.inputState.lastContextMenu=Date.now()},Yd.beforeinput=(e,t)=>{var n,i;if("insertReplacementText"==t.inputType&&e.observer.editContext){let i=null===(n=t.dataTransfer)||void 0===n?void 0:n.getData("text/plain"),a=t.getTargetRanges();if(i&&a.length){let t=a[0],n=e.posAtDOM(t.startContainer,t.startOffset),r=e.posAtDOM(t.endContainer,t.endOffset);return Gd(e,{from:n,to:r,insert:e.state.toText(i)}),!0}}let a;if(hd.chrome&&hd.android&&(a=Qd.find(e=>e.inputType==t.inputType))&&(e.observer.delayAndroidKey(a.key,a.keyCode),"Backspace"==a.key||"Delete"==a.key)){let t=(null===(i=window.visualViewport)||void 0===i?void 0:i.height)||0;setTimeout(()=>{var n;((null===(n=window.visualViewport)||void 0===n?void 0:n.height)||0)>t+10&&e.hasFocus&&(e.contentDOM.blur(),e.focus())},100)}return hd.ios&&"deleteContentForward"==t.inputType&&e.observer.flushSoon(),hd.safari&&"insertText"==t.inputType&&e.inputState.composing>=0&&setTimeout(()=>Xd.compositionend(e,t),20),!1};class vu extends kc{compare(e){return this==e||this.constructor==e.constructor&&this.eq(e)}eq(e){return!1}destroy(e){}}vu.prototype.elementClass="",vu.prototype.toDOM=void 0,vu.prototype.mapMode=_l.TrackBefore,vu.prototype.startSide=vu.prototype.endSide=-1,vu.prototype.point=!0;const fu=class e{constructor(){oe(this,"plugin",null),oe(this,"TUANKI_ANNOTATION_REGEX",/^>\s*\[!tuanki\](?:\s*(.*))?$/gm),oe(this,"DECK_REGEX",/#deck\/([^\s#]+)/g),oe(this,"METADATA_REGEX",/^(uuid|created|modified|version|blockId):\s*(.+)$/gm),oe(this,"BLOCK_ID_REGEX",/\^([a-zA-Z0-9-_]+)$/gm),oe(this,"detectedAnnotations",new Map),oe(this,"eventListeners",[])}setPlugin(e){this.plugin=e}get debugMode(){var e,t,n,i;return null!=(i=null==(n=null==(t=null==(e=this.plugin)?void 0:e.settings)?void 0:t.annotation)?void 0:n.debugMode)&&i}static getInstance(){return e.instance||(e.instance=new e),e.instance}createExtension(){return Ud.fromClass(class{constructor(t){oe(this,"decorations"),oe(this,"detector"),this.detector=e.getInstance(),this.decorations=this.buildDecorations(t)}update(e){(e.docChanged||e.viewportChanged)&&(this.decorations=this.buildDecorations(e.view),e.docChanged&&this.detector.detectAnnotationsInView(e.view))}buildDecorations(e){const t=new Ic,n=e.state.doc.toString(),i=/^>\s*\[!tuanki\](.*)$/gm;let a;for(;null!==(a=i.exec(n));){const n=a.index,i=a.index+a[0].length,r=a[1].trim();i<e.viewport.from||n>e.viewport.to||t.add(n,i,Cd.mark({class:"cm-callout cm-callout-tuanki",attributes:{"data-callout-type":"tuanki","data-callout-title":r,title:"Tuanki 学习卡片标注",role:"button"}}))}return t.finish()}},{decorations:e=>e.decorations})}detectAnnotationsInView(e){const t=e.state.doc.toString(),n=this.getFilePathFromView(e);return this.detectAnnotationsInText(t,n)}detectAnnotationsInText(e,t){const n=[],i=e.split("\n");for(let r=0;r<i.length;r++){if(i[r].match(/^>\s*\[!tuanki\](.*)$/))try{const e=this.parseAnnotationBlock(i,r,t);e&&(n.push(e),this.detectedAnnotations.set(e.id,e))}catch(a){_e.error("解析标注块失败:",a)}}return this.notifyListeners(n),n}parseAnnotationBlock(e,t,n){var i,a,r;const s=this.generateAnnotationId(n,t),{endLine:o,content:l}=this.extractAnnotationContent(e,t),c=this.extractContentFromBlock(l);if(!c.success)return this.debugMode&&_e.debug("[AnnotationDetector] 内容提取失败:",c.error),null;return{id:s,position:{filePath:n,startLine:t,endLine:o,startChar:0,endChar:(null==(i=e[o])?void 0:i.length)||0,blockId:null==(a=c.existingMetadata)?void 0:a.blockId},rawContent:l,cardContent:c.content||"",deckTemplate:c.deckTemplate||{},metadata:c.existingMetadata||{},detectedAt:(new Date).toISOString(),isProcessed:!!(null==(r=c.existingMetadata)?void 0:r.uuid),cardId:void 0}}extractAnnotationContent(e,t){const n=[];let i=t;for(n.push(e[i]),i++;i<e.length;){const t=e[i];if(""===t.trim()){if(i+1<e.length&&e[i+1].startsWith(">")){n.push(t),i++;continue}break}if(!t.startsWith(">"))break;n.push(t),i++}return{endLine:i-1,content:n.join("\n")}}extractContentFromBlock(e){try{const t=e.split("\n").map(e=>e.replace(/^>\s?/,"")).join("\n").trim(),n=this.extractDeckTemplateInfo(t),i=this.extractExistingMetadata(t);return{success:!0,content:this.extractPureContent(t),deckTemplate:n,existingMetadata:i}}catch(t){return{success:!1,error:`内容提取失败: ${t.message}`}}}extractDeckTemplateInfo(e){const t={};this.DECK_REGEX.lastIndex=0;const n=this.DECK_REGEX.exec(e);return n&&(t.deckName=n[1].trim(),this.debugMode&&_e.debug(`🔍 [AnnotationDetector] 提取到牌组标签: "${t.deckName}"`)),t}extractExistingMetadata(e){const t={};let n;for(this.METADATA_REGEX.lastIndex=0;null!==(n=this.METADATA_REGEX.exec(e));){const e=n[1],i=n[2].trim();switch(e){case"uuid":t.uuid=i;break;case"created":t.created=i;break;case"modified":t.modified=i;break;case"version":t.version=parseInt(i,10);break;case"blockId":t.blockId=i}}this.BLOCK_ID_REGEX.lastIndex=0;const i=this.BLOCK_ID_REGEX.exec(e);return i&&(t.blockId=i[1]),t}extractPureContent(e){let t=e;return t=t.replace(/^\[!tuanki\].*?\n?/,""),t=t.replace(this.DECK_REGEX,""),t=t.replace(this.METADATA_REGEX,""),t=t.replace(this.BLOCK_ID_REGEX,""),t=t.replace(/\n\s*\n\s*\n/g,"\n\n").trim(),t}generateAnnotationId(e,t){const n=Date.now();return`tuanki-annotation-${this.simpleHash(`${e}:${t}:${n}`)}`}simpleHash(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(36)}getFilePathFromView(e){var t;return(null==(t=e.state)?void 0:t.filePath)||"unknown"}addListener(e){this.eventListeners.push(e)}removeListener(e){const t=this.eventListeners.indexOf(e);t>-1&&this.eventListeners.splice(t,1)}notifyListeners(e){this.eventListeners.forEach(t=>{try{t(e)}catch(n){_e.error("标注监听器执行失败:",n)}})}getDetectedAnnotations(){return Array.from(this.detectedAnnotations.values())}clearCache(){this.detectedAnnotations.clear()}getAnnotationsForFile(e){return this.getDetectedAnnotations().filter(t=>t.position.filePath===e)}};oe(fu,"instance");let mu=fu;var yu=(e=>(e.QUESTION_ANSWER="question_answer",e.CLOZE="cloze",e.BASIC="basic",e.MULTI_CHOICE="multi_choice",e.CODE="code",e))(yu||{});const bu=class e{constructor(){oe(this,"HEADING_REGEX",/^#{1,6}\s+(.+)$/gm),oe(this,"CLOZE_REGEX",/\{\{c\d+::([^}]+)\}\}/g),oe(this,"HIGHLIGHT_CLOZE_REGEX",/==(.*?)==/g),oe(this,"CODE_BLOCK_REGEX",/```(\w+)?\n([\s\S]*?)```/g),oe(this,"INLINE_CODE_REGEX",/`([^`]+)`/g),oe(this,"LINK_REGEX",/\[\[([^\]]+)\]\]/g),oe(this,"TAG_REGEX",/#([a-zA-Z0-9\u4e00-\u9fff/_-]+)/g),oe(this,"DECK_REGEX",/#deck\/([^\s#]+)/g),oe(this,"LIST_ITEM_REGEX",/^[\s]*[-*+]\s+(.+)$/gm),oe(this,"NUMBERED_LIST_REGEX",/^[\s]*\d+\.\s+(.+)$/gm),oe(this,"BLOCKQUOTE_REGEX",/^>\s+(.+)$/gm)}static getInstance(){return e.instance||(e.instance=new e),e.instance}extractContent(e){try{if(_e.debug(`🔍 [ContentExtractor] 开始提取内容: ${e.id}`),!e.rawContent||"string"!=typeof e.rawContent)return _e.warn("⚠️ [ContentExtractor] rawContent为空或无效"),{success:!1,error:"标注内容为空"};const t=this.cleanRawContent(e.rawContent);if(!t||!t.trim())return _e.warn("⚠️ [ContentExtractor] 清理后内容为空"),{success:!1,error:"标注内容为空"};const n=this.parseContentStructure(t),i=this.extractDeckTemplateInfo(t),a=this.extractMetadata(t),r=this.generateCardContent(n);return _e.debug(`✅ [ContentExtractor] 内容提取完成: 类型=${n.type}`),{success:!0,content:r,deckTemplate:i,existingMetadata:a}}catch(t){return _e.error("❌ [ContentExtractor] 内容提取失败:",t),{success:!1,error:`内容提取失败: ${t.message}`}}}cleanRawContent(e){if(!e||"string"!=typeof e)return"";let t=e;t=t.replace(/^>\s?/gm,""),t=t.replace(/^\[!tuanki\].*?\n?/,"");return[...t.match(/^(uuid|created|modified|version|blockId):\s*.+$/gm)||[],...t.match(/\^[a-zA-Z0-9-_]+$/gm)||[]].forEach(e=>{t=t.replace(e,"")}),t=t.replace(/\n\s*\n\s*\n/g,"\n\n").trim(),t}parseContentStructure(e){const t=this.detectContentType(e),n={type:t,notes:e};switch(t){case"question_answer":this.parseQuestionAnswer(e,n);break;case"cloze":this.parseClozeContent(e,n);break;case"code":this.parseCodeContent(e,n);break;case"multi_choice":this.parseMultiChoiceContent(e,n);break;default:this.parseBasicContent(e,n)}return this.extractCommonElements(e,n),n}detectContentType(e){if(this.CLOZE_REGEX.test(e)||this.HIGHLIGHT_CLOZE_REGEX.test(e))return"cloze";if(this.CODE_BLOCK_REGEX.test(e))return"code";const t=e.match(this.LIST_ITEM_REGEX);return t&&t.length>=3?"multi_choice":e.includes("?")||e.includes("？")||e.match(/^#{1,6}\s+.*[?？]/m)||e.includes("问题")||e.includes("答案")?"question_answer":"basic"}parseQuestionAnswer(e,t){const n=e.split("\n"),i=[],a=[];let r=!1;for(const s of n){const e=s.trim();e.includes("答案")||e.includes("Answer")||e.includes("解答")||e.includes("Solution")?r=!0:r?e&&a.push(s):e&&i.push(s)}if(t.question=i.join("\n").trim(),t.answer=a.join("\n").trim(),!t.answer&&t.question){const n=e.split(/\n\s*\n/);n.length>=2&&(t.question=n[0].trim(),t.answer=n.slice(1).join("\n\n").trim())}}parseClozeContent(e,t){t.clozeText=e;const n=e.match(this.CLOZE_REGEX)||e.match(this.HIGHLIGHT_CLOZE_REGEX);n&&n.length>0&&(t.title=`挖空练习 (${n.length}个空)`)}parseCodeContent(e,t){const n=e.match(this.CODE_BLOCK_REGEX);if(n){t.language=n[1]||"text",t.code=n[2].trim();const i=e.replace(this.CODE_BLOCK_REGEX,"").trim();i&&(t.question=i)}}parseMultiChoiceContent(e,t){if(!e||"string"!=typeof e)return t.question="",void(t.choices=[]);const n=e.split("\n"),i=[],a=[];for(const r of n){const e=r.match(this.LIST_ITEM_REGEX);(null==e?void 0:e[1])?a.push(e[1].trim()):r.trim()&&i.push(r)}t.question=i.join("\n").trim(),t.choices=a}parseBasicContent(e,t){const n=e.match(this.HEADING_REGEX);n&&(t.title=n[1]),t.notes=e}extractCommonElements(e,t){var n;const i=this.extractTags(e);if(t.tags=i,!t.title){const i=null==(n=e.split("\n")[0])?void 0:n.trim();i&&i.length<100&&(t.title=i)}}extractTags(e){const t=[];let n;for(this.TAG_REGEX.lastIndex=0;null!==(n=this.TAG_REGEX.exec(e));){const e=n[1];e.includes("/")||t.push(e)}return t}extractDeckTemplateInfo(e){const t={};this.DECK_REGEX.lastIndex=0;const n=this.DECK_REGEX.exec(e);return n?(t.deckName=n[1].trim(),_e.debug(`🔍 [ContentExtractor] 提取到牌组标签: "${t.deckName}"`)):_e.debug(`⚠️ [ContentExtractor] 未找到牌组标签，内容预览: ${e.substring(0,50)}...`),t}extractMetadata(e){const t={},n=/^(uuid|created|modified|version|blockId):\s*(.+)$/gm;let i;for(;null!==(i=n.exec(e));){const e=i[1],n=i[2].trim();switch(e){case"uuid":t.uuid=n;break;case"created":t.created=n;break;case"modified":t.modified=n;break;case"version":t.version=parseInt(n,10);break;case"blockId":t.blockId=n}}const a=e.match(/\^([a-zA-Z0-9-_]+)$/m);return a&&(t.blockId=a[1]),t}generateCardContent(e){const t=[];switch(e.title&&t.push(`# ${e.title}`),e.type){case"question_answer":e.question&&t.push(`**问题**: ${e.question}`),e.answer&&t.push(`**答案**: ${e.answer}`);break;case"cloze":e.clozeText&&t.push(e.clozeText);break;case"code":e.question&&t.push(e.question),e.code&&t.push(`\`\`\`${e.language||""}\n${e.code}\n\`\`\``);break;case"multi_choice":e.question&&t.push(e.question),e.choices&&e.choices.length>0&&(t.push("**选项**:"),e.choices.forEach((e,n)=>{t.push(`${String.fromCharCode(65+n)}. ${e}`)}));break;default:e.notes&&t.push(e.notes)}return e.tags&&e.tags.length>0&&t.push(`\n**标签**: ${e.tags.map(e=>`#${e}`).join(" ")}`),t.join("\n\n")}validateContent(e){const t=[];return e&&0!==e.trim().length||t.push("内容为空"),e.length<10&&t.push("内容过短，可能不是有效的学习卡片"),e.length>1e4&&t.push("内容过长，建议分割为多个卡片"),{isValid:0===t.length,issues:t}}parseChoiceContent(e){if(!e||"string"!=typeof e)return{success:!1,question:"",options:"",confidence:0,format:"unknown"};_e.debug("[ContentExtractor] 开始解析选择题内容:",e.substring(0,200));const t=e.match(/^##\s*(.+?)\n([\s\S]*?)\n\n((?:[A-E]\..*?\n?)+)(?:---div---\s*\n([\s\S]*))?$/m);if(t){const[,e,n,i,a]=t,r=`${e.trim()}\n${n.trim()}`,s=this.parseBackContent(a||"");return _e.debug("[ContentExtractor] 匹配格式1 - H2标题+描述+选项:",{title:e.trim(),description:n.trim(),options:i.trim(),backContent:null==a?void 0:a.substring(0,100)}),{success:!0,question:r.trim(),options:i.trim(),correctAnswer:s.answer,explanation:s.explanation,tags:s.tags,confidence:.95,format:"markdown-h2-desc"}}const n=e.match(/^##\s*(.+?)\n\*\*选项\*\*:\s*\n((?:[A-E]\..*?\n?)+)(?:---div---\s*\n([\s\S]*))?$/m);if(n){const[,e,t,i]=n,a=this.parseBackContent(i||"");return _e.debug("[ContentExtractor] 匹配格式2 - H2标题+选项标记:",{question:e.trim(),options:t.trim()}),{success:!0,question:e.trim(),options:t.trim(),correctAnswer:a.answer,explanation:a.explanation,tags:a.tags,confidence:.95,format:"markdown-h2"}}const i=e.match(/^(.+?)\n((?:[A-E]\..*?\n?)+)(?:---div---\s*\n([\s\S]*))?$/m);if(i){const[,e,t,n]=i,a=t.trim().split("\n").filter(e=>e.trim());if(a.length>=2&&a.every(e=>/^[A-E]\./.test(e.trim()))){const i=this.parseBackContent(n||"");return _e.debug("[ContentExtractor] 匹配格式3 - 直接选项:",{question:e.trim(),options:t.trim()}),{success:!0,question:e.trim(),options:t.trim(),correctAnswer:i.answer,explanation:i.explanation,tags:i.tags,confidence:.9,format:"markdown-options"}}}return _e.debug("[ContentExtractor] 所有格式都不匹配，解析失败"),{success:!1,question:"",options:"",confidence:0,format:"unknown"}}parseQAContent(e){if(!e||"string"!=typeof e)return{success:!1,question:"",answer:"",confidence:0,format:"unknown"};const t=e.match(/^(.+?)\n---div---\s*\n([\s\S]*)$/m);if(t){const[,n,i]=t,a=this.extractTags(e);return{success:!0,question:n.trim(),answer:i.trim(),tags:a.length>0?a.join(","):void 0,confidence:.9,format:"markdown-qa"}}return{success:!1,question:"",answer:"",confidence:0,format:"unknown"}}parseClozeContentNew(e){if(!e||"string"!=typeof e)return{success:!1,text:"",clozeCount:0,confidence:0,format:"unknown"};const t=e.match(this.CLOZE_REGEX);if(t&&t.length>0){const n=this.extractTags(e);return{success:!0,text:e,clozeCount:t.length,tags:n.length>0?n.join(","):void 0,confidence:.95,format:"anki-cloze"}}const n=e.match(this.HIGHLIGHT_CLOZE_REGEX);if(n&&n.length>0){const t=this.extractTags(e);return{success:!0,text:e,clozeCount:n.length,tags:t.length>0?t.join(","):void 0,confidence:.85,format:"highlight-cloze"}}return{success:!1,text:"",clozeCount:0,confidence:0,format:"unknown"}}detectContentTypeNew(e){if(!e)return"unknown";const t=e.match(/[A-E]\.\s*.+/g);return t&&t.length>=2?"choice":this.CLOZE_REGEX.test(e)||this.HIGHLIGHT_CLOZE_REGEX.test(e)?"cloze":e.includes("---div---")?"qa":"unknown"}parseBackContent(e){if(!e)return{};const t=e.trim().split("\n");let n="",i="",a="";for(const r of t){const e=r.trim();e.startsWith("**解析**:")||e.startsWith("解析:")?i=e.replace(/^\*\*解析\*\*:\s*|^解析:\s*/,""):e.startsWith("**标签**:")||e.startsWith("标签:")?a=e.replace(/^\*\*标签\*\*:\s*|^标签:\s*/,""):e.startsWith("**")&&e.includes("**:")?n||(n=e):e&&!n?n=e:e&&!i&&(i=e)}return{answer:n,explanation:i,tags:a}}};oe(bu,"instance");let wu=bu;const ku="---div---",Su={QUESTION:"Q:"},xu={META_SEPARATOR:/^\s*---\s*meta(data)?\s*---\s*$/im};const _u="tk-",Cu="23456789abcdefghjkmnpqrstuvwxyz",Iu=7,Du=5,Tu=/^tk-[23456789abcdefghjkmnpqrstuvwxyz]{12}$/,Mu="0123456789abcdefghijklmnopqrstuvwxyz",Au=/^we-[0-9a-z]{6}$/,Eu=100;new Date("2025-01-01T00:00:00Z").getTime(),new Date("2125-01-01T00:00:00Z").getTime();const zu="UUID格式无效",Pu="BlockID格式无效",Ru="包含无效字符",$u=class e{constructor(){oe(this,"uuidCollisionCount",0),oe(this,"blockIdCollisionCount",0),oe(this,"lastTimestamp",0),oe(this,"sameMillisecondCount",0)}static getInstance(){return e.instance||(e.instance=new e),e.instance}generateCardUUID(){const e=Date.now();if(e===this.lastTimestamp){if(this.sameMillisecondCount++,this.sameMillisecondCount>=Eu){for(;Date.now()===this.lastTimestamp;);this.sameMillisecondCount=0}}else this.lastTimestamp=e,this.sameMillisecondCount=0;const t=this.encodeTimestamp(e),n=this.generateRandomString(Du,Cu);return`${_u}${t}${n}`}encodeTimestamp(e){let t="",n=e;for(let i=0;i<Iu;i++){t=Cu[n%31]+t,n=Math.floor(n/31)}return t}extractTimestamp(e){if(!this.isValidUUID(e))return 0;const t=e.replace(_u,"").substring(0,Iu);let n=0;for(let i=0;i<t.length;i++){const e=Cu.indexOf(t[i]);if(-1===e)return 0;n=31*n+e}return n}isValidUUID(e){return Tu.test(e)}validateUUID(e){const t={isValid:!1,formatValid:!1,alphabetValid:!1};if(t.formatValid=Tu.test(e),!t.formatValid)return t.error=zu,t;const n=e.replace(_u,"");if(t.alphabetValid=[...n].every(e=>Cu.includes(e)),!t.alphabetValid)return t.error=Ru,t;const i=this.extractTimestamp(e);return t.timestamp=i,t.timestampValid=i>0&&i<Date.now()+864e5,t.isValid=!0,t}generateBlockID(){return`we-${this.generateRandomString(6,Mu)}`}isValidBlockID(e){return Au.test(e)}validateBlockID(e){const t={isValid:!1,formatValid:!1,alphabetValid:!1};return t.formatValid=Au.test(e),t.formatValid?(t.alphabetValid=[...e].every(e=>Mu.includes(e)),t.alphabetValid?(t.isValid=!0,t):(t.error=Ru,t)):(t.error=Pu,t)}generateRandomString(e,t){let n="";for(let i=0;i<e;i++){n+=t[Math.floor(Math.random()*t.length)]}return n}generateBatchUUIDs(e){const t=[];for(let n=0;n<e;n++)t.push(this.generateCardUUID());return t}generateBatchBlockIDs(e){const t=[];for(let n=0;n<e;n++)t.push(this.generateBlockID());return t}resetCounters(){this.uuidCollisionCount=0,this.blockIdCollisionCount=0,this.lastTimestamp=0,this.sameMillisecondCount=0}getStatistics(){return{uuidCollisions:this.uuidCollisionCount,blockIdCollisions:this.blockIdCollisionCount,lastTimestamp:this.lastTimestamp,sameMillisecondCount:this.sameMillisecondCount}}};oe($u,"instance");const Ou=$u.getInstance();var Lu=(e=>(e.GENERIC="generic",e.UUID="uuid",e.CARD="card",e.DECK="deck",e.TEMPLATE="template",e.SESSION="session",e.COMPONENT="component",e.MODAL="modal",e.NOTIFICATION="notification",e.BLOCK="block",e.CACHE_KEY="cache_key",e.ERROR="error",e))(Lu||{});j=[js({lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.INFRASTRUCTURE_SERVICE})];let Nu=class e{constructor(){oe(this,"BASE36_CHARS","0123456789abcdefghijklmnopqrstuvwxyz"),oe(this,"BASE62_CHARS","0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"),oe(this,"HEX_CHARS","0123456789abcdef"),oe(this,"DEFAULT_CONFIGS",{generic:{type:"generic",length:12,format:"base36",includeTimestamp:!0},uuid:{type:"uuid",format:"uuid"},card:{type:"card",prefix:"card",length:16,format:"base36",includeTimestamp:!0,separator:"-"},deck:{type:"deck",prefix:"deck",length:12,format:"base36",includeTimestamp:!0,separator:"-"},template:{type:"template",prefix:"tpl",length:10,format:"base36",includeTimestamp:!1,separator:"-"},session:{type:"session",prefix:"session",length:12,format:"base36",includeTimestamp:!0,separator:"-"},component:{type:"component",prefix:"cmp",length:8,format:"base62",includeTimestamp:!1,separator:"-"},modal:{type:"modal",prefix:"modal",length:8,format:"base36",includeTimestamp:!1,separator:"-"},notification:{type:"notification",prefix:"notif",length:10,format:"base36",includeTimestamp:!0,separator:"-"},block:{type:"block",length:12,format:"base36",includeTimestamp:!0},cache_key:{type:"cache_key",length:16,format:"base62",includeTimestamp:!1,separator:"_"},error:{type:"error",prefix:"err",length:12,format:"base36",includeTimestamp:!0,separator:"-"}})}static getInstance(){return e.instance||(e.instance=new e),e.instance}generate(e,t){const n={...this.DEFAULT_CONFIGS[e],...t};return this.generateWithConfig(n).id}generateWithDetails(e,t){const n={...this.DEFAULT_CONFIGS[e],...t};return this.generateWithConfig(n)}generateWithConfig(e){const t=Date.now();let n;switch(e.format){case"uuid":n=this.generateUUID();break;case"hex":n=this.generateRandomString(e.length||12,this.HEX_CHARS);break;case"base62":n=this.generateRandomString(e.length||12,this.BASE62_CHARS);break;default:n=this.generateBase36ID(e)}if(e.prefix){const t=e.separator||"";n=`${e.prefix}${t}${n}`}return{id:n,type:e.type,timestamp:t,metadata:{format:e.format,length:e.length,hasPrefix:!!e.prefix,hasTimestamp:e.includeTimestamp}}}generateBase36ID(e){let t="";if(e.includeTimestamp){t+=Date.now().toString(36)}const n=(e.length||12)-(e.includeTimestamp,0);return t+=this.generateRandomString(n,this.BASE36_CHARS),t}generateUUID(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}generateRandomString(e,t){let n="";for(let i=0;i<e;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}validateID(e,t){const n=this.DEFAULT_CONFIGS[t];if(n.prefix){const t=n.separator||"",i=`${n.prefix}${t}`;if(!e.startsWith(i))return!1}if("uuid"===n.format){return/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}return!0}parseID(e,t){const n=this.DEFAULT_CONFIGS[t],i={id:e,type:t,isValid:this.validateID(e,t),hasPrefix:!1,hasTimestamp:!1};if(n.prefix){const t=n.separator||"",a=`${n.prefix}${t}`;e.startsWith(a)&&(i.hasPrefix=!0,i.prefix=n.prefix,i.content=e.substring(a.length))}else i.content=e;if("base36"===n.format&&n.includeTimestamp&&i.content)try{const e=Date.now().toString(36).length,t=i.content.substring(0,e),n=parseInt(t,36);!Number.isNaN(n)&&n>0&&(i.hasTimestamp=!0,i.timestamp=n,i.createdAt=new Date(n))}catch(a){}return i}generateBatch(e,t,n){const i=[];for(let a=0;a<t;a++)i.push(this.generate(e,n));return i}generateCacheKey(e,...t){const n=[e,...t].filter(Boolean).join("_");return this.generate("cache_key",{prefix:n})}};Nu=se(U=te(null),0,"UnifiedIDGenerator",j,Nu),oe(Nu,"instance"),re(U,1,Nu);const Fu=Nu.getInstance();V=[js({lifetime:Ls.SINGLETON,layer:Ws.INFRASTRUCTURE,type:Gs.INFRASTRUCTURE_SERVICE})];let Bu=class e{constructor(){oe(this,"defaultTimezone",{timezone:"Asia/Shanghai",locale:"zh-CN",use24Hour:!0}),oe(this,"defaultRelativeConfig",{locale:"zh-CN",numeric:"auto",style:"long"})}static getInstance(){return e.instance||(e.instance=new e),e.instance}formatDate(e,t="YYYY-MM-DD",n){if(!e)return"-";const i=this.normalizeDate(e);if(!i||Number.isNaN(i.getTime()))return"-";switch(this.defaultTimezone,t){case"YYYY-MM-DD":default:return this.formatISODate(i);case"YYYY-MM-DD HH:mm:ss":return this.formatISODateTime(i);case"YYYY-MM-DDTHH:mm:ss.sssZ":return i.toISOString();case"YYYY年MM月DD日":return this.formatChineseDate(i);case"YYYY年MM月DD日 HH:mm:ss":return this.formatChineseDateTime(i);case"relative":return this.formatRelativeTime(i);case"anki":return this.formatAnkiTimestamp(i)}}formatRelativeTime(e,t){const n=this.normalizeDate(e);if(!n)return"-";const i={...this.defaultRelativeConfig,...t};try{const e=new Intl.RelativeTimeFormat(i.locale,{numeric:i.numeric,style:i.style}),t=new Date,a=n.getTime()-t.getTime(),r=Math.abs(a);if(r<6e4)return"刚刚";if(r<36e5){const t=Math.round(a/6e4);return e.format(t,"minute")}if(r<864e5){const t=Math.round(a/36e5);return e.format(t,"hour")}if(r<2592e6){const t=Math.round(a/864e5);return e.format(t,"day")}if(r<31536e6){const t=Math.round(a/2592e6);return e.format(t,"month")}{const t=Math.round(a/31536e6);return e.format(t,"year")}}catch(a){return this.formatSimpleRelativeTime(n)}}parseDate(e){if(!e)return null;try{if(e.includes("T")||e.includes("-")){const t=new Date(e);if(!Number.isNaN(t.getTime()))return t}const t=parseInt(e,10);return Number.isNaN(t)?null:t<1e10?new Date(1e3*t):new Date(t)}catch(t){return null}}convertAnkiTimestamp(e){return new Date(1e3*e)}toAnkiTimestamp(e){const t=this.normalizeDate(e);return t?Math.floor(t.getTime()/1e3):0}startOfDay(e){const t=this.normalizeDate(e);if(!t)return new Date;const n=new Date(t);return n.setHours(0,0,0,0),n}endOfDay(e){const t=this.normalizeDate(e);if(!t)return new Date;const n=new Date(t);return n.setHours(23,59,59,999),n}bucketDate(e,t="day"){const n=this.normalizeDate(e);if(!n)return"";switch(t){case"day":default:return this.formatISODate(n);case"week":{const e=this.getWeekStart(n);return this.formatISODate(e)}case"month":return`${n.getFullYear()}-${this.pad2(n.getMonth()+1)}`;case"year":return n.getFullYear().toString()}}timeDifference(e,t,n="milliseconds"){const i=this.normalizeDate(e),a=this.normalizeDate(t);if(!i||!a)return 0;const r=i.getTime()-a.getTime();switch(n){case"seconds":return r/1e3;case"minutes":return r/6e4;case"hours":return r/36e5;case"days":return r/864e5;default:return r}}normalizeDate(e){if(!e)return null;if(e instanceof Date)return Number.isNaN(e.getTime())?null:e;if("number"==typeof e){return new Date(e<1e10?1e3*e:e)}return"string"==typeof e?this.parseDate(e):null}formatISODate(e){return`${e.getFullYear()}-${this.pad2(e.getMonth()+1)}-${this.pad2(e.getDate())}`}formatISODateTime(e){return`${this.formatISODate(e)} ${this.pad2(e.getHours())}:${this.pad2(e.getMinutes())}:${this.pad2(e.getSeconds())}`}formatChineseDate(e){return`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日`}formatChineseDateTime(e){return`${this.formatChineseDate(e)} ${this.pad2(e.getHours())}:${this.pad2(e.getMinutes())}:${this.pad2(e.getSeconds())}`}formatAnkiTimestamp(e){return this.toAnkiTimestamp(e).toString()}formatSimpleRelativeTime(e){const t=(new Date).getTime()-e.getTime(),n=Math.abs(t);if(n<6e4)return"刚刚";if(n<36e5){return`${Math.floor(n/6e4)}分钟${t>0?"前":"后"}`}if(n<864e5){return`${Math.floor(n/36e5)}小时${t>0?"前":"后"}`}return`${Math.floor(n/864e5)}天${t>0?"前":"后"}`}getWeekStart(e){const t=new Date(e),n=t.getDay(),i=t.getDate()-n+(0===n?-6:1);return t.setDate(i),this.startOfDay(t)}pad2(e){return e.toString().padStart(2,"0")}setDefaultTimezone(e){this.defaultTimezone={...this.defaultTimezone,...e}}setDefaultRelativeConfig(e){this.defaultRelativeConfig={...this.defaultRelativeConfig,...e}}};Bu=se(q=te(null),0,"UnifiedDateTimeProcessor",V,Bu),oe(Bu,"instance"),re(q,1,Bu);const ju=Bu.getInstance(),Uu=e=>ju.formatRelativeTime(e);function Vu(){return Ou.generateCardUUID()}function qu(e){if((e=>Ou.isValidUUID(e))(e))return!0;return!!/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)||!!(e.startsWith("tuanki-card-")||e.startsWith("uuid-")||e.startsWith("card-"))}function Hu(){return Ou.generateBlockID()}function Wu(e){return(e=>Ou.isValidBlockID(e))(e.startsWith("^")?e.substring(1):e)}function Gu(){return((e="generic",t)=>Fu.generate(e,t))(Lu.GENERIC)}function Qu(e){return e?Uu(e):"-"}function Ku(e){return e?Uu(e):"-"}const Zu=new Map;function Yu(e,t,n,i="\n---\n"){var a,r,s,o;if(!e)return _e.warn("[getCardContentBySide] 无效的卡片数据，返回空字符串"),"";const l=`${e.uuid}_${e.modified||""}`;let c=Zu.get(l);if(c)return"front"===t?c.front:c.back;let d="",u="";const h=null==n?void 0:n.find(t=>t.id===e.templateId);if(!h||!h.fields){if(e.content&&e.content.trim()){const t=e.content.trim(),n=t.indexOf(ku);n>=0?(d=t.substring(0,n).trim(),u=t.substring(n+9).trim()):(d=t,u="")}else d=(null==(a=e.fields)?void 0:a.front)||(null==(r=e.fields)?void 0:r.question)||"",u=(null==(s=e.fields)?void 0:s.back)||(null==(o=e.fields)?void 0:o.answer)||"";if(Zu.set(l,{front:d,back:u}),Zu.size>2e3){Array.from(Zu.keys()).slice(0,100).forEach(e=>Zu.delete(e))}return"front"===t?d:u}const p=h.fields.filter(e=>"field"===e.type&&("front"===e.side||"both"===e.side)),g=h.fields.filter(e=>"field"===e.type&&("back"===e.side||"both"===e.side));if(d=p.map(t=>{var n;return null==(n=e.fields)?void 0:n[t.key]}).filter(Boolean).join(i),u=g.map(t=>{var n;return null==(n=e.fields)?void 0:n[t.key]}).filter(Boolean).join(i),Zu.set(l,{front:d,back:u}),Zu.size>2e3){Array.from(Zu.keys()).slice(0,100).forEach(e=>Zu.delete(e))}return"front"===t?d:u}const Xu=Object.freeze(Object.defineProperty({__proto__:null,formatRelativeTime:Qu,formatRelativeTimeDetailed:Ku,generateBlockId:Hu,generateId:Gu,generateUUID:Vu,getCardContentBySide:Yu,isValidBlockId:Wu,isValidUUID:qu},Symbol.toStringTag,{value:"Module"})),Ju=class e{constructor(){oe(this,"UUID_CHARS","0123456789abcdef"),oe(this,"BLOCK_ID_CHARS","abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),oe(this,"generatedUuids",new Set),oe(this,"generatedBlockIds",new Set)}static getInstance(){return e.instance||(e.instance=new e),e.instance}generateMetadata(e,t={}){_e.debug(`🏷️ [MetadataGenerator] 开始生成元数据: ${e.id}`);const n={...e.metadata||{}},i=[];if(!n.uuid||t.forceNewUuid){const e=n.uuid;n.uuid=this.generateUuid(),e!==n.uuid&&i.push("uuid")}if(!n.blockId||t.forceNewBlockId){const e=n.blockId;n.blockId=this.generateBlockId(),e!==n.blockId&&i.push("blockId")}if(!1!==t.updateModifiedTime){const e=n.modified;n.modified=this.generateTimestamp(),e!==n.modified&&i.push("modified")}const a=t.customContentHash||this.generateContentHash(e.cardContent);n.contentHash!==a&&(n.contentHash=a,i.push("contentHash"));const r=this.generateMetadataText(n);return _e.debug(`✅ [MetadataGenerator] 元数据生成完成: 变更字段=${i.join(", ")}`),{metadata:n,hasChanges:i.length>0,changedFields:i,metadataText:r}}generateUuid(){const e=Vu();return this.generatedUuids.add(e),e}generateBlockId(){const e=Hu();return this.generatedBlockIds.add(e),e}generateTimestamp(e){return(e||new Date).toISOString()}generateContentHash(e){let t=0;const n=e.trim().replace(/\s+/g," ");for(let i=0;i<n.length;i++){t=(t<<5)-t+n.charCodeAt(i),t&=t}return Math.abs(t).toString(36)}generateMetadataText(e){const t=[];if(t.push("%%"),e.blockId&&t.push(`^${e.blockId}`),e.uuid&&t.push(`uuid: ${e.uuid}`),e.modified){const n=e.modified.split("T")[0];t.push(`modified: ${n}`)}return t.push("%%"),t.join("\n")}parseMetadataText(e){const t={},n=e.split("\n");for(const i of n){const e=i.trim(),n=e.match(/^\^([a-zA-Z0-9-_]+)$/);if(n){t.blockId=n[1];continue}const a=e.match(/^(uuid|created|modified|version|contentHash):\s*(.+)$/);if(a){const e=a[1],n=a[2].trim();switch(e){case"uuid":t.uuid=n;break;case"created":t.created=n;break;case"modified":t.modified=n;break;case"version":t.version=parseInt(n,10);break;case"contentHash":t.contentHash=n}}}return t}validateUuid(e){if(/^tk-[23456789abcdefghjkmnpqrstuvwxyz]{12}$/.test(e))return!0;return/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}validateBlockId(e){return/^[a-zA-Z0-9-_]{6,20}$/.test(e)}validateTimestamp(e){try{return new Date(e).toISOString()===e}catch(t){return!1}}compareMetadata(e,t){const n=[],i=new Set([...Object.keys(e),...Object.keys(t)]);for(const a of i){e[a]!==t[a]&&n.push(a)}return{isEqual:0===n.length,differences:n}}clearCache(){this.generatedUuids.clear(),this.generatedBlockIds.clear(),_e.debug("🧹 [MetadataGenerator] 缓存已清理")}getCacheStats(){return{uuidCount:this.generatedUuids.size,blockIdCount:this.generatedBlockIds.size}}batchGenerateMetadata(e,t={}){_e.debug(`🏷️ [MetadataGenerator] 开始批量生成元数据: ${e.length} 个标注`);const n=[];for(const a of e)try{const e=this.generateMetadata(a,t);n.push(e)}catch(i){_e.error(`元数据生成失败: ${a.id}`,i),n.push({metadata:a.metadata||{},hasChanges:!1,changedFields:[],metadataText:""})}return _e.debug(`✅ [MetadataGenerator] 批量元数据生成完成: ${n.length} 个结果`),n}};oe(Ju,"instance");let eh=Ju;const th=class e{constructor(){oe(this,"vault"),oe(this,"metadataGenerator"),oe(this,"modificationHistory",[]),oe(this,"backupStorage",new Map),this.metadataGenerator=eh.getInstance()}static getInstance(){return e.instance||(e.instance=new e),e.instance}initialize(e){this.vault=e,_e.debug("📝 [DocumentModifier] 初始化完成")}async insertMetadata(e,t,n={}){_e.debug(`📝 [DocumentModifier] 开始插入元数据: ${e.id}`);try{const i=this.vault.getAbstractFileByPath(e.position.filePath);if(!(i&&i instanceof ge.TFile))return{success:!1,error:`文件不存在: ${e.position.filePath}`};const a=await this.vault.read(i);n.createBackup&&this.createBackup(e.position.filePath,a);const r=this.findAnnotationBlock(a,e);if(!r)return{success:!1,error:"无法找到对应的标注块"};const s=this.metadataGenerator.generateMetadataText(t),o=this.insertMetadataIntoBlock(a,r,s,n);if(n.validateResult){const e=this.validateModification(a,o);if(!e.isValid)return{success:!1,error:`修改验证失败: ${e.errors.join(", ")}`}}return await this.vault.modify(i,o),this.recordModification({operation:"insert_metadata",filePath:e.position.filePath,timestamp:(new Date).toISOString(),originalContent:a,modifiedContent:o,metadata:t,success:!0}),_e.debug("✅ [DocumentModifier] 元数据插入成功"),{success:!0,modifiedLines:this.countModifiedLines(a,o),insertedMetadata:t,originalContent:a}}catch(i){return _e.error("❌ [DocumentModifier] 元数据插入失败:",i),this.recordModification({operation:"insert_metadata",filePath:e.position.filePath,timestamp:(new Date).toISOString(),originalContent:"",modifiedContent:"",metadata:t,success:!1,error:i instanceof Error?i.message:String(i)}),{success:!1,error:`元数据插入失败: ${i instanceof Error?i.message:String(i)}`}}}findAnnotationBlock(e,t){var n;const i=e.split("\n"),a=Math.max(0,Math.min(null!=(n=t.position.startLine)?n:0,i.length-1));let r=-1,s=-1;if(i[a]&&/^>\s*\[!tuanki\]/.test(i[a]))r=a;else for(let o=a;o>=0;o--){if(/^>\s*\[!tuanki\]/.test(i[o])){r=o;break}if(a-o>30)break}if(-1===r)return null;for(let o=r+1;o<i.length;o++){const e=i[o];if(""===e.trim()){if(o+1<i.length&&i[o+1].startsWith(">"))continue;s=o-1;break}if(!e.startsWith(">")){s=o-1;break}}-1===s&&(s=i.length-1);return{startIndex:i.slice(0,r).join("\n").length+(r>0?1:0),endIndex:i.slice(0,s+1).join("\n").length,blockContent:i.slice(r,s+1).join("\n")}}insertMetadataIntoBlock(e,t,n,i){const{startIndex:a,endIndex:r,blockContent:s}=t;let o=s;o=this.extractExistingMetadata(s).hasMetadata&&!i.forceOverwrite?this.updateExistingMetadata(s,n):this.insertNewMetadata(s,n,i);return e.substring(0,a)+o+e.substring(r)}extractExistingMetadata(e){const t=e.split("\n"),n=[],i=[];let a=!1,r=!1;for(const s of t){const e=s.replace(/^>\s?/,"");e.match(/^%%(\s*📎\s*Tuanki元数据)?$/)?(n.push(s),r=!0,a=!0):r&&e.match(/^%%$/)?(n.push(s),r=!1,a=!1):r?n.push(s):e.match(/^(uuid|created|modified|version|blockId):\s*/)||e.match(/^\^[a-zA-Z0-9-_]+$/)?(n.push(s),a=!0):a&&""===e.trim()?n.push(s):(i.push(s),a=!1)}return{hasMetadata:n.length>0,metadataLines:n,contentWithoutMetadata:i.join("\n")}}updateExistingMetadata(e,t){const{contentWithoutMetadata:n}=this.extractExistingMetadata(e);return`${n}\n>\n${t.split("\n").map(e=>e.trim()?`> ${e}`:">").join("\n")}`}insertNewMetadata(e,t,n){const i=t.split("\n").map(e=>e.trim()?`> ${e}`:">").join("\n");switch(n.metadataPosition){case"after_content":default:return`${e}\n>\n${i}`;case"before_tags":return this.insertBeforeTags(e,i)}}insertBeforeTags(e,t){const n=e.split("\n"),i=n.findIndex(e=>e.replace(/^>\s?/,"").match(/#[a-zA-Z0-9\u4e00-\u9fff/_-]+/));return-1!==i?(n.splice(i,0,">",...t.split("\n")),n.join("\n")):`${e}\n>\n${t}`}validateModification(e,t){const n=[];t.length-e.length<-50&&n.push("修改后内容长度显著减少，可能存在内容丢失");const i=t.match(/^>\s*\[!tuanki\]/gm);i&&0!==i.length||n.push("修改后未找到tuanki标注块");const a=t.match(/^>\s*(uuid|created|modified|version|blockId):\s*.+$/gm);return a&&0!==a.length||n.push("修改后未找到有效的元数据"),{isValid:0===n.length,errors:n}}countModifiedLines(e,t){const n=e.split("\n"),i=t.split("\n");return Math.abs(i.length-n.length)}createBackup(e,t){const n=`${e}-${Date.now()}`;if(this.backupStorage.set(n,t),this.backupStorage.size>100){const e=this.backupStorage.keys().next().value;e&&this.backupStorage.delete(e)}_e.debug(`💾 [DocumentModifier] 创建备份: ${n}`)}async restoreBackup(e,t){try{let n;if(t)n=`${e}-${t}`;else{const t=Array.from(this.backupStorage.keys()).filter(t=>t.startsWith(e)).sort().reverse();if(0===t.length)return _e.error("未找到备份文件"),!1;n=t[0]}const i=this.backupStorage.get(n);if(!i)return _e.error("备份内容不存在"),!1;const a=this.vault.getAbstractFileByPath(e);return a&&a instanceof ge.TFile?(await this.vault.modify(a,i),_e.debug(`🔄 [DocumentModifier] 备份恢复成功: ${n}`),!0):(_e.error("目标文件不存在"),!1)}catch(n){return _e.error("备份恢复失败:",n),!1}}recordModification(e){this.modificationHistory.push(e),this.modificationHistory.length>1e3&&this.modificationHistory.shift()}getModificationHistory(e){return e?this.modificationHistory.filter(t=>t.filePath===e):[...this.modificationHistory]}cleanup(){this.modificationHistory.length=0,this.backupStorage.clear(),_e.debug("🧹 [DocumentModifier] 清理完成")}async batchInsertMetadata(e,t={}){_e.debug(`📝 [DocumentModifier] 开始批量插入元数据: ${e.length} 个标注`);const n=[];for(const{annotation:a,metadata:r}of e)try{const e=await this.insertMetadata(a,r,t);n.push(e)}catch(i){n.push({success:!1,error:`批量处理失败: ${i instanceof Error?i.message:String(i)}`})}return _e.debug(`✅ [DocumentModifier] 批量元数据插入完成: ${n.length} 个结果`),n}async cleanupAnnotationByBlockId(e,t,n={renameCalloutToNote:!0}){try{const i=this.vault.getAbstractFileByPath(e);if(!(i&&i instanceof ge.TFile))return{success:!1,error:`文件不存在: ${e}`};const a=await this.vault.read(i),r=a.split("\n"),s=new RegExp(`^>\\s*\\^${t}\\s*$`),o=r.findIndex(e=>s.test(e.trim()));if(-1===o)return{success:!1,error:`未找到 blockId: ${t}`};let l=o;for(let e=o;e>=0;e--){if(/^>\s*\[!tuanki\]/.test(r[e])){l=e;break}if(!r[e].startsWith(">"))break}let c=o;for(let e=o+1;e<r.length;e++){if(!r[e].startsWith(">")){c=e-1;break}e===r.length-1&&(c=e)}if(l>c)return{success:!1,error:"标注块边界解析失败"};const d=r.slice(l,c+1),u=e=>{const n=e.replace(/^>\s?/,"").trim();return n===`^${t}`||!!/^(uuid|created|modified|version|blockId):\s*/.test(n)},h=d.filter(e=>!u(e));n.renameCalloutToNote&&h.length>0&&(h[0]=h[0].replace(/\[!tuanki\]/,"[!note]"));const p=r.slice(0,l).join("\n"),g=r.slice(c+1).join("\n"),v=[p,h.join("\n"),g].filter(Boolean).join("\n");return await this.vault.modify(i,v),this.recordModification({operation:"remove_metadata",filePath:e,timestamp:(new Date).toISOString(),originalContent:a,modifiedContent:v,metadata:{blockId:t},success:!0}),{success:!0,modified:Math.abs(v.length-a.length)}}catch(i){return _e.error("清理标注失败:",i),{success:!1,error:i instanceof Error?i.message:String(i)}}}};oe(th,"instance");let nh=th;function ih(e,t="info"){const n=document.createElement("div");n.className=`tuanki-notification notification-${t}`;Object.assign(n.style,{position:"fixed",top:"20px",right:"20px",background:(()=>{const e=document.body.classList.contains("theme-dark")||document.documentElement.classList.contains("theme-dark")||window.matchMedia("(prefers-color-scheme: dark)").matches,n={success:e?"#10b981":"#059669",error:e?"#ef4444":"#dc2626",warning:e?"#f59e0b":"#d97706",info:e?"#3b82f6":"#2563eb"};return n[t]||n.info})(),color:"white",padding:"12px 16px",borderRadius:"8px",display:"flex",alignItems:"center",gap:"8px",zIndex:"1000001",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",transform:"translateX(100%)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",fontSize:"14px",fontWeight:"500",maxWidth:"400px",minWidth:"200px",wordWrap:"break-word",fontFamily:'var(--font-interface, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif)'});const i=document.createElement("span");i.style.fontSize="16px",i.style.flexShrink="0";const a={success:"✓",error:"✕",warning:"⚠",info:"ℹ"};i.textContent=a[t]||a.info,n.appendChild(i);const r=document.createElement("span");if(r.textContent=e,r.style.flex="1",n.appendChild(r),document.body.appendChild(n),!document.querySelector("#tuanki-notification-styles")){const e=document.createElement("style");e.id="tuanki-notification-styles",e.textContent="\n      .tuanki-notification {\n        pointer-events: auto;\n        user-select: none;\n        backdrop-filter: blur(8px);\n      }\n\n      .tuanki-notification:hover {\n        transform: translateX(0) scale(1.02) !important;\n        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2) !important;\n      }\n\n      /* 深色模式适配 */\n      .theme-dark .tuanki-notification {\n        border: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      /* 浅色模式适配 */\n      .theme-light .tuanki-notification {\n        border: 1px solid rgba(0, 0, 0, 0.1);\n      }\n    ",document.head.appendChild(e)}setTimeout(()=>{n.style.transform="translateX(0)"},10),setTimeout(()=>{n.style.transform="translateX(100%)",setTimeout(()=>{n.parentNode&&n.remove()},300)},3e3)}class ah{constructor(){oe(this,"fsrs"),this.fsrs=new Is}parseClozes(e){var t;const n=[],i=[],a=/\{\{c(\d+)::([^:}]+)(?:::([^}]+))?\}\}/g;let r;const s=new Set;for(;null!==(r=a.exec(e));){const e=parseInt(r[1],10),a=e-1,o=r[2].trim(),l=null==(t=r[3])?void 0:t.trim();if(e<1){i.push(`Invalid cloze number: c${e} (must be >= 1)`);continue}s.add(a);const c=n.findIndex(e=>e.ord===a);c>=0?(n[c].text+=`, ${o}`,l&&!n[c].hint&&(n[c].hint=l)):n.push({ord:a,text:o,hint:l,position:{start:r.index,end:r.index+r[0].length}})}if(n.sort((e,t)=>e.ord-t.ord),n.length>0){const e=Array.from({length:n.length},(e,t)=>t),t=n.map(e=>e.ord),a=e.filter(e=>!t.includes(e));a.length>0&&i.push(`Cloze numbers are not continuous. Missing: ${a.map(e=>`c${e+1}`).join(", ")}`)}const o=s.size,l=o>=2;return{hasValidClozes:n.length>0&&0===i.length,clozes:n,totalClozes:o,isProgressive:l,errors:i.length>0?i:void 0}}canConvert(e){if(!e.content)return!1;const t=this.parseClozes(e.content);return t.isProgressive&&t.hasValidClozes}convert(e,t={}){var n;const i=this.parseClozes(e.content);if(!i.hasValidClozes)throw new Error(`Card cannot be converted: ${(null==(n=i.errors)?void 0:n.join("; "))||"No valid clozes"}`);if(!i.isProgressive)throw new Error(`Card has only ${i.totalClozes} cloze(s), need at least 2 for progressive cloze`);const{inheritFsrs:a=!1,inheritanceMode:r="first-only",keepParent:s=!0,createdAt:o=(new Date).toISOString()}=t,l=this.createChildCards(e,i.clozes,{inheritFsrs:a,inheritanceMode:r,createdAt:o});return{parent:this.createParentCard(e,l,i.clozes),children:l}}createParentCard(e,t,n){return{...e,uuid:e.uuid,type:Kr.ProgressiveParent,content:e.content,progressiveCloze:{childCardIds:t.map(e=>e.uuid),totalClozes:n.length,createdAt:(new Date).toISOString()},fsrs:void 0,reviewHistory:void 0,modified:(new Date).toISOString()}}createChildCards(e,t,n){const i=[];for(let a=0;a<t.length;a++){const r=t[a];let s,o=[];const l=a*5;"none"!==n.inheritanceMode?"first-only"===n.inheritanceMode&&0===a?e.fsrs?(s=this.cloneFsrsData(e.fsrs),o=e.reviewHistory||[]):s=this.createNewFsrs(l):"proportional"===n.inheritanceMode&&e.fsrs?(s=this.cloneFsrsData(e.fsrs),o=e.reviewHistory||[]):s=this.createNewFsrs(l):s=this.createNewFsrs(l);const c={...e,uuid:Vu(),type:Kr.ProgressiveChild,parentCardId:e.uuid,clozeOrd:r.ord,content:e.content,fsrs:s,reviewHistory:o,clozeSnapshot:{text:r.text,hint:r.hint},progressiveCloze:void 0,created:n.createdAt,modified:n.createdAt};i.push(c)}return i}createNewFsrs(e=0){const t=new Date;return e>0&&t.setDate(t.getDate()+e),{due:t.toISOString(),stability:0,difficulty:5,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:0,lastReview:void 0,retrievability:1}}cloneFsrsData(e){return{...e}}convertBatch(e,t={}){return e.map(e=>{try{if(!this.canConvert(e))return{sourceCard:e,parent:null,children:[],success:!1,error:"Card cannot be converted to progressive cloze"};const{parent:n,children:i}=this.convert(e,t);return{sourceCard:e,parent:n,children:i,success:!0}}catch(n){return{sourceCard:e,parent:null,children:[],success:!1,error:n instanceof Error?n.message:String(n)}}})}}const rh=xe.getInstance();class sh{constructor(){oe(this,"converter"),this.converter=new ah}processNewCard(e){rh.debug(`[CardCreationProcessor] Processing new card: ${e.uuid}`);try{if(!this.converter.canConvert(e))return rh.debug("[CardCreationProcessor] Not a progressive cloze card"),{success:!0,cards:[e]};const{parent:t,children:n}=this.converter.convert(e,{inheritFsrs:!1,keepParent:!0});return rh.info(`[CardCreationProcessor] Converted to progressive cloze: 1 parent + ${n.length} children`),{success:!0,cards:[t,...n],parent:t,children:n}}catch(t){return rh.error(`[CardCreationProcessor] Failed to process card: ${e.uuid}`,t),{success:!1,cards:[e],error:t instanceof Error?t.message:String(t)}}}processCards(e){return e.map(e=>this.processNewCard(e))}}const oh=/^Q:\s*(.+?)$/m,lh=/^([A-H])\)\s*(.+?)(\s*\{[✓✔]\})?$/gm,ch=/\{[✓✔]\}|(?:^|\s)[✓✔](?:\s|$)/,dh=/==([^=]+)==/g,uh=/\{\{c(\d+)::([^:}]+)(?:::([^}]+))?\}\}/g,hh=/^([A-Z][a-zA-Z]+):\s*(.+?)$/gm,ph=/^Explanation:\s*(.+?)(?=\n[A-Z][a-zA-Z]+:|$)/ms,gh=/\[\[([^\]]+)\]\]/g;class vh{extractMetadataSection(e){if(!function(e){return xu.META_SEPARATOR.test(e)}(e))return{mainContent:e,metadataContent:"",hasMetadata:!1};const{mainContent:t,metadataContent:n}=function(e){const t=e.match(xu.META_SEPARATOR);if(!t||"number"!=typeof t.index)return{mainContent:e,metadataContent:""};const n=t.index;return{mainContent:e.substring(0,n).trim(),metadataContent:e.substring(n+t[0].length).trim()}}(e);return{mainContent:t,metadataContent:n,hasMetadata:!0}}parseExtraFields(e){if(!e)return{};const t=function(e){const t={},n=e.match(ph);n&&(t.explanation=n[1].trim());const i=e.matchAll(hh);for(const a of i){const e=a[1],n=a[2].trim();"Explanation"===e&&t.explanation||(t[e.charAt(0).toLowerCase()+e.slice(1)]=n)}return t}(e),n={};t.hint&&(n.hint=t.hint),t.explanation&&(n.explanation=t.explanation),t.context&&(n.context=t.context),t.difficulty&&(n.difficulty=t.difficulty),t.source&&(n.source=t.source),t.tags&&(n.customFields=n.customFields||{},n.customFields.tags=t.tags),t.related&&(n.related=function(e){const t=[],n=e.matchAll(gh);for(const i of n){const e=i[1].trim();e&&!t.includes(e)&&t.push(e)}return t}(t.related));const i=["hint","explanation","context","difficulty","source","tags","related"];for(const[a,r]of Object.entries(t))i.includes(a)||(n.customFields=n.customFields||{},n.customFields[a]=r);return n}buildMetadataSection(e){if(!e||0===Object.keys(e).length)return"";let t="\n\n---meta---\n\n";if(e.explanation&&(t+=`Explanation: ${e.explanation}\n\n`),e.difficulty&&(t+=`Difficulty: ${e.difficulty}\n`),e.source&&(t+=`Source: ${e.source}\n`),e.related&&e.related.length>0){t+=`Related: ${e.related.map(e=>`[[${e}]]`).join(", ")}\n`}if(e.customFields)for(const[n,i]of Object.entries(e.customFields))if("tags"===n)t+=`Tags: ${i}\n`;else{t+=`${n.charAt(0).toUpperCase()+n.slice(1)}: ${i}\n`}return t}createSuccessResult(e,t,n,i){return{success:!0,fields:e,metadata:n,rawContent:t,warnings:i}}createErrorResult(e,t,n,i){return{success:!1,fields:{},rawContent:n,error:{type:e,message:t,suggestion:i}}}validateRequiredFields(e,t){const n=[];for(const i of t)e[i]&&""!==e[i].trim()||n.push(i);return{valid:0===n.length,missing:n}}cleanFieldContent(e){return e.trim().replace(/\n{3,}/g,"\n\n").replace(/[ \t]+$/gm,"")}}var fh=(e=>(e.INVALID_FORMAT="invalid_format",e.MISSING_REQUIRED_FIELD="missing_required_field",e.INVALID_METADATA="invalid_metadata",e.UNKNOWN_CARD_TYPE="unknown_card_type",e.MISSING_CORRECT_MARKER="missing_correct_marker",e.NO_CLOZE_FOUND="no_cloze_found",e))(fh||{});class mh extends vh{parseMarkdownToFields(e,t){try{const t=e.trim();if(!t)return this.createErrorResult(fh.INVALID_FORMAT,"内容为空",e,"请输入卡片内容");const n=t.indexOf(ku);let i,a;n>=0?(i=t.substring(0,n).trim(),a=t.substring(n+9).trim()):(i=t,a="");const r={front:i,back:a};if(!i)return this.createErrorResult(fh.MISSING_REQUIRED_FIELD,"正面内容不能为空",e,"请输入问题或正面内容");const s=[];return a||s.push("背面内容为空，建议添加答案"),this.createSuccessResult(r,e,void 0,s.length>0?s:void 0)}catch(n){return this.createErrorResult(fh.INVALID_FORMAT,`解析失败: ${n instanceof Error?n.message:String(n)}`,e)}}buildMarkdownFromFields(e,t){const n=e.front||e.Front||"",i=e.back||e.Back||"";return n?i?`${n}\n\n${ku}\n\n${i}`:n:""}}class yh extends vh{parseMarkdownToFields(e,t){var n,i;try{const t=e.trim();if(!t)return this.createErrorResult(fh.INVALID_FORMAT,"内容为空",e,"请输入选择题内容");const a=this.parseChoiceContent(t);if(!a.success)return this.createErrorResult(a.errorType,a.errorMessage,e,a.suggestion);const r={front:a.question,back:a.explanation||"",options:this.serializeOptions(a.options),correctAnswers:null==(n=a.correctAnswers)?void 0:n.join(",")},s=this.validateRequiredFields(r,["front","options"]);if(!s.valid)return this.createErrorResult(fh.MISSING_REQUIRED_FIELD,`缺少必需字段: ${s.missing.join(", ")}`,e);const o=[];return 0===(null==(i=a.correctAnswers)?void 0:i.length)&&o.push("未找到正确答案标记{✓}"),this.createSuccessResult(r,e,void 0,o.length>0?o:void 0)}catch(a){return this.createErrorResult(fh.INVALID_FORMAT,`解析失败: ${a instanceof Error?a.message:String(a)}`,e)}}parseChoiceContent(e){const t=e.match(oh);if(!t)return{success:!1,errorType:fh.INVALID_FORMAT,errorMessage:"未找到问题部分（Q:）",suggestion:"选择题必须以 Q: 开头"};const n=this.cleanFieldContent(t[1]),i=e.substring(t.index+t[0].length),a=i.match(/^([A-H])\)/m);if(!a)return{success:!1,errorType:fh.INVALID_FORMAT,errorMessage:"未找到选项（A) B) C)等）",suggestion:"选项必须使用 A) B) C) D) 格式"};const r=i.indexOf(a[0]),s=i.indexOf(`\n${ku}`),o=s>=0?s:i.length,l=function(e){const t=[],n=e.matchAll(lh);for(const i of n){const e=i[1],n=i[2].trim(),a=!!i[3],r=n.replace(ch,"").trim();t.push({label:`${e})`,text:r,isCorrect:a})}return t}(i.substring(r,o));if(0===l.length)return{success:!1,errorType:fh.INVALID_FORMAT,errorMessage:"无法解析选项",suggestion:"请检查选项格式是否正确"};const c=l.filter(e=>e.isCorrect).map(e=>e.label);let d;if(s>=0){const e=i.substring(s+9+2).trim();e&&(d=this.cleanFieldContent(e))}return{success:!0,question:n,options:l,correctAnswers:c,explanation:d}}serializeOptions(e){return e.map(e=>`${e.label} ${e.text}${e.isCorrect?" {✓}":""}`).join("\n")}buildMarkdownFromFields(e,t){let n="";const i=e.front||e.Front||"";n+=`${Su.QUESTION} ${i}\n\n`,e.options&&(n+=`${e.options}\n\n`);const a=e.back||e.Back||"";return a&&(n+=`${ku}\n\n`,n+=a),n.trim()}}class bh{analyze(e){const t=e.matchAll(/\{\{c(\d+)::([^}:]+)(?:::([^}]+))?\}\}/g),n=Array.from(t),i=e.matchAll(/==([^=]+)==/g),a=Array.from(i),r=this.extractProgressiveClozes(e);return{hasProgressiveCloze:n.length>0,hasHighlight:a.length>0,clozeCount:n.length,highlightCount:a.length,shouldSplit:n.length>1,clozes:r}}extractProgressiveClozes(e){var t;const n=[],i=/\{\{c(\d+)::([^}:]+)(?:::([^}]+))?\}\}/g;let a;for(;null!==(a=i.exec(e));){const e=parseInt(a[1])-1,i=a[2].trim(),r=null==(t=a[3])?void 0:t.trim();n.push({ord:e,text:i,hint:r,startPos:a.index,endPos:a.index+a[0].length,uuid:this.generateClozeUUID(e,i),syntax:"anki"})}return n.sort((e,t)=>e.ord-t.ord)}generateClozeUUID(e,t){return`cloze-${e}-${this.simpleHash(`${e}-${t}`)}`}simpleHash(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(36)}validateClozeNumbers(e){const t=e.map(e=>e.ord),n=[...new Set(t)],i=t.filter((e,n)=>t.indexOf(e)!==n),a=[...new Set(i)],r=Math.max(...n),s=[];for(let o=0;o<=r;o++)n.includes(o)||s.push(o+1);return{valid:0===i.length&&0===s.length,missingNumbers:s,duplicateNumbers:a.map(e=>e+1)}}getMaxClozeNumber(e){const t=e.matchAll(/\{\{c(\d+)::/g),n=Array.from(t).map(e=>parseInt(e[1]));return n.length>0?Math.max(...n):0}hasProgressiveCloze(e){return/\{\{c\d+::.+?\}\}/.test(e)}hasObsidianHighlight(e){return/==.+?==/.test(e)}}class wh extends vh{parseMarkdownToFields(e,t){try{const t=e.trim();if(!t)return this.createErrorResult(fh.INVALID_FORMAT,"内容为空",e,"请输入挖空题内容");const n=new bh,i=n.analyze(t);if(!i.hasProgressiveCloze&&!i.hasHighlight)return this.createErrorResult(fh.NO_CLOZE_FOUND,"未找到挖空标记",e,"请使用 ==内容== 或 {{c1::内容}} 标记挖空部分");if(i.hasProgressiveCloze){const t=n.validateClozeNumbers(i.clozes);if(!t.valid){let n="挖空编号不连续";return t.missingNumbers.length>0&&(n+=`，缺少: c${t.missingNumbers.join(", c")}`),t.duplicateNumbers.length>0&&(n+=`，重复: c${t.duplicateNumbers.join(", c")}`),this.createErrorResult(fh.INVALID_FORMAT,n,e,"请确保挖空编号从c1开始连续递增")}}const a={text:t},r=this.createSuccessResult(a,e,void 0);return{...r,metadata:{...r.metadata,clozeAnalysis:i}}}catch(n){return this.createErrorResult(fh.INVALID_FORMAT,`解析失败: ${n instanceof Error?n.message:String(n)}`,e)}}buildMarkdownFromFields(e,t){return e.text||e.Text||e.front||e.Front||""}static convertObsidianToAnkiStyle(e){let t=e,n=1;return t=t.replace(dh,()=>{const e=`{{c${n}::$1}}`;return n++,e}),t}static convertAnkiToObsidianStyle(e){return e.replace(uh,(e,t,n,i)=>i?`==${n}==(${i})`:`==${n}==`)}}const kh=class e{constructor(){oe(this,"contentExtractor"),oe(this,"metadataGenerator"),oe(this,"dataStorage"),oe(this,"deckService"),oe(this,"templateService"),oe(this,"fsrs"),oe(this,"plugin"),oe(this,"cardCreationProcessor"),this.contentExtractor=wu.getInstance(),this.metadataGenerator=eh.getInstance(),this.cardCreationProcessor=new sh}static getInstance(){return e.instance||(e.instance=new e),e.instance}injectServices(e){this.dataStorage=e.dataStorage,this.deckService=e.deckService,this.templateService=e.templateService,this.fsrs=e.fsrs,this.plugin=e.plugin}async createCardFromAnnotation(e,t={}){_e.debug(`🎯 [CardCreationBridge] 开始创建卡片: ${e.id}`);try{if(e.isProcessed&&!t.skipDuplicateCheck)return{success:!1,error:{type:Jo.DUPLICATE_UUID,message:"该标注已经处理过，存在对应的卡片",timestamp:(new Date).toISOString(),annotationId:e.id,recoverable:!1}};const i=this.contentExtractor.extractContent(e);if(!i.success)return{success:!1,error:{type:Jo.PARSE_ERROR,message:i.error||"内容提取失败",timestamp:(new Date).toISOString(),annotationId:e.id,recoverable:!0}};const a=await this.matchDeck(e.deckTemplate,t);if(!a)return{success:!1,error:{type:Jo.DECK_NOT_FOUND,message:"无法找到或创建合适的牌组",timestamp:(new Date).toISOString(),annotationId:e.id,recoverable:!0}};const r=await this.matchTemplate(e.deckTemplate,i.content||"",t);if(!r)return{success:!1,error:{type:Jo.TEMPLATE_NOT_FOUND,message:"无法找到合适的模板",timestamp:(new Date).toISOString(),annotationId:e.id,recoverable:!0}};const s=this.metadataGenerator.generateMetadata(e,{updateModifiedTime:!0}),o=await this.buildCardData(e,i.content||"",a,r,s.metadata,t);try{e.position.filePath&&s.metadata&&(await nh.getInstance().insertMetadata(e,s.metadata,{createBackup:!1,validateResult:!0,preserveFormatting:!0,forceOverwrite:!1}),_e.debug("✅ [CardCreationBridge] UUID已写回文档"))}catch(n){_e.warn("⚠️ 一次性写回 uuid/^blockId 失败（已忽略，不影响卡片创建）",n)}const l=await this.createCard(o);_e.debug(`✅ [CardCreationBridge] 卡片创建成功: ${l.uuid}, type=${l.type}, templateId=${l.templateId}`);const c=(l.content||"").substring(0,30).replace(/\n/g," ");return ih("✅ 卡片已创建"+(c?`：${c}...`:""),"success"),_e.debug(`[CardCreationBridge] 卡片创建完成，type=${l.type}，progressiveCloze将在学习时检测`),{success:!0,card:l,createdNewDeck:a.isNewDeck,usedTemplateId:r.templateId,warnings:i.warnings}}catch(i){_e.error("❌ [CardCreationBridge] 卡片创建失败:",i);const t=i;return{success:!1,error:{type:Jo.CARD_CREATION_ERROR,message:`卡片创建失败: ${t.message||String(i)}`,timestamp:(new Date).toISOString(),annotationId:e.id,stack:t.stack,recoverable:!0}}}}async matchDeck(e,t){try{if(e.deckName){const n=await this.findDeckByName(e.deckName);if(n)return{deckId:n.id,deckName:n.name,isNewDeck:!1,confidence:1};if(t.autoCreateDeck){const t=await this.createDeck(e.deckName);return{deckId:t.id,deckName:t.name,isNewDeck:!0,confidence:1}}}if(t.defaultDeckId){const e=await this.getDeckById(t.defaultDeckId);if(e)return{deckId:e.id,deckName:e.name,isNewDeck:!1,confidence:.5}}const n=await this.getAllDecks();if(n.length>0){const e=n[0];return{deckId:e.id,deckName:e.name,isNewDeck:!1,confidence:.3}}return null}catch(n){return _e.error("牌组匹配失败:",n),null}}detectContentType(e){const t=this.detectCardTypeFromContent(e);let n;switch(t){case Kr.Cloze:n=yu.CLOZE;break;case Kr.Multiple:n=yu.MULTI_CHOICE;break;case Kr.Code:n=yu.CODE;break;default:n=yu.QUESTION_ANSWER}return _e.debug(`[CardCreationBridge] detectContentType: cardType=${t} → contentType=${n}`),n}async matchTemplate(e,t,n){try{const e=this.detectContentType(t),i=await this.findTemplateByContentType(e);if(i)return _e.debug(`[CardCreationBridge] matchTemplate: 匹配到模板 ${i.id} (${i.name}), contentType=${e}`),{templateId:i.id,templateName:i.name,confidence:.8,contentType:e};if(_e.warn(`[CardCreationBridge] matchTemplate: 未找到contentType=${e}对应的模板，尝试默认模板`),n.defaultTemplateId){const t=await this.getTemplateById(n.defaultTemplateId);if(t)return{templateId:t.id,templateName:t.name,confidence:.5,contentType:e}}const a=await this.getBasicTemplate();return a?{templateId:a.id,templateName:a.name,confidence:.3,contentType:e}:null}catch(i){return _e.error("模板匹配失败:",i),null}}async buildCardData(e,t,n,i,a,r){var s;const o=(new Date).toISOString(),l=this.detectCardTypeFromContent(t);return _e.debug(`[CardCreationBridge] buildCardData: 从内容检测到cardType=${l}, templateId=${i.templateId}`),_e.debug("[CardCreationBridge] Content-Only 架构：使用 content 作为唯一数据源"),{uuid:a.uuid,deckId:n.deckId,type:l,content:t,tags:this.extractTags(t),sourceFile:e.position.filePath,sourceBlock:a.blockId?`^${a.blockId}`:void 0,created:a.created||o,modified:a.modified||o,fsrs:(null==(s=this.fsrs)?void 0:s.createCard())||this.createDefaultFSRSData()}}getParserForCardType(e){switch(e){case Kr.Basic:return new mh;case Kr.Multiple:return new yh;case Kr.Cloze:return new wh;default:return new mh}}extractTags(e){const t=/#([a-zA-Z0-9\u4e00-\u9fff/_-]+)/g,n=[];let i;for(;null!==(i=t.exec(e));){const e=i[1];e.includes("/")||n.push(e)}return n}detectCardTypeFromContent(e){_e.debug(`[CardCreationBridge] detectCardTypeFromContent - 内容预览: ${e.substring(0,100)}`);const t=e.includes("{{c"),n=/==.+?==/s.test(e);return t||n?(_e.debug(`[CardCreationBridge] ✅ 检测到挖空标记 (Anki: ${t}, Markdown: ${n})，返回CardType.Cloze`),Kr.Cloze):e.includes("---choice---")||/^[A-D][.)、]\s/m.test(e)?(_e.debug("[CardCreationBridge] ✅ 检测到选择题标记，返回CardType.Multiple"),Kr.Multiple):(_e.debug("[CardCreationBridge] ⚠️ 未检测到特殊标记，返回CardType.Basic"),Kr.Basic)}mapContentTypeToCardType(e){switch(e){case yu.CLOZE:return Kr.Cloze;case yu.CODE:return Kr.Code;case yu.MULTI_CHOICE:return Kr.Multiple;default:return Kr.Basic}}createDefaultFSRSData(){return{due:(new Date).toISOString(),stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,state:0,last_review:null}}async findDeckByName(e){var t,n,i,a;try{return null!=(a=(await(null!=(i=null==(n=null==(t=this.dataStorage)?void 0:t.getAllDecks)?void 0:n.call(t))?i:Promise.resolve([]))).find(t=>t.name===e))?a:null}catch(r){return null}}async createDeck(e){throw new Error("创建牌组功能需要实现")}async getDeckById(e){var t,n,i,a,r;try{if(null==(t=this.dataStorage)?void 0:t.getDeck)return await this.dataStorage.getDeck(e);return null!=(r=(await(null!=(a=null==(i=null==(n=this.dataStorage)?void 0:n.getAllDecks)?void 0:i.call(n))?a:Promise.resolve([]))).find(t=>t.id===e))?r:null}catch(s){return null}}async getAllDecks(){var e,t,n;try{return await(null!=(n=null==(t=null==(e=this.dataStorage)?void 0:e.getAllDecks)?void 0:t.call(e))?n:Promise.resolve([]))}catch(i){return[]}}async findTemplateByName(e){var t,n,i;try{return await(null!=(i=null==(n=null==(t=this.templateService)?void 0:t.getTemplateByName)?void 0:n.call(t,e))?i:Promise.resolve(null))}catch(a){return null}}async findTemplateByContentType(e){var t,n;try{const i={[yu.QUESTION_ANSWER]:"official-qa",[yu.CLOZE]:"official-cloze",[yu.CODE]:"official-qa",[yu.MULTI_CHOICE]:"official-choice",[yu.BASIC]:"official-qa"},a={[yu.QUESTION_ANSWER]:"通用问答题",[yu.CLOZE]:"填空题",[yu.CODE]:"通用问答题",[yu.MULTI_CHOICE]:"选择题",[yu.BASIC]:"通用问答题"},r=i[e]||"official-qa",s=a[e]||"通用问答题",o=await(null==(n=null==(t=this.templateService)?void 0:t.getTemplateById)?void 0:n.call(t,r));return o||(_e.warn(`[CardCreationBridge] 模板 ${r} 不存在，使用fallback`),{id:r,name:s})}catch(i){return _e.error("[CardCreationBridge] 模板查询失败:",i),{id:"official-qa",name:"通用问答题"}}}async getTemplateById(e){var t,n,i;try{return await(null!=(i=null==(n=null==(t=this.templateService)?void 0:t.getTemplateById)?void 0:n.call(t,e))?i:Promise.resolve(null))}catch(a){return null}}async getBasicTemplate(){var e,t,n;try{const i={id:"official-qa",name:"通用问答题"},a=await(null!=(n=null==(t=null==(e=this.templateService)?void 0:e.getTemplateById)?void 0:t.call(e,i.id))?n:Promise.resolve(null));return null!=a?a:i}catch(i){return{id:"official-qa",name:"通用问答题"}}}async createCard(e){var t;const n=this.cardCreationProcessor.processNewCard(e);if(null==(t=this.dataStorage)?void 0:t.saveCard)return await this.dataStorage.saveCard(n);throw new Error("卡片创建服务未初始化")}};oe(kh,"instance");let Sh=kh;const xh=class e{constructor(){oe(this,"annotationDetector"),oe(this,"contentExtractor"),oe(this,"metadataGenerator"),oe(this,"cardCreationBridge"),oe(this,"documentModifier"),oe(this,"vault",null),oe(this,"currentStatus",Xo.IDLE),oe(this,"syncStatusInfo",{status:Xo.IDLE,processedCount:0,totalCount:0,errorCount:0}),oe(this,"taskQueue",[]),oe(this,"processingTasks",new Set),oe(this,"duplicateCache",new Map),oe(this,"statusListeners",[]),this.annotationDetector=mu.getInstance(),this.contentExtractor=wu.getInstance(),this.metadataGenerator=eh.getInstance(),this.cardCreationBridge=Sh.getInstance(),this.documentModifier=nh.getInstance()}setVault(e){this.vault=e}static getInstance(){return e.instance||(e.instance=new e),e.instance}async syncFile(e,t={}){_e.debug(`🔄 [SyncManager] 开始同步文件: ${e}`),this.updateStatus(Xo.DETECTING,{currentFile:e});try{const n=await this.readFileContent(e),i=this.annotationDetector.detectAnnotationsInText(n,e);_e.debug(`🔍 [SyncManager] 检测到 ${i.length} 个标注`);const a=await this.filterAnnotations(i,t),r=await this.batchProcessAnnotations(a,t);return this.updateStatus(Xo.COMPLETED),_e.debug(`✅ [SyncManager] 文件同步完成: 成功=${r.successCount}, 失败=${r.failureCount}`),r.successCount>0&&ih(`✅ 成功创建 ${r.successCount} 张卡片`,"success"),r}catch(n){return _e.error("❌ [SyncManager] 文件同步失败:",n),this.updateStatus(Xo.ERROR),{totalProcessed:0,successCount:0,failureCount:1,skippedCount:0,results:[{annotationId:"unknown",success:!1,error:n instanceof Error?n.message:String(n)}],processingTime:0}}}async syncMultipleFiles(e,t={}){_e.debug(`🔄 [SyncManager] 开始批量同步: ${e.length} 个文件`);const n=Date.now(),i={totalProcessed:0,successCount:0,failureCount:0,skippedCount:0,results:[],processingTime:0};this.updateStatus(Xo.PROCESSING,{totalCount:e.length,processedCount:0});for(let r=0;r<e.length;r++){const n=e[r];try{const a=await this.syncFile(n,t);i.totalProcessed+=a.totalProcessed,i.successCount+=a.successCount,i.failureCount+=a.failureCount,i.skippedCount+=a.skippedCount,i.results.push(...a.results),this.updateStatus(Xo.PROCESSING,{processedCount:r+1,totalCount:e.length})}catch(a){_e.error(`文件同步失败: ${n}`,a),i.failureCount++}}return i.processingTime=Date.now()-n,this.updateStatus(Xo.COMPLETED),_e.debug(`✅ [SyncManager] 批量同步完成: ${JSON.stringify(i)}`),i}async filterAnnotations(e,t){const n=[];for(const i of e){if(t.skipDuplicateCheck){n.push(i);continue}!(await this.checkDuplicate(i)).isDuplicate||t.forceSync?this.validateAnnotation(i)?n.push(i):_e.warn(`⚠️ [SyncManager] 标注验证失败: ${i.id}`):_e.debug(`⏭️ [SyncManager] 跳过重复标注: ${i.id}`)}return n}async batchProcessAnnotations(e,t){var n;const i=Date.now(),a=[],r=t.maxConcurrency||3,s=this.chunkArray(e,r);for(const c of s){const e=c.map(e=>this.processAnnotation(e,t)),i=await Promise.allSettled(e);for(let t=0;t<i.length;t++){const e=i[t],r=c[t];"fulfilled"===e.status?a.push({annotationId:r.id,success:e.value.success,cardId:e.value.cardId,error:e.value.error}):a.push({annotationId:r.id,success:!1,error:(null==(n=e.reason)?void 0:n.message)||"处理失败"})}}const o=a.filter(e=>e.success).length,l=a.filter(e=>!e.success).length;return{totalProcessed:a.length,successCount:o,failureCount:l,skippedCount:0,results:a,processingTime:Date.now()-i}}async processAnnotation(e,t){var n,i;const a=`${e.position.filePath}:${e.position.startLine}:${e.metadata.blockId||""}:${e.metadata.uuid||""}`;if(this.processingTasks.has(a))return _e.warn(`⏭️ [SyncManager] 跳过重复中的标注处理: ${a}`),{success:!1,error:"重复处理已在进行中"};this.processingTasks.add(a);try{_e.debug(`🔄 [SyncManager] 处理标注: ${e.id}`);const a=await this.cardCreationBridge.createCardFromAnnotation(e,{autoCreateDeck:t.autoCreateDecks,defaultDeckId:t.defaultDeckId,defaultTemplateId:t.defaultTemplateId});return a.success?(this.updateDuplicateCache(e),_e.debug(`✅ [SyncManager] 标注处理完成: ${e.id}`),{success:!0,cardId:null==(i=a.card)?void 0:i.id}):{success:!1,error:(null==(n=a.error)?void 0:n.message)||"卡片创建失败"}}catch(r){return _e.error(`❌ [SyncManager] 标注处理失败: ${e.id}`,r),{success:!1,error:r instanceof Error?r.message:String(r)}}finally{this.processingTasks.delete(a)}}async checkDuplicate(e){if(e.metadata.uuid){const t=this.duplicateCache.get(e.metadata.uuid);if(t)return{isDuplicate:!0,existingAnnotation:t,conflictReason:"UUID重复",canMerge:!1}}if(e.metadata.contentHash)for(const[t,n]of this.duplicateCache)if(n.metadata.contentHash===e.metadata.contentHash&&n.position.filePath===e.position.filePath)return{isDuplicate:!0,existingAnnotation:n,conflictReason:"内容重复",canMerge:!0};return{isDuplicate:!1}}validateAnnotation(e){return!!(e.id&&e.cardContent&&e.position)&&(!(e.cardContent.trim().length<5)&&!!e.position.filePath)}updateDuplicateCache(e){e.metadata.uuid&&this.duplicateCache.set(e.metadata.uuid,e)}updateStatus(e,t){this.currentStatus=e,this.syncStatusInfo={...this.syncStatusInfo,status:e,...t},this.statusListeners.forEach(e=>{try{e(this.syncStatusInfo)}catch(t){_e.error("状态监听器执行失败:",t)}})}addStatusListener(e){this.statusListeners.push(e)}removeStatusListener(e){const t=this.statusListeners.indexOf(e);t>-1&&this.statusListeners.splice(t,1)}getCurrentStatus(){return{...this.syncStatusInfo}}clearCache(){this.duplicateCache.clear(),this.taskQueue.length=0,this.processingTasks.clear(),_e.debug("🧹 [SyncManager] 缓存已清理")}chunkArray(e,t){const n=[];for(let i=0;i<e.length;i+=t)n.push(e.slice(i,i+t));return n}async readFileContent(e){if(!this.vault)throw new Error("Vault not set in SyncManager");const t=this.vault.getAbstractFileByPath(e);if(t instanceof ge.TFile)return await this.vault.read(t);throw new Error(`文件不存在或不是可读取文件: ${e}`)}};oe(xh,"instance");let _h=xh;const Ch=class e{constructor(){oe(this,"vault"),oe(this,"annotationDetector"),oe(this,"syncManager"),oe(this,"plugin"),oe(this,"options",{debounceDelay:1e3,watchAllFiles:!0,watchedExtensions:[".md"],excludePatterns:[/\.obsidian/,/node_modules/],autoSync:!0,maxConcurrency:3,onlyActiveFileAutoSync:!0,initialScanAutoSync:!1,getActiveFilePath:void 0}),oe(this,"isWatching",!1),oe(this,"fileChangeRecords",new Map),oe(this,"eventRefs",[]),oe(this,"changeListeners",[]),oe(this,"eventListeners",[]),oe(this,"idleScanQueue",[]),oe(this,"isIdleScanning",!1),oe(this,"simpleSyncEngine",null),this.annotationDetector=mu.getInstance(),this.syncManager=_h.getInstance()}static getInstance(){return e.instance||(e.instance=new e),e.instance}initialize(e,t){this.vault=e,(null==t?void 0:t.plugin)&&(this.plugin=t.plugin,t.plugin=void 0),this.options={...this.options,...t},_e.debug("👁️ [AnnotationFileWatcher] 初始化完成")}startWatching(){if(this.isWatching)return;_e.info("📡 [AnnotationFileWatcher] 标注监听已启动（实时模式）");const e=this.vault.on("modify",e=>{e instanceof ge.TFile&&this.handleFileModified(e)}),t=this.vault.on("create",e=>{e instanceof ge.TFile&&this.handleFileCreated(e)}),n=this.vault.on("delete",e=>{e instanceof ge.TFile&&this.handleFileDeleted(e)}),i=this.vault.on("rename",async(e,t)=>{e instanceof ge.TFile&&await this.handleFileRenamed(e,t)});this.eventRefs=[e,t,n,i],this.isWatching=!0,_e.info("💡 [AnnotationFileWatcher] 提示: 使用 triggerScan() 手动扫描文件")}stopWatching(){this.isWatching&&(_e.debug("停止监听文件变更"),this.eventRefs.forEach(e=>{this.vault.offref(e)}),this.eventRefs=[],this.fileChangeRecords.forEach(e=>{e.pendingTimeout&&clearTimeout(e.pendingTimeout)}),this.fileChangeRecords.clear(),this.isWatching=!1)}async handleFileModified(e){if(!this.shouldWatchFile(e))return;if(this.options.onlyActiveFileAutoSync&&this.options.getActiveFilePath){const t=this.options.getActiveFilePath();if(t&&e.path!==t)return}const t=this.fileChangeRecords.get(e.path);(null==t?void 0:t.pendingTimeout)&&clearTimeout(t.pendingTimeout);const n=setTimeout(async()=>{await this.processFileChange(e,!1)},this.options.debounceDelay),i={filePath:e.path,lastModified:e.stat.mtime,lastContent:"",lastAnnotationCount:0,pendingTimeout:n};this.fileChangeRecords.set(e.path,i)}async handleFileCreated(e){this.shouldWatchFile(e)&&setTimeout(async()=>{await this.processFileChange(e,!0)},this.options.debounceDelay)}handleFileDeleted(e){const t=this.fileChangeRecords.get(e.path);(null==t?void 0:t.pendingTimeout)&&clearTimeout(t.pendingTimeout),this.fileChangeRecords.delete(e.path),this.emitEvent({type:el.ANNOTATION_PROCESSED,data:{action:"file_deleted",filePath:e.path},timestamp:(new Date).toISOString(),source:"AnnotationFileWatcher"})}async handleFileRenamed(e,t){const n=this.fileChangeRecords.get(t);n&&(n.filePath=e.path,this.fileChangeRecords.delete(t),this.fileChangeRecords.set(e.path,n));try{const{UUIDRegistry:n}=await Promise.resolve().then(()=>T_e);n.getInstance().updateFilePath(t,e.path)}catch(i){_e.error("[AnnotationFileWatcher] 更新UUID注表失败:",i)}}async processFileChange(e,t=!1){try{const i=await this.vault.read(e),a=this.annotationDetector.detectAnnotationsInText(i,e.path);if(a.length>0&&_e.debug(`📊 [AnnotationFileWatcher] ${e.path}: 发现 ${a.length} 个标注`),this.options.autoSync&&!t&&a.length>0){if(this.options.onlyActiveFileAutoSync&&this.options.getActiveFilePath){const t=this.options.getActiveFilePath();if(t&&e.path!==t)return}const t=await this.getSimpleSyncEngine();if(t)for(const e of a)try{await t.smartSync(e)}catch(n){_e.error("❌ [AnnotationFileWatcher] 同步标注失败:",n)}}}catch(n){_e.error(`❌ [AnnotationFileWatcher] 处理文件变更失败: ${e.path}`,n)}}shouldWatchFile(e){if(this.options.watchedExtensions&&this.options.watchedExtensions.length>0){if(!this.options.watchedExtensions.some(t=>e.path.endsWith(t)))return!1}if(this.options.excludePatterns){if(this.options.excludePatterns.some(t=>t.test(e.path)))return!1}return!0}async triggerScan(e="active-only"){switch(_e.info(`🔍 [AnnotationFileWatcher] 触发扫描: ${e}`),e){case"active-only":await this.scanActiveFile();break;case"incremental":await this.scanRecentFiles(6048e5);break;case"full":await this.performFullScan()}}async scanActiveFile(){if(!this.options.getActiveFilePath)return void _e.warn("[AnnotationFileWatcher] 无法获取活动文件路径");const e=this.options.getActiveFilePath();if(!e)return void _e.debug("[AnnotationFileWatcher] 无活动文件");const t=this.vault.getAbstractFileByPath(e);t instanceof ge.TFile&&(await this.processFileChange(t,!0),_e.info(`✅ [AnnotationFileWatcher] 已扫描活动文件: ${t.path}`))}async scanRecentFiles(e){const t=Date.now(),n=t-e,i=this.vault.getMarkdownFiles().filter(e=>this.shouldWatchFile(e)&&e.stat.mtime>n);_e.info(`🔍 [AnnotationFileWatcher] 扫描最近${Math.round(e/864e5)}天内的文件: ${i.length}个`);let a=0,r=0;for(const o of i){await this.processFileChange(o,!0),a++;const e=this.annotationDetector.getAnnotationsForFile(o.path);r+=(null==e?void 0:e.length)||0}const s=((Date.now()-t)/1e3).toFixed(2);_e.info(`✅ [AnnotationFileWatcher] 增量扫描完成: ${a}个文件, ${r}个标注, ${s}s`)}async performFullScan(){const e=Date.now(),t=this.vault.getMarkdownFiles().filter(e=>this.shouldWatchFile(e));_e.info(`🔍 [AnnotationFileWatcher] 初始扫描: ${t.length} 个文件...`);try{let n=0,i=0,a=0;const r=this.options.maxConcurrency||3;for(let e=0;e<t.length;e+=r){const s=t.slice(e,e+r).map(async e=>{const t=await this.processFileChange(e,!this.options.initialScanAutoSync);n++;const r=this.annotationDetector.getAnnotationsForFile(e.path),s=(null==r?void 0:r.length)||0;return s>0&&(a++,i+=s),t});await Promise.allSettled(s)}const s=((Date.now()-e)/1e3).toFixed(2);_e.info(`✅ [AnnotationFileWatcher] 初始扫描完成: ${n}个文件, ${a}个含标注, 共${i}个标注, 耗时${s}s`)}catch(n){_e.error("❌ [AnnotationFileWatcher] 完整扫描失败:",n)}}scheduleIdleScan(){if(this.isIdleScanning)return;const e=this.vault.getMarkdownFiles().filter(e=>this.shouldWatchFile(e));this.idleScanQueue=[...e],this.isIdleScanning=!0,_e.info(`⏰ [AnnotationFileWatcher] 已安排${this.idleScanQueue.length}个文件的空闲扫描`),this.processIdleQueue()}processIdleQueue(){if(0===this.idleScanQueue.length)return this.isIdleScanning=!1,void _e.info("✅ [AnnotationFileWatcher] 空闲扫描完成");"undefined"!=typeof requestIdleCallback?requestIdleCallback(e=>{this.scanNextBatch(e)}):setTimeout(()=>{this.scanNextBatch()},100)}async scanNextBatch(e){const t=this.idleScanQueue.splice(0,5);for(const n of t){if(e&&e.timeRemaining()<10){this.idleScanQueue.unshift(n);break}await this.processFileChange(n,!0)}this.processIdleQueue()}stopIdleScan(){this.idleScanQueue=[],this.isIdleScanning=!1,_e.info("[AnnotationFileWatcher] 已停止空闲扫描")}emitChangeEvent(e){this.changeListeners.forEach(t=>{try{t(e)}catch(n){_e.error("变更事件监听器执行失败:",n)}})}emitEvent(e){this.eventListeners.forEach(t=>{try{t(e)}catch(n){_e.error("事件监听器执行失败:",n)}})}addChangeListener(e){this.changeListeners.push(e)}removeChangeListener(e){const t=this.changeListeners.indexOf(e);t>-1&&this.changeListeners.splice(t,1)}addEventListener(e){this.eventListeners.push(e)}removeEventListener(e){const t=this.eventListeners.indexOf(e);t>-1&&this.eventListeners.splice(t,1)}isWatchingFiles(){return this.isWatching}async getSimpleSyncEngine(){if(!this.simpleSyncEngine)try{const{SimpleSyncEngine:e}=await Promise.resolve().then(()=>E_e);this.simpleSyncEngine=e.getInstance()}catch(e){return _e.error("❌ [AnnotationFileWatcher] 加载SimpleSyncEngine失败:",e),null}return this.simpleSyncEngine}getScanStatus(){return{isIdleScanning:this.isIdleScanning,queueLength:this.idleScanQueue.length,watchedFiles:this.fileChangeRecords.size}}getWatchingStats(){const e=Array.from(this.fileChangeRecords.values()).reduce((e,t)=>e+t.lastAnnotationCount,0);return{watchedFiles:this.fileChangeRecords.size,totalAnnotations:e,lastScanTime:(new Date).toISOString()}}};oe(Ch,"instance");let Ih=Ch;const Dh=class e{constructor(){oe(this,"metrics",new Map),oe(this,"completedMetrics",[]),oe(this,"isEnabled",!1)}static getInstance(){return e.instance||(e.instance=new e),e.instance}enable(){this.isEnabled=!0,_e.debug("📊 [PerformanceProfiler] 性能分析已启用")}disable(){this.isEnabled=!1,this.clear(),_e.debug("📊 [PerformanceProfiler] 性能分析已禁用")}startMeasure(e,t){if(!this.isEnabled)return"";const n=`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i={name:e,startTime:performance.now(),metadata:t};return this.metrics.set(n,i),n}endMeasure(e){if(!this.isEnabled||!e)return 0;const t=this.metrics.get(e);return t?(t.endTime=performance.now(),t.duration=t.endTime-t.startTime,this.completedMetrics.push(t),this.metrics.delete(e),t.duration):(_e.warn(`📊 [PerformanceProfiler] 未找到测量ID: ${e}`),0)}async measureAsync(e,t,n){const i=this.startMeasure(e,n);try{const e=await t();return this.endMeasure(i),e}catch(a){throw this.endMeasure(i),a}}measureSync(e,t,n){const i=this.startMeasure(e,n);try{const e=t();return this.endMeasure(i),e}catch(a){throw this.endMeasure(i),a}}generateReport(){const e=[...this.completedMetrics],t=e.reduce((e,t)=>e+(t.duration||0),0),n=e.filter(e=>e.name.includes("detection")||e.name.includes("detect")),i=e.filter(e=>e.name.includes("processing")||e.name.includes("process")),a=e.filter(e=>e.name.includes("modification")||e.name.includes("modify")),r=this.calculateAverage(n),s=this.calculateAverage(i),o=this.calculateAverage(a),l=e.filter(e=>{var t;return null==(t=e.metadata)?void 0:t.annotationCount}).length,c=t>0?l/(t/1e3):0,d=this.generateRecommendations(e);return{totalDuration:t,metrics:e,summary:{averageDetectionTime:r,averageProcessingTime:s,averageDocumentModificationTime:o,throughput:c,memoryUsage:this.getMemoryUsage()},recommendations:d}}calculateAverage(e){if(0===e.length)return 0;return e.reduce((e,t)=>e+(t.duration||0),0)/e.length}getMemoryUsage(){if("undefined"!=typeof performance&&"memory"in performance)return performance.memory.usedJSHeapSize}generateRecommendations(e){const t=[],n=e.filter(e=>(e.duration||0)>1e3);n.length>0&&t.push(`发现 ${n.length} 个耗时超过1秒的操作，建议优化`);const i=e.filter(e=>e.name.includes("detection"));this.calculateAverage(i)>500&&t.push("标注检测平均耗时较长，建议优化正则表达式或使用缓存");const a=e.filter(e=>e.name.includes("processing"));this.calculateAverage(a)>2e3&&t.push("标注处理平均耗时较长，建议增加并发处理或优化算法");const r=e.filter(e=>e.name.includes("modification"));this.calculateAverage(r)>300&&t.push("文档修改平均耗时较长，建议优化文件I/O操作");const s=this.getMemoryUsage();s&&s>104857600&&t.push("内存使用较高，建议优化缓存策略或增加垃圾回收");const o=e.filter(e=>{var t;return null==(t=e.metadata)?void 0:t.annotationCount}).length,l=e.reduce((e,t)=>e+(t.duration||0),0);return(l>0?o/(l/1e3):0)<1&&t.push("处理吞吐量较低，建议优化并发策略或算法效率"),0===t.length&&t.push("性能表现良好，无需特别优化"),t}printReport(){if(!this.isEnabled)return void _e.debug("📊 [PerformanceProfiler] 性能分析未启用");const e=this.generateReport();_e.debug(`总耗时: ${e.totalDuration.toFixed(2)}ms`),_e.debug(`测量次数: ${e.metrics.length}`),_e.debug(`平均检测时间: ${e.summary.averageDetectionTime.toFixed(2)}ms`),_e.debug(`平均处理时间: ${e.summary.averageProcessingTime.toFixed(2)}ms`),_e.debug(`平均文档修改时间: ${e.summary.averageDocumentModificationTime.toFixed(2)}ms`),_e.debug(`处理吞吐量: ${e.summary.throughput.toFixed(2)} 标注/秒`),e.summary.memoryUsage&&_e.debug(`内存使用: ${(e.summary.memoryUsage/1024/1024).toFixed(2)}MB`),e.recommendations.forEach(e=>_e.debug(`• ${e}`));const t=e.metrics.sort((e,t)=>(t.duration||0)-(e.duration||0));t.slice(0,10).forEach(e=>{_e.debug(`${e.name}: ${(e.duration||0).toFixed(2)}ms`)}),t.length>10&&_e.debug(`... 还有 ${t.length-10} 个指标`)}exportData(){const e=this.generateReport();return JSON.stringify(e,null,2)}clear(){this.metrics.clear(),this.completedMetrics.length=0}getRealTimeStats(){const e=this.completedMetrics.slice(-10),t=this.calculateAverage(e),n=e.reduce((e,t)=>e+(t.duration||0),0),i=n>0?e.length/(n/1e3):0;return{activeMeasures:this.metrics.size,completedMeasures:this.completedMetrics.length,averageDuration:t,recentThroughput:i}}setThresholds(e){_e.debug("📊 [PerformanceProfiler] 性能阈值已设置:",e)}};oe(Dh,"instance");const Th=Dh.getInstance(),Mh=class e{constructor(){oe(this,"metrics",[]),oe(this,"isEnabled",!1),oe(this,"feedbackCallbacks",new Map)}static getInstance(){return e.instance||(e.instance=new e),e.instance}enable(){this.isEnabled=!0,_e.debug("🎨 [UXOptimizer] 用户体验优化已启用")}disable(){this.isEnabled=!1,this.clear(),_e.debug("🎨 [UXOptimizer] 用户体验优化已禁用")}recordInteraction(e,t,n,i,a){if(!this.isEnabled)return;const r={timestamp:Date.now(),action:e,duration:t,success:n,context:i,errorMessage:a};this.metrics.push(r),this.analyzeInteraction(r)}recordSatisfaction(e,t){if(!this.isEnabled)return;const n=this.metrics.filter(t=>t.action===e).sort((e,t)=>t.timestamp-e.timestamp)[0];n&&(n.userSatisfaction=t)}analyzeInteraction(e){e.duration>3e3&&this.triggerFeedback("slow_response",{action:e.action,duration:e.duration,suggestion:"操作响应较慢，建议检查网络连接或减少同时处理的任务数量"}),!e.success&&e.errorMessage&&this.triggerFeedback("error_occurred",{action:e.action,error:e.errorMessage,suggestion:this.getErrorSuggestion(e.errorMessage)});const t=this.metrics.filter(t=>t.action===e.action&&Date.now()-t.timestamp<6e4).length;t>5&&this.triggerFeedback("frequent_action",{action:e.action,frequency:t,suggestion:"检测到频繁操作，可能存在配置问题或需要批量处理功能"})}getErrorSuggestion(e){const t={"文件不存在":"请确认文件路径正确，或检查文件是否已被删除","权限不足":"请检查文件权限设置，确保Obsidian有读写权限","格式错误":"请检查标注格式是否符合规范：> [!tuanki]","网络错误":"请检查网络连接，或稍后重试","内存不足":"请关闭其他应用程序释放内存，或重启Obsidian","解析失败":"请检查Markdown语法是否正确，特别是标注块的格式"};for(const[n,i]of Object.entries(t))if(e.includes(n))return i;return"遇到未知错误，请查看控制台日志或联系技术支持"}triggerFeedback(e,t){const n=this.feedbackCallbacks.get(e);n&&n(t)}onFeedback(e,t){this.feedbackCallbacks.set(e,t)}generateReport(){const e=this.metrics.length,t=this.metrics.filter(e=>e.success).length,n=e>0?t/e*100:0,i=e>0?this.metrics.reduce((e,t)=>e+t.duration,0)/e:0,a=this.metrics.filter(e=>void 0!==e.userSatisfaction).map(e=>e.userSatisfaction);return{totalInteractions:e,successRate:n,averageResponseTime:i,userSatisfactionScore:a.length>0?a.reduce((e,t)=>e+t,0)/a.length:0,commonIssues:this.analyzeCommonIssues(),recommendations:this.generateRecommendations()}}analyzeCommonIssues(){const e=new Map;return this.metrics.filter(e=>!e.success).forEach(t=>{const n=t.errorMessage||`${t.action} 失败`;e.has(n)||e.set(n,{count:0,examples:[]});const i=e.get(n);i.count++,i.examples.push(t)}),Array.from(e.entries()).map(([e,t])=>{const n=t.count;return{issue:e,frequency:n,impact:this.determineImpact(n,t.examples),suggestions:this.generateIssueSuggestions(e,t.examples)}}).sort((e,t)=>t.frequency-e.frequency)}determineImpact(e,t){const n=e/this.metrics.length;return n>.2?"high":n>.1?"medium":"low"}generateIssueSuggestions(e,t){const n=[];return e.includes("文件")&&(n.push("检查文件路径和权限设置"),n.push("确保文件未被其他程序占用")),(e.includes("格式")||e.includes("解析"))&&(n.push("检查标注格式是否符合规范"),n.push("参考文档中的标注示例")),(e.includes("网络")||e.includes("连接"))&&(n.push("检查网络连接状态"),n.push("尝试重新连接或稍后重试")),t.length>10&&(n.push("考虑批量处理以提高效率"),n.push("检查是否存在配置问题")),n}generateRecommendations(){const e=[],t=this.generateReport();t.successRate<80&&e.push("成功率较低，建议检查常见错误并优化用户指导"),t.averageResponseTime>2e3&&e.push("平均响应时间较长，建议优化性能或增加进度提示"),t.userSatisfactionScore<3.5&&e.push("用户满意度较低，建议改进用户界面和交互流程");const n=t.commonIssues.filter(e=>"high"===e.impact);n.length>0&&e.push(`优先解决高影响问题：${n.map(e=>e.issue).join(", ")}`);return this.metrics.filter(e=>Date.now()-e.timestamp<36e5).length>100&&e.push("检测到高频使用，建议添加快捷操作和批量功能"),0===e.length&&e.push("用户体验表现良好，继续保持"),e}getRealTimeMetrics(){const e=this.metrics.filter(e=>Date.now()-e.timestamp<3e5),t=e.length>0?e.filter(e=>e.success).length/e.length*100:0,n=e.length>0?e.reduce((e,t)=>e+t.duration,0)/e.length:0,i=e.filter(e=>!e.success).length,a=this.metrics.filter(e=>Date.now()-e.timestamp>=3e5&&Date.now()-e.timestamp<6e5),r=a.length>0?a.filter(e=>e.success).length/a.length*100:t;let s="stable";return t>r+5?s="improving":t<r-5&&(s="declining"),{recentSuccessRate:t,recentAverageResponseTime:n,activeIssues:i,trendDirection:s}}clear(){this.metrics.length=0,this.feedbackCallbacks.clear()}exportData(){const e=this.generateReport();return JSON.stringify({report:e,rawMetrics:this.metrics},null,2)}printReport(){if(!this.isEnabled)return void _e.debug("🎨 [UXOptimizer] 用户体验优化未启用");const e=this.generateReport();_e.debug(`总交互次数: ${e.totalInteractions}`),_e.debug(`成功率: ${e.successRate.toFixed(1)}%`),_e.debug(`平均响应时间: ${e.averageResponseTime.toFixed(0)}ms`),_e.debug(`用户满意度: ${e.userSatisfactionScore.toFixed(1)}/5`),e.commonIssues.length>0&&e.commonIssues.slice(0,5).forEach(e=>{_e.debug(`${e.issue} (${e.frequency}次, ${e.impact}影响)`)}),e.recommendations.forEach(e=>_e.debug(`• ${e}`))}};oe(Mh,"instance");const Ah=Mh.getInstance(),Eh=class e{constructor(){oe(this,"annotationDetector"),oe(this,"contentExtractor"),oe(this,"metadataGenerator"),oe(this,"cardCreationBridge"),oe(this,"documentModifier"),oe(this,"syncManager"),oe(this,"fileWatcher"),oe(this,"systemState",{status:Xo.IDLE,isProcessing:!1,detectedAnnotations:[],processingQueue:[],completedTasks:[],errorLog:[],stats:{totalDetected:0,totalProcessed:0,totalErrors:0,successRate:0}}),oe(this,"config",{autoDetectionEnabled:!0,detectionInterval:1e3,autoCreateDecks:!0,defaultDeckId:"",defaultTemplateId:"",showNotifications:!0,maxConcurrentTasks:3,debounceDelay:1e3,debugMode:!1,onlyActiveFileAutoSync:!0}),oe(this,"plugin"),oe(this,"vault"),oe(this,"isInitialized",!1),oe(this,"eventListeners",[]),this.annotationDetector=mu.getInstance(),this.contentExtractor=wu.getInstance(),this.metadataGenerator=eh.getInstance(),this.cardCreationBridge=Sh.getInstance(),this.documentModifier=nh.getInstance(),this.syncManager=_h.getInstance(),this.fileWatcher=Ih.getInstance()}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(e){var t;const n=Date.now();try{_e.debug("🚀 [TuankiAnnotationSystem] 开始初始化系统"),(null==(t=e.config)?void 0:t.debugMode)&&(Th.enable(),Ah.enable(),_e.debug("📊 [TuankiAnnotationSystem] 性能分析和UX优化已启用")),this.plugin=e.plugin,this.vault=e.vault,e.config&&(this.config={...this.config,...e.config}),this.annotationDetector.setPlugin(e.plugin),this.documentModifier.initialize(this.vault),this.fileWatcher.initialize(this.vault,{debounceDelay:this.config.debounceDelay,autoSync:this.config.autoDetectionEnabled,maxConcurrency:this.config.maxConcurrentTasks,onlyActiveFileAutoSync:this.config.onlyActiveFileAutoSync,initialScanAutoSync:!1,getActiveFilePath:()=>{var e;return null==(e=this.plugin.app.workspace.getActiveFile())?void 0:e.path},plugin:e.plugin}),this.syncManager.setVault(this.vault),this.cardCreationBridge.injectServices({dataStorage:e.dataStorage,deckService:e.deckService,templateService:e.templateService,fsrs:e.fsrs,plugin:e.plugin,cardRelationService:e.cardRelationService});const{SimpleSyncEngine:i}=await Promise.resolve().then(()=>E_e);i.getInstance().initialize({dataStorage:e.dataStorage,cardCreationBridge:this.cardCreationBridge,vault:this.vault,plugin:e.plugin}),_e.debug("✅ [TuankiAnnotationSystem] SimpleSyncEngine初始化完成"),this.setupEventListeners(),this.config.autoDetectionEnabled&&(this.fileWatcher.startWatching(),_e.info("💡 [TuankiAnnotationSystem] 标注监听已启动，使用命令面板触发扫描")),this.isInitialized=!0,this.updateSystemState({status:Xo.IDLE});const a=Date.now()-n;return Ah.recordInteraction("system_initialize",a,!0,{componentsCount:7,autoDetectionEnabled:this.config.autoDetectionEnabled,debugMode:this.config.debugMode}),_e.debug("✅ [TuankiAnnotationSystem] 系统初始化完成"),{success:!0,timestamp:(new Date).toISOString()}}catch(i){const e=Date.now()-n,t=i instanceof Error?i.message:String(i);return Ah.recordInteraction("system_initialize",e,!1,{},t),_e.error("❌ [TuankiAnnotationSystem] 系统初始化失败:",i),{success:!1,error:`系统初始化失败: ${t}`,timestamp:(new Date).toISOString()}}}async destroy(){_e.debug("🔄 [TuankiAnnotationSystem] 开始销毁系统");try{this.fileWatcher.stopWatching(),this.annotationDetector.clearCache(),this.metadataGenerator.clearCache(),this.syncManager.clearCache(),this.documentModifier.cleanup(),this.eventListeners.length=0,this.systemState={status:Xo.IDLE,isProcessing:!1,detectedAnnotations:[],processingQueue:[],completedTasks:[],errorLog:[],stats:{totalDetected:0,totalProcessed:0,totalErrors:0,successRate:0}},this.isInitialized=!1,_e.debug("✅ [TuankiAnnotationSystem] 系统销毁完成")}catch(e){_e.error("❌ [TuankiAnnotationSystem] 系统销毁失败:",e)}}async detectAnnotations(e){try{if(!this.isInitialized)throw new Error("系统未初始化");_e.debug(`🔍 [TuankiAnnotationSystem] 检测标注: ${e}`);const t=this.vault.getAbstractFileByPath(e);if(!(t&&t instanceof ge.TFile))throw new Error(`文件不存在: ${e}`);const n=await this.vault.read(t),i=this.annotationDetector.detectAnnotationsInText(n,e);return this.updateSystemState({detectedAnnotations:[...this.systemState.detectedAnnotations,...i],stats:{...this.systemState.stats,totalDetected:this.systemState.stats.totalDetected+i.length}}),_e.debug(`✅ [TuankiAnnotationSystem] 检测完成: 找到 ${i.length} 个标注`),{success:!0,data:i,timestamp:(new Date).toISOString()}}catch(t){const e=t instanceof Error?t.message:String(t);return _e.error("❌ [TuankiAnnotationSystem] 标注检测失败:",t),{success:!1,error:e,timestamp:(new Date).toISOString()}}}async syncFile(e,t){var n;try{if(!this.isInitialized)throw new Error("系统未初始化");_e.debug(`🔄 [TuankiAnnotationSystem] 同步文件: ${e}`),this.updateSystemState({status:Xo.PROCESSING,isProcessing:!0});const i=await this.syncManager.syncFile(e,{forceSync:null==t?void 0:t.forceSync,autoCreateDecks:null!=(n=null==t?void 0:t.autoCreateDecks)?n:this.config.autoCreateDecks,defaultDeckId:this.config.defaultDeckId,defaultTemplateId:this.config.defaultTemplateId,maxConcurrency:this.config.maxConcurrentTasks});return this.updateSystemState({status:Xo.COMPLETED,isProcessing:!1,stats:{...this.systemState.stats,totalProcessed:this.systemState.stats.totalProcessed+i.successCount,totalErrors:this.systemState.stats.totalErrors+i.failureCount,successRate:this.calculateSuccessRate()}}),this.emitEvent({type:el.BATCH_COMPLETED,data:i,timestamp:(new Date).toISOString(),source:"TuankiAnnotationSystem"}),_e.debug(`✅ [TuankiAnnotationSystem] 文件同步完成: ${JSON.stringify(i)}`),{success:!0,data:i,timestamp:(new Date).toISOString()}}catch(i){_e.error("❌ [TuankiAnnotationSystem] 文件同步失败:",i),this.updateSystemState({status:Xo.ERROR,isProcessing:!1});return{success:!1,error:i instanceof Error?i.message:String(i),timestamp:(new Date).toISOString()}}}async syncMultipleFiles(e){try{if(!this.isInitialized)throw new Error("系统未初始化");_e.debug(`🔄 [TuankiAnnotationSystem] 批量同步: ${e.length} 个文件`),this.updateSystemState({status:Xo.PROCESSING,isProcessing:!0});const t=await this.syncManager.syncMultipleFiles(e,{autoCreateDecks:this.config.autoCreateDecks,defaultDeckId:this.config.defaultDeckId,defaultTemplateId:this.config.defaultTemplateId,maxConcurrency:this.config.maxConcurrentTasks});return this.updateSystemState({status:Xo.COMPLETED,isProcessing:!1,stats:{...this.systemState.stats,totalProcessed:this.systemState.stats.totalProcessed+t.successCount,totalErrors:this.systemState.stats.totalErrors+t.failureCount,successRate:this.calculateSuccessRate()}}),_e.debug(`✅ [TuankiAnnotationSystem] 批量同步完成: ${JSON.stringify(t)}`),{success:!0,data:t,timestamp:(new Date).toISOString()}}catch(t){_e.error("❌ [TuankiAnnotationSystem] 批量同步失败:",t),this.updateSystemState({status:Xo.ERROR,isProcessing:!1});return{success:!1,error:t instanceof Error?t.message:String(t),timestamp:(new Date).toISOString()}}}getSystemState(){return this.systemState}async triggerScan(e="active-only"){if(!this.isInitialized)throw new Error("[TuankiAnnotationSystem] 系统未初始化");await this.fileWatcher.triggerScan(e)}scheduleIdleScan(){if(!this.isInitialized)throw new Error("[TuankiAnnotationSystem] 系统未初始化");this.fileWatcher.scheduleIdleScan()}stopIdleScan(){this.fileWatcher.stopIdleScan()}getScanStatus(){return this.fileWatcher.getScanStatus()}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e},void 0!==e.autoDetectionEnabled&&(e.autoDetectionEnabled&&!this.fileWatcher.isWatchingFiles()?this.fileWatcher.startWatching():!e.autoDetectionEnabled&&this.fileWatcher.isWatchingFiles()&&this.fileWatcher.stopWatching()),_e.debug("⚙️ [TuankiAnnotationSystem] 配置已更新")}setupEventListeners(){this.fileWatcher.addChangeListener(e=>{_e.debug(`📝 [TuankiAnnotationSystem] 标注变更: ${e.type} - ${e.annotation.id}`),this.emitEvent({type:el.ANNOTATION_DETECTED,data:e,timestamp:(new Date).toISOString(),source:"AnnotationFileWatcher"})}),this.syncManager.addStatusListener(e=>{this.updateSystemState({status:e.status,isProcessing:e.status===Xo.PROCESSING})})}updateSystemState(e){this.systemState={...this.systemState,...e}}calculateSuccessRate(){const e=this.systemState.stats.totalProcessed+this.systemState.stats.totalErrors;return e>0?this.systemState.stats.totalProcessed/e*100:0}emitEvent(e){this.eventListeners.forEach(t=>{try{t(e)}catch(n){_e.error("事件监听器执行失败:",n)}})}addEventListener(e){this.eventListeners.push(e)}removeEventListener(e){const t=this.eventListeners.indexOf(e);t>-1&&this.eventListeners.splice(t,1)}getHealthStatus(){const e=[];return this.isInitialized||e.push("系统未初始化"),this.systemState.stats.successRate<80&&this.systemState.stats.totalProcessed>10&&e.push("成功率过低"),this.systemState.errorLog.length>100&&e.push("错误日志过多"),{isHealthy:0===e.length,issues:e,uptime:Date.now()}}};oe(Eh,"instance");let zh=Eh;const Ph={enableTagTrigger:!0,triggerTag:"#tuanki",symbols:{cardDelimiter:"<->",faceDelimiter:"---div---",clozeMarker:"=="},batchParsing:{autoCreateBlockLinks:!1,autoSetSourceFile:!0,blockIdPrefix:"tuanki",insertMetadata:!1,autoTrigger:!1,triggerDebounce:2e3,onlyActiveFile:!0,includeFolders:[],excludeFolders:[".obsidian",".trash","node_modules",".git"],maxFilesPerBatch:50,defaultDeckId:void 0,defaultPriority:0,folderDeckMappings:[],autoSync:{enabled:!1,watchActiveFile:!0,debounceDelay:2e3,onlyInMappedFolders:!0},conflictResolution:{defaultStrategy:"ask-user",showConflictNotification:!0},excludeTags:["skip"],forceSyncTags:["自动同步"]},enableTemplateSystem:!0,templates:[],defaultTemplateId:"official-qa"};function Rh(){const e=navigator.userAgent.toLowerCase(),t="ontouchstart"in window||navigator.maxTouchPoints>0,n=window.innerWidth,i=window.innerHeight,a=n>i,r=n>=768&&n<=1024||i>=768&&i<=1024||/ipad|android(?!.*mobile)|tablet|kindle|silk/i.test(e),s=!r&&(n<768||/mobile|phone|android.*mobile|iphone|ipod|blackberry|windows phone/i.test(e)),o=!r&&!s;let l;l=n<768?"small":n<=1024?"medium":"large";let c="unknown";return/ipad|iphone|ipod/i.test(e)?c="ios":/android/i.test(e)?c="android":/windows/i.test(e)?c="windows":/mac/i.test(e)?c="macos":/linux/i.test(e)&&(c="linux"),{isTablet:r,isMobile:s,isDesktop:o,isTouch:t,orientation:a?"landscape":"portrait",screenSize:l,platform:c}}const $h=768,Oh=1024,Lh=1200;function Nh(e){const t=Rh(),n=function(){const e=window.innerWidth;return e<$h?"mobile":e<Oh?"tablet":e<Lh?"desktop":"large"}();e.classList.remove("tuanki-mobile","tuanki-tablet","tuanki-desktop","tuanki-touch","tuanki-no-touch","tuanki-portrait","tuanki-landscape","tuanki-small","tuanki-medium","tuanki-large"),t.isMobile&&e.classList.add("tuanki-mobile"),t.isTablet&&e.classList.add("tuanki-tablet"),t.isDesktop&&e.classList.add("tuanki-desktop"),e.classList.add(t.isTouch?"tuanki-touch":"tuanki-no-touch"),e.classList.add(`tuanki-${t.orientation}`),e.classList.add(`tuanki-${t.screenSize}`),e.classList.add(`tuanki-bp-${n}`)}const Fh=new class{constructor(){oe(this,"config",{enabled:!1,showDebugInfo:!1,logDeviceChanges:!1,enableTouchSimulation:!1}),oe(this,"debugOverlay",null),oe(this,"originalDeviceInfo",null)}enable(e={}){this.config={...this.config,enabled:!0,...e},this.config.showDebugInfo&&void 0!==e.showDebugInfo&&this.createDebugOverlay(),this.config.logDeviceChanges&&this.setupDeviceLogging(),this.config.enableTouchSimulation&&this.setupTouchSimulation(),_e.debug("[TabletDebugger] 调试模式已启用",this.config)}disable(){this.config.enabled=!1,this.removeDebugOverlay(),window.__tuanki_debugger_setup&&(delete window.__tuanki_debugger_setup,_e.debug("[TabletDebugger] 已清理调试设置标记")),_e.debug("[TabletDebugger] 调试模式已禁用")}mockDevice(e){this.originalDeviceInfo||(this.originalDeviceInfo=Rh());window.__tuanki_detectDevice=()=>({...this.originalDeviceInfo,...e}),_e.debug("[TabletDebugger] 设备模拟已启用",e),this.updateDebugOverlay()}restoreDevice(){delete window.__tuanki_detectDevice,_e.debug("[TabletDebugger] 已恢复真实设备检测"),this.updateDebugOverlay()}simulateOrientationChange(e){const t=new CustomEvent("orientationchange",{detail:{orientation:e}});window.dispatchEvent(t),window.dispatchEvent(new Event("resize")),_e.debug("[TabletDebugger] 模拟方向变化:",e)}createDebugOverlay(){this.debugOverlay||(this.debugOverlay=document.createElement("div"),this.debugOverlay.id="tuanki-tablet-debug",this.debugOverlay.style.cssText="\n      position: fixed;\n      top: 10px;\n      left: 10px;\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 10px;\n      border-radius: 5px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 10000;\n      max-width: 300px;\n      pointer-events: none;\n    ",document.body.appendChild(this.debugOverlay),this.updateDebugOverlay())}updateDebugOverlay(){var e;if(!this.debugOverlay)return;const t=(null==(e=window.__tuanki_detectDevice)?void 0:e.call(window))||Rh(),n=window.innerWidth,i=window.innerHeight,a=window.devicePixelRatio;this.debugOverlay.innerHTML=`\n      <div><strong>🖥️ 设备信息</strong></div>\n      <div>类型: ${t.isTablet?"Tablet":t.isMobile?"Mobile":"Desktop"}</div>\n      <div>触控: ${t.isTouch?"Yes":"No"}</div>\n      <div>方向: ${t.orientation}</div>\n      <div>尺寸: ${t.screenSize}</div>\n      <div>平台: ${t.platform}</div>\n      <div><strong>📱 屏幕信息</strong></div>\n      <div>分辨率: ${n}x${i}</div>\n      <div>像素比: ${a}</div>\n      <div>User Agent: ${navigator.userAgent.slice(0,50)}...</div>\n      ${this.config.mockDevice?'<div style="color: yellow">⚠️ 设备模拟中</div>':""}\n    `}removeDebugOverlay(){this.debugOverlay&&(document.body.removeChild(this.debugOverlay),this.debugOverlay=null)}setupDeviceLogging(){if(window.__tuanki_debugger_setup)return void _e.warn("[TabletDebugger] 设备日志已设置，跳过");const e=window.addEventListener;window.addEventListener=function(t,n,i){if("resize"===t||"orientationchange"===t){const a=e=>{try{if("function"==typeof n){const t=e.currentTarget||e.target||window;return n.call(t,e)}if(n&&"function"==typeof n.handleEvent)return n.handleEvent.call(n,e)}catch(t){_e.warn("[TabletDebugger] 监听器调用失败:",t)}};return e.call(this,t,a,i)}return e.call(this,t,n,i)},window.__tuanki_debugger_setup=!0}setupTouchSimulation(){document.addEventListener("mousedown",e=>{var t;const n=new TouchEvent("touchstart",{touches:[new Touch({identifier:0,target:e.target,clientX:e.clientX,clientY:e.clientY,radiusX:20,radiusY:20,rotationAngle:0,force:1})]});null==(t=e.target)||t.dispatchEvent(n)}),_e.debug("[TabletDebugger] 触控模拟已启用")}getConfig(){return{...this.config}}getStats(){var e;return{currentDevice:(null==(e=window.__tuanki_detectDevice)?void 0:e.call(window))||Rh(),isMocked:!!window.__tuanki_detectDevice,screenInfo:{width:window.innerWidth,height:window.innerHeight,ratio:window.devicePixelRatio,available:{width:screen.availWidth,height:screen.availHeight}},capabilities:{touch:"ontouchstart"in window,multiTouch:navigator.maxTouchPoints,hover:window.matchMedia("(hover: hover)").matches,pointerEvents:"onpointerdown"in window}}}},Bh={isTablet:!0,isMobile:!1,isDesktop:!1,isTouch:!0,orientation:"portrait",screenSize:"medium",platform:"ios"},jh={isTablet:!0,isMobile:!1,isDesktop:!1,isTouch:!0,orientation:"landscape",screenSize:"medium",platform:"android"},Uh={isTablet:!1,isMobile:!0,isDesktop:!1,isTouch:!0,orientation:"portrait",screenSize:"small",platform:"ios"};window.tuankiTabletDebug={enable:()=>Fh.enable({showDebugInfo:!0,logDeviceChanges:!0}),disable:()=>Fh.disable(),mockiPad:()=>Fh.mockDevice(Bh),mockAndroid:()=>Fh.mockDevice(jh),mockMobile:()=>Fh.mockDevice(Uh),restore:()=>Fh.restoreDevice(),stats:()=>Fh.getStats(),landscape:()=>Fh.simulateOrientationChange("landscape"),portrait:()=>Fh.simulateOrientationChange("portrait")},_e.debug("🔧 平板端调试工具已加载！使用 window.tuankiTabletDebug 进行调试"),_e.debug("常用命令:"),_e.debug("- tuankiTabletDebug.enable() - 启用调试"),_e.debug("- tuankiTabletDebug.mockiPad() - 模拟iPad"),_e.debug("- tuankiTabletDebug.landscape() - 模拟横屏"),_e.debug("- tuankiTabletDebug.stats() - 查看设备信息");const Vh=class e{constructor(){oe(this,"state",{decks:null,templates:null,timestamp:0,isLoading:!1}),oe(this,"loadPromise",null),oe(this,"CACHE_TTL",3e5),oe(this,"plugin",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}async preload(e){if(this.plugin||(this.plugin=e),this.loadPromise)return _e.debug("[GlobalDataCache]","数据预加载已在进行中，等待完成..."),this.loadPromise;if(this.isCacheValid())return void _e.debug("[GlobalDataCache]","缓存仍然有效，跳过预加载");_e.debug("[GlobalDataCache]","开始预加载数据...");const t=Date.now();return this.state.isLoading=!0,this.loadPromise=(async()=>{try{const[n,i]=await Promise.all([this.loadDecks(e),this.loadTemplates(e)]);this.state.decks=n,this.state.templates=i,this.state.timestamp=Date.now();const a=Date.now()-t;_e.debug("[GlobalDataCache]",`数据预加载完成: ${a}ms`,{decks:n.length,templates:i.length})}catch(n){_e.error("[GlobalDataCache] 数据预加载失败:",n)}finally{this.state.isLoading=!1,this.loadPromise=null}})(),this.loadPromise}async getDecks(e,t=!1){if(t||!this.isCacheValid()||!this.state.decks)if(_e.debug("[GlobalDataCache]","牌组缓存无效，重新加载..."),this.loadPromise)await this.loadPromise;else{const t=await this.loadDecks(e);this.state.decks=t,this.state.timestamp=Date.now()}return this.state.decks||[]}async getTemplates(e=!1){return!e&&this.isCacheValid()&&this.state.templates||(_e.debug("[GlobalDataCache]","模板缓存无效，重新加载..."),this.loadPromise?await this.loadPromise:(this.state.templates=[],this.state.timestamp=Date.now())),this.state.templates||[]}async refresh(e){_e.debug("[GlobalDataCache]","手动刷新缓存..."),this.clear(),await this.preload(e)}clear(){_e.debug("[GlobalDataCache]","清除缓存"),this.state.decks=null,this.state.templates=null,this.state.timestamp=0,this.loadPromise=null}async invalidateCardCache(e){_e.debug("[GlobalDataCache]",`使牌组 ${e} 的卡片缓存失效`),this.state.decks=null,this.state.timestamp=Date.now()-this.CACHE_TTL}async invalidateDeckCache(){_e.debug("[GlobalDataCache]","使牌组缓存失效"),this.state.decks=null,this.state.timestamp=Date.now()-this.CACHE_TTL}isCacheValid(){if(0===this.state.timestamp)return!1;return Date.now()-this.state.timestamp<this.CACHE_TTL}async loadDecks(e){try{const t=await e.dataStorage.getAllDecks();return _e.debug("[GlobalDataCache]",`牌组数据加载完成: ${t.length} 个牌组`),t}catch(t){return _e.error("[GlobalDataCache] 加载牌组失败:",t),[]}}async loadTemplates(e){try{return _e.debug("[GlobalDataCache]","模板系统已弃用，返回空数组"),[]}catch(t){return _e.error("[GlobalDataCache] 加载模板失败:",t),[]}}};oe(Vh,"instance");let qh=Vh;qh.getInstance();const Hh={GRID_VIEW:"grid-view",KANBAN_VIEW:"kanban-view",ADVANCED_ANALYTICS:"advanced-analytics",AI_ASSISTANT:"ai-assistant",ANNOTATION_SYSTEM:"annotation-system",INCREMENTAL_READING:"incremental-reading",BATCH_PARSING:"batch-parsing",QUESTION_BANK:"question-bank"},Wh={[Hh.GRID_VIEW]:{name:"网格视图",description:"以卡片网格形式展示，让管理更直观",icon:"🎨"},[Hh.KANBAN_VIEW]:{name:"看板视图",description:"看板式管理，按状态分类显示",icon:"📋"},[Hh.ADVANCED_ANALYTICS]:{name:"高级统计分析",description:"详细的学习数据分析、热力图和可视化",icon:"📊"},[Hh.AI_ASSISTANT]:{name:"AI智能助手",description:"智能批量生成高质量记忆卡片",icon:"🤖"},[Hh.ANNOTATION_SYSTEM]:{name:"Tuanki标注系统",description:"基于文档标注快速创建卡片",icon:"✍️"},[Hh.INCREMENTAL_READING]:{name:"渐进性阅读",description:"支持渐进式阅读工作流",icon:"📖"},[Hh.BATCH_PARSING]:{name:"批量解析系统",description:"自动解析文档中的卡片，支持文件夹映射和智能触发",icon:"🔄"},[Hh.QUESTION_BANK]:{name:"题库系统",description:"专业的题库刷题功能，支持考试、小测验等多种模式",icon:"📝"}},Gh=class e{constructor(){oe(this,"isPremiumActive"),oe(this,"validationCache",null),oe(this,"CACHE_DURATION",3e5),this.isPremiumActive=Fr(!1)}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(e){const t=await this.validateLicense(e);this.isPremiumActive.set(t)}async updateLicense(e){this.clearCache();const t=await this.validateLicense(e);this.isPremiumActive.set(t)}async validateLicense(e){if(!(null==e?void 0:e.isActivated))return!1;if(this.validationCache){if(Date.now()-this.validationCache.timestamp<this.CACHE_DURATION)return this.validationCache.isValid}const t=await Es.validateCurrentLicense(e);return this.validationCache={isValid:t.isValid,timestamp:Date.now()},t.isValid}canUseFeature(e){let t=!1;this.isPremiumActive.subscribe(e=>{t=e})();return!Object.values(Hh).includes(e)||t}clearCache(){this.validationCache=null}};oe(Gh,"instance");let Qh=Gh;class Kh{constructor(e,t,n){oe(this,"plugin"),oe(this,"parser"),oe(this,"options"),oe(this,"eventRefs",[]),oe(this,"debounceTimers",new Map),oe(this,"isProcessing",new Map),this.plugin=e,this.parser=t,this.options=n}async initialize(){if(!Qh.getInstance().canUseFeature(Hh.BATCH_PARSING))return void _e.debug("[BatchParsingWatcher] 批量解析功能需要激活许可证，跳过初始化");if(!this.options.autoTrigger)return void _e.debug("[BatchParsingWatcher] 自动触发已禁用");const e=this.plugin.app.vault.on("modify",e=>{e instanceof ge.TFile&&this.handleFileModify(e)});this.eventRefs.push(e),_e.debug("[BatchParsingWatcher] ✅ 监听器已初始化")}handleFileModify(e){if("md"===e.extension){if(this.options.onlyActiveFile){const t=this.plugin.app.workspace.getActiveFile();if(!t||e.path!==t.path)return}this.shouldProcessFile(e.path)&&this.debounceFileChange(e)}}debounceFileChange(e){this.debounceTimers.has(e.path)&&clearTimeout(this.debounceTimers.get(e.path));const t=setTimeout(()=>{this.processFile(e),this.debounceTimers.delete(e.path)},this.options.debounceDelay);this.debounceTimers.set(e.path,t)}async processFile(e){if(this.isProcessing.get(e.path))_e.debug(`[BatchParsingWatcher] 跳过重复处理: ${e.path}`);else{this.isProcessing.set(e.path,!0);try{const t=await this.plugin.app.vault.read(e);await this.triggerBatchParsing(e,t)}catch(t){_e.error("[BatchParsingWatcher] 处理文件失败:",t),new ge.Notice(`❌ 批量解析失败: ${t instanceof Error?t.message:"未知错误"}`)}finally{this.isProcessing.set(e.path,!1)}}}async triggerBatchParsing(e,t){_e.debug(`[BatchParsingWatcher] 🔄 开始自动解析: ${e.path}`);const n={settings:this.plugin.settings.simplifiedParsing,scenario:"batch",sourceFile:e.path,sourceFileName:e.name,sourceContent:t,onContentUpdated:async t=>{_e.debug(`[BatchParsingWatcher] 📝 文档已更新: ${e.path}`)}};try{const i=await this.parser.parseBatchCards(t,n),{cards:a}=i;a.length>0?(_e.debug(`[BatchParsingWatcher] ✅ 解析完成: ${a.length} 张卡片`),"function"==typeof this.plugin.addCardsToDB?await this.plugin.addCardsToDB(a):(_e.warn("[BatchParsingWatcher] addCardsToDB 方法不存在，卡片未保存"),new ge.Notice(`⚠️ 解析完成但未保存: ${e.name} → ${a.length} 张卡片`,3e3))):_e.debug("[BatchParsingWatcher] ⚠️ 未找到可解析的卡片")}catch(i){throw _e.error("[BatchParsingWatcher] 解析失败:",i),i}}shouldProcessFile(e){if(this.options.excludeFolders.length>0)for(const t of this.options.excludeFolders)if(e.startsWith(t))return!1;if(this.options.includeFolders.length>0){let t=!1;for(const n of this.options.includeFolders)if(e.startsWith(n)){t=!0;break}if(!t)return!1}return!0}destroy(){for(const e of this.eventRefs)this.plugin.app.vault.offref(e);this.eventRefs=[];for(const e of this.debounceTimers.values())clearTimeout(e);this.debounceTimers.clear(),this.isProcessing.clear(),_e.debug("[BatchParsingWatcher] 🔴 监听器已销毁")}updateOptions(e){this.options={...this.options,...e},_e.debug("[BatchParsingWatcher] 🔄 选项已更新:",this.options)}getOptions(){return{...this.options}}isRunning(){return this.eventRefs.length>0}}class Zh{constructor(e={}){oe(this,"patterns",new Map),oe(this,"config"),this.config={primaryLanguage:"auto",enableAutoDetection:!0,supportedLanguages:["zh","en","ja","ko"],fallbackToEnglish:!0,...e},this.initializePatterns()}initializePatterns(){this.patterns.set("zh",{questionMarkers:["问题[:：]","题目[:：]","Q[:：]","问[:：]","什么","如何","为什么","怎么","哪个","哪些","是否","能否","可以","应该"],answerMarkers:["答案[:：]","解答[:：]","A[:：]","答[:：]","回答[:：]","解释[:：]","说明[:：]"],separators:["---","===","***","———","——","答案","解答","回答"],questionWords:["什么","如何","为什么","怎么","哪个","哪些","谁","何时","何地","多少","几个"],punctuation:["？","。","！","：","；","，"]}),this.patterns.set("en",{questionMarkers:["Question:","Q:","Ask:","Problem:","What","How","Why","When","Where","Who","Which"],answerMarkers:["Answer:","A:","Solution:","Response:","Reply:","Explanation:"],separators:["---","===","***","Answer","Solution"],questionWords:["what","how","why","when","where","who","which","whose","whom","can","could","should","would","will","do","does","did","is","are"],punctuation:["?",".","!",":",";",","]}),this.patterns.set("ja",{questionMarkers:["質問:","問題:","Q:","問:","何","どう","なぜ","いつ","どこ","誰"],answerMarkers:["答え:","回答:","A:","解答:","説明:","解釈:"],separators:["---","===","***","答え","回答"],questionWords:["何","どう","なぜ","いつ","どこ","誰","どの","どれ","いくつ"],punctuation:["？","。","！","：","；","、"]}),this.patterns.set("ko",{questionMarkers:["질문:","문제:","Q:","물음:","무엇","어떻게","왜","언제","어디","누구"],answerMarkers:["답:","답변:","A:","해답:","설명:","해석:"],separators:["---","===","***","답","답변"],questionWords:["무엇","어떻게","왜","언제","어디","누구","어느","몇","얼마"],punctuation:["?",".","!",":",";",","]})}detectLanguage(e){if(!this.config.enableAutoDetection)return"auto"===this.config.primaryLanguage?"en":this.config.primaryLanguage;const t=new Map;for(const[a,r]of this.patterns){let n=0;for(const t of r.questionMarkers){const i=new RegExp(t,"gi"),a=e.match(i);a&&(n+=2*a.length)}for(const t of r.questionWords){const i=new RegExp(`\\b${t}\\b`,"gi"),a=e.match(i);a&&(n+=a.length)}for(const t of r.punctuation){n+=.5*(e.match(new RegExp(`\\${t}`,"g"))||[]).length}t.set(a,n)}let n=0,i="en";for(const[a,r]of t)r>n&&(n=r,i=a);return i}getPatterns(e){const t=e||this.detectLanguage("");return this.patterns.get(t)||this.patterns.get("en")}looksLikeQuestion(e,t){const n=this.getPatterns(t);for(const i of n.questionMarkers)if(new RegExp(i,"i").test(e))return!0;for(const i of n.questionWords)if(new RegExp(`\\b${i}\\b`,"i").test(e))return!0;return e.includes("?")||e.includes("？")}findSeparators(e,t){const n=this.getPatterns(t),i=[];for(const a of n.separators){const t=new RegExp(a,"gi");let n;for(;null!==(n=t.exec(e));)i.push({index:n.index,separator:n[0]})}return i.sort((e,t)=>e.index-t.index)}smartSplit(e){const t=this.detectLanguage(e);this.getPatterns(t);const n=this.findSeparators(e,t);if(n.length>0){const i=n[0];return{question:e.substring(0,i.index).trim(),answer:e.substring(i.index+i.separator.length).trim(),confidence:.8,language:t}}const i=e.split("\n").filter(e=>e.trim());for(let a=0;a<i.length;a++)if(this.looksLikeQuestion(i[a],t)){return{question:i.slice(0,a+1).join("\n"),answer:i.slice(a+1).join("\n"),confidence:.6,language:t}}return i.length>=2?{question:i[0],answer:i.slice(1).join("\n"),confidence:.4,language:t}:{question:e,answer:"",confidence:.2,language:t}}}class Yh{constructor(){oe(this,"metrics"),oe(this,"operationHistory",[]),oe(this,"MAX_HISTORY_SIZE",1e3),oe(this,"PERFORMANCE_THRESHOLDS",{maxParseTime:100,minCacheHitRate:.6,maxMemoryUsage:52428800,minSuccessRate:.85,minAverageConfidence:.7,maxErrorRate:.1}),this.metrics={parseTime:0,cacheHitRate:0,memoryUsage:0,successRate:0,averageConfidence:0,errorCount:0,totalOperations:0,errorRate:0}}recordOperation(e,t,n,i,a){const r={timestamp:Date.now(),operation:e,duration:t,success:n,confidence:i,cacheHit:a};this.operationHistory.push(r),this.operationHistory.length>this.MAX_HISTORY_SIZE&&this.operationHistory.shift(),this.updateMetrics()}updateMetrics(){if(0===this.operationHistory.length)return;const e=this.operationHistory.slice(-100);this.metrics.parseTime=e.reduce((e,t)=>e+t.duration,0)/e.length;const t=e.filter(e=>void 0!==e.cacheHit);if(t.length>0){const e=t.filter(e=>e.cacheHit).length;this.metrics.cacheHitRate=e/t.length}const n=e.filter(e=>e.success).length;this.metrics.successRate=n/e.length;const i=e.filter(e=>void 0!==e.confidence);if(i.length>0){const e=i.reduce((e,t)=>e+(t.confidence||0),0);this.metrics.averageConfidence=e/i.length}this.metrics.errorCount=e.filter(e=>!e.success).length,this.metrics.errorRate=this.metrics.errorCount/e.length,this.metrics.totalOperations=e.length,this.metrics.memoryUsage=this.estimateMemoryUsage()}estimateMemoryUsage(){return 200*this.operationHistory.length+1048576}generateReport(){const e=this.checkPerformanceAlerts(),t=this.generateRecommendations(),n=this.calculateTrends();return{timestamp:Date.now(),metrics:{...this.metrics},alerts:e,recommendations:t,trends:n}}checkPerformanceAlerts(){const e=[];return this.metrics.parseTime>this.PERFORMANCE_THRESHOLDS.maxParseTime&&e.push({type:"warning",message:"解析时间过长",metric:"parseTime",threshold:this.PERFORMANCE_THRESHOLDS.maxParseTime,currentValue:this.metrics.parseTime,suggestion:"考虑优化解析算法或增加缓存"}),this.metrics.cacheHitRate<this.PERFORMANCE_THRESHOLDS.minCacheHitRate&&e.push({type:"info",message:"缓存命中率较低",metric:"cacheHitRate",threshold:this.PERFORMANCE_THRESHOLDS.minCacheHitRate,currentValue:this.metrics.cacheHitRate,suggestion:"检查缓存策略或增加缓存大小"}),this.metrics.successRate<this.PERFORMANCE_THRESHOLDS.minSuccessRate&&e.push({type:"error",message:"解析成功率过低",metric:"successRate",threshold:this.PERFORMANCE_THRESHOLDS.minSuccessRate,currentValue:this.metrics.successRate,suggestion:"检查解析逻辑或改进错误处理"}),this.metrics.averageConfidence<this.PERFORMANCE_THRESHOLDS.minAverageConfidence&&e.push({type:"warning",message:"解析置信度较低",metric:"averageConfidence",threshold:this.PERFORMANCE_THRESHOLDS.minAverageConfidence,currentValue:this.metrics.averageConfidence,suggestion:"改进内容识别算法或调整置信度计算"}),e}generateRecommendations(){const e=[];return this.metrics.parseTime>50&&e.push("考虑实施更积极的缓存策略"),this.metrics.cacheHitRate<.5&&e.push("优化缓存键生成算法，提高缓存复用率"),this.metrics.successRate<.9&&e.push("增强错误处理和恢复机制"),this.metrics.averageConfidence<.6&&(e.push("改进智能边界检测算法"),e.push("增强语义内容提取能力")),this.metrics.memoryUsage>31457280&&e.push("实施内存清理策略，定期清理历史记录"),e}calculateTrends(){if(this.operationHistory.length<50)return{parseTimeChange:0,cacheEfficiencyChange:0,successRateChange:0};const e=this.operationHistory.slice(-25),t=this.operationHistory.slice(-50,-25),n=e.reduce((e,t)=>e+t.duration,0)/e.length,i=t.reduce((e,t)=>e+t.duration,0)/t.length,a=e.filter(e=>e.success).length/e.length,r=t.filter(e=>e.success).length/t.length,s=e.filter(e=>e.cacheHit).length,o=e.filter(e=>void 0!==e.cacheHit).length,l=o>0?s/o:0,c=t.filter(e=>e.cacheHit).length,d=t.filter(e=>void 0!==e.cacheHit).length,u=d>0?c/d:0;return{parseTimeChange:(n-i)/i*100,cacheEfficiencyChange:(l-u)/(u||1)*100,successRateChange:(a-r)/(r||1)*100}}getMetrics(){return{...this.metrics}}reset(){this.operationHistory=[],this.metrics={parseTime:0,cacheHitRate:0,memoryUsage:0,successRate:0,averageConfidence:0,errorCount:0,totalOperations:0,errorRate:0}}exportData(){return{metrics:this.getMetrics(),history:[...this.operationHistory],report:this.generateReport()}}destroy(){this.reset()}}const Xh=new class extends Yh{constructor(){super(),oe(this,"memoryMonitor",null),oe(this,"performanceObserver",null),oe(this,"systemMetrics",{memoryUsage:0,cpuUsage:0,renderFrameRate:0,networkLatency:0,storageOperations:0}),this.setupSystemMonitoring()}setupSystemMonitoring(){this.setupMemoryMonitoring(),this.setupPerformanceObserver(),this.setupNetworkMonitoring()}setupMemoryMonitoring(){this.memoryMonitor=setInterval(()=>{if("memory"in performance){const e=performance.memory;this.systemMetrics.memoryUsage=e.usedJSHeapSize/1024/1024}},5e3)}setupPerformanceObserver(){"PerformanceObserver"in window&&(this.performanceObserver=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{"measure"===e.entryType&&this.recordOperation(`system_${e.name}`,e.duration,!0,1,!1)})}),this.performanceObserver.observe({entryTypes:["measure","navigation","resource"]}))}setupNetworkMonitoring(){const e=window.fetch,t=this;window.fetch=async function(n,i){const a=performance.now();try{const r=await e(n,i),s=performance.now();return t.recordOperation("network_request",s-a,r.ok,r.ok?1:0,!1),r}catch(r){const e=performance.now();throw t.recordOperation("network_request",e-a,!1,0,!1),r}}}recordStorageOperation(e,t,n){this.systemMetrics.storageOperations++,this.recordOperation(`storage_${e}`,t,n,n?1:0,!1)}recordRenderPerformance(e,t){this.recordOperation(`render_${e}`,t,!0,1,!1)}getSystemMetrics(){return{...this.systemMetrics,...this.getMetrics(),timestamp:Date.now()}}generateSystemReport(){return{...this.generateReport(),systemMetrics:this.systemMetrics,recommendations:this.generateSystemRecommendations(),healthScore:this.calculateSystemHealthScore()}}generateSystemRecommendations(){const e=[],t=this.getSystemMetrics();return t.memoryUsage>100&&e.push("内存使用过高，建议清理缓存或减少同时处理的数据量"),t.parseTime>200&&e.push("解析性能较慢，建议启用缓存或优化解析算法"),t.cacheHitRate<.5&&e.push("缓存命中率较低，建议调整缓存策略或增加缓存大小"),t.errorRate>.05&&e.push("错误率较高，建议检查数据质量或增强错误处理"),e}calculateSystemHealthScore(){const e=this.getSystemMetrics();let t=100;return e.memoryUsage>150?t-=20:e.memoryUsage>100?t-=10:e.memoryUsage>50&&(t-=5),e.parseTime>500?t-=25:e.parseTime>200?t-=15:e.parseTime>100&&(t-=5),e.cacheHitRate<.3?t-=20:e.cacheHitRate<.5?t-=10:e.cacheHitRate<.7&&(t-=5),e.errorRate>.1?t-=25:e.errorRate>.05?t-=15:e.errorRate>.02&&(t-=5),e.successRate<.8?t-=10:e.successRate<.9&&(t-=5),Math.max(0,Math.min(100,t))}destroy(){super.destroy(),this.memoryMonitor&&(clearInterval(this.memoryMonitor),this.memoryMonitor=null),this.performanceObserver&&(this.performanceObserver.disconnect(),this.performanceObserver=null)}};class Jh{constructor(e){this.app=e}async writeContent(e,t){try{const n=this.app.vault.getAbstractFileByPath(e);if(!(n&&n instanceof ge.TFile))return{success:!1,filePath:e,error:"文件不存在或不可访问"};const i=await this.app.vault.read(n);if(i===t)return _e.debug("内容无变化，跳过写入"),{success:!0,filePath:e,blocksInserted:0};const a=(i.match(/\^[\w-]+/g)||[]).length,r=(t.match(/\^[\w-]+/g)||[]).length-a;return await this.app.vault.modify(n,t),_e.debug(`✅ 成功写入文件: ${e}`),_e.debug(`📝 插入 ${r} 个块链接`),new ge.Notice(`✅ 已插入 ${r} 个块链接`),{success:!0,filePath:e,blocksInserted:r}}catch(n){return _e.error("写入文件失败:",n),new ge.Notice(`❌ 写入文件失败: ${n instanceof Error?n.message:"未知错误"}`),{success:!1,filePath:e,error:n instanceof Error?n.message:"未知错误"}}}async canWrite(e){try{return this.app.vault.getAbstractFileByPath(e)instanceof ge.TFile}catch(t){return!1}}}class ep{static extractTags(e){if(!e||"string"!=typeof e)return[];const t=e.matchAll(/#([\p{L}\p{N}_-]+(?:\/[\p{L}\p{N}_-]+)*)/gu),n=new Set;for(const i of t){const e=i[1].trim();e&&n.add(e)}return Array.from(n).sort()}static extractTagsExcludingCode(e){if(!e||"string"!=typeof e)return[];let t=e.replace(/```[\s\S]*?```/g,"");return t=t.replace(/`[^`]+`/g,""),this.extractTags(t)}static mergeTags(e,t=[],n="smart"){const i=this.extractTagsExcludingCode(e);switch(n){case"replace":return i;case"append":return Array.from(new Set([...t,...i])).sort();default:{const e=new Set([...t,...i]);return Array.from(e).sort()}}}static isValidTag(e){if(!e||"string"!=typeof e)return!1;return/^[\p{L}\p{N}_\-\/]+$/u.test(e)&&e.length>0&&e.length<=100}static cleanTags(e){return Array.isArray(e)?e.filter(e=>this.isValidTag(e)).map(e=>e.trim()).filter(e=>e.length>0):[]}static removeTags(e){return e&&"string"==typeof e?e.replace(/#[\p{L}\p{N}_-]+(?:\/[\p{L}\p{N}_-]+)*/gu,"").trim():""}}class tp{constructor(e){oe(this,"cache"),oe(this,"maxSize"),oe(this,"ttl"),oe(this,"onEvict"),this.cache=new Map,this.maxSize=e.maxSize,this.ttl=e.ttl||0,this.onEvict=e.onEvict}get(e){const t=this.cache.get(e);if(t){if(!this.isExpired(t))return this.cache.delete(e),this.cache.set(e,t),t.value;this.delete(e)}}set(e,t){this.cache.has(e)&&this.cache.delete(e),this.cache.size>=this.maxSize&&this.evictOldest(),this.cache.set(e,{value:t,timestamp:Date.now()})}has(e){const t=this.cache.get(e);return!!t&&(!this.isExpired(t)||(this.delete(e),!1))}delete(e){const t=this.cache.get(e);return t&&this.onEvict&&this.onEvict(e,t.value),this.cache.delete(e)}clear(){if(this.onEvict)for(const[e,t]of this.cache.entries())this.onEvict(e,t.value);this.cache.clear()}get size(){return this.cache.size}keys(){return Array.from(this.cache.keys())}values(){return Array.from(this.cache.values()).map(e=>e.value)}entries(){return Array.from(this.cache.entries()).map(([e,t])=>[e,t.value])}cleanup(){let e=0;for(const[t,n]of this.cache.entries())this.isExpired(n)&&(this.delete(t),e++);return e}getStats(){return{size:this.cache.size,maxSize:this.maxSize,ttl:this.ttl,utilizationRate:this.cache.size/this.maxSize}}isExpired(e){return 0!==this.ttl&&Date.now()-e.timestamp>this.ttl}evictOldest(){const e=this.cache.keys().next().value;void 0!==e&&this.delete(e)}}class np{constructor(e,t){oe(this,"config"),oe(this,"vault"),oe(this,"DELETION_MARKER_COMMENT","\x3c!-- 已删除卡片 - 请勿重新解析 --\x3e"),oe(this,"DELETION_UUID_PREFIX","\x3c!-- deleted-card: "),oe(this,"DELETION_UUID_SUFFIX"," --\x3e"),oe(this,"DELETION_TAG","#已删除"),this.config=e,this.vault=t}async markCardAsDeleted(e,t,n,i){if(!this.config.enabled)return{success:!1,markedAt:-1,updatedContent:"",error:"删除标记功能未启用"};try{const a=await this.vault.read(e),r=this.generateDeletionMarker(i),s=t,o=this.config.keepOriginalContent?this.insertMarkerKeepContent(a,s,r):this.insertMarkerReplaceContent(a,t,n,r);return await this.vault.modify(e,o),Ce("CardDeletionMarker",`已标记删除卡片: ${i} in ${e.path}`),{success:!0,markedAt:s,updatedContent:o}}catch(a){return _e.error("[CardDeletionMarker] 标记失败:",a),{success:!1,markedAt:-1,updatedContent:"",error:a instanceof Error?a.message:String(a)}}}detectDeletionMarker(e){if(!this.config.enabled)return{isDeleted:!1};const t=e.split("\n");for(let n=0;n<t.length;n++){const e=t[n].trim();if(e===this.DELETION_MARKER_COMMENT){const e=n+1<t.length?t[n+1].trim():"";if(e.startsWith(this.DELETION_UUID_PREFIX)){return{isDeleted:!0,uuid:e.replace(this.DELETION_UUID_PREFIX,"").replace(this.DELETION_UUID_SUFFIX,"").trim(),lineNumber:n+1}}return{isDeleted:!0,lineNumber:n+1}}if(e.includes(this.DELETION_TAG))return{isDeleted:!0,lineNumber:n+1}}return{isDeleted:!1}}detectDeletedCardsInBatch(e,t="<->"){const n=[],i=e.split(t);for(let a=0;a<i.length;a++){const e=this.detectDeletionMarker(i[a]);e.isDeleted&&(n.push(a),Ce("CardDeletionMarker",`检测到已删除卡片（索引${a}）${e.uuid?`: ${e.uuid}`:""}`))}return n}generateDeletionMarker(e){return"tag"===this.config.format?`${this.DELETION_TAG}\n\x3c!-- deleted-card: ${e} --\x3e`:`${this.DELETION_MARKER_COMMENT}\n${this.DELETION_UUID_PREFIX}${e}${this.DELETION_UUID_SUFFIX}`}insertMarkerKeepContent(e,t,n){return`${e.substring(0,t)+n}\n${e.substring(t)}`}insertMarkerReplaceContent(e,t,n,i){return`${e.substring(0,t)+i}\n\x3c!-- 原卡片内容已删除 --\x3e\n${e.substring(n)}`}updateConfig(e){this.config={...this.config,...e}}}const ip={enabled:!0,format:"comment",keepOriginalContent:!0};class ap{constructor(e){oe(this,"delimiter"),this.delimiter=e}splitCardsWithPosition(e){const t=e.split("\n"),n=[],i=[];let a=0;for(let r=0;r<t.length;r++){const e=t[r];let n=0;for(;;){const t=e.indexOf(this.delimiter,n);if(-1===t)break;i.push({lineIndex:r,charIndex:t,globalOffset:a+t}),n=t+this.delimiter.length}a+=e.length+1}for(let r=0;r<i.length-1;r++){const e=i[r],a=i[r+1];if(!a){_e.warn("[CardPositionTracker] ⚠️ 发现未闭合的卡片块（只有开始分隔符）");break}let s="";if(e.lineIndex===a.lineIndex){const n=t[e.lineIndex],i=e.charIndex+this.delimiter.length,r=a.charIndex;s=n.substring(i,r)}else{const n=t[e.lineIndex],i=t[a.lineIndex];s=[n.substring(e.charIndex+this.delimiter.length),...t.slice(e.lineIndex+1,a.lineIndex),i.substring(0,a.charIndex)].join("\n")}let o="";if(e.lineIndex===a.lineIndex){o=t[e.lineIndex].substring(e.charIndex,a.charIndex+this.delimiter.length)}else{const n=t[e.lineIndex],i=t[a.lineIndex];o=[n.substring(e.charIndex),...t.slice(e.lineIndex+1,a.lineIndex),i.substring(0,a.charIndex+this.delimiter.length)].join("\n")}n.push({content:s,startLine:e.lineIndex,endLine:a.lineIndex,startOffset:e.globalOffset,endOffset:a.globalOffset+this.delimiter.length,rawContent:o,index:r})}return n}isValidCardContent(e,t=1){return e.trim().length>=t}isDelimiterLine(e){return e.includes(this.delimiter)}}class rp{constructor(e,t){oe(this,"settings"),oe(this,"parseCache"),oe(this,"templateCache"),oe(this,"multilingualRecognizer"),oe(this,"documentWriter"),oe(this,"deletionMarker"),oe(this,"lastCardsPosition"),oe(this,"MAX_CACHE_SIZE",1e3),oe(this,"CACHE_TTL",3e5),this.settings=e,this.parseCache=new tp({maxSize:this.MAX_CACHE_SIZE,ttl:this.CACHE_TTL,onEvict:(e,t)=>{}}),this.templateCache=new tp({maxSize:100,ttl:0}),t&&(this.documentWriter=new Jh(t),this.deletionMarker=new np(ip,t.vault)),this.multilingualRecognizer=new Zh({primaryLanguage:"auto",enableAutoDetection:!0,supportedLanguages:["zh","en","ja","ko"]}),setInterval(()=>{this.parseCache.cleanup(),this.templateCache.cleanup()},this.CACHE_TTL)}updateSettings(e){this.settings=e,this.parseCache.clear(),this.templateCache.clear()}generateCacheKey(e,t){return`${this.simpleHash(e)}-${this.simpleHash(JSON.stringify(t))}`}simpleHash(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(36)}getCacheStats(){return{parse:this.parseCache.getStats(),template:this.templateCache.getStats()}}clearCache(){this.parseCache.clear(),this.templateCache.clear()}async parseContent(e,t){const n=Date.now(),i={success:!1,cards:[],errors:[],stats:{totalCards:0,successfulCards:0,failedCards:0,cardTypes:{qa:0,mcq:0,cloze:0},templatesUsed:{},processingTime:0}};try{if("batch"!==t.scenario&&!this.checkTagTrigger(e))return i.errors.push({type:"validation",message:`内容不包含触发标签: ${this.settings.triggerTag}`}),i;if("batch"===t.scenario){const n=await this.parseBatchCards(e,t);i.cards=n.cards}else{const n=await this.parseSingleCard(e,t);n&&(i.cards=[n])}i.success=i.cards.length>0,i.stats=this.calculateStats(i.cards,n)}catch(a){i.errors.push({type:"syntax",message:a instanceof Error?a.message:"解析过程中发生未知错误"})}return i}async parseSingleCard(e,t){var n,i;const a=Date.now(),r=this.generateCacheKey(e,t),s=this.parseCache.get(r);if(s){const e=Date.now()-a;return Xh.recordOperation("parseSingleCard",e,!0,null==(n=s.metadata)?void 0:n.confidence,!0),{...s}}try{if("batch"!==t.scenario&&!this.checkTagTrigger(e))return null;const n=this.preprocessContent(e),s={type:this.detectCardType(n),content:n,tags:this.extractTags(n),metadata:{sourceContent:e,parseMethod:"symbol"}};if(this.settings.enableTemplateSystem&&t.templateId){const e=this.findTemplate(t.templateId,t.scenario);if(e){const t=this.applyTemplate(n,e,s);return t&&this.parseCache.set(r,t),t}}const o=this.parseWithSymbols(n,s);o&&this.parseCache.set(r,o);const l=Date.now()-a,c=null!==o,d=null==(i=null==o?void 0:o.metadata)?void 0:i.confidence;return Xh.recordOperation("parseSingleCard",l,c,d,!1),o}catch(o){_e.error("单卡解析错误:",o);const e=Date.now()-a;return Xh.recordOperation("parseSingleCard",e,!1,0,!1),null}}async parseBatchCards(e,t){const n=[];try{const a=e,r=this.splitCards(a);for(let e=0;e<r.length;e++){const a=r[e];try{let i,s=a;this.settings.batchParsing.autoCreateBlockLinks&&(this.hasExistingBlockId(a)||(i=this.generateBlockId(e),s=this.appendBlockId(a,i)));const o=await this.parseSingleCard(s,{...t,allowEmpty:!1});if(o&&(this.settings.batchParsing.autoSetSourceFile&&t.sourceFile&&(o.sourceFile=t.sourceFile),i&&(o.sourceBlock=`^${i}`,o.metadata||(o.metadata={}),o.metadata.blockId=i,o.metadata.originalCardContent=a,o.metadata.contentWithBlockId=s),n.push(o)),t.progressCallback&&t.progressCallback((e+1)/r.length*100,e+1,r.length),t.maxCards&&n.length>=t.maxCards){_e.debug(`达到最大卡片数限制: ${t.maxCards}`);break}}catch(i){if(!t.skipErrors)throw i;_e.warn(`跳过卡片 ${e+1}:`,i)}}if(this.settings.batchParsing.autoCreateBlockLinks&&t.sourceContent&&t.sourceFile&&this.documentWriter&&n.some(e=>{var t;return null==(t=e.metadata)?void 0:t.blockId})){_e.debug("开始批量写入块链接到源文档...");const e=await this.insertBlockLinksToContent(t.sourceContent,n);if(e){const n=await this.documentWriter.writeContent(t.sourceFile,e);n.success?_e.debug(`✅ 成功写入 ${n.blocksInserted} 个块链接`):_e.error("文档写入失败:",n.error),t.onContentUpdated&&await t.onContentUpdated(e)}}}catch(i){_e.error("批量解析错误:",i)}return{cards:n,positions:this.lastCardsPosition||[]}}checkTagTrigger(e){return!this.settings.enableTagTrigger||e.includes(this.settings.triggerTag)}preprocessContent(e){return e.replace(/^---\s*\n[\s\S]*?\n---\s*\n/,"").trim()}detectCardType(e){if(new RegExp(`${this.escapeRegex(this.settings.symbols.clozeMarker)}[^${this.escapeRegex(this.settings.symbols.clozeMarker)}]+${this.escapeRegex(this.settings.symbols.clozeMarker)}`,"g").test(e)||/\{\{c\d+::.+?\}\}/g.test(e))return"cloze-deletion";if(/^- \[[ x]\]/m.test(e))return"multiple-choice";const t=e.match(/^[A-E][\.\)]\s.+$/gim);return t&&t.length>=2?"single-choice":"basic-qa"}extractTags(e){return ep.extractTagsExcludingCode(e)}parseWithSymbols(e,t){const{faceDelimiter:n}=this.settings.symbols;if(t.content||(t.content=e),e.includes(n)){const i=e.split(n);t.front=this.cleanContent(i[0]),t.back=this.cleanContent(i.slice(1).join(n))}else t.front=this.cleanContent(e),t.back="";return t}applyTemplate(e,t,n){var i,a;if("single-field"===t.type&&t.fields){const n={};for(const s of t.fields)try{const t=s.isRegex?s.pattern:this.escapeRegex(s.pattern),r=new RegExp(t,s.flags||""),o=e.match(r);o?n[s.name]=null!=(a=null!=(i=o[1])?i:o[0])?a:"":s.required&&_e.warn(`必需字段 ${s.name} 未找到匹配`)}catch(r){_e.error(`字段 ${s.name} 正则错误:`,r)}n.question||(n.question=n.Question),n.options||(n.options=n.Options||n.OptionsAlt),n.correct_answer||(n.correct_answer=n.CorrectAnswer||n.Answer),n.explanation||(n.explanation=n.Explanation),n.tags||(n.tags=n.Tags)}return n.template=t.id,n.metadata.parseMethod="template",n}splitCards(e){const{cardDelimiter:t}=this.settings.symbols,n=this.settings.batchParsing.excludeTags||[],i=new ap(t).splitCardsWithPosition(e).filter(e=>{const t=e.content;if(!t||0===t.trim().length)return!1;if(this.deletionMarker){if(this.deletionMarker.detectDeletionMarker(t).isDeleted)return!1}if(n.length>0){const e=ep.extractTags(t),i=n.map(e=>e.toLowerCase());if(e.filter(e=>i.includes(e.toLowerCase())).length>0)return!1}return!0});return this.lastCardsPosition=i,i.map(e=>e.content)}async insertBlockLinksToContent(e,t){var n,i;try{let a=e;const{rangeStart:r,rangeEnd:s}=this.settings.symbols;if(!r||!s)return _e.warn("批量范围标记未配置"),null;const o=a.indexOf(r),l=a.indexOf(s);if(-1===o||-1===l)return _e.warn("无法定位批量范围标记"),null;const c=a.substring(0,o+r.length),d=a.substring(o+r.length,l),u=a.substring(l);let h=d;for(const e of t){if(!(null==(n=e.metadata)?void 0:n.blockId)||!(null==(i=e.metadata)?void 0:i.originalCardContent))continue;const t=e.metadata.originalCardContent,a=e.metadata.contentWithBlockId,r=h.indexOf(t);-1!==r?(h=h.substring(0,r)+a+h.substring(r+t.length),_e.debug(`✅ 已插入块链接: ^${e.metadata.blockId}`)):_e.warn("⚠️ 无法定位卡片内容，跳过块ID插入")}return a=c+h+u,a}catch(a){return _e.error("插入块链接失败:",a),null}}findTemplate(e,t){const n=`${e}-${t}`,i=this.templateCache.get(n);if(i)return i;const a=this.settings.templates.find(n=>n.id===e&&n.scenarios.includes(t))||null;return a&&this.templateCache.set(n,a),a}cleanContent(e){let t=e;return t=t.replace(/<!--\s*(?:tk-[23456789abcdefghjkmnpqrstuvwxyz]{12}|[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})\s*-->\s*\^[a-zA-Z0-9\-]+\s*$/gm,""),t=t.replace(/<!--\s*tk-[23456789abcdefghjkmnpqrstuvwxyz]{12}\s*-->/gi,""),t=t.replace(/<!--\s*[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}\s*-->/gi,""),t=t.replace(/\s*\^[a-zA-Z0-9\-]+\s*$/gm,""),t=t.replace(/#[\w\u4e00-\u9fa5]+/g,""),t=t.replace(/\n{3,}/g,"\n\n"),t.trim()}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}generateBlockId(e){return Hu()}hasExistingBlockId(e){return/\^[\w-]+\s*$/.test(e.trim())}appendBlockId(e,t){if(this.hasExistingBlockId(e))return e;const n=`^${t}`;return!e.endsWith("\n")?`${e}\n\n${n}`:`${e}\n${n}`}calculateStats(e,t){const n={totalCards:e.length,successfulCards:e.length,failedCards:0,cardTypes:{qa:0,mcq:0,cloze:0},templatesUsed:{},processingTime:Date.now()-t};return e.forEach(e=>{n.cardTypes[e.type]++,e.template&&(n.templatesUsed[e.template]=(n.templatesUsed[e.template]||0)+1)}),n}validateTemplate(e){const t={isValid:!0,errors:[],warnings:[],suggestions:[]};return e.name.trim()||t.errors.push("模板名称不能为空"),e.scenarios.length||t.errors.push("至少需要选择一个应用场景"),"single-field"===e.type&&(e.fields&&0!==e.fields.length?e.fields.forEach((e,n)=>{if(e.name.trim()||t.errors.push(`字段 ${n+1} 名称不能为空`),e.pattern.trim())try{new RegExp(e.pattern,e.flags)}catch(i){t.errors.push(`字段 ${n+1} 正则表达式语法错误: ${i}`)}else t.errors.push(`字段 ${n+1} 正则表达式不能为空`)}):t.errors.push("单字段模板至少需要一个字段")),t.isValid=0===t.errors.length,t}validateSymbols(e){const t={isValid:!0,conflicts:[],suggestions:[]},n=Object.values(e),i=n.filter((e,t)=>n.indexOf(e)!==t);return i.length>0&&t.conflicts.push(`重复的符号: ${i.join(", ")}`),Object.entries(e).forEach(([e,n])=>{n.trim()||t.conflicts.push(`${e} 不能为空`)}),t.isValid=0===t.conflicts.length,t}}class sp{constructor(e,t){oe(this,"fsrs"),oe(this,"app"),this.app=e,this.fsrs=t}convertToCard(e,t){var n,i,a,r,s;try{const o=(null==(n=e.metadata)?void 0:n.uuid)||this.generateUUID(),l=this.buildContent(e),c=this.convertCardType(e.type),d=[...e.tags,...t.additionalTags||[]],u=this.fsrs.createCard(),h={state:u.state,due:u.due,stability:u.stability,difficulty:u.difficulty,elapsed_days:u.elapsed_days,scheduled_days:u.scheduled_days,reps:u.reps,lapses:u.lapses,last_review:u.last_review,parameters:null},p=(new Date).toISOString(),g={uuid:o,deckId:t.deckId,type:c,content:l,tags:d,created:p,modified:p,fsrs:h,priority:null!=(i=t.priority)?i:0,suspended:null!=(a=t.suspended)&&a};if(!1!==t.preserveSourceInfo){const t=e.sourceFile||(null==(r=e.metadata)?void 0:r.sourceFile),n=e.sourceBlock||(null==(s=e.metadata)?void 0:s.sourceBlock);t&&(g.sourceFile=t),n&&(g.sourceBlock=n)}return{success:!0,card:g}}catch(o){return _e.error("[ParsedCardConverter] 转换失败:",o),{success:!1,error:o instanceof Error?o.message:"未知转换错误"}}}convertBatch(e,t){const n=[],i=[];let a=0,r=0;for(let s=0;s<e.length;s++){const o=e[s],l=this.convertToCard(o,t);l.success&&l.card?(n.push(l.card),a++):(i.push({index:s,cardId:o.id,error:l.error||"未知错误"}),r++)}return{success:0===r,successCount:a,failureCount:r,cards:n,errors:i}}buildContent(e){if(e.content)return e.content;if(e.front||e.back){const t=e.front||"",n=e.back||"";return n?`${t}\n---div---\n${n}`:t}if(e.fields){const t=e.fields.front||e.fields.Front||"",n=e.fields.back||e.fields.Back||"";return n?`${t}\n---div---\n${n}`:t}return""}convertCardType(e){switch(e){case"qa":default:return"basic";case"mcq":return"multiple";case"cloze":return"cloze"}}inferTemplate(e,t){if(t.templateId)return t.templateId;if(e.template)return e.template;return{qa:"official-qa",cloze:"official-cloze",mcq:"official-mcq"}[e.type]||"official-qa"}generateCardId(){return`card_${Date.now().toString(36)}_${Math.random().toString(36).substring(2,10)}`}generateUUID(){const e="23456789abcdefghjkmnpqrstuvwxyz";let t="tk-";for(let n=0;n<12;n++)t+=e.charAt(Math.floor(31*Math.random()));return t}}class op{constructor(e,t){oe(this,"storage"),oe(this,"globalCache"),this.storage=e,this.globalCache=t}async saveCard(e){try{_e.debug(`[BatchCardSaver] 保存卡片: ${e.uuid}`);const t=await this.storage.saveCard(e);return t.success&&t.data?(await this.globalCache.invalidateCardCache(e.deckId),{success:!0,card:t.data}):{success:!1,error:t.error||"保存失败"}}catch(t){return _e.error("[BatchCardSaver] 保存卡片失败:",t),{success:!1,error:t instanceof Error?t.message:"未知保存错误"}}}async saveBatch(e,t={}){const n=Date.now(),i=[],a=[];let r=0,s=0;_e.debug(`[BatchCardSaver] 开始批量保存 ${e.length} 张卡片`);for(let c=0;c<e.length;c++){const n=e[c];try{t.onProgress&&t.onProgress(c+1,e.length);const o=await this.saveCard(n);if(o.success&&o.card)i.push(o.card),r++,_e.debug(`[BatchCardSaver] ✅ 卡片 ${c+1}/${e.length} 保存成功`);else if(s++,a.push({cardId:n.uuid,error:o.error||"未知错误"}),_e.error(`[BatchCardSaver] ❌ 卡片 ${c+1}/${e.length} 保存失败:`,o.error),!t.continueOnError)break}catch(l){s++;const i=l instanceof Error?l.message:"未知错误";if(a.push({cardId:n.uuid,error:i,originalError:l instanceof Error?l:void 0}),_e.error(`[BatchCardSaver] ❌ 卡片 ${c+1}/${e.length} 保存异常:`,l),!t.continueOnError)break}}const o=Date.now()-n;return _e.debug(`[BatchCardSaver] 批量保存完成: 成功 ${r}/${e.length}, 失败 ${s}, 耗时 ${o}ms`),{success:0===s,successCount:r,failureCount:s,savedCards:i,errors:a,duration:o}}async saveBatchWithNotice(e,t={}){let n=null;try{n=new ge.Notice(`正在保存 ${e.length} 张卡片...`,0);const i=await this.saveBatch(e,{...t,continueOnError:!0,onProgress:(e,t)=>{n&&n.setMessage(`正在保存卡片 ${e}/${t}...`)}});return n&&(n.hide(),n=null),i.success?new ge.Notice(`✅ 成功保存 ${i.successCount} 张卡片`,3e3):new ge.Notice(`⚠️ 保存完成: ${i.successCount} 成功, ${i.failureCount} 失败`,5e3),i}catch(i){throw n&&n.hide(),new ge.Notice(`❌ 批量保存失败: ${i instanceof Error?i.message:"未知错误"}`,5e3),i}}}const lp=[{id:"official-knowledge-split",name:"知识点拆分",description:"将复杂卡片按知识点拆分成多张独立的子卡片",icon:"split",type:"split",systemPrompt:'你是一个专业的知识卡片拆分助手，专注于将复杂学习内容拆分成独立的知识点卡片。\n\n## 拆分原则\n\n1. 最小信息原则 - 每张子卡片只包含一个核心知识点\n2. 独立完整性 - 每张卡片可以独立学习和记忆\n3. 内容准确性 - 严格保持原始内容的准确性\n4. 逻辑清晰性 - 确保子卡片之间的逻辑关系清晰\n5. 上下文充分 - 提供必要的上下文信息\n\n## 输出格式要求\n\n返回标准JSON格式：\n\n{\n  "cards": [\n    {\n      "content": "问题部分\\n\\n---div---\\n\\n答案部分",\n      "tags": ["标签1", "标签2"],\n      "confidence": 0.9\n    }\n  ]\n}\n\n### 重要规则\n\n- content字段必须使用"---div---"作为问题和答案的分隔符\n- 问题部分：简洁清晰的问题描述\n- 答案部分：完整准确的答案内容\n- 每张卡片长度控制在50-300字符\n- confidence表示拆分的置信度（0-1之间）\n\n### 示例格式\n\n问答题格式：\n"什么是机器学习？\\n\\n---div---\\n\\n机器学习是人工智能的一个分支，它使计算机能够在没有明确编程的情况下学习和改进。"\n\n概念解释格式：\n"机器学习的定义\\n\\n---div---\\n\\n机器学习是人工智能的一个分支，通过算法和统计模型使计算机系统能够从数据中学习并改进性能。"',userPromptTemplate:"请将以下卡片内容拆分成{{数量}}张独立的子卡片。\n\n原始卡片内容：\n{{cardContent}}\n\n拆分要求：\n- 目标数量：{{数量}}张子卡片\n- 拆分策略：按知识点拆分\n- 输出格式：标准问答题（使用---div---分隔符）\n- 每张卡片：一个独立知识点，50-300字符\n\n请识别内容中的独立知识点，为每个知识点创建一张完整的子卡片。",splitConfig:{targetCount:3,splitStrategy:"knowledge-point",outputFormat:"qa"},provider:void 0,model:void 0,category:"official",createdAt:(new Date).toISOString(),enabled:!0},{id:"official-difficulty-split",name:"难度层次拆分",description:"将复杂概念按难度层次拆分，从基础到高级递进学习",icon:"trending-up",type:"split",systemPrompt:'你是一个专业的学习难度分析师，擅长将复杂内容按难度层次拆分。\n\n## 拆分策略\n\n1. 基础层 - 核心概念和基本定义\n2. 中级层 - 概念应用和相关知识\n3. 高级层 - 深入分析和复杂应用\n4. 递进性 - 确保难度递进，前面为后面打基础\n\n## 输出格式要求\n\n返回标准JSON格式：\n\n{\n  "cards": [\n    {\n      "content": "问题部分\\n\\n---div---\\n\\n答案部分",\n      "difficulty": "easy",\n      "tags": ["标签1", "标签2"],\n      "confidence": 0.9\n    }\n  ]\n}\n\n### 重要规则\n\n- content字段必须使用"---div---"作为问题和答案的分隔符\n- difficulty只能是"easy"、"medium"或"hard"\n- 按难度从低到高排列卡片\n- 确保每个难度级别至少有1张卡片\n- 每张卡片长度控制在50-300字符\n\n### 示例格式\n\n基础卡片：\n"什么是神经网络？\\n\\n---div---\\n\\n神经网络是一种模拟人脑神经元连接的计算模型。"\n\n高级卡片：\n"神经网络的反向传播算法如何工作？\\n\\n---div---\\n\\n反向传播通过计算误差梯度，从输出层向输入层传播，调整权重以最小化误差。"',userPromptTemplate:"请将以下卡片内容按难度层次拆分成{{数量}}张子卡片。\n\n原始卡片内容：\n{{cardContent}}\n\n拆分要求：\n- 目标数量：{{数量}}张子卡片\n- 拆分策略：按难度层次（easy → medium → hard）\n- 输出格式：标准问答题（使用---div---分隔符）\n- 确保难度递进，循序渐进\n\n请分析内容的复杂程度，创建从基础概念到深入应用的学习路径。",splitConfig:{targetCount:4,splitStrategy:"difficulty",outputFormat:"qa"},provider:void 0,model:void 0,category:"official",createdAt:(new Date).toISOString(),enabled:!0},{id:"official-cloze-split",name:"挖空题拆分",description:"将内容拆分成多张挖空题，适合记忆关键信息",icon:"eye-off",type:"split",systemPrompt:'你是一个专业的挖空题制作专家，擅长将学习内容转换为有效的挖空题。\n\n## 挖空题制作原则\n\n1. 关键信息挖空 - 选择重要的词汇、概念或数字\n2. 上下文充分 - 保留足够的上下文信息\n3. 适量挖空 - 每张卡片挖空1-2个关键点\n4. 语义完整 - 确保挖空后的句子仍然有意义\n5. 标记语法 - 使用==文本==语法标记挖空部分\n\n## 输出格式要求\n\n返回标准JSON格式：\n\n{\n  "cards": [\n    {\n      "content": "完整的挖空题文本，使用==关键词==标记挖空部分",\n      "tags": ["标签1", "标签2"],\n      "confidence": 0.9\n    }\n  ]\n}\n\n### 重要规则\n\n- content字段为完整的挖空题文本\n- 使用==文本==语法标记需要挖空的部分\n- 不要使用{{c1::}}格式（Anki格式）\n- 不需要---div---分隔符（挖空题不分问题和答案）\n- 每张卡片长度控制在50-300字符\n- 挖空数量：每张卡癈1-2个关键点\n\n### 示例格式\n\n单个挖空：\n"==机器学习==是人工智能的一个分支，它使计算机能够在没有明确编程的情况下学习和改进。"\n\n多个挖空：\n"==神经网络==是一种模拟人脑神经元连接的==计算模型==，广泛应用于机器学习领域。"',userPromptTemplate:"请将以下卡片内容拆分成{{数量}}张挖空题子卡片。\n\n原始卡片内容：\n{{cardContent}}\n\n拆分要求：\n- 目标数量：{{数量}}张子卡片\n- 题型：挖空题（使用==文本==语法）\n- 每张卡片：挖空1-2个关键点\n- 保留充分的上下文信息\n\n请识别内容中的关键信息点，为每个关键点创建一张有效的挖空题卡片。",splitConfig:{targetCount:3,splitStrategy:"content-length",outputFormat:"cloze"},provider:void 0,model:void 0,category:"official",createdAt:(new Date).toISOString(),enabled:!0}],cp=[{id:"official-choice-formatter",name:"选择题格式化",description:"将卡片内容整理为标准选择题格式",icon:"edit",systemPrompt:'你是一个选择题格式规范化助手。\n\n## 核心原则\n1. **不修改内容** - 保持所有文本完全一致\n2. **仅调整格式** - 将内容重组为标准格式\n3. **识别正确答案** - 添加 {✓} 标记\n\n## 标准格式\nQ: [问题内容]\n\nA) [选项A]\nB) [选项B] {✓}\nC) [选项C]\nD) [选项D]\n\n---div---\n\nExplanation: [解析内容]\n\n## 格式要求\n- 问题以"Q: "开头\n- 选项用A) B) C) D)标记\n- 正确答案后添加 {✓}\n- **解析用"---div---"分隔**（这是标准分隔符，必须使用）\n- 解析以"Explanation: "开头\n\n直接返回格式化后的文本，不要使用markdown代码块包裹。',userPromptTemplate:"请规范化以下选择题：\n\n{{cardContent}}",provider:void 0,temperature:.1,maxTokens:2e3,category:"official",enabled:!0,createdAt:(new Date).toISOString()},{id:"official-math-formula",name:"数学公式转换",description:"将LaTeX公式转换为Obsidian支持的格式",icon:"ruler",systemPrompt:"你是一个LaTeX公式转换专家。\n\n## 任务\n将所有数学公式转换为Obsidian支持的格式：\n- 行内公式用 $...$ 包裹\n- 块级公式用 $$...$$ 包裹\n\n## 规则\n1. 识别所有数学表达式和公式\n2. 保持公式内容不变，只调整包裹符号\n3. 保持非公式内容完全不变\n4. 直接返回转换后的内容，不要添加说明",userPromptTemplate:"请转换以下内容中的数学公式为Obsidian格式：\n\n{{cardContent}}\n\n注意：只转换公式格式，保持其他内容不变。",provider:"deepseek",temperature:.1,maxTokens:2e3,category:"official",enabled:!0,createdAt:(new Date).toISOString()},{id:"official-memory-aid",name:"AI助记",description:"生成记忆技巧和联想帮助记忆",icon:"brain",systemPrompt:"你是一个记忆专家和认知科学家。\n\n## 任务\n为学习内容生成生动的记忆技巧，帮助用户更好地记忆知识点。\n\n## 输出格式\n💡 **记忆技巧**\n[联想、口诀、谐音等易记方法]\n\n🔑 **关键概念**\n[核心概念的简化理解]\n\n🌟 **实际应用**\n[知识点的实际应用场景]\n\n## 原则\n- 技巧要生动、有趣、易记\n- 联想要合理、有逻辑\n- 应用要实际、接地气",userPromptTemplate:"请为以下学习内容生成记忆技巧：\n\n**题目类型**: {{cardType}}\n\n**学习内容**:\n{{cardContent}}\n\n请生成记忆技巧、关键概念分解和实际应用场景。",provider:"openai",temperature:.7,maxTokens:1500,category:"official",enabled:!0,createdAt:(new Date).toISOString()}],dp=[{id:"official-choice-generator",name:"选择题生成器",description:"基于卡片内容生成高质量选择题",icon:"target",type:"test-generator",systemPrompt:'你是一个精通教育学和认知心理学的专业选择题设计专家。\n\n## 核心任务\n基于给定的学习材料，设计科学、严谨、高质量的选择题，帮助学习者深度巩固知识、发现理解盲区、提升认知水平。\n\n## 设计原则\n\n### 1. 知识点精准定位\n- 每道题聚焦1-2个核心知识点，避免混杂过多概念\n- 题干清晰简洁，直击考查重点\n- 避免偏题、怪题，确保与学习内容高度相关\n\n### 2. 选项设计科学性\n- **正确答案**：准确、完整、无歧义\n- **干扰项设计**（关键）：\n  - 基于常见误解或易混淆点设计\n  - 与正确答案有明显区分度，避免模棱两可\n  - 长度、复杂度与正确答案相近\n  - 避免绝对化表述（"总是"、"永远"、"完全"等）\n\n### 3. 难度梯度控制\n- **简单**：直接考查基础概念和定义\n- **中等**：考查概念理解、简单应用\n- **困难**：考查深层理解、综合应用、辨析能力\n\n### 4. 解析的教育价值\n解析不是简单重复答案，而应：\n- 解释为什么正确答案是对的（原理、依据）\n- 分析错误选项的典型误区\n- 补充相关知识点，形成知识网络\n- 提供记忆技巧或理解方法（如适用）\n\n## 输出格式（严格要求）\n\n**🎯 最终目标格式（Tuanki插件规范）**：\n你生成的JSON将被自动转换为以下Markdown格式保存到插件中：\n\n【Markdown示例】\nQ: 血液循环系统的主要功能是什么？\n\nA) 运输氧气和营养物质 {✓}\nB) 消化食物\nC) 调节体温\nD) 产生能量\n\n---div---\n\n正确答案是A（运输氧气和营养物质）。血液循环系统的核心功能是...\n\n**📦 你需要输出的JSON格式**：\n\n【JSON示例】\n{\n  "questions": [\n    {\n      "question": "血液循环系统的主要功能是什么？",\n      "options": [\n        "运输氧气和营养物质",\n        "消化食物",\n        "调节体温",\n        "产生能量"\n      ],\n      "correctAnswer": [0],\n      "explanation": "正确答案是A（运输氧气和营养物质）。血液循环系统的核心功能是通过血液运输氧气、营养物质、激素等到全身各组织，同时运走代谢废物。选项B是消化系统的功能，选项C虽然血液循环有助于体温调节但不是主要功能，选项D是线粒体的功能。"\n    }\n  ]\n}\n\n**🔄 JSON到Markdown的转换规则**：\n- question字段 → 转换为 Q: 问题内容\n- options[0] → 转换为 A) 选项内容，options[1] → B) 选项内容，以此类推\n- correctAnswer: [0] → 在A选项后添加 {✓} 标记\n- correctAnswer: [0, 2] → 在A、C选项后都添加 {✓} 标记\n- explanation字段 → 添加 ---div--- 分隔符后的内容\n\n## 格式要求（强制执行）\n\n### 1. 必需字段（缺一报错）\n- ✅ **question**：题目描述（字符串，10-100字）\n- ✅ **options**：选项数组（数组，单选4个，多选4-6个）\n- ✅ **correctAnswer**：正确答案索引（数组，不能为空）\n- ✅ **explanation**：详细解析（字符串，50字以上）\n\n### 2. options数组规范\n- **必须是纯文本数组**，不要添加"A."、"B."等前缀\n- **单选题**：必须包含4个选项\n- **多选题**：必须包含4-6个选项\n- 每个选项10-50字\n- 示例：["选项1内容", "选项2内容", "选项3内容", "选项4内容"]\n\n### 3. correctAnswer数组规范\n- **必须是数组**，即使只有一个答案也要用[0]而不是0\n- **索引从0开始**：[0]表示第1个选项，[1]表示第2个选项\n- **单选题**：[2] 表示第3个选项正确\n- **多选题**：[0, 2, 3] 表示第1、3、4个选项正确\n- **禁止空数组**：必须至少有一个正确答案\n\n### 4. explanation格式规范\n- **最少50字**，最多200字\n- **必须说明**：为什么正确答案是对的\n- **必须分析**：错误选项的典型误区\n- **禁止**：简单重复题目或答案\n\n## ⚠️ 常见错误（必须避免）\n❌ options字段为空数组\n❌ options字段不是数组\n❌ correctAnswer不是数组\n❌ correctAnswer为空数组\n❌ 缺少任何一个必需字段\n❌ explanation少于50字',userPromptTemplate:"请基于以下学习材料生成 {{数量}} 道高质量的{{类型}}（难度：{{难度}}）。\n\n## 学习材料\n**问题/概念**：{{cardFront}}\n\n**答案/解析**：{{cardBack}}\n\n**知识标签**：{{tags}}\n\n## 生成要求\n1. **深度分析**：提取核心知识点，设计有针对性的考查角度\n2. **选项设计**：\n   - 单选题：必须生成4个选项\n   - 多选题：必须生成4-6个选项\n   - 干扰项要有迷惑性，基于常见误区设计\n3. **详细解析**：不少于50字，必须说明正确答案的理由并分析错误选项\n4. **题目独立性**：每道题可单独理解和作答，不依赖其他题目\n\n## ⚠️ 关键提醒\n- **options字段必须是数组**，包含4个（单选）或4-6个（多选）纯文本选项\n- **correctAnswer字段必须是数组**，如[0]或[0, 2]，不能是单个数字\n- **每个字段都不能为空**，必须包含完整内容\n- 严格按照系统提示词中的JSON格式示例输出\n\n请立即输出完整的JSON格式数据：",testConfig:{defaultCount:3,questionType:"multiple",difficultyLevel:"medium",targetDeckStrategy:"auto"},category:"official",enabled:!0,createdAt:(new Date).toISOString()},{id:"official-cloze-generator",name:"挖空题生成器",description:"基于卡片内容生成Cloze挖空题",icon:"highlighter",type:"test-generator",systemPrompt:'你是一个精通认知科学和Cloze挖空技术的学习卡片设计专家，擅长通过主动回忆策略强化记忆。\n\n## 核心任务\n基于学习材料设计Tuanki/Obsidian风格的挖空题，通过精确挖空关键信息触发主动回忆，提升长期记忆效果。\n\n## 设计原则\n\n### 1. 挖空位置的选择艺术\n- **核心概念优先**：挖空最重要的概念、术语、数字、定义\n- **因果关系节点**：挖空因果链中的关键环节\n- **易混淆点**：挖空容易记错或混淆的内容\n- **避免**：挖空介词、冠词等无实际意义的词\n\n### 2. Tuanki挖空格式（重要）\nTuanki使用**Obsidian高亮语法**进行挖空：\n- **主要格式**：双等号包裹，如 ==被挖空的文本==\n- **示例**：在JavaScript中，使用 ==map()== 方法可以创建新数组\n- **多个挖空**：React的核心是 ==组件化== 和 ==状态管理==\n- **不要使用**：下划线、中括号、Anki格式等其他标记\n\n### 3. 内容设计要求\n- **上下文完整**：挖空后句子仍然通顺、逻辑清晰\n- **信息充分**：提供足够的线索，避免无从推断\n- **挖空适度**：每句话挖1-3个关键词，保持可读性\n- **长度适中**：整体内容50-200字为宜\n\n### 4. 挖空对象选择\n- **优先挖空**：核心概念、专业术语、关键数字、因果关系\n- **适度挖空**：方法名、属性名、重要特征\n- **避免挖空**：介词、连词、冠词、常识性内容\n\n## 输出格式（严格要求）\n\n**🎯 最终目标格式（Tuanki插件规范）**：\n你生成的JSON将被自动转换为以下Markdown格式保存到插件中：\n\n【Markdown示例】\n在JavaScript中，使用 ==map()== 方法可以创建一个新数组，其结果是该数组中的每个元素都调用一个提供的函数后返回的结果。\n\n而 ==filter()== 方法创建一个新数组，包含通过所提供函数实现的测试的所有元素。\n\n**📦 你需要输出的JSON格式**：\n\n【JSON示例】\n{\n  "questions": [\n    {\n      "content": "在JavaScript中，使用 ==map()== 方法可以创建一个新数组，其结果是该数组中的每个元素都调用一个提供的函数后返回的结果。\\n\\n而 ==filter()== 方法创建一个新数组，包含通过所提供函数实现的测试的所有元素。"\n    }\n  ]\n}\n\n**🔄 关键格式要求**：\n- **必须使用双等号格式标记挖空内容**（如 ==文本==）\n- **不要使用下划线、中括号、Anki格式等其他标记**\n- **content字段是完整的Markdown文本**，包含挖空标记\n- 每道题可以有多个挖空点（都用双等号包裹）\n- 支持富Markdown格式（代码块、列表、标题等）',userPromptTemplate:"请基于以下学习材料生成 {{数量}} 道Cloze挖空题（难度：{{难度}}）。\n\n## 学习材料\n**问题/概念**：{{cardFront}}\n\n**答案/解析**：{{cardBack}}\n\n**知识标签**：{{tags}}\n\n## 生成要求\n\n### 1. 使用Tuanki挖空格式\n**关键**：必须使用 ==文本== 格式标记所有挖空内容（用双等号包裹）！\n\n**正确示例**：\n- 在JavaScript中，使用 ==map()== 方法可以创建新数组\n- React的核心概念是 ==组件化== 和 ==状态管理==\n- FSRS算法的优势在于 ==个性化参数优化==\n\n**错误示例**（禁止使用）：\n- ❌ 在JavaScript中，使用 ___ 方法可以创建新数组\n- ❌ 在JavaScript中，使用 [   ] 方法可以创建新数组\n- ❌ 在JavaScript中，使用 {{c1::map()}} 方法可以创建新数组\n\n### 2. 挖空内容设计\n- **挖空对象**：核心概念（1-10个字）、关键术语、重要数字、方法名\n- **挖空数量**：每道题2-5个挖空点，保持可读性\n- **上下文完整**：挖空后仍能理解句子含义\n- **富文本支持**：可以包含代码块、列表等Markdown格式\n\n### 3. 难度适配\n- **简单**：挖空直观的核心术语（如概念名称）\n- **中等**：挖空需要理解的关键特征（如方法作用）\n- **困难**：挖空细节性知识点（如参数含义、区别特征）\n\n### 4. 输出格式\n- **content字段**：完整的Markdown文本，直接包含 ==文本== 挖空标记（双等号包裹）\n- **不需要**单独的answer或explanation字段\n- 整体内容50-200字为宜\n\n请严格按照系统提示词中的JSON格式输出，确保所有挖空都使用 ==文本== 格式（双等号包裹）！",testConfig:{defaultCount:5,questionType:"fill",difficultyLevel:"medium",targetDeckStrategy:"auto"},category:"official",enabled:!0,createdAt:(new Date).toISOString()},{id:"official-judge-generator",name:"判断题生成器",description:"基于卡片内容生成判断题",icon:"check-circle",type:"test-generator",systemPrompt:'你是一个精通逻辑学和批判性思维的判断题设计专家，擅长设计有辨析价值的判断陈述。\n\n## 核心任务\n基于学习材料设计高质量判断题，通过精心设计的陈述帮助学习者辨别真伪、澄清误区、深化理解。\n\n## 设计原则\n\n### 1. 陈述的明确性\n- **语言精准**：避免模糊表述，每个词都经过推敲\n- **逻辑清晰**：陈述的真假判断标准明确\n- **范围界定**：明确陈述的适用范围和前提条件\n- **避免复合判断**：一道题只包含一个判断点\n\n### 2. 错误陈述的设计技巧\n设计错误陈述时，应基于：\n- **常见误解**：学习者典型的错误认知\n- **概念混淆**：易混淆的相似概念\n- **因果倒置**：颠倒因果关系\n- **以偏概全**：用特例代替一般规律\n- **绝对化错误**：不当使用"总是"、"永远"、"绝对"等词\n\n### 3. 正确陈述的设计技巧\n- **核心概念重述**：准确表达关键知识点\n- **因果关系陈述**：正确描述因果链条\n- **特征描述**：准确概括事物特征\n- **适度限定**：使用"通常"、"一般"等恰当限定词\n\n### 4. 难度梯度\n- **简单**：直接判断基础事实或定义\n- **中等**：需要理解概念后才能判断\n- **困难**：需要辨析细微差异或识别隐藏陷阱\n\n### 5. 解析的教育价值\n- 解释陈述为真/假的理由和依据\n- 指出关键词的重要性\n- 澄清相关的常见误区\n- 补充正确的完整表述（对于错误陈述）\n\n## 输出格式（严格要求）\n\n**🎯 最终目标格式（Tuanki插件规范）**：\n你生成的JSON将被自动转换为以下Markdown格式保存到插件中：\n\n【Markdown示例】\nFSRS算法相比SM-2算法引入了个性化参数优化，能够根据用户的实际学习数据调整算法参数。\n\n---div---\n\n✅ **正确**。FSRS算法的主要改进就是引入了基于机器学习的个性化参数优化，这使得它能够根据每个用户的具体学习模式动态调整，提供更精准的复习时间预测。\n\n**📦 你需要输出的JSON格式**：\n\n【JSON示例】\n{\n  "questions": [\n    {\n      "statement": "FSRS算法相比SM-2算法引入了个性化参数优化，能够根据用户的实际学习数据调整算法参数。",\n      "answer": true,\n      "explanation": "✅ **正确**。FSRS算法的主要改进就是引入了基于机器学习的个性化参数优化，这使得它能够根据每个用户的具体学习模式动态调整，提供更精准的复习时间预测。"\n    }\n  ]\n}\n\n**🔄 JSON到Markdown的转换规则**：\n- statement → 陈述内容（作为正面）\n- ---div--- → 自动添加分隔符\n- explanation → 分隔符后的解析内容（作为背面）\n\n**📝 格式要求**：\n- answer 使用布尔值：true 表示正确，false 表示错误\n- 陈述应当清晰明确，15-50字\n- 解析建议包含"✅ **正确**"或"❌ **错误**"标识',userPromptTemplate:'请基于以下学习材料生成 {{数量}} 道判断题（难度：{{难度}}）。\n\n## 学习材料\n**问题/概念**：{{cardFront}}\n\n**答案/解析**：{{cardBack}}\n\n**知识标签**：{{tags}}\n\n## 生成要求\n1. **陈述设计**：\n   - 语句完整、逻辑清晰、无歧义\n   - 长度控制在15-50字\n   - 避免双重否定或过于复杂的句式\n2. **真假比例**：尽量保持正确和错误陈述的平衡（不要全是错误或全是正确）\n3. **错误陈述设计**：基于常见误区，有明确的错误点，避免"猜题"式陈述\n4. **解析要求**：\n   - 正确陈述：解释为什么正确，引用知识点依据（30字以上）\n   - 错误陈述：指出错在哪里，并提供正确表述（40字以上）\n5. **辨析价值**：每道题都应有教育意义，帮助澄清概念\n\n请严格按照JSON格式输出。',testConfig:{defaultCount:5,questionType:"judge",difficultyLevel:"easy",targetDeckStrategy:"auto"},category:"official",enabled:!0,createdAt:(new Date).toISOString()}];const up=new class{constructor(){oe(this,"plugin",null),oe(this,"store",Fr(this.getInitialState())),oe(this,"saveDebounceTimer",null),oe(this,"SAVE_DEBOUNCE_MS",1e3),oe(this,"subscribe",this.store.subscribe)}initialize(e){this.plugin=e,this.loadFromPlugin(),_e.info("[AIConfigStore] Store已初始化")}getInitialState(){return{customFormatActions:[],customTestGenActions:[],customSplitActions:[],defaultProvider:"zhipu",apiKeys:{},lastModified:Date.now(),version:0}}loadFromPlugin(){var e,t,n;if(!this.plugin)return void _e.warn("[AIConfigStore] Plugin未初始化，跳过加载");const i=this.plugin.settings.aiConfig;if(i){try{this.store.set({customFormatActions:structuredClone(i.customFormatActions||[]),customTestGenActions:structuredClone(i.customTestGenActions||[]),customSplitActions:structuredClone(i.customSplitActions||[]),defaultProvider:i.defaultProvider||"zhipu",apiKeys:structuredClone(i.apiKeys||{}),lastModified:Date.now(),version:0})}catch(a){_e.warn("[AIConfigStore] 加载时structuredClone失败，使用JSON fallback:",a),this.store.set({customFormatActions:JSON.parse(JSON.stringify(i.customFormatActions||[])),customTestGenActions:JSON.parse(JSON.stringify(i.customTestGenActions||[])),customSplitActions:JSON.parse(JSON.stringify(i.customSplitActions||[])),defaultProvider:i.defaultProvider||"zhipu",apiKeys:JSON.parse(JSON.stringify(i.apiKeys||{})),lastModified:Date.now(),version:0})}_e.info("[AIConfigStore] 配置已从plugin加载",{formatActions:(null==(e=i.customFormatActions)?void 0:e.length)||0,testGenActions:(null==(t=i.customTestGenActions)?void 0:t.length)||0,splitActions:(null==(n=i.customSplitActions)?void 0:n.length)||0})}else _e.warn("[AIConfigStore] aiConfig不存在，使用默认值")}getState(){return jr(this.store)}updateFormatActions(e){this.store.update(t=>({...t,customFormatActions:this.validateAndClone(e,"format"),lastModified:Date.now(),version:t.version+1})),this.scheduleSave(),_e.debug("[AIConfigStore] 格式化功能已更新",{count:e.length})}updateTestGenActions(e){this.store.update(t=>({...t,customTestGenActions:this.validateAndClone(e,"test-generator"),lastModified:Date.now(),version:t.version+1})),this.scheduleSave(),_e.debug("[AIConfigStore] 测试题功能已更新",{count:e.length})}updateSplitActions(e){this.store.update(t=>({...t,customSplitActions:this.validateAndClone(e,"split"),lastModified:Date.now(),version:t.version+1})),this.scheduleSave(),_e.debug("[AIConfigStore] 拆分功能已更新",{count:e.length})}updateAllActions(e,t,n){this.store.update(i=>({...i,customFormatActions:this.validateAndClone(e,"format"),customTestGenActions:this.validateAndClone(t,"test-generator"),customSplitActions:this.validateAndClone(n,"split"),lastModified:Date.now(),version:i.version+1})),this.scheduleSave(),_e.debug("[AIConfigStore] 所有功能已批量更新")}validateAndClone(e,t){return e.filter(e=>"custom"===e.category&&e.type===t).filter(e=>this.isValidAction(e,t)).map(e=>this.deepCloneAction(e))}isValidAction(e,t){return e.id&&e.name&&e.systemPrompt?"test-generator"!==t||e.testConfig?!("split"===t&&!e.splitConfig)||(_e.warn("[AIConfigStore] 拆分功能缺少splitConfig:",e.id),!1):(_e.warn("[AIConfigStore] 测试题功能缺少testConfig:",e.id),!1):(_e.warn("[AIConfigStore] 无效的action（缺少基础字段）:",{id:e.id,name:e.name,hasSystemPrompt:!!e.systemPrompt}),!1)}deepCloneAction(e){try{return{...structuredClone(e),provider:e.provider,model:e.model,testConfig:e.testConfig,splitConfig:e.splitConfig}}catch(t){_e.warn("[AIConfigStore] structuredClone失败，使用JSON fallback:",t);return{...JSON.parse(JSON.stringify(e)),id:e.id,name:e.name,type:e.type,category:e.category,systemPrompt:e.systemPrompt,userPromptTemplate:e.userPromptTemplate,provider:e.provider,model:e.model,testConfig:e.testConfig,splitConfig:e.splitConfig,description:e.description,icon:e.icon,enabled:e.enabled,createdAt:e.createdAt,updatedAt:e.updatedAt}}}scheduleSave(){this.saveDebounceTimer&&clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=setTimeout(()=>{this.saveToPlugin()},this.SAVE_DEBOUNCE_MS)}async saveToPlugin(){if(!this.plugin)return void _e.error("[AIConfigStore] Plugin未初始化，无法保存");const e=this.getState();this.plugin.settings.aiConfig||(this.plugin.settings.aiConfig={apiKeys:{},defaultProvider:"zhipu",customFormatActions:[],customTestGenActions:[],customSplitActions:[],officialFormatActions:{choice:{enabled:!0},mathFormula:{enabled:!0},memoryAid:{enabled:!0}}}),this.plugin.settings.aiConfig||(this.plugin.settings.aiConfig={});try{this.plugin.settings.aiConfig.customFormatActions=structuredClone(e.customFormatActions),this.plugin.settings.aiConfig.customTestGenActions=structuredClone(e.customTestGenActions),this.plugin.settings.aiConfig.customSplitActions=structuredClone(e.customSplitActions)}catch(t){_e.warn("[AIConfigStore] 保存时structuredClone失败，使用JSON fallback:",t),this.plugin.settings.aiConfig.customFormatActions=JSON.parse(JSON.stringify(e.customFormatActions)),this.plugin.settings.aiConfig.customTestGenActions=JSON.parse(JSON.stringify(e.customTestGenActions)),this.plugin.settings.aiConfig.customSplitActions=JSON.parse(JSON.stringify(e.customSplitActions))}try{await this.plugin.saveSettings(),_e.info("[AIConfigStore] 配置已保存到磁盘",{version:e.version,formatActions:e.customFormatActions.length,testGenActions:e.customTestGenActions.length,splitActions:e.customSplitActions.length})}catch(t){throw _e.error("[AIConfigStore] 保存失败:",t),t}}async forceSave(){this.saveDebounceTimer&&(clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=null),await this.saveToPlugin()}destroy(){this.saveDebounceTimer&&(clearTimeout(this.saveDebounceTimer),this.saveDebounceTimer=null)}},hp=Br(up,e=>[...cp.map(e=>({...e,type:"format",category:"official"})),...e.customFormatActions.map(e=>({...e,type:"format",category:"custom"}))]),pp=Br(up,e=>[...dp.map(e=>({...e,type:"test-generator",category:"official"})),...e.customTestGenActions.map(e=>({...e,type:"test-generator",category:"custom"}))]),gp=Br(up,e=>[...lp.map(e=>({...e,type:"split",category:"official"})),...e.customSplitActions.map(e=>({...e,type:"split",category:"custom"}))]),vp=Br(up,e=>({format:e.customFormatActions.filter(e=>!1!==e.enabled),testGen:e.customTestGenActions.filter(e=>!1!==e.enabled),split:e.customSplitActions.filter(e=>!1!==e.enabled)}));class fp{constructor(e,t){oe(this,"vault"),oe(this,"metadataCache"),this.vault=e,this.metadataCache=t}getAllFolders(){const e=[],t=this.vault.getRoot(),n=(t,i=0)=>{"/"!==t.path&&e.push({path:t.path||".",name:t.name||"根目录",level:i,childCount:t.children.length});for(const e of t.children)e instanceof ge.TFolder&&n(e,i+1)};return n(t),e.sort((e,t)=>e.path.localeCompare(t.path))}async getFilesInScope(e){const t=this.vault.getMarkdownFiles(),n=[];for(const i of t)await this.shouldIncludeFile(i,e)&&n.push(i);return n}async shouldIncludeFile(e,t){const n=e.path;return!this.isInExcludedFolders(n,t.excludeFolders)&&!!this.isInIncludedFolders(n,t.includeFolders,t.recursive)}isInExcludedFolders(e,t){if(0===t.length)return!1;for(const n of t){const t=this.normalizePath(n);if(e.startsWith(t))return!0}return!1}isInIncludedFolders(e,t,n){if(0===t.length)return!0;for(const i of t){const t=this.normalizePath(i);if(n){if(e.startsWith(t))return!0}else{if(this.getParentFolder(e)===t)return!0}}return!1}normalizePath(e){if(!e||"."===e)return"";let t=e.replace(/^\/+/,"");return t.endsWith("/")||(t+="/"),t}getParentFolder(e){const t=e.lastIndexOf("/");return-1===t?"":`${e.substring(0,t)}/`}async getScanStats(e){const t=this.vault.getMarkdownFiles(),n={totalFiles:t.length,includedFiles:0,excludedFiles:0,markedFiles:0};for(const i of t){await this.shouldIncludeFile(i,e)?n.includedFiles++:n.excludedFiles++}return n}isFolderExists(e){const t="."===e?"":e,n=this.vault.getAbstractFileByPath(t);return null!==n&&n instanceof ge.TFolder}getSubFolders(e){const t="."===e?"":e,n=this.vault.getAbstractFileByPath(t);if(!(n&&n instanceof ge.TFolder))return[];const i=[],a=e.split("/").filter(e=>e).length;for(const r of n.children)r instanceof ge.TFolder&&i.push({path:r.path,name:r.name,level:a+1,childCount:r.children.length});return i.sort((e,t)=>e.name.localeCompare(t.name))}}class mp{constructor(e,t){oe(this,"config"),oe(this,"deckStorage"),oe(this,"deckCache",new Map),oe(this,"mappingCache",new Map),this.config=e,this.deckStorage=t}async resolveDeckForFile(e){const t=this.mappingCache.get(e.path);if(t)return t;let n;if(!this.config.enabled)return n=await this.getDefaultDeck(),this.mappingCache.set(e.path,n),n;const i=this.findMatchingRule(e.path);return n=i?await this.applyRule(e,i):await this.getDefaultDeck(),this.mappingCache.set(e.path,n),n}findMatchingRule(e){const t=this.getFileFolder(e);for(const n of this.config.rules)if(this.isRuleMatch(t,n))return n;return null}isRuleMatch(e,t){const n=this.normalizePath(t.folderPath),i=this.normalizePath(e);return t.includeSubfolders?i.startsWith(n):i===n}async applyRule(e,t){if(t.targetDeckId){const e=await this.getDeck(t.targetDeckId);if(e)return{deckId:e.id,deckName:e.name,isNewDeck:!1,ruleUsed:t}}const n=this.generateDeckName(e,t);let i=await this.deckStorage.getDeckByName(n),a=!1;return!i&&t.autoCreate&&(i=await this.deckStorage.createDeck(n,`由文件夹 ${t.folderPath} 自动创建`),a=!0,this.deckCache.set(i.id,i)),i?{deckId:i.id,deckName:i.name,isNewDeck:a,ruleUsed:t}:await this.getDefaultDeck()}generateDeckName(e,t){let n;switch(t.namingStrategy){case"custom":n=t.customName||this.getFolderName(t.folderPath);break;case"folder-name":default:n=this.getFolderName(t.folderPath);break;case"path-based":n=this.generatePathBasedName(e,t)}return`${this.config.deckNamePrefix||""}${n}${this.config.deckNameSuffix||""}`}generatePathBasedName(e,t){const n=this.getFileFolder(e.path),i=this.normalizePath(t.folderPath);if(n===i)return this.getFolderName(t.folderPath);if("hierarchy"===t.subfolderStrategy){return n.substring(i.length).split("/").filter(e=>e).join(this.config.hierarchySeparator)}return"separate-decks"===t.subfolderStrategy?this.getFolderName(n):this.getFolderName(t.folderPath)}async getDefaultDeck(){if(this.config.defaultDeckId){const e=await this.getDeck(this.config.defaultDeckId);if(e)return{deckId:e.id,deckName:e.name,isNewDeck:!1}}const e=await this.deckStorage.getDecks();if(e.length>0){const t=e[0];return{deckId:t.id,deckName:t.name,isNewDeck:!1}}const t=await this.deckStorage.createDeck("默认牌组","批量解析默认牌组");return this.deckCache.set(t.id,t),{deckId:t.id,deckName:t.name,isNewDeck:!0}}async getDeck(e){if(this.deckCache.has(e))return this.deckCache.get(e);const t=await this.deckStorage.getDeckById(e);return t&&this.deckCache.set(e,t),t}getFileFolder(e){const t=e.lastIndexOf("/");return-1===t?"":e.substring(0,t)}getFolderName(e){if(!e||"."===e||"/"===e)return"根目录";const t=e.replace(/\/+$/,""),n=t.lastIndexOf("/");return-1===n?t:t.substring(n+1)}normalizePath(e){if(!e||"."===e||"/"===e)return"";return e.replace(/^\/+/,"").replace(/\/+$/,"")}updateConfig(e){this.config={...this.config,...e},this.clearCache()}clearCache(){this.mappingCache.clear(),this.deckCache.clear()}addRule(e){this.config.rules.push(e),this.clearCache()}removeRule(e){this.config.rules=this.config.rules.filter(t=>t.folderPath!==e),this.clearCache()}getRules(){return[...this.config.rules]}async resolveDeckForFiles(e){const t=new Map;for(const n of e){const e=await this.resolveDeckForFile(n);t.set(n.path,e)}return t}}class yp{constructor(e,t,n){oe(this,"config"),oe(this,"vault"),oe(this,"storage"),oe(this,"uuidPattern"),this.config=e,this.vault=t,this.storage=n,this.uuidPattern=this.buildUUIDPattern()}generateUUID(){return Vu()}generateBlockID(){return Hu()}async insertBlockID(e,t,n){const i=n||this.generateBlockID(),a=` ^${i}`;return{success:!0,blockId:i,updatedContent:e.substring(0,t)+a+e.substring(t)}}async insertUUIDAndBlockID(e,t,n,i){if(!this.config.enabled)return{success:!1,uuid:"",blockId:"",updatedContent:e,insertedAt:-1,error:"UUID功能未启用"};const a=this.generateUUID(),r=this.generateBlockID(),s=`${this.formatUUIDMarker(a)} ^${r}`;let o,l;switch(this.config.insertPosition){case"before-card":case"in-metadata":default:o=t,l=`${e.substring(0,o)+s}\n${e.substring(o)}`;break;case"after-card":o=n,l=`${e.substring(0,o)}\n${s}${e.substring(o)}`}return{success:!0,uuid:a,blockId:r,updatedContent:l,insertedAt:o}}async insertUUID(e,t,n,i){if(!this.config.enabled)return{success:!1,uuid:"",updatedContent:e,insertedAt:-1,error:"UUID功能未启用"};const a=this.generateUUID(),r=this.formatUUIDMarker(a);let s,o;switch(this.config.insertPosition){case"before-card":case"in-metadata":default:s=t,o=`${e.substring(0,s)+r}\n${e.substring(s)}`;break;case"after-card":s=n,o=`${e.substring(0,s)}\n${r}${e.substring(s)}`}return{success:!0,uuid:a,updatedContent:o,insertedAt:s}}async detectUUID(e,t,n){if(!this.config.enabled)return{found:!1,isDuplicate:!1};const i=e.substring(t,n),a=this.uuidPattern.exec(i);if(!a)return{found:!1,isDuplicate:!1};const r=a[1],s=this.getLineNumber(e,t+a.index),o=await this.storage.uuidExists(r);let l;if(o){const e=await this.storage.getRecordByUUID(r);l=null==e?void 0:e.cardId}return{found:!0,uuid:r,lineNumber:s,cardId:l,isDuplicate:o}}async handleDuplicate(e,t){switch(this.config.duplicateStrategy){case"skip":return Ce("UUIDManager",`跳过重复UUID: ${e} in ${t.path}`),"skip";case"update":return Ce("UUIDManager",`更新重复UUID: ${e} in ${t.path}`),"update";case"create-new":return Ce("UUIDManager",`为重复UUID创建新卡片: ${e} in ${t.path}`),"create-new";default:return"skip"}}async saveRecord(e,t,n,i){const a={uuid:e,cardId:t,sourceFile:n.path,lineNumber:i,createdAt:new Date,updatedAt:new Date};await this.storage.saveRecord(a)}async processFileUUIDs(e,t){let n=await this.vault.read(e);const i=new Map,a=[],r=t.sort((e,t)=>t.startIndex-e.startIndex);for(const s of r){const t=await this.detectUUID(n,s.startIndex,s.endIndex);if(t.found&&t.uuid)i.set(s.startIndex,t.uuid),t.isDuplicate&&a.push(t.uuid);else{const t=await this.insertUUID(n,s.startIndex,s.endIndex,e);t.success&&(n=t.updatedContent,i.set(s.startIndex,t.uuid))}}return{updatedContent:n,uuidMap:i,duplicates:a}}formatUUIDMarker(e){const t=`${this.config.prefix}${e}`;switch(this.config.format){case"comment":default:return`\x3c!-- ${t} --\x3e`;case"frontmatter":return`uuid: ${t}`;case"inline-code":return`\`${t}\``}}buildUUIDPattern(){const e=this.config.prefix.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),t="(?:tk-[23456789abcdefghjkmnpqrstuvwxyz]{12}|[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})";switch(this.config.format){case"comment":default:return new RegExp(`\x3c!--\\s*(?:${e})?(${t})\\s*--\x3e`,"i");case"frontmatter":return new RegExp(`uuid:\\s*(?:${e})?(${t})`,"i");case"inline-code":return new RegExp(`\`(?:${e})?(${t})\``,"i")}}getLineNumber(e,t){return e.substring(0,t).split("\n").length}updateConfig(e){this.config={...this.config,...e},this.uuidPattern=this.buildUUIDPattern()}async hasUUID(e){try{return await this.storage.uuidExists(e)}catch(t){return _e.error("[UUIDManager] 检查UUID存在性失败:",t),!1}}async getRecordByUUID(e){try{return await this.storage.getRecordByUUID(e)}catch(t){return _e.error("[UUIDManager] 获取UUID记录失败:",t),null}}async detectUUIDWithValidation(e){const t=e.match(/<!--\s*(tk-[23456789abcdefghjkmnpqrstuvwxyz]{12})\s*-->/i);if(t){const e=t[1];try{return await this.storage.uuidExists(e)?(Ce("UUIDManager",`UUID验证通过: ${e}`),e):(_e.warn(`[UUIDManager] UUID格式正确但数据库中不存在: ${e}`),e)}catch(i){return _e.error("[UUIDManager] 数据库验证失败:",i),e}}const n=e.match(/<!--\s*([0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})\s*-->/i);if(n){const e=n[1];return Ce("UUIDManager",`检测到旧格式UUID: ${e}`),e}return null}async batchCheckUUIDs(e){const t=new Map;if(0===e.length)return t;Ce("UUIDManager",`批量检查 ${e.length} 个UUID...`);try{const n=await Promise.all(e.map(async e=>({uuid:e,exists:await this.storage.uuidExists(e)})));for(const{uuid:e,exists:a}of n)t.set(e,a);const i=Array.from(t.values()).filter(Boolean).length;Ce("UUIDManager",`批量检查完成: ${i}/${e.length} 个UUID已存在`)}catch(n){_e.error("[UUIDManager] 批量检查失败:",n);for(const i of e)t.set(i,!1)}return t}async cleanupFileRecords(e){const t=await this.storage.getFileUUIDs(e.path);for(const n of t)await this.storage.deleteRecord(n.uuid)}isValidUUID(e){return qu(e)}isValidBlockID(e){return Wu(e)}extractUUID(e){const t=this.uuidPattern.exec(e);return t?t[1]:null}}class bp{constructor(e,t){oe(this,"dataStorage"),oe(this,"plugin"),this.dataStorage=e,this.plugin=t}getDirectFileReader(){var e;return null==(e=this.plugin)?void 0:e.directFileReader}async smartSync(e,t,n){Ce("ThreeWayMerge",`开始同步卡片: ${t.substring(0,8)}...`);const i=this.getDirectFileReader();if(!i)return _e.warn("[ThreeWayMergeEngine] ⚠️ DirectFileReader未初始化，无法查询现有卡片"),Ce("ThreeWayMerge","DirectFileReader不可用，默认为新卡片"),await this.createNewCard(e,t,n);const a=await i.getCardByUUID(t);if(!a)return Ce("ThreeWayMerge","UUID不存在，创建新卡片"),await this.createNewCard(e,t,n);Ce("ThreeWayMerge",`找到现有卡片: ${a.id}`);const r=await this.checkNeedsUpdate(e,a);switch(r.action){case"skip":return Ce("ThreeWayMerge",`跳过：${r.reason}`),{action:"skipped",cardId:a.id,uuid:t,reason:r.reason};case"update-from-source":return Ce("ThreeWayMerge",`更新：${r.reason}`),await this.updateExistingCard(a,e,n);case"keep-database":return Ce("ThreeWayMerge",`保留数据库：${r.reason}`),{action:"kept",cardId:a.id,uuid:t,reason:r.reason};case"conflict":{Ce("ThreeWayMerge","检测到冲突！");const n=await this.detectConflict(e,a);return{action:"conflict",cardId:a.id,uuid:t,conflict:n}}default:return{action:"skipped",reason:"unknown-decision"}}}async checkNeedsUpdate(e,t){const n=t.content||"",i=t.lastScannedContent||"";Ce("ThreeWayMerge","三方对比",{sourceLength:e.length,dbLength:n.length,snapshotLength:i.length});const a=e!==i,r=n!==i;return Ce("ThreeWayMerge","变化检测",{sourceChanged:a,dbChanged:r}),a||r?a&&!r?{action:"update-from-source",reason:"source-modified-only"}:!a&&r?{action:"keep-database",reason:"tuanki-modified-only"}:a&&r?{action:"conflict",reason:"both-modified"}:{action:"skip",reason:"unknown-state"}:{action:"skip",reason:"no-changes"}}async detectConflict(e,t){const n=t.content||"",i=t.lastScannedContent||"";return{type:"both-modified",sourceContent:e,dbContent:n,lastScanned:i,sourceChanges:this.calculateDiff(i,e),dbChanges:this.calculateDiff(i,n),uuid:t.uuid,cardId:t.uuid}}calculateDiff(e,t){const n=e.length,i=t.length-n;return i>0?`+${i} 字符`:i<0?`${i} 字符`:"内容重新组织"}async createNewCard(e,t,n){try{return{action:"created",uuid:t,reason:"new-card"}}catch(i){throw _e.error("[ThreeWayMerge] 创建卡片失败:",i),i}}async updateExistingCard(e,t,n){try{const i=e.content,a=e.deckId;e.content=t,e.modified=(new Date).toISOString(),e.lastScannedContent=t,e.lastScannedAt=(new Date).toISOString(),e.isBatchScanned=!0,e.modifiedInTuanki=!1;let r=!1;return a!==n&&(e.deckId=n,r=!0),await this.dataStorage.updateCard(e),{action:"updated",cardId:e.uuid,uuid:e.uuid,changes:{contentChanged:i!==t,deckChanged:r}}}catch(i){throw _e.error("[ThreeWayMerge] 更新卡片失败:",i),i}}async resolveConflict(e,t,n){if(Ce("ThreeWayMerge",`解决冲突: ${t}`),"use-source"===t){const t=e.content;return e.content=n,e.modified=(new Date).toISOString(),e.lastScannedContent=n,e.lastScannedAt=(new Date).toISOString(),e.modifiedInTuanki=!1,await this.dataStorage.updateCard(e),{action:"updated",cardId:e.uuid,uuid:e.uuid,reason:"conflict-resolved-use-source",changes:{contentChanged:t!==n}}}return e.lastScannedContent=e.content,e.lastScannedAt=(new Date).toISOString(),e.modifiedInTuanki=!0,await this.dataStorage.updateCard(e),{action:"kept",cardId:e.uuid,uuid:e.uuid,reason:"conflict-resolved-keep-tuanki"}}async findCardByUUID(e){if(!this.dataStorage)return null;try{return(await this.dataStorage.getAllCards()).find(t=>t.uuid===e)||null}catch(t){return _e.error("[ThreeWayMergeEngine] 查找卡片失败:",t),null}}}async function wp(e,t,n,i,a){const r=[];if(e.length!==t.length)return{duplicates:r,contentUpdated:!1,updatedContent:n};const s=[];for(let o=e.length-1;o>=0;o--){const n=e[o],r=t[o],l=a(r.rawContent);if(l)n.metadata||(n.metadata={}),n.metadata.uuid=l;else{const e=i.generateUUID(),t=i.generateBlockID(),a=`\x3c!-- ${e} --\x3e ^${t}`;s.push({lineNumber:r.endLine,content:a,cardIndex:o}),n.metadata||(n.metadata={}),n.metadata.uuid=e,n.metadata.blockId=t}}if(s.length>0){Ce("processUUIDs",`准备插入UUID，共 ${s.length} 个`),Ce("processUUIDs",`插入计划（排序前）: ${s.map(e=>`行${e.lineNumber}`).join(", ")}`);const e=n.split("\n");s.sort((e,t)=>t.lineNumber-e.lineNumber),Ce("processUUIDs",`插入顺序（排序后）: ${s.map(e=>`行${e.lineNumber}`).join(", ")}`);for(const n of s)Ce("processUUIDs",`在第 ${n.lineNumber} 行插入: ${n.content}`),e.splice(n.lineNumber,0,n.content);const t=e.join("\n");let i=!0;for(const n of s)t.includes(n.content)||(_e.error(`[processUUIDs] 验证失败：未找到插入的内容: ${n.content}`),i=!1);return i&&Ce("processUUIDs","所有UUID插入验证通过"),{duplicates:r,contentUpdated:!0,updatedContent:t}}return{duplicates:r,contentUpdated:!1,updatedContent:n}}const kp="tuanki-uuid";class Sp{constructor(e){this.app=e}async parseFrontmatter(e){try{const t=await this.app.vault.read(e);return this.parseFrontmatterFromContent(t)}catch(t){return _e.error("[FrontmatterManager] 解析frontmatter失败:",t),{}}}parseFrontmatterFromContent(e){const t=e.match(/^---[\r\n]+([\s\S]*?)[\r\n]+---/);if(!t)return{};const n=t[1];return this.parseYAML(n)}parseYAML(e){const t={},n=e.split(/\r?\n/);for(const i of n){const e=i.trim();if(!e||e.startsWith("#"))continue;const n=e.indexOf(":");if(-1===n)continue;const a=e.substring(0,n).trim();let r=e.substring(n+1).trim();(r.startsWith('"')&&r.endsWith('"')||r.startsWith("'")&&r.endsWith("'"))&&(r=r.substring(1,r.length-1),r=r.replace(/\\"/g,'"').replace(/\\'/g,"'"));r.includes("-")||r.length>15?t[a]=r:"true"===r?t[a]=!0:"false"===r?t[a]=!1:Number.isNaN(Number(r))||""===r||r.includes(" ")?t[a]=r:t[a]=Number(r)}return t}stringifyYAML(e){const t=[];for(const[n,i]of Object.entries(e)){let e;e="string"==typeof i?i.includes(":")||i.includes("#")||i.includes("\n")?`"${i.replace(/"/g,'\\"')}"`:i:"boolean"==typeof i?i?"true":"false":"number"==typeof i?String(i):Array.isArray(i)?`\n  - ${i.join("\n  - ")}`:"object"==typeof i&&null!==i?JSON.stringify(i):String(i),t.push(`${n}: ${e}`)}return t.join("\n")}async updateFrontmatter(e,t){try{const n=await this.app.vault.read(e),i=this.updateFrontmatterInContent(n,t);await this.app.vault.modify(e,i)}catch(n){throw _e.error("[FrontmatterManager] 更新frontmatter失败:",n),n}}updateFrontmatterInContent(e,t){const n={...this.parseFrontmatterFromContent(e),...t},i=`---\n${this.stringifyYAML(n)}\n---`;if(e.match(/^---[\r\n]/)){const t=/^---[\r\n]+([\s\S]*?)[\r\n]+---/;return t.test(e)?e.replace(t,i):e.replace(/^---[\r\n][\s\S]*?[\r\n]+---/,i)}return`${i}\n\n${e}`}async getUUID(e){return(await this.parseFrontmatter(e))[kp]||null}async setUUID(e,t){await this.updateFrontmatter(e,{[kp]:t});const n=await this.getUUID(e);n!==t&&_e.error(`[FrontmatterManager] UUID 写入验证失败，期望: ${t.substring(0,8)}...，实际: ${n?`${n.substring(0,8)}...`:"null"}`)}async batchUpdate(e,t){await this.updateFrontmatter(e,t)}async removeField(e,t){try{const n=await this.app.vault.read(e),i=this.parseFrontmatterFromContent(n);delete i[t];const a=this.updateFrontmatterInContent(n,i);await this.app.vault.modify(e,a)}catch(n){throw _e.error("[FrontmatterManager] 移除字段失败:",n),n}}async hasFrontmatter(e){try{return(await this.app.vault.read(e)).startsWith("---\n")}catch(t){return!1}}extractBodyContent(e){if(!e.startsWith("---\n"))return e;const t=e.match(/^---\n[\s\S]*?\n---\n*/);return t?e.substring(t[0].length):e}combineContent(e,t){if(0===Object.keys(e).length)return t;return`---\n${this.stringifyYAML(e)}\n---\n\n${t}`}}class xp{constructor(e){oe(this,"frontmatterManager"),this.app=e,this.frontmatterManager=new Sp(e)}async parseFile(e,t,n){try{const i=await this.app.vault.read(e),a=this.frontmatterManager.parseFrontmatterFromContent(i),r=this.extractTags(a,i),s=["#we_已删除","#we_deleted",...t.excludeTags||[]];if(this.shouldSkipByTags(r,s)){const e=s.map(e=>e.startsWith("#")?e.substring(1):e);return{success:!1,shouldSkip:!0,skipReason:`包含排除标签: ${e.filter(e=>r.some(t=>t.toLowerCase()===e.toLowerCase())).map(e=>"#"+e).join(", ")}`}}let o=a["tuanki-uuid"];const l=!o;l&&(o=Vu());const c=this.frontmatterManager.extractBodyContent(i);let d="",u="";if("front-back-split"===t.contentStructure){const e=this.splitFrontBack(c,t.frontBackSeparator);d=e.front,u=e.back}else d=c.trim(),u="";return{success:!0,card:{type:"qa",front:d,back:u,tags:r,metadata:{sourceFile:e.path,sourceBlock:void 0,targetDeckId:n,uuid:o,isNewCard:l,fileMtime:e.stat.mtime,parseMode:"single-card"}}}}catch(i){return _e.error("[SingleCardParser] 解析文件失败:",i),{success:!1,error:i instanceof Error?i.message:String(i)}}}splitFrontBack(e,t){const n=e.split(t);return n.length>=2?{front:n[0].trim(),back:n.slice(1).join(t).trim()}:{front:e.trim(),back:""}}extractTags(e,t){const n=new Set;e.tags&&("string"==typeof e.tags?n.add(e.tags):Array.isArray(e.tags)&&e.tags.forEach(e=>n.add(e)));const i=/#([^\s#]+)/g;let a;for(;null!==(a=i.exec(t));)n.add(a[1]);return Array.from(n)}shouldSkipByTags(e,t){if(!t||0===t.length)return!1;if(!e||0===e.length)return!1;return t.map(e=>e.startsWith("#")?e.substring(1):e).some(t=>e.some(e=>e.toLowerCase()===t.toLowerCase()))}async parseFiles(e,t,n){const i=[];for(const a of e){const e=await this.parseFile(a,t,n);i.push(e)}return i}async getFileUUID(e){return await this.frontmatterManager.getUUID(e)}async setFileUUID(e,t){await this.frontmatterManager.setUUID(e,t)}}class _p{constructor(e,t){this.dataStorage=e,this.plugin=t}async decideSyncAction(e){var t,n;try{const i=null==(t=e.metadata)?void 0:t.uuid;if(!i)return _e.error("[SingleCardSyncEngine] 卡片缺少 UUID，无法决策"),{action:"skip",reason:"卡片缺少 UUID"};const a=await this.findCardByUUID(i);if(!a)return{action:"create",reason:"数据库中不存在此卡片",card:e};const r=null==(n=e.metadata)?void 0:n.fileMtime,s=a.modified?new Date(a.modified).getTime():0;return r?r>s?{action:"update",reason:`文件修改时间 (${new Date(r).toISOString()}) 晚于数据库 (${new Date(s).toISOString()})`,card:e,existingCard:a}:{action:"skip",reason:`文件修改时间 (${new Date(r).toISOString()}) 早于或等于数据库 (${new Date(s).toISOString()})，保护插件内编辑`,existingCard:a}:(_e.warn("[SingleCardSyncEngine] 卡片缺少文件 mtime，跳过同步"),{action:"skip",reason:"卡片缺少文件修改时间",existingCard:a})}catch(i){return _e.error("[SingleCardSyncEngine] 决策同步动作失败:",i),{action:"skip",reason:`决策失败: ${i instanceof Error?i.message:String(i)}`}}}getDirectFileReader(){var e;return null==(e=this.plugin)?void 0:e.directFileReader}async findCardByUUID(e){try{const t=this.getDirectFileReader();return t?await t.getCardByUUID(e):(_e.warn("[SingleCardSyncEngine] ⚠️ DirectFileReader未初始化，无法查找卡片"),null)}catch(t){return _e.error("[SingleCardSyncEngine] 查找卡片失败:",t),null}}async decideSyncActions(e){const t=[];for(const n of e){const e=await this.decideSyncAction(n);t.push(e)}return t}getSyncStatistics(e){return{createCount:e.filter(e=>"create"===e.action).length,updateCount:e.filter(e=>"update"===e.action).length,skipCount:e.filter(e=>"skip"===e.action).length}}filterCardsToProcess(e){return e.filter(e=>"skip"!==e.action&&e.card).map(e=>e.card)}async forceSync(e){var t;try{const n=null==(t=e.metadata)?void 0:t.uuid;if(!n)return{action:"skip",reason:"卡片缺少 UUID"};const i=await this.findCardByUUID(n);return i?{action:"update",reason:"强制同步：覆盖现有卡片",card:e,existingCard:i}:{action:"create",reason:"强制同步：新卡片",card:e}}catch(n){return _e.error("[SingleCardSyncEngine] 强制同步失败:",n),{action:"skip",reason:`强制同步失败: ${n instanceof Error?n.message:String(n)}`}}}}class Cp{constructor(e,t){oe(this,"frontmatterManager"),oe(this,"plugin"),this.app=e,this.frontmatterManager=new Sp(e),this.plugin=t}async parseFile(e,t,n){var i,a,r,s;const o={success:!0,cards:[],errors:[],skippedCount:0,positions:[],originalContent:void 0};try{const l=await this.app.vault.read(e);let c;o.originalContent=l,"frontmatter"===t.uuidLocation&&(c=await this.frontmatterManager.getUUID(e)||void 0);let d=[];if("separator"===t.mode&&t.separatorMode)d=this.parseBySeparator(l,t);else{if("pattern"!==t.mode||!t.patternMode)return o.success=!1,o.errors.push("无效的解析配置：缺少 separatorMode 或 patternMode"),o;d=this.parseByPattern(l,t)}const u=["#we_已删除","#we_deleted",...(null==(s=null==(r=null==(a=null==(i=this.plugin)?void 0:i.settings)?void 0:a.simplifiedParsing)?void 0:r.batchParsing)?void 0:s.excludeTags)||[]],h=d.filter(e=>{const t=this.shouldSkipByTags(e.tags,u);return t&&o.skippedCount++,!t}),p=[],g=l.split("\n"),v=e=>{let t=0;for(let n=0;n<g.length;n++){const i=g[n].length+1;if(t+i>e)return n;t+=i}return g.length-1};for(let i=0;i<h.length;i++){const a=h[i];let r=a.uuid;r||("frontmatter"===t.uuidLocation&&c&&1===h.length?r=c:t.autoAddUUID&&(r=Vu()));const s={type:"qa",front:a.front.trim(),back:a.back.trim(),tags:a.tags,metadata:{sourceFile:e.path,sourceBlock:void 0,targetDeckId:n,uuid:r,isNewCard:!r,parseMode:"regex",regexConfig:t.name,cardIndex:i}};o.cards.push(s);const d=v(a.startIndex),u=v(a.endIndex),g=a.startIndex,f=a.endIndex,m=l.substring(a.startIndex,a.endIndex);p.push({content:`${a.front}\n---div---\n${a.back}`,startLine:d,endLine:u,startOffset:g,endOffset:f,rawContent:m,index:i})}o.positions=p,Ce("RegexCardParser",`成功解析 ${o.cards.length} 张卡片 (跳过 ${o.skippedCount})`)}catch(l){o.success=!1,o.errors.push(l instanceof Error?l.message:String(l)),_e.error("[RegexCardParser] 解析失败:",l)}return o}parseBySeparator(e,t){const n=[];if(!t.separatorMode)return n;try{const{cardSeparator:i,frontBackSeparator:a,multiline:r}=t.separatorMode,s=new RegExp(i,r?"gm":"g");let o,l=0;const c=[];for(;null!==(o=s.exec(e));)c.push({index:o.index,length:o[0].length}),l=o.index+o[0].length;for(let d=0;d<c.length-1;d++){const i=c[d],r=c[d+1],s=i.index+i.length,o=r.index,l=e.substring(s,o).trim();if(l){const e=this.parseCardBlock(l,a,t);e&&(e.startIndex=s,e.endIndex=o,n.push(e))}}if(c.length>0){const i=c[c.length-1],r=i.index+i.length,s=e.length,o=e.substring(r,s).trim();if(o){const e=this.parseCardBlock(o,a,t);e&&(e.startIndex=r,e.endIndex=s,n.push(e))}}}catch(i){_e.error("[RegexCardParser] 分隔符解析失败:",i)}return n}parseByPattern(e,t){const n=[];if(!t.patternMode)return n;try{const{cardPattern:i,flags:a,captureGroups:r}=t.patternMode,s=new RegExp(i,a);let o;for(;null!==(o=s.exec(e));){const e=o[r.front]||"",i=o[r.back]||"",a=void 0!==r.tags?o[r.tags]:void 0,s=a?this.extractTagsFromString(a):[];let l;"inline"===t.uuidLocation&&t.uuidPattern&&(l=this.extractInlineUUID(o[0],t.uuidPattern)),n.push({front:e.trim(),back:i.trim(),tags:s,uuid:l,startIndex:o.index,endIndex:o.index+o[0].length})}Ce("RegexParser",`正则模式解析完成，匹配到 ${n.length} 张卡片`)}catch(i){_e.error("[RegexCardParser] 正则模式解析失败:",i)}return n}parseCardBlock(e,t,n){try{const i=this.extractTagsFromString(e);let a;"inline"===n.uuidLocation&&n.uuidPattern&&(a=this.extractInlineUUID(e,n.uuidPattern));const r=this.cleanCardContent(e);let s="",o="";if(t){const e=r.split(new RegExp(t,"m"));e.length>=2?(s=e[0].trim(),o=e.slice(1).join("\n").trim()):s=r.trim()}else s=r.trim();return{front:s,back:o,tags:i,uuid:a,startIndex:0,endIndex:e.length}}catch(i){return _e.error("[RegexCardParser] 解析卡片块失败:",i),null}}extractTagsFromString(e){const t=new Set,n=/#([^\s#]+)/g;let i;for(;null!==(i=n.exec(e));)t.add(i[1]);return Array.from(t)}extractInlineUUID(e,t){try{const n=new RegExp(t).exec(e);return(null==n?void 0:n[1])?n[1]:void 0}catch(n){return void _e.error("[RegexCardParser] 提取内联 UUID 失败:",n)}}shouldSkipByTags(e,t){if(!t||0===t.length)return!1;if(!e||0===e.length)return!1;return t.map(e=>e.startsWith("#")?e.substring(1):e).some(t=>e.some(e=>e.toLowerCase()===t.toLowerCase()))}async parseFiles(e,t,n){const i=[];for(const a of e){const e=await this.parseFile(a,t,n);i.push(e)}return i}cleanCardContent(e){let t=e;return t=t.replace(/<!--\s*(?:tk-[23456789abcdefghjkmnpqrstuvwxyz]{12}|[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})\s*-->\s*\^[a-zA-Z0-9\-]+\s*$/gm,""),t=t.replace(/<!--\s*tk-[23456789abcdefghjkmnpqrstuvwxyz]{12}\s*-->/gi,""),t=t.replace(/<!--\s*[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}\s*-->/gi,""),t=t.replace(/\s*\^[a-zA-Z0-9\-]+\s*$/gm,""),t=t.replace(/\n{3,}/g,"\n\n"),t=t.trim(),t}}class Ip{constructor(e,t,n,i,a,r,s,o,l){oe(this,"config"),oe(this,"fileSelector"),oe(this,"deckMapping"),oe(this,"uuidManager"),oe(this,"parser"),oe(this,"mergeEngine"),oe(this,"isRunning",!1),oe(this,"abortController"),oe(this,"app"),oe(this,"singleCardParser"),oe(this,"singleCardSyncEngine"),oe(this,"regexCardParser"),oe(this,"cleanupService"),this.config=e,this.fileSelector=t,this.deckMapping=n,this.uuidManager=i,this.parser=a,this.app=r,this.cleanupService=o,s?(this.mergeEngine=new bp(s,l),this.singleCardParser=new xp(r),this.singleCardSyncEngine=new _p(s,l),this.regexCardParser=new Cp(r,l),Ce("SimpleBatchParsingService","✅ 单文件单卡片解析器和正则解析器已初始化")):(this.mergeEngine=new bp(null,null),_e.error("❌ [SimpleBatchParsingService] dataStorage未提供，单文件单卡片模式和三方合并功能将不可用！"),_e.warn("[SimpleBatchParsingService] 所有文件将回退到兼容模式（旧解析器）"))}async preflightCheck(){const e=[],t=[];if(Ce("SimpleBatchParsingService","开始预检查..."),!this.config.folderDeckMappings||0===this.config.folderDeckMappings.length)return e.push("❌ 未配置任何文件夹/文件到牌组的映射关系"),e.push("💡 请在插件设置 → 分隔符配置 → 文件夹牌组映射 中添加映射"),{valid:!1,errors:e,warnings:t};const n=this.config.folderDeckMappings.filter(e=>e.enabled);if(0===n.length)return e.push("❌ 所有映射都已禁用"),e.push("💡 请至少启用一个映射关系"),{valid:!1,errors:e,warnings:t};Ce("SimpleBatchParsingService",`找到 ${n.length} 个启用的映射`);for(const r of n){const t=r.path||r.folderPath||"",n=r.type||"folder";if(!t){e.push(`❌ 映射 "${r.targetDeckName}" 的路径为空`);continue}this.app.vault.getAbstractFileByPath(t)?Ce("SimpleBatchParsingService",`映射路径有效: ${t} (${n}) → ${r.targetDeckName}`):e.push(`❌ 路径不存在: ${t} (映射到: ${r.targetDeckName})`)}if(e.length>0)return{valid:!1,errors:e,warnings:t};try{const e=await this.scanMappedFolders();if(0===e.length)t.push("⚠️ 未找到任何 Markdown 文件，请检查映射路径是否正确");else{Ce("SimpleBatchParsingService",`找到 ${e.length} 个文件`);const n=await this.findUnmappedFiles(e);n.length>0&&(t.push(`⚠️ 发现 ${n.length} 个文件未配置映射，这些文件将被跳过：`),n.slice(0,5).forEach(e=>t.push(`  - ${e.path}`)),n.length>5&&t.push(`  ... 还有 ${n.length-5} 个文件`))}}catch(a){t.push(`⚠️ 扫描文件时出错: ${a instanceof Error?a.message:"未知错误"}`)}const i={valid:0===e.length,errors:e,warnings:t};return Ce("SimpleBatchParsingService","预检查完成",{valid:i.valid,errorCount:e.length,warningCount:t.length}),i}async findUnmappedFiles(e){const t=[];for(const n of e){this.findMatchingMapping(n.path)||t.push(n)}return t}validateMappingConfiguration(){return this.config.folderDeckMappings&&this.config.folderDeckMappings.length>0&&this.config.folderDeckMappings.some(e=>e.enabled)}async executeBatchParsing(e){var t;if(this.isRunning)throw new Error("批量解析正在运行中");this.isRunning=!0,this.abortController=new AbortController;const n=Date.now(),i=[],a={success:!1,totalCards:0,successfulCards:0,failedCards:[],newDecks:[],duplicateUUIDs:[],newCards:0,updatedCards:0,skippedCards:0,conflictCards:0,conflicts:[],errors:[],stats:{filesProcessed:0,filesWithCards:0,filesSkipped:0,processingTime:0}};try{Ce("SimpleBatchParsingService","执行预检查...");const s=await this.preflightCheck();if(s.warnings.length>0&&(_e.warn("[SimpleBatchParsingService] 预检查警告:"),s.warnings.forEach(e=>_e.warn(e))),!s.valid){_e.error("[SimpleBatchParsingService] 预检查失败:"),s.errors.forEach(e=>_e.error(e));const e=["❌ 批量解析预检查失败","",...s.errors,"",...s.warnings.length>0?["警告:",...s.warnings]:[]].join("\n");return new ge.Notice(e,1e4),a.success=!1,a.errors=s.errors.map(e=>({file:"system",message:e})),this.isRunning=!1,this.abortController=void 0,{parsedCards:[],result:a}}if(Ce("SimpleBatchParsingService","预检查通过，开始解析"),s.warnings.length>0){const e=["⚠️ 预检查警告:",...s.warnings.slice(0,3)].join("\n");new ge.Notice(e,5e3)}const o=await this.scanMappedFolders();if(0===o.length)return new ge.Notice("⚠️ 没有找到符合条件的文件，请检查文件夹映射配置"),a.success=!0,{parsedCards:[],result:a};const l=o.slice(0,this.config.maxFilesPerBatch);o.length>this.config.maxFilesPerBatch&&new ge.Notice(`⚠️ 文件数量超过限制，将只处理前 ${this.config.maxFilesPerBatch} 个文件`,5e3),this.config.showProgressNotice&&new ge.Notice(`🔄 开始批量解析：${l.length} 个文件`);for(let n=0;n<l.length;n++){if(this.abortController.signal.aborted){new ge.Notice("❌ 批量解析已取消");break}const s=l[n],o={totalFiles:l.length,processedFiles:n,currentFile:s.name,successCount:a.successfulCards,errorCount:a.failedCards.length,percentage:Math.round(n/l.length*100)};e&&e(o);try{const e=await this.processFile(s);e.parsedCards.length>0&&i.push(...e.parsedCards),a.totalCards+=e.totalCards,a.successfulCards+=e.successfulCards,a.failedCards.push(...e.failedCards),a.newDecks.push(...e.newDecks),a.duplicateUUIDs.push(...e.duplicateUUIDs),a.newCards+=e.newCards||0,a.updatedCards+=e.updatedCards||0,a.skippedCards+=e.skippedCards||0,a.conflictCards+=e.conflictCards||0,e.conflicts&&e.conflicts.length>0&&(null==(t=a.conflicts)||t.push(...e.conflicts)),a.stats.filesProcessed++,e.totalCards>0&&a.stats.filesWithCards++}catch(r){a.errors.push({file:s.path,message:r instanceof Error?r.message:"未知错误",error:r}),_e.error(`[SimpleBatchParsingService] 处理文件失败: ${s.path}`,r)}}a.stats.processingTime=Date.now()-n,a.success=0===a.errors.length,this.config.showProgressNotice&&this.showCompletionNotice(a)}catch(r){_e.error("[SimpleBatchParsingService] 批量解析失败:",r),a.errors.push({file:"system",message:r instanceof Error?r.message:"系统错误",error:r})}finally{this.isRunning=!1,this.abortController=void 0}return{parsedCards:i,result:a}}async parseSingleFileWithMapping(e){if(!this.findMatchingMapping(e.path))return{parsedCards:[],success:!1,message:`文件未配置牌组映射: ${e.name}\n\n请在插件设置中为该文件或其文件夹配置映射关系`};try{const t=await this.processFile(e);return t.parsedCards.length>0?{parsedCards:t.parsedCards,success:!0,message:`成功解析 ${t.parsedCards.length} 张卡片`}:{parsedCards:[],success:!1,message:"未找到可解析的卡片"}}catch(t){return{parsedCards:[],success:!1,message:`解析失败: ${t instanceof Error?t.message:"未知错误"}`}}}async processFile(e){var t,n,i,a,r,s,o;const l={parsedCards:[],totalCards:0,successfulCards:0,failedCards:[],newDecks:[],duplicateUUIDs:[],newCards:0,updatedCards:0,skippedCards:0,conflictCards:0,conflicts:[]},c=this.findMatchingMapping(e.path);if(!c)return l;const d=c.fileMode||"single-card";if(Ce("SimpleBatchParsingService",`🔍 路由决策 - fileMode: ${d}, singleCardParser: ${!!this.singleCardParser}, singleCardSyncEngine: ${!!this.singleCardSyncEngine}`),"single-card"===d){if(!this.singleCardParser||!this.singleCardSyncEngine){const t="❌ 单文件单卡片模式不可用：解析器未初始化。请检查插件是否正确加载。";return _e.error(`[SimpleBatchParsingService] ${t}`),l.errors.push({file:e.path,message:t,error:new Error("SingleCardParser or SingleCardSyncEngine not initialized")}),l}return Ce("SimpleBatchParsingService",`✅ 场景2（单卡片模式）：${e.path}`),await this.parseSingleFileAsSingleCard(e,c,l)}if("multi-cards"===d){const t=c.multiCardsConfig;if((null==t?void 0:t.parsingConfig)&&this.regexCardParser)return Ce("SimpleBatchParsingService",`✅ 场景1（正则模式）：多卡片解析 ${e.path}`),await this.parseSingleFileAsMultiCards(e,c,l)}Ce("SimpleBatchParsingService",`⚠️ 兼容模式（旧解析器）：${e.path} - fileMode=${d}, singleCardParser=${!!this.singleCardParser}, singleCardSyncEngine=${!!this.singleCardSyncEngine}`);const u=await e.vault.read(e),h=c.targetDeckId,p=c.targetDeckName;let g=u;const v={settings:this.config.parsingSettings,scenario:"batch",sourceFile:e.path,sourceFileName:e.name,sourceContent:u,onContentUpdated:async t=>{g=t,this.config.autoSaveAfterParsing&&await e.vault.modify(e,t)}},{cards:f,positions:m}=await this.parser.parseBatchCards(u,v);if(0===f.length)return l;if(l.totalCards=f.length,this.config.uuid.enabled&&"skip"===this.config.uuid.duplicateStrategy){const{EnhancedDelimiterDetector:e}=await Promise.resolve().then(()=>z_e),t=new e(this.config.parsingSettings.symbols.cardDelimiter).splitCardsRaw(g);let n=0;for(let i=f.length-1;i>=0;i--){const e=i+1;if(e<t.length-1){const a=t[e],r=this.detectUUIDInBlock(a);if(r){await this.checkCardExists(r)&&(f.splice(i,1),n++)}}}n>0&&(l.totalCards=f.length)}if(this.config.uuid.enabled&&m&&m.length===f.length){const i=await wp(f,m,g,this.uuidManager,e=>this.detectUUIDInBlock(e));if(l.duplicateUUIDs.push(...i.duplicates),i.contentUpdated&&this.config.autoSaveAfterParsing&&await e.vault.modify(e,i.updatedContent),this.cleanupService&&i.contentUpdated){for(const e of f)(null==(t=e.metadata)?void 0:t.uuid)&&this.cleanupService.markUUIDRecentlyCreated(e.metadata.uuid),(null==(n=e.metadata)?void 0:n.blockId)&&this.cleanupService.markRecentlyCreated(e.metadata.blockId);Ce("SimpleBatchParsingService",`已保护 ${f.length} 个UUID/块链接（60秒）`)}for(const t of f)t.metadata&&(t.metadata.blockId&&(t.metadata.sourceBlock=t.metadata.blockId),t.metadata.sourceFile||(t.metadata.sourceFile=e.path));Ce("SimpleBatchParsingService",`✅ 已设置 ${f.length} 张卡片的溯源信息（sourceFile + sourceBlock）`)}for(let k=0;k<f.length;k++){const e=f[k];e.metadata||(e.metadata={}),e.metadata.targetDeckId=h,e.metadata.targetDeckName=p,e.metadata.isBatchScanned=!0,e.metadata.lastScannedAt=(new Date).toISOString();const t=`${e.front}\n---div---\n${e.back}`;e.metadata.lastScannedContent=t}l.totalCards=f.length,l.successfulCards=0,l.parsedCards=f,l.newCards=0,l.updatedCards=0,l.skippedCards=0,l.conflictCards=0;const y=(null==(i=this.config.parsingSettings.batchParsing)?void 0:i.excludeTags)||[],b=(null==(a=this.config.parsingSettings.batchParsing)?void 0:a.forceSyncTags)||[];Ce("BatchParsing",`开始同步决策: 总计${f.length}张卡片`);for(const k of f)try{const t=(null==(r=k.metadata)?void 0:r.uuid)||"",n=k.tags||[];if(n.some(e=>y.includes(e))){l.skippedCards++,Ce("BatchParsing",`跳过（包含排除标签）: ${t.substring(0,8)}...`);continue}if(n.some(e=>b.includes(e))){t?(l.updatedCards++,Ce("BatchParsing",`强制同步（包含#自动同步标签）: ${t.substring(0,8)}...`)):(l.newCards++,Ce("BatchParsing","新卡片（包含#自动同步标签）")),l.successfulCards++;continue}const i=(null==(s=k.metadata)?void 0:s.lastScannedContent)||`${k.front}\n---div---\n${k.back}`,a=await this.mergeEngine.smartSync(i,t,h);switch(a.action){case"created":l.newCards++,l.successfulCards++,Ce("BatchParsing",`新增卡片: ${t.substring(0,8)}...`);break;case"updated":l.updatedCards++,l.successfulCards++,Ce("BatchParsing",`更新卡片: ${t.substring(0,8)}... (${a.reason})`);break;case"skipped":case"kept":l.skippedCards++,l.successfulCards++,Ce("BatchParsing",`跳过卡片: ${t.substring(0,8)}... (${a.reason})`);break;case"conflict":l.conflictCards++,a.conflict&&(null==(o=l.conflicts)||o.push({file:e.path,cardIndex:f.indexOf(k),uuid:t,conflict:a.conflict})),Ce("BatchParsing",`检测到冲突: ${t.substring(0,8)}...`)}}catch(w){_e.error("[BatchParsing] 同步决策失败:",w),l.failedCards.push({file:e.path,card:k,error:w instanceof Error?w.message:String(w)})}return Ce("BatchParsing",`同步决策完成: 新增${l.newCards}, 更新${l.updatedCards}, 跳过${l.skippedCards}, 冲突${l.conflictCards}`),l}detectUUIDInBlock(e){const t=e.match(/<!--\s*(tk-[23456789abcdefghjkmnpqrstuvwxyz]{12})\s*-->/i);if(t)return t[1];const n=e.match(/<!--\s*([0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12})\s*-->/i);return n?n[1]:null}showCompletionNotice(e){const t=(e.stats.processingTime/1e3).toFixed(1);e.success?new ge.Notice(`✅ 批量解析完成：${e.successfulCards}/${e.totalCards} 张卡片 (${t}s)`,5e3):new ge.Notice(`⚠️ 批量解析完成（有错误）：${e.successfulCards}/${e.totalCards} 张卡片，${e.errors.length} 个文件失败`,7e3)}abort(){this.abortController&&this.abortController.abort()}isProcessing(){return this.isRunning}updateConfig(e){this.config={...this.config,...e}}async scanMappedFolders(){const e=(this.config.folderDeckMappings||[]).filter(e=>e.enabled);if(0===e.length)return[];const t=[];for(const n of e){const e=await this.scanMapping(n);t.push(...e)}return this.deduplicateFiles(t)}async scanMapping(e){const t=e.type||"folder",n=e.path||e.folderPath||"";return n?"file"===t?this.scanSingleFile(n):this.scanFolder(n,e.includeSubfolders):(_e.warn("[SimpleBatchParsingService] 映射路径为空"),[])}async scanSingleFile(e){const t=this.app.vault.getAbstractFileByPath(e);return t&&t instanceof ge.TFile?"md"!==t.extension?(_e.warn(`[SimpleBatchParsingService] 非 Markdown 文件: ${e}`),[]):[t]:(_e.warn(`[SimpleBatchParsingService] 文件不存在: ${e}`),[])}async scanFolder(e,t){const n=this.app.vault.getAbstractFileByPath(e);if(!(n&&n instanceof ge.TFolder))return _e.warn(`[SimpleBatchParsingService] 文件夹不存在: ${e}`),[];const i=[];if(t)ge.Vault.recurseChildren(n,e=>{e instanceof ge.TFile&&"md"===e.extension&&i.push(e)});else for(const a of n.children)a instanceof ge.TFile&&"md"===a.extension&&i.push(a);return i}deduplicateFiles(e){const t=new Set,n=[];for(const i of e)t.has(i.path)||(t.add(i.path),n.push(i));return n}async scanSingleMapping(e,t){var n,i,a;const r=Date.now(),s=e.type||"folder",o=e.path||e.folderPath||"";e.fileMode||(e.fileMode="single-card",Ce("SimpleBatchParsingService","⚠️ 检测到映射缺少fileMode，自动设置为single-card")),Ce("SimpleBatchParsingService","开始扫描单个映射",{type:s,path:o,targetDeckId:e.targetDeckId,fileMode:e.fileMode,includeSubfolders:e.includeSubfolders});const l=await this.scanMapping(e);if(0===l.length)return _e.warn("[SimpleBatchParsingService] 未找到任何文件"),{success:!0,totalCards:0,successfulCards:0,failedCards:[],newDecks:[],duplicateUUIDs:[],parsedCards:[],newCards:0,updatedCards:0,skippedCards:0,conflictCards:0,conflicts:[],errors:[],stats:{filesProcessed:0,filesWithCards:0,filesSkipped:0,processingTime:Date.now()-r}};Ce("SimpleBatchParsingService",`找到 ${l.length} 个文件`);const c={...this.config};this.config.folderDeckMappings=[e];const d={success:!0,totalCards:0,successfulCards:0,failedCards:[],newDecks:[],duplicateUUIDs:[],parsedCards:[],newCards:0,updatedCards:0,skippedCards:0,conflictCards:0,conflicts:[],errors:[],stats:{filesProcessed:0,filesWithCards:0,filesSkipped:0,processingTime:0}};for(let h=0;h<l.length;h++){const e=l[h];t&&t(h+1,l.length,e.path);try{const t=await this.processFile(e);d.totalCards+=t.totalCards,d.successfulCards+=t.successfulCards,d.failedCards.push(...t.failedCards),d.newDecks.push(...t.newDecks),d.duplicateUUIDs.push(...t.duplicateUUIDs),d.newCards+=t.newCards||0,d.updatedCards+=t.updatedCards||0,d.skippedCards+=t.skippedCards||0,d.conflictCards+=t.conflictCards||0,t.conflicts&&t.conflicts.length>0&&(null==(n=d.conflicts)||n.push(...t.conflicts)),t.parsedCards&&t.parsedCards.length>0&&(null==(i=d.parsedCards)||i.push(...t.parsedCards),d.stats.filesWithCards++),d.stats.filesProcessed++}catch(u){const t=u instanceof Error?u.message:"未知错误";_e.error(`[SimpleBatchParsingService] 处理文件失败: ${e.path}`,u),d.errors.push({file:e.path,message:t,error:u}),d.stats.filesSkipped++}}return this.config=c,d.stats.processingTime=Date.now()-r,d.stats.filesSkipped=l.length-d.stats.filesProcessed,Ce("SimpleBatchParsingService","扫描完成",{totalCards:d.totalCards,parsedCardsCount:null==(a=d.parsedCards)?void 0:a.length,successfulCards:d.successfulCards,failedCards:d.failedCards,filesProcessed:d.stats.filesProcessed}),d}async countCardsInMapping(e){const t=e.path||e.folderPath||"";Ce("SimpleBatchParsingService",`统计映射卡片数: ${t}`);const n=await this.scanMapping(e);if(0===n.length)return 0;let i=0;for(const r of n)try{const e=await r.vault.read(r),t={settings:this.config.parsingSettings,scenario:"batch",sourceFile:r.path,sourceFileName:r.name,sourceContent:e},{cards:n}=await this.parser.parseBatchCards(e,t);i+=n.length}catch(a){_e.error(`[SimpleBatchParsingService] 统计文件卡片失败: ${r.path}`,a)}return Ce("SimpleBatchParsingService",`统计完成: ${i} 张卡片`),i}async checkCardExists(e){try{return await this.uuidManager.hasUUID(e)}catch(t){return _e.error("检查UUID存在性失败:",t),!1}}findMatchingMapping(e){const t=(this.config.folderDeckMappings||[]).filter(e=>e.enabled);if(0===t.length)return null;const n=[...t].sort((e,t)=>{const n=e.path||e.folderPath||"";return(t.path||t.folderPath||"").length-n.length});for(const i of n){const t=i.type||"folder",n=i.path||i.folderPath||"";if("file"===t){if(e===n)return i}else if(i.includeSubfolders){if(e.startsWith(`${n}/`)||e.startsWith(n))return i}else{if(e.substring(0,e.lastIndexOf("/"))===n)return i}}return null}async parseSingleFileAsSingleCard(e,t,n){var i,a,r,s,o,l,c,d,u;try{Ce("SimpleBatchParsingService",`场景2：单文件单卡片模式解析 ${e.path}`);const p=t.singleCardConfig;if(!p)return _e.warn("[SimpleBatchParsingService] 映射缺少 singleCardConfig，跳过"),n;const g=await(null==(i=this.singleCardParser)?void 0:i.parseFile(e,p,t.targetDeckId));if(!g)return n.failedCards.push({file:e.path,card:null,error:"解析器未初始化"}),n;if(!g.success||g.shouldSkip)return g.shouldSkip?(Ce("SimpleBatchParsingService",`跳过文件: ${g.skipReason}`),n.skippedCards=(n.skippedCards||0)+1):(_e.error(`[SimpleBatchParsingService] 解析失败: ${g.error}`),n.failedCards.push({file:e.path,card:null,error:g.error||"未知错误"})),n;const v=g.card;if(!v)return n.failedCards.push({file:e.path,card:null,error:"解析后的卡片为空"}),n;const f=await(null==(a=this.singleCardSyncEngine)?void 0:a.decideSyncAction(v));if(!f)return n.failedCards.push({file:e.path,card:v,error:"同步决策器未初始化"}),n;switch(Ce("SimpleBatchParsingService",`同步决策: ${f.action} - ${f.reason}`),n.totalCards++,n.parsedCards||(n.parsedCards=[]),f.action){case"create":n.newCards=(n.newCards||0)+1,v&&n.parsedCards.push(v),n.successfulCards++;break;case"update":n.updatedCards=(n.updatedCards||0)+1,n.parsedCards||(n.parsedCards=[]),v&&n.parsedCards.push(v),n.successfulCards++;break;case"skip":n.skippedCards=(n.skippedCards||0)+1}if(v&&(null==(r=v.metadata)?void 0:r.uuid)&&(null==(s=v.metadata)?void 0:s.isNewCard))try{await(null==(o=this.singleCardParser)?void 0:o.getFileUUID(e))!==v.metadata.uuid&&await(null==(l=this.singleCardParser)?void 0:l.setFileUUID(e,v.metadata.uuid))}catch(h){_e.error("[SimpleBatchParsingService] 写入 UUID 失败:",h)}else if(v&&(null==(c=v.metadata)?void 0:c.uuid)){if(!(await(null==(d=this.singleCardParser)?void 0:d.getFileUUID(e))))try{await(null==(u=this.singleCardParser)?void 0:u.setFileUUID(e,v.metadata.uuid))}catch(h){_e.error("[SimpleBatchParsingService] 补充写入 UUID 失败:",h)}}return n}catch(h){return _e.error("[SimpleBatchParsingService] 场景2解析异常:",h),n.failedCards.push({file:e.path,card:null,error:h instanceof Error?h.message:String(h)}),n}}async parseSingleFileAsMultiCards(e,t,n){var i,a,r,s,o;try{Ce("SimpleBatchParsingService",`场景1：多卡片正则模式解析 ${e.path}`);const c=t.multiCardsConfig;if(!(null==c?void 0:c.parsingConfig))return _e.warn("[SimpleBatchParsingService] 映射缺少 multiCardsConfig.parsingConfig，跳过"),n;const d=c.parsingConfig,u=await(null==(i=this.regexCardParser)?void 0:i.parseFile(e,d,t.targetDeckId));if(!u)return n.failedCards.push({file:e.path,card:null,error:"解析器返回空结果"}),n;if(!u.success||0===u.cards.length)return u.errors.length>0&&(_e.error("[SimpleBatchParsingService] 正则解析失败:",u.errors),n.failedCards.push({file:e.path,card:null,error:u.errors.join("; ")})),u.skippedCount>0&&(n.skippedCards=(n.skippedCards||0)+u.skippedCount),n;if(n.totalCards+=u.cards.length,n.skippedCards=(n.skippedCards||0)+u.skippedCount,Ce("SimpleBatchParsingService",`正则解析成功：${u.cards.length} 张卡片，跳过 ${u.skippedCount}`),this.config.uuid.enabled&&u.positions&&u.originalContent)if(u.positions.length===u.cards.length){Ce("SimpleBatchParsingService","开始插入UUID和块链接...");const t=await wp(u.cards,u.positions,u.originalContent,this.uuidManager,e=>this.detectUUIDInBlock(e));if(n.duplicateUUIDs.push(...t.duplicates),t.contentUpdated&&this.config.autoSaveAfterParsing?(await e.vault.modify(e,t.updatedContent),Ce("SimpleBatchParsingService","UUID和块链接已插入并保存到文件")):t.contentUpdated&&Ce("SimpleBatchParsingService","UUID已插入但未自动保存（autoSaveAfterParsing=false）"),this.cleanupService&&t.contentUpdated){for(const e of u.cards)(null==(a=e.metadata)?void 0:a.uuid)&&this.cleanupService.markUUIDRecentlyCreated(e.metadata.uuid),(null==(r=e.metadata)?void 0:r.blockId)&&this.cleanupService.markRecentlyCreated(e.metadata.blockId);Ce("SimpleBatchParsingService",`已保护 ${u.cards.length} 个UUID/块链接（60秒）`)}for(const n of u.cards)n.metadata&&(n.metadata.blockId&&(n.metadata.sourceBlock=n.metadata.blockId),n.metadata.sourceFile||(n.metadata.sourceFile=e.path));Ce("SimpleBatchParsingService",`✅ 已设置 ${u.cards.length} 张卡片的溯源信息（sourceFile + sourceBlock）`)}else _e.warn(`[SimpleBatchParsingService] ⚠️ 位置信息数量不匹配: cards=${u.cards.length}, positions=${u.positions.length}`);else this.config.uuid.enabled&&_e.warn("[SimpleBatchParsingService] ⚠️ UUID未插入: 缺少位置信息或原始内容");if("tag-based"===(d.syncMethod||"tag-based")){n.parsedCards||(n.parsedCards=[]),n.conflicts||(n.conflicts=[]);for(const i of u.cards)try{const a=(null==(s=i.metadata)?void 0:s.uuid)||"";if(!a){n.newCards=(n.newCards||0)+1,n.parsedCards.push(i),n.successfulCards++;continue}const r=`${i.front}\n---div---\n${i.back}`,o=await this.mergeEngine.smartSync(r,a,t.targetDeckId);switch(o.action){case"created":n.newCards=(n.newCards||0)+1,n.parsedCards.push(i),n.successfulCards++;break;case"updated":n.updatedCards=(n.updatedCards||0)+1,n.parsedCards.push(i),n.successfulCards++;break;case"kept":case"skipped":n.skippedCards=(n.skippedCards||0)+1;break;case"conflict":n.conflictCards=(n.conflictCards||0)+1,n.conflicts.push({file:e.path,cardIndex:n.parsedCards.length,uuid:a,conflict:o})}}catch(l){_e.error("[SimpleBatchParsingService] 同步决策失败:",l),n.failedCards.push({file:e.path,card:i,error:l instanceof Error?l.message:String(l)})}}else{n.parsedCards||(n.parsedCards=[]);for(const e of u.cards){const t=null==(o=e.metadata)?void 0:o.uuid;if(t){await this.mergeEngine.findCardByUUID(t)?n.updatedCards=(n.updatedCards||0)+1:n.newCards=(n.newCards||0)+1}else n.newCards=(n.newCards||0)+1;n.parsedCards.push(e),n.successfulCards++}}return n}catch(l){return _e.error("[SimpleBatchParsingService] 场景1多卡片解析异常:",l),n.failedCards.push({file:e.path,card:null,error:l instanceof Error?l.message:String(l)}),n}}}class Dp{constructor(e,t,n,i,a,r){var s;oe(this,"app"),oe(this,"config"),oe(this,"parser"),oe(this,"deckStorage"),oe(this,"uuidStorage"),oe(this,"plugin"),oe(this,"fileSelector"),oe(this,"deckMapping"),oe(this,"uuidManager"),oe(this,"batchService"),oe(this,"isInitialized",!1),oe(this,"progressCallback"),this.app=e,this.parser=n,this.deckStorage=i,this.uuidStorage=a,this.plugin=r,this.config=function(e){return{folderDeckMappings:[],uuid:Mp,parsingSettings:e,maxFilesPerBatch:100,showProgressNotice:!0,autoSaveAfterParsing:!0,deckNamePrefix:"",hierarchySeparator:"::"}}(t),(null==(s=t.batchParsing)?void 0:s.folderDeckMappings)&&Array.isArray(t.batchParsing.folderDeckMappings)&&t.batchParsing.folderDeckMappings.length>0?(this.config.folderDeckMappings=t.batchParsing.folderDeckMappings,this.logDebug("从 settings 恢复映射配置:",this.config.folderDeckMappings.length,"个映射")):this.logDebug("未找到持久化的映射配置，使用空列表"),this.fileSelector=new fp(e.vault,e.metadataCache),this.deckMapping=new mp(this.config.deckMapping||{enabled:!1,rules:[],hierarchySeparator:"::"},i),this.uuidManager=new yp(this.config.uuid,e.vault,a),this.batchService=new Ip(this.config,this.fileSelector,this.deckMapping,this.uuidManager,n,e,r.dataStorage,r.blockLinkCleanupService,r),this.isInitialized=!0}logDebug(e,...t){Ce("BatchParsingManager",e,...t)}registerCommands(e){e.addCommand({id:"batch-parsing-clean-uuids",name:"清理UUID记录",callback:()=>{this.cleanupUUIDs()}})}updateParserSettings(e){this.config.parsingSettings=e,this.parser.updateSettings(e),this.batchService.updateConfig({parsingSettings:e})}async executeBatchParsing(){var e,t,n;if(!Qh.getInstance().canUseFeature(Hh.BATCH_PARSING))return new ge.Notice("🔒 批量解析系统需要激活许可证才能使用"),null;if(!this.isInitialized)return new ge.Notice("❌ 批量解析服务未初始化"),null;if(this.batchService.isProcessing())return new ge.Notice("⚠️ 批量解析正在进行中"),null;this.syncConfigFromSettings();const i=this.getValidMappings();if(0===i.length){const e=this.validateConfig();return new ge.Notice(`❌ 配置错误: ${e.message}`),null}const a=this.getInvalidMappings();if(a.length>0){const e=a.map(e=>{const t=e.path||e.folderPath;return t?`"${t}"`:`ID: ${e.id||"未知"}`}).join(", ");new ge.Notice(`⚠️ 检测到 ${a.length} 个配置不完整的映射已跳过: ${e}\n✅ 将继续处理 ${i.length} 个有效映射`,6e3)}const r=this.config.folderDeckMappings;this.config.folderDeckMappings=i;try{const i=new Tp(this.app,()=>{this.batchService.abort()});i.open();const{parsedCards:a,result:l}=await this.batchService.executeBatchParsing(e=>{i.updateProgress(e),this.progressCallback&&this.progressCallback(e)});if(i.close(),a.length>0){new ge.Notice(`🔄 开始保存 ${a.length} 张卡片...`);try{await this.plugin.addCardsToDB(a),l.successfulCards=a.length,l.success=!0;let i=0;for(const r of a){const a=null==(e=r.metadata)?void 0:e.uuid,o=r.id;if(!a||!o)continue;const l=r.sourceFile||(null==(t=r.metadata)?void 0:t.sourceFile)||(null==(n=r.customFields)?void 0:n.obsidianFilePath);if(!l)continue;const c=this.app.vault.getAbstractFileByPath(l);if(c instanceof ge.TFile)try{await this.uuidManager.saveRecord(a,o,c,0),i++}catch(s){_e.error(`保存UUID记录失败 (${a}):`,s)}}}catch(o){_e.error("[BatchParsingManager] 保存卡片失败:",o),l.errors.push({file:"system",message:`保存失败: ${o instanceof Error?o.message:"未知错误"}`,error:o}),l.success=!1}}return this.showResult(l),this.config.folderDeckMappings=r,l}catch(s){return _e.error("[BatchParsingManager] 批量解析失败:",s),new ge.Notice(`❌ 批量解析失败: ${s instanceof Error?s.message:"未知错误"}`),r&&(this.config.folderDeckMappings=r),null}}async parseSingleFile(e){try{const t=await this.batchService.parseSingleFileWithMapping(e);if(!t.success)return void new ge.Notice(t.message||"❌ 解析失败",8e3);t.parsedCards&&t.parsedCards.length>0?(new ge.Notice(`🔄 开始保存 ${t.parsedCards.length} 张卡片...`),await this.plugin.addCardsToDB(t.parsedCards),new ge.Notice(`✅ 成功保存 ${t.parsedCards.length} 张卡片到指定牌组`)):new ge.Notice("⚠️ 未找到可解析的卡片")}catch(t){_e.error("解析文件失败:",t),new ge.Notice(`❌ 解析失败: ${t instanceof Error?t.message:"未知错误"}`)}}async cleanupUUIDs(){new ge.Notice("UUID清理功能开发中...")}async updateConfig(e){var t,n,i;if(this.config={...this.config,...e},e.folderDeckMappings&&(null==(i=null==(n=null==(t=this.plugin)?void 0:t.settings)?void 0:n.simplifiedParsing)?void 0:i.batchParsing)){this.plugin.settings.simplifiedParsing.batchParsing.folderDeckMappings=e.folderDeckMappings,this.logDebug("同步映射配置到 settings:",e.folderDeckMappings.length,"个映射");try{await this.plugin.saveSettings(),this.logDebug("✅ 配置已保存到磁盘")}catch(a){_e.error("❌ [BatchParsingManager] 保存配置失败:",a)}}else e.folderDeckMappings&&_e.warn("[BatchParsingManager] 无法同步映射配置：settings.simplifiedParsing.batchParsing 不存在");e.deckMapping&&this.deckMapping.updateConfig(e.deckMapping),e.uuid&&this.uuidManager.updateConfig(e.uuid),this.batchService.updateConfig(this.config)}async updateMappings(e){await this.updateConfig({folderDeckMappings:e})}getConfig(){return{...this.config}}validateConfig(){if(!this.config.folderDeckMappings||0===this.config.folderDeckMappings.length)return{valid:!1,message:"请先配置文件夹与牌组的映射关系"};const e=this.config.folderDeckMappings.filter(e=>e.enabled);if(0===e.length)return{valid:!1,message:"没有启用的文件夹映射，请至少启用一个映射"};const t=[];for(const n of e){const e=n.path||n.folderPath;e?n.targetDeckId||t.push(`映射 "${e}" (未配置目标牌组)`):t.push(`映射 ID: ${n.id||"未知"} (未配置路径)`)}return t.length>0?{valid:!1,message:`存在配置不完整的映射：\n${t.join("\n")}\n\n请在插件设置中检查并完善映射配置。`}:{valid:!0,message:""}}getValidMappings(){return this.config.folderDeckMappings&&0!==this.config.folderDeckMappings.length?this.config.folderDeckMappings.filter(e=>{if(!e.enabled)return!1;return(e.path||e.folderPath)&&e.targetDeckId}):[]}getInvalidMappings(){return this.config.folderDeckMappings&&0!==this.config.folderDeckMappings.length?this.config.folderDeckMappings.filter(e=>{if(!e.enabled)return!1;return!(e.path||e.folderPath)||!e.targetDeckId}):[]}syncConfigFromSettings(){var e,t,n,i;if(!(null==(n=null==(t=null==(e=this.plugin)?void 0:e.settings)?void 0:t.simplifiedParsing)?void 0:n.batchParsing))return void this.logDebug("无法同步配置：settings.simplifiedParsing.batchParsing 不存在");const a=this.plugin.settings.simplifiedParsing.batchParsing.folderDeckMappings;if(a&&Array.isArray(a)&&a.length>0){const e=(null==(i=this.config.folderDeckMappings)?void 0:i.length)||0;this.config.folderDeckMappings=a,this.logDebug("已从 settings 同步最新映射配置:",a.length,"个映射",e!==a.length?`(变化: ${e} → ${a.length})`:"(无变化)"),this.batchService.updateConfig({folderDeckMappings:a})}else this.logDebug("settings 中没有映射配置，保持当前配置")}setProgressCallback(e){this.progressCallback=e}showResult(e){const t=(e.stats.processingTime/1e3).toFixed(1);e.success?new ge.Notice(`✅ 批量解析完成\n成功: ${e.successfulCards}/${e.totalCards} 张卡片\n处理文件: ${e.stats.filesProcessed} 个\n用时: ${t}秒`,8e3):new ge.Notice(`⚠️ 批量解析完成（有错误）\n成功: ${e.successfulCards}/${e.totalCards} 张卡片\n错误: ${e.errors.length} 个文件失败\n用时: ${t}秒`,1e4),this.logDebug("批量解析结果:",{...e,errors:e.errors.map(e=>({file:e.file,message:e.message}))})}async scanSingleMapping(e,t){if(!this.isInitialized)throw new Error("批量解析服务未初始化");return await this.batchService.scanSingleMapping(e,t)}async countCardsInMapping(e){if(!this.isInitialized)throw new Error("批量解析服务未初始化");return await this.batchService.countCardsInMapping(e)}destroy(){this.deckMapping.clearCache(),this.isInitialized=!1}}class Tp extends ge.Modal{constructor(e,t){super(e),oe(this,"progressBar"),oe(this,"statusText"),oe(this,"detailsText"),oe(this,"onCancel"),this.onCancel=t}onOpen(){this.contentEl.empty(),this.contentEl.addClass("batch-progress-modal"),this.contentEl.createEl("h2",{text:"批量解析进行中"});const e=this.contentEl.createDiv("progress-container");this.progressBar=e.createDiv("progress-bar"),this.progressBar.style.width="0%",this.statusText=this.contentEl.createDiv("status-text"),this.statusText.setText("正在初始化..."),this.detailsText=this.contentEl.createDiv("details-text");this.contentEl.createEl("button",{text:"取消"}).onclick=()=>{this.onCancel(),this.close()},this.addStyles()}updateProgress(e){this.progressBar.style.width=`${e.percentage}%`,this.statusText.setText(`正在处理: ${e.currentFile} (${e.processedFiles}/${e.totalFiles})`),this.detailsText.setText(`成功: ${e.successCount} | 失败: ${e.errorCount}`)}addStyles(){const e=document.createElement("style");e.textContent="\n      .batch-progress-modal {\n        padding: 2rem;\n        min-width: 500px;\n      }\n      .batch-progress-modal h2 {\n        margin: 0 0 1.5rem 0;\n      }\n      .progress-container {\n        height: 8px;\n        background: var(--background-modifier-border);\n        border-radius: 4px;\n        overflow: hidden;\n        margin-bottom: 1rem;\n      }\n      .progress-bar {\n        height: 100%;\n        background: var(--interactive-accent);\n        transition: width 0.3s ease;\n      }\n      .status-text {\n        margin-bottom: 0.5rem;\n        font-weight: 500;\n      }\n      .details-text {\n        margin-bottom: 1.5rem;\n        font-size: 0.9em;\n        color: var(--text-muted);\n      }\n      .batch-progress-modal button {\n        padding: 0.5rem 1.5rem;\n        background: var(--interactive-normal);\n        border: 1px solid var(--background-modifier-border);\n        border-radius: 4px;\n        cursor: pointer;\n      }\n      .batch-progress-modal button:hover {\n        background: var(--interactive-hover);\n      }\n    ",document.head.appendChild(e)}onClose(){this.contentEl.empty()}}const Mp={enabled:!0,insertPosition:"after-card",format:"comment",prefix:"",duplicateStrategy:"skip",autoFixMissing:!0};class Ap{constructor(){oe(this,"records",new Map),oe(this,"cardIdIndex",new Map),oe(this,"filePathIndex",new Map),this.loadFromStorage()}async saveRecord(e){var t;_e.debug(`[UUIDStorageImpl] 💾 保存UUID记录: ${e.uuid} -> ${e.cardId}`),this.records.set(e.uuid,e),this.cardIdIndex.set(e.cardId,e.uuid),this.filePathIndex.has(e.sourceFile)||this.filePathIndex.set(e.sourceFile,new Set),null==(t=this.filePathIndex.get(e.sourceFile))||t.add(e.uuid),await this.persistToStorage(),_e.debug(`[UUIDStorageImpl] ✅ UUID记录已保存并持久化: ${e.uuid}`),_e.debug(`[UUIDStorageImpl] 📊 当前记录总数: ${this.records.size}`)}async getRecordByUUID(e){return this.records.get(e)||null}async getRecordByCardId(e){const t=this.cardIdIndex.get(e);return t&&this.records.get(t)||null}async deleteRecord(e){const t=this.records.get(e);if(!t)return;this.cardIdIndex.delete(t.cardId);const n=this.filePathIndex.get(t.sourceFile);n&&(n.delete(e),0===n.size&&this.filePathIndex.delete(t.sourceFile)),this.records.delete(e),await this.persistToStorage()}async uuidExists(e){const t=this.records.has(e);return _e.debug(`[UUIDStorageImpl] 🔍 查询UUID: ${e} - ${t?"✅ 存在":"❌ 不存在"} (总记录数: ${this.records.size})`),t}async getFileUUIDs(e){const t=this.filePathIndex.get(e);if(!t)return[];const n=[];for(const i of t){const e=this.records.get(i);e&&n.push(e)}return n}async loadFromStorage(){var e;try{const t=localStorage.getItem("tuanki-uuid-records");if(!t)return;const n=JSON.parse(t);for(const i of n){const t={...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)};this.records.set(i.uuid,t),this.cardIdIndex.set(i.cardId,i.uuid),this.filePathIndex.has(i.sourceFile)||this.filePathIndex.set(i.sourceFile,new Set),null==(e=this.filePathIndex.get(i.sourceFile))||e.add(i.uuid)}_e.debug(`[UUIDStorageImpl] 已加载 ${this.records.size} 条UUID记录`)}catch(t){_e.error("[UUIDStorageImpl] 加载UUID记录失败:",t)}}async persistToStorage(){try{const e=Array.from(this.records.values());localStorage.setItem("tuanki-uuid-records",JSON.stringify(e))}catch(e){_e.error("[UUIDStorageImpl] 持久化UUID记录失败:",e)}}async clear(){this.records.clear(),this.cardIdIndex.clear(),this.filePathIndex.clear(),await this.persistToStorage()}getStats(){return{totalRecords:this.records.size,totalFiles:this.filePathIndex.size}}}class Ep{constructor(e){oe(this,"plugin"),oe(this,"deckCache",new Map),this.plugin=e}async getDecks(){try{const e=this.plugin.dataStorage;if(!e)return _e.error("[DeckStorageAdapter] 数据存储服务不可用"),[];const t=await e.getDecks();if((null==t?void 0:t.success)&&Array.isArray(t.data)){const e=t.data.map(e=>({id:e.id||e.deckId||String(e.name),name:e.name||e.deckName||"Unnamed Deck",description:e.description||e.desc||""}));return e.forEach(e=>this.deckCache.set(e.id,e)),e}return _e.warn("[DeckStorageAdapter] 未找到牌组或格式不正确"),[]}catch(e){return _e.error("[DeckStorageAdapter] 获取牌组列表失败:",e),[]}}async getDeckById(e){if(this.deckCache.has(e))return this.deckCache.get(e);return(await this.getDecks()).find(t=>t.id===e)||null}async getDeckByName(e){return(await this.getDecks()).find(t=>t.name===e)||null}async createDeck(e,t){try{const n=this.plugin.dataStorage;if(!n||"function"!=typeof n.createDeck)throw _e.error("[DeckStorageAdapter] 创建牌组功能不可用"),new Error("数据存储服务不支持创建牌组");const i=await n.createDeck({name:e,description:t||""});if((null==i?void 0:i.success)&&i.data){const n={id:i.data.id||i.data.deckId||this.generateDeckId(),name:i.data.name||e,description:i.data.description||t||""};return this.deckCache.set(n.id,n),_e.debug(`[DeckStorageAdapter] ✅ 已创建牌组: ${n.name} (${n.id})`),n}throw new Error("创建牌组失败")}catch(n){_e.error("[DeckStorageAdapter] 创建牌组失败:",n);const i={id:this.generateDeckId(),name:e,description:t||""};return this.deckCache.set(i.id,i),i}}async deckExists(e){return null!==await this.getDeckById(e)}generateDeckId(){return`deck_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}clearCache(){this.deckCache.clear()}}class zp{constructor(e){oe(this,"storage"),oe(this,"syncHooks",[]),this.storage=e}registerSyncHook(e){this.syncHooks.push(e)}async createRootDeck(e,t){const n=(new Date).toISOString(),i=await this.storage.getUserProfile(),a={id:this.generateDeckId(),name:e,description:"",category:"默认",parentId:void 0,path:e,level:0,order:await this.getNextOrder(null),inheritSettings:!1,settings:t?{...i.globalSettings.defaultDeckSettings,...t}:i.globalSettings.defaultDeckSettings,stats:this.createEmptyStats(),includeSubdecks:!1,deckType:"mixed",created:n,modified:n,tags:[],metadata:{}};return await this.storage.saveDeck(a),_e.debug(`✅ Created root deck: ${a.path}`),a}async createSubdeck(e,t){const n=await this.storage.getDeck(e);if(!n)throw new Error(`Parent deck not found: ${e}`);const i=(new Date).toISOString(),a={id:this.generateDeckId(),name:t,description:"",category:n.category,parentId:e,path:`${n.path}::${t}`,level:n.level+1,order:await this.getNextOrder(e),inheritSettings:!0,settings:n.inheritSettings?n.settings:{...n.settings},stats:this.createEmptyStats(),includeSubdecks:!1,icon:n.icon,color:n.color,deckType:n.deckType||"mixed",created:i,modified:i,tags:[],metadata:{}};return await this.storage.saveDeck(a),_e.debug(`✅ Created subdeck: ${a.path}`),a}async moveDeck(e,t){const n=await this.storage.getDeck(e);if(!n)throw new Error(`Deck not found: ${e}`);if(t&&await this.isDescendant(t,e))throw new Error("Cannot move deck to its own descendant");const i=n.path;if(t){const e=await this.storage.getDeck(t);if(!e)throw new Error(`Parent deck not found: ${t}`);n.parentId=t,n.path=`${e.path}::${n.name}`,n.level=e.level+1}else n.parentId=void 0,n.path=n.name,n.level=0;n.order=await this.getNextOrder(t),n.modified=(new Date).toISOString(),await this.storage.saveDeck(n),await this.updateChildrenPaths(e,i,n.path);for(const r of this.syncHooks)if(r.onMove)try{await r.onMove(e,t)}catch(a){_e.error("[DeckHierarchyService] 同步钩子执行失败 (onMove):",a)}_e.debug(`✅ Moved deck from ${i} to ${n.path}`)}async renameDeck(e,t){const n=await this.storage.getDeck(e);if(!n)throw new Error(`Deck not found: ${e}`);const i=n.path,a=n.name;if(n.name=t,n.parentId){const e=await this.storage.getDeck(n.parentId);e&&(n.path=`${e.path}::${t}`)}else n.path=t;n.modified=(new Date).toISOString(),await this.storage.saveDeck(n),await this.updateChildrenPaths(e,i,n.path);for(const s of this.syncHooks)if(s.onRename)try{await s.onRename(e,t)}catch(r){_e.error("[DeckHierarchyService] 同步钩子执行失败 (onRename):",r)}_e.debug(`✅ Renamed deck from "${a}" to "${t}"`)}async deleteDeckWithChildren(e){const t=await this.getDescendants(e),n=t.sort((e,t)=>t.level-e.level);for(const a of n)await this.storage.deleteDeck(a.id);await this.storage.deleteDeck(e);for(const a of this.syncHooks)if(a.onDelete)try{await a.onDelete(e)}catch(i){_e.error("[DeckHierarchyService] 同步钩子执行失败 (onDelete):",i)}_e.debug(`✅ Deleted deck and ${t.length} descendants`)}async getDeckTree(){const e=await this.storage.getDecks(),t=e.filter(e=>!e.parentId);return t.sort((e,t)=>(e.order||0)-(t.order||0)),t.map(t=>this.buildTreeNode(t,e))}async getDescendants(e){const t=await this.storage.getDecks(),n=t.find(t=>t.id===e);if(!n)return[];const i=[],a=e=>{const n=t.filter(t=>t.parentId&&t.path.startsWith(`${e}::`));for(const t of n)i.push(t),a(t.path)};return a(n.path),i}async getBreadcrumb(e){const t=[];let n=await this.storage.getDeck(e);for(;n&&(t.unshift(n),n.parentId);)n=await this.storage.getDeck(n.parentId);return t}async getChildren(e){const t=(await this.storage.getDecks()).filter(t=>t.parentId===e);return t.sort((e,t)=>(e.order||0)-(t.order||0)),t}async updateOrder(e,t){const n=await this.storage.getDeck(e);if(!n)throw new Error(`Deck not found: ${e}`);n.order=t,n.modified=(new Date).toISOString(),await this.storage.saveDeck(n)}async reorderSiblings(e,t){for(let n=0;n<t.length;n++)await this.updateOrder(t[n],n)}async updateChildrenPaths(e,t,n){const i=(await this.storage.getDecks()).filter(t=>t.parentId===e);for(const a of i){const e=a.path;a.path=a.path.replace(t,n),a.modified=(new Date).toISOString(),await this.storage.saveDeck(a),await this.updateChildrenPaths(a.id,e,a.path)}}buildTreeNode(e,t){const n=t.filter(t=>t.parentId===e.id).sort((e,t)=>(e.order||0)-(t.order||0)).map(e=>this.buildTreeNode(e,t));return{deck:e,children:n}}async isDescendant(e,t){const n=await this.storage.getDecks();let i=n.find(e=>e.id===t);for(;null==i?void 0:i.parentId;){if(i.parentId===e)return!0;i=n.find(e=>e.id===(null==i?void 0:i.parentId))}return!1}async getNextOrder(e){const t=(await this.storage.getDecks()).filter(t=>t.parentId===e);if(0===t.length)return 0;return Math.max(...t.map(e=>e.order||0))+1}generateDeckId(){return`deck_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}createEmptyStats(){return{totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:0,forecastDays:{}}}}class Pp{constructor(e,t){oe(this,"plugin"),oe(this,"storage"),oe(this,"hashCache"),oe(this,"mediaBasePath"),this.plugin=e,this.storage=t,this.hashCache=new Map,this.mediaBasePath=ps()}async initialize(){_e.debug("[MediaManagement] Initializing..."),_e.debug("[MediaManagement] Media path:",this.mediaBasePath),await this.ensureDir(this.mediaBasePath),await this.rebuildHashCache(),_e.debug("[MediaManagement] Initialized")}async addMedia(e,t,n){const i=await this.calculateHash(e),a=this.hashCache.get(i);if(a)return _e.debug(`Media file already exists (hash: ${i.substring(0,8)}), adding reference`),a.usedByCards.includes(n)||(a.usedByCards.push(n),a.lastAccessed=(new Date).toISOString(),await this.updateMediaIndex(a),await this.saveHashIndex()),a;const r=await this.storage.getDeck(t);if(!r)throw new Error(`Deck not found: ${t}`);const s=`${r.path.replace(/::/g,"/")}/${e.name}`,o=`${this.mediaBasePath}/${s}`;await this.ensureDirForFile(o);const l=await e.arrayBuffer();await this.plugin.app.vault.adapter.writeBinary(o,l);const c={id:this.generateMediaId(),filename:e.name,deckPath:r.path,storagePath:s,hash:i,size:e.size,mimeType:e.type,usedByCards:[n],created:(new Date).toISOString(),lastAccessed:(new Date).toISOString()};return this.hashCache.set(i,c),await this.updateMediaIndex(c),await this.saveHashIndex(),_e.debug(`✅ Added media file: ${s}`),c}async getMediaByCard(e){return(await this.getAllMedia()).filter(t=>t.usedByCards.includes(e))}async getMediaByDeck(e){return(await this.getMediaIndex(e)).files}async onCardDeleted(e){const t=await this.getMediaByCard(e);for(const n of t)n.usedByCards=n.usedByCards.filter(t=>t!==e),0===n.usedByCards.length?(_e.debug(`Moving orphaned media: ${n.filename}`),await this.moveToOrphaned(n)):await this.updateMediaIndex(n);await this.saveHashIndex()}async onDeckDeleted(e){const t=await this.storage.getDeck(e);if(!t)return;const n=await this.getMediaIndex(t.path);for(const i of n.files)0===i.usedByCards.length?await this.deleteMedia(i):await this.moveToOrphaned(i);_e.debug(`✅ Cleaned up media for deleted deck: ${t.path}`)}async cleanupOrphaned(e=30){const t=`${this.mediaBasePath}/_orphaned`,n=Date.now()-24*e*60*60*1e3;let i=0;try{const e=(await this.plugin.app.vault.adapter.list(t)).files||[];for(const t of e)if(!t.endsWith(".json"))try{const e=await this.plugin.app.vault.adapter.stat(t);e&&e.mtime<n&&(await this.plugin.app.vault.adapter.remove(t),i++)}catch(a){_e.warn(`Failed to check/delete orphaned file: ${t}`,a)}_e.debug(`✅ Cleaned up ${i} orphaned media files`)}catch(a){_e.error("Orphaned cleanup failed:",a)}return i}async getStats(){const e=await this.getAllMedia(),t=e.reduce((e,t)=>e+t.size,0);let n=0;try{n=((await this.plugin.app.vault.adapter.list(`${this.mediaBasePath}/_orphaned`)).files||[]).filter(e=>!e.endsWith(".json")).length}catch(i){n=0}return{totalFiles:e.length,totalSize:t,orphanedCount:n}}async calculateHash(e){const t=await e.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}async moveToOrphaned(e){const t=`${this.mediaBasePath}/${e.storagePath}`,n=`${this.mediaBasePath}/_orphaned/${e.filename}`;try{if(await this.plugin.app.vault.adapter.exists(t)){const i=await this.plugin.app.vault.adapter.readBinary(t);await this.plugin.app.vault.adapter.writeBinary(n,i),await this.plugin.app.vault.adapter.remove(t),e.storagePath=`_orphaned/${e.filename}`,e.deckPath="_orphaned",await this.updateMediaIndex(e),_e.debug(`Moved to orphaned: ${e.filename}`)}}catch(i){_e.error("Failed to move media to orphaned:",i)}}async deleteMedia(e){const t=`${this.mediaBasePath}/${e.storagePath}`;try{await this.plugin.app.vault.adapter.remove(t),this.hashCache.delete(e.hash),_e.debug(`Deleted media: ${e.filename}`)}catch(n){_e.error("Failed to delete media:",n)}}async getMediaIndex(e){const t=`${this.mediaBasePath}/${e.replace(/::/g,"/")}/.media-index.json`;try{const e=await this.plugin.app.vault.adapter.read(t);return JSON.parse(e)}catch(n){return{deckPath:e,files:[],lastUpdated:(new Date).toISOString()}}}async updateMediaIndex(e){const t=await this.getMediaIndex(e.deckPath),n=t.files.findIndex(t=>t.id===e.id);n>=0?t.files[n]=e:t.files.push(e),t.files=t.files.filter(t=>t.usedByCards.length>0||t.id===e.id),t.lastUpdated=(new Date).toISOString();const i=`${this.mediaBasePath}/${e.deckPath.replace(/::/g,"/")}/.media-index.json`;await this.ensureDirForFile(i),await this.plugin.app.vault.adapter.write(i,JSON.stringify(t,null,2))}async getAllMedia(){const e=[],t=await this.storage.getDecks();for(const n of t){const t=await this.getMediaIndex(n.path);e.push(...t.files)}return e}async rebuildHashCache(){_e.debug("[MediaManagement] Rebuilding hash cache..."),this.hashCache=new Map;try{if(await this.loadHashIndex(),0===this.hashCache.size){const e=await this.getAllMedia();for(const t of e)this.hashCache.set(t.hash,t);this.hashCache.size>0&&await this.saveHashIndex(),_e.debug(`[MediaManagement] Rebuilt hash cache with ${this.hashCache.size} entries`)}}catch(e){_e.error("[MediaManagement] Failed to rebuild hash cache:",e),this.hashCache=new Map}}async loadHashIndex(){const e=`${this.mediaBasePath}/.hash-index.json`;try{const t=await this.plugin.app.vault.adapter.read(e),n=JSON.parse(t);this.hashCache=new Map(Object.entries(n)),_e.debug(`Loaded ${this.hashCache.size} media file hashes`)}catch(t){this.hashCache=new Map,_e.debug("No existing hash index found, starting fresh")}}async saveHashIndex(){const e=`${this.mediaBasePath}/.hash-index.json`,t=Object.fromEntries(this.hashCache);await this.plugin.app.vault.adapter.write(e,JSON.stringify(t,null,2))}async ensureDir(e){await ys.ensureDirRecursive(this.plugin.app.vault.adapter,e)}async ensureDirForFile(e){await ys.ensureDirForFile(this.plugin.app.vault.adapter,e)}generateMediaId(){return`media_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}class Rp{constructor(e){oe(this,"plugin"),oe(this,"basePath"),oe(this,"cardBySourceIndex",{}),oe(this,"mediaByHashIndex",{}),this.plugin=e,this.basePath=us.indices}async initialize(){_e.debug("[IndexManager] Initializing..."),_e.debug("[IndexManager] Indices path:",this.basePath),await this.ensureDir(this.basePath),await this.loadIndices(),_e.debug("[IndexManager] ✅ Initialized")}async updateCardIndex(e){if(!e.sourceFile)return;this.cardBySourceIndex[e.sourceFile]||(this.cardBySourceIndex[e.sourceFile]={cardIds:[],lastUpdated:""});const t=this.cardBySourceIndex[e.sourceFile];t.cardIds.includes(e.uuid)||t.cardIds.push(e.uuid),t.lastUpdated=(new Date).toISOString(),await this.saveIndex("card-by-source",this.cardBySourceIndex)}async removeCardIndex(e,t){if(!t)return;const n=this.cardBySourceIndex[t];n&&(n.cardIds=n.cardIds.filter(t=>t!==e),0===n.cardIds.length?delete this.cardBySourceIndex[t]:n.lastUpdated=(new Date).toISOString(),await this.saveIndex("card-by-source",this.cardBySourceIndex))}getCardIdsBySourceFile(e){var t;return(null==(t=this.cardBySourceIndex[e])?void 0:t.cardIds)||[]}getAllIndexedSourceFiles(){return Object.keys(this.cardBySourceIndex)}async updateMediaHashIndex(e,t){this.mediaByHashIndex[e]=t,await this.saveIndex("media-by-hash",this.mediaByHashIndex)}async removeMediaHashIndex(e){delete this.mediaByHashIndex[e],await this.saveIndex("media-by-hash",this.mediaByHashIndex)}getMediaIdByHash(e){return this.mediaByHashIndex[e]}async rebuildIndices(e,t){_e.debug("Rebuilding all indices..."),this.cardBySourceIndex={};for(const i of e)i.sourceFile&&(this.cardBySourceIndex[i.sourceFile]||(this.cardBySourceIndex[i.sourceFile]={cardIds:[],lastUpdated:""}),this.cardBySourceIndex[i.sourceFile].cardIds.push(i.uuid),this.cardBySourceIndex[i.sourceFile].lastUpdated=(new Date).toISOString());await this.saveIndex("card-by-source",this.cardBySourceIndex),_e.debug(`✅ Rebuilt card-by-source index (${Object.keys(this.cardBySourceIndex).length} files)`),this.mediaByHashIndex={};try{const e=await t();for(const t of e)this.mediaByHashIndex[t.hash]=t.id;await this.saveIndex("media-by-hash",this.mediaByHashIndex),_e.debug(`✅ Rebuilt media-by-hash index (${Object.keys(this.mediaByHashIndex).length} files)`)}catch(n){_e.error("Failed to rebuild media index:",n)}_e.debug("✅ All indices rebuilt successfully")}validateIndices(e){const t=[],n=new Set;for(const a of Object.values(this.cardBySourceIndex))a.cardIds.forEach(e=>n.add(e));const i=new Set(e.filter(e=>e.sourceFile).map(e=>e.uuid));for(const a of i)n.has(a)||t.push(`Card ${a} is missing from index`);for(const a of n)i.has(a)||t.push(`Card ${a} in index but not in actual cards`);return{isValid:0===t.length,issues:t}}getStats(){const e=Object.values(this.cardBySourceIndex).reduce((e,t)=>e+t.cardIds.length,0);return{cardBySourceCount:Object.keys(this.cardBySourceIndex).length,mediaByHashCount:Object.keys(this.mediaByHashIndex).length,totalIndexedCards:e}}async clearAllIndices(){_e.debug("Clearing all indices..."),this.cardBySourceIndex={},this.mediaByHashIndex={},await this.saveIndex("card-by-source",this.cardBySourceIndex),await this.saveIndex("media-by-hash",this.mediaByHashIndex),_e.debug("✅ All indices cleared")}async loadIndices(){try{const e=await this.plugin.app.vault.adapter.read(`${this.basePath}/card-by-source.json`);this.cardBySourceIndex=JSON.parse(e),_e.debug(`Loaded card-by-source index (${Object.keys(this.cardBySourceIndex).length} files)`)}catch(e){this.cardBySourceIndex={},_e.debug("No existing card-by-source index found")}try{const e=await this.plugin.app.vault.adapter.read(`${this.basePath}/media-by-hash.json`);this.mediaByHashIndex=JSON.parse(e),_e.debug(`Loaded media-by-hash index (${Object.keys(this.mediaByHashIndex).length} files)`)}catch(e){this.mediaByHashIndex={},_e.debug("No existing media-by-hash index found")}}async saveIndex(e,t){const n=`${this.basePath}/${e}.json`;await this.plugin.app.vault.adapter.write(n,JSON.stringify(t,null,2))}async ensureDir(e){await ys.ensureDir(this.plugin.app.vault.adapter,e)}}class $p{constructor(e){oe(this,"state"),oe(this,"listeners",new Set),oe(this,"plugin"),oe(this,"isUpdating",!1),this.plugin=e,this.state={selectedDeckId:null,selectedCardTypes:new Set,selectedPriority:null,selectedTags:new Set,selectedTimeFilter:null,activeDocumentFilter:null,dataSource:"memory"},this.loadFromStorage()}getState(){return{...this.state,selectedCardTypes:new Set(this.state.selectedCardTypes),selectedTags:new Set(this.state.selectedTags)}}updateFilter(e){this.isUpdating||(this.isUpdating=!0,this.state={...this.state,...e,selectedCardTypes:e.selectedCardTypes?new Set(e.selectedCardTypes):this.state.selectedCardTypes,selectedTags:e.selectedTags?new Set(e.selectedTags):this.state.selectedTags},this.saveToStorage(),this.notifyListeners(),this.isUpdating=!1)}subscribe(e){return this.listeners.add(e),e(this.getState()),()=>{this.listeners.delete(e)}}clearAll(){this.updateFilter({selectedDeckId:null,selectedCardTypes:new Set,selectedPriority:null,selectedTags:new Set,selectedTimeFilter:null,activeDocumentFilter:null})}notifyListeners(){const e=this.getState();this.listeners.forEach(t=>{try{t(e)}catch(n){_e.error("[FilterStateService] Listener error:",n)}})}saveToStorage(){try{const e={selectedDeckId:this.state.selectedDeckId,selectedCardTypes:Array.from(this.state.selectedCardTypes),selectedPriority:this.state.selectedPriority,selectedTags:Array.from(this.state.selectedTags),selectedTimeFilter:this.state.selectedTimeFilter,activeDocumentFilter:this.state.activeDocumentFilter,dataSource:this.state.dataSource};localStorage.setItem("tuanki-global-filter-state",JSON.stringify(e))}catch(e){_e.error("[FilterStateService] Failed to save state:",e)}}loadFromStorage(){var e;try{const t=localStorage.getItem("tuanki-global-filter-state");if(!t)return;const n=JSON.parse(t);this.state={selectedDeckId:n.selectedDeckId||null,selectedCardTypes:new Set(n.selectedCardTypes||[]),selectedPriority:null!=(e=n.selectedPriority)?e:null,selectedTags:new Set(n.selectedTags||[]),selectedTimeFilter:n.selectedTimeFilter||null,activeDocumentFilter:n.activeDocumentFilter||null,dataSource:n.dataSource||"memory"},_e.debug("[FilterStateService] State loaded from storage")}catch(t){_e.error("[FilterStateService] Failed to load state:",t)}}getFilterSummary(){const e=[];return this.state.selectedDeckId&&e.push("牌组"),this.state.selectedCardTypes.size>0&&e.push(`${this.state.selectedCardTypes.size}种题型`),null!==this.state.selectedPriority&&e.push("优先级"),this.state.selectedTags.size>0&&e.push(`${this.state.selectedTags.size}个标签`),this.state.activeDocumentFilter&&e.push("文档"),e.length>0?e.join(" · "):"无筛选"}hasActiveFilters(){return!!(this.state.selectedDeckId||this.state.selectedCardTypes.size>0||null!==this.state.selectedPriority||this.state.selectedTags.size>0||this.state.activeDocumentFilter)}}class Op{constructor(){oe(this,"subscriptions",new Map),oe(this,"subscriptionIdCounter",0),this.initializeSubscriptionMaps(),_e.debug("[DataSyncService] 服务已初始化")}initializeSubscriptionMaps(){["cards","decks","sessions","settings"].forEach(e=>{this.subscriptions.set(e,[])})}subscribe(e,t,n={}){const i="sub_"+ ++this.subscriptionIdCounter,a={id:i,callback:t,options:n},r=this.subscriptions.get(e);return r&&r.push(a),_e.debug(`[DataSyncService] 新订阅: ${e} (${i})`),()=>this.unsubscribe(e,i)}unsubscribe(e,t){const n=this.subscriptions.get(e);if(!n)return;const i=n.findIndex(e=>e.id===t);if(-1!==i){const a=n[i];a.debounceTimer&&clearTimeout(a.debounceTimer),n.splice(i,1),_e.debug(`[DataSyncService] 取消订阅: ${e} (${t})`)}}async notifyChange(e){var t;const n={...e,timestamp:Date.now()};_e.debug("[DataSyncService] 数据变更通知:",{type:n.type,action:n.action,ids:(null==(t=n.ids)?void 0:t.length)||0,metadata:n.metadata});const i=this.subscriptions.get(n.type);i&&0!==i.length?await Promise.all(i.map(e=>this.notifySubscription(e,n))):_e.debug(`[DataSyncService] 无订阅者: ${n.type}`)}async notifySubscription(e,t){e.options.filter&&!e.options.filter(t)||(e.options.debounce?(e.debounceTimer&&clearTimeout(e.debounceTimer),e.debounceTimer=window.setTimeout(async()=>{await this.executeCallback(e,t),e.debounceTimer=void 0},e.options.debounce)):await this.executeCallback(e,t))}async executeCallback(e,t){try{await e.callback(t)}catch(n){_e.error("[DataSyncService] 订阅回调执行失败:",n)}}getStats(){const e={};return this.subscriptions.forEach((t,n)=>{e[n]=t.length}),e}destroy(){this.subscriptions.forEach(e=>{e.forEach(e=>{e.debounceTimer&&clearTimeout(e.debounceTimer)})}),this.subscriptions.clear(),this.initializeSubscriptionMaps(),_e.debug("[DataSyncService] 服务已销毁")}}const Lp={"zh-CN":{analytics:{dashboard:{title:"统计分析",loading:"正在加载数据...",error:"数据加载失败",retry:"重试",refresh:"刷新",noData:"暂无数据",kpi:{todayReviews:"今日复习",todayNew:"今日新增",accuracy:"正确率",studyTime:"学习时长",memoryRate:"记忆率",streakDays:"连续天数",fsrsProgress:"FSRS进度",trend:{up:"上升",down:"下降",stable:"稳定",yesterdayCompare:"较昨日",newCardsAdded:"未学习加入"}},charts:{reviewTrend:"复习趋势（{days}天）",ratingDistribution:"评分分布",calendarHeatmap:"热力图（日历）",timeHeatmap:"时段热力（24h×7）",intervalGrowth:"间隔增长（周均 scheduledDays）",deckComparison:"牌组对比"},table:{deck:"牌组",reviews:"复习量",accuracy:"正确率",avgInterval:"平均间隔",avgDifficulty:"平均难度"},fsrs:{title:"FSRS6 算法分析",avgDifficulty:"平均难度",avgStability:"平均稳定性",difficultyScore:"FSRS难度评分",stabilityDays:"天数",retentionRate:"记忆保持率",learningEfficiency:"学习效率"}},timeRange:{last7Days:"最近7天",last30Days:"最近30天",last90Days:"最近90天",thisMonth:"本月",lastMonth:"上月",thisYear:"今年",custom:"自定义"},errors:{loadFailed:"数据加载失败",networkError:"网络连接错误",dataCorrupted:"数据损坏",insufficientData:"数据不足",calculationError:"计算错误"}},settings:{title:"设置",categories:{basic:"基础",fsrs6:"FSRS6算法",annotation:"标注同步",cardParsing:"批量解析",aiConfig:"AI服务",virtualization:"性能优化",dataManagement:"数据管理",ankiConnect:"Anki同步",about:"关于"},basic:{title:"基础设置",language:{label:"语言",chinese:"简体中文",english:"English",description:"选择界面显示语言"},defaultDeck:{label:"默认牌组",placeholder:"输入默认牌组名称",description:"未学习卡片默认添加到此牌组"},notifications:{label:"启用通知",description:"显示学习提醒和系统通知"},floatingButton:{label:"显示悬浮新建按钮",description:"在界面右下角显示快速新建按钮"},shortcuts:{label:"启用键盘快捷键",description:"学习模式的键盘快捷键（1-4评分，空格显示答案）"},debugMode:{label:"调试模式",description:"启用后将在浏览器控制台输出详细的调试日志信息",enabled:"调试模式已启用，控制台将输出详细日志",disabled:"调试模式已关闭"}},editor:{title:"编辑器窗口设置",enableResize:{label:"启用拖拽调整",description:"允许通过拖拽边框调整编辑窗口尺寸"},windowSize:{label:"窗口尺寸",description:"选择编辑窗口的默认大小"},rememberSize:{label:"记住上次尺寸",description:"下次打开时恢复上次的窗口大小"},sizePresets:{small:"小",medium:"中",large:"大",fullscreen:"全屏",custom:"自定义"}},learning:{title:"学习设置",reviewsPerDay:{label:"每日复习数量",description:"每天计划复习的卡片数量上限"},newCardsPerDay:{label:"每日未学习数量",description:"每天学习的未学习卡片数量上限"},learningSteps:{label:"学习步骤（分钟）",description:"用逗号分隔多个时间间隔",placeholder:"1, 10"},graduatingInterval:{label:"毕业间隔（天）",description:"卡片从学习阶段毕业后的初始复习间隔",placeholder:"1"},autoAdvance:{label:"自动前进",description:"评分后自动显示下一张卡片",delay:"延迟（秒）"}},siblingDispersion:{title:"兄弟卡片智能分散",saved:"兄弟卡片分散设置已保存",saveFailed:"保存失败，请重试",enabledNotice:"✅ 兄弟卡片智能分散已启用",resetToDefaults:"已重置为推荐配置",whatIs:"什么是兄弟卡片分散？",description:"渐进式挖空会为一张卡片创建多个子卡片（兄弟卡片）。为了避免记忆干扰，这些兄弟卡片不应在相近日期出现。",benefit:"✨ 启用后可提升学习效果，减少前摄干扰和倒摄干扰，符合认知科学研究和Anki最佳实践。",enable:{label:"启用智能分散",description:"自动管理兄弟卡片的学习日期，避免在同一学习会话或相近日期出现"},parameters:{title:"核心参数"},minSpacing:{label:"最小间隔天数",description:"兄弟卡片之间的最小时间间隔（推荐：5天）"},spacingPercentage:{label:"动态分散比例",description:"基于复习间隔的动态调整比例（推荐：5%）",hint:"💡 实际间隔 = max(最小间隔, 复习间隔 × 此比例)"},example:{title:"分散效果示例"},features:{title:"功能开关"},filterInQueue:{label:"队列生成时过滤",description:"避免同一学习会话中出现兄弟卡片（立即生效）",recommendation:"强烈推荐开启"},autoAdjustAfterReview:{label:"复习后动态调整",description:"复习后自动调整冲突的兄弟卡片due日期",recommendation:"推荐开启，持续优化"},respectFuzzRange:{label:"遵守FSRS的fuzz范围",description:"仅在FSRS的fuzz范围内调整，不破坏最优复习间隔",recommendation:"必须开启，确保科学性"},resetButton:"重置为推荐配置",resetHint:"基于Anki社区标准和CleverDeck最佳实践",science:{title:"科学依据",interference:{title:"记忆干扰理论",proactive:"前摄干扰",proactiveDesc:"先学习的内容干扰后学习内容的记忆",retroactive:"倒摄干扰",retroactiveDesc:"后学习的内容干扰先学习内容的记忆",consolidation:"记忆巩固",consolidationDesc:"新记忆需要时间才能稳固，相似内容连续学习会降低效果"},references:{title:"参考标准"},benefits:{title:"预期效果",retention:"提高长期记忆率",interference:"减少记忆干扰",efficiency:"提升学习效率",fsrs:"完美兼容FSRS算法"}}},navigation:{title:"导航可见性",description:"控制主界面导航项的显示"},cardParsing:{title:"批量解析配置",premiumPrompt:"批量解析功能可让您一次性处理多个文件或文件夹。升级到高级版以解锁此功能。",regexManagement:{title:"正则匹配管理",addMapping:"添加映射",presets:{defaultMode:"默认模式（新用户）",qaMode:"Q&A 模式",standardDivider:"标准分隔模式",basicMode:"初级模式",ankiExport:"Anki 导出模式"},tableHeaders:{type:"类型",path:"路径",filePrefix:"文件前缀",regexPattern:"正则匹配",targetDeck:"目标牌组",subfolders:"子文件夹",outerCover:"外层叠盖",enabled:"启用",actions:"操作"},actions:{enable:"启用",delete:"删除",edit:"编辑"}},preset:{title:"编辑正则预设",presetName:"预设名称",parseMode:"解析模式",cardSeparation:"卡片分隔方式",useCustomSeparator:"使用自定义分隔符",useLineSeparator:"使用全行分隔",cardSeparator:"卡片分隔符",frontBackSeparator:"正反面分隔符",syncMethod:"同步方法",excludeTags:"排除标签（逗号分隔）",parseModeOptions:{divider:"分隔符模式（简易）"}},dividerConfig:{title:"批量解析分隔符",regex:"正面/背面分隔符",regexDesc:"用于分隔卡片正面和背面内容的符号（默认：---div---）",marker:"挖空标记",markerDesc:"标记挖空内容的符号（默认：==）",cardSeparator:"卡片分隔符",cardSeparatorDesc:"在批量解析中分隔不同卡片的符号（默认：<->）"},systemExcludeTags:{label:"文件级别排除标签",value:"#we_已删除, #we_deleted",desc:"系统自动过滤带有这些标签的卡片文件（官方设置，不可修改）"},excludeTags:{title:"排除标签配置",label:"用户自定义排除标签",desc:"包含这些标签的卡片将被跳过（多个标签用逗号分隔，自动识别 # 符号）",placeholder:"skip"},fileMappings:{title:"文件夹牌组映射",folderDeckMapping:"Folder-Deck Mapping",desc:"配置文件夹到牌组的自动映射关系",addMapping:"添加映射"}},actions:{save:"保存",saved:"设置已保存",saveFailed:"保存设置失败",reset:"重置",cancel:"取消",confirm:"确认",close:"关闭"}},common:{loading:"加载中...",error:"错误",success:"成功",warning:"警告",info:"信息",confirm:"确认",cancel:"取消",save:"保存",delete:"删除",edit:"编辑",close:"关闭",retry:"重试",refresh:"刷新",reset:"重置",clear:"清空",search:"搜索",filter:"筛选",sort:"排序",export:"导出",import:"导入",settings:"设置",help:"帮助",about:"关于",notSet:"未设置",unknown:"未知",batchOperations:"批量操作",premiumFeature:"高级功能",time:{seconds:"{count} 秒",minutes:"{count} 分钟",hours:"{count} 小时",days:"{count} 天",manual:"手动"},timeUnits:{seconds:"{n} 秒",minutes:"{n} 分钟",hours:"{n} 小时",days:"{n} 天",weeks:"{n} 周",months:"{n} 个月",years:"{n} 年"},count:{items:"{count} 项",selected:"已选择 {count} 项"},validation:{required:"此字段为必填项",invalid:"输入无效"}},navigation:{deckStudy:"牌组学习",cardManagement:"卡片管理",aiAssistant:"AI制卡",analytics:"统计分析",switchView:"切换视图",createDeck:"新建牌组",moreActions:"更多操作"},celebration:{title:"恭喜！今日学习完成！",subtitle:"你已经完成了「{deckName}」的所有学习任务",stats:{title:"📊 今日学习成就",cardsStudied:"学习卡片",reviewed:"复习卡片",timeSpent:"学习时长",studyTime:"学习时长",accuracy:"正确率",memoryRate:"记忆率"},footer:{hint:"💫 可以继续学习其他牌组哦~",closeButton:"知道了"},timeFormat:{lessThan1Min:"< 1分钟",minutes:"{n}分钟",hoursMinutes:"{h}小时{m}分钟"}},navbar:{openSettings:"打开设置",settings:"设置",collapse:"收起导航栏",expand:"展开导航栏",collapseHint:"将鼠标移到此处展开导航栏"},rating:{again:"重来",hard:"困难",good:"良好",easy:"简单",show:"显示答案",undo:"撤销",seconds:"{n}秒",minutes:"{n}分钟",hours:"{n}小时",days:"{n}天",months:"{n}月",years:"{n}年"},notifications:{success:{cardSaved:"卡片已保存",cardDeleted:"卡片已删除",deckCreated:"牌组已创建",settingsUpdated:"设置已更新",syncCompleted:"同步完成",exportSuccess:"导出成功",importSuccess:"导入成功",backupCreated:"备份已创建",optimizationComplete:"参数优化完成"},error:{saveFailed:"保存失败",loadFailed:"加载失败",deleteFailed:"删除失败",syncFailed:"同步失败",connectionFailed:"连接失败",exportFailed:"导出失败",importFailed:"导入失败",validationFailed:"验证失败",unknownError:"发生未知错误"},warning:{unsavedChanges:"有未保存的更改",licenseExpiring:"许可证即将过期",licenseExpired:"许可证已过期",backupFailed:"备份失败",syncConflict:"同步冲突"},info:{loading:"加载中...",syncing:"同步中...",processing:"处理中...",generating:"AI生成中...",optimizing:"优化中..."}},menus:{context:{edit:"编辑",delete:"删除",duplicate:"复制",copy:"复制内容",moveTo:"移动到",addTags:"添加标签",removeTags:"移除标签",suspend:"暂停",unsuspend:"恢复",bury:"埋藏",unbury:"取消埋藏",flag:"标记",unflag:"取消标记"},tooltips:{clickToEdit:"点击编辑",doubleClickToView:"双击查看详情",dragToSort:"拖拽排序",rightClickForMore:"右键查看更多选项"}},studyInterface:{showAnswer:"显示答案",confirmAnswer:"确认答案",closeStudy:"关闭学习界面",ratings:{again:"重来",hard:"困难",good:"良好",easy:"简单"},intervals:{unknown:"未知",lessThan1Min:"< 1分钟",minutes:"{n}分钟",hours:"{n}小时",days:"{n}天",months:"{n}个月",years:"{n}年"},errors:{invalidCard:"卡片数据无效",invalidCardId:"卡片ID无效",invalidFields:"字段数据结构无效",renderError:"渲染错误",noContent:"无内容",processingError:"处理错误",defaultFieldFailed:"默认字段处理失败",degradedFieldFailed:"降级字段处理失败"},labels:{error:"错误",statsDetails:"统计情况详情",noTemplates:"未找到可用模板",setReminder:"设置复习提醒",setPriority:"设置优先级"},progress:{ariaLabel:"学习进度",newCards:"未学习 {n} 张",learning:"学习中 {n} 张",review:"待复习 {n} 张",mastered:"已掌握 {n} 张",total:"总计 {n} 张卡片"},actions:{return:"返回",regenerate:"重新生成",collect:"收入 ({n})",undo:"撤销"}},cardManagement:{more:"更多",search:"搜索",viewModes:{title:"视图",table:"表格视图",grid:"网格视图",kanban:"看板视图"},layout:{title:"布局",fixed:"固定高度",waterfall:"瀑布流"},gridAttributeSelector:{tooltip:"卡片属性显示",title:"左上角显示属性",none:"不显示",uuid:"唯一标识符",source:"来源文档",priority:"优先级",retention:"记忆程度",modified:"修改时间"},density:{title:"密度",compact:"紧凑",comfortable:"舒适",spacious:"宽敞"},tools:{title:"工具",scanOrphans:"扫描孤儿卡片",fieldManagement:"字段管理",columnSettings:"列设置"},filters:{showAll:"显示全部",appliedFilters:"已应用筛选条件",clearAll:"清除所有筛选",deck:"牌组",priority:"优先级",time:"时间"},empty:{hint:"请添加卡片或调整筛选条件"},batchToolbar:{selected:"已选择 {count} 张卡片",copy:"复制",changeDeck:"更换牌组",changeTemplate:"更换模板（暂不可用）",addTags:"添加标签",removeTags:"删除标签"},batchDelete:{confirm:"确定要删除选中的 {count} 张卡片吗？此操作不可撤销。"}},deckStudyPage:{deckTypes:{choice:"选择题"},urgency:{urgent:"紧急",completed:"完成"},moreActions:"更多操作",tableHeaders:{deckName:"牌组名称",newCards:"未学习",learning:"学习中",review:"待复习",actions:"操作"}},filters:{loading:"加载筛选数据...",sections:{decks:"牌组筛选",types:"题型筛选",priority:"优先级",tags:"标签筛选",time:"时间筛选"},allDecks:"全部牌组",noTags:"暂无标签",clearAll:"清除所有筛选",myFilters:"我的筛选",manage:"管理",cardTypes:{qa:"问答题",choice:"选择题",fill:"填空题",cloze:"挖空题"},priorities:{all:"全部",high:"高优先级",medium:"中优先级",low:"低优先级",none:"无优先级"},timeFilters:{all:"全部",today:"今天",dueToday:"今天到期",addedToday:"今天添加",editedToday:"今天编辑",reviewedToday:"今天复习",firstReview:"首次复习",retryToday:"今天重来",neverReviewed:"从未复习"},status:{new:"未学习",learning:"学习中",review:"复习中",mastered:"已掌握"},advancedBuilder:{title:"高级筛选构建器",addGroup:"添加条件组",addCondition:"添加条件",removeGroup:"删除组",results:"筛选结果",calculating:"计算中",cards:"张卡片",apply:"应用",save:"保存",cancel:"取消",enableCondition:"点击启用此条件",disableCondition:"点击禁用此条件"}},ui:{cancel:"取消",confirm:"确认",delete:"删除",save:"保存",edit:"编辑",close:"关闭",closeNotification:"关闭通知",newCard:"新建卡片",progressBar:"进度条",hideMonitor:"隐藏监控器",technicalDetails:"技术详情",metrics:{memoryUsage:"内存使用",cacheHitRate:"缓存命中率",throughput:"吞吐量",networkLatency:"网络延迟",errorRate:"错误率"},pagination:{previous:"上一页",next:"下一页",page:"第 {n} 页",total:"共 {n} 张卡片"},tables:{loading:"加载中...",empty:"暂无数据",selectAll:"全选"}},tables:{card:{loading:"正在加载卡片...",empty:"暂无卡片"}},fsrs:{title:"FSRS6算法设置",description:"配置间隔重复学习算法参数",savedMessage:"FSRS6设置已保存",saveFailed:"保存设置失败",basicParams:{title:"基础参数",retention:{label:"目标记忆率",description:"期望的长期记忆保持率（0.5-0.99）"},maxInterval:{label:"最大间隔",description:"卡片复习的最大间隔天数"},enableFuzz:{label:"启用随机化",description:"在计算的间隔基础上添加随机波动"}},advancedSettings:{title:"高级设置",weights:{title:"权重参数",description:"FSRS6算法的21个权重参数，影响记忆预测的准确性",allowEdit:"允许编辑",locked:'权重参数已锁定，启用"允许编辑"开关以修改参数',warning:"⚠️ 修改权重参数可能影响学习效果，请谨慎操作",reset:"重置默认"}},optimization:{title:"智能优化",description:"基于您的学习数据自动调优FSRS6参数",overview:{title:"优化概览",description:"点击FSRS6标准模型来优化算法性",algorithmVersion:"算法版本",systemVersion:"系统版本",reviewRecords:"复习记录",optimizationResult:"优化结果",consecutiveParams:"连续参数",dataPoints:"数据点",refresh:"刷新"},dataPoints:"数据点数量",accuracy:"预测准确性",status:"优化状态",statusReady:"就绪",statusOptimizing:"优化中...",startButton:"开始优化",optimizingButton:"优化中...",complete:"参数优化完成",failed:"参数优化失败"},performance:{title:"性能监控",description:"实时监控FSRS6算法的运行状态和性能指标",refresh:"刷新",algorithmVersion:"算法版本",executionTime:"执行时间",cacheHitRate:"缓存命中率",activeInstances:"活跃实例",noData:"点击刷新按钮获取性能指标"},parameters:{title:"算法参数",targetRetention:{label:"目标记忆率",description:"期望的长期记忆保持率（0.5-0.99）",placeholder:"例如：0.9表示90%记忆率"},maxInterval:{label:"最大间隔",description:"两次复习之间的最长天数",unit:"天"}},actions:{reset:"重置为默认值",import:"导入参数",export:"导出参数",save:"保存参数",cancel:"取消"}},annotation:{title:"Tuanki 标注系统",sectionTitle:"Tuanki标注功能",description:"基于文档标注快速创建卡片，提高制卡效率",requireLicense:"此功能需要激活许可证后使用",features:{title:"激活后您将获得",feature1:"🎨 网格视图",feature2:"📋 看板视图",feature3:"📊 统计分析",feature4:"✍️ 标注块同步",feature5:"🔄 批量解析",feature6:"🤖 AI制卡",feature7:"📚 刷题牌组（开发中）",feature8:"📖 渐进式阅读（敬请期待）"},activateButton:"前往激活",settings:{saved:"设置已保存",failed:"设置保存失败，请重试"},autoDetection:{label:"启用自动检测",description:"实时监听文档变更，自动检测新的标注"},debounceDelay:{label:"防抖延迟",description:"标注变更后等待时间，避免频繁触发",unit:"毫秒"},maxConcurrent:{label:"最大并发处理数",description:"同时处理的标注任务数量，影响处理速度和系统负载"},bidirectionalSync:{label:"启用双向同步",description:"标注块与卡片内容自动双向同步（建议开启）",enabled:"双向同步已开启",disabled:"双向同步已关闭"},onlyActiveFile:{label:"仅同步活动文件",description:"只同步当前打开的文件，减少系统负载",enabled:"仅同步活动文件已开启",disabled:"仅同步活动文件已关闭"},sync:{title:"同步选项",autoSync:{label:"自动同步",description:"自动监控文件变化并同步到卡片"},syncInterval:{label:"同步间隔",description:"检查文件变化的时间间隔",unit:"秒"},twoWaySync:{label:"双向同步",description:"卡片内容更改时同步回标注块"},syncOnlyActive:{label:"仅同步活动文件",description:"只同步当前打开的文件，减少性能影响"}},monitoring:{title:"文件监控",detectDelay:{label:"检测延迟",description:"文件变化后等待时间，避免频繁触发",unit:"毫秒"}},advanced:{title:"高级选项",maxConcurrent:{label:"最大并发处理数",description:"同时处理的文件数量"},autoCreateDeck:{label:"自动创建牌组",description:"根据文件路径自动创建对应的牌组"}},actions:{syncAllDocuments:"同步所有文档",syncCurrent:"同步当前文档",syncSelected:"同步选中的文档"}},parsing:{title:"卡片解析设置",description:"配置Markdown文件的卡片批量解析规则",batchParsing:{title:"批量解析",enable:{label:"启用批量解析",description:"扫描文件中的卡片标记并批量创建"},markers:{title:"解析标记",startMarker:{label:"开始标记",description:"批量解析的起始标记",default:"---start---"},endMarker:{label:"结束标记",description:"批量解析的结束标记",default:"---end---"}}},cloze:{title:"挖空语法",defaultSyntax:{label:"默认语法",markdown:"Markdown高亮（==文本==）",anki:"Anki格式（{{c1::文本}}）"},autoDetect:{label:"自动检测",description:"自动检测并支持两种语法"}}},aiConfig:{title:"",description:"",providers:{title:"AI提供商",openai:"OpenAI",gemini:"Google Gemini",anthropic:"Anthropic Claude",deepseek:"DeepSeek",zhipu:"智谱清言",siliconflow:"硅基流动",xai:"xAI Grok",select:"选择提供商"},apiKeys:{title:"API密钥配置",apiKeyLabel:"API密钥",apiKeyDescription:"输入您的{provider} API密钥",modelLabel:"模型",modelDescription:"选择要使用的AI模型",testConnection:"测试连接",testing:"测试中...",testSuccess:"连接成功！",testFailed:"API密钥未配置",show:"显示",hide:"隐藏",verified:"已验证",defaultBadge:"🎯 默认",formattingBadge:"📝 格式化",splittingBadge:"🔀 AI拆分",menuLabel:"提供商配置菜单",configOptions:"配置选项"},models:{title:"模型选择",select:"选择模型",recommended:"推荐",custom:"自定义模型",customPlaceholder:"输入自定义模型名称 (如: gpt-4o-2024-05-13)",customHint:"请输入完整的模型名称，如API文档中所示",validationError:"模型名称格式错误",validationWarning:"建议使用官方模型名称格式"},promptTemplates:{title:"提示词模板管理",official:{title:"官方模板",count:"{n} 个",badge:"官方",viewDetail:"查看详情"},custom:{title:"自定义模板",count:"{n} 个",create:"新建模板",edit:"编辑",delete:"删除",deleteConfirm:"确定要删除这个模板吗？"},modal:{createTitle:"新建模板",editTitle:"编辑模板",name:"模板名称",namePlaceholder:"例如：标准问答生成",content:"提示词内容",contentHelper:"使用 {变量名} 来定义可替换的变量，例如：{count}, {difficulty}",contentPlaceholder:"请根据以下内容生成{count}张问答卡片...",detectedVariables:"检测到的变量",variables:"变量：",cancel:"取消",save:"保存"}},globalParams:{temperature:{label:"Temperature",description:"控制AI响应的随机性。值越低越确定，越高越创造性。推荐范围：0.5-1.0"},maxTokens:{label:"最大Token数",description:"单次请求的最大Token数量。推荐范围：1000-4000"},requestTimeout:{label:"请求超时时间",description:"API请求超时时间（秒）。推荐：30-60秒"},concurrentLimit:{label:"并发请求限制",description:"同时发送的最大请求数。推荐：1-5"}},imageGeneration:{defaultSyntax:{label:"默认图片语法",description:"选择插入图片时使用的默认语法格式",wiki:"Wiki链接 (![[image.png]])",markdown:"Markdown (![](image.png))"},attachmentDir:{label:"附件保存目录",description:"AI生成的图片将保存到这个目录下",placeholder:"attachments/ai-generated"},autoCreateSubfolders:{label:"自动创建子文件夹",description:"按日期自动创建子文件夹组织图片"},includeTimestamp:{label:"文件名包含时间戳",description:"在图片文件名中包含生成时间戳"},includeCaption:{label:"自动添加图片说明",description:"在图片下方自动添加AI生成的说明文字"}},cardSplitting:{title:"AI拆分卡片配置",enabled:{label:"启用AI拆分",description:"在学习界面中显示AI拆分按钮，可将复杂卡片拆分为多张子卡片"},defaultTargetCount:{label:"默认生成数量",description:"设置AI拆分时默认生成的子卡片数量（0 = 让AI自动决定，通常2-5张）"},minContentLength:{label:"最小内容长度",description:"只有内容长度达到此值的卡片才可以进行拆分（字符数）"},maxContentLength:{label:"最大内容长度",description:"超过此长度的卡片内容将被截断后再拆分（字符数）"},autoInheritTags:{label:"自动继承标签",description:"子卡片自动继承父卡片的所有标签"},autoInheritSource:{label:"自动继承来源信息",description:"子卡片自动继承父卡片的Obsidian来源文档和块链接"},requireConfirmation:{label:"收入前确认",description:"收入子卡片到牌组前需要用户确认（推荐开启）"},defaultInstruction:{label:"默认拆分指令（可选）",description:'自定义AI拆分的额外指令，例如："重点关注定义和例子"（留空则使用默认指令）',placeholder:"输入自定义拆分指令...",allowEdit:"允许编辑提示词",locked:"默认提示词已锁定，点击开关解锁编辑",usingDefault:"当前使用系统默认提示词（留空则自动使用）",warning:"⚠️ 自定义提示词会影响AI拆分效果，取决于提示词质量和AI模型",viewDefault:"📖 查看系统默认提示词",defaultPromptContent:'你是一个专业的学习卡片拆分助手，遵循"最小信息原则"。\n\n你的任务是将一张包含多个知识点的父卡片拆分为多张独立的子卡片。每张子卡片应该只包含一个清晰的知识点。\n\n拆分原则：\n1. 每张子卡片只包含一个核心概念或知识点\n2. 保持子卡片的独立性和完整性\n3. 子卡片应该可以独立复习和理解\n4. 保留必要的上下文，但避免重复信息\n5. 保持原有的格式风格和表达方式\n\n输出格式（JSON）：\n{\n  "cards": [\n    {\n      "front": "问题或提示",\n      "back": "答案或解释",\n      "tags": ["可选标签"],\n      "explanation": "可选的额外说明"\n    }\n  ]\n}'}}},dataManagement:{title:"数据管理",description:"管理插件数据的导入、导出和备份",panelTitle:"数据管理主面板组件",panelDescription:"集成所有数据管理功能的统一界面",initFailed:"服务初始化失败",refreshFailed:"刷新失败，请重试",confirmPhrase:"确认操作",resetConfirmPhrase:"确认重置",importExport:{title:"导入导出",import:{title:"导入数据",button:"导入",selectFile:"选择文件",importing:"导入中...",success:"数据导入成功",successDetail:"导入: {imported} 条，跳过: {skipped} 条",failed:"导入失败",confirm:"确定要导入数据吗？此操作将覆盖现有数据！",details:{fileName:"文件名: {name}",fileSize:"文件大小: {size} MB",autoBackup:"导入前将自动创建备份"},warnings:{override:"现有数据可能被覆盖",format:"请确保导入文件格式正确",backup:"建议先创建手动备份"}},export:{title:"导出数据",button:"导出",exporting:"导出中...",success:"数据导出成功",successDetail:"文件: {path}",failed:"导出失败",confirm:"确定要导出所有数据吗？",details:{all:"将导出所有牌组和卡片数据",records:"包含学习记录和用户设置",format:"生成JSON格式的导出文件"}}},backup:{title:"数据备份",latest:{title:"载新备份",lastGenerated:"最后生成",dataFolder:"数据文件夹",justNow:"刚刚",stats:{totalSize:"总大小",deckCount:"牌组数量",cardTotal:"卡片总量",backupCount:"保存总数"}},history:{title:"备份历史",tableHeaders:{backupTime:"备份时间",backupType:"备份方式",backupSize:"备份大小",actions:"操作"},type:{manual:"手动",auto:"自动"},actions:{restore:"恢复",delete:"删除",export:"导出"}},operations:{integrityCheck:"完整性检查",exportData:"导出数据",importData:"导入数据",clearAll:"直接清空",createBackup:"立即备份"},auto:{title:"自动备份配置",description:"定期自动创建数据备份，保护您的学习数据安全",enable:"启用自动备份",enableDesc:"定期自动创建数据备份",interval:"备份间隔",intervalDesc:"自动备份的时间间隔（1-168 小时）",intervalUnit:"小时",triggers:{title:"触发条件",onStartup:"启动时备份",onStartupDesc:"插件启动时自动创建备份",onCardThreshold:"卡片数量阈值备份",onCardThresholdDesc:"卡片数量变化达到阈值时自动备份",thresholdCount:"阈值数量",thresholdCountDesc:"卡片数量变化达到此值时触发备份",thresholdUnit:"张卡片"}},manual:{title:"手动备份",label:"手动备份",create:"立即备份",creating:"备份中...",success:"备份创建成功",successDetail:"大小: {size} MB",failed:"创建备份失败"}}},ankiConnect:{title:"AnkiConnect 同步",sectionTitle:"Anki同步设置",description:"连接到 Anki 桌面应用，实现双向卡片同步",enable:{label:"启用 AnkiConnect",description:"连接到 Anki 桌面应用，实现双向卡片同步"},connection:{title:"连接管理",status:"连接状态",statusLabel:{connected:"已连接",disconnected:"未连接",testing:"测试中..."},testConnection:"测试连接",address:{label:"AnkiConnect 地址",placeholder:"http://localhost:8765",description:"AnkiConnect API的地址"}},autoSync:{title:"自动同步配置",enable:"启用自动同步",enableDesc:"在文档变化时自动同步到Anki"},deckSync:{title:"牌组同步配置",enable:"启用牌组同步",enableDesc:"同步牌组数据到Anki",description:"配置 Tuanki 牌组与 Anki 牌组的映射关系",apiV6:"可选: 启用 API v6",discovered:"已发现 {count} 张 Anki 牌组",configureMapping:"配置映射"},sectionSync:{title:"板块同步配置",enable:"启用板块同步",enableDesc:"同步板块内容到Anki"}},virtualization:{title:"性能优化",description:"配置虚拟滚动和渲染优化，提升大量卡片时的性能表现",resetConfirm:"确定要重置所有虚拟化设置为默认值吗？",resetButton:"重置为默认",kanban:{title:"看板视图设置",enableVirtualScroll:{label:"启用虚拟滚动",description:"在看板列内启用虚拟滚动，大幅提升大量卡片时的性能（推荐 >200 张卡片时启用）"},enableColumnVirtualization:{label:"列内虚拟化",description:"单独对每一列启用虚拟滚动（关闭后仍可使用渐进加载）"},overscan:{label:"预渲染数量 (Overscan)",description:"视口外预渲染的卡片数量，增加可减少滚动时的白屏，但会占用更多内存"},initialBatchSize:{label:"初始加载数量",description:"每列初始加载的卡片数量（非虚拟化模式下有效）"},loadMoreBatchSize:{label:"批量加载数量",description:'点击"加载更多"时一次加载的卡片数量'}},table:{title:"表格视图设置",enableVirtualScroll:{label:"启用虚拟滚动",description:"在表格视图启用虚拟滚动（当前默认使用分页）"},enableTableVirtualization:{label:"启用表格虚拟滚动",description:"对表格行启用虚拟滚动（需先启用虚拟滚动）"},paginationThreshold:{label:"分页阈值",description:"少于此数量时使用分页而非虚拟滚动（推荐 500）"}},advanced:{title:"高级选项",cacheItemHeight:{label:"缓存测量高度",description:"缓存卡片的测量高度以提升性能（推荐开启）"},estimatedItemHeight:{label:"估算项目高度",description:"虚拟滚动的初始高度估算值（像素）"},resetSettings:{label:"重置设置",description:"将所有虚拟化设置重置为默认值"}},tips:{title:"性能优化提示",tip1:"虚拟滚动在卡片数量超过 200 张时自动启用，无需手动干预",tip2:"增加 Overscan 值可减少滚动时的白屏，但会增加内存占用",tip3:"表格视图推荐使用分页模式，除非需要快速浏览大量数据",tip4:"启用高度缓存可显著提升滚动性能，但会占用少量内存"}},decks:{dashboard:{emptyHint:"该分类暂无牌组，创建新牌组时可为其分配分类",unit:"张",study:"学习",completed:"完成",startStudy:"开始学习",viewCelebration:"查看庆祝",moreActions:"更多操作"},card:{ariaLabel:"牌组: {name}",new:"未",learning:"学",review:"复"},grid:{emptyText:"该分类暂无牌组",emptyHint:"创建新牌组时可为其分配分类",parentDeck:"父卡片牌组",childDeck:"子卡片牌组"},menu:{createSubdeck:"创建子牌组",moveDeck:"移动牌组",moveCategory:"移动分类",edit:"编辑",delete:"删除",refreshData:"刷新数据"}},studyInfo:{fsrs:{title:"FSRS算法信息",version:"FSRS 5/6",description:"FSRS (Free Spaced Repetition Scheduler) 是一个基于记忆模型的间隔重复算法，能够更精确地预测遗忘时间并优化复习间隔。"},today:{title:"今日学习",unit:"张卡",studied:"已学习",new:"新增",review:"复习",reviewCount:"复习次数"},smartTips:{title:"智能提示",shortMemory:"智能短时记忆",forgetPredict:"预测遗忘优化",sameDayOptimize:"同日复习优化"},currentCard:{title:"当前卡片",type:"类型",reps:"复习次数",lapses:"遗忘次数"}},toolbar:{unknownDeck:"未知牌组",sourceNotFound:"未找到源文档",sourceNotExist:"源文档不存在",blockNotFound:"未找到块链接",sourceDeleted:"源文档已被删除",jumpedToSource:"已跳转到源文档",openedSource:"已打开源文档",noSourceLinked:"该卡片未关联源文档",sourceDoc:"源文档",currentCard:"当前卡片",saveAndPreview:"保存并预览",editCard:"编辑卡片",preview:"预览",edit:"编辑",plainTextEditor:"普通文本编辑器",textEdit:"文本编辑",deleteCard:"删除卡片",delete:"删除",setReminder:"设置提醒",reminder:"提醒",setPriority:"设置优先级",priority:"优先级",changeDeck:"更换牌组",deck:"牌组",deckList:"牌组列表",currentDeck:"当前牌组",availableDecks:"可用牌组",viewCardInfo:"查看卡片信息与来源",cardInfoAndSource:"卡片信息与来源",belongToDeck:"所属牌组",cardState:"卡片状态",stateNew:"新",stateLearning:"学习中",stateReview:"复习中",stateRelearning:"重学中",stateUnknown:"未知",graphLink:"图谱联动",graphLinkEnabled:"关闭图谱联动",graphLinkDisabled:"开启图谱联动",graphLinkSuccess:"✅ 图谱联动已开启\n切换卡片时图谱会自动更新",graphLinkClosed:"图谱联动已关闭",noSourceFile:"⚠️ 当前卡片没有来源文档",sourceFileNotExist:"⚠️ 来源文档不存在",graphLinkInitFailed:"❌ 图谱联动初始化失败"},modals:{viewCard:{title:"卡片详情",tabInfo:"卡片基本信息",tabStats:"复习数据",tabCurve:"记忆曲线图",loading:"加载中...",unknownTemplate:"未知模板",noDeck:"无牌组"},moveDeck:{title:"移动牌组",moveToNew:"将 {name} 移动到新位置",searchPlaceholder:"搜索目标牌组...",selectTarget:"选择目标位置",rootOption:"顶级（无父牌组）",rootDesc:"升级为根级牌组",moveToRoot:"移动为顶级牌组",cancel:"取消",confirm:"确认移动"},saveFilter:{title:"保存筛选器",name:"名称",namePlaceholder:"请输入筛选器名称",nameError:"请输入筛选器名称",nameTooLong:"名称不能超过50个字符",description:"描述",descriptionPlaceholder:"可选",icon:"图标",color:"颜色",pinToSidebar:"固定到侧边栏",cancel:"取消",save:"保存",iconFilter:"筛选器",iconStar:"星标",iconBookmark:"书签",iconTag:"标签",iconHeart:"喜欢",iconFlag:"旗帜",iconCircleDot:"圆点",iconCheckCircle:"勾选",iconClock:"时钟",iconCalendar:"日历",iconBook:"书籍",iconLayers:"分层",colorBlue:"蓝色",colorTheme:"主题色",colorPink:"粉色",colorRed:"红色",colorOrange:"橙色",colorGreen:"绿色",colorCyan:"青色",colorGray:"灰色"},batchAddTags:{title:"批量添加标签",inputPlaceholder:"输入标签并按回车...",suggestions:"建议",cancel:"取消",confirm:"确认添加"},batchRemoveTags:{title:"批量删除标签",info:"从选中的 {count} 张卡片中删除标签",selectAll:"全选",clearAll:"清空",noTags:"所选卡片没有标签",cancel:"取消",confirm:"确认删除"},batchDeckChange:{title:"批量更换牌组",operationType:"选择操作类型：",move:"移动",moveDesc:"将 {count} 张卡片移动到新牌组",copy:"复制",copyDesc:"复制 {count} 张卡片到新牌组（保留原卡片）",searchPlaceholder:"搜索牌组...",selectDeck:"选择牌组: {name}",cancel:"取消",confirm:"确认"},cardInfoTab:{copyUUID:"UUID已复制到剪贴板",noSource:"此卡片没有关联的源文档",sourceDeleted:"源文档已被删除",jumpedToSource:"已跳转到源文档",openedSource:"已打开源文档",basicInfo:"基础信息",uuid:"UUID",deckLabel:"所属牌组",templateLabel:"使用模板",createdAt:"创建时间",updatedAt:"最后编辑",sourceInfo:"来源信息",sourceFile:"来源文件",sourceBlock:"来源块",notLinked:"未关联",viewSource:"查看源文档",tags:"标签",noTags:"暂无标签",customFields:"自定义字段",noCustomFields:"暂无自定义字段"},reviewStatsTab:{coreMetrics:"核心指标",totalReviews:"总复习次数",lapses:"遗忘次数",successRate:"正确率",avgResponseTime:"平均答题时间",times:"次",seconds:"秒",fsrsMetrics:"FSRS指标",stability:"稳定性",difficulty:"难度",retrievability:"可提取性",days:"天",reviewHistory:"复习历史",noHistory:"暂无复习记录",schedulingInfo:"调度信息",currentInterval:"当前间隔",nextReview:"下次复习",notScheduled:"未安排"},memoryCurveTab:{title:"记忆曲线",description:"记忆曲线图显示",noData:"暂无数据",timeRange:"时间范围：",range7d:"7天",range30d:"30天",range90d:"90天",rangeAll:"全部",legend:{predicted:"预测曲线 - 基于FSRS算法的理论遗忘曲线",actual:"实际曲线 - 基于真实复习记录的表现",review:"复习点 - 实际复习时刻的记忆状态"},emptyState:{title:"数据不足",description:"至少需要2次复习记录才能生成记忆曲线",reviewCount:"当前复习次数：{count}"},insights:{title:"曲线解读",forgetting:{title:"遗忘曲线",description:"记忆随时间自然衰退，稳定性越高，曲线越平缓"},optimalTiming:{title:"最佳复习时机",description:"当可提取性降至70-80%时复习效果最佳"},stabilityGrowth:{title:"稳定性增长",description:"成功复习会显著提升稳定性，延长下次间隔"},lapsesImpact:{title:"遗忘影响",description:"遗忘会降低稳定性，但有助于长期记忆"}},summary:{dataPoints:"数据点数量",reviewMarkers:"复习标记",currentStability:"当前稳定性",currentRetrievability:"当前可提取性",pointsUnit:"个",daysUnit:"天"}},apkgImport:{title:"APKG导入",selectFile:"请选择 .apkg 文件",invalidFile:"请选择 .apkg 文件",importing:"导入中...",importComplete:"导入完成",importFailed:"导入失败",stages:{parsing:"解析文件",media:"导入媒体",cards:"导入卡片",finalizing:"完成"}},fileSelector:{title:"选择文件",rootFolder:"根目录",selectAll:"全选",deselectAll:"取消全选",selected:"已选择 {count} 个文件",confirm:"确认",cancel:"取消"},cardPreview:{title:"卡片预览",back:"返回",close:"关闭",selectCard:"选择此卡片",modifyRequirement:"修改生成要求",collapseDialog:"收起对话",prevCard:"上一张",nextCard:"下一张",selectAll:"全选",deselectAll:"取消全选",selected:"已选择",cardsUnit:"张",importTo:"导入到",importCards:"导入 {count} 张卡片",importing:"导入中...",generating:"正在生成",generatingProgress:"正在生成 {current}/{total}"},batchTemplateChange:{title:"批量更换模板",selectTemplate:"选择新模板",confirm:"确认更换",cancel:"取消"},createDeck:{titleCreate:"新建牌组",titleEdit:"编辑牌组",titleCreateSub:"新建子牌组",parentDeck:"父牌组（可选）",noParent:"无（创建根牌组）",willCreateAs:"将创建为「{parent}」的子牌组",name:"名称",namePlaceholder:"例如：计算机科学",description:"描述",descriptionPlaceholder:"可选",category:"分类（可多选）",categoryLoading:"加载分类中...",categorySelected:"已选择 {count} 个分类",categoryDisabled:"子牌组不支持分类，跟随父牌组的分类",deckType:"牌组类型",deckTypeMixed:"混合题型",deckTypeMixedDesc:"可以添加所有类型的卡片",deckTypeChoice:"选择题专用",deckTypeChoiceDesc:"只能添加选择题类型的卡片",deckTypeHint:"此牌组只能添加选择题类型的卡片",cancel:"取消",create:"创建",save:"保存",close:"关闭",initFailed:"初始化失败，请重试",createFailed:"创建牌组失败: {error}"}},commands:{formatAsCloze:{name:"格式化为渐进式挖空",noSelection:"⚠️ 请先选中要格式化的文本",success:"✅ 已格式化为渐进式挖空，请输入序号（如 1, 2, 3）",error:"❌ 格式化失败，请重试"}},about:{title:"关于Tuanki",product:{name:"Tuanki - 智能记忆卡片插件",productName:"产品名称",version:"版本号",versionLabel:"版本",algorithm:"核心算法",algorithmValue:"FSRS6 (Free Spaced Repetition Scheduler v6.1.1)",platform:"适用平台",platformValue:"Obsidian",developer:"开发者",developerValue:"Tuanki 团队",licenseMode:"许可模式",licenseModeValue:"完全免费 + 高级功能许可证",description:"基于FSRS6算法的智能间隔重复学习系统"},quickLinks:{title:"快捷链接",openSource:"完全开源",documentation:"查看文档",changelog:"更新日志",support:"联系支持"},acknowledgments:{title:"特别鸣谢",fsrs:"FSRS算法",fsrsDesc:"FSRS算法团队",obsidian:"Obsidian",obsidianDesc:"Obsidian平台支持",anki:"Anki",ankiDesc:"Anki项目启发",community:"SamuelKreatorsz",communityDesc:"社区贡献者"},license:{title:"许可证信息",status:"状态",statusActive:"高级功能已激活",statusInactive:"高级功能未激活",type:"类型",manage:"管理",activation:{title:"许可证激活",code:"激活码",placeholder:"输入许可证激活码",activate:"激活",activating:"激活中..."}},contact:{title:"联系方式",github:"GitHub仓库",email:"联系邮箱",support:"技术支持",website:"官方网站"}},license:{boundEmail:"绑定邮箱",activatedDevices:"已激活设备",activationPrompt:"激活后解锁更多强大功能",getActivationCode:"获取激活码",activatePremium:"激活高级功能"}},"en-US":{analytics:{dashboard:{title:"Analytics Dashboard",loading:"Loading data...",error:"Failed to load data",retry:"Retry",refresh:"Refresh",noData:"No data available",kpi:{todayReviews:"Today Reviews",todayNew:"Today New",accuracy:"Accuracy",studyTime:"Study Time",memoryRate:"Memory Rate",streakDays:"Streak Days",fsrsProgress:"FSRS Progress",trend:{up:"Up",down:"Down",stable:"Stable",yesterdayCompare:"vs Yesterday",newCardsAdded:"New cards added"}},charts:{reviewTrend:"Review Trend ({days} days)",ratingDistribution:"Rating Distribution",calendarHeatmap:"Calendar Heatmap",timeHeatmap:"Time Heatmap (24h×7)",intervalGrowth:"Interval Growth (Weekly Avg)",deckComparison:"Deck Comparison"},table:{deck:"Deck",reviews:"Reviews",accuracy:"Accuracy",avgInterval:"Avg Interval",avgDifficulty:"Avg Difficulty"},fsrs:{title:"FSRS6 Algorithm Analysis",avgDifficulty:"Avg Difficulty",avgStability:"Avg Stability",difficultyScore:"FSRS Difficulty Score",stabilityDays:"Days",retentionRate:"Retention Rate",learningEfficiency:"Learning Efficiency"}},timeRange:{last7Days:"Last 7 Days",last30Days:"Last 30 Days",last90Days:"Last 90 Days",thisMonth:"This Month",lastMonth:"Last Month",thisYear:"This Year",custom:"Custom"},errors:{loadFailed:"Failed to load data",networkError:"Network connection error",dataCorrupted:"Data corrupted",insufficientData:"Insufficient data",calculationError:"Calculation error"}},settings:{title:"Settings",categories:{basic:"Basic",fsrs6:"FSRS6 Algorithm",annotation:"Annotation Sync",cardParsing:"Batch Parsing",aiConfig:"AI Card Creation",virtualization:"Performance",dataManagement:"Data Management",ankiConnect:"Anki Sync",about:"About"},basic:{title:"Basic Settings",language:{label:"Language",chinese:"简体中文",english:"English",description:"Select interface language"},defaultDeck:{label:"Default Deck",placeholder:"Enter default deck name",description:"New cards will be added to this deck by default"},notifications:{label:"Enable Notifications",description:"Show study reminders and system notifications"},floatingButton:{label:"Show Floating Create Button",description:"Display quick create button at bottom-right corner"},shortcuts:{label:"Enable Keyboard Shortcuts",description:"Keyboard shortcuts for study mode (1-4 for rating, Space to show answer)"},debugMode:{label:"Debug Mode",description:"Output detailed debug logs to browser console",enabled:"Debug mode enabled, detailed logs will be shown in console",disabled:"Debug mode disabled"}},editor:{title:"Editor Window Settings",enableResize:{label:"Enable Drag to Resize",description:"Allow resizing editor window by dragging borders"},windowSize:{label:"Window Size",description:"Default size for editor window"},rememberSize:{label:"Remember Last Size",description:"Restore previous window size on next open"},sizePresets:{small:"Small",medium:"Medium",large:"Large",fullscreen:"Fullscreen",custom:"Custom"}},learning:{title:"Learning Settings",reviewsPerDay:{label:"Reviews Per Day",description:"Maximum number of cards to review per day"},newCardsPerDay:{label:"New Cards Per Day",description:"Maximum number of new cards to learn per day"},learningSteps:{label:"Learning Steps (minutes)",description:"Separate multiple intervals with commas",placeholder:"1, 10"},graduatingInterval:{label:"Graduating Interval (days)",description:"Initial review interval after graduating from learning",placeholder:"1"},autoAdvance:{label:"Auto Advance",description:"Automatically show next card after rating",delay:"Delay (seconds)"}},siblingDispersion:{title:"Intelligent Sibling Dispersion",saved:"Sibling dispersion settings saved",saveFailed:"Failed to save, please try again",enabledNotice:"✅ Intelligent sibling dispersion enabled",resetToDefaults:"Reset to recommended configuration",whatIs:"What is Sibling Dispersion?",description:"Progressive cloze creates multiple child cards (siblings) for one card. To avoid memory interference, these sibling cards should not appear on similar dates.",benefit:"✨ When enabled, it improves learning effectiveness by reducing proactive and retroactive interference, based on cognitive science research and Anki best practices.",enable:{label:"Enable Intelligent Dispersion",description:"Automatically manage sibling card study dates to avoid appearing in the same study session or on similar dates"},parameters:{title:"Core Parameters"},minSpacing:{label:"Minimum Spacing (Days)",description:"Minimum time interval between sibling cards (Recommended: 5 days)"},spacingPercentage:{label:"Dynamic Spacing Percentage",description:"Dynamic adjustment ratio based on review interval (Recommended: 5%)",hint:"💡 Actual interval = max(min spacing, review interval × this ratio)"},example:{title:"Dispersion Effect Examples"},features:{title:"Feature Toggles"},filterInQueue:{label:"Filter in Queue Generation",description:"Prevent sibling cards from appearing in the same study session (Immediate effect)",recommendation:"Highly recommended"},autoAdjustAfterReview:{label:"Dynamic Adjustment After Review",description:"Automatically adjust conflicting sibling card due dates after review",recommendation:"Recommended for continuous optimization"},respectFuzzRange:{label:"Respect FSRS Fuzz Range",description:"Adjust only within FSRS fuzz range, preserving optimal review intervals",recommendation:"Must enable for scientific accuracy"},resetButton:"Reset to Recommended Configuration",resetHint:"Based on Anki community standards and CleverDeck best practices",science:{title:"Scientific Basis",interference:{title:"Memory Interference Theory",proactive:"Proactive Interference",proactiveDesc:"Previously learned content interferes with new learning",retroactive:"Retroactive Interference",retroactiveDesc:"Newly learned content interferes with previous memory",consolidation:"Memory Consolidation",consolidationDesc:"New memories need time to consolidate; learning similar content consecutively reduces effectiveness"},references:{title:"Reference Standards"},benefits:{title:"Expected Benefits",retention:"Improve long-term retention",interference:"Reduce memory interference",efficiency:"Enhance learning efficiency",fsrs:"Perfect compatibility with FSRS algorithm"}}},navigation:{title:"Navigation Visibility",description:"Control the display of main interface navigation items"},cardParsing:{title:"Batch Parsing Configuration",premiumPrompt:"Batch parsing allows you to process multiple files or folders at once. Upgrade to premium to unlock this feature.",regexManagement:{title:"Regex Pattern Management",addMapping:"Add Mapping",presets:{defaultMode:"Default Mode (New Users)",qaMode:"Q&A Mode",standardDivider:"Standard Divider Mode",basicMode:"Basic Mode",ankiExport:"Anki Export Mode"},tableHeaders:{type:"Type",path:"Path",filePrefix:"File Prefix",regexPattern:"Regex Pattern",targetDeck:"Target Deck",subfolders:"Subfolders",outerCover:"Outer Cover",enabled:"Enabled",actions:"Actions"},actions:{enable:"Enable",delete:"Delete",edit:"Edit"}},preset:{title:"Edit Regex Preset",presetName:"Preset Name",parseMode:"Parse Mode",cardSeparation:"Card Separation Method",useCustomSeparator:"Use Custom Separator",useLineSeparator:"Use Line Separator",cardSeparator:"Card Separator",frontBackSeparator:"Front/Back Separator",syncMethod:"Sync Method",excludeTags:"Exclude Tags (comma-separated)",parseModeOptions:{divider:"Divider Mode (Simple)"}},dividerConfig:{title:"Batch Parsing Delimiters",regex:"Front/Back Delimiter",regexDesc:"Symbol to separate front and back content of cards (default: ---div---)",marker:"Cloze Marker",markerDesc:"Symbol to mark cloze content (default: == ==)",cardSeparator:"Card Separator",cardSeparatorDesc:"Symbol to separate different cards in batch parsing (default: %%<->%%)"},systemExcludeTags:{label:"File-level Exclude Tags",value:"#we_已删除, #we_deleted",desc:"System automatically filters card files with these tags (Official setting, read-only)"},excludeTags:{title:"Exclude Tags Configuration",label:"User-defined Exclude Tags",desc:"Cards with these tags will be skipped (separate with commas, # symbol auto-handled)",placeholder:"skip"},fileMappings:{title:"Folder-Deck Mapping",folderDeckMapping:"Folder-Deck Mapping",desc:"Configure automatic mapping between folders and decks",addMapping:"Add Mapping"}},actions:{save:"Save",saved:"Settings saved",saveFailed:"Failed to save settings",reset:"Reset",cancel:"Cancel",confirm:"Confirm",close:"Close"}},study:{title:"Study",session:{start:"Start Study",pause:"Pause",resume:"Resume",finish:"Finish",exit:"Exit"},progress:{new:"New",learning:"Learning",review:"Review",completed:"Completed",remaining:"Remaining"},rating:{again:"Again",hard:"Hard",good:"Good",easy:"Easy",showAnswer:"Show Answer"},toolbar:{undo:"Undo",skip:"Skip",edit:"Edit",flag:"Flag",suspend:"Suspend",bury:"Bury",delete:"Delete",info:"Info",source:"Source"},stats:{studyTime:"Study Time",cardsReviewed:"Cards Reviewed",accuracy:"Accuracy",streak:"Streak"}},cards:{title:"Card Management",actions:{create:"Create Card",edit:"Edit",delete:"Delete",duplicate:"Duplicate",move:"Move",export:"Export",import:"Import"},filters:{all:"All",new:"New",learning:"Learning",review:"Review",suspended:"Suspended",buried:"Buried"},fields:{front:"Front",back:"Back",tags:"Tags",deck:"Deck",created:"Created",modified:"Modified"}},common:{loading:"Loading...",error:"Error",success:"Success",warning:"Warning",info:"Info",confirm:"Confirm",cancel:"Cancel",save:"Save",delete:"Delete",edit:"Edit",close:"Close",retry:"Retry",refresh:"Refresh",reset:"Reset",clear:"Clear",search:"Search",filter:"Filter",sort:"Sort",export:"Export",import:"Import",settings:"Settings",help:"Help",about:"About",notSet:"Not Set",unknown:"Unknown",batchOperations:"Batch Operations",premiumFeature:"Premium Feature",time:{seconds:"{count} seconds",minutes:"{count} minutes",hours:"{count} hours",days:"{count} days",manual:"Manual"},timeUnits:{seconds:"{n} seconds",minutes:"{n} minutes",hours:"{n} hours",days:"{n} days",weeks:"{n} weeks",months:"{n} months",years:"{n} years"},count:{items:"{count} items",selected:"{count} selected"},validation:{required:"This field is required",invalid:"Invalid input"}},navigation:{deckStudy:"Deck Study",cardManagement:"Card Management",aiAssistant:"AI Assistant",analytics:"Analytics",switchView:"Switch View",createDeck:"Create Deck",moreActions:"More Actions"},celebration:{title:"Congratulations! Today's study complete!",subtitle:'You\'ve finished all learning tasks for "{deckName}"',stats:{cardsStudied:"Cards Studied",timeSpent:"Time Spent",accuracy:"Accuracy"},footer:{hint:"💫 You can continue with other decks~",closeButton:"Got it"},timeFormat:{lessThan1Min:"< 1min",minutes:"{n}min",hoursMinutes:"{h}h {m}min"}},navbar:{openSettings:"Open Settings",settings:"Settings",collapse:"Collapse Navbar",expand:"Expand Navbar",collapseHint:"Move mouse here to expand navbar"},rating:{again:"Again",hard:"Hard",good:"Good",easy:"Easy",show:"Show Answer",undo:"Undo",seconds:"{n}s",minutes:"{n}m",hours:"{n}h",days:"{n}d",months:"{n}mo",years:"{n}y"},notifications:{success:{cardSaved:"Card Saved",cardDeleted:"Card Deleted",deckCreated:"Deck Created",settingsUpdated:"Settings Updated",syncCompleted:"Sync Completed",exportSuccess:"Export Successful",importSuccess:"Import Successful",backupCreated:"Backup Created",optimizationComplete:"Optimization Complete"},error:{saveFailed:"Save Failed",loadFailed:"Load Failed",deleteFailed:"Delete Failed",syncFailed:"Sync Failed",connectionFailed:"Connection Failed",exportFailed:"Export Failed",importFailed:"Import Failed",validationFailed:"Validation Failed",unknownError:"Unknown Error Occurred"},warning:{unsavedChanges:"Unsaved Changes",licenseExpiring:"License Expiring Soon",licenseExpired:"License Expired",backupFailed:"Backup Failed",syncConflict:"Sync Conflict"},info:{loading:"Loading...",syncing:"Syncing...",processing:"Processing...",generating:"AI Generating...",optimizing:"Optimizing..."}},menus:{context:{edit:"Edit",delete:"Delete",duplicate:"Duplicate",copy:"Copy Content",moveTo:"Move To",addTags:"Add Tags",removeTags:"Remove Tags",suspend:"Suspend",unsuspend:"Unsuspend",bury:"Bury",unbury:"Unbury",flag:"Flag",unflag:"Unflag"},tooltips:{clickToEdit:"Click to edit",doubleClickToView:"Double click to view details",dragToSort:"Drag to sort",rightClickForMore:"Right click for more options"}},studyInterface:{showAnswer:"Show Answer",confirmAnswer:"Confirm Answer",closeStudy:"Close Study Interface",ratings:{again:"Again",hard:"Hard",good:"Good",easy:"Easy"},intervals:{unknown:"Unknown",lessThan1Min:"< 1min",minutes:"{n}min",hours:"{n}h",days:"{n}d",months:"{n}mo",years:"{n}y"},errors:{invalidCard:"Invalid card data",invalidCardId:"Invalid card ID",invalidFields:"Invalid fields structure",renderError:"Render Error",noContent:"No Content",processingError:"Processing Error",defaultFieldFailed:"Default field processing failed",degradedFieldFailed:"Degraded field processing failed"},labels:{error:"Error",statsDetails:"Stats Details",noTemplates:"No templates found",setReminder:"Set Review Reminder",setPriority:"Set Priority"},progress:{ariaLabel:"Study Progress",newCards:"New {n}",learning:"Learning {n}",review:"Due {n}",mastered:"Mastered {n}",total:"Total {n} cards"},actions:{return:"Return",regenerate:"Regenerate",collect:"Collect ({n})",undo:"Undo"}},cardManagement:{more:"More",search:"Search",viewModes:{title:"View",table:"Table View",grid:"Grid View",kanban:"Kanban View"},layout:{title:"Layout",fixed:"Fixed Height",waterfall:"Waterfall"},gridAttributeSelector:{tooltip:"Card Attribute Display",title:"Top-Left Attribute",none:"None",uuid:"Unique ID",source:"Source Document",priority:"Priority",retention:"Retention Rate",modified:"Modified Time"},density:{title:"Density",compact:"Compact",comfortable:"Comfortable",spacious:"Spacious"},tools:{title:"Tools",scanOrphans:"Scan Orphan Cards",fieldManagement:"Field Management",columnSettings:"Column Settings"},filters:{showAll:"Show All",appliedFilters:"Filters Applied",clearAll:"Clear All Filters",deck:"Deck",priority:"Priority",time:"Time"},empty:{hint:"Please add cards or adjust filters"},batchToolbar:{selected:"{count} cards selected",copy:"Copy",changeDeck:"Change Deck",changeTemplate:"Change Template (Unavailable)",addTags:"Add Tags",removeTags:"Remove Tags"},batchDelete:{confirm:"Are you sure you want to delete {count} selected cards? This action cannot be undone."}},deckStudyPage:{deckTypes:{choice:"Choice Questions"},urgency:{urgent:"Urgent",completed:"Completed"},moreActions:"More Actions",tableHeaders:{deckName:"Deck Name",newCards:"New",learning:"Learning",review:"Review",actions:"Actions"}},filters:{loading:"Loading filter data...",sections:{decks:"Deck Filter",types:"Type Filter",priority:"Priority",tags:"Tag Filter",time:"Time Filter"},allDecks:"All Decks",noTags:"No tags",clearAll:"Clear All Filters",myFilters:"My Filters",manage:"Manage",cardTypes:{qa:"Q&A",choice:"Multiple Choice",fill:"Fill in Blank",cloze:"Cloze"},priorities:{all:"All",high:"High Priority",medium:"Medium Priority",low:"Low Priority",none:"No Priority"},timeFilters:{all:"All",today:"Today",dueToday:"Due Today",addedToday:"Added Today",editedToday:"Edited Today",reviewedToday:"Reviewed Today",firstReview:"First Review",retryToday:"Retry Today",neverReviewed:"Never Reviewed"},status:{new:"New",learning:"Learning",review:"Review",mastered:"Mastered"},advancedBuilder:{title:"Advanced Filter Builder",addGroup:"Add Group",addCondition:"Add Condition",removeGroup:"Remove Group",results:"Results",calculating:"Calculating",cards:"cards",apply:"Apply",save:"Save",cancel:"Cancel",enableCondition:"Click to enable this condition",disableCondition:"Click to disable this condition"}},ui:{cancel:"Cancel",confirm:"Confirm",delete:"Delete",save:"Save",edit:"Edit",close:"Close",closeNotification:"Close notification",newCard:"New Card",progressBar:"Progress bar",hideMonitor:"Hide monitor",technicalDetails:"Technical details",metrics:{memoryUsage:"Memory Usage",cacheHitRate:"Cache Hit Rate",throughput:"Throughput",networkLatency:"Network Latency",errorRate:"Error Rate"},pagination:{previous:"Previous",next:"Next",page:"Page {n}",total:"{n} cards total"},tables:{loading:"Loading...",empty:"No data",selectAll:"Select All"}},tables:{card:{loading:"Loading cards...",empty:"No cards"}},fsrs:{title:"FSRS6 Algorithm Settings",description:"Configure spaced repetition algorithm parameters",savedMessage:"FSRS6 settings saved",saveFailed:"Failed to save settings",basicParams:{title:"Basic Parameters",retention:{label:"Target Retention",description:"Desired long-term memory retention rate (0.5-0.99)"},maxInterval:{label:"Maximum Interval",description:"Maximum review interval in days"},enableFuzz:{label:"Enable Randomization",description:"Add random fluctuation to calculated intervals"}},advancedSettings:{title:"Advanced Settings",weights:{title:"Weight Parameters",description:"21 weight parameters of FSRS6 algorithm, affecting memory prediction accuracy",allowEdit:"Allow Editing",locked:'Weight parameters are locked, enable "Allow Editing" to modify',warning:"⚠️ Modifying weight parameters may affect learning effectiveness, please proceed with caution",reset:"Reset Default"}},optimization:{title:"Smart Optimization",description:"Automatically optimize FSRS6 parameters based on your learning data",overview:{title:"Optimization Overview",description:"Click FSRS6 Standard Model to optimize algorithm",algorithmVersion:"Algorithm Version",systemVersion:"System Version",reviewRecords:"Review Records",optimizationResult:"Optimization Result",consecutiveParams:"Consecutive Params",dataPoints:"Data Points",refresh:"Refresh"},dataPoints:"Data Points",accuracy:"Prediction Accuracy",status:"Optimization Status",statusReady:"Ready",statusOptimizing:"Optimizing...",startButton:"Start Optimization",optimizingButton:"Optimizing...",complete:"Parameter optimization complete",failed:"Parameter optimization failed"},performance:{title:"Performance Monitoring",description:"Real-time monitoring of FSRS6 algorithm status and performance metrics",refresh:"Refresh",algorithmVersion:"Algorithm Version",executionTime:"Execution Time",cacheHitRate:"Cache Hit Rate",activeInstances:"Active Instances",noData:"Click refresh button to get performance metrics"},parameters:{title:"Algorithm Parameters",targetRetention:{label:"Target Retention",description:"Desired long-term memory retention rate (0.5-0.99)",placeholder:"e.g., 0.9 for 90% retention"},maxInterval:{label:"Maximum Interval",description:"Maximum days between reviews",unit:"days"}},actions:{reset:"Reset to Default",import:"Import Parameters",export:"Export Parameters",save:"Save Parameters",cancel:"Cancel"}},annotation:{title:"Tuanki Annotation System",sectionTitle:"Tuanki Annotation Features",description:"Create cards quickly based on document annotations",requireLicense:"This feature requires license activation",features:{title:"You will get after activation",feature1:"📝 In-document annotation card creation",feature2:"🎯 Smart batch card generation",feature3:"🔄 Two-way sync updates",feature4:"⚡ Efficient learning workflow",feature5:"🎨 Custom annotation styles"},activateButton:"Go to Activate",settings:{saved:"Settings saved",failed:"Failed to save settings, please retry"},autoDetection:{label:"Enable Auto Detection",description:"Monitor document changes and detect new annotations in real-time"},debounceDelay:{label:"Debounce Delay",description:"Wait time after annotation changes to avoid frequent triggers",unit:"milliseconds"},maxConcurrent:{label:"Max Concurrent Processing",description:"Number of annotation tasks processed simultaneously, affects speed and system load"},bidirectionalSync:{label:"Enable Two-Way Sync",description:"Auto sync between annotation blocks and card content (recommended)",enabled:"Two-way sync enabled",disabled:"Two-way sync disabled"},onlyActiveFile:{label:"Sync Active File Only",description:"Only sync currently open file to reduce system load",enabled:"Sync active file only enabled",disabled:"Sync active file only disabled"},sync:{title:"Sync Options",autoSync:{label:"Auto Sync",description:"Automatically monitor file changes and sync to cards"},syncInterval:{label:"Sync Interval",description:"Time interval for checking file changes",unit:"seconds"},twoWaySync:{label:"Two-Way Sync",description:"Sync card content back to annotation blocks"},syncOnlyActive:{label:"Sync Active File Only",description:"Only sync currently open file to reduce performance impact"}},monitoring:{title:"File Monitoring",detectDelay:{label:"Detection Delay",description:"Wait time after file changes to avoid frequent triggers",unit:"milliseconds"}},advanced:{title:"Advanced Options",maxConcurrent:{label:"Max Concurrent Processing",description:"Number of files processed simultaneously"},autoCreateDeck:{label:"Auto Create Deck",description:"Automatically create decks based on file path"}},actions:{syncAllDocuments:"Sync All Documents",syncCurrent:"Sync Current Document",syncSelected:"Sync Selected Documents"}},parsing:{title:"Card Parsing Settings",description:"Configure batch card parsing rules for Markdown files",batchParsing:{title:"Batch Parsing",enable:{label:"Enable Batch Parsing",description:"Scan and batch create cards from file markers"},markers:{title:"Parse Markers",startMarker:{label:"Start Marker",description:"Start marker for batch parsing",default:"---start---"},endMarker:{label:"End Marker",description:"End marker for batch parsing",default:"---end---"}}},cloze:{title:"Cloze Grammar",defaultSyntax:{label:"Default Syntax",markdown:"Markdown Highlight (==text==)",anki:"Anki Format ({{c1::text}})"},autoDetect:{label:"Auto Detect",description:"Automatically detect and support both syntaxes"}}},aiConfig:{title:"AI Card Creation",description:"Configure AI-assisted card creation features",providers:{title:"AI Providers",openai:"OpenAI",gemini:"Google Gemini",anthropic:"Anthropic Claude",deepseek:"DeepSeek",zhipu:"Zhipu AI",siliconflow:"SiliconFlow",select:"Select Provider"},apiKeys:{title:"API Key Configuration",apiKeyLabel:"API Key",apiKeyDescription:"Enter your {provider} API key",modelLabel:"Model",modelDescription:"Select the AI model to use",testConnection:"Test Connection",testing:"Testing...",testSuccess:"Connection successful!",testFailed:"API key not configured",show:"Show",hide:"Hide",verified:"Verified",defaultBadge:"🎯 Default",formattingBadge:"📝 Formatting",splittingBadge:"🔀 Splitting",menuLabel:"Provider configuration menu",configOptions:"Configuration Options"},models:{title:"Model Selection",select:"Select Model",recommended:"Recommended"},promptTemplates:{title:"Prompt Template Management",official:{title:"Official Templates",count:"{n} templates",badge:"Official",viewDetail:"View Details"},custom:{title:"Custom Templates",count:"{n} templates",create:"New Template",edit:"Edit",delete:"Delete",deleteConfirm:"Are you sure you want to delete this template?"},modal:{createTitle:"New Template",editTitle:"Edit Template",name:"Template Name",namePlaceholder:"E.g.: Standard Q&A Generation",content:"Prompt Content",contentHelper:"Use {variable} to define replaceable variables, e.g.: {count}, {difficulty}",contentPlaceholder:"Generate {count} Q&A cards based on the following content...",detectedVariables:"Detected Variables",variables:"Variables:",cancel:"Cancel",save:"Save"}},globalParams:{temperature:{label:"Temperature",description:"Control AI response randomness. Lower = more deterministic, Higher = more creative. Recommended: 0.5-1.0"},maxTokens:{label:"Max Tokens",description:"Maximum tokens per request. Recommended: 1000-4000"},requestTimeout:{label:"Request Timeout",description:"API request timeout in seconds. Recommended: 30-60s"},concurrentLimit:{label:"Concurrent Request Limit",description:"Maximum concurrent requests. Recommended: 1-5"}},imageGeneration:{defaultSyntax:{label:"Default Image Syntax",description:"Choose default syntax format for inserting images",wiki:"Wiki Link (![[image.png]])",markdown:"Markdown (![](image.png))"},attachmentDir:{label:"Attachment Directory",description:"AI-generated images will be saved to this directory",placeholder:"attachments/ai-generated"},autoCreateSubfolders:{label:"Auto Create Subfolders",description:"Automatically create date-based subfolders to organize images"},includeTimestamp:{label:"Include Timestamp in Filename",description:"Include generation timestamp in image filenames"},includeCaption:{label:"Auto Add Image Caption",description:"Automatically add AI-generated caption below images"}},cardSplitting:{title:"AI Card Splitting Configuration",enabled:{label:"Enable AI Splitting",description:"Show AI split button in study interface to split complex cards into multiple sub-cards"},defaultTargetCount:{label:"Default Generation Count",description:"Default number of sub-cards to generate (0 = let AI decide, usually 2-5 cards)"},minContentLength:{label:"Minimum Content Length",description:"Only cards with content length above this value can be split (characters)"},maxContentLength:{label:"Maximum Content Length",description:"Content exceeding this length will be truncated before splitting (characters)"},autoInheritTags:{label:"Auto Inherit Tags",description:"Sub-cards automatically inherit all tags from parent card"},autoInheritSource:{label:"Auto Inherit Source Info",description:"Sub-cards automatically inherit Obsidian source document and block links from parent"},requireConfirmation:{label:"Require Confirmation Before Adding",description:"User confirmation required before adding sub-cards to deck (recommended)"},defaultInstruction:{label:"Default Split Instruction (Optional)",description:'Custom instructions for AI splitting, e.g., "Focus on definitions and examples" (leave empty for default)',placeholder:"Enter custom split instructions...",allowEdit:"Allow Editing Prompt",locked:"Default prompt is locked, toggle switch to unlock editing",usingDefault:"Currently using system default prompt (leave empty to use default)",warning:"⚠️ Custom prompts may affect AI splitting quality, depends on prompt quality and AI model",viewDefault:"📖 View System Default Prompt",defaultPromptContent:'You are a professional learning card splitting assistant, following the "Minimum Information Principle".\n\nYour task is to split a parent card containing multiple knowledge points into multiple independent sub-cards. Each sub-card should contain only one clear knowledge point.\n\nSplitting Principles:\n1. Each sub-card contains only one core concept or knowledge point\n2. Maintain independence and completeness of sub-cards\n3. Sub-cards should be independently reviewable and understandable\n4. Retain necessary context but avoid duplicate information\n5. Maintain the original format style and expression\n\nOutput Format (JSON):\n{\n  "cards": [\n    {\n      "front": "Question or prompt",\n      "back": "Answer or explanation",\n      "tags": ["optional tags"],\n      "explanation": "optional additional explanation"\n    }\n  ]\n}'}}},dataManagement:{title:"Data Management",description:"Manage plugin data import, export, and backup",panelTitle:"Data Management Panel",panelDescription:"Integrated interface for all data management functions",initFailed:"Service initialization failed",refreshFailed:"Refresh failed, please retry",confirmPhrase:"Confirm Operation",resetConfirmPhrase:"Confirm Reset",importExport:{title:"Import/Export",import:{title:"Import Data",button:"Import",selectFile:"Select File",importing:"Importing...",success:"Data imported successfully",successDetail:"Imported: {imported}, Skipped: {skipped}",failed:"Import failed",confirm:"Are you sure you want to import data? This will overwrite existing data!",details:{fileName:"File name: {name}",fileSize:"File size: {size} MB",autoBackup:"A backup will be created automatically before import"},warnings:{override:"Existing data may be overwritten",format:"Please ensure the import file format is correct",backup:"Recommend creating a manual backup first"}},export:{title:"Export Data",button:"Export",exporting:"Exporting...",success:"Data exported successfully",successDetail:"File: {path}",failed:"Export failed",confirm:"Are you sure you want to export all data?",details:{all:"Will export all decks and card data",records:"Including study records and user settings",format:"Generate JSON format export file"}}},backup:{title:"Data Backup",latest:{title:"Latest Backup",lastGenerated:"Last Generated",dataFolder:"Data Folder",justNow:"Just now",stats:{totalSize:"Total Size",deckCount:"Deck Count",cardTotal:"Card Total",backupCount:"Backup Count"}},history:{title:"Backup History",tableHeaders:{backupTime:"Backup Time",backupType:"Backup Type",backupSize:"Backup Size",actions:"Actions"},type:{manual:"Manual",auto:"Auto"},actions:{restore:"Restore",delete:"Delete",export:"Export"}},operations:{integrityCheck:"Integrity Check",exportData:"Export Data",importData:"Import Data",clearAll:"Clear All",createBackup:"Create Backup"},auto:{title:"Auto Backup Configuration",description:"Automatically create data backups periodically to protect your learning data",enable:"Enable Auto Backup",enableDesc:"Periodically create data backups automatically",interval:"Backup Interval",intervalDesc:"Time interval for automatic backups (1-168 hours)",intervalUnit:"hours",triggers:{title:"Trigger Conditions",onStartup:"Backup on Startup",onStartupDesc:"Automatically create backup when plugin starts",onCardThreshold:"Backup on Card Threshold",onCardThresholdDesc:"Automatically backup when card count changes reach threshold",thresholdCount:"Threshold Count",thresholdCountDesc:"Trigger backup when card count changes reach this value",thresholdUnit:"cards"}},manual:{title:"Manual Backup",label:"Manual Backup",create:"Backup Now",creating:"Creating Backup...",success:"Backup created successfully",successDetail:"Size: {size} MB",failed:"Failed to create backup"}}},ankiConnect:{title:"AnkiConnect Sync",sectionTitle:"Anki Sync Settings",description:"Connect to Anki desktop application for bidirectional card synchronization",enable:{label:"Enable AnkiConnect",description:"Connect to Anki desktop application for bidirectional card synchronization"},connection:{title:"Connection Management",status:"Connection Status",statusLabel:{connected:"Connected",disconnected:"Disconnected",testing:"Testing..."},testConnection:"Test Connection",address:{label:"AnkiConnect Address",placeholder:"http://localhost:8765",description:"AnkiConnect API address"},test:{button:"Test Connection",testing:"Testing...",success:"Connection Successful",failed:"Connection Failed"}},status:{title:"Connection Status",connected:"Connected",disconnected:"Disconnected",syncing:"Syncing..."},autoSync:{title:"Auto Sync Configuration",enable:"Enable Auto Sync",enableDesc:"Automatically sync to Anki on document changes"},deckSync:{title:"Deck Sync Configuration",enable:"Enable Deck Sync",enableDesc:"Synchronize deck data to Anki",description:"Configure mapping between Tuanki decks and Anki decks",apiV6:"Optional: Enable API v6",discovered:"Discovered {count} Anki decks",configureMapping:"Configure Mapping"},sectionSync:{title:"Section Sync Configuration",enable:"Enable Section Sync",enableDesc:"Synchronize section content to Anki"}},virtualization:{title:"Performance Optimization",description:"Configure virtual scrolling and rendering optimization to improve performance with large card sets",resetConfirm:"Are you sure you want to reset all virtualization settings to default?",resetButton:"Reset to Default",kanban:{title:"Kanban View Settings",enableVirtualScroll:{label:"Enable Virtual Scrolling",description:"Enable virtual scrolling within kanban columns to greatly improve performance with large card sets (recommended for >200 cards)"},enableColumnVirtualization:{label:"Column Virtualization",description:"Enable virtual scrolling for each column individually (progressive loading still available when disabled)"},overscan:{label:"Overscan Count",description:"Number of cards to pre-render outside viewport, increase to reduce white screen during scrolling but uses more memory"},initialBatchSize:{label:"Initial Load Count",description:"Number of cards to initially load per column (effective in non-virtualization mode)"},loadMoreBatchSize:{label:"Batch Load Count",description:'Number of cards to load at once when clicking "Load More"'}},table:{title:"Table View Settings",enableVirtualScroll:{label:"Enable Virtual Scrolling",description:"Enable virtual scrolling in table view (currently defaults to pagination)"},enableTableVirtualization:{label:"Enable Table Virtualization",description:"Enable virtual scrolling for table rows (requires virtual scrolling enabled first)"},paginationThreshold:{label:"Pagination Threshold",description:"Use pagination instead of virtual scrolling below this count (recommended: 500)"}},advanced:{title:"Advanced Options",cacheItemHeight:{label:"Cache Measured Heights",description:"Cache measured card heights to improve performance (recommended)"},estimatedItemHeight:{label:"Estimated Item Height",description:"Initial height estimate for virtual scrolling (pixels)"},resetSettings:{label:"Reset Settings",description:"Reset all virtualization settings to default values"}},tips:{title:"Performance Optimization Tips",tip1:"Virtual scrolling automatically enables when card count exceeds 200, no manual intervention needed",tip2:"Increasing Overscan reduces white screen during scrolling but increases memory usage",tip3:"Pagination mode is recommended for table view unless you need quick browsing of large datasets",tip4:"Enabling height cache significantly improves scrolling performance with minimal memory cost"}},decks:{dashboard:{emptyHint:"No decks in this category. You can assign categories when creating new decks",unit:"cards",study:"Study",completed:"Done",startStudy:"Start Study",viewCelebration:"View Celebration",moreActions:"More Actions"},card:{ariaLabel:"Deck: {name}",new:"New",learning:"Learn",review:"Rev"},grid:{emptyText:"No decks in this category",emptyHint:"You can assign categories when creating new decks",parentDeck:"Parent Card Deck",childDeck:"Child Card Deck"},menu:{createSubdeck:"Create Subdeck",moveDeck:"Move Deck",moveCategory:"Move Category",edit:"Edit",delete:"Delete",refreshData:"Refresh Data"}},studyInfo:{fsrs:{title:"FSRS Algorithm Info",version:"FSRS 5/6",description:"FSRS (Free Spaced Repetition Scheduler) is a memory model-based spaced repetition algorithm that can more accurately predict forgetting time and optimize review intervals."},today:{title:"Today's Study",unit:"cards",studied:"Studied",new:"New",review:"Review",reviewCount:"Review Count"},smartTips:{title:"Smart Tips",shortMemory:"Smart Short Memory",forgetPredict:"Forget Prediction Optimization",sameDayOptimize:"Same-day Review Optimization"},currentCard:{title:"Current Card",type:"Type",reps:"Reviews",lapses:"Lapses"}},toolbar:{unknownDeck:"Unknown Deck",sourceNotFound:"Source document not found",sourceNotExist:"Source document does not exist",blockNotFound:"Block link not found",sourceDeleted:"Source document has been deleted",jumpedToSource:"Jumped to source document",openedSource:"Opened source document",noSourceLinked:"This card is not linked to a source document",sourceDoc:"Source Document",currentCard:"Current Card",saveAndPreview:"Save & Preview",editCard:"Edit Card",preview:"Preview",edit:"Edit",plainTextEditor:"Plain Text Editor",textEdit:"Text Edit",deleteCard:"Delete Card",delete:"Delete",setReminder:"Set Reminder",reminder:"Reminder",setPriority:"Set Priority",priority:"Priority",changeDeck:"Change Deck",deck:"Deck",deckList:"Deck List",currentDeck:"Current Deck",availableDecks:"Available Decks",viewCardInfo:"View Card Info & Source",cardInfoAndSource:"Card Info & Source",belongToDeck:"Belongs to Deck",cardState:"Card State",stateNew:"New",stateLearning:"Learning",stateReview:"Review",stateRelearning:"Relearning",stateUnknown:"Unknown",graphLink:"Graph Link",graphLinkEnabled:"Disable Graph Link",graphLinkDisabled:"Enable Graph Link",graphLinkSuccess:"✅ Graph link enabled\nGraph will auto-update when switching cards",graphLinkClosed:"Graph link disabled",noSourceFile:"⚠️ Current card has no source file",sourceFileNotExist:"⚠️ Source file does not exist",graphLinkInitFailed:"❌ Failed to initialize graph link"},modals:{viewCard:{title:"Card Details",tabInfo:"Card Info",tabStats:"Review Stats",tabCurve:"Memory Curve",loading:"Loading...",unknownTemplate:"Unknown Template",noDeck:"No Deck"},moveDeck:{title:"Move Deck",moveToNew:"Move {name} to new location",searchPlaceholder:"Search target deck...",selectTarget:"Select Target Location",rootOption:"Top Level (No Parent)",rootDesc:"Upgrade to root deck",moveToRoot:"Move to top level",cancel:"Cancel",confirm:"Confirm Move"},saveFilter:{title:"Save Filter",name:"Name",namePlaceholder:"Enter filter name",nameError:"Please enter filter name",nameTooLong:"Name cannot exceed 50 characters",description:"Description",descriptionPlaceholder:"Optional",icon:"Icon",color:"Color",pinToSidebar:"Pin to Sidebar",cancel:"Cancel",save:"Save",iconFilter:"Filter",iconStar:"Star",iconBookmark:"Bookmark",iconTag:"Tag",iconHeart:"Heart",iconFlag:"Flag",iconCircleDot:"Circle Dot",iconCheckCircle:"Check Circle",iconClock:"Clock",iconCalendar:"Calendar",iconBook:"Book",iconLayers:"Layers",colorBlue:"Blue",colorTheme:"Theme Color",colorPink:"Pink",colorRed:"Red",colorOrange:"Orange",colorGreen:"Green",colorCyan:"Cyan",colorGray:"Gray"},batchAddTags:{title:"Batch Add Tags",inputPlaceholder:"Enter tags and press Enter...",suggestions:"Suggestions",cancel:"Cancel",confirm:"Confirm Add"},batchRemoveTags:{title:"Batch Remove Tags",info:"Remove tags from {count} selected cards",selectAll:"Select All",clearAll:"Clear All",noTags:"Selected cards have no tags",cancel:"Cancel",confirm:"Confirm Delete"},batchDeckChange:{title:"Batch Change Deck",operationType:"Select operation type:",move:"Move",moveDesc:"Move {count} cards to new deck",copy:"Copy",copyDesc:"Copy {count} cards to new deck (keep originals)",searchPlaceholder:"Search decks...",selectDeck:"Select deck: {name}",cancel:"Cancel",confirm:"Confirm"},cardInfoTab:{copyUUID:"UUID copied to clipboard",noSource:"This card has no linked source document",sourceDeleted:"Source document has been deleted",jumpedToSource:"Jumped to source document",openedSource:"Opened source document",basicInfo:"Basic Information",uuid:"UUID",deckLabel:"Deck",templateLabel:"Template",createdAt:"Created",updatedAt:"Last Edited",sourceInfo:"Source Information",sourceFile:"Source File",sourceBlock:"Source Block",notLinked:"Not Linked",viewSource:"View Source",tags:"Tags",noTags:"No Tags",customFields:"Custom Fields",noCustomFields:"No Custom Fields"},reviewStatsTab:{coreMetrics:"Core Metrics",totalReviews:"Total Reviews",lapses:"Lapses",successRate:"Success Rate",avgResponseTime:"Avg Response Time",times:"times",seconds:"sec",fsrsMetrics:"FSRS Metrics",stability:"Stability",difficulty:"Difficulty",retrievability:"Retrievability",days:"days",reviewHistory:"Review History",noHistory:"No review records yet",schedulingInfo:"Scheduling Info",currentInterval:"Current Interval",nextReview:"Next Review",notScheduled:"Not Scheduled"},memoryCurveTab:{title:"Memory Curve",description:"Memory curve visualization",noData:"No data available",timeRange:"Time Range:",range7d:"7 Days",range30d:"30 Days",range90d:"90 Days",rangeAll:"All",legend:{predicted:"Predicted - Theoretical forgetting curve based on FSRS",actual:"Actual - Performance based on real review records",review:"Review Points - Memory state at review moments"},emptyState:{title:"Insufficient Data",description:"At least 2 review records needed to generate memory curve",reviewCount:"Current reviews: {count}"},insights:{title:"Curve Insights",forgetting:{title:"Forgetting Curve",description:"Memory naturally decays over time, higher stability means flatter curve"},optimalTiming:{title:"Optimal Review Timing",description:"Most effective when retrievability drops to 70-80%"},stabilityGrowth:{title:"Stability Growth",description:"Successful reviews significantly increase stability and extend intervals"},lapsesImpact:{title:"Lapses Impact",description:"Lapses reduce stability but benefit long-term memory"}},summary:{dataPoints:"Data Points",reviewMarkers:"Review Markers",currentStability:"Current Stability",currentRetrievability:"Current Retrievability",pointsUnit:"",daysUnit:"days"}},apkgImport:{title:"APKG Import",selectFile:"Please select .apkg file",invalidFile:"Please select .apkg file",importing:"Importing...",importComplete:"Import Complete",importFailed:"Import Failed",stages:{parsing:"Parsing file",media:"Importing media",cards:"Importing cards",finalizing:"Finalizing"}},fileSelector:{title:"Select Files",rootFolder:"Root",selectAll:"Select All",deselectAll:"Deselect All",selected:"{count} files selected",confirm:"Confirm",cancel:"Cancel"},cardPreview:{title:"Card Preview",back:"Back",close:"Close",selectCard:"Select this card",modifyRequirement:"Modify Generation",collapseDialog:"Collapse",prevCard:"Previous",nextCard:"Next",selectAll:"Select All",deselectAll:"Deselect All",selected:"Selected",cardsUnit:"cards",importTo:"Import to",importCards:"Import {count} Cards",importing:"Importing...",generating:"Generating",generatingProgress:"Generating {current}/{total}"},batchTemplateChange:{title:"Batch Change Template",selectTemplate:"Select new template",confirm:"Confirm Change",cancel:"Cancel"},createDeck:{titleCreate:"New Deck",titleEdit:"Edit Deck",titleCreateSub:"New Subdeck",parentDeck:"Parent Deck (Optional)",noParent:"None (Create Root Deck)",willCreateAs:'Will be created as subdeck of "{parent}"',name:"Name",namePlaceholder:"e.g., Computer Science",description:"Description",descriptionPlaceholder:"Optional",category:"Categories (Multi-select)",categoryLoading:"Loading categories...",categorySelected:"{count} categories selected",categoryDisabled:"Subdecks cannot have categories, they inherit from parent",deckType:"Deck Type",deckTypeMixed:"Mixed Types",deckTypeMixedDesc:"Can add all types of cards",deckTypeChoice:"Choice Questions Only",deckTypeChoiceDesc:"Can only add choice question cards",deckTypeHint:"This deck can only add choice question cards",cancel:"Cancel",create:"Create",save:"Save",close:"Close",initFailed:"Initialization failed, please retry",createFailed:"Failed to create deck: {error}"}},commands:{formatAsCloze:{name:"Format as Progressive Cloze",noSelection:"⚠️ Please select text first",success:"✅ Formatted as progressive cloze, please enter number (e.g., 1, 2, 3)",error:"❌ Format failed, please try again"}},about:{title:"About Tuanki",product:{name:"Tuanki - Intelligent Flashcard Plugin",productName:"Product Name",version:"Version",versionLabel:"Version",algorithm:"Core Algorithm",algorithmValue:"FSRS6 (Free Spaced Repetition Scheduler v6.1.1)",platform:"Platform",platformValue:"Obsidian",developer:"Developer",developerValue:"Tuanki Team",licenseMode:"License Mode",licenseModeValue:"Completely Free + Premium Features License",description:"Intelligent spaced repetition learning system based on FSRS6 algorithm"},quickLinks:{title:"Quick Links",openSource:"Fully Open Source",documentation:"View Documentation",changelog:"Changelog",support:"Contact Support"},acknowledgments:{title:"Special Thanks",fsrs:"FSRS Algorithm",fsrsDesc:"FSRS Algorithm Team",obsidian:"Obsidian",obsidianDesc:"Obsidian Platform Support",anki:"Anki",ankiDesc:"Anki Project Inspiration",community:"SamuelKreatorsz",communityDesc:"Community Contributors"},license:{title:"License Information",status:"Status",statusActive:"Premium Features Activated",statusInactive:"Premium Features Not Activated",type:"Type",manage:"Manage",activation:{title:"License Activation",code:"Activation Code",placeholder:"Enter license activation code",activate:"Activate",activating:"Activating..."}},contact:{title:"Contact",github:"GitHub Repository",email:"Email",support:"Technical Support",website:"Official Website"}},license:{boundEmail:"Bound Email",activatedDevices:"Activated Devices",activationPrompt:"Unlock more powerful features after activation",getActivationCode:"Get Activation Code",activatePremium:"Activate Premium Features"}}},Np={defaultLanguage:"zh-CN",fallbackLanguage:"zh-CN",supportedLanguages:["zh-CN","en-US"]},Fp=Fr(Np.defaultLanguage),Bp=Fr(Np),jp=class e{constructor(){oe(this,"currentLang",Np.defaultLanguage),oe(this,"config",Np),Fp.subscribe(e=>{this.currentLang=e}),Bp.subscribe(e=>{this.config=e})}static getInstance(){return e.instance||(e.instance=new e),e.instance}t(e,t){const n=this.getTranslation(e,this.currentLang);if(!n){const n=this.getTranslation(e,this.config.fallbackLanguage);return n?this.interpolate(n,t):(_e.warn(`Translation not found for key: ${e}`),e)}return this.interpolate(n,t)}getTranslation(e,t){const n=e.split(".");let i=Lp[t];for(const a of n){if(!i||"object"!=typeof i||!(a in i))return null;i=i[a]}return"string"==typeof i?i:null}interpolate(e,t){return t?e.replace(/\{(\w+)\}/g,(e,n)=>{var i;return(null==(i=t[n])?void 0:i.toString())||e}):e}setLanguage(e){this.config.supportedLanguages.includes(e)?Fp.set(e):_e.warn(`Unsupported language: ${e}`)}getCurrentLanguage(){return this.currentLang}getSupportedLanguages(){return this.config.supportedLanguages}isLanguageSupported(e){return this.config.supportedLanguages.includes(e)}};oe(jp,"instance");const Up=jp.getInstance(),Vp=Br(Fp,e=>(e,t)=>Up.t(e,t));var qp=(e=>(e.QUICK_CREATE="quick-create",e.ANNOTATION="annotation",e.BATCH_PARSE_SINGLE="batch-parse-single",e.BATCH_PARSE_MULTI="batch-parse-multi",e))(qp||{});class Hp{constructor(e){oe(this,"vault"),oe(this,"uuidIndex",new Map),oe(this,"blockIdIndex",new Map),oe(this,"lastIndexUpdate",0),oe(this,"recentlyCreatedLinks",new Map),oe(this,"recentlyCreatedUUIDs",new Map),oe(this,"PROTECTION_WINDOW",6e4),oe(this,"DATA_FOLDER","tuanki"),oe(this,"INDEX_CACHE_TTL",3e4),this.vault=e,Ce("OrphanedLinkDetector","初始化直接文件读取检测器")}markRecentlyCreated(e){const t=e.replace(/^\^/,"");this.recentlyCreatedLinks.set(t,Date.now()),Ce("OrphanedLinkDetector",`保护块链接: ${t} (60秒)`)}markUUIDRecentlyCreated(e){this.recentlyCreatedUUIDs.set(e,Date.now()),Ce("OrphanedLinkDetector",`保护UUID: ${e} (60秒)`)}removeProtection(e){const t=e.replace(/^\^/,"");this.recentlyCreatedLinks.delete(t)&&Ce("OrphanedLinkDetector",`移除保护: ${t}`)}removeUUIDProtection(e){this.recentlyCreatedUUIDs.delete(e)&&Ce("OrphanedLinkDetector",`移除UUID保护: ${e}`)}cleanupExpiredProtections(){const e=Date.now();let t=0;for(const[n,i]of this.recentlyCreatedLinks)e-i>this.PROTECTION_WINDOW&&(this.recentlyCreatedLinks.delete(n),t++);for(const[n,i]of this.recentlyCreatedUUIDs)e-i>this.PROTECTION_WINDOW&&(this.recentlyCreatedUUIDs.delete(n),t++);t>0&&Ce("OrphanedLinkDetector",`清理过期保护: ${t} 个`)}isProtected(e){const t=e.replace(/^\^/,"");if(this.recentlyCreatedLinks.has(t)){const e=this.recentlyCreatedLinks.get(t),n=Date.now()-e;if(n<this.PROTECTION_WINDOW)return Ce("OrphanedLinkDetector",`块链接受保护: ${t} (${Math.round((this.PROTECTION_WINDOW-n)/1e3)}秒剩余)`),!0;this.recentlyCreatedLinks.delete(t)}return!1}isUUIDProtected(e){if(this.recentlyCreatedUUIDs.has(e)){const t=this.recentlyCreatedUUIDs.get(e),n=Date.now()-t;if(n<this.PROTECTION_WINDOW)return Ce("OrphanedLinkDetector",`UUID受保护: ${e} (${Math.round((this.PROTECTION_WINDOW-n)/1e3)}秒剩余)`),!0;this.recentlyCreatedUUIDs.delete(e)}return!1}async detectInFile(e){try{const t=await e.vault.cachedRead(e),n=this.extractWeBlockLinks(t),i=this.extractUUIDs(t),a=this.extractYamlUUID(t);a&&i.push(a);const r=await this.batchCheckOrphaned(n),s=new Map;for(const e of i){const t=await this.isUUIDOrphaned(e);s.set(e,t)}const o=[];for(const[l,c]of r)if(c){const n=this.inferCreationType(t,l,void 0);o.push({blockId:l,filePath:e.path,creationType:n,isOrphaned:!0})}for(const[l,c]of s)if(c){const n=this.inferCreationType(t,void 0,l),i=o.find(t=>t.filePath===e.path&&t.creationType===n);i?i.uuid=l:o.push({blockId:"",uuid:l,filePath:e.path,creationType:n,isOrphaned:!0})}return o}catch(t){return _e.error("[OrphanedLinkDetector] 检测文件失败:",e.path,t),[]}}extractWeBlockLinks(e){const t=(e.match(/\^we-[a-z0-9]{6}/g)||[]).map(e=>e.replace(/^\^/,""));return Array.from(new Set(t))}extractUUIDs(e){const t=[];(e.match(/<!--\s*tk-[a-z0-9]{12}\s*-->/g)||[]).forEach(e=>{var n;const i=null==(n=e.match(/tk-[a-z0-9]{12}/))?void 0:n[0];i&&t.push(i)});const n=/^>\s*uuid:\s*(tk-[a-z0-9]{12})/gm;let i;for(;null!==(i=n.exec(e));)t.push(i[1]);return Array.from(new Set(t))}extractYamlUUID(e){const t=e.match(/^---\n([\s\S]*?)\n---/);if(!t)return null;const n=t[1].match(/tuanki-uuid:\s*(tk-[a-z0-9]{12})/);return n?n[1]:null}async ensureIndexUpToDate(){const e=Date.now();e-this.lastIndexUpdate<this.INDEX_CACHE_TTL||(Ce("OrphanedLinkDetector","重建卡片索引..."),await this.buildIndexFromDataFiles(),this.lastIndexUpdate=e,Ce("OrphanedLinkDetector",`索引重建完成: ${this.uuidIndex.size}个UUID, ${this.blockIdIndex.size}个块链接`))}async buildIndexFromDataFiles(){this.uuidIndex.clear(),this.blockIdIndex.clear();try{const e=await this.getAllDeckFiles();for(const t of e)await this.indexCardsFromFile(t)}catch(e){_e.error("[OrphanedLinkDetector] 构建索引失败:",e)}}async getAllDeckFiles(){const e=[],t=this.vault.getAbstractFileByPath(`${this.DATA_FOLDER}/decks`);if(t&&t instanceof ge.TFolder)for(const n of t.children)n instanceof ge.TFile&&"json"===n.extension&&e.push(n);return e}async indexCardsFromFile(e){try{const t=await this.vault.read(e),n=JSON.parse(t),i=n.cards||[];for(const a of i)if(a.uuid&&this.uuidIndex.set(a.uuid,{filePath:e.path,cardId:a.uuid,deckId:n.id||"unknown"}),a.sourceBlock){const t=a.sourceBlock.replace(/^\^/,"");this.blockIdIndex.set(t,{filePath:e.path,cardId:a.uuid,deckId:n.id||"unknown"})}}catch(t){_e.warn("[OrphanedLinkDetector] 解析文件失败:",e.path,t)}}async isUUIDOrphaned(e){if(this.isUUIDProtected(e))return!1;await this.ensureIndexUpToDate();const t=!this.uuidIndex.has(e);return Ce("OrphanedLinkDetector",`UUID检查: ${e} -> ${t?"孤立":"存在"}`),t}async batchCheckOrphaned(e){const t=new Map;if(0===e.length)return t;this.cleanupExpiredProtections(),await this.ensureIndexUpToDate();for(const n of e){if(this.isProtected(n)){t.set(n,!1);continue}const e=!this.blockIdIndex.has(n);t.set(n,e)}return Ce("OrphanedLinkDetector",`批量检查完成: ${e.length}个块ID，${Array.from(t.values()).filter(e=>e).length}个孤立`),t}inferCreationType(e,t,n){return n&&/^---\n[\s\S]*?tuanki-uuid:/m.test(e)?qp.BATCH_PARSE_SINGLE:e.includes("<->")?qp.BATCH_PARSE_MULTI:n&&/>\s*\[!tuanki\]/m.test(e)?qp.ANNOTATION:qp.QUICK_CREATE}clearCache(){this.uuidIndex.clear(),this.blockIdIndex.clear(),this.lastIndexUpdate=0,Ce("OrphanedLinkDetector","索引缓存已清理")}getIndexStats(){return{uuids:this.uuidIndex.size,blockIds:this.blockIdIndex.size,lastUpdate:new Date(this.lastIndexUpdate)}}}class Wp{constructor(){oe(this,"type",qp.QUICK_CREATE)}async execute(e,t){const n={success:!1,filePath:e.filePath,cleanedItems:[]};try{if(!(await this.shouldCleanup(e)))return n.success=!0,n;const i=t.getAbstractFileByPath(e.filePath);if(!(i instanceof ge.TFile))return n.error=`文件不存在: ${e.filePath}`,n;const a=await t.read(i),r=await this.removeBlockLinkFromLine(a,e.blockId);r!==a&&(await t.modify(i,r),n.cleanedItems.push(`^${e.blockId}`),Ce("QuickCreateCleanup",`清理块链接: ^${e.blockId} from ${e.filePath}`)),n.success=!0}catch(i){_e.error("[QuickCreateCleanup] 清理失败:",i),n.error=i instanceof Error?i.message:String(i)}return n}async shouldCleanup(e){return!!e.blockId&&!!e.filePath}async removeBlockLinkFromLine(e,t){const n=new RegExp(`\\s*\\^${this.escapeRegex(t)}(?![A-Za-z0-9_-])`,"gm").exec(e);if(!n)return Ce("QuickCreateCleanup",`未找到块链接 ^${t}，可能已被清理`),e;const i=e.substring(0,n.index).lastIndexOf("\n")+1,a=e.indexOf("\n",n.index),r=-1===a?e.length:a,s=e.substring(i,r),o=s.replace(new RegExp(`\\s*\\^${this.escapeRegex(t)}.*$`),"").trimEnd(),l=e.substring(0,i)+o+e.substring(r);return Ce("QuickCreateCleanup",`清理成功: ^${t}, 行: "${s}" -> "${o}"`),l}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class Gp{constructor(){oe(this,"type",qp.ANNOTATION)}async execute(e,t){const n={success:!1,filePath:e.filePath,cleanedItems:[]};try{if(!(await this.shouldCleanup(e)))return n.success=!0,n;const i=t.getAbstractFileByPath(e.filePath);if(!(i instanceof ge.TFile))return n.error=`文件不存在: ${e.filePath}`,n;const a=await t.read(i),r=this.findAnnotationBlockByUUID(a,e.uuid);if(!r)return n.error=`未找到标注块: ${e.uuid}`,n;const s=this.cleanupAnnotationBlock(a,r.startLine,r.endLine);s!==a&&(await t.modify(i,s),n.cleanedItems.push(`uuid: ${e.uuid}`),e.blockId&&n.cleanedItems.push(`^${e.blockId}`),Ce("AnnotationCleanup",`清理标注块: ${e.uuid} from ${e.filePath}`)),n.success=!0}catch(i){_e.error("[AnnotationCleanup] 清理失败:",i),n.error=i instanceof Error?i.message:String(i)}return n}async shouldCleanup(e){return!!e.uuid&&!!e.filePath}findAnnotationBlockByUUID(e,t){const n=e.split("\n"),i=new RegExp(`^>\\s*uuid:\\s*${this.escapeRegex(t)}\\s*$`),a=n.findIndex(e=>i.test(e.trim()));if(-1===a)return null;let r=-1;for(let o=a-1;o>=0;o--){if(n[o].match(/^>\s*\[!tuanki\]/)){r=o;break}if(!n[o].startsWith(">"))break}if(-1===r)return null;let s=n.length-1;for(let o=a+1;o<n.length;o++)if(!n[o].startsWith(">")){s=o-1;break}return{startLine:r,endLine:s}}cleanupAnnotationBlock(e,t,n){const i=e.split("\n"),a=new Set;for(let r=t;r<=n;r++){const e=i[r];(e.match(/^>\s*uuid:/i)||e.match(/^>\s*modified:/i)||e.match(/^>\s*created:/i)||e.match(/^>\s*version:/i)||e.match(/^>\s*\^[a-zA-Z0-9-_]+\s*$/)||">"===e.trim()&&r>t)&&a.add(r)}t>=0&&t<i.length&&(i[t]=i[t].replace(/\[!tuanki\]/,"[!note]"));return i.filter((e,t)=>!a.has(t)).join("\n")}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class Qp{constructor(e){oe(this,"type",qp.BATCH_PARSE_SINGLE),oe(this,"app"),this.app=e}async execute(e,t){const n={success:!1,filePath:e.filePath,cleanedItems:[]};try{if(!(await this.shouldCleanup(e)))return n.success=!0,n;const a=t.getAbstractFileByPath(e.filePath);if(!(a instanceof ge.TFile))return n.error=`文件不存在: ${e.filePath}`,n;const r=new Sp(this.app),s=await r.getUUID(a);if(s&&(await r.removeField(a,"tuanki-uuid"),n.cleanedItems.push(`tuanki-uuid: ${s}`),Ce("BatchParseSingleCleanup",`清理YAML UUID: ${s}`)),e.blockId)try{const i=await t.read(a),r=await this.removeBlockLink(i,e.blockId);r!==i&&(await t.modify(a,r),n.cleanedItems.push(`块链接: ^${e.blockId}`),Ce("BatchParseSingleCleanup",`清理块链接: ^${e.blockId}`))}catch(i){_e.error("[BatchParseSingleCleanup] 清理块链接失败:",i)}n.success=!0}catch(a){_e.error("[BatchParseSingleCleanup] 清理失败:",a),n.error=a instanceof Error?a.message:String(a)}return n}async shouldCleanup(e){return!(!e.uuid&&!e.blockId)&&!!e.filePath}async removeBlockLink(e,t){const n=new RegExp(`\\s*\\^${this.escapeRegex(t)}(?![A-Za-z0-9_-])`,"gm").exec(e);if(!n)return Ce("BatchParseSingleCleanup",`未找到块链接 ^${t}`),e;const i=e.substring(0,n.index).lastIndexOf("\n")+1,a=e.indexOf("\n",n.index),r=-1===a?e.length:a,s=e.substring(i,r).replace(new RegExp(`\\s*\\^${this.escapeRegex(t)}.*$`),"").trimEnd(),o=e.substring(0,i)+s+e.substring(r);return Ce("BatchParseSingleCleanup",`清理成功: ^${t}`),o}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class Kp{constructor(){oe(this,"type",qp.BATCH_PARSE_MULTI)}async execute(e,t){const n={success:!1,filePath:e.filePath,cleanedItems:[]};try{if(!(await this.shouldCleanup(e)))return n.success=!0,n;const i=t.getAbstractFileByPath(e.filePath);if(!(i instanceof ge.TFile))return n.error=`文件不存在: ${e.filePath}`,n;const a=await t.read(i),r=this.findCardBlock(a,e.blockId||e.uuid);if(!r)return n.error=`未找到卡片块: ${e.blockId||e.uuid}`,n;const s=this.markCardBlockAsDeleted(a,r.startIndex,r.endIndex);s!==a&&(await t.modify(i,s),n.cleanedItems.push(`#已删除标签 (${e.blockId||e.uuid})`),Ce("BatchParseMultiCleanup",`标记删除: ${e.blockId||e.uuid} in ${e.filePath}`)),n.success=!0}catch(i){_e.error("[BatchParseMultiCleanup] 清理失败:",i),n.error=i instanceof Error?i.message:String(i)}return n}async shouldCleanup(e){return!(!e.blockId&&!e.uuid)&&!!e.filePath}findCardBlock(e,t){const n=e.split("<->");let i=0;for(let a=0;a<n.length;a++){const e=n[a];if(e.includes(`^${t}`)||e.includes(t)){return{startIndex:i,endIndex:i+e.length,blockContent:e}}i+=e.length+3}return null}markCardBlockAsDeleted(e,t,n){const i=e.substring(t,n);if(i.includes("#已删除"))return e;const a=/<!--\s*tk-[a-z0-9]{12}\s*(?:-->|→)\s*\^[a-z0-9-_]+.*$/im,r=i.split("\n").filter(e=>!a.test(e.trim())),s=[];let o=0;for(let c=0;c<r.length;c++)if(""!==r[c].trim()){o=c;break}for(let c=0;c<r.length;c++)c===o&&(s.push("#已删除"),s.push("")),s.push(r[c]);0===o&&0===r.length&&(s.push("#已删除"),s.push(""));const l=s.join("\n");return e.substring(0,t)+l+e.substring(n)}}const Zp=class e{constructor(){oe(this,"dataStorage",null),oe(this,"vault",null),oe(this,"app",null),oe(this,"detector",null),oe(this,"strategies",new Map),oe(this,"initialized",!1)}static getInstance(){return e.instance||(e.instance=new e),e.instance}initialize(e){this.dataStorage=e.dataStorage,this.vault=e.vault,this.app=e.app,this.detector=new Hp(e.vault),this.registerStrategy(qp.QUICK_CREATE,new Wp),this.registerStrategy(qp.ANNOTATION,new Gp),this.registerStrategy(qp.BATCH_PARSE_SINGLE,new Qp(this.app)),this.registerStrategy(qp.BATCH_PARSE_MULTI,new Kp),this.initialized=!0,Ce("CleanupService","初始化完成")}registerStrategy(e,t){this.strategies.set(e,t)}getStrategy(e){const t=this.strategies.get(e);return t||(_e.warn(`[CleanupService] 未找到策略: ${e}，使用默认策略`),this.strategies.get(qp.QUICK_CREATE))}async cleanupAfterCardDeletion(e){var t;try{if(!this.vault)return{success:!1,filePath:e.sourceFile||"",error:"没有vault实例",cleanedItems:[]};if(!e.sourceFile)return{success:!0,filePath:"",cleanedItems:[]};const n=await this.inferCreationType(e),i=null==(t=e.sourceBlock)?void 0:t.replace(/^\^/,""),a={filePath:e.sourceFile||"",blockId:i,uuid:e.uuid,creationType:n,metadata:e.metadata};if(!a.filePath)return{success:!0,filePath:"",cleanedItems:[]};e.sourceBlock&&this.removeProtection(e.sourceBlock),e.uuid&&this.removeUUIDProtection(e.uuid);const r=this.getStrategy(n),s=await r.execute(a,this.vault);return Ce("CleanupService",`删除后清理完成: ${e.uuid} (${n})`),s}catch(n){return _e.error("[CleanupService] 删除后清理失败:",n),{success:!1,filePath:e.sourceFile||"",cleanedItems:[],error:n instanceof Error?n.message:String(n)}}}async cleanupBlockLink(e,t){if(!this.initialized)return{success:!1,filePath:e,cleanedItems:[],error:"清理服务未初始化"};try{const n={filePath:e,blockId:t,creationType:qp.QUICK_CREATE},i=this.getStrategy(qp.QUICK_CREATE);return await i.execute(n,this.vault)}catch(n){return _e.error("[CleanupService] 清理块链接失败:",n),{success:!1,filePath:e,cleanedItems:[],error:n instanceof Error?n.message:String(n)}}}async cleanupUUID(e,t){var n,i;if(!this.initialized)return{success:!1,filePath:e,cleanedItems:[],error:"清理服务未初始化"};try{const a=null==(n=this.vault)?void 0:n.getAbstractFileByPath(e);if(!(a instanceof ge.TFile))return{success:!1,filePath:e,cleanedItems:[],error:"文件不存在"};const r=await(null==(i=this.vault)?void 0:i.read(a));if(!r)return{success:!1,filePath:e,cleanedItems:[],error:"无法读取文件内容"};const s=this.inferCreationTypeFromContent(r,void 0,t),o={filePath:e,uuid:t,creationType:s},l=this.getStrategy(s);return await l.execute(o,this.vault)}catch(a){return _e.error("[CleanupService] 清理UUID失败:",a),{success:!1,filePath:e,cleanedItems:[],error:a instanceof Error?a.message:String(a)}}}async cleanupFile(e){var t;if(!this.initialized)return{success:!1,filePath:e.path,cleanedItems:[],error:"清理服务未初始化"};const n={success:!0,filePath:e.path,cleanedItems:[]};try{const a=await(null==(t=this.detector)?void 0:t.detectInFile(e));if(!a||0===a.length)return Ce("CleanupService",`文件无孤立引用: ${e.path}`),n;Ce("CleanupService",`发现 ${a.length} 个孤立引用: ${e.path}`);const r=new Map;for(const e of a){const t=r.get(e.creationType)||[];t.push(e),r.set(e.creationType,t)}for(const[t,s]of r){const a=this.getStrategy(t);for(const r of s){const s={filePath:e.path,blockId:r.blockId,uuid:r.uuid,creationType:t};try{const e=await a.execute(s,this.vault);e.success&&n.cleanedItems.push(...e.cleanedItems)}catch(i){_e.error("[CleanupService] 清理单个引用失败:",r,i)}}}Ce("CleanupService",`文件清理完成: ${e.path}, 清理 ${n.cleanedItems.length} 项`)}catch(i){_e.error("[CleanupService] 文件清理失败:",e.path,i),n.success=!1,n.error=i instanceof Error?i.message:String(i)}return n}async inferCreationType(e){var t,n,i;if(null==(t=e.metadata)?void 0:t.creationType)return e.metadata.creationType;if(!e.sourceFile)return qp.QUICK_CREATE;try{const t=null==(n=this.vault)?void 0:n.getAbstractFileByPath(e.sourceFile);if(!(t instanceof ge.TFile))return qp.QUICK_CREATE;const a=await(null==(i=this.vault)?void 0:i.read(t));return a?this.inferCreationTypeFromContent(a,e.sourceBlock,e.uuid):qp.QUICK_CREATE}catch(a){return _e.warn("[CleanupService] 读取文件失败，使用默认创建方式:",a),qp.QUICK_CREATE}}inferCreationTypeFromContent(e,t,n){return n&&/^---\n[\s\S]*?tuanki-uuid:/m.test(e)?qp.BATCH_PARSE_SINGLE:e.includes("<->")?qp.BATCH_PARSE_MULTI:n&&/>\s*\[!tuanki\]/m.test(e)?qp.ANNOTATION:qp.QUICK_CREATE}getDetector(){return this.detector}markRecentlyCreated(e){this.detector?this.detector.markRecentlyCreated(e):_e.warn("[CleanupService] 检测器未初始化，无法标记保护")}removeProtection(e){this.detector&&this.detector.removeProtection(e)}removeUUIDProtection(e){this.detector&&this.detector.removeUUIDProtection(e)}markUUIDRecentlyCreated(e){this.detector?this.detector.markUUIDRecentlyCreated(e):_e.warn("[CleanupService] 检测器未初始化，无法标记UUID保护")}};oe(Zp,"instance");let Yp=Zp;class Xp{constructor(e,t,n,i){oe(this,"cleanupService"),oe(this,"detector"),oe(this,"vault"),oe(this,"app"),oe(this,"isCancelled",!1),oe(this,"progressCallback"),oe(this,"BATCH_SIZE",50),oe(this,"TIME_SLICE",50),this.cleanupService=e,this.detector=t,this.vault=n,this.app=i}async scanAndCleanup(e){const t={totalFiles:0,filesWithOrphans:0,totalOrphans:0,cleanedOrphans:0,errors:[],duration:0},n=Date.now();this.isCancelled=!1;try{_e.debug("[GlobalScanner] 🔍 开始智能过滤文件...");const a=await this.getFilesToScan();if(t.totalFiles=a.length,_e.debug(`[GlobalScanner] 📂 找到 ${a.length} 个候选文件`),0===a.length)return t.duration=Date.now()-n,t;for(let n=0;n<a.length;n+=this.BATCH_SIZE){if(this.isCancelled){_e.debug("[GlobalScanner] ⚠️ 扫描已取消");break}const r=a.slice(n,n+this.BATCH_SIZE);for(let s=0;s<r.length;s++){const o=r[s],l=n+s;try{const e=await this.detector.detectInFile(o);if(e.length>0){t.filesWithOrphans++,t.totalOrphans+=e.length;const n=await this.cleanupService.cleanupFile(o);n.success&&(t.cleanedOrphans+=n.cleanedItems.length)}}catch(i){t.errors.push({filePath:o.path,error:i instanceof Error?i.message:String(i)}),_e.error("[GlobalScanner] 处理文件失败:",o.path,i)}e&&e({phase:"cleaning",currentFile:o.path,processedFiles:l+1,totalFiles:a.length,cleanedCount:t.cleanedOrphans,percentage:Math.round((l+1)/a.length*100)})}await this.yieldMainThread()}e&&e({phase:"completed",currentFile:"",processedFiles:a.length,totalFiles:a.length,cleanedCount:t.cleanedOrphans,percentage:100})}catch(i){_e.error("[GlobalScanner] 扫描失败:",i),t.errors.push({filePath:"",error:i instanceof Error?i.message:String(i)})}return t.duration=Date.now()-n,_e.debug("[GlobalScanner] ✅ 扫描完成:",{totalFiles:t.totalFiles,filesWithOrphans:t.filesWithOrphans,totalOrphans:t.totalOrphans,cleanedOrphans:t.cleanedOrphans,errors:t.errors.length,duration:`${(t.duration/1e3).toFixed(1)}s`}),t}onProgress(e){return this.progressCallback=e,()=>{this.progressCallback=void 0}}async performCleanup(){return this.scanAndCleanup(this.progressCallback)}cancel(){this.isCancelled=!0,_e.debug("[GlobalScanner] 🛑 取消扫描")}async getFilesToScan(){const e=this.vault.getMarkdownFiles(),t=e.filter(e=>{const t=this.app.metadataCache.getFileCache(e);return(null==t?void 0:t.blocks)&&Object.keys(t.blocks).length>0});_e.debug(`[GlobalScanner] 第一轮过滤: ${t.length}/${e.length} 个文件有块链接`);const n=[];for(const a of t)try{const e=await this.vault.cachedRead(a);/\^we-[a-z0-9]{6}/.test(e)&&n.push(a)}catch(i){_e.warn("[GlobalScanner] 读取文件失败:",a.path,i)}return _e.debug(`[GlobalScanner] 第二轮过滤: ${n.length}/${t.length} 个文件包含we-块链接`),n}yieldMainThread(){return new Promise(e=>setTimeout(e,10))}}class Jp extends ge.Modal{constructor(e,t){super(e),oe(this,"scanner"),oe(this,"progressBar"),oe(this,"currentFileEl"),oe(this,"progressTextEl"),oe(this,"statsEl"),oe(this,"cancelBtn"),oe(this,"isCancelled",!1),oe(this,"isCompleted",!1),this.scanner=t}onOpen(){this.buildUI()}onClose(){this.contentEl.empty()}buildUI(){const{contentEl:e}=this;e.empty(),e.addClass("tuanki-cleanup-progress-modal");e.createDiv("modal-header").createEl("h2",{text:"🧹 全局清理孤立块链接"});const t=e.createDiv("modal-body"),n=t.createDiv("progress-container");this.progressBar=n.createDiv("progress-bar"),this.progressBar.style.width="0%";const i=t.createDiv("status-section"),a=i.createDiv("current-file");a.createSpan({text:"当前文件: ",cls:"label"}),this.currentFileEl=a.createSpan({text:"准备中...",cls:"value"});const r=i.createDiv("progress-text");this.progressTextEl=r.createSpan({text:"0 / 0 文件"}),this.statsEl=t.createDiv("stats-section"),this.updateStats(0,0);const s=e.createDiv("modal-footer");this.cancelBtn=s.createEl("button",{text:"取消",cls:"cancel-btn"}),this.cancelBtn.onclick=()=>this.handleCancel()}updateProgress(e){this.progressBar.style.width=`${e.percentage}%`;const t=e.currentFile?e.currentFile.split("/").pop():"";this.currentFileEl.textContent=t||"处理中...",this.progressTextEl.textContent=`${e.processedFiles} / ${e.totalFiles} 文件`,this.updateStats(e.processedFiles,e.cleanedCount)}showResult(e){this.isCompleted=!0,this.progressBar.style.width="100%",this.currentFileEl.textContent="完成",this.progressTextEl.textContent=`扫描完成 - 用时 ${(e.duration/1e3).toFixed(1)}秒`,this.statsEl.empty();if([{label:"扫描文件",value:e.totalFiles},{label:"包含孤立引用",value:e.filesWithOrphans},{label:"发现孤立引用",value:e.totalOrphans},{label:"已清理",value:e.cleanedOrphans}].forEach(e=>{const t=this.statsEl.createDiv("stat-item");t.createSpan({text:`${e.label}: `,cls:"stat-label"}),t.createSpan({text:String(e.value),cls:"stat-value"})}),e.errors.length>0){const t=this.statsEl.createDiv("stat-item error");t.createSpan({text:"错误: ",cls:"stat-label"}),t.createSpan({text:String(e.errors.length),cls:"stat-value"})}this.cancelBtn.textContent="关闭",this.cancelBtn.removeClass("cancel-btn"),this.cancelBtn.addClass("close-btn")}updateStats(e,t){this.statsEl.empty();[{label:"已处理",value:e,cls:"processed"},{label:"已清理",value:t,cls:"cleaned"}].forEach(e=>{const t=this.statsEl.createDiv("stat-item");t.createSpan({text:`${e.label}: `,cls:"stat-label"}),t.createSpan({text:String(e.value),cls:`stat-value ${e.cls}`})})}handleCancel(){this.isCompleted?this.close():(this.isCancelled=!0,this.scanner.cancel(),this.cancelBtn.textContent="取消中...",this.cancelBtn.disabled=!0,setTimeout(()=>{this.close()},2e3))}}class eg{constructor(e,t="tuanki"){oe(this,"vault"),oe(this,"adapter"),oe(this,"dataFolder"),oe(this,"uuidIndex",new Map),oe(this,"blockIdIndex",new Map),oe(this,"lastIndexUpdate",0),oe(this,"INDEX_TTL",3e4),oe(this,"performanceLoggingEnabled",!1),oe(this,"queryCount",0),oe(this,"totalQueryTime",0),oe(this,"cacheHits",0),oe(this,"indexRebuildCount",0),oe(this,"fileWatcherRefs",[]),this.vault=e,this.adapter=e.adapter,this.dataFolder=t,this.setupFileWatcher()}async getCardByUUID(e){const t=performance.now();try{await this.ensureIndexUpToDate();const n=this.uuidIndex.get(e);if(!n)return this.logPerformance("getCardByUUID",t,!1),null;const i=await this.readCardFromLocation(n,e);return this.logPerformance("getCardByUUID",t,!0),i}catch(n){return _e.error("[DirectFileCardReader] getCardByUUID失败:",n),this.logPerformance("getCardByUUID",t,!1),null}}async getAllCards(){const e=performance.now();try{const t=await this.getAllDeckFiles(),n=(await Promise.all(t.map(async e=>{try{const t=await this.adapter.read(e);return JSON.parse(t).cards||[]}catch(t){return _e.error(`[DirectFileCardReader] 读取文件失败: ${e}`,t),[]}}))).flat();return this.logPerformance("getAllCards",e,!0),n}catch(t){return _e.error("[DirectFileCardReader] getAllCards失败:",t),this.logPerformance("getAllCards",e,!1),[]}}async getCardsPage(e,t,n){const i=performance.now();try{const a=await this.getAllCards();let r=a;n&&(r=this.applyFilters(a,n));const s=e*t,o=s+t,l=r.slice(s,o);return this.logPerformance("getCardsPage",i,!0),l}catch(a){return _e.error("[DirectFileCardReader] getCardsPage失败:",a),this.logPerformance("getCardsPage",i,!1),[]}}async searchCards(e){const t=performance.now();try{if(!e.trim())return[];const n=await this.getAllCards(),i=e.toLowerCase(),a=n.filter(e=>{const t=this.getCardFieldText(e,"front").toLowerCase(),n=this.getCardFieldText(e,"back").toLowerCase(),a=(e.tags||[]).join(" ").toLowerCase();return t.includes(i)||n.includes(i)||a.includes(i)});return this.logPerformance("searchCards",t,!0),a}catch(n){return _e.error("[DirectFileCardReader] searchCards失败:",n),this.logPerformance("searchCards",t,!1),[]}}async getCardCount(){return await this.ensureIndexUpToDate(),this.uuidIndex.size}async ensureIndexUpToDate(){const e=Date.now();e-this.lastIndexUpdate<this.INDEX_TTL||(await this.buildIndex(),this.lastIndexUpdate=e,this.indexRebuildCount++)}async buildIndex(){this.uuidIndex.clear(),this.blockIdIndex.clear();try{const e=await this.getAllDeckFiles();for(const t of e)await this.indexCardsFromFile(t)}catch(e){_e.error("[DirectFileCardReader] 构建索引失败:",e)}}async indexCardsFromFile(e){try{const t=await this.adapter.read(e),n=JSON.parse(t),i=n.cards||[];for(const a of i){const t={filePath:e,cardId:a.uuid,deckId:n.id||"unknown"};if(a.uuid&&this.uuidIndex.set(a.uuid,t),a.sourceBlock){const e=a.sourceBlock.replace(/^\^/,"");this.blockIdIndex.set(e,t)}}}catch(t){_e.error(`[DirectFileCardReader] 索引文件失败: ${e}`,t)}}async updateIndexForFile(e){try{this.removeIndexEntriesForFile(e.path),await this.indexCardsFromFile(e.path)}catch(t){_e.error("[DirectFileCardReader] 增量更新失败:",t)}}removeIndexEntriesForFile(e){for(const[t,n]of this.uuidIndex.entries())n.filePath===e&&this.uuidIndex.delete(t);for(const[t,n]of this.blockIdIndex.entries())n.filePath===e&&this.blockIdIndex.delete(t)}async getAllDeckFiles(){const e=[],t=`${this.dataFolder}/decks`;try{const i=await this.adapter.list(t);for(const t of i.files){const n=t.split("/").pop()||"";"decks.json"!==n&&n.endsWith(".json")&&e.push(t)}for(const t of i.folders)try{const n=await this.adapter.list(t);for(const t of n.files){"cards.json"===(t.split("/").pop()||"")&&e.push(t)}}catch(n){_e.debug("[DirectFileCardReader] 跳过子文件夹:",t)}}catch(n){_e.error("[DirectFileCardReader] 获取牌组文件失败:",n)}return e}async readCardFromLocation(e,t){try{const n=await this.adapter.read(e.filePath),i=JSON.parse(n);return(i.cards||[]).find(e=>e.uuid===t)||null}catch(n){return _e.error("[DirectFileCardReader] 读取卡片失败:",n),null}}setupFileWatcher(){const e=this.vault.on("modify",async e=>{e instanceof ge.TFile&&this.isDeckFile(e)&&await this.updateIndexForFile(e)}),t=this.vault.on("delete",e=>{e instanceof ge.TFile&&this.isDeckFile(e)&&this.removeIndexEntriesForFile(e.path)});this.fileWatcherRefs=[e,t]}isDeckFile(e){if(!(e instanceof ge.TFile))return!1;if("json"!==e.extension)return!1;const t=`${this.dataFolder}/decks`;return e.path.startsWith(t)&&"decks.json"!==e.name}applyFilters(e,t){let n=e;if(t.deckId&&(n=n.filter(e=>e.deckId===t.deckId)),t.tags&&t.tags.length>0&&(n=n.filter(e=>{const n=e.tags||[];return t.tags.some(e=>n.includes(e))})),void 0!==t.state&&(n=n.filter(e=>{var n;return(null==(n=e.fsrs)?void 0:n.state)===t.state})),t.searchQuery){const e=t.searchQuery.toLowerCase();n=n.filter(t=>{const n=this.getCardFieldText(t,"front").toLowerCase(),i=this.getCardFieldText(t,"back").toLowerCase();return n.includes(e)||i.includes(e)})}return n}getCardFieldText(e,t){if(!e.fields)return"";const n=e.fields[t];return n?"string"==typeof n?n:"object"==typeof n&&null!==n&&"text"in n?n.text:"":""}enablePerformanceLogging(){this.performanceLoggingEnabled=!0}disablePerformanceLogging(){this.performanceLoggingEnabled=!1}logPerformance(e,t,n){const i=performance.now()-t;this.queryCount++,this.totalQueryTime+=i,n&&this.cacheHits++,this.performanceLoggingEnabled}getPerformanceStats(){return{totalQueries:this.queryCount,avgQueryTime:this.queryCount>0?this.totalQueryTime/this.queryCount:0,cacheHitRate:this.queryCount>0?this.cacheHits/this.queryCount*100:0,indexRebuildCount:this.indexRebuildCount,lastRebuildTime:this.lastIndexUpdate}}resetPerformanceStats(){this.queryCount=0,this.totalQueryTime=0,this.cacheHits=0,this.indexRebuildCount=0}dispose(){this.fileWatcherRefs.forEach(e=>{this.vault.offref(e)}),this.fileWatcherRefs=[],this.uuidIndex.clear(),this.blockIdIndex.clear()}clearCache(){this.uuidIndex.clear(),this.blockIdIndex.clear(),this.lastIndexUpdate=0}getIndexStats(){return{uuids:this.uuidIndex.size,blockIds:this.blockIdIndex.size,lastUpdate:new Date(this.lastIndexUpdate)}}updateCardIndex(e){if(!e.uuid||!e.deckId)return void _e.warn("[DirectFileCardReader] 卡片缺少UUID或deckId，跳过索引更新");const t={filePath:`${this.dataFolder}/decks/${e.deckId}/cards.json`,cardId:e.uuid,deckId:e.deckId};if(this.uuidIndex.set(e.uuid,t),e.sourceBlock){const n=e.sourceBlock.replace(/^\^/,"");this.blockIdIndex.set(n,t)}}removeCardIndex(e,t){if(t)this.uuidIndex.delete(t);else{for(const[t,n]of this.uuidIndex.entries())if(n.cardId===e){this.uuidIndex.delete(t);break}for(const[t,n]of this.blockIdIndex.entries())if(n.cardId===e){this.blockIdIndex.delete(t);break}}}batchUpdateCardIndex(e){for(const t of e)this.updateCardIndex(t)}}class tg{constructor(e,t="tuanki"){oe(this,"vault"),oe(this,"dataFolder"),oe(this,"uuidToDeck",new Map),oe(this,"lastIndexUpdate",0),oe(this,"INDEX_TTL",6e4),oe(this,"initialized",!1),this.vault=e,this.dataFolder=t}async initialize(){if(this.initialized)return void _e.debug("[CardIndexService] 已经初始化，跳过");_e.debug("[CardIndexService] 开始构建卡片索引...");const e=performance.now();await this.buildIndex(),this.initialized=!0;const t=performance.now()-e;_e.debug(`[CardIndexService] ✅ 索引构建完成: ${this.uuidToDeck.size}张卡片, 耗时${t.toFixed(2)}ms`)}getDeckIdByUUID(e){return this.uuidToDeck.get(e)}updateCardIndex(e,t){this.uuidToDeck.set(e,t)}removeCardIndex(e){this.uuidToDeck.delete(e)}batchUpdateIndex(e){for(const t of e)t.uuid&&this.updateCardIndex(t.uuid,t.deckId)}async ensureIndexUpToDate(){Date.now()-this.lastIndexUpdate<this.INDEX_TTL||(_e.debug("[CardIndexService] 索引已过期，重建中..."),await this.buildIndex())}async buildIndex(){this.uuidToDeck.clear();try{const e=await this.getAllDeckFiles();for(const t of e)await this.indexCardsFromFile(t);this.lastIndexUpdate=Date.now()}catch(e){_e.error("[CardIndexService] 构建索引失败:",e)}}async indexCardsFromFile(e){try{const t=await this.vault.read(e),n=JSON.parse(t),i=n.cards||[],a=n.id||this.extractDeckIdFromPath(e.path);for(const e of i)e.uuid&&this.uuidToDeck.set(e.uuid,a)}catch(t){_e.error(`[CardIndexService] 索引文件失败: ${e.path}`,t)}}async getAllDeckFiles(){const e=[],t=`${this.dataFolder}/decks`;try{const n=this.vault.getAbstractFileByPath(t);if(!n||!("children"in n))return e;for(const t of n.children)if(t instanceof ge.TFile){if("decks.json"===t.name)continue;"json"===t.extension&&e.push(t)}else if("children"in t)for(const n of t.children)n instanceof ge.TFile&&"cards.json"===n.name&&e.push(n)}catch(n){_e.error("[CardIndexService] 获取牌组文件失败:",n)}return e}extractDeckIdFromPath(e){const t=e.split("/"),n=t.indexOf("decks")+1;return t[n]||"unknown"}getStats(){const e=new Set(this.uuidToDeck.values());return{totalCards:this.uuidToDeck.size,totalDecks:e.size,lastUpdate:new Date(this.lastIndexUpdate)}}dispose(){this.uuidToDeck.clear(),_e.debug("[CardIndexService] 资源已清理")}clearCache(){this.uuidToDeck.clear(),this.lastIndexUpdate=0,_e.debug("[CardIndexService] 索引缓存已清理")}}const ng={defaultDeck:"默认牌组",reviewsPerDay:20,newCardsPerDay:20,enableNotifications:!0,theme:"auto",language:"zh-CN",autoShowAnswerSeconds:0,learningSteps:[1,10],graduatingInterval:1,maxAdvanceDays:7,enableShortcuts:!0,showFloatingCreateButton:!0,dataBackupIntervalHours:24,autoBackupConfig:{enabled:!0,intervalHours:24,triggers:{onStartup:!0,onCardThreshold:!0,cardThresholdCount:100},notifications:{onSuccess:!0,onFailure:!0},lastAutoBackupTime:void 0,autoBackupCount:0},multipleChoiceStats:{totalQuestions:0,correctAnswers:0,totalAttempts:0,lastUpdated:(new Date).toISOString()},navigationVisibility:{deckStudy:!0,cardManagement:!0,aiAssistant:!0,statistics:!0},showSettingsButton:!0,dataFolderVisibility:{hideInFileExplorer:!0,folderName:"tuanki",userAcknowledgedRisk:!1},enablePersonalization:!0,personalizationSettings:{enabled:!0,minDataPoints:50,enableBacktracking:!0,checkpointInterval:50,performanceThreshold:.1,autoOptimization:!0},editorModalSize:{preset:"large",customWidth:800,customHeight:600,rememberLastSize:!0,enableResize:!0},cardManagementViewPreferences:{currentView:"table",gridLayout:"fixed",gridCardAttribute:"uuid",kanbanLayoutMode:"comfortable",tableViewMode:"basic",enableCardLocationJump:!1},studyInterfaceViewPreferences:{showSidebar:!0,sidebarCompactModeSetting:"auto",statsCollapsed:!0,cardOrder:"sequential",sidebarPosition:"right"},queueOptimization:{learningSteps:{enabled:!0,steps:[1,10],maxFailures:5,showProgressIndicator:!0},interleaving:{enabled:!0,mode:"smart",respectPriority:!0,minGroupSize:3,maxConsecutiveSameTag:2},difficultyTracking:{enabled:!0,showIndicator:!0,autoTag:!0,interventionThreshold:2,trendAnalysisWindow:5},priority:{enableUserPriority:!0,enableDifficultyAdjustment:!0,enableLeechBoost:!0}},enableDirectDelete:!1,license:{activationCode:"",isActivated:!1,activatedAt:"",deviceFingerprint:"",expiresAt:"",productVersion:"",licenseType:"lifetime"},fsrsParams:{w:[.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,.1542],requestRetention:.9,maximumInterval:365,enableFuzz:!0,optimizationHistory:[],pendingOptimization:void 0},simplifiedParsing:Ph,migrationCompleted:!1,editor:{linkStyle:"wikilink",linkPath:"short",preferAlias:!0,attachmentDir:"Tuanki Assets",embedImages:!0},cardManager:{visibleFields:{table:{front:!0,back:!0,status:!0,due:!0,difficulty:!0,priority:!0,tags:!0,deck:!0,backlink:!0,actions:!0},grid:{tags:!0,priority:!0,deck:!0,backlink:!0}},sort:{primary:{field:"due",order:"asc"},secondary:null},defaultFilters:{tag:"",status:""}},clozeSettings:{enabled:!0,openDelimiter:"==",closeDelimiter:"==",placeholder:"[...]"},mediaAutoPlay:{enabled:!1,mode:"first",timing:"cardChange",playbackInterval:2e3},enableDebugMode:!1,showPerformanceSettings:!1,repairTool:{repairScope:"current-file",repairMissingBlockIds:!0,repairMissingUUIDs:!0,repairMissingTimestamps:!0,repairMalformedCallouts:!0,createBackupBeforeRepair:!1,confirmBeforeBatchRepair:!0,blockIdGenerationStrategy:"random",timestampStrategy:"current"},ankiConnect:{enabled:!1,endpoint:"http://localhost:8765",mediaSync:{enabled:!0,largeFileThresholdMB:10,supportedTypes:["png","jpg","jpeg","gif","mp3","mp4"],createBacklinks:!0},autoSync:{enabled:!1,intervalMinutes:30,syncOnStartup:!1,onlyWhenAnkiRunning:!0,prioritizeRecent:!0},bidirectionalSync:{enabled:!1,conflictResolution:"tuanki_wins"},deckMappings:{},templateMappings:{},syncLogs:[],maxLogEntries:100,tutorialCompleted:!1,tutorialStep:0},annotation:{autoDetectionEnabled:!0,detectionInterval:1e3,autoCreateDecks:!0,defaultDeckId:"",defaultTemplateId:"official-qa",showNotifications:!0,maxConcurrentTasks:3,debounceDelay:1e3,debugMode:!1,bidirectionalSyncEnabled:!0,onlyActiveFileAutoSync:!0},aiConfig:{apiKeys:{},providers:{},defaultProvider:"zhipu",lastUsedProvider:void 0,lastUsedModel:void 0,modelDefaults:{},usage:{totalGenerations:0,totalCards:0,successfulImports:0,totalCost:0,monthlyCost:0},security:{encryptApiKeys:!1,enableContentFilter:!0,anonymousStats:!0},formatting:{enabled:!0},globalParams:{temperature:.1,maxTokens:2e3,requestTimeout:3e4,concurrentLimit:3},promptTemplates:{official:[],custom:[]},imageGeneration:{defaultSyntax:"wiki",attachmentDir:"Tuanki Assets",autoCreateSubfolders:!0,includeTimestamp:!0,includeCaption:!1},history:{enabled:!0,retentionDays:30,showCostStats:!0,autoCleanFailures:!1},customFormatActions:[],customTestGenActions:[],customSplitActions:[],officialFormatActions:{choice:{enabled:!0},mathFormula:{enabled:!0},memoryAid:{enabled:!0}}}};class ig extends ge.Plugin{constructor(){super(...arguments),oe(this,"settings"),oe(this,"dataStorage"),oe(this,"fsrs"),oe(this,"wasmUrl"),oe(this,"editorPoolManager"),oe(this,"annotationSystem"),oe(this,"cardRelationService"),oe(this,"deckHierarchy"),oe(this,"mediaManager"),oe(this,"indexManager"),oe(this,"shortcutService"),oe(this,"filterStateService"),oe(this,"dataSyncService"),oe(this,"questionBankStorage"),oe(this,"questionBankService"),oe(this,"questionBankHierarchy"),oe(this,"uiManager"),oe(this,"dataFolderHider"),oe(this,"blockLinkCleanupService"),oe(this,"directFileReader"),oe(this,"cardIndexService"),oe(this,"batchParsingWatcher"),oe(this,"cardConverter"),oe(this,"batchCardSaver"),oe(this,"batchParsingManager"),oe(this,"simplifiedCardParser"),oe(this,"currentCreateCardModal",null),oe(this,"currentEditCardModal",null),oe(this,"ankiConnectService",null),oe(this,"autoBackupScheduler",null),oe(this,"queueOptimizationSystem"),oe(this,"cachedDecks",[])}async loadSettings(){const e=await this.loadData();this.settings=this.deepMerge(ng,e),this.settings.simplifiedParsing||(_e.warn("[Plugin] settings.simplifiedParsing 不存在，使用默认值"),this.settings.simplifiedParsing=Ph),this.settings.simplifiedParsing.batchParsing||(_e.warn("[Plugin] settings.simplifiedParsing.batchParsing 不存在，使用默认值"),this.settings.simplifiedParsing.batchParsing=Ph.batchParsing),await this.migrateFSRSParameters(),await this.migrateLicenseData(),await this.migrateDelimiterConfig();const t=this.settings.language||"zh-CN";Up.setLanguage(t),Fp.set(t)}async migrateFSRSParameters(){var e,t,n,i,a;try{const i=null==(e=this.settings.fsrsParams)?void 0:e.w,a=21;if(!i||!Array.isArray(i)){const e=null==(t=this.settings.fsrsParams)?void 0:t.optimizationHistory,i=null==(n=this.settings.fsrsParams)?void 0:n.pendingOptimization;return this.settings.fsrsParams={...this.settings.fsrsParams,w:[...ng.fsrsParams.w],optimizationHistory:e||[],pendingOptimization:i},_e.info("FSRS参数已初始化"),void(await this.saveSettings())}let r=!1,s="";if(i.length!==a)r=!0,s=`参数数量不匹配 (当前: ${i.length}, 期望: ${a})`;else{i.some((e,t)=>!("number"==typeof e&&!Number.isNaN(e))||(7===t&&(e<0||e>.5)||(e<-10||e>100)))&&(r=!0,s="检测到无效的参数值（超出合理范围）")}r&&(_e.info("FSRS参数已优化"),this.settings.fsrsParams.w=[...ng.fsrsParams.w],("number"!=typeof this.settings.fsrsParams.requestRetention||this.settings.fsrsParams.requestRetention<.5||this.settings.fsrsParams.requestRetention>.99)&&(this.settings.fsrsParams.requestRetention=ng.fsrsParams.requestRetention),("number"!=typeof this.settings.fsrsParams.maximumInterval||this.settings.fsrsParams.maximumInterval<1||this.settings.fsrsParams.maximumInterval>1825)&&(this.settings.fsrsParams.maximumInterval=ng.fsrsParams.maximumInterval),await this.saveSettings(),this.settings.enableNotifications&&setTimeout(()=>{new ge.Notice(`FSRS6参数已自动修复（${s}）`,5e3)},2e3))}catch(r){_e.error("FSRS参数迁移失败",r);const e=null==(i=this.settings.fsrsParams)?void 0:i.optimizationHistory,t=null==(a=this.settings.fsrsParams)?void 0:a.pendingOptimization;this.settings.fsrsParams={...ng.fsrsParams,optimizationHistory:e||[],pendingOptimization:t},await this.saveSettings(),_e.info("FSRS参数已重置为默认值")}}async migrateLicenseData(){try{const e=this.settings.license;if(!e)return _e.warn("许可证数据不存在，使用默认值"),this.settings.license=Os,void(await this.saveSettings());let t=!1;void 0===e.activationCode&&(e.activationCode="",t=!0),void 0===e.isActivated&&(e.isActivated=!1,t=!0),void 0===e.activatedAt&&(e.activatedAt="",t=!0),void 0===e.deviceFingerprint&&(e.deviceFingerprint="",t=!0),void 0===e.expiresAt&&(e.expiresAt="",t=!0),void 0===e.productVersion&&(e.productVersion="",t=!0),void 0===e.licenseType&&(e.licenseType="lifetime",t=!0),t&&(_e.info("许可证数据已自动补全缺失字段"),await this.saveSettings())}catch(e){_e.error("许可证数据迁移失败",e)}}async migrateDelimiterConfig(){var e,t,n,i,a,r,s,o,l;try{const c="%%<->%%",d="<->";let u=!1,h=0;const p=[];if((null==(t=null==(e=this.settings.simplifiedParsing)?void 0:e.symbols)?void 0:t.cardDelimiter)===c&&(this.settings.simplifiedParsing.symbols.cardDelimiter=d,u=!0,h++,p.push("全局分隔符配置")),(null==(n=this.settings.simplifiedParsing)?void 0:n.regexPresets)&&Array.isArray(this.settings.simplifiedParsing.regexPresets))for(let e=0;e<this.settings.simplifiedParsing.regexPresets.length;e++){const t=this.settings.simplifiedParsing.regexPresets[e];let n=!1;(null==(i=t.separatorMode)?void 0:i.cardSeparator)===c&&(t.separatorMode.cardSeparator=d,n=!0,h++),n&&(u=!0,p.push(`预设模板 "${t.name||`预设${e+1}`}"`))}if((null==(r=null==(a=this.settings.simplifiedParsing)?void 0:a.batchParsing)?void 0:r.folderDeckMappings)&&Array.isArray(this.settings.simplifiedParsing.batchParsing.folderDeckMappings))for(let e=0;e<this.settings.simplifiedParsing.batchParsing.folderDeckMappings.length;e++){const t=this.settings.simplifiedParsing.batchParsing.folderDeckMappings[e];let n=!1;if(null==(s=t.multiCardsConfig)?void 0:s.parsingConfig){const i=t.multiCardsConfig.parsingConfig;if((null==(o=i.separatorMode)?void 0:o.cardSeparator)===c&&(i.separatorMode.cardSeparator=d,n=!0,h++),(null==(l=i.patternMode)?void 0:l.cardSeparator)===c&&(i.patternMode.cardSeparator=d,n=!0,h++),n){u=!0;const n=t.path||t.folderPath||`映射${e+1}`;p.push(`映射配置 "${n}"`)}}}u&&(await this.saveSettings(),_e.info(`配置已更新 (${h}处)`),this.settings.enableNotifications&&setTimeout(()=>{new ge.Notice(`✅ 分隔符配置已自动迁移\n已将 ${h} 处 %%<->%% 更新为 <->`,5e3)},2e3))}catch(c){_e.error("分隔符配置迁移失败",c)}}deepMerge(e,t){const n={...e};for(const i in t)t.hasOwnProperty(i)&&(t[i]&&"object"==typeof t[i]&&!Array.isArray(t[i])?n[i]=this.deepMerge(e[i]||{},t[i]):n[i]=t[i]);return n}async saveSettings(){_e.setDebugMode(this.settings.enableDebugMode||!1),await this.saveData(this.settings),this.simplifiedCardParser&&this.settings.simplifiedParsing&&this.simplifiedCardParser.updateSettings(this.settings.simplifiedParsing),this.batchParsingManager&&this.settings.simplifiedParsing&&this.batchParsingManager.updateParserSettings(this.settings.simplifiedParsing);const e=Qh.getInstance();await e.updateLicense(this.settings.license),this.batchParsingWatcher&&this.batchParsingWatcher.destroy(),await this.initBatchParsingWatcher()}getDefaultTemplateId(){return""}async migrateDeckCategories(){try{const{getCategoryStorage:e}=await Promise.resolve().then(()=>$_e),t=e();await t.initialize();const n=await t.getCategories();if(0===n.length)return;const i=await this.dataStorage.getDecks();let a=0;for(const r of i)if(!(r.categoryIds&&r.categoryIds.length>0))if(r.category){const e=n.find(e=>e.name===r.category||e.id===r.category);e?(r.categoryIds=[e.id],await this.dataStorage.saveDeck(r),a++):(r.categoryIds=[n[0].id],await this.dataStorage.saveDeck(r),a++)}else r.categoryIds=[n[0].id],await this.dataStorage.saveDeck(r),a++;a>0&&_e.info(`分类迁移完成 (${a}/${i.length})`)}catch(e){_e.error("[CategoryMigration] 迁移失败:",e)}}async validateLicense(){var e;try{if(this.settings.license.isActivated){const t=await Es.validateCurrentLicense(this.settings.license);t.isValid?(null==(e=t.warnings)?void 0:e.includes("设备指纹已自动更新到新版本"))&&await this.saveSettings():(_e.warn("许可证验证失败:",t.error),this.settings.license.isActivated=!1,await this.saveSettings(),this.showLicenseExpiredNotice(t.error||"许可证验证失败"))}}catch(t){_e.error("许可证验证过程中发生错误:",t)}}showLicenseExpiredNotice(e){var t;const n=function(e,t){return new Ps(e,t)}(`许可证失效: ${e}`,0),i=document.createDocumentFragment(),a=document.createTextNode(`许可证失效: ${e} `),r=document.createElement("button");r.textContent="前往设置",r.style.marginLeft="8px",r.onclick=()=>{!function(e,t){try{ki(()=>{(null==e?void 0:e.setting)&&"function"==typeof e.setting.open?(e.setting.open(),t&&"function"==typeof e.setting.openTabById&&setTimeout(()=>{try{e.setting.openTabById(t)}catch(n){_e.warn("[SafeSettings] 打开标签失败:",n)}},100)):_e.warn("[SafeSettings] 设置 API 不可用")})}catch(n){_e.error("[SafeSettings] 打开设置失败:",n)}}(this.app,"tuanki"),n.hide()},i.appendChild(a),i.appendChild(r);try{const e=null==(t=n.notice)?void 0:t.noticeEl;e&&(e.empty(),e.appendChild(i))}catch(s){_e.warn("添加按钮到 Notice 失败:",s)}}async checkAndValidateLicense(){try{if(!this.settings.license.isActivated)return!1;if(this.needsLicenseValidation()){const e=await Es.validateCurrentLicense(this.settings.license);if(!e.isValid)return _e.warn("许可证验证失败:",e.error),this.settings.license.isActivated=!1,await this.saveSettings(),this.showLicenseExpiredNotice(e.error||"许可证验证失败"),!1;await this.saveSettings()}return!0}catch(e){return _e.error("许可证验证过程中发生错误:",e),!1}}needsLicenseValidation(){var e;const t=this.settings.license;if(!(null==(e=t.cloudSync)?void 0:e.lastValidatedAt))return!0;const n=new Date(t.cloudSync.lastValidatedAt).getTime();return(Date.now()-n)/864e5>7}isTrialVersion(){return Es.isTrialVersion(this.settings.license)}getLicenseStatus(){if(!this.settings.license.isActivated)return{isValid:!1,isActivated:!1};const e=Es.getLicenseRemainingDays(this.settings.license);return{isValid:e>0,isActivated:!0,remainingDays:e}}async migrateDataIfNeeded(){try{const{DataMigrationService:e}=await Promise.resolve().then(()=>O_e),t=new e(this.app),n=await t.migrate();n.migrated&&(_e.info(`✅ [数据迁移] 成功迁移 ${n.filesCount} 个文件`),await t.promptLegacyDataCleanup())}catch(e){_e.error("❌ [数据迁移] 迁移过程出错:",e),new ge.Notice("Tuanki: 数据迁移遇到问题，但插件将继续运行",5e3)}}async initializeDataFolderHider(){var e,t;try{const{DataFolderHiderService:n}=await Promise.resolve().then(()=>L_e),{TUANKI_DATA:i}=await Promise.resolve().then(()=>ms);this.dataFolderHider=new n;null==(t=null==(e=this.settings.dataFolderVisibility)?void 0:e.hideInFileExplorer)||t?(this.settings.dataFolderVisibility?this.settings.dataFolderVisibility.folderName=i:this.settings.dataFolderVisibility={hideInFileExplorer:!0,folderName:i,userAcknowledgedRisk:!1},await this.saveSettings(),this.dataFolderHider.enable(i),_e.info(`✅ [DataFolderHider] 数据文件夹CSS隐藏已启用: ${i}`)):_e.info("[DataFolderHider] 用户选择不隐藏数据文件夹")}catch(n){_e.error("❌ [DataFolderHider] 初始化失败:",n)}}async initializeDataStorage(){try{_e.info("🚀 [Layout Ready] 文件系统已就绪，开始初始化数据存储..."),await this.migrateDataIfNeeded(),this.dataStorage=new bs(this),await this.dataStorage.initialize(),_e.info("✅ 数据存储初始化完成"),await this.initializeDataFolderHider(),await this.initializeServicesAfterStorage(),_e.info("✅ 所有依赖数据存储的服务初始化完成")}catch(e){throw _e.error("❌ 数据存储初始化失败:",e),new ge.Notice("Tuanki 插件数据初始化失败，请重启 Obsidian",8e3),e}}async initializeServicesAfterStorage(){var e,t,n,i,a,r,s,o,l,c,d,u,h,p,g,v,f,m,y,b,w;this.deckHierarchy=new zp(this.dataStorage),this.mediaManager=new Pp(this,this.dataStorage),await this.mediaManager.initialize(),_e.info("[Services] MediaManagementService 已初始化");try{const{QueueOptimizationFactory:e}=await Promise.resolve().then(()=>q_e);this.queueOptimizationSystem=e.createFromPluginSettings(this.settings),_e.info("[Services] ✅ Queue Optimization System initialized successfully")}catch(I){_e.error("[Services] ❌ Queue Optimization System initialization failed:",I);const{QueueOptimizationFactory:e}=await Promise.resolve().then(()=>q_e);this.queueOptimizationSystem=e.createDefault(),_e.warn("[Services] ⚠️ Using default Queue Optimization System")}try{const{QuestionBankMigration:e}=await Promise.resolve().then(()=>W_e);await e.autoMigrate(this);const{QuestionBankStorage:t,QuestionBankService:n,QuestionBankHierarchyService:i}=await Promise.resolve().then(()=>Mke);this.questionBankStorage=new t(this.app),await this.questionBankStorage.initialize(),this.questionBankService=new n(this.questionBankStorage),await this.questionBankService.initialize(),this.questionBankHierarchy=new i(this.dataStorage,this.questionBankService),this.deckHierarchy.registerSyncHook({onMove:async(e,t)=>{var n;await(null==(n=this.questionBankHierarchy)?void 0:n.syncMove(e,t))},onRename:async(e,t)=>{var n;await(null==(n=this.questionBankHierarchy)?void 0:n.syncRename(e,t))},onDelete:async e=>{var t;await(null==(t=this.questionBankHierarchy)?void 0:t.syncDelete(e))}}),_e.info("[Services] Sync hooks registered"),_e.info("[Services] Question Bank services initialized successfully");try{const e=await this.questionBankService.getAllBanks();if(e.some(e=>"string"==typeof e)){_e.warn("[QuestionBank] 检测到损坏的题库数据，正在清理..."),await this.questionBankStorage.saveBanks([]);const e=await this.questionBankStorage.loadBanks();for(const t of e)await this.questionBankStorage.saveBankQuestions(t.id,[]);await this.questionBankService.initialize(),_e.info("[QuestionBank] 数据已清理")}}catch(D){_e.warn("[QuestionBank] 数据检查失败（非致命错误）:",D)}}catch(I){_e.error("[Services] Question Bank services initialization failed:",I),this.questionBankService=void 0,this.questionBankStorage=void 0,this.questionBankHierarchy=void 0}await this.migrateDeckCategories();const{CardRelationService:k}=await Promise.resolve().then(()=>G_e);this.cardRelationService=new k(this.dataStorage),_e.info("卡片关系服务初始化完成"),this.annotationSystem=zh.getInstance(),await this.annotationSystem.initialize({plugin:this,vault:this.app.vault,workspace:this.app.workspace,metadataCache:this.app.metadataCache,dataStorage:this.dataStorage,deckService:this.dataStorage,fsrs:this.fsrs,cardRelationService:this.cardRelationService,config:{autoDetectionEnabled:null==(n=null==(t=null==(e=this.settings)?void 0:e.annotation)?void 0:t.autoDetectionEnabled)||n,autoCreateDecks:null==(r=null==(a=null==(i=this.settings)?void 0:i.annotation)?void 0:a.autoCreateDecks)||r,defaultDeckId:null!=(l=null==(o=null==(s=this.settings)?void 0:s.annotation)?void 0:o.defaultDeckId)?l:void 0,defaultTemplateId:null!=(u=null==(d=null==(c=this.settings)?void 0:c.annotation)?void 0:d.defaultTemplateId)?u:"official-qa",debounceDelay:null!=(g=null==(p=null==(h=this.settings)?void 0:h.annotation)?void 0:p.debounceDelay)?g:400,maxConcurrentTasks:null!=(m=null==(f=null==(v=this.settings)?void 0:v.annotation)?void 0:f.maxConcurrentTasks)?m:2,debugMode:null!=(w=null==(b=null==(y=this.settings)?void 0:y.annotation)?void 0:b.debugMode)&&w,onlyActiveFileAutoSync:!0}}),_e.info("标注系统已启用"),window.tuankiAnnotationSystem=this.annotationSystem;const{UUIDRegistry:S}=await Promise.resolve().then(()=>T_e),x=S.getInstance();x.injectDataStorage(this.dataStorage),x.injectPlugin(this),_e.info("UUID 注册表已初始化");const _=Date.now();try{await qh.getInstance().preload(this);const e=Date.now()-_;_e.info(`全局数据缓存预加载完成: ${e}ms`)}catch(I){_e.error("全局数据缓存预加载失败（不影响插件启动）:",I)}await this.initBatchParsingWatcher();try{this.blockLinkCleanupService=Yp.getInstance(),this.blockLinkCleanupService.initialize({dataStorage:this.dataStorage,vault:this.app.vault,app:this.app}),_e.info("块链接清理服务已初始化")}catch(I){_e.error("块链接清理系统初始化失败:",I)}const{PATHS:C}=await Promise.resolve().then(()=>ms);_e.debug(`数据路径: ${C.root}`),_e.debug("初始化DirectFileCardReader...");try{this.directFileReader=new eg(this.app.vault,C.root),this.settings.enableDebugMode&&this.directFileReader.enablePerformanceLogging(),_e.info("✅ DirectFileCardReader初始化完成")}catch(I){_e.error("DirectFileCardReader初始化失败:",I)}try{_e.debug("预加载牌组数据缓存..."),this.cachedDecks=await this.dataStorage.getAllDecks(),_e.info(`✅ 牌组数据缓存完成: ${this.cachedDecks.length} 个牌组`)}catch(I){_e.warn("⚠️ 牌组数据预加载失败（不影响功能）:",I),this.cachedDecks=[]}_e.debug("初始化CardIndexService...");try{this.cardIndexService=new tg(this.app.vault,C.root),this.cardIndexService.initialize().catch(e=>{_e.error("CardIndexService索引构建失败:",e)}),_e.info("✅ CardIndexService初始化完成")}catch(I){_e.error("CardIndexService初始化失败:",I)}try{await this.initializeAutoBackup(),_e.debug("✅ 自动备份调度器初始化完成")}catch(I){_e.error("自动备份调度器初始化失败:",I)}if(this.settings.enableDebugMode)try{const{registerProgressiveCleanupTool:e}=await Promise.resolve().then(()=>K_e);e(this),_e.debug("✅ V1.5清理开发工具已注册");const{registerProgressiveDebugTool:t}=await Promise.resolve().then(()=>Z_e);t(this),_e.debug("✅ 渐进式挖空调试工具已注册")}catch(I){_e.error("开发工具注册失败:",I)}_e.debug("✅ 所有依赖数据存储的服务初始化完成")}async initializeAnkiConnect(){var e,t;try{if(null==(e=this.settings.ankiConnect)?void 0:e.enabled){const{AnkiConnectService:e}=await Promise.resolve().then(()=>dpe);this.ankiConnectService=new e(this,this.app,this.settings.ankiConnect),this.ankiConnectService.startConnectionMonitoring(),_e.debug("AnkiConnect监控已启动"),(null==(t=this.settings.ankiConnect.autoSync)?void 0:t.enabled)&&(this.ankiConnectService.startAutoSync(),_e.debug("AnkiConnect自动同步已启动"))}}catch(n){_e.error("❌ AnkiConnect 服务初始化失败:",n)}}cleanupAnkiConnect(){if(this.ankiConnectService){try{this.ankiConnectService.stopConnectionMonitoring(),this.ankiConnectService.stopAutoSync(),_e.debug("AnkiConnect服务已停止")}catch(e){_e.error("❌ 停止 AnkiConnect 服务失败:",e)}this.ankiConnectService=null}}async initializeAutoBackup(){try{await this.migrateBackupConfig();const{AutoBackupScheduler:e}=await Promise.resolve().then(()=>Y_e);this.autoBackupScheduler=new e(this,()=>this.settings.autoBackupConfig,async e=>{this.settings.autoBackupConfig={...this.settings.autoBackupConfig,...e},await this.saveSettings()}),this.autoBackupScheduler.start(),_e.debug("自动备份调度器已启动"),await this.autoBackupScheduler.checkAndCreateStartupBackup()}catch(e){_e.error("❌ 自动备份调度器初始化失败:",e)}}cleanupAutoBackup(){if(this.autoBackupScheduler){try{this.autoBackupScheduler.stop(),_e.debug("自动备份调度器已停止")}catch(e){_e.error("❌ 停止自动备份调度器失败:",e)}this.autoBackupScheduler=null}}async migrateBackupConfig(){if(this.settings.autoBackupConfig)return;const e=this.settings.dataBackupIntervalHours||24,t=!1!==this.settings.autoBackup;this.settings.autoBackupConfig={enabled:t,intervalHours:e,triggers:{onStartup:!0,onCardThreshold:!0,cardThresholdCount:100},notifications:{onSuccess:!0,onFailure:!0},autoBackupCount:0},await this.saveSettings(),_e.debug("备份配置已迁移")}async updateAnkiConnectEndpoint(e){this.ankiConnectService?(this.cleanupAnkiConnect(),this.settings.ankiConnect.endpoint=e,await this.saveSettings(),await this.initializeAnkiConnect(),_e.debug("AnkiConnect端点已更新")):await this.initializeAnkiConnect()}async toggleAnkiConnect(e){this.settings.ankiConnect.enabled=e,await this.saveSettings(),e?await this.initializeAnkiConnect():this.cleanupAnkiConnect(),_e.debug("AnkiConnect "+(e?"已启用":"已禁用"))}async initBatchParsingWatcher(){var e,t;if(!this.settings.simplifiedParsing)return void _e.warn("[Plugin] simplifiedParsing 配置未初始化");const n=this.settings.simplifiedParsing.batchParsing;try{this.cardConverter||(this.cardConverter=new sp(this.app,this.fsrs)),this.batchCardSaver||(this.batchCardSaver=new op(this.dataStorage,qh.getInstance()));const t=new rp(this.settings.simplifiedParsing,this.app);this.simplifiedCardParser=t;try{const e=new Ap,n=new Ep(this);this.batchParsingManager=new Dp(this.app,this.settings.simplifiedParsing,t,n,e,this),this.batchParsingManager.registerCommands(this),_e.debug("批量解析系统已初始化")}catch(i){_e.error("[Plugin] ❌ 批量解析手动触发系统初始化失败 - 详细信息:"),_e.error("[Plugin] 错误类型:",null==(e=null==i?void 0:i.constructor)?void 0:e.name),_e.error("[Plugin] 错误消息:",i instanceof Error?i.message:String(i)),_e.error("[Plugin] 错误堆栈:",i instanceof Error?i.stack:"无堆栈信息"),_e.error("[Plugin] 完整错误对象:",i),this.batchParsingManager=void 0}n.autoTrigger?(_e.debug("[Plugin] 🔍 [步骤3] autoTrigger 已启用，初始化自动触发监听器..."),this.batchParsingWatcher=new Kh(this,t,{debounceDelay:n.triggerDebounce,onlyActiveFile:n.onlyActiveFile,autoTrigger:n.autoTrigger,includeFolders:n.includeFolders,excludeFolders:n.excludeFolders}),await this.batchParsingWatcher.initialize(),_e.info("[Plugin] ✅ 批量解析监听器已初始化")):_e.debug("[Plugin] ℹ️ autoTrigger 已禁用，跳过批量解析监听器初始化"),_e.info("[Plugin] ✅ 批量解析服务初始化完成")}catch(i){_e.error("[Plugin] ❌ 解析服务初始化失败 - 详细信息:"),_e.error("[Plugin] 错误类型:",null==(t=null==i?void 0:i.constructor)?void 0:t.name),_e.error("[Plugin] 错误消息:",i instanceof Error?i.message:String(i)),_e.error("[Plugin] 错误堆栈:",i instanceof Error?i.stack:"无堆栈信息"),_e.error("[Plugin] 完整错误对象:",i)}}async getDefaultDeckId(){var e,t;try{if(null==(t=null==(e=this.settings.simplifiedParsing)?void 0:e.batchParsing)?void 0:t.defaultDeckId){const e=this.settings.simplifiedParsing.batchParsing.defaultDeckId,t=await this.dataStorage.getDeck(e);if(t)return _e.debug("[Plugin] ✅ 使用配置的默认牌组:",t.name),e}const n=await this.dataStorage.getDecks();if(n&&n.length>0)return _e.debug("[Plugin] ✅ 使用第一个牌组:",n[0].name),n[0].id;_e.info("[Plugin] 🔄 创建新的默认牌组...");const i=(await this.dataStorage.getUserProfile()).globalSettings.defaultDeckSettings,a={id:`deck_${Date.now().toString(36)}`,name:"批量解析",description:"通过批量解析功能创建的卡片",category:"默认",path:"批量解析",level:0,order:0,inheritSettings:!1,created:(new Date).toISOString(),modified:(new Date).toISOString(),settings:i,includeSubdecks:!1,stats:{totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:0,forecastDays:{}},tags:[],metadata:{autoCreated:!0}},r=await this.dataStorage.saveDeck(a);return r.success&&r.data?(_e.info("[Plugin] ✅ 已创建默认牌组:",r.data.name),r.data.id):(_e.error("[Plugin] ❌ 创建默认牌组失败"),null)}catch(n){return _e.error("[Plugin] 获取默认牌组失败:",n),null}}async addCardsToDB(e){var t,n,i,a,r,s;this.cardConverter&&this.batchCardSaver||(this.cardConverter=new sp(this.app,this.fsrs),this.batchCardSaver=new op(this.dataStorage,qh.getInstance()),_e.debug("[Plugin] ✅ 动态初始化卡片转换器和保存器"));try{if(!(await this.getDefaultDeckId()))return void new ge.Notice("❌ 无法获取或创建默认牌组");const o=[];for(const c of e){if(!(null==(t=c.metadata)?void 0:t.targetDeckId)){_e.error("[Plugin] ❌ 卡片缺少 targetDeckId，拒绝保存:",{front:(c.front||c.content||"").substring(0,50),source:(null==(n=c.metadata)?void 0:n.sourceFile)||"未知"});continue}const e=c.metadata.targetDeckId;if(!(await this.dataStorage.getDeck(e))){_e.error("[Plugin] ❌ 目标牌组不存在，拒绝保存:",{deckId:e,deckName:(null==(i=c.metadata)?void 0:i.targetDeckName)||"未知",cardFront:(c.front||c.content||"").substring(0,50)});continue}const l={deckId:e,preserveSourceInfo:!0,priority:null!=(s=null==(r=null==(a=this.settings.simplifiedParsing)?void 0:a.batchParsing)?void 0:r.defaultPriority)?s:0,suspended:!1},d=this.cardConverter.convertToCard(c,l);d.success&&d.card?o.push(d.card):_e.error("[Plugin] 卡片转换失败:",d.errors||[d.error].filter(Boolean))}if(0===o.length)return void new ge.Notice("❌ 没有可保存的卡片");_e.info(`[Plugin] ✅ 成功转换 ${o.length} 张卡片`);const l=await this.batchCardSaver.saveBatchWithNotice(o,{continueOnError:!0});_e.info("[Plugin] 批量保存完成:",{"成功":l.successCount,"失败":l.failureCount,"总计":e.length,"耗时":l.duration?`${l.duration}ms`:"未知"}),l.failureCount>0&&_e.error("[Plugin] 保存失败的卡片:",l.errors)}catch(o){_e.error("[Plugin] 添加卡片到数据库失败:",o),new ge.Notice(`❌ 保存卡片失败: ${o instanceof Error?o.message:"未知错误"}`)}}registerBatchParsingCommands(){this.addCommand({id:"scan-active-file-annotations",name:"扫描当前文件标注",callback:async()=>{try{const e=window.tuankiAnnotationSystem;if(!e)return void new ge.Notice("❌ 标注系统未初始化");await e.triggerScan("active-only"),new ge.Notice("✅ 已扫描当前文件")}catch(e){new ge.Notice("❌ 扫描失败: "+(e instanceof Error?e.message:String(e))),_e.error("[标注扫描] 扫描活动文件失败:",e)}}}),this.addCommand({id:"scan-recent-annotations",name:"扫描最近修改文件的标注",callback:async()=>{try{const e=window.tuankiAnnotationSystem;if(!e)return void new ge.Notice("❌ 标注系统未初始化");await e.triggerScan("incremental"),new ge.Notice("✅ 增量扫描完成")}catch(e){new ge.Notice("❌ 扫描失败: "+(e instanceof Error?e.message:String(e))),_e.error("[标注扫描] 增量扫描失败:",e)}}}),this.addCommand({id:"scan-all-annotations",name:"全库扫描标注",callback:async()=>{try{const e=window.tuankiAnnotationSystem;if(!e)return void new ge.Notice("❌ 标注系统未初始化");new ge.Notice("🔍 开始全库扫描..."),await e.triggerScan("full"),new ge.Notice("✅ 全库扫描完成")}catch(e){new ge.Notice("❌ 扫描失败: "+(e instanceof Error?e.message:String(e))),_e.error("[标注扫描] 全库扫描失败:",e)}}}),this.addCommand({id:"batch-parse-current-file",name:"批量解析当前文件",checkCallback:e=>{var t;const n=this.app.workspace.getActiveFile();if(!n||"md"!==n.extension)return!1;if(!e){if(!Qh.getInstance().canUseFeature(Hh.BATCH_PARSING))return void new ge.Notice("🔒 批量解析系统需要激活许可证才能使用");null==(t=this.batchParsingManager)||t.parseSingleFile(n)}return!0}}),this.addCommand({id:"batch-parse-all-mappings",name:"批量解析所有映射文件",callback:async()=>{var e;Qh.getInstance().canUseFeature(Hh.BATCH_PARSING)?await(null==(e=this.batchParsingManager)?void 0:e.executeBatchParsing()):new ge.Notice("🔒 批量解析系统需要激活许可证才能使用")}}),_e.info("[Plugin] 批量解析命令已注册")}async onload(){try{_e.info("🚀 Tuanki plugin loading with Hot Reload"),await this.loadSettings(),_e.setDebugMode(this.settings.enableDebugMode||!1),_e.debug("初始化AI配置Store..."),up.initialize(this),_e.info("✅ AI配置Store已初始化"),_e.debug("初始化架构系统..."),e=this,window.tuankiPlugin=e,_e.debug("🔗 插件引用已设置"),function(){try{Wo(),_e.debug("🎯 服务注册表初始化完成")}catch(e){throw _e.error("❌ 服务注册表初始化失败:",e),e}}(),Fo.startMonitoring(),_e.debug("初始化平板端适配..."),this.initializeTabletSupport(),_e.debug("注册视图..."),this.registerView(De,e=>new Te(e,this)),this.registerView(ts,e=>new ns(e,this)),this.registerView(is,e=>new as(e,this)),this.registerView(rs,e=>new ss(e,this)),_e.info("✅ 视图已注册（在 workspace 恢复前）"),_e.debug("⏳ 等待 workspace layout-ready 事件..."),this.app.workspace.onLayoutReady(async()=>{await this.initializeDataStorage()}),ro("SET_ONLINE_STATUS",navigator.onLine),ao("SET_CURRENT_PAGE","loading"),_e.info("架构系统初始化完成"),_e.debug("Tuanki 插件启动完成"),await this.validateLicense(),_e.debug("初始化高级功能守卫...");const i=Qh.getInstance();await i.initialize(this.settings.license),_e.info("高级功能守卫初始化完成"),window.addEventListener("tuanki:open-activation",()=>{this.activateView(De),setTimeout(()=>{window.dispatchEvent(new CustomEvent("tuanki:navigate",{detail:{page:"settings",tab:"about"}}))},100)}),_e.info("初始化基础服务（不依赖数据存储）..."),this.filterStateService=new $p(this),this.dataSyncService=new Op,this.indexManager=new Rp(this);try{await this.indexManager.initialize(),_e.info("IndexManagerService 已初始化")}catch(t){_e.error("IndexManagerService 初始化失败:",t)}_e.info("基础服务初始化完成"),this.fsrs=new Is({requestRetention:this.settings.fsrsParams.requestRetention,maximumInterval:this.settings.fsrsParams.maximumInterval,enableFuzz:this.settings.fsrsParams.enableFuzz,w:this.settings.fsrsParams.w}),_e.info("FSRS算法已初始化");const{EmbeddableEditorManager:a}=await Promise.resolve().then(()=>Xk);this.editorPoolManager=new a(this.app),_e.info("嵌入式编辑器管理器已初始化（v3）");try{window.addEventListener("error",e=>{var t;if(e.message&&e.message.includes("ResizeObserver loop"))return;const n=(null==(t=e.error)?void 0:t.stack)||"";_e.error("[GLOBAL_ERROR]",e.message,n||e)}),window.addEventListener("unhandledrejection",e=>{const t=e.reason,n=(null==t?void 0:t.message)||t,i=(null==t?void 0:t.stack)||"";_e.error("[UNHANDLED_REJECTION]",n,i||e)})}catch(n){}try{const e=new Ys,t=await e.performHealthCheck();_e.debug("架构健康检查:",t),"critical"===t.status?_e.error("架构存在严重问题:",t.issues):"warning"===t.status?_e.warn("架构存在警告:",t.issues):_e.info("架构健康状态良好")}catch(t){_e.error("架构健康检查失败:",t)}this.wasmUrl=this.app.vault.adapter.getResourcePath(`${this.manifest.dir}/sql-wasm.wasm`),this.addRibbonIcon("brain","Open Weave",()=>{this.activateView(De)}),this.addRibbonIcon("filter","打开Tuanki筛选器",()=>{this.activateFilterView()}),this.addCommand({id:"open-weave-view",name:"Open Weave",callback:()=>{this.activateView(De)}}),this.addCommand({id:"quick-add-card",name:"Quick Add Card",callback:async()=>{await this.openCreateCardModal()}}),this.addCommand({id:"create-card-from-selection",name:"Create Card from Selection",callback:async()=>{try{_e.debug("📝 [快捷键创建卡片] 命令触发");let e="",n=null,i=null;const a=this.app.workspace.getActiveViewOfType(ge.MarkdownView);if((null==a?void 0:a.editor)&&(n=a.editor,i=a,e=n.getSelection()),!e||""===e.trim()){const t=window.getSelection();t&&t.toString().trim()&&(e=t.toString().trim())}if(!e||""===e.trim()){if(_e.debug("⚠️ [快捷键创建卡片] 未选中文本"),!n)return void new ge.Notice("📖 请在阅读视图中选中文本后再使用快捷键",3e3);{_e.debug("⚠️ [快捷键创建卡片] 尝试获取当前行");const t=n.getCursor(),i=n.getLine(t.line);if(!(null==i?void 0:i.trim()))return void new ge.Notice("ℹ️ 请先选中要创建卡片的文本内容",3e3);e=i.trim(),n.setSelection({line:t.line,ch:0},{line:t.line,ch:i.length}),new ge.Notice("ℹ️ 使用当前行内容创建卡片",2e3)}}const r=(null==a?void 0:a.file)||(null==i?void 0:i.file);let s,o,l;if(r?(s=r.path,o=r.basename,_e.debug("✅ [快捷键创建卡片] 源文件:",s)):(_e.warn("⚠️ [快捷键创建卡片] 无文件信息，创建无溯源卡片"),new ge.Notice("ℹ️ 创建卡片（无源文档信息）",2e3)),s)try{const{BlockLinkManager:t}=await Promise.resolve().then(()=>X_e),n=new t(this.app),i=await n.createBlockLinkForSelection(e,s);i.success&&i.blockLinkInfo?(l=i.blockLinkInfo,_e.debug("✅ [快捷键创建卡片] 块链接创建成功:",l.blockLink),this.blockLinkCleanupService&&(this.blockLinkCleanupService.markRecentlyCreated(l.blockId),_e.debug("🛡️ [快捷键创建卡片] 块链接已保护（60秒）"))):(_e.warn("⚠️ [快捷键创建卡片] 块链接创建失败，使用文档级溯源"),new ge.Notice("⚠️ 无法创建精确块链接，已保存文档级来源",2e3))}catch(t){_e.error("❌ [快捷键创建卡片] 块链接创建异常:",t)}const c=`${e}\n\n---div---\n\n`,d={};l?(d.sourceFile=s,d.sourceBlock=`^${l.blockId}`):s&&(d.sourceFile=s),_e.debug("📝 [快捷键创建卡片] 打开创建卡片模态窗"),await this.openCreateCardModal({initialContent:c,cardMetadata:d,onSuccess:e=>{_e.debug("✅ [快捷键创建卡片] 卡片创建成功:",e.id),new ge.Notice("✅ 卡片创建成功",2e3)},onCancel:()=>{_e.debug("ℹ️ [快捷键创建卡片] 用户取消创建")}})}catch(t){_e.error("❌ [快捷键创建卡片] 执行失败:",t),new ge.Notice("❌ 创建卡片失败，请重试",3e3)}}}),this.addCommand({id:"format-selection-as-cloze",name:Up.t("commands.formatAsCloze.name"),callback:async()=>{try{_e.debug("📝 [格式化挖空] 命令触发");let e="",t=null;const n=$s.getInstance();if(n.hasActivePluginEditor()&&(t=n.getCompatibleEditor(),t&&(e=t.getSelection(),_e.debug("📝 [格式化挖空] 使用插件编辑器:",e?"成功":"失败"))),!t){const n=this.app.workspace.getActiveViewOfType(ge.MarkdownView);(null==n?void 0:n.editor)&&(t=n.editor,e=t.getSelection(),_e.debug("📝 [格式化挖空] 使用原生编辑器:",e?"成功":"失败"))}if(!e||""===e.trim()){const t=window.getSelection();t&&t.toString().trim()&&(e=t.toString().trim(),_e.debug("📝 [格式化挖空] Window Selection API 获取: 成功"))}if(!e||""===e.trim())return _e.debug("⚠️ [格式化挖空] 未选中文本"),void new ge.Notice(Up.t("commands.formatAsCloze.noSelection"),3e3);if(!t)return _e.warn("⚠️ [格式化挖空] 无法找到编辑器实例"),void new ge.Notice("📝 请确保编辑器已获得焦点",3e3);const i=t.getValue().matchAll(/\{\{c(\d+)::/g),a=Array.from(i).map(e=>parseInt(e[1])),r=a.length>0?Math.max(...a):0,s=r+1;_e.debug(`📝 [格式化挖空] 当前最大序号: c${r}, 下一个: c${s}`);const o=`{{c${s}::${e}}}`;t.replaceSelection(o),_e.debug("✅ [格式化挖空] 格式化成功"),new ge.Notice(Up.t("commands.formatAsCloze.success")+` (c${s})`,2500)}catch(t){_e.error("❌ [格式化挖空] 执行失败:",t),new ge.Notice(Up.t("commands.formatAsCloze.error"),3e3)}}}),this.registerBatchParsingCommands(),this.registerCleanupCommands(),this.registerImageMaskFeatures(),this.addSettingTab(new Ds(this.app,this)),_e.debug("🎨 Initializing UI Manager...");const{UIManager:r}=await Promise.resolve().then(()=>tCe);this.uiManager=r.getInstance(this,{debug:this.settings.enableDebugMode||!1}),_e.debug("✅ UI Manager initialized"),this.settings.showFloatingCreateButton&&this.createGlobalFloatingButton(),ao("SET_CURRENT_PAGE","deck-study"),ao("SET_LOADING",!1),_e.debug("🎉 Tuanki 插件完全初始化完成 - 新架构已启用"),await this.initializeAnkiConnect()}catch(t){_e.error("❌ 插件初始化失败:",t),await $o(t instanceof Error?t:new Error(String(t)),Oo("AnkiPlugin","onload")),new ge.Notice("Tuanki 插件初始化失败，请查看控制台了解详情",5e3)}var e}onunload(){_e.debug("[Tuanki] 保存并清理AI配置Store..."),up.forceSave().then(()=>{up.destroy(),_e.info("✅ AI配置Store已清理")}).catch(e=>{_e.error("AI配置Store清理失败:",e)}),_e.debug("[Tuanki] 清理 UI 组件..."),this.uiManager&&(this.uiManager.destroyAll(),_e.debug("[TuankiPlugin] ✅ UI Manager 已清理")),this.dataFolderHider&&(this.dataFolderHider.destroy(),_e.debug("[TuankiPlugin] ✅ DataFolderHider 已清理")),this.dataSyncService&&(this.dataSyncService.destroy(),_e.debug("[Tuanki] DataSyncService destroyed")),this.cleanupAnkiConnect(),this.cleanupAutoBackup(),this.annotationSystem&&this.annotationSystem.destroy(),delete window.tuankiAnnotationSystem,this.batchParsingWatcher&&(this.batchParsingWatcher.destroy(),this.batchParsingWatcher=void 0),this.batchParsingManager&&(this.batchParsingManager.destroy(),this.batchParsingManager=void 0,_e.debug("[Plugin] ✅ 新批量解析系统已清理")),this.directFileReader&&(this.directFileReader.dispose(),_e.debug("[Plugin] ✅ DirectFileCardReader已清理")),this.cardIndexService&&(this.cardIndexService.dispose(),_e.debug("[Plugin] ✅ CardIndexService已清理")),this.editorPoolManager&&this.editorPoolManager.cleanup(),_e.debug("[Tuanki] ✅ 插件卸载完成")}async openCreateCardModal(e){var t,n,i,a,r;try{if(this.currentCreateCardModal){_e.debug("🎯 [openCreateCardModal] 已存在打开的模态窗，填充内容到现有窗口");const t="string"==typeof e?{initialContent:e}:e||{},{initialContent:n="",sourceInfo:i}=t;if(n&&this.currentCreateCardModal.updateContent&&(await this.currentCreateCardModal.updateContent(n,i),_e.debug("🎯 [openCreateCardModal] ✅ 内容已填充到现有模态窗"),new ge.Notice("✨ 内容已填充到编辑器")),n){this.currentCreateCardModal.container.scrollIntoView({behavior:"smooth",block:"center"});const e=this.currentCreateCardModal.container;e.style.boxShadow="0 0 20px rgba(88, 166, 255, 0.5)",setTimeout(()=>{e.style.boxShadow=""},300)}return}const s="string"==typeof e?{initialContent:e}:e||{},{initialContent:o="",parsedCard:l,sourceInfo:c,selectedTemplate:d,contentMapping:u,onSuccess:h,onCancel:p}=s;if(_e.debug("🎯 [openCreateCardModal] 被调用（直接挂载模式）"),!this.dataStorage)return _e.error("❌ [openCreateCardModal] dataStorage未初始化"),void new ge.Notice("插件正在初始化，请稍候再试");_e.debug("🎯 [openCreateCardModal] 预加载数据...");const g=await this.dataStorage.getAllDecks();let v=[];_e.debug("🎯 [openCreateCardModal] 数据预加载完成");const{CardType:f}=await Promise.resolve().then(()=>Yr),m=o||(null==(t=s.cardMetadata)?void 0:t.content)||"";_e.debug("🎯 [openCreateCardModal] Content-Only 架构：只使用 content");const y={uuid:Vu(),deckId:(null==(n=s.cardMetadata)?void 0:n.deckId)||(null==(i=g[0])?void 0:i.id)||"default",type:f.Basic,content:m,sourceFile:null==(a=s.cardMetadata)?void 0:a.sourceFile,sourceBlock:null==(r=s.cardMetadata)?void 0:r.sourceBlock,fsrs:{due:(new Date).toISOString(),stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:0,lastReview:void 0,retrievability:1},reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},created:(new Date).toISOString(),modified:(new Date).toISOString(),tags:(null==l?void 0:l.tags)||[]},{EmbeddableEditorManager:b}=await Promise.resolve().then(()=>Xk),w=new b(this.app);_e.debug("🎯 [openCreateCardModal] 动态导入CreateCardModal组件...");const{mount:k,unmount:S}=await Promise.resolve().then(()=>Or),{default:x}=await Promise.resolve().then(()=>DCe),_=document.createElement("div");_.className="tuanki-create-card-modal-container",document.body.appendChild(_),_e.debug("🎯 [openCreateCardModal] 挂载CreateCardModal组件到document.body...");const C=k(x,{target:_,props:{open:!0,card:y,plugin:this,editorPoolManager:w,decks:g,templates:v,onModalClose:()=>{_e.debug("🎯 [openCreateCardModal] 模态窗关闭，清理DOM"),S(C),_.remove(),this.currentCreateCardModal=null},onSave:e=>{_e.debug("🎯 [openCreateCardModal] 卡片保存成功，通知外部"),null==h||h(e)},onCancel:()=>{_e.debug("🎯 [openCreateCardModal] 用户取消"),null==p||p(),S(C),_.remove(),this.currentCreateCardModal=null}}}),I=async(e,t)=>{(null==C?void 0:C.updateContent)&&await C.updateContent(e,t)};this.currentCreateCardModal={instance:C,container:_,updateContent:I},_e.debug("🎯 [openCreateCardModal] ✅ 新建卡片模态窗已成功挂载（全局显示，支持外部操作）")}catch(s){_e.error("🎯 [openCreateCardModal] 执行失败:",s),new ge.Notice("打开新建卡片模态框时发生错误")}}async openEditCardModal(e,t){try{const{onSave:i,onCancel:a}=t||{};if(this.currentEditCardModal){_e.debug("🎯 [openEditCardModal] 强制清理旧模态窗");const{unmount:e}=await Promise.resolve().then(()=>Or);try{e(this.currentEditCardModal.instance)}catch(n){_e.warn("[openEditCardModal] unmount失败:",n)}this.currentEditCardModal.container.remove(),this.currentEditCardModal=null}const r=document.querySelectorAll(".tuanki-edit-card-modal-container");if(r.length>0&&(_e.warn(`🎯 [openEditCardModal] 发现${r.length}个残留容器，强制清理`),r.forEach(e=>e.remove())),!this.dataStorage||!this.editorPoolManager)return _e.error("❌ [openEditCardModal] 服务未初始化"),void new ge.Notice("插件正在初始化，请稍候再试");const s=this.cachedDecks.length>0?this.cachedDecks:await this.dataStorage.getAllDecks(),o=this.editorPoolManager,{mount:l,unmount:c}=await Promise.resolve().then(()=>Or),{default:d}=await Promise.resolve().then(()=>TCe),u=document.createElement("div");u.className="tuanki-edit-card-modal-container",document.body.appendChild(u);const h=l(d,{target:u,props:{open:!0,card:e,plugin:this,editorPoolManager:o,decks:s,onModalClose:()=>{_e.debug("🎯 [openEditCardModal] 关闭并清理"),c(h),u.remove(),this.currentEditCardModal=null},onSave:e=>{_e.debug("🎯 [openEditCardModal] 保存成功，立即关闭"),c(h),u.remove(),this.currentEditCardModal=null,i&&Promise.resolve(i(e)).catch(e=>{_e.error("[openEditCardModal] onSave失败:",e)})},onCancel:()=>{_e.debug("🎯 [openEditCardModal] 取消"),null==a||a(),c(h),u.remove(),this.currentEditCardModal=null}}});this.currentEditCardModal={instance:h,container:u},_e.debug("🎯 [openEditCardModal] ✅ 挂载成功")}catch(i){_e.error("🎯 [openEditCardModal] 失败:",i),new ge.Notice("打开编辑卡片模态框时发生错误")}}createGlobalFloatingButton(){Promise.resolve().then(()=>zCe).then(async({default:e})=>{const{mount:t}=await Promise.resolve().then(()=>Or),n=document.createElement("div");n.className="tuanki-floating-button-container",document.body.appendChild(n);const i=t(e,{target:n,props:{plugin:this,onCreateCard:()=>{this.openCreateCardModal({initialContent:"\n\n---div---\n\n"})}}});this.uiManager.register("floating-button","floating-button",i,n,{createdBy:"createGlobalFloatingButton"}),_e.debug("[Plugin] ✅ 全局悬浮按钮已创建并注册到 UIManager（使用专用容器）")}).catch(e=>{_e.error("[Plugin] ❌ 加载全局悬浮按钮失败:",e)})}toggleFloatingButton(e){e&&!this.uiManager.has("floating-button")?this.createGlobalFloatingButton():!e&&this.uiManager.has("floating-button")&&this.uiManager.destroy("floating-button")}async activateView(e){var t;try{if(!e)return void _e.error("[TuankiPlugin] activateView: viewType不能为空");if(!(null==(t=this.app)?void 0:t.workspace))return void _e.error("[TuankiPlugin] activateView: workspace不可用");_e.debug(`[TuankiPlugin] 正在激活视图: ${e}`),this.app.workspace.detachLeavesOfType(e),e===De&&this.app.workspace.detachLeavesOfType("anki-view");const n=this.app.workspace.getLeaf(!1);if(!n)return void _e.error("[TuankiPlugin] activateView: 无法创建leaf");await n.setViewState({type:e,active:!0});const i=this.app.workspace.getLeavesOfType(e);i.length>0&&i[0]?(this.app.workspace.revealLeaf(i[0]),_e.debug(`[TuankiPlugin] 成功激活视图: ${e}`)):_e.error(`[TuankiPlugin] activateView: 找不到指定类型的视图leaf: ${e}`)}catch(n){_e.error("[TuankiPlugin] activateView失败:",n),new ge.Notice(`无法打开视图: ${n instanceof Error?n.message:"未知错误"}`)}}async activateFilterView(){const{workspace:e}=this.app;let t=e.getLeavesOfType(is)[0];if(!t){const n=e.getLeftLeaf(!1);n&&(await n.setViewState({type:is,active:!0}),t=n)}t&&e.revealLeaf(t)}async openStudySession(e){const t="string"==typeof e?e:null==e?void 0:e.deckId,n="object"==typeof e?null==e?void 0:e.mode:void 0,i="object"==typeof e?null==e?void 0:e.cardIds:void 0;_e.debug("[Plugin] 打开学习会话");try{const e=this.app.workspace,a=e.getLeavesOfType(ts);if(a.length>0){const r=a[0];return e.revealLeaf(r),await r.setViewState({type:ts,state:{deckId:t,mode:n,cardIds:i}}),void _e.debug("[Plugin] ✅ 激活已存在的学习会话")}const r=e.getLeaf("tab");await r.setViewState({type:ts,state:{deckId:t,mode:n,cardIds:i}}),e.revealLeaf(r),_e.debug("[Plugin] ✅ 学习会话已打开")}catch(a){_e.error("[Plugin] ❌ 打开学习会话失败:",a),new ge.Notice("打开学习会话失败")}}async openQuestionBankSession(e){const{bankId:t,bankName:n,mode:i,config:a}=e;_e.debug("[Plugin] 打开刷题学习会话:",{bankId:t,bankName:n,mode:i});try{const e=this.app.workspace,r=e.getLeavesOfType(rs).find(e=>{var n;return(null==(n=e.view.getState())?void 0:n.bankId)===t});if(r)return e.revealLeaf(r),void _e.debug("[Plugin] ✅ 激活已存在的刷题会话");const s=e.getLeaf("tab");await s.setViewState({type:rs,state:{bankId:t,bankName:n,mode:i,config:a}}),e.revealLeaf(s),_e.debug("[Plugin] ✅ 刷题会话已打开（标签页模式）")}catch(r){_e.error("[Plugin] ❌ 打开刷题会话失败:",r),new ge.Notice("打开刷题界面失败")}}async loadStudyCards(e){try{const t=await this.dataStorage.getAllCards(),n=Date.now();let i=t.filter(e=>e.fsrs&&e.fsrs.due&&new Date(e.fsrs.due).getTime()<=n);e&&(i=i.filter(t=>t.deckId===e));const a=this.settings.reviewsPerDay||20;return i.slice(0,a)}catch(t){return _e.error("[Plugin] 加载学习卡片失败:",t),[]}}async loadPersistedStudySession(){try{const e=await this.loadData();if(null==e?void 0:e.persistedStudySession){es.getInstance().setPersistedSession(e.persistedStudySession),_e.debug("[Plugin] 已加载持久化的学习会话")}}catch(e){_e.error("[Plugin] 加载持久化学习会话失败:",e)}}async savePersistedStudySession(){try{const e=es.getInstance().getPersistedSession();if(e){const t=await this.loadData()||{};t.persistedStudySession=e,await this.saveData(t),_e.debug("[Plugin] 学习会话已持久化到磁盘")}}catch(e){_e.error("[Plugin] 保存学习会话失败:",e)}}async clearPersistedStudySession(){try{const e=await this.loadData()||{};e.persistedStudySession=void 0,await this.saveData(e);es.getInstance().clearPersistedSession(),_e.debug("[Plugin] 已清除持久化的学习会话")}catch(e){_e.error("[Plugin] 清除学习会话失败:",e)}}registerCleanupCommands(){_e.debug("[Plugin] 注册块链接清理命令..."),this.addCommand({id:"cleanup-current-file",name:"🧹 清理当前文档的孤立块链接",callback:async()=>{try{const e=this.app.workspace.getActiveFile();if(!e)return void new ge.Notice("❌ 没有打开的文档",3e3);const t=this.blockLinkCleanupService.getDetector();if(!t)return void new ge.Notice("❌ 清理服务未初始化",3e3);const n=new ge.Notice("🔍 正在检测孤立引用...",0),i=await t.detectInFile(e);if(0===i.length)return n.hide(),void new ge.Notice("当前文档没有孤立引用",3e3);let a=0;for(const r of i){const t=await this.blockLinkCleanupService.cleanupFile(e);t.success&&(a+=t.cleanedItems.length)}n.hide(),a>0?new ge.Notice(`清理完成：已清理 ${a} 个孤立引用`,5e3):new ge.Notice("✅ 清理完成：没有需要清理的内容",3e3)}catch(e){_e.error("[Plugin] 清理当前文档失败:",e),new ge.Notice("❌ 清理当前文档失败，请查看控制台",3e3)}}}),this.addCommand({id:"cleanup-orphaned-block-links",name:"🧹 全局清理孤立块链接（扫描所有文档）",callback:async()=>{try{const e=this.blockLinkCleanupService.getDetector();if(!e)return void new ge.Notice("❌ 清理服务未初始化",3e3);const t=new Xp(this.blockLinkCleanupService,e,this.app.vault,this.app),n=new Jp(this.app,t);n.open();const i=await t.scanAndCleanup(e=>{n.updateProgress(e)});n.showResult(i),i.cleanedOrphans>0?new ge.Notice(`✅ 清理完成：已清理 ${i.cleanedOrphans} 个孤立引用`,5e3):new ge.Notice("✅ 扫描完成：未发现孤立引用",3e3)}catch(e){_e.error("[Plugin] 全局清理失败:",e),new ge.Notice("❌ 全局清理失败，请查看控制台",3e3)}}}),_e.debug("[Plugin] ✅ 块链接清理命令已注册")}registerImageMaskFeatures(){_e.debug("[Plugin] 注册图片遮罩功能..."),this.registerEvent(this.app.workspace.on("editor-menu",(e,t,n)=>{const i=t.getCursor(),a=t.getLine(i.line);this.hasImageLink(a)&&e.addItem(e=>{e.setTitle("Tuanki 图片遮罩").setIcon("image").onClick(async()=>{var e;await this.openImageMaskModalFromEditor(t,i.line,(null==(e=n.file)?void 0:e.path)||"")})})})),this.addCommand({id:"edit-image-mask",name:"编辑图片遮罩",editorCallback:async(e,t)=>{var n;const i=e.getCursor(),a=e.getLine(i.line);this.hasImageLink(a)?await this.openImageMaskModalFromEditor(e,i.line,(null==(n=t.file)?void 0:n.path)||""):new ge.Notice("⚠️ 请将光标移动到图片行")}}),_e.debug("[Plugin] ✅ 图片遮罩功能已注册")}async openImageMaskModalFromEditor(e,t,n){try{const{MaskDataParser:i}=await Promise.resolve().then(()=>Z7),a=new i(this.app),r=e.getLine(t),s=a.extractImageLink(r);if(!s)return void new ge.Notice("❌ 无法识别图片链接");const o=a.resolveImagePath(s,n);if(!o)return void new ge.Notice("❌ 无法找到图片文件");const l=e.getValue(),c=a.findMaskCommentForImage(l,t);let d=null;if(c.found&&c.content){const e=a.parseCommentToMaskData(c.content);e.success&&(d=e.data||null)}const{ImageMaskEditorModal:u}=await Promise.resolve().then(()=>RCe);new u(this.app,{imageFile:o,initialMaskData:d,onSave:async n=>{await this.saveMaskData(e,t,n,a)}}).open()}catch(i){_e.error("[Plugin] 打开图片遮罩模态窗失败:",i),new ge.Notice("❌ 打开图片遮罩编辑器失败")}}async saveMaskData(e,t,n,i){try{const a=e.getValue(),r=i.findMaskCommentForImage(a,t);if(0===n.masks.length){if(r.found&&"number"==typeof r.line){e.getLine(r.line);e.replaceRange("",{line:r.line,ch:0},{line:r.line+1,ch:0}),_e.debug("[Plugin] 已删除空遮罩注释")}else _e.debug("[Plugin] 无遮罩数据，且无需清理");return}const s=i.maskDataToComment(n);if(r.found&&"number"==typeof r.line){const t=e.getLine(r.line);e.replaceRange(s,{line:r.line,ch:0},{line:r.line,ch:t.length}),_e.debug("[Plugin] 已更新遮罩数据")}else{e.replaceRange(`\n${s}`,{line:t,ch:e.getLine(t).length}),_e.debug("[Plugin] 已插入遮罩数据")}}catch(a){throw _e.error("[Plugin] 保存遮罩数据失败:",a),a}}hasImageLink(e){return/!\[\[.*?\]\]/.test(e)||/!\[.*?\]\(.*?\)/.test(e)}initializeTabletSupport(){try{const e=Rh();_e.debug("[平板端适配] 设备信息:",e),document.body&&Nh(document.body),this.app.workspace.onLayoutReady(()=>{document.querySelectorAll(".tuanki-app").forEach(e=>{e instanceof HTMLElement&&Nh(e)}),this.applyTouchOptimizations()}),window.tuankiDeviceInfo=e,_e.info("[平板端适配] 初始化完成",{device:e.isTablet?"tablet":e.isMobile?"mobile":"desktop",touch:e.isTouch,orientation:e.orientation})}catch(e){_e.error("[平板端适配] 初始化失败:",e)}}applyTouchOptimizations(){try{if(!Rh().isTouch)return void _e.debug("[触控优化] 非触控设备，跳过优化");_e.debug("[触控优化] 开始应用触控优化");const e=document.querySelectorAll(".tuanki-app button, .tuanki-app .clickable");e.forEach(e=>{if(e instanceof HTMLElement){e.classList.add("tuanki-touch-optimized");const t=e.offsetHeight,n=e.offsetWidth;(t<44||n<44)&&(e.style.minHeight="44px",e.style.minWidth="44px")}});const t=document.querySelectorAll('.tuanki-app .scrollable, .tuanki-app [style*="overflow"]');t.forEach(e=>{e instanceof HTMLElement&&(e.style.webkitOverflowScrolling="touch",e.style.overscrollBehavior="contain")}),_e.info("[触控优化] 已应用到",e.length,"个按钮和",t.length,"个滚动容器")}catch(e){_e.error("[触控优化] 应用失败:",e)}}}"undefined"!=typeof window&&(null!=(G=(W=null!=(H=window.__svelte)?H:window.__svelte={}).v)?G:W.v=new Set).add("5");const ag={plus:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 208H272V64c0-17.67-14.33-32-32-32h-32c-17.67 0-32 14.33-32 32v144H32c-17.67 0-32 14.33-32 32v32c0 17.67 14.33 32 32 32h144v144c0 17.67 14.33 32 32 32h32c17.67 0 32-14.33 32-32V304h144c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32z"/></svg>',trash:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16zM53.2 467a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45L416 128H32z"/></svg>',edit:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M402.6 83.2l90.2 90.2c3.8 3.8 3.8 10 0 13.8L274.4 405.6l-92.8 10.3c-12.4 1.4-22.9-9.1-21.5-21.5l10.3-92.8L388.8 83.2c3.8-3.8 10-3.8 13.8 0zm162-22.9l-48.8-48.8c-15.2-15.2-39.9-15.2-55.2 0l-35.4 35.4c-3.8 3.8-3.8 10 0 13.8l90.2 90.2c3.8 3.8 10 3.8 13.8 0l35.4-35.4c15.2-15.3 15.2-40 0-55.2zM384 346.2V448H64V128h229.8c3.2 0 6.2-1.3 8.5-3.5l40-40c7.6-7.6 2.2-20.5-8.5-20.5H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V306.2c0-10.7-12.9-16-20.5-8.5l-40 40c-2.2 2.3-3.5 5.3-3.5 8.5z"/></svg>',settings:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47.6 0-70.8l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10.7-5.4-16.1-3.1l-42.6 24.6c-20.1-17.4-44.9-30.7-72.4-37.9v-49.2c0-5.6-3.9-10.5-9.4-11.7-36.7-8.2-74.3-7.8-109.2 0-5.5 1.2-9.4 6.1-9.4 11.7v49.2c-27.5 7.1-52.3 20.4-72.4 37.9l-42.6-24.6c-5.4-2.3-12.3-.9-16.1 3.1-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4.6 11.2 5.5 14l42.6 24.6c-4.3 23.2-4.3 47.6 0 70.8l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10.7 5.4 16.1 3.1l42.6-24.6c20.1 17.4 44.9 30.7 72.4 37.9v49.2c0 5.6 3.9 10.5 9.4 11.7 36.7 8.2 74.3 7.8 109.2 0 5.5-1.2 9.4-6.1 9.4-11.7v-49.2c27.5-7.1 52.3-20.4 72.4-37.9l42.6 24.6c5.4 2.3 12.3.9 16.1-3.1 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.4-.7-11.2-5.6-14zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z"/></svg>',times:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"/></svg>',check:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg>',copy:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M320 448v40c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V120c0-13.255 10.745-24 24-24h72v296c0 30.879 25.121 56 56 56h168zm0-344V0H152c-13.255 0-24 10.745-24 24v368c0 13.255 10.745 24 24 24h272c13.255 0 24-10.745 24-24V128H344c-13.2 0-24-10.8-24-24zm120.971-31.029L375.029 7.029A24 24 0 0 0 358.059 0H352v96h96v-6.059a24 24 0 0 0-7.029-16.97z"/></svg>',refresh:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M449.9 39.96l-48.5 48.53C362.5 53.19 311.4 32 256 32C161.5 32 78.59 92.34 49.58 182.2c-5.9 18.6 8.63 35.8 28.25 35.8 11.5 0 21.4-7.87 24.6-19.05C123.6 148.91 185.2 112 256 112c29.4 0 57.01 9.13 79.72 24.71l-49.66 49.66C275.7 196.7 283.1 208 296 208h144c8.84 0 16-7.16 16-16V48c0-12.9-11.3-20.3-21.4-9.96l-48.7 48.92zM32 304v144c0 8.84 7.16 16 16 16h144c12.9 0 20.3-11.3 9.96-21.4l-48.92-48.7C182.99 409.13 218.6 432 256 432c70.8 0 132.4-36.91 153.6-86.95 3.2-11.18 13.1-19.05 24.6-19.05 19.62 0 34.15 17.2 28.25 35.8C433.41 451.66 350.5 512 256 512c-55.4 0-106.5-21.19-145.4-56.49L62.04 504c-10.1 10.34-21.4 2.94-21.4-9.96V350c0-8.84 7.16-16 16-16h144c12.9 0 20.3 11.3 9.96 21.4L32 304z"/></svg>',"chevron-down":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg>',"chevron-up":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"/></svg>',"chevron-left":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z"/></svg>',"chevron-right":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>',eye:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M572.52 241.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35 0 0 0 0 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35 0 0 0 0-29.19zM288 400a144 144 0 1 1 144-144 143.93 143.93 0 0 1-144 144zm0-240a95.31 95.31 0 0 0-25.31 3.79 47.85 47.85 0 0 1-66.9 66.9A95.78 95.78 0 1 0 288 160z"/></svg>',"eye-off":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M320 400c-75.85 0-137.25-58.71-142.9-133.11L72.2 185.82c-13.79 17.3-26.48 35.59-36.72 55.59a32.35 32.35 0 0 0 0 29.19C89.71 376.41 197.07 448 320 448c26.91 0 52.87-4 77.89-10.46L346 397.39c-8.4 1.67-17.12 2.61-26 2.61zm313.82 58.1l-110.55-85.44a331.25 331.25 0 0 0 81.25-102.07 32.35 32.35 0 0 0 0-29.19C550.29 135.59 442.93 64 320 64a308.15 308.15 0 0 0-147.32 37.7L45.46 3.37A16 16 0 0 0 23 6.18L3.37 31.45A16 16 0 0 0 6.18 53.9l588.36 454.73a16 16 0 0 0 22.46-2.81l19.64-25.27a16 16 0 0 0-2.82-22.45zm-183.72-142l-39.3-30.38A94.75 94.75 0 0 0 416 256a94.76 94.76 0 0 0-121.31-92.21A47.65 47.65 0 0 1 304 192a46.64 46.64 0 0 1-1.54 10l-73.61-56.89A142.31 142.31 0 0 1 320 112a143.92 143.92 0 0 1 144 144c0 21.63-5.29 41.79-13.9 60.11z"/></svg>',search:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>',info:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>',warning:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></svg>',star:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z" fill="none" stroke="currentColor" stroke-width="32"/></svg>',starFilled:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z" fill="currentColor"/></svg>',bookmark:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M336 0H48C21.49 0 0 21.49 0 48v464l192-112 192 112V48c0-26.51-21.49-48-48-48zm0 428.43l-144-84-144 84V54a6 6 0 0 1 6-6h276a6 6 0 0 1 6 6v374.43z"/></svg>',thumbtack:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M298.028 214.267L285.793 96H328c13.255 0 24-10.745 24-24V24c0-13.255-10.745-24-24-24H56C42.745 0 32 10.745 32 24v48c0 13.255 10.745 24 24 24h42.207L85.972 214.267C37.465 236.82 0 277.261 0 328c0 13.255 10.745 24 24 24h136v104.007c0 1.242.289 2.467.845 3.578l24 48c2.941 5.882 11.364 5.893 14.311 0l24-48a8.008 8.008 0 0 0 .845-3.578V352h136c13.255 0 24-10.745 24-24-.001-51.183-37.983-91.42-85.973-113.733z"/></svg>',sliders:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M496 384H160v-16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v16H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h80v16c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16v-16h336c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zm0-160h-80v-16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v16H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h336v16c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16v-16h80c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16zm0-160H288V48c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v16H16C7.2 64 0 71.2 0 80v32c0 8.8 7.2 16 16 16h208v16c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16v-16h208c8.8 0 16-7.2 16-16V80c0-8.8-7.2-16-16-16z"/></svg>',"ellipsis-h":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8 0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg>',file:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 97.9c4.5 4.5 7 10.6 7 16.9z"/></svg>',download:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M216 0h80c13.3 0 24 10.7 24 24v168h87.7c17.8 0 26.7 21.5 14.1 34.1L269.7 378.3c-7.5 7.5-19.8 7.5-27.3 0L90.1 226.1c-12.6-12.6-3.7-34.1 14.1-34.1H192V24c0-13.3 10.7-24 24-24zm296 376v112c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V376c0-13.3 10.7-24 24-24h146.7l49 49c20.1 20.1 52.5 20.1 72.6 0l49-49H488c13.3 0 24 10.7 24 24zm-124 88c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20zm64 0c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20z"/></svg>',brain:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M208 0c-29.87 0-54.92 20.82-61.48 48.6C126.6 41.96 105.3 32 82 32 36.8 32 0 68.8 0 114s36.8 82 82 82c7.9 0 15.4-1.13 22.5-3.22v70.79c-7.04-2.09-14.61-3.22-22.5-3.22-45.2 0-82 36.8-82 82s36.8 82 82 82c23.3 0 44.6-9.96 64.52-16.6C153.08 435.18 178.13 456 208 456c29.87 0 54.92-20.82 61.48-48.6C289.4 414.04 310.7 424 334 424c45.2 0 82-36.8 82-82s-36.8-82-82-82c-7.9 0-15.4 1.13-22.5 3.22v-70.79c7.04 2.09 14.61 3.22 22.5 3.22 45.2 0 82-36.8 82-82s-36.8-82-82-82c-23.3 0-44.6 9.96-64.52 16.6C262.92 76.82 237.87 56 208 56V0z"/></svg>',bolt:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M296 160H180.6l42.6-129.8C227.2 15 215.7 0 200 0H56C44 0 33.8 8.9 32.2 20.8l-32 240C-1.7 275.2 9.5 288 24 288h118.7L96.6 482.5c-3.6 15.2 8 29.5 23.3 29.5 8.4 0 16.4-4.4 20.8-12l176-304c9.3-15.9-2.2-36-20.7-36z"/></svg>',"chart-bar":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M332.8 320h38.4c6.4 0 12.8-6.4 12.8-12.8V172.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v134.4c0 6.4 6.4 12.8 12.8 12.8zm96 0h38.4c6.4 0 12.8-6.4 12.8-12.8V76.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v230.4c0 6.4 6.4 12.8 12.8 12.8zm-288 0h38.4c6.4 0 12.8-6.4 12.8-12.8v-70.4c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v70.4c0 6.4 6.4 12.8 12.8 12.8zm96 0h38.4c6.4 0 12.8-6.4 12.8-12.8V108.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v198.4c0 6.4 6.4 12.8 12.8 12.8zM496 384H64V80c0-8.84-7.16-16-16-16H16C7.16 64 0 71.16 0 80v336c0 17.67 14.33 32 32 32h464c8.84 0 16-7.16 16-16v-32c0-8.84-7.16-16-16-16z"/></svg>',code:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2l43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6l144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"/></svg>',envelope:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg>',clock:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>',history:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M504 255.531c.253 136.64-111.18 248.372-247.82 248.468-59.015.042-113.223-20.53-155.822-54.911-11.077-8.94-11.905-25.541-1.839-35.607l11.267-11.267c8.609-8.609 22.353-9.551 31.891-1.984C173.062 425.135 212.781 440 256 440c101.705 0 184-82.311 184-184 0-101.705-82.311-184-184-184-48.814 0-93.149 18.969-126.068 49.932l50.754 50.754c10.08 10.08 2.941 27.314-11.313 27.314H24c-8.837 0-16-7.163-16-16V38.627c0-14.254 17.234-21.393 27.314-11.314l49.372 49.372C129.209 34.136 189.552 8 256 8c136.81 0 247.747 110.78 248 247.531zm-180.912 78.784l9.823-12.63c8.138-10.463 6.253-25.542-4.21-33.679L288 256.349V148c0-13.255-10.745-24-24-24h-16c-13.255 0-24 10.745-24 24v135.651l65.409 50.874c10.463 8.137 25.541 6.253 33.679-4.21z"/></svg>',calendar:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"/></svg>',tag:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>',folder:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 128H272l-64-64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48z"/></svg>',"file-text":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm64 236c0 6.6-5.4 12-12 12H108c-6.6 0-12-5.4-12-12v-8c0-6.6 5.4-12 12-12h168c6.6 0 12 5.4 12 12v8zm0-64c0 6.6-5.4 12-12 12H108c-6.6 0-12-5.4-12-12v-8c0-6.6 5.4-12 12-12h168c6.6 0 12 5.4 12 12v8zm0-72v8c0 6.6-5.4 12-12 12H108c-6.6 0-12-5.4-12-12v-8c0-6.6 5.4-12 12-12h168c6.6 0 12 5.4 12 12z"/></svg>',spinner:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49 0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156 0c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>',bars:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>',list:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M80 368H16a16 16 0 0 0-16 16v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-64a16 16 0 0 0-16-16zm0-320H16A16 16 0 0 0 0 64v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16V64a16 16 0 0 0-16-16zm0 160H16a16 16 0 0 0-16 16v64a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-64a16 16 0 0 0-16-16zm416 176H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16z"/></svg>',sort:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M41 288h238c21.4 0 32.1 25.9 17 41L177 448c-9.4 9.4-24.6 9.4-33.9 0L24 329c-15.1-15.1-4.4-41 17-41zm255-105L177 64c-9.4-9.4-24.6-9.4-33.9 0L24 183c-15.1 15.1-4.4 41 17 41h238c21.4 0 32.1-25.9 17-41z"/></svg>',"sort-up":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M279 224H41c-21.4 0-32.1-25.9-17-41L143 64c9.4-9.4 24.6-9.4 33.9 0l119 119c15.2 15.1 4.5 41-16.9 41z"/></svg>',"sort-down":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M41 288h238c21.4 0 32.1 25.9 17 41L177 448c-9.4 9.4-24.6 9.4-33.9 0L24 329c-15.1-15.1-4.4-41 17-41z"/></svg>',bold:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M304.793 243.891c33.639-18.537 53.657-54.16 53.657-95.693 0-48.236-26.25-87.626-68.626-104.179C265.138 34.01 240.849 32 209.661 32H24c-8.837 0-16 7.163-16 16v33.049c0 8.837 7.163 16 16 16h33.113v318.53H24c-8.837 0-16 7.163-16 16V464c0 8.837 7.163 16 16 16h195.69c24.203 0 44.834-1.289 66.866-7.584C337.52 457.193 376 410.647 376 350.014c0-52.168-26.573-91.684-71.207-106.123zM142.217 100.809h67.444c16.294 0 27.536 2.019 37.525 6.717 15.828 7.452 24.66 20.595 24.66 36.78 0 18.094-7.776 31.456-21.746 37.164-10.477 4.284-23.51 5.566-37.525 5.566h-69.842V100.809h-.516zm112.642 305.475c-10.735 4.32-25.5 6.717-42.299 6.717H142.217V271.387h70.358c16.294 0 29.798 1.039 42.299 5.566 18.227 6.591 27.536 23.96 27.536 43.534 0 18.567-8.808 34.027-26.551 41.797z"/></svg>',italic:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M204.758 416h-33.849l62.092-320h33.849a16 16 0 0 0 15.804-12.727l6.758-32C290.559 43.543 284.888 32 277.390 32H144.973a16 16 0 0 0-15.804 12.727l-6.758 32C121.264 84.457 126.935 96 134.433 96h33.849L106.190 416H72.341a16 16 0 0 0-15.804 12.727l-6.758 32C48.632 468.457 54.303 480 61.801 480h132.417a16 16 0 0 0 15.804-12.727l6.758-32c1.147-7.73-4.524-19.273-12.022-19.273z"/></svg>',underline:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M32 64h32c8.837 0 16-7.163 16-16s-7.163-16-16-16H32C14.327 32 0 46.327 0 64s14.327 32 32 32zm0 128h32c8.837 0 16-7.163 16-16s-7.163-16-16-16H32c-17.673 0-32 14.327-32 32s14.327 32 32 32zm416-128H128c-17.673 0-32 14.327-32 32s14.327 32 32 32h320c17.673 0 32-14.327 32-32s-14.327-32-32-32zm0 128H128c-17.673 0-32 14.327-32 32s14.327 32 32 32h320c17.673 0 32-14.327 32-32s-14.327-32-32-32zM224 248c-53.019 0-96 42.981-96 96s42.981 96 96 96 96-42.981 96-96-42.981-96-96-96z"/></svg>',link:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg>',image:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 448H48c-26.51 0-48-21.49-48-48V112c0-26.51 21.49-48 48-48h416c26.51 0 48 21.49 48 48v288c0 26.51-21.49 48-48 48zM112 120c-30.928 0-56 25.072-56 56s25.072 56 56 56 56-25.072 56-56-25.072-56-56-56zM64 384h384V272l-87.515-87.515c-4.686-4.686-12.284-4.686-16.971 0L208 320l-55.515-55.515c-4.686-4.686-12.284-4.686-16.971 0L64 336v48z"/></svg>',layers:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M12.41 148.02l232.94 105.67c6.8 3.09 14.49 3.09 21.29 0l232.94-105.67c16.55-7.51 16.55-32.52 0-40.03L266.65 2.31a25.607 25.607 0 0 0-21.29 0L12.41 107.98c-16.55 7.51-16.55 32.53 0 40.04zm487.18 88.28l-58.09-26.33-161.64 73.27c-7.56 3.43-15.59 5.17-23.86 5.17s-16.29-1.74-23.86-5.17L70.51 209.97l-58.1 26.33c-16.55 7.5-16.55 32.5 0 40l232.94 105.59c6.8 3.08 14.49 3.08 21.29 0L499.59 276.3c16.55-7.5 16.55-32.5 0-40zm0 127.8l-57.87-26.23-161.86 73.37c-7.56 3.43-15.59 5.17-23.86 5.17s-16.29-1.74-23.86-5.17L70.28 337.87 12.41 364.1c-16.55 7.5-16.55 32.5 0 40l232.94 105.59c6.8 3.08 14.49 3.08 21.29 0L499.59 404.1c16.55-7.5 16.55-32.5 0-40z"/></svg>',columns:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM224 416H64V160h160v256zm224 0H288V160h160v256z"/></svg>',hash:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M440.667 182.109l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l14.623-81.891C377.123 38.754 371.468 32 363.997 32h-40.632c-6.775 0-12.483 4.759-13.726 11.391l-13.289 74.609H175.242l14.623-81.891C191.178 38.754 185.523 32 178.052 32h-40.632c-6.775 0-12.483 4.759-13.726 11.391L110.405 128H35.594c-7.471 0-13.126 6.754-11.813 14.109l7.143 40c1.313 7.355 7.342 11.891 14.813 11.891h74.81l-22.857 128H23.88c-7.471 0-13.126 6.754-11.813 14.109l7.143 40c1.313 7.355 7.342 11.891 14.813 11.891h74.81L94.545 469.109C93.232 476.246 98.887 483 106.358 483h40.632c6.775 0 12.483-4.759 13.726-11.391L173.205 384h121.108L280.025 469.109C278.712 476.246 284.367 483 291.838 483h40.632c6.775 0 12.483-4.759 13.726-11.391L359.485 384h74.81c7.471 0 13.126-6.754 11.813-14.109l-7.143-40c-1.313-7.355-7.342-11.891-14.813-11.891h-74.81l22.857-128h74.81c7.471 0 13.126-6.754 11.813-14.109zM261.889 320h-121.11l22.857-128h121.11L261.889 320z"/></svg>',undo:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M255.545 8c-66.269.119-126.438 26.233-170.86 68.685L48.971 40.971C33.851 25.851 8 36.559 8 57.941V192c0 13.255 10.745 24 24 24h134.059c21.382 0 32.09-25.851 16.971-40.971l-41.75-41.75c30.864-28.899 70.801-44.907 113.23-45.273 92.398-.798 170.283 73.977 169.484 169.442C423.236 348.009 349.816 424 256 424c-41.127 0-79.997-14.678-110.63-41.556-4.743-4.161-11.906-3.908-16.368.553L89.34 422.659c-4.872 4.872-4.631 12.815.482 17.433C133.798 479.813 192.074 504 256 504c136.966 0 247.999-111.033 248-247.998C504.001 119.193 392.354 7.755 255.545 8z"/></svg>',layout:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM224 416H64V160h160v256zm224 0H288V160h160v256z"/></svg>',"sidebar-open":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>',"sidebar-close":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>',grid:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm0 160H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm386.667-160H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm0 160H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm-205.334 0H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24z"/></svg>',flag:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M349.565 98.783C295.978 98.783 251.721 64 184.348 64c-24.955 0-47.309 4.384-68.045 12.013a55.947 55.947 0 0 0 3.586-23.562C118.117 24.015 94.806 1.206 66.338.048 34.345-1.254 8 24.296 8 56c0 19.026 9.497 35.825 24 45.945V488c0 13.255 10.745 24 24 24h16c13.255 0 24-10.745 24-24V382.693c22.532-1.524 44.337-5.862 64.817-13.527 50.845-19.048 96.927-11.27 142.427 13.527C336.868 402.547 372.62 416 408 416c31.928 0 62.205-9.803 88-28.976V135.972c-31.753 25.222-70.333 39.697-110.933 39.697-18.775 0-36.911-2.929-53.502-8.886z"/></svg>',circle:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200z"/></svg>',fire:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M216 23.86c0-23.8-30.65-32.77-44.15-13.04C48 191.85 224 200 224 288c0 35.63-29.11 64.46-64.85 63.99-35.17-.45-63.15-29.77-63.15-64.94v-85.51c0-21.7-26.47-32.23-41.43-16.5C27.8 213.16 0 261.33 0 320c0 105.87 86.13 192 192 192s192-86.13 192-192c0-170.29-168-193-168-296.14z"/></svg>',"alert-circle":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>',"layer-group":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M12.41 148.02l232.94 105.67c6.8 3.09 14.49 3.09 21.29 0l232.94-105.67c16.55-7.51 16.55-32.52 0-40.03L266.65 2.31a25.607 25.607 0 0 0-21.29 0L12.41 107.98c-16.55 7.51-16.55 32.53 0 40.04zm487.18 88.28l-58.09-26.33-161.64 73.27c-7.56 3.43-15.59 5.17-23.86 5.17s-16.29-1.74-23.86-5.17L70.51 209.97l-58.1 26.33c-16.55 7.5-16.55 32.5 0 40l232.94 105.59c6.8 3.08 14.49 3.08 21.29 0L499.59 276.3c16.55-7.5 16.55-32.5 0-40zm0 127.8l-57.87-26.23-161.86 73.37c-7.56 3.43-15.59 5.17-23.86 5.17s-16.29-1.74-23.86-5.17L70.28 337.87 12.41 364.1c-16.55 7.5-16.55 32.5 0 40l232.94 105.59c6.8 3.08 14.49 3.08 21.29 0L499.59 404.1c16.55-7.5 16.55-32.5 0-40z"/></svg>',"layout-grid":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm0 160H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm386.667-160H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm0 160H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm-205.334 0H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24z"/></svg>',square:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-6 400H54c-3.3 0-6-2.7-6-6V86c0-3.3 2.7-6 6-6h340c3.3 0 6 2.7 6 6v340c0 3.3-2.7 6-6 6z"/></svg>',"check-square":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zm0 400H48V80h352v352zm-35.864-241.724L191.547 361.48c-4.705 4.667-12.303 4.637-16.97-.068l-90.781-91.516c-4.667-4.705-4.637-12.303.069-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l59.792 60.277 141.352-140.216c4.705-4.667 12.303-4.637 16.97.068l22.536 22.718c4.667 4.706 4.637 12.304-.068 16.971z"/></svg>',inbox:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M567.938 243.908L462.25 85.374A48.003 48.003 0 0 0 422.311 64H153.689a48 48 0 0 0-39.938 21.374L8.062 243.908A47.994 47.994 0 0 0 0 270.533V400c0 26.51 21.49 48 48 48h480c26.51 0 48-21.49 48-48V270.533a47.994 47.994 0 0 0-8.062-26.625zM162.252 128h251.497l85.333 128H376l-32 64H232l-32-64H76.918l85.334-128z"/></svg>',"file-edit":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>',statistics:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M332.8 320h38.4c6.4 0 12.8-6.4 12.8-12.8V172.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v134.4c0 6.4 6.4 12.8 12.8 12.8zm96 0h38.4c6.4 0 12.8-6.4 12.8-12.8V76.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v230.4c0 6.4 6.4 12.8 12.8 12.8zm-288 0h38.4c6.4 0 12.8-6.4 12.8-12.8v-70.4c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v70.4c0 6.4 6.4 12.8 12.8 12.8zm96 0h38.4c6.4 0 12.8-6.4 12.8-12.8V108.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v198.4c0 6.4 6.4 12.8 12.8 12.8zM496 384H64V80c0-8.84-7.16-16-16-16H16C7.16 64 0 71.16 0 80v336c0 17.67 14.33 32 32 32h464c8.84 0 16-7.16 16-16v-32c0-8.84-7.16-16-16-16z"/></svg>',wrench:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M507.73 109.1c-2.24-9.03-13.54-12.09-20.12-5.51l-74.36 74.36-67.88-11.31-11.31-67.88 74.36-74.36c6.62-6.62 3.43-17.9-5.66-20.16-47.38-11.74-99.55.91-136.58 37.93-39.64 39.64-50.55 97.1-34.05 147.2L18.74 402.76c-24.99 24.99-24.99 65.51 0 90.5 24.99 24.99 65.51 24.99 90.5 0l213.21-213.21c50.12 16.71 107.47 5.68 147.37-34.22 37.07-37.07 49.7-89.32 37.91-136.73zM64 472c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24z"/></svg>',database:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M448 73.143v45.714C448 159.143 347.667 192 224 192S0 159.143 0 118.857V73.143C0 32.857 100.333 0 224 0s224 32.857 224 73.143zM448 176v102.857C448 319.143 347.667 352 224 352S0 319.143 0 278.857V176c48.125 33.143 136.208 48.572 224 48.572S399.874 209.143 448 176zm0 160v102.857C448 479.143 347.667 512 224 512S0 479.143 0 438.857V336c48.125 33.143 136.208 48.572 224 48.572S399.874 369.143 448 336z"/></svg>',lightbulb:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path d="M176 80c-52.94 0-96 43.06-96 96 0 8.84 7.16 16 16 16s16-7.16 16-16c0-35.3 28.72-64 64-64 8.84 0 16-7.16 16-16s-7.16-16-16-16zM96.06 459.17c0 3.15.93 6.22 2.68 8.84l24.51 36.84c2.97 4.46 7.97 7.14 13.32 7.14h78.85c5.36 0 10.36-2.68 13.32-7.14l24.51-36.84c1.74-2.62 2.67-5.7 2.68-8.84l.05-43.18H96.02l.04 43.18zM176 0C73.72 0 0 82.97 0 176c0 44.37 16.45 84.85 43.56 115.78 16.64 18.99 42.74 58.8 52.42 92.16v.06h48v-.12c-.01-4.77-.72-9.51-2.15-14.07-5.59-17.81-22.82-64.77-62.17-109.67-20.54-23.43-31.52-53.15-31.61-84.14-.2-73.64 59.67-128 127.95-128 70.58 0 128 57.42 128 128 0 30.97-11.24 60.85-31.65 84.14-39.11 44.61-56.42 91.47-62.1 109.46a47.507 47.507 0 0 0-2.22 14.3v.1h48v-.05c9.68-33.37 35.78-73.18 52.42-92.16C335.55 260.85 352 220.37 352 176 352 78.8 273.2 0 176 0z"/></svg>',"minimize-2":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M200 288H88c-21.4 0-32.1 25.8-17 41l32.9 31-99.2 99.3c-6.2 6.2-6.2 16.4 0 22.6l25.4 25.4c6.2 6.2 16.4 6.2 22.6 0L152 408l31.1 33c15.1 15.1 40.9 4.4 40.9-17V312c0-13.3-10.7-24-24-24zm112-64h112c21.4 0 32.1-25.9 17-41l-32.9-31 99.2-99.3c6.2-6.2 6.2-16.4 0-22.6L481.9 4.7c-6.2-6.2-16.4-6.2-22.6 0L360 104l-31.1-33C313.8 55.9 288 66.6 288 88v112c0 13.3 10.7 24 24 24z"/></svg>',"maximize-2":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M200 288H88c-21.4 0-32.1 25.9-17 41l32.9 31-99.2 99.3c-6.2 6.2-6.2 16.4 0 22.6l25.4 25.4c6.2 6.2 16.4 6.2 22.6 0L152 408l31.1 33c15.1 15.1 40.9 4.4 40.9-17V312c0-13.3-10.7-24-24-24zm312-256l-25.4-25.4c-6.2-6.2-16.4-6.2-22.6 0L365 105.7 333 73c-15.1-15.1-40.9-4.4-40.9 17v112c0 13.3 10.7 24 24 24h112c21.4 0 32.1-25.9 17-41l-32.9-31 99.2-99.3c6.2-6.3 6.2-16.4 0-22.7z"/></svg>',"refresh-cw":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M500.33 0h-47.41a12 12 0 0 0-12 12.57l4 82.76A247.42 247.42 0 0 0 256 8C119.34 8 7.9 119.53 8 256.19 8.1 393.07 119.1 504 256 504a247.1 247.1 0 0 0 166.18-63.91 12 12 0 0 0 .48-17.43l-34-34a12 12 0 0 0-16.38-.55A176 176 0 1 1 402.1 157.8l-101.53-4.87a12 12 0 0 0-12.57 12v47.41a12 12 0 0 0 12 12h200.33a12 12 0 0 0 12-12V12a12 12 0 0 0-12-12z"/></svg>',"bar-chart-2":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M332.8 320h38.4c6.4 0 12.8-6.4 12.8-12.8V172.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v134.4c0 6.4 6.4 12.8 12.8 12.8zm96 0h38.4c6.4 0 12.8-6.4 12.8-12.8V76.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v230.4c0 6.4 6.4 12.8 12.8 12.8zm-288 0h38.4c6.4 0 12.8-6.4 12.8-12.8v-70.4c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v70.4c0 6.4 6.4 12.8 12.8 12.8zm96 0h38.4c6.4 0 12.8-6.4 12.8-12.8V108.8c0-6.4-6.4-12.8-12.8-12.8h-38.4c-6.4 0-12.8 6.4-12.8 12.8v198.4c0 6.4 6.4 12.8 12.8 12.8zM496 384H64V80c0-8.84-7.16-16-16-16H16C7.16 64 0 71.16 0 80v336c0 17.67 14.33 32 32 32h464c8.84 0 16-7.16 16-16v-32c0-8.84-7.16-16-16-16z"/></svg>',award:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M97.12 362.63c-8.69-8.69-4.16-6.24-25.12-11.85-9.51-2.55-17.87-7.45-25.43-13.32L1.2 448.7c-4.39 10.77 3.81 22.47 15.43 22.03l52.69-2.01L105.56 507c8 8.44 22.04 5.81 26.43-4.96l52.05-127.62c-10.84 6.04-22.87 9.58-35.31 9.58-19.5 0-37.82-7.59-51.61-21.37zM382.8 448.7l-45.37-111.24c-7.56 5.88-15.92 10.77-25.43 13.32-21.07 5.64-16.45 3.18-25.12 11.85-13.79 13.78-32.12 21.37-51.62 21.37-12.44 0-24.47-3.55-35.31-9.58L252 502.04c4.39 10.77 18.44 13.4 26.43 4.96l36.25-38.28 52.69 2.01c11.62.44 19.82-11.27 15.43-22.03zM263 340c15.28-15.55 17.03-14.21 38.79-20.14 13.89-3.79 24.75-14.84 28.47-28.98 7.48-28.4 5.54-24.97 25.95-45.75 10.17-10.35 14.14-25.44 10.42-39.58-7.47-28.38-7.48-24.42 0-52.83 3.72-14.14-.25-29.23-10.42-39.58-20.41-20.78-18.47-17.36-25.95-45.75-3.72-14.14-14.58-25.19-28.47-28.98-27.88-7.61-24.52-5.62-44.95-26.41-10.17-10.35-25-14.4-38.89-10.61-27.87 7.6-23.98 7.61-51.9 0-13.89-3.79-28.72.25-38.89 10.61-20.41 20.78-17.05 18.8-44.94 26.41-13.89 3.79-24.75 14.84-28.47 28.98-7.47 28.39-5.54 24.97-25.95 45.75-10.17 10.35-14.15 25.44-10.42 39.58 7.47 28.36 7.48 24.4 0 52.82-3.72 14.14.25 29.23 10.42 39.59 20.41 20.78 18.47 17.35 25.95 45.75 3.72 14.14 14.58 25.19 28.47 28.98C104.6 325.96 106.27 325 121 340c13.23 13.47 33.84 15.88 49.74 5.82a39.676 39.676 0 0 1 42.53 0c15.89 10.06 36.5 7.65 49.73-5.82zM97.66 175.96c0-53.03 42.24-96.02 94.34-96.02s94.34 42.99 94.34 96.02-42.24 96.02-94.34 96.02-94.34-42.99-94.34-96.02z"/></svg>',repeat:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M500.33 0h-47.41a12 12 0 0 0-12 12.57l4 82.76A247.42 247.42 0 0 0 256 8C119.34 8 7.9 119.53 8 256.19 8.1 393.07 119.1 504 256 504a247.1 247.1 0 0 0 166.18-63.91 12 12 0 0 0 .48-17.43l-34-34a12 12 0 0 0-16.38-.55A176 176 0 1 1 402.1 157.8l-101.53-4.87a12 12 0 0 0-12.57 12v47.41a12 12 0 0 0 12 12h200.33a12 12 0 0 0 12-12V12a12 12 0 0 0-12-12z"/></svg>',"rotate-ccw":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M212.333 224.333H12c-6.627 0-12-5.373-12-12V12C0 5.373 5.373 0 12 0h48c6.627 0 12 5.373 12 12v78.112C117.773 39.279 184.26 7.47 258.175 8.007c136.906.994 246.448 111.623 246.157 248.532C504.041 393.258 393.12 504 256.333 504c-64.089 0-122.496-24.313-166.51-64.215-5.099-4.622-5.334-12.554-.467-17.42l33.967-33.967c4.474-4.474 11.662-4.717 16.401-.525C170.76 415.336 211.58 432 256.333 432c97.268 0 176-78.716 176-176 0-97.267-78.716-176-176-176-58.496 0-110.28 28.476-142.274 72.333h98.274c6.627 0 12 5.373 12 12v48c0 6.627-5.373 12-12 12z"/></svg>',"x-circle":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"/></svg>',cube:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M239.1 6.3l-208 78c-18.7 7-31.1 25-31.1 45v225.1c0 18.2 10.3 34.8 26.5 42.9l208 104c13.5 6.8 29.4 6.8 42.9 0l208-104c16.3-8.1 26.5-24.8 26.5-42.9V129.3c0-20-12.4-37.9-31.1-45l-208-78C262 2.2 250 2.2 239.1 6.3zM256 68.4l192 72v1.1l-192 78-192-78v-1.1l192-72zm-32 356V275.5l160-65v133.9l-160 80z"/></svg>',bot:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M32 224h64v64H32v-64zm0 128h64v64H32v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zM224 0c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm224 0c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zM0 128v256c0 53 43 96 96 96h448c53 0 96-43 96-96V128c0-53-43-96-96-96H96C43 32 0 75 0 128z"/></svg>',"chart-line":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M496 384H64V80c0-8.84-7.16-16-16-16H16C7.16 64 0 71.16 0 80v336c0 17.67 14.33 32 32 32h464c8.84 0 16-7.16 16-16v-32c0-8.84-7.16-16-16-16zM464 96H345.94c-21.38 0-32.09 25.85-16.97 40.97l32.4 32.4L288 242.75l-73.37-73.37c-12.5-12.5-32.76-12.5-45.25 0l-68.69 68.69c-6.25 6.25-6.25 16.38 0 22.63l22.62 22.62c6.25 6.25 16.38 6.25 22.63 0L192 236.25l73.37 73.37c12.5 12.5 32.76 12.5 45.25 0l96-96 32.4 32.4c15.12 15.12 40.97 4.41 40.97-16.97V112c.01-8.84-7.15-16-15.99-16z"/></svg>',bullseye:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M248 8C111.03 8 0 119.03 0 256s111.03 248 248 248 248-111.03 248-248S384.97 8 248 8zm0 432c-101.69 0-184-82.29-184-184 0-101.69 82.29-184 184-184 101.69 0 184 82.29 184 184 0 101.69-82.29 184-184 184zm0-312c-70.69 0-128 57.31-128 128s57.31 128 128 128 128-57.31 128-128-57.31-128-128-128zm0 192c-35.29 0-64-28.71-64-64s28.71-64 64-64 64 28.71 64 64-28.71 64-64 64zm0-96c-17.64 0-32 14.36-32 32s14.36 32 32 32 32-14.36 32-32-14.36-32-32-32z"/></svg>',microchip:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 48v416c0 26.51-21.49 48-48 48H144c-26.51 0-48-21.49-48-48V48c0-26.51 21.49-48 48-48h224c26.51 0 48 21.49 48 48zM144 16c-17.67 0-32 14.33-32 32v416c0 17.67 14.33 32 32 32h224c17.67 0 32-14.33 32-32V48c0-17.67-14.33-32-32-32H144zm32 64h160c8.84 0 16 7.16 16 16v32c0 8.84-7.16 16-16 16H176c-8.84 0-16-7.16-16-16V96c0-8.84 7.16-16 16-16zm0 96h160c8.84 0 16 7.16 16 16v32c0 8.84-7.16 16-16 16H176c-8.84 0-16-7.16-16-16v-32c0-8.84 7.16-16 16-16zm0 96h160c8.84 0 16 7.16 16 16v32c0 8.84-7.16 16-16 16H176c-8.84 0-16-7.16-16-16v-32c0-8.84 7.16-16 16-16zm0 96h160c8.84 0 16 7.16 16 16v32c0 8.84-7.16 16-16 16H176c-8.84 0-16-7.16-16-16v-32c0-8.84 7.16-16 16-16z"/></svg>',"check-circle":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></svg>',"graduation-cap":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M622.34 153.2L343.4 67.5c-15.2-4.67-31.6-4.67-46.79 0L17.66 153.2c-23.54 7.23-23.54 38.36 0 45.59l48.63 14.94c-10.67 13.19-17.23 29.28-17.23 46.9v119.47c0 38.99 26.28 72.67 63.63 82.45l13.91 3.64c18.49 4.85 37.74-6.78 42.59-25.27s-6.78-37.74-25.27-42.59L131.01 392.8c-8.96-2.35-15.34-10.42-15.34-19.64V253.69l67.96 20.82c15.2 4.67 31.6 4.67 46.79 0L622.34 198.8c23.55-7.24 23.55-38.36 0-45.6zM496.01 225.94l-144.01 44.17c-15.2 4.67-31.6 4.67-46.79 0l-144.01-44.17L48.01 198.8l247.99-76.02c15.2-4.67 31.6-4.67 46.79 0L592.01 198.8l-96.01 27.14z"/></svg>',zap:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M296 160H180.6l42.6-129.8C227.2 15 215.7 0 200 0H56C44 0 33.8 8.9 32.2 20.8l-32 240C-1.7 275.2 9.5 288 24 288h118.7L96.6 482.5c-3.6 15.2 8 29.5 23.3 29.5 8.4 0 16.4-4.4 20.8-12l176-304c9.3-15.9-2.2-36-20.7-36z"/></svg>',heading:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M448 96v320h32a16 16 0 0 1 16 16v32a16 16 0 0 1-16 16H320a16 16 0 0 1-16-16v-32a16 16 0 0 1 16-16h32V288H160v128h32a16 16 0 0 1 16 16v32a16 16 0 0 1-16 16H32a16 16 0 0 1-16-16v-32a16 16 0 0 1 16-16h32V96H32a16 16 0 0 1-16-16V48a16 16 0 0 1 16-16h160a16 16 0 0 1 16 16v32a16 16 0 0 1-16 16h-32v128h192V96h-32a16 16 0 0 1-16-16V48a16 16 0 0 1 16-16h160a16 16 0 0 1 16 16v32a16 16 0 0 1-16 16z"/></svg>',"clipboard-list":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 40c13.3 0 24 10.7 24 24s-10.7 24-24 24-24-10.7-24-24 10.7-24 24-24zm96 304c0 4.4-3.6 8-8 8H104c-4.4 0-8-3.6-8-8v-16c0-4.4 3.6-8 8-8h176c4.4 0 8 3.6 8 8v16zm0-64c0 4.4-3.6 8-8 8H104c-4.4 0-8-3.6-8-8v-16c0-4.4 3.6-8 8-8h176c4.4 0 8 3.6 8 8v16zm0-64c0 4.4-3.6 8-8 8H104c-4.4 0-8-3.6-8-8v-16c0-4.4 3.6-8 8-8h176c4.4 0 8 3.6 8 8v16z"/></svg>',wand:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38c-12.5-12.5-32.76-12.5-45.25 0L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c12.5 12.5 32.76 12.5 45.25 0L502.62 139.48c12.5-12.5 12.5-32.76 0-45.25z"/></svg>',x:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"/></svg>',save:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM224 416c-35.346 0-64-28.654-64-64 0-35.346 28.654-64 64-64s64 28.654 64 64c0 35.346-28.654 64-64 64zm96-304.52V212c0 6.627-5.373 12-12 12H76c-6.627 0-12-5.373-12-12V108c0-6.627 5.373-12 12-12h228.52c3.183 0 6.235 1.264 8.485 3.515l3.48 3.48A11.996 11.996 0 0 1 320 111.48z"/></svg>',"plus-circle":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6 0-12-5.4-12-12v-92h-92c-6.6 0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6 0 12 5.4 12 12v92h92c6.6 0 12 5.4 12 12v56z"/></svg>',"times-circle":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z"/></svg>',"exclamation-triangle":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/></svg>',th:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm0 160H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm386.667-160H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm0 160H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zm-205.334 0H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.334c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24z"/></svg>',compress:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M4.686 427.314L104 328l-32.922-31.029C55.958 281.851 66.666 256 88.048 256h112C213.303 256 224 266.745 224 280v112c0 21.382-25.803 32.09-40.922 16.971L152 376l-99.314 99.314c-6.248 6.248-16.379 6.248-22.627 0L4.686 449.941c-6.248-6.248-6.248-16.379 0-22.627zM443.314 84.686L344 184l32.922 31.029C392.042 230.149 381.334 256 359.952 256h-112C234.697 256 224 245.255 224 232V120c0-21.382 25.803-32.09 40.922-16.971L296 136l99.314-99.314c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.248 6.248 6.248 16.379 0 22.627z"/></svg>',expand:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M0 180V56c0-13.3 10.7-24 24-24h124c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H64v84c0 6.6-5.4 12-12 12H12c-6.6 0-12-5.4-12-12zM288 44v40c0 6.6 5.4 12 12 12h84v84c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12V56c0-13.3-10.7-24-24-24H300c-6.6 0-12 5.4-12 12zm148 276h-40c-6.6 0-12 5.4-12 12v84h-84c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h124c13.3 0 24-10.7 24-24V332c0-6.6-5.4-12-12-12zM160 468v-40c0-6.6-5.4-12-12-12H64v-84c0-6.6-5.4-12-12-12H12c-6.6 0-12 5.4-12 12v124c0 13.3 10.7 24 24 24h124c6.6 0 12-5.4 12-12z"/></svg>',"th-large":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M296 32h192c13.255 0 24 10.745 24 24v160c0 13.255-10.745 24-24 24H296c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24zm-80 0H24C10.745 32 0 42.745 0 56v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24zM0 296v160c0 13.255 10.745 24 24 24h192c13.255 0 24-10.745 24-24V296c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm296 184h192c13.255 0 24-10.745 24-24V296c0-13.255-10.745-24-24-24H296c-13.255 0-24 10.745-24 24v160c0 13.255 10.745 24 24 24z"/></svg>',"panel-left":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 96C0 60.65 28.65 32 64 32H448C483.3 32 512 60.65 512 96V416C512 451.3 483.3 480 448 480H64C28.65 480 0 451.3 0 416V96zM64 416H192V96H64V416z"/></svg>',"panel-right":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 96C0 60.65 28.65 32 64 32H448C483.3 32 512 60.65 512 96V416C512 451.3 483.3 480 448 480H64C28.65 480 0 451.3 0 416V96zM448 416V96H320V416H448z"/></svg>',"id-card":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M528 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM528 80v352H48V80h480zM208 256c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm-89.6 128h179.2c12.4 0 22.4-8.6 22.4-19.2v-19.2c0-31.8-30.1-57.6-67.2-57.6-10.8 0-18.7 8-44.8 8-26.9 0-33.4-8-44.8-8-37.1 0-67.2 25.8-67.2 57.6v19.2c0 10.6 10 19.2 22.4 19.2zM360 320h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8zm0-64h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8H360c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8z"/></svg>',"id-card-alt":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M528 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm-352 96c35.3 0 64 28.7 64 64s-28.7 64-64 64-64-28.7-64-64 28.7-64 64-64zm112 236.8c0 10.6-10 19.2-22.4 19.2H86.4C74 384 64 375.4 64 364.8v-19.2c0-31.8 30.1-57.6 67.2-57.6 10.8 0 18.7 8 44.8 8 26.9 0 33.4-8 44.8-8 37.1 0 67.2 25.8 67.2 57.6v19.2zM512 312c8.8 0 16-7.2 16-16v-16c0-8.8-7.2-16-16-16H368c-8.8 0-16 7.2-16 16v16c0 8.8 7.2 16 16 16h144zm0-64c8.8 0 16-7.2 16-16v-16c0-8.8-7.2-16-16-16H368c-8.8 0-16 7.2-16 16v16c0 8.8 7.2 16 16 16h144zm0-64c8.8 0 16-7.2 16-16v-16c0-8.8-7.2-16-16-16H368c-8.8 0-16 7.2-16 16v16c0 8.8 7.2 16 16 16h144z"/></svg>',"book-open":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M542.22 32.05c-54.8 3.11-163.72 14.43-230.96 55.59-4.64 2.84-7.27 7.89-7.27 13.17v363.87c0 11.55 12.63 18.85 23.28 13.49 69.18-34.82 169.23-44.32 218.7-46.92 16.89-.89 30.02-14.43 30.02-30.66V62.75c.01-17.71-15.35-31.74-33.77-30.7zM264.73 87.64C197.5 46.48 88.58 35.17 33.78 32.05 15.36 31.01 0 45.04 0 62.75V400.6c0 16.24 13.13 29.78 30.02 30.66 49.49 2.6 149.59 12.11 218.77 46.95 10.62 5.35 23.21-1.94 23.21-13.46V100.63c0-5.29-2.62-10.14-7.27-12.99z"/></svg>',magic:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38c-12.5-12.5-32.76-12.5-45.25 0L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c12.5 12.5 32.76 12.5 45.25 0L502.62 139.48c12.5-12.5 12.5-32.76 0-45.25z"/></svg>',robot:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M32 224h64v64H32v-64zm0 128h64v64H32v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zm128-128h64v64h-64v-64zm0 128h64v64h-64v-64zM224 0c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm224 0c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zM0 128v256c0 53 43 96 96 96h448c53 0 96-43 96-96V128c0-53-43-96-96-96H96C43 32 0 75 0 128z"/></svg>',filter:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M487.976 0H24.028C2.71 0-8.047 25.866 7.058 40.971L192 225.941V432c0 7.831 3.821 15.17 10.237 19.662l80 55.98C298.02 518.69 320 507.493 320 487.98V225.941l184.947-184.97C520.021 25.896 509.338 0 487.976 0z"/></svg>',"volume-up":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M215.03 71.05L126.06 160H24c-13.26 0-24 10.74-24 24v144c0 13.25 10.74 24 24 24h102.06l88.97 88.95c15.03 15.03 40.97 4.47 40.97-16.97V88.02c0-21.46-25.96-31.98-40.97-16.97zm233.32-51.08c-11.17-7.33-26.18-4.24-33.51 6.95-7.34 11.17-4.22 26.18 6.95 33.51 66.27 43.49 105.82 116.6 105.82 195.58 0 78.98-39.54 152.09-105.82 195.58-11.17 7.32-14.29 22.34-6.95 33.5 7.04 10.71 21.93 14.56 33.51 6.95C528.27 439.58 576 351.33 576 256S528.27 72.43 448.35 19.97zM480 256c0-63.53-32.06-121.94-85.77-156.24-11.19-7.14-26.03-3.82-33.12 7.46s-3.78 26.21 7.41 33.36C408.27 165.97 432 209.11 432 256s-23.73 90.03-63.48 115.42c-11.19 7.14-14.5 22.07-7.41 33.36 6.51 10.36 21.12 15.14 33.12 7.46C447.94 377.94 480 319.53 480 256zm-96 0c0-33.53-17.2-62.99-43.27-80.17-11.73-7.73-27.57-4.58-35.27 7.16-7.7 11.72-4.5 27.33 7.02 35.25 9.27 6.19 15.52 16.71 15.52 27.76 0 11.04-6.25 21.57-15.52 27.75-11.53 7.92-14.72 23.53-7.02 35.25 7.69 11.73 23.54 14.89 35.27 7.16C366.8 318.99 384 289.53 384 256z"/></svg>',"volume-down":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M215.03 71.05L126.06 160H24c-13.26 0-24 10.74-24 24v144c0 13.25 10.74 24 24 24h102.06l88.97 88.95c15.03 15.03 40.97 4.47 40.97-16.97V88.02c0-21.46-25.96-31.98-40.97-16.97zM384 256c0-33.53-17.2-62.99-43.27-80.17-11.73-7.73-27.57-4.58-35.27 7.16-7.7 11.72-4.5 27.33 7.02 35.25 9.27 6.19 15.52 16.71 15.52 27.76 0 11.04-6.25 21.57-15.52 27.75-11.53 7.92-14.72 23.53-7.02 35.25 7.69 11.73 23.54 14.89 35.27 7.16C366.8 318.99 384 289.53 384 256z"/></svg>',"volume-mute":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M215.03 71.05L126.06 160H24c-13.26 0-24 10.74-24 24v144c0 13.25 10.74 24 24 24h102.06l88.97 88.95c15.03 15.03 40.97 4.47 40.97-16.97V88.02c0-21.46-25.96-31.98-40.97-16.97zm233.32-51.08c-11.17-7.33-26.18-4.24-33.51 6.95-7.34 11.17-4.22 26.18 6.95 33.51 66.27 43.49 105.82 116.6 105.82 195.58 0 78.98-39.54 152.09-105.82 195.58-11.17 7.32-14.29 22.34-6.95 33.5 7.04 10.71 21.93 14.56 33.51 6.95C528.27 439.58 576 351.33 576 256S528.27 72.43 448.35 19.97zM480 256c0-63.53-32.06-121.94-85.77-156.24-11.19-7.14-26.03-3.82-33.12 7.46s-3.78 26.21 7.41 33.36C408.27 165.97 432 209.11 432 256s-23.73 90.03-63.48 115.42c-11.19 7.14-14.5 22.07-7.41 33.36 6.51 10.36 21.12 15.14 33.12 7.46C447.94 377.94 480 319.53 480 256zm-96 0c0-33.53-17.2-62.99-43.27-80.17-11.73-7.73-27.57-4.58-35.27 7.16-7.7 11.72-4.5 27.33 7.02 35.25 9.27 6.19 15.52 16.71 15.52 27.76 0 11.04-6.25 21.57-15.52 27.75-11.53 7.92-14.72 23.53-7.02 35.25 7.69 11.73 23.54 14.89 35.27 7.16C366.8 318.99 384 289.53 384 256z"/></svg>',upload:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M296 384h-80c-13.3 0-24-10.7-24-24V192h-87.7c-17.8 0-26.7-21.5-14.1-34.1L242.3 5.7c7.5-7.5 19.8-7.5 27.3 0l152.2 152.2c12.6 12.6 3.7 34.1-14.1 34.1H320v168c0 13.3-10.7 24-24 24zm216-8v112c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V376c0-13.3 10.7-24 24-24h146.7l49 49c20.1 20.1 52.5 20.1 72.6 0l49-49H488c13.3 0 24 10.7 24 24zm-124 88c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20zm64 0c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20z"/></svg>',play:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M424.4 214.7L72.4 6.6C43.8-10.3 0 6.1 0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1 0-82.6z"/></svg>',pause:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M144 479H48c-26.5 0-48-21.5-48-48V79c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v352c0 26.5-21.5 48-48 48zm304-48V79c0-26.5-21.5-48-48-48h-96c-26.5 0-48 21.5-48 48v352c0 26.5 21.5 48 48 48h96c26.5 0 48-21.5 48-48z"/></svg>',stop:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48z"/></svg>',"list-ul":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M48 48a48 48 0 1 1 0 96 48 48 0 1 1 0-96zm0 160a48 48 0 1 1 0 96 48 48 0 1 1 0-96zm0 160a48 48 0 1 1 0 96 48 48 0 1 1 0-96zM192 64c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192z"/></svg>',"list-ol":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M24 56c0-13.3 10.7-24 24-24h32c13.3 0 24 10.7 24 24v120h16c13.3 0 24 10.7 24 24s-10.7 24-24 24H48c-13.3 0-24-10.7-24-24s10.7-24 24-24h8V80H48c-13.3 0-24-10.7-24-24zM86.7 341.2c-6.5-7.4-18.3-6.9-24 1.2L51.5 357.9c-7.7 10.8-2.2 25.1 11.1 25.1h5.8c2.3 8.5 9.5 15.4 18.8 17.8c-2.9 6.2-9.4 10.2-16.7 10.2c-7.9 0-15.3-4.9-18.2-12.3c-2.8-7.2-11-10.9-18.2-8.1s-10.9 11-8.1 18.2c8.2 21.2 30.9 34 53.5 34c30.9 0 56-25.1 56-56c0-8.8-2-17.1-5.5-24.5c2.5-1.9 4.8-4.1 6.8-6.8l5.2-7.3c7.7-10.8 2.2-25.1-11.1-25.1H86.7zM192 64c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H192z"/></svg>',markdown:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M593.8 59.1H46.2C20.7 59.1 0 79.8 0 105.2v301.5c0 25.5 20.7 46.2 46.2 46.2h547.7c25.5 0 46.2-20.7 46.1-46.1V105.2c0-25.4-20.7-46.1-46.2-46.1zM338.5 360.6H277v-120l-61.5 76.9-61.5-76.9v120H92.3V151.4h61.5l61.5 76.9 61.5-76.9h61.5v209.2zm135.3 3.1L381.5 256H443V151.4h61.5V256H566z"/></svg>',bell:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M224 512c35.32 0 63.97-28.65 63.97-64H160.03c0 35.35 28.65 64 63.97 64zm215.39-149.71c-19.32-20.76-55.47-51.99-55.47-154.29 0-77.7-54.48-139.9-127.94-155.16V32c0-17.67-14.32-32-31.98-32s-31.98 14.33-31.98 32v20.84C118.56 68.1 64.08 130.3 64.08 208c0 102.3-36.15 133.53-55.47 154.29-6 6.45-8.66 14.16-8.61 21.71.11 16.4 12.98 32 32.1 32h383.8c19.12 0 32-15.6 32.1-32 .05-7.55-2.61-15.27-8.61-21.71z"/></svg>',"question-circle":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zM262.655 90c-54.497 0-89.255 22.957-116.549 63.758-3.536 5.286-2.353 12.415 2.715 16.258l34.699 26.31c5.205 3.947 12.621 3.008 16.665-2.122 17.864-22.658 30.113-35.797 57.303-35.797 20.429 0 45.698 13.148 45.698 32.958 0 14.976-12.363 22.667-32.534 33.976C247.128 238.528 216 254.941 216 296v4c0 6.627 5.373 12 12 12h56c6.627 0 12-5.373 12-12v-1.333c0-28.462 83.186-29.647 83.186-106.667 0-58.002-60.165-102-116.531-102zM256 338c-25.365 0-46 20.635-46 46 0 25.364 20.635 46 46 46s46-20.636 46-46c0-25.365-20.635-46-46-46z"/></svg>',"panel-left-open":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zm64 0v320H192V96H64zm384 0H256V416H448V96z"/></svg>',"panel-left-close":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zm384 96H320V416h64c17.7 0 32-14.3 32-32V192zm-64-64v64h64V128c0-17.7-14.3-32-32-32H320zM64 96V416H256V96H64z"/></svg>',"columns-3":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M0 96C0 60.7 28.7 32 64 32H576c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM64 96V416H213.3V96H64zm384 0V416H597.3V96H448zM277.3 96V416H362.7V96H277.3z"/></svg>',film:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M488 64h-8v20c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12V64H96v20c0 6.6-5.4 12-12 12H44c-6.6 0-12-5.4-12-12V64h-8C10.7 64 0 74.7 0 88v336c0 13.3 10.7 24 24 24h8v-20c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v20h320v-20c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v20h8c13.3 0 24-10.7 24-24V88c0-13.3-10.7-24-24-24zM96 372c0 6.6-5.4 12-12 12H44c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12H44c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12H44c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm272 208c0 6.6-5.4 12-12 12H156c-6.6 0-12-5.4-12-12v-96c0-6.6 5.4-12 12-12h200c6.6 0 12 5.4 12 12v96zm0-168c0 6.6-5.4 12-12 12H156c-6.6 0-12-5.4-12-12v-96c0-6.6 5.4-12 12-12h200c6.6 0 12 5.4 12 12v96zm112 152c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40zm0-96c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40z"/></svg>'};function rg(e){return ag[e]||ag.info}function sg(e){return e in ag}const og={deckStudy:"graduation-cap",tuankiCardManagement:"id-card",cardManagement:"id-card",aiAssistant:"robot",statistics:"chart-line",plus:"plus",trash:"trash",delete:"trash",edit:"edit",settings:"settings",cog:"settings",close:"times",times:"times",check:"check",copy:"copy",refresh:"refresh",sync:"refresh","chevron-down":"chevron-down","chevron-up":"chevron-up","chevron-left":"chevron-left","chevron-right":"chevron-right","arrow-left":"chevron-left","arrow-right":"chevron-right",eye:"eye","eye-off":"eye-off",search:"search",filter:"filter","info-circle":"info",info:"info","question-circle":"question-circle",help:"question-circle",bell:"bell",star:"star",bookmark:"bookmark",thumbtack:"thumbtack",pin:"thumbtack",sliders:"sliders",lightbulb:"lightbulb",play:"play","volume-up":"volume-up","volume-down":"volume-down","volume-mute":"volume-mute",pause:"pause",stop:"stop",file:"file","file-text":"file-text",upload:"upload",download:"download",database:"database",code:"code",microchip:"microchip","chart-bar":"chart-bar","chart-line":"chart-line",bullseye:"bullseye",envelope:"envelope",mail:"envelope",clock:"clock",history:"history","calendar-alt":"calendar",calendar:"calendar",alert:"warning",warning:"warning","check-circle":"check-circle",brain:"brain","graduation-cap":"graduation-cap",bold:"bold",italic:"italic",underline:"underline",heading:"heading","list-ul":"list-ul","list-ol":"list-ol",link:"link",image:"image",markdown:"markdown","list-alt":"list","clipboard-list":"clipboard-list","layer-group":"layer-group",tag:"tag",hash:"hash",bolt:"bolt",magic:"magic",layers:"layers",columns:"columns","book-open":"book-open",robot:"robot","id-card":"id-card","id-card-alt":"id-card-alt","trash-2":"trash",x:"times","alert-circle":"info","alert-triangle":"exclamation-triangle","tag-x":"times","tag-plus":"plus",chevronDown:"chevron-down",checkCircle:"check",xCircle:"times-circle",loader:"spinner","th-list":"list","th-large":"th-large","more-horizontal":"ellipsis-h","layout-template":"th-large","arrow-up":"chevron-up","arrow-down":"chevron-down","trending-up":"chart-bar",starFilled:"star",trendingUp:"chart-bar",award:"star",package:"file","upload-cloud":"chevron-up","file-plus":"plus","git-merge":"chevron-right",activity:"chart-bar",shield:"star","credit-card":"file",tool:"settings",target:"star","bar-chart":"chart-bar",cpu:"settings",sparkles:"star","file-x":"times","sidebar-open":"bars","sidebar-close":"chevron-right","panel-left-open":"bars","panel-left-close":"chevron-left","panel-left":"panel-left","panel-right":"panel-right","columns-3":"columns-3",film:"film",fileText:"file-text",chevronRight:"chevron-right",obsidian:"cube",folder:"folder",document:"file",square:"square","check-square":"check-square",loading:"spinner",wrench:"wrench",compress:"compress",expand:"expand",list:"list","ellipsis-h":"ellipsis-h",grid:"th","bar-chart-2":"chart-bar",sort:"sort","sort-up":"sort-up","sort-down":"sort-down"},lg={split:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    \x3c!-- 主卡片 --\x3e\n    <rect x="4" y="3" width="16" height="7" rx="1.5"/>\n    \x3c!-- 连接线 --\x3e\n    <path d="M12 10 L12 13"/>\n    \x3c!-- 分叉线 --\x3e\n    <path d="M12 13 L7 16"/>\n    <path d="M12 13 L12 16"/>\n    <path d="M12 13 L17 16"/>\n    \x3c!-- 三张子卡片 --\x3e\n    <rect x="2" y="16" width="5" height="5" rx="1"/>\n    <rect x="9.5" y="16" width="5" height="5" rx="1"/>\n    <rect x="17" y="16" width="5" height="5" rx="1"/>\n  </svg>'};function cg(e){if(lg[e])return lg[e];if(sg(e))return rg(e);const t=og[e];return t&&sg(t)?rg(t):rg("info")}function dg(e){if(lg[e])return!0;if(sg(e))return!0;const t=og[e];return!!t&&sg(t)}const ug="deckStudy",hg="tuankiCardManagement",pg="aiAssistant",gg="statistics",vg="plus",fg="trash",mg="cog",yg="times",bg="check",wg="copy",kg="chevron-down",Sg="chevron-up",xg="chevron-right",_g="arrow-right",Cg="search",Ig="info-circle",Dg="question-circle",Tg="download",Mg="warning",Ag="check-circle",Eg="link",zg="tag",Pg="hash",Rg="folder",$g="x";var Og=la("<span> </span>"),Lg=la('<span><span class="tuanki-icon__content svelte-1hcxni0"><!></span> <!></span>');function Ng(e,t){if(new.target)return Er({component:Ng,...e});kt(t,!0);let n=Ar(t,"name",7),i=Ar(t,"size",7,"md"),a=Ar(t,"variant",7,"default"),r=Ar(t,"color",7),s=Ar(t,"rotate",7),o=Ar(t,"flip",7),l=Ar(t,"animation",7),c=Ar(t,"opacity",7),d=Ar(t,"disabled",7,!1),u=Ar(t,"clickable",7,!1),h=Ar(t,"badge",7),p=Ar(t,"badgeVariant",7,"primary"),g=Ar(t,"badgePosition",7,"top-right"),v=Ar(t,"onclick",7),f=Ar(t,"onhover",7),m=Ar(t,"onfocus",7),y=Ar(t,"ariaLabel",7),b=Ar(t,"title",7),w=Ar(t,"role",7,"img"),k=Ar(t,"class",7,""),S=Mr(t,["$$slots","$$events","$$legacy","name","size","variant","color","rotate","flip","animation","opacity","disabled","clickable","badge","badgeVariant","badgePosition","onclick","onhover","onfocus","ariaLabel","title","role","class"]),x=In(()=>cg(n())||cg("question-circle")),_=In(()=>()=>{if("number"==typeof i())return`${i()}px`;if("string"==typeof i()&&i().includes("px"))return i();return{xs:"12px",sm:"14px",md:"16px",lg:"20px",xl:"24px","2xl":"32px"}[i()]||"16px"}),C=In(()=>()=>{const e=[];return s()&&e.push(`rotate(${s()}deg)`),"horizontal"===o()&&e.push("scaleX(-1)"),"vertical"===o()&&e.push("scaleY(-1)"),"both"===o()&&e.push("scaleX(-1) scaleY(-1)"),e.length>0?e.join(" "):void 0}),I=In(()=>()=>{const e={width:bi(_)(),height:bi(_)(),display:"inline-flex","align-items":"center","justify-content":"center","flex-shrink":"0"};r()&&(e.color=r()),void 0!==c()&&(e.opacity=c().toString());const t=bi(C)();return t&&(e.transform=t),d()&&(e.opacity="0.5"),Object.entries(e).map(([e,t])=>`${e}: ${t}`).join("; ")}),D=In(()=>()=>{const e=["tuanki-icon",`tuanki-icon--${a()}`,`tuanki-icon--${i()}`];return l()&&e.push(`tuanki-icon--${l()}`),d()&&e.push("tuanki-icon--disabled"),(u()||v())&&e.push("tuanki-icon--clickable"),h()&&e.push("tuanki-icon--with-badge"),k()&&e.push(k()),e.join(" ")}),T=In(()=>()=>["tuanki-icon__badge",`tuanki-icon__badge--${p()}`,`tuanki-icon__badge--${g()}`].join(" "));function M(e){var t;d()||null==(t=v())||t(e)}let A=In(()=>({role:u()?"button":"img","aria-label":y()||n(),"aria-hidden":!u()&&!y()||void 0,tabindex:u()?0:void 0,...S}));var E={get name(){return n()},set name(e){n(e),hn()},get size(){return i()},set size(e="md"){i(e),hn()},get variant(){return a()},set variant(e="default"){a(e),hn()},get color(){return r()},set color(e){r(e),hn()},get rotate(){return s()},set rotate(e){s(e),hn()},get flip(){return o()},set flip(e){o(e),hn()},get animation(){return l()},set animation(e){l(e),hn()},get opacity(){return c()},set opacity(e){c(e),hn()},get disabled(){return d()},set disabled(e=!1){d(e),hn()},get clickable(){return u()},set clickable(e=!1){u(e),hn()},get badge(){return h()},set badge(e){h(e),hn()},get badgeVariant(){return p()},set badgeVariant(e="primary"){p(e),hn()},get badgePosition(){return g()},set badgePosition(e="top-right"){g(e),hn()},get onclick(){return v()},set onclick(e){v(e),hn()},get onhover(){return f()},set onhover(e){f(e),hn()},get onfocus(){return m()},set onfocus(e){m(e),hn()},get ariaLabel(){return y()},set ariaLabel(e){y(e),hn()},get title(){return b()},set title(e){b(e),hn()},get role(){return w()},set role(e="img"){w(e),hn()},get class(){return k()},set class(e=""){k(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},z=Lg(),P=e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),M(e))};tr(z,(e,t)=>({class:e,style:t,...bi(A),onclick:M,onkeydown:P}),[()=>bi(D)(),()=>bi(I)()],void 0,"svelte-1hcxni0");var R=Gt(z);Aa(Gt(R),()=>bi(x)),zt(R);var $=Kt(R,2),O=e=>{var t=Og(),n=Gt(t,!0);zt(t),zi(e=>{Fa(t,1,e,"svelte-1hcxni0"),va(n,h())},[()=>$a(bi(T)())]),pa(e,t)};return xa($,e=>{h()&&e(O)}),zt(z),pa(e,z),St(E)}var Fg=la('<span class="tuanki-btn__text svelte-fsmucp"><!></span>'),Bg=la('<kbd class="tuanki-btn__shortcut svelte-fsmucp"> </kbd>'),jg=la("<a><!> <!> <!> <!></a>"),Ug=la('<span class="tuanki-btn__text svelte-fsmucp"><!></span>'),Vg=la('<kbd class="tuanki-btn__shortcut svelte-fsmucp"> </kbd>'),qg=la("<button><!> <!> <!> <!></button>");function Hg(e,t){if(new.target)return Er({component:Hg,...e});kt(t,!0);let n=Ar(t,"variant",7,"secondary"),i=Ar(t,"size",7,"md"),a=Ar(t,"disabled",7,!1),r=Ar(t,"loading",7,!1),s=Ar(t,"icon",7),o=Ar(t,"iconPosition",7,"left"),l=Ar(t,"iconOnly",7,!1),c=Ar(t,"onclick",7),d=Ar(t,"onhover",7),u=Ar(t,"onfocus",7),h=Ar(t,"ariaLabel",7),p=Ar(t,"tooltip",7),g=Ar(t,"shortcut",7),v=Ar(t,"class",7,""),f=Ar(t,"fullWidth",7,!1),m=Ar(t,"rounded",7,!1),y=Ar(t,"href",7),b=Ar(t,"target",7),w=Ar(t,"type",7,"button"),k=Ar(t,"children",7),S=Mr(t,["$$slots","$$events","$$legacy","variant","size","disabled","loading","icon","iconPosition","iconOnly","onclick","onhover","onfocus","ariaLabel","tooltip","shortcut","class","fullWidth","rounded","href","target","type","children"]);const x=$r();let _=In(()=>()=>{const e=["tuanki-btn",`tuanki-btn--${n()}`,`tuanki-btn--${i()}`];return r()&&e.push("tuanki-btn--loading"),a()&&e.push("tuanki-btn--disabled"),f()&&e.push("tuanki-btn--full-width"),m()&&e.push("tuanki-btn--rounded"),l()&&e.push("tuanki-btn--icon-only"),v()&&e.push(v()),e.join(" ")});function C(e){var t;a()||r()||(null==(t=c())||t(e),x("click",e))}function I(e){var t;a()||(null==(t=d())||t(e),x("hover",e))}function D(e){var t;a()||(null==(t=u())||t(e),x("focus",e))}let T=In(()=>()=>{switch(i()){case"xs":return 12;case"sm":return 14;case"md":default:return 16;case"lg":return 18;case"xl":return 20}});var M={get variant(){return n()},set variant(e="secondary"){n(e),hn()},get size(){return i()},set size(e="md"){i(e),hn()},get disabled(){return a()},set disabled(e=!1){a(e),hn()},get loading(){return r()},set loading(e=!1){r(e),hn()},get icon(){return s()},set icon(e){s(e),hn()},get iconPosition(){return o()},set iconPosition(e="left"){o(e),hn()},get iconOnly(){return l()},set iconOnly(e=!1){l(e),hn()},get onclick(){return c()},set onclick(e){c(e),hn()},get onhover(){return d()},set onhover(e){d(e),hn()},get onfocus(){return u()},set onfocus(e){u(e),hn()},get ariaLabel(){return h()},set ariaLabel(e){h(e),hn()},get tooltip(){return p()},set tooltip(e){p(e),hn()},get shortcut(){return g()},set shortcut(e){g(e),hn()},get class(){return v()},set class(e=""){v(e),hn()},get fullWidth(){return f()},set fullWidth(e=!1){f(e),hn()},get rounded(){return m()},set rounded(e=!1){m(e),hn()},get href(){return y()},set href(e){y(e),hn()},get target(){return b()},set target(e){b(e),hn()},get type(){return w()},set type(e="button"){w(e),hn()},get children(){return k()},set children(e){k(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},A=ha(),E=Qt(A),z=e=>{var t=jg();tr(t,e=>({href:y(),target:b(),class:e,"aria-label":h(),title:p(),onclick:C,onmouseover:I,onfocus:D,...S}),[()=>bi(_)()],void 0,"svelte-fsmucp");var n=Gt(t),i=e=>{{let t=In(()=>bi(T)());Ng(e,{name:"spinner",get size(){return bi(t)},animation:"spin"})}},a=e=>{var t=ha(),n=Qt(t),i=e=>{{let t=In(()=>bi(T)());Ng(e,{get name(){return s()},get size(){return bi(t)}})}};xa(n,e=>{s()&&"left"===o()&&e(i)},!0),pa(e,t)};xa(n,e=>{r()?e(i):e(a,!1)});var c=Kt(n,2),d=e=>{var t=Fg();Ea(Gt(t),()=>{var e;return null!=(e=k())?e:je}),zt(t),pa(e,t)};xa(c,e=>{l()||e(d)});var u=Kt(c,2),v=e=>{{let t=In(()=>bi(T)());Ng(e,{get name(){return s()},get size(){return bi(t)}})}};xa(u,e=>{s()&&"right"===o()&&!r()&&e(v)});var f=Kt(u,2),m=e=>{var t=Bg(),n=Gt(t,!0);zt(t),zi(()=>va(n,g())),pa(e,t)};xa(f,e=>{g()&&e(m)}),zt(t),pa(e,t)},P=e=>{var t=qg();tr(t,e=>({type:w(),class:e,disabled:a(),"aria-label":h(),title:p(),onclick:C,onmouseover:I,onfocus:D,...S}),[()=>bi(_)()],void 0,"svelte-fsmucp");var n=Gt(t),i=e=>{{let t=In(()=>bi(T)());Ng(e,{name:"spinner",get size(){return bi(t)},animation:"spin"})}},c=e=>{var t=ha(),n=Qt(t),i=e=>{{let t=In(()=>bi(T)());Ng(e,{get name(){return s()},get size(){return bi(t)}})}};xa(n,e=>{s()&&"left"===o()&&e(i)},!0),pa(e,t)};xa(n,e=>{r()?e(i):e(c,!1)});var d=Kt(n,2),u=e=>{var t=Ug();Ea(Gt(t),()=>{var e;return null!=(e=k())?e:je}),zt(t),pa(e,t)};xa(d,e=>{l()||e(u)});var v=Kt(d,2),f=e=>{{let t=In(()=>bi(T)());Ng(e,{get name(){return s()},get size(){return bi(t)}})}};xa(v,e=>{s()&&"right"===o()&&!r()&&e(f)});var m=Kt(v,2),y=e=>{var t=Vg(),n=Gt(t,!0);zt(t),zi(()=>va(n,g())),pa(e,t)};xa(m,e=>{g()&&e(y)}),zt(t),pa(e,t)};return xa(E,e=>{y()?e(z):e(P,!1)}),pa(e,A),St(M)}var Wg=la('<div class="loader-message svelte-1f3oa8z"> </div>'),Gg=la('<div class="bouncing-balls-loader svelte-1f3oa8z"><div class="loader-wrapper svelte-1f3oa8z"><div class="circle svelte-1f3oa8z"></div> <div class="circle svelte-1f3oa8z"></div> <div class="circle svelte-1f3oa8z"></div> <div class="shadow svelte-1f3oa8z"></div> <div class="shadow svelte-1f3oa8z"></div> <div class="shadow svelte-1f3oa8z"></div></div> <!></div>');function Qg(e,t){if(new.target)return Er({component:Qg,...e});kt(t,!0);let n=Ar(t,"message",7,"加载中...");var i={get message(){return n()},set message(e="加载中..."){n(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},a=Gg(),r=Kt(Gt(a),2),s=e=>{var t=Wg(),i=Gt(t,!0);zt(t),zi(()=>va(i,n())),pa(e,t)};return xa(r,e=>{n()&&e(s)}),zt(a),pa(e,a),St(i)}const Kg=Math.min,Zg=Math.max,Yg=Math.round,Xg=e=>({x:e,y:e}),Jg={left:"right",right:"left",bottom:"top",top:"bottom"},ev={start:"end",end:"start"};function tv(e,t,n){return Zg(e,Kg(t,n))}function nv(e,t){return"function"==typeof e?e(t):e}function iv(e){return e.split("-")[0]}function av(e){return e.split("-")[1]}function rv(e){return"x"===e?"y":"x"}function sv(e){return"y"===e?"height":"width"}const ov=new Set(["top","bottom"]);function lv(e){return ov.has(iv(e))?"y":"x"}function cv(e){return rv(lv(e))}function dv(e){return e.replace(/start|end/g,e=>ev[e])}const uv=["left","right"],hv=["right","left"],pv=["top","bottom"],gv=["bottom","top"];function vv(e,t,n,i){const a=av(e);let r=function(e,t,n){switch(e){case"top":case"bottom":return n?t?hv:uv:t?uv:hv;case"left":case"right":return t?pv:gv;default:return[]}}(iv(e),"start"===n,i);return a&&(r=r.map(e=>e+"-"+a),t&&(r=r.concat(r.map(dv)))),r}function fv(e){return e.replace(/left|right|bottom|top/g,e=>Jg[e])}function mv(e){const{x:t,y:n,width:i,height:a}=e;return{width:i,height:a,top:n,left:t,right:t+i,bottom:n+a,x:t,y:n}}function yv(e,t,n){let{reference:i,floating:a}=e;const r=lv(t),s=cv(t),o=sv(s),l=iv(t),c="y"===r,d=i.x+i.width/2-a.width/2,u=i.y+i.height/2-a.height/2,h=i[o]/2-a[o]/2;let p;switch(l){case"top":p={x:d,y:i.y-a.height};break;case"bottom":p={x:d,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:u};break;case"left":p={x:i.x-a.width,y:u};break;default:p={x:i.x,y:i.y}}switch(av(t)){case"start":p[s]-=h*(n&&c?-1:1);break;case"end":p[s]+=h*(n&&c?-1:1)}return p}async function bv(e,t){var n;void 0===t&&(t={});const{x:i,y:a,platform:r,rects:s,elements:o,strategy:l}=e,{boundary:c="clippingAncestors",rootBoundary:d="viewport",elementContext:u="floating",altBoundary:h=!1,padding:p=0}=nv(t,e),g=function(e){return"number"!=typeof e?function(e){return{top:0,right:0,bottom:0,left:0,...e}}(e):{top:e,right:e,bottom:e,left:e}}(p),v=o[h?"floating"===u?"reference":"floating":u],f=mv(await r.getClippingRect({element:null==(n=await(null==r.isElement?void 0:r.isElement(v)))||n?v:v.contextElement||await(null==r.getDocumentElement?void 0:r.getDocumentElement(o.floating)),boundary:c,rootBoundary:d,strategy:l})),m="floating"===u?{x:i,y:a,width:s.floating.width,height:s.floating.height}:s.reference,y=await(null==r.getOffsetParent?void 0:r.getOffsetParent(o.floating)),b=await(null==r.isElement?void 0:r.isElement(y))&&await(null==r.getScale?void 0:r.getScale(y))||{x:1,y:1},w=mv(r.convertOffsetParentRelativeRectToViewportRelativeRect?await r.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:m,offsetParent:y,strategy:l}):m);return{top:(f.top-w.top+g.top)/b.y,bottom:(w.bottom-f.bottom+g.bottom)/b.y,left:(f.left-w.left+g.left)/b.x,right:(w.right-f.right+g.right)/b.x}}const wv=new Set(["left","top"]);function kv(){return"undefined"!=typeof window}function Sv(e){return Cv(e)?(e.nodeName||"").toLowerCase():"#document"}function xv(e){var t;return(null==e||null==(t=e.ownerDocument)?void 0:t.defaultView)||window}function _v(e){var t;return null==(t=(Cv(e)?e.ownerDocument:e.document)||window.document)?void 0:t.documentElement}function Cv(e){return!!kv()&&(e instanceof Node||e instanceof xv(e).Node)}function Iv(e){return!!kv()&&(e instanceof Element||e instanceof xv(e).Element)}function Dv(e){return!!kv()&&(e instanceof HTMLElement||e instanceof xv(e).HTMLElement)}function Tv(e){return!(!kv()||"undefined"==typeof ShadowRoot)&&(e instanceof ShadowRoot||e instanceof xv(e).ShadowRoot)}const Mv=new Set(["inline","contents"]);function Av(e){const{overflow:t,overflowX:n,overflowY:i,display:a}=Uv(e);return/auto|scroll|overlay|hidden|clip/.test(t+i+n)&&!Mv.has(a)}const Ev=new Set(["table","td","th"]);function zv(e){return Ev.has(Sv(e))}const Pv=[":popover-open",":modal"];function Rv(e){return Pv.some(t=>{try{return e.matches(t)}catch(n){return!1}})}const $v=["transform","translate","scale","rotate","perspective"],Ov=["transform","translate","scale","rotate","perspective","filter"],Lv=["paint","layout","strict","content"];function Nv(e){const t=Fv(),n=Iv(e)?Uv(e):e;return $v.some(e=>!!n[e]&&"none"!==n[e])||!!n.containerType&&"normal"!==n.containerType||!t&&!!n.backdropFilter&&"none"!==n.backdropFilter||!t&&!!n.filter&&"none"!==n.filter||Ov.some(e=>(n.willChange||"").includes(e))||Lv.some(e=>(n.contain||"").includes(e))}function Fv(){return!("undefined"==typeof CSS||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}const Bv=new Set(["html","body","#document"]);function jv(e){return Bv.has(Sv(e))}function Uv(e){return xv(e).getComputedStyle(e)}function Vv(e){return Iv(e)?{scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}:{scrollLeft:e.scrollX,scrollTop:e.scrollY}}function qv(e){if("html"===Sv(e))return e;const t=e.assignedSlot||e.parentNode||Tv(e)&&e.host||_v(e);return Tv(t)?t.host:t}function Hv(e){const t=qv(e);return jv(t)?e.ownerDocument?e.ownerDocument.body:e.body:Dv(t)&&Av(t)?t:Hv(t)}function Wv(e,t,n){var i;void 0===t&&(t=[]);const a=Hv(e),r=a===(null==(i=e.ownerDocument)?void 0:i.body),s=xv(a);return r?(Gv(s),t.concat(s,s.visualViewport||[],Av(a)?a:[],[])):t.concat(a,Wv(a,[]))}function Gv(e){return e.parent&&Object.getPrototypeOf(e.parent)?e.frameElement:null}function Qv(e){const t=Uv(e);let n=parseFloat(t.width)||0,i=parseFloat(t.height)||0;const a=Dv(e),r=a?e.offsetWidth:n,s=a?e.offsetHeight:i,o=Yg(n)!==r||Yg(i)!==s;return o&&(n=r,i=s),{width:n,height:i,$:o}}function Kv(e){return Iv(e)?e:e.contextElement}function Zv(e){const t=Kv(e);if(!Dv(t))return Xg(1);const n=t.getBoundingClientRect(),{width:i,height:a,$:r}=Qv(t);let s=(r?Yg(n.width):n.width)/i,o=(r?Yg(n.height):n.height)/a;return s&&Number.isFinite(s)||(s=1),o&&Number.isFinite(o)||(o=1),{x:s,y:o}}const Yv=Xg(0);function Xv(e){const t=xv(e);return Fv()&&t.visualViewport?{x:t.visualViewport.offsetLeft,y:t.visualViewport.offsetTop}:Yv}function Jv(e,t,n,i){void 0===t&&(t=!1),void 0===n&&(n=!1);const a=e.getBoundingClientRect(),r=Kv(e);let s=Xg(1);t&&(i?Iv(i)&&(s=Zv(i)):s=Zv(e));const o=function(e,t,n){return void 0===t&&(t=!1),!(!n||t&&n!==xv(e))&&t}(r,n,i)?Xv(r):Xg(0);let l=(a.left+o.x)/s.x,c=(a.top+o.y)/s.y,d=a.width/s.x,u=a.height/s.y;if(r){const e=xv(r),t=i&&Iv(i)?xv(i):i;let n=e,a=Gv(n);for(;a&&i&&t!==n;){const e=Zv(a),t=a.getBoundingClientRect(),i=Uv(a),r=t.left+(a.clientLeft+parseFloat(i.paddingLeft))*e.x,s=t.top+(a.clientTop+parseFloat(i.paddingTop))*e.y;l*=e.x,c*=e.y,d*=e.x,u*=e.y,l+=r,c+=s,n=xv(a),a=Gv(n)}}return mv({width:d,height:u,x:l,y:c})}function ef(e,t){const n=Vv(e).scrollLeft;return t?t.left+n:Jv(_v(e)).left+n}function tf(e,t){const n=e.getBoundingClientRect();return{x:n.left+t.scrollLeft-ef(e,n),y:n.top+t.scrollTop}}const nf=new Set(["absolute","fixed"]);function af(e,t,n){let i;if("viewport"===t)i=function(e,t){const n=xv(e),i=_v(e),a=n.visualViewport;let r=i.clientWidth,s=i.clientHeight,o=0,l=0;if(a){r=a.width,s=a.height;const e=Fv();(!e||e&&"fixed"===t)&&(o=a.offsetLeft,l=a.offsetTop)}const c=ef(i);if(c<=0){const e=i.ownerDocument,t=e.body,n=getComputedStyle(t),a="CSS1Compat"===e.compatMode&&parseFloat(n.marginLeft)+parseFloat(n.marginRight)||0,s=Math.abs(i.clientWidth-t.clientWidth-a);s<=25&&(r-=s)}else c<=25&&(r+=c);return{width:r,height:s,x:o,y:l}}(e,n);else if("document"===t)i=function(e){const t=_v(e),n=Vv(e),i=e.ownerDocument.body,a=Zg(t.scrollWidth,t.clientWidth,i.scrollWidth,i.clientWidth),r=Zg(t.scrollHeight,t.clientHeight,i.scrollHeight,i.clientHeight);let s=-n.scrollLeft+ef(e);const o=-n.scrollTop;return"rtl"===Uv(i).direction&&(s+=Zg(t.clientWidth,i.clientWidth)-a),{width:a,height:r,x:s,y:o}}(_v(e));else if(Iv(t))i=function(e,t){const n=Jv(e,!0,"fixed"===t),i=n.top+e.clientTop,a=n.left+e.clientLeft,r=Dv(e)?Zv(e):Xg(1);return{width:e.clientWidth*r.x,height:e.clientHeight*r.y,x:a*r.x,y:i*r.y}}(t,n);else{const n=Xv(e);i={x:t.x-n.x,y:t.y-n.y,width:t.width,height:t.height}}return mv(i)}function rf(e,t){const n=qv(e);return!(n===t||!Iv(n)||jv(n))&&("fixed"===Uv(n).position||rf(n,t))}function sf(e,t,n){const i=Dv(t),a=_v(t),r="fixed"===n,s=Jv(e,!0,r,t);let o={scrollLeft:0,scrollTop:0};const l=Xg(0);function c(){l.x=ef(a)}if(i||!i&&!r)if(("body"!==Sv(t)||Av(a))&&(o=Vv(t)),i){const e=Jv(t,!0,r,t);l.x=e.x+t.clientLeft,l.y=e.y+t.clientTop}else a&&c();r&&!i&&a&&c();const d=!a||i||r?Xg(0):tf(a,o);return{x:s.left+o.scrollLeft-l.x-d.x,y:s.top+o.scrollTop-l.y-d.y,width:s.width,height:s.height}}function of(e){return"static"===Uv(e).position}function lf(e,t){if(!Dv(e)||"fixed"===Uv(e).position)return null;if(t)return t(e);let n=e.offsetParent;return _v(e)===n&&(n=n.ownerDocument.body),n}function cf(e,t){const n=xv(e);if(Rv(e))return n;if(!Dv(e)){let t=qv(e);for(;t&&!jv(t);){if(Iv(t)&&!of(t))return t;t=qv(t)}return n}let i=lf(e,t);for(;i&&zv(i)&&of(i);)i=lf(i,t);return i&&jv(i)&&of(i)&&!Nv(i)?n:i||function(e){let t=qv(e);for(;Dv(t)&&!jv(t);){if(Nv(t))return t;if(Rv(t))return null;t=qv(t)}return null}(e)||n}const df={convertOffsetParentRelativeRectToViewportRelativeRect:function(e){let{elements:t,rect:n,offsetParent:i,strategy:a}=e;const r="fixed"===a,s=_v(i),o=!!t&&Rv(t.floating);if(i===s||o&&r)return n;let l={scrollLeft:0,scrollTop:0},c=Xg(1);const d=Xg(0),u=Dv(i);if((u||!u&&!r)&&(("body"!==Sv(i)||Av(s))&&(l=Vv(i)),Dv(i))){const e=Jv(i);c=Zv(i),d.x=e.x+i.clientLeft,d.y=e.y+i.clientTop}const h=!s||u||r?Xg(0):tf(s,l);return{width:n.width*c.x,height:n.height*c.y,x:n.x*c.x-l.scrollLeft*c.x+d.x+h.x,y:n.y*c.y-l.scrollTop*c.y+d.y+h.y}},getDocumentElement:_v,getClippingRect:function(e){let{element:t,boundary:n,rootBoundary:i,strategy:a}=e;const r=[..."clippingAncestors"===n?Rv(t)?[]:function(e,t){const n=t.get(e);if(n)return n;let i=Wv(e,[]).filter(e=>Iv(e)&&"body"!==Sv(e)),a=null;const r="fixed"===Uv(e).position;let s=r?qv(e):e;for(;Iv(s)&&!jv(s);){const t=Uv(s),n=Nv(s);n||"fixed"!==t.position||(a=null),(r?!n&&!a:!n&&"static"===t.position&&a&&nf.has(a.position)||Av(s)&&!n&&rf(e,s))?i=i.filter(e=>e!==s):a=t,s=qv(s)}return t.set(e,i),i}(t,this._c):[].concat(n),i],s=r[0],o=r.reduce((e,n)=>{const i=af(t,n,a);return e.top=Zg(i.top,e.top),e.right=Kg(i.right,e.right),e.bottom=Kg(i.bottom,e.bottom),e.left=Zg(i.left,e.left),e},af(t,s,a));return{width:o.right-o.left,height:o.bottom-o.top,x:o.left,y:o.top}},getOffsetParent:cf,getElementRects:async function(e){const t=this.getOffsetParent||cf,n=this.getDimensions,i=await n(e.floating);return{reference:sf(e.reference,await t(e.floating),e.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}},getClientRects:function(e){return Array.from(e.getClientRects())},getDimensions:function(e){const{width:t,height:n}=Qv(e);return{width:t,height:n}},getScale:Zv,isElement:Iv,isRTL:function(e){return"rtl"===Uv(e).direction}},uf=function(e){return void 0===e&&(e=0),{name:"offset",options:e,async fn(t){var n,i;const{x:a,y:r,placement:s,middlewareData:o}=t,l=await async function(e,t){const{placement:n,platform:i,elements:a}=e,r=await(null==i.isRTL?void 0:i.isRTL(a.floating)),s=iv(n),o=av(n),l="y"===lv(n),c=wv.has(s)?-1:1,d=r&&l?-1:1,u=nv(t,e);let{mainAxis:h,crossAxis:p,alignmentAxis:g}="number"==typeof u?{mainAxis:u,crossAxis:0,alignmentAxis:null}:{mainAxis:u.mainAxis||0,crossAxis:u.crossAxis||0,alignmentAxis:u.alignmentAxis};return o&&"number"==typeof g&&(p="end"===o?-1*g:g),l?{x:p*d,y:h*c}:{x:h*c,y:p*d}}(t,e);return s===(null==(n=o.offset)?void 0:n.placement)&&null!=(i=o.arrow)&&i.alignmentOffset?{}:{x:a+l.x,y:r+l.y,data:{...l,placement:s}}}}},hf=function(e){return void 0===e&&(e={}),{name:"shift",options:e,async fn(t){const{x:n,y:i,placement:a}=t,{mainAxis:r=!0,crossAxis:s=!1,limiter:o={fn:e=>{let{x:t,y:n}=e;return{x:t,y:n}}},...l}=nv(e,t),c={x:n,y:i},d=await bv(t,l),u=lv(iv(a)),h=rv(u);let p=c[h],g=c[u];if(r){const e="y"===h?"bottom":"right";p=tv(p+d["y"===h?"top":"left"],p,p-d[e])}if(s){const e="y"===u?"bottom":"right";g=tv(g+d["y"===u?"top":"left"],g,g-d[e])}const v=o.fn({...t,[h]:p,[u]:g});return{...v,data:{x:v.x-n,y:v.y-i,enabled:{[h]:r,[u]:s}}}}}},pf=function(e){return void 0===e&&(e={}),{name:"flip",options:e,async fn(t){var n,i;const{placement:a,middlewareData:r,rects:s,initialPlacement:o,platform:l,elements:c}=t,{mainAxis:d=!0,crossAxis:u=!0,fallbackPlacements:h,fallbackStrategy:p="bestFit",fallbackAxisSideDirection:g="none",flipAlignment:v=!0,...f}=nv(e,t);if(null!=(n=r.arrow)&&n.alignmentOffset)return{};const m=iv(a),y=lv(o),b=iv(o)===o,w=await(null==l.isRTL?void 0:l.isRTL(c.floating)),k=h||(b||!v?[fv(o)]:function(e){const t=fv(e);return[dv(e),t,dv(t)]}(o)),S="none"!==g;!h&&S&&k.push(...vv(o,v,g,w));const x=[o,...k],_=await bv(t,f),C=[];let I=(null==(i=r.flip)?void 0:i.overflows)||[];if(d&&C.push(_[m]),u){const e=function(e,t,n){void 0===n&&(n=!1);const i=av(e),a=cv(e),r=sv(a);let s="x"===a?i===(n?"end":"start")?"right":"left":"start"===i?"bottom":"top";return t.reference[r]>t.floating[r]&&(s=fv(s)),[s,fv(s)]}(a,s,w);C.push(_[e[0]],_[e[1]])}if(I=[...I,{placement:a,overflows:C}],!C.every(e=>e<=0)){var D,T;const e=((null==(D=r.flip)?void 0:D.index)||0)+1,t=x[e];if(t){if(!("alignment"===u&&y!==lv(t))||I.every(e=>lv(e.placement)!==y||e.overflows[0]>0))return{data:{index:e,overflows:I},reset:{placement:t}}}let n=null==(T=I.filter(e=>e.overflows[0]<=0).sort((e,t)=>e.overflows[1]-t.overflows[1])[0])?void 0:T.placement;if(!n)switch(p){case"bestFit":{var M;const e=null==(M=I.filter(e=>{if(S){const t=lv(e.placement);return t===y||"y"===t}return!0}).map(e=>[e.placement,e.overflows.filter(e=>e>0).reduce((e,t)=>e+t,0)]).sort((e,t)=>e[1]-t[1])[0])?void 0:M[0];e&&(n=e);break}case"initialPlacement":n=o}if(a!==n)return{reset:{placement:n}}}return{}}}},gf=(e,t,n)=>{const i=new Map,a={platform:df,...n},r={...a.platform,_c:i};return(async(e,t,n)=>{const{placement:i="bottom",strategy:a="absolute",middleware:r=[],platform:s}=n,o=r.filter(Boolean),l=await(null==s.isRTL?void 0:s.isRTL(t));let c=await s.getElementRects({reference:e,floating:t,strategy:a}),{x:d,y:u}=yv(c,i,l),h=i,p={},g=0;for(let v=0;v<o.length;v++){const{name:n,fn:r}=o[v],{x:f,y:m,data:y,reset:b}=await r({x:d,y:u,initialPlacement:i,placement:h,strategy:a,middlewareData:p,rects:c,platform:s,elements:{reference:e,floating:t}});d=null!=f?f:d,u=null!=m?m:u,p={...p,[n]:{...p[n],...y}},b&&g<=50&&(g++,"object"==typeof b&&(b.placement&&(h=b.placement),b.rects&&(c=!0===b.rects?await s.getElementRects({reference:e,floating:t,strategy:a}):b.rects),({x:d,y:u}=yv(c,h,l))),v=-1)}return{x:d,y:u,placement:h,strategy:a,middlewareData:p}})(e,t,{...a,platform:r})};var vf=la('<div role="menu"><!></div>');function ff(e,t){if(new.target)return Er({component:ff,...e});kt(t,!0);let n=Ar(t,"show",15),i=Ar(t,"anchor",7),a=Ar(t,"placement",7,"right-start"),r=Ar(t,"offset",7,8),s=Ar(t,"onClose",7),o=Ar(t,"class",7,""),l=Ar(t,"children",7),c=Pn(null),d=Pn(Ot({top:0,left:0}));async function u(){if(n()&&i()&&bi(c))try{const{x:e,y:t}=await gf(i(),bi(c),{placement:a(),middleware:[uf(r()),pf({fallbackPlacements:["left-start","bottom-start","top-start","right-end","left-end"]}),hf({padding:8})]});$n(d,{top:t,left:e},!0)}catch(e){_e.error("[FloatingMenu] 定位计算失败:",e)}}function h(e){var t,a;if(!n()||!bi(c))return;const r=e.target;bi(c).contains(r)||(null==(t=i())?void 0:t.contains(r))||null==(a=s())||a()}function p(e){var t;"Escape"===e.key&&n()&&(e.preventDefault(),null==(t=s())||t())}Ti(()=>{if(n()&&i())return requestAnimationFrame(()=>{u(),requestAnimationFrame(()=>{u()})}),window.addEventListener("resize",u),window.addEventListener("scroll",u,!0),()=>{window.removeEventListener("resize",u),window.removeEventListener("scroll",u,!0)}}),Pr(()=>{document.addEventListener("mousedown",h),document.addEventListener("keydown",p)}),Rr(()=>{document.removeEventListener("mousedown",h),document.removeEventListener("keydown",p)});var g={get show(){return n()},set show(e){n(e),hn()},get anchor(){return i()},set anchor(e){i(e),hn()},get placement(){return a()},set placement(e="right-start"){a(e),hn()},get offset(){return r()},set offset(e=8){r(e),hn()},get onClose(){return s()},set onClose(e){s(e),hn()},get class(){return o()},set class(e=""){o(e),hn()},get children(){return l()},set children(e){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},v=ha(),f=Qt(v),m=e=>{var t=vf();Ea(Gt(t),()=>{var e;return null!=(e=l())?e:je}),zt(t),kr(t,e=>$n(c,e),()=>bi(c)),zi(()=>{var e,i,a;Fa(t,1,`floating-menu ${null!=(e=o())?e:""}`,"svelte-yekky"),ja(t,`top: ${null!=(i=bi(d).top)?i:""}px; left: ${null!=(a=bi(d).left)?a:""}px;`),er(t,"aria-hidden",!n())}),pa(e,t)};return xa(f,e=>{n()&&e(m)}),pa(e,v),St(g)}function mf(e,t){if("Enter"===e.key||" "===e.key){e.preventDefault();const n=e.currentTarget.getBoundingClientRect();t(new MouseEvent("mousedown",{clientX:n.left,clientY:n.top,button:0}))}}var yf=la('<div class="tuanki-column-resizer svelte-1lvyn0d" aria-label="调整列宽度" tabindex="0" role="button"></div>');function bf(e,t){if(new.target)return Er({component:bf,...e});kt(t,!0);let n=Ar(t,"columnKey",7),i=Ar(t,"onResize",7),a=Pn(!1),r=Pn(0);function s(e){e.preventDefault(),e.stopPropagation(),$n(a,!0),$n(r,e.clientX,!0),document.addEventListener("mousemove",o),document.addEventListener("mouseup",l),document.body.classList.add("resizing-column")}function o(e){if(!bi(a))return;const t=e.clientX-bi(r);i()(n(),t),$n(r,e.clientX,!0)}function l(){bi(a)&&($n(a,!1),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",l),document.body.classList.remove("resizing-column"))}var c={get columnKey(){return n()},set columnKey(e){n(e),hn()},get onResize(){return i()},set onResize(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},d=yf();return d.__mousedown=s,d.__keydown=[mf,s],pa(e,d),St(c)}function wf(e,t){const n=e.target;t()(n.checked)}ia(["mousedown","keydown"]);var kf=la('<label class="tuanki-checkbox-label svelte-5x9bog"><input type="checkbox" aria-label="选择" class="svelte-5x9bog"/> <span class="tuanki-checkbox-custom svelte-5x9bog"></span></label>');function Sf(e,t){if(new.target)return Er({component:Sf,...e});kt(t,!0);let n=Ar(t,"checked",7),i=Ar(t,"indeterminate",7,!1),a=Ar(t,"onchange",7);var r={get checked(){return n()},set checked(e){n(e),hn()},get indeterminate(){return i()},set indeterminate(e=!1){i(e),hn()},get onchange(){return a()},set onchange(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=kf(),o=Gt(s);return Za(o),o.__change=[wf,a],Pt(2),zt(s),zi(()=>{Xa(o,n()),o.indeterminate=i()}),pa(e,s),St(r)}ia(["change"]);const xf=[{id:"official-qa",name:"问答题",description:"标准的问答题模板，支持二级标题和正反面分离",type:"single-field",fields:[{name:"Front",pattern:"^(?:##\\s*(.+?)(?=\\n|---div---|$)|(.+?)(?=---div---|$))",isRegex:!0,flags:"ms",required:!0},{name:"Back",pattern:"(?<=---div---)(.+)$",isRegex:!0,flags:"ms",required:!1},{name:"Tags",pattern:"#([\\w\\u4e00-\\u9fa5]+)",isRegex:!0,flags:"g",required:!1}],scenarios:["newCard","study","edit"],isDefault:!0,isOfficial:!0},{id:"official-choice",name:"选择题",description:"选择题模板，支持中英文，输出结构化字段",type:"single-field",fields:[{name:"question",pattern:"^##\\s*(.+?)(?=\\n|$)",isRegex:!0,flags:"m",required:!0},{name:"options",pattern:"^(?:[A-E][\\.|\\)]\\s.*(?:\\n|$))+",isRegex:!0,flags:"m",required:!0},{name:"correct_answer",pattern:"^(?:(?:正确答案|答案|Correct Answer|Answer)[:：]\\s*([A-E]))",isRegex:!0,flags:"mi",required:!0},{name:"explanation",pattern:"(?:解析|Explanation)[:：]\\s*(.+?)(?=\\n|$)",isRegex:!0,flags:"mi",required:!1},{name:"tags",pattern:"#([\\w\\u4e00-\\u9fa5/_-]+)",isRegex:!0,flags:"g",required:!1}],scenarios:["newCard","study","edit"],isDefault:!0,isOfficial:!0},{id:"official-cloze",name:"填空题",description:"挖空题模板，支持 Obsidian 高亮和 Anki 语法",type:"single-field",fields:[{name:"Text",pattern:"^(.+?)(?=---div---|$)",isRegex:!0,flags:"ms",required:!0},{name:"Cloze",pattern:"==(.+?)==",isRegex:!0,flags:"g",required:!0},{name:"ClozeAnki",pattern:"\\{\\{c\\d+::(.+?)\\}\\}",isRegex:!0,flags:"g",required:!1},{name:"Extra",pattern:"(?<=---div---)(.+)$",isRegex:!0,flags:"ms",required:!1},{name:"Tags",pattern:"#([\\w\\u4e00-\\u9fa5]+)",isRegex:!0,flags:"g",required:!1}],scenarios:["newCard","study","edit"],isDefault:!0,isOfficial:!0}].filter(e=>e.isOfficial);function _f(e,t=[],n){var i,a,r,s;if(!e)return{name:"未设置",icon:Dg,class:"tuanki-template-unknown"};const o=xf.find(t=>t.id===e);if(o)return{name:o.name,icon:Ag,class:"tuanki-template-official"};const l=null==(r=null==(a=null==(i=null==n?void 0:n.settings)?void 0:i.simplifiedParsing)?void 0:a.templates)?void 0:r.find(t=>t.id===e);if(l){const e="anki_imported"===(null==(s=l.tuankiMetadata)?void 0:s.source);return{name:l.name,icon:e?Tg:zg,class:"tuanki-template-custom"}}const c=t.find(t=>t.id===e);if(c)return{name:c.name,icon:c.isOfficial?Ag:zg,class:c.isOfficial?"tuanki-template-official":"tuanki-template-custom"};return{name:e.replace(/^(official-|anki-imported-|custom-)/,"").replace(/[-_]/g," ").replace(/\b\w/g,e=>e.toUpperCase()),icon:Mg,class:"tuanki-template-missing"}}function Cf(e){switch(e){case"存在":return{text:"存在",icon:bg,class:"tuanki-status-exists",tooltip:"源文档存在，支持双向同步"};case"已删除":return{text:"已删除",icon:fg,class:"tuanki-status-deleted",tooltip:"源文档已删除，不支持双向同步"};case"无源文档":return{text:"无源文档",icon:Dg,class:"tuanki-status-none",tooltip:"卡片没有关联的源文档"};default:return{text:"未知",icon:Dg,class:"tuanki-status-unknown",tooltip:"源文档状态未知"}}}function If(e,t=50){return e?e.length<=t?e:`${e.substring(0,t)}...`:""}const Df={front:"正面",back:"背面",status:"状态",deck:"牌组",tags:"标签",priority:"优先级",created:"创建时间",modified:"修改时间",next_review:"下次复习",retention:"记忆率",interval:"间隔",difficulty:"难度",review_count:"复习次数",uuid:"UUID",obsidian_block_link:"块引用",source_document:"源文档",field_template:"模板",source_document_status:"源状态",actions:"操作",question_type:"题型",accuracy:"正确率",test_attempts:"答题次数",last_test:"最后测试",error_level:"错题等级",source_card:"关联记忆卡片"},Tf={front:"Front",back:"Back",status:"Status",deck:"Deck",tags:"Tags",priority:"Priority",created:"Created",modified:"Modified",next_review:"Next Review",retention:"Retention",interval:"Interval",difficulty:"Difficulty",review_count:"Reviews",uuid:"UUID",obsidian_block_link:"Block Link",source_document:"Source",field_template:"Template",source_document_status:"Source Status",actions:"Actions",question_type:"Question Type",accuracy:"Accuracy",test_attempts:"Attempts",last_test:"Last Test",error_level:"Error Level",source_card:"Source Card"},Mf={front:"卡片正面内容",back:"卡片背面内容",status:"卡片学习状态",deck:"所属牌组",tags:"卡片标签",priority:"优先级（1-4星）",created:"创建时间",modified:"卡片最后修改时间",next_review:"下次复习的预计时间",retention:"当前的记忆保持率",interval:"当前复习间隔",difficulty:"卡片难度系数",review_count:"已复习次数",uuid:"唯一标识符",obsidian_block_link:"Obsidian块引用",source_document:"源文档路径",field_template:"字段模板",source_document_status:"源文档状态",actions:"操作",question_type:"题目类型（单选、多选、填空、问答）",accuracy:"答题正确率",test_attempts:"测试答题次数",last_test:"最近一次测试时间",error_level:"错题严重程度",source_card:"生成该题目的源记忆卡片"},Af={front:"Card front content",back:"Card back content",status:"Card learning status",deck:"Deck name",tags:"Card tags",priority:"Priority (1-4 stars)",created:"Creation date",modified:"Last modified date",next_review:"Next scheduled review time",retention:"Current memory retention rate",interval:"Current review interval",difficulty:"Card difficulty factor",review_count:"Number of reviews",uuid:"Unique identifier",obsidian_block_link:"Obsidian block link",source_document:"Source document path",field_template:"Field template",source_document_status:"Source document status",actions:"Actions",question_type:"Question type (single choice, multiple choice, cloze, short answer)",accuracy:"Test accuracy rate",test_attempts:"Number of test attempts",last_test:"Last test time",error_level:"Error severity level",source_card:"Source memory card that generated this question"},Ef=new Set(["front","back","status","deck","tags","priority","created","modified","next_review","retention","interval","difficulty","review_count","uuid","obsidian_block_link","source_document","field_template","source_document_status","question_type","accuracy","test_attempts","last_test","error_level","source_card"]);function zf(e,t="zh"){return("zh"===t?Df:Tf)[e]||e}function Pf(e,t="zh"){return("zh"===t?Mf:Af)[e]||""}var Rf=la('<th class="tuanki-actions-column tuanki-resizable-column svelte-44hi7k"><span class="tuanki-column-text svelte-44hi7k"> </span> <!></th>'),$f=(e,t,n,i)=>{t()||n()(i)},Of=(e,t,n,i)=>{t()||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n()(i))},Lf=la('<th role="button"><div class="tuanki-column-header svelte-44hi7k"><span class="tuanki-column-text svelte-44hi7k"> </span> <span class="tuanki-sort-icon svelte-44hi7k" aria-hidden="true"><!></span></div> <!></th>'),Nf=la('<th class="tuanki-resizable-column svelte-44hi7k"><span class="tuanki-column-text svelte-44hi7k"> </span> <!></th>'),Ff=la('<thead class="tuanki-table-header svelte-44hi7k"><tr><th class="tuanki-checkbox-column tuanki-resizable-column svelte-44hi7k"><!> <!></th><!></tr></thead>');function Bf(e,t){if(new.target)return Er({component:Bf,...e});kt(t,!0);let n=Ar(t,"columnVisibility",7),i=Ar(t,"columnOrder",7),a=Ar(t,"tableViewMode",7,"basic"),r=Ar(t,"sortConfig",7),s=Ar(t,"selectedCards",7),o=Ar(t,"totalCards",7),l=Ar(t,"columnWidths",7),c=Ar(t,"onSelectAll",7),d=Ar(t,"onSort",7),u=Ar(t,"isSorting",7,!1),h=Ar(t,"onColumnResize",7);const p=In(()=>{return e=s().size,(t=o())>0&&e===t;var e,t}),g=In(()=>{return e=s().size,t=o(),e>0&&e<t;var e,t}),v=In(()=>{if("undefined"==typeof window)return"zh";try{return"en"===(localStorage.getItem("tuanki-language")||"zh")?"en":"zh"}catch(e){return"zh"}});var f={get columnVisibility(){return n()},set columnVisibility(e){n(e),hn()},get columnOrder(){return i()},set columnOrder(e){i(e),hn()},get tableViewMode(){return a()},set tableViewMode(e="basic"){a(e),hn()},get sortConfig(){return r()},set sortConfig(e){r(e),hn()},get selectedCards(){return s()},set selectedCards(e){s(e),hn()},get totalCards(){return o()},set totalCards(e){o(e),hn()},get columnWidths(){return l()},set columnWidths(e){l(e),hn()},get onSelectAll(){return c()},set onSelectAll(e){c(e),hn()},get onSort(){return d()},set onSort(e){d(e),hn()},get isSorting(){return u()},set isSorting(e=!1){u(e),hn()},get onColumnResize(){return h()},set onColumnResize(e){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},m=Ff(),y=Gt(m),b=Gt(y),w=Gt(b);{let e=In(()=>"zh"===bi(v)?"全选":"Select all");Sf(w,{get checked(){return bi(p)},get indeterminate(){return bi(g)},get onchange(){return c()},get ariaLabel(){return bi(e)}})}return bf(Kt(w,2),{columnKey:"checkbox",get onResize(){return h()}}),zt(b),Ca(Kt(b),16,i,e=>e,(e,t)=>{var n=ha(),i=Qt(n),s=e=>{var n=Rf(),i=Gt(n),a=Gt(i,!0);zt(i),bf(Kt(i,2),{get columnKey(){return t},get onResize(){return h()}}),zt(n),zi((e,i)=>{var r;ja(n,`width: ${null!=(r=l()[t])?r:""}px;`),er(n,"title",e),va(a,i)},[()=>Pf(t,bi(v)),()=>zf(t,bi(v))]),pa(e,n)},o=e=>{var n=ha(),i=Qt(n),s=e=>{var n=Lf();let i;n.__click=[$f,u,d,t],n.__keydown=[Of,u,d,t];var s=Gt(n),o=Gt(s),c=Gt(o,!0);zt(o);var p=Kt(o,2),g=Gt(p);{let e=In(()=>{return e=t,n=r().field,i=r().direction,e!==n?"sort":"asc"===i?"sort-up":"sort-down";var e,n,i}),n=In(()=>t===r().field?"primary":"muted");Ng(g,{get name(){return bi(e)},size:12,get variant(){return bi(n)}})}zt(p),zt(s),bf(Kt(s,2),{get columnKey(){return t},get onResize(){return h()}}),zt(n),zi((e,a,r,s,o)=>{var d;i=Fa(n,1,`tuanki-sortable-column tuanki-resizable-column ${null!=e?e:""}`,"svelte-44hi7k",i,a),ja(n,`width: ${null!=(d=l()[t])?d:""}px;`),er(n,"tabindex",u()?-1:0),er(n,"aria-label",r),er(n,"aria-disabled",u()),er(n,"title",s),va(c,o)},[()=>function(e,t="basic"){const n={basic:{core:["front","back"],basic:["status","deck","tags","priority","created","modified"],source:["source_document","obsidian_block_link"]},review:{core:["front","back"],review:["status","next_review","retention","interval","difficulty","review_count"]},questionBank:{core:["front","back"],basic:["deck","tags","priority"],test:["question_type","accuracy","test_attempts","last_test","error_level","source_card"],meta:["created"]}}[t];if(!n)return"";for(const[i,a]of Object.entries(n))if(a.includes(e))return`group-${i}${a[a.length-1]===e?" group-end":""}`;return""}(t,a()),()=>({"sorting-disabled":u()}),()=>function(e,t,n,i="zh"){return e!==t?"zh"===i?"点击排序":"Click to sort":"asc"===n?"zh"===i?"升序排列,点击改为降序":"Sorted ascending, click for descending":"zh"===i?"降序排列，点击改为升序":"Sorted descending, click for ascending"}(t,r().field,r().direction,bi(v)),()=>u()?"排序进行中，请稍候...":Pf(t,bi(v)),()=>zf(t,bi(v))]),pa(e,n)},o=e=>{var n=Nf(),i=Gt(n),a=Gt(i,!0);zt(i),bf(Kt(i,2),{get columnKey(){return t},get onResize(){return h()}}),zt(n),zi((e,i)=>{var r;ja(n,`width: ${null!=(r=l()[t])?r:""}px;`),er(n,"title",e),va(a,i)},[()=>Pf(t,bi(v)),()=>zf(t,bi(v))]),pa(e,n)};xa(i,e=>{!function(e){return Ef.has(e)}(t)?e(o,!1):e(s)},!0),pa(e,n)};xa(i,e=>{"actions"===t?e(s):e(o,!1)}),pa(e,n)}),zt(y),zt(m),zi(()=>{var e;ja(b,`width: ${null!=(e=l().checkbox)?e:""}px;`),er(b,"title","zh"===bi(v)?"全选":"Select all")}),pa(e,m),St(f)}ia(["click","keydown"]);var jf=la('<span class="status-badge svelte-bnpjys"> </span>');function Uf(e,t){if(new.target)return Er({component:Uf,...e});kt(t,!0);let n=Ar(t,"state",7);const i={[Gr.New]:{text:"新卡片",color:"var(--color-gray)"},[Gr.Learning]:{text:"学习中",color:"var(--color-blue)"},[Gr.Review]:{text:"复习",color:"var(--color-green)"},[Gr.Relearning]:{text:"重新学习",color:"var(--color-yellow)"}};let a=In(()=>i[n()]||{text:"未知",color:"var(--color-gray)"});var r={get state(){return n()},set state(e){n(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=jf(),o=Gt(s,!0);return zt(s),zi(()=>{var e;ja(s,`--status-color: ${null!=(e=bi(a).color)?e:""}`),va(o,bi(a).text)}),pa(e,s),St(r)}var Vf=la('<div role="gridcell"><!></div>');function qf(e,t){if(new.target)return Er({component:qf,...e});kt(t,!0);let n=Ar(t,"checked",7),i=Ar(t,"indeterminate",7,!1),a=Ar(t,"onchange",7),r=Ar(t,"ariaLabel",7,"选择"),s=Ar(t,"cardId",7),o=Ar(t,"onDragSelectStart",7),l=Ar(t,"onDragSelectMove",7),c=Ar(t,"isDragSelectActive",7,!1),d=Pn(!1),u=null,h=Pn(!1);Ti(()=>{bi(d)&&o()&&(o()(s()),document.body.style.userSelect="none",$n(d,!1))}),Ti(()=>{c()||(document.body.style.userSelect="")});var p={get checked(){return n()},set checked(e){n(e),hn()},get indeterminate(){return i()},set indeterminate(e=!1){i(e),hn()},get onchange(){return a()},set onchange(e){a(e),hn()},get ariaLabel(){return r()},set ariaLabel(e="选择"){r(e),hn()},get cardId(){return s()},set cardId(e){s(e),hn()},get onDragSelectStart(){return o()},set onDragSelectStart(e){o(e),hn()},get onDragSelectMove(){return l()},set onDragSelectMove(e){l(e),hn()},get isDragSelectActive(){return c()},set isDragSelectActive(e=!1){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},g=Vf();let v;return g.__mousedown=function(e){0===e.button&&($n(h,!0),u=setTimeout(()=>{bi(h)&&$n(d,!0)},500))},g.__mouseup=function(e){u&&(clearTimeout(u),u=null),c()&&(e.preventDefault(),e.stopPropagation()),$n(h,!1),$n(d,!1)},Sf(Gt(g),{get checked(){return n()},get indeterminate(){return i()},get onchange(){return a()}}),zt(g),zi(e=>{v=Fa(g,1,"draggable-checkbox-wrapper svelte-193sviq",null,v,e),er(g,"aria-label",r())},[()=>({"drag-select-mode":c(),"long-pressing":bi(d)})]),na("mouseenter",g,function(){c()&&l()&&l()(s())}),na("mouseleave",g,function(){u&&!c()&&(clearTimeout(u),u=null,$n(h,!1))}),na("selectstart",g,function(e){c()&&e.preventDefault()}),pa(e,g),St(p)}function Hf(e,t,n,i,a,r){"Enter"===e.key?(e.preventDefault(),bi(t).trim()?n(bi(t)):i()):","===e.key?(e.preventDefault(),n(bi(t))):"Escape"===e.key?(e.preventDefault(),a()):"Backspace"===e.key&&""===bi(t)&&bi(r).length>0&&(e.preventDefault(),$n(r,bi(r).slice(0,-1),!0))}ia(["mousedown","mouseup"]);var Wf=e=>e.stopPropagation(),Gf=(e,t,n)=>t(bi(n)),Qf=la('<span class="tag-chip svelte-rnwfvk"><span class="tag-text svelte-rnwfvk"> </span> <button type="button" class="tag-chip-remove svelte-rnwfvk" aria-label="移除标签">×</button></span>'),Kf=la('<div class="selected-tags svelte-rnwfvk"></div>'),Zf=(e,t,n)=>t(bi(n)),Yf=la('<button type="button"> </button>'),Xf=la('<div class="available-tags svelte-rnwfvk"><div class="available-tags-title svelte-rnwfvk">可选标签（点击添加/移除）</div> <div class="available-tags-list svelte-rnwfvk"></div></div>'),Jf=la('<div class="tuanki-tags-editor svelte-rnwfvk"><div class="tag-input-wrapper svelte-rnwfvk"><!> <input class="tag-input svelte-rnwfvk"/></div> <!> <div class="tag-editor-actions svelte-rnwfvk"><button type="button" class="tag-btn tag-btn-cancel svelte-rnwfvk">取消</button> <button type="button" class="tag-btn tag-btn-save svelte-rnwfvk">保存</button></div></div>'),em=(e,t)=>"Enter"===e.key&&t(),tm=la("<span> </span>"),nm=la('<span class="tuanki-tags-more svelte-rnwfvk"> </span>'),im=la("<!> <!>",1),am=la('<span class="tuanki-text-muted tuanki-tags-placeholder svelte-rnwfvk">点击添加标签</span>'),rm=la('<button class="tuanki-tags-container svelte-rnwfvk" aria-label="编辑标签" type="button"><!> <div class="tuanki-tags-edit-hint svelte-rnwfvk"><!></div></button>'),sm=la('<td class="tuanki-tags-column svelte-rnwfvk"><!></td>');function om(e,t){if(new.target)return Er({component:om,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"onTagsUpdate",7),a=Ar(t,"availableTags",23,()=>[]),r=Pn(!1),s=Pn(Ot([])),o=Pn(""),l=Pn(null),c=In(()=>n().tags||[]);function d(){$n(s,[...n().tags||[]],!0),$n(o,""),$n(r,!0)}function u(){$n(r,!1),$n(s,[],!0),$n(o,"")}function h(){i()&&(i()(n().uuid,bi(s)),u())}function p(e){const t=e.trim();t&&!bi(s).includes(t)&&($n(s,[...bi(s),t],!0),$n(o,""))}function g(e){$n(s,bi(s).filter(t=>t!==e),!0)}function v(e){bi(s).includes(e)?g(e):p(e)}Ti(()=>{}),Ti(()=>{if(bi(r)&&bi(l))return setTimeout(()=>{document.addEventListener("mousedown",e)},0),()=>{document.removeEventListener("mousedown",e)};function e(e){bi(l)&&!bi(l).contains(e.target)&&h()}});var f={get card(){return n()},set card(e){n(e),hn()},get onTagsUpdate(){return i()},set onTagsUpdate(e){i(e),hn()},get availableTags(){return a()},set availableTags(e=[]){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},m=sm();m.__click=d;var y=Gt(m),b=e=>{var t=Jf();t.__click=[Wf];var n=Gt(t),i=Gt(n),r=e=>{var t=Kf();Ca(t,21,()=>bi(s),_a,(e,t)=>{var n=Qf(),i=Gt(n),a=Gt(i,!0);zt(i),Kt(i,2).__click=[Gf,g,t],zt(n),zi(()=>va(a,bi(t))),pa(e,n)}),zt(t),pa(e,t)};xa(i,e=>{bi(s).length>0&&e(r)});var c=Kt(i,2);Za(c),c.__keydown=[Hf,o,p,h,u,s],Bn(c,!0),zt(n);var d=Kt(n,2),f=e=>{var t=Xf(),n=Kt(Gt(t),2);Ca(n,21,a,_a,(e,t)=>{var n=Yf();n.__click=[Zf,v,t];var i=Gt(n,!0);zt(n),zi(e=>{Fa(n,1,`available-tag-item ${null!=e?e:""}`,"svelte-rnwfvk"),va(i,bi(t))},[()=>bi(s).includes(bi(t))?"selected":""]),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(d,e=>{a().length>0&&e(f)});var m=Kt(d,2),y=Gt(m);y.__click=u,Kt(y,2).__click=h,zt(m),zt(t),kr(t,e=>$n(l,e),()=>bi(l)),zi(()=>er(c,"placeholder",bi(s).length>0?"":"输入标签后按回车添加")),pr(c,()=>bi(o),e=>$n(o,e)),pa(e,t)},w=e=>{var t=rm();t.__click=d,t.__keydown=[em,d];var n=Gt(t),i=e=>{var t=im(),n=Qt(t);Ca(n,16,()=>bi(c).slice(0,2),e=>e,(e,t)=>{var n=tm(),i=Gt(n,!0);zt(n),zi(e=>{Fa(n,1,`tuanki-tag tuanki-tag-${null!=e?e:""}`,"svelte-rnwfvk"),va(i,t)},[()=>function(e){const t=["blue","green","purple","orange","pink","cyan","red","yellow"];return t[e.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%t.length]}(t)]),pa(e,n)});var i=Kt(n,2),a=e=>{var t=nm(),n=Gt(t);zt(t),zi(()=>va(n,"+"+(bi(c).length-2))),pa(e,t)};xa(i,e=>{bi(c).length>2&&e(a)}),pa(e,t)},a=e=>{pa(e,am())};xa(n,e=>{bi(c).length>0?e(i):e(a,!1)});var r=Kt(n,2);Ng(Gt(r),{name:"edit",size:12}),zt(r),zt(t),pa(e,t)};return xa(y,e=>{bi(r)?e(b):e(w,!1)}),zt(m),pa(e,m),St(f)}ia(["click","keydown"]);var lm=la('<button class="tuanki-priority-star svelte-1dmkbx3"><!></button>'),cm=la('<td class="tuanki-priority-column svelte-1dmkbx3"><div class="tuanki-priority-container interactive svelte-1dmkbx3" role="group" aria-label="优先级评分"></div></td>');function dm(e,t){if(new.target)return Er({component:dm,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"onPriorityUpdate",7),a=Pn(null),r=Pn(-1);var s={get card(){return n()},set card(e){n(e),hn()},get onPriorityUpdate(){return i()},set onPriorityUpdate(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=cm(),l=Gt(o);return Ca(l,20,()=>Array(4),_a,(e,t,s)=>{const o=In(()=>function(e,t,n,i,a){const r=i===e;return r&&(r?a:-1)>=t?"hover":t<n?"filled":"empty"}(n().uuid,s,n().priority||2,bi(a),bi(r)));var l=lm();l.__click=()=>function(e){if(!i())return;const t=e+1;i()(n().uuid,t)}(s),er(l,"aria-label",`设置优先级为 ${s+1} 星`),er(l,"title",`设置优先级为 ${s+1} 星`);var c=Gt(l);{let e=In(()=>"empty"===bi(o)?"star":"starFilled"),t=In(()=>"hover"===bi(o)||"filled"===bi(o)?"var(--tuanki-warning)":"var(--text-faint)");Ng(c,{get name(){return bi(e)},size:"14",get color(){return bi(t)}})}zt(l),na("mouseenter",l,()=>{return e=s,$n(a,n().uuid,!0),void $n(r,e,!0);var e}),pa(e,l)}),zt(l),zt(o),na("mouseleave",l,function(){$n(a,null),$n(r,-1)}),pa(e,o),St(s)}ia(["click"]);var um=la('<span class="tuanki-deck-name svelte-12v3pw8"> </span>'),hm=la('<span class="tuanki-text-muted">无牌组</span>'),pm=la('<td class="tuanki-deck-column svelte-12v3pw8"><div class="tuanki-cell-content"><!></div></td>');function gm(e,t){if(new.target)return Er({component:gm,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"decks",23,()=>[]);const a=In(()=>function(e,t){if(!t)return e||"未知牌组";const n=t.find(t=>t.id===e);return(null==n?void 0:n.name)||e||"未知牌组"}(n().deckId,i())),r=In(()=>If(bi(a),20));var s={get card(){return n()},set card(e){n(e),hn()},get decks(){return i()},set decks(e=[]){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=pm(),l=Gt(o),c=Gt(l),d=e=>{var t=um(),n=Gt(t,!0);zt(t),zi(()=>{er(t,"title",bi(a)),va(n,bi(r))}),pa(e,t)},u=e=>{pa(e,hm())};return xa(c,e=>{n().deckId?e(d):e(u,!1)}),zt(l),zt(o),pa(e,o),St(s)}var vm=la('<span class="tuanki-block-ref-display svelte-9ohfqb"><!> <span class="tuanki-link-text svelte-9ohfqb"> </span></span>'),fm=la('<span class="tuanki-no-link svelte-9ohfqb" title="无块引用"><!> <span class="tuanki-text-muted">-</span></span>'),mm=la('<td class="tuanki-link-column svelte-9ohfqb"><div class="tuanki-cell-content"><!></div></td>');function ym(e,t){if(new.target)return Er({component:ym,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"plugin",7);const a=In(()=>n().sourceBlock||n().obsidian_block_link);var r={get card(){return n()},set card(e){n(e),hn()},get plugin(){return i()},set plugin(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=mm(),o=Gt(s),l=Gt(o),c=e=>{var t=vm(),n=Gt(t);Ng(n,{get name(){return Eg},size:14});var i=Kt(n,2),r=Gt(i,!0);zt(i),zt(t),zi(e=>{var n;er(t,"title",`块引用: ${null!=(n=bi(a))?n:""}`),va(r,e)},[()=>If(bi(a),20)]),pa(e,t)},d=e=>{var t=fm();Ng(Gt(t),{get name(){return Eg},size:14}),Pt(2),zt(t),pa(e,t)};return xa(l,e=>{bi(a)?e(c):e(d,!1)}),zt(o),zt(s),pa(e,s),St(r)}function bm(e,t,n,i,a,r){e.preventDefault(),e.stopPropagation();const s=new ge.Menu;t()&&s.addItem(e=>{e.setTitle("查看详情").setIcon("eye").onClick(()=>{t()(n().uuid)})}),(i()||a())&&s.addItem(e=>{e.setTitle("编辑卡片").setIcon("edit").onClick(()=>{a()?a()(n().uuid):i()&&i()(n().uuid)})}),s.addSeparator(),s.addItem(e=>{e.setTitle("删除卡片").setIcon("trash").setWarning(!0).onClick(()=>{r()(n().uuid)})}),s.showAtMouseEvent(e)}var wm=la('<div class="tuanki-actions-container svelte-dululw"><button class="actions-menu-button svelte-dululw" title="操作菜单"><!></button></div>');function km(e,t){if(new.target)return Er({component:km,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"onView",7),a=Ar(t,"onTempFileEdit",7),r=Ar(t,"onEdit",7),s=Ar(t,"onDelete",7);var o={get card(){return n()},set card(e){n(e),hn()},get onView(){return i()},set onView(e){i(e),hn()},get onTempFileEdit(){return a()},set onTempFileEdit(e){a(e),hn()},get onEdit(){return r()},set onEdit(e){r(e),hn()},get onDelete(){return s()},set onDelete(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=wm(),c=Gt(l);return c.__click=[bm,i,n,r,a,s],Ng(Gt(c),{name:"more-horizontal",size:16}),zt(c),zt(l),pa(e,l),St(o)}function Sm(e){if(!e)return"-";const t=new Date,n=e.getTime()-t.getTime(),i=Math.floor(n/864e5);return i<0?"已到期":0===i?"今天":1===i?"明天":i<7?`${i}天后`:i<30?`${Math.floor(i/7)}周后`:`${Math.floor(i/30)}月后`}function xm(e){if(!e)return"var(--text-muted)";const t=new Date,n=e.getTime()-t.getTime(),i=Math.floor(n/864e5);return i<0?"var(--text-error)":0===i?"var(--text-warning)":i<7?"var(--text-accent)":"var(--text-muted)"}ia(["click"]);var _m=la('<td class="review-data-cell svelte-1ecz1pv"><span> </span></td>');function Cm(e,t){if(new.target)return Er({component:Cm,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"column",7);const a=In(()=>function(e){var t,n,i,a;try{const r=e.fsrs;return{nextReview:(null==r?void 0:r.due)?new Date(r.due):null,retention:(null==r?void 0:r.stability)?Math.min(r.stability/100,1):0,interval:null!=(t=null==r?void 0:r.scheduledDays)?t:0,difficulty:null!=(n=null==r?void 0:r.difficulty)?n:0,reviewCount:null!=(a=null==(i=e.reviewHistory)?void 0:i.length)?a:0}}catch(r){return _e.error("[CardReviewData] 派生复习数据失败:",r),{nextReview:null,retention:0,interval:0,difficulty:0,reviewCount:0}}}(n())),r=In(()=>{switch(i()){case"next_review":return{text:Sm(bi(a).nextReview),color:xm(bi(a).nextReview)};case"retention":return{text:`${Math.round(100*bi(a).retention)}%`,color:(n=bi(a).retention,n>=.9?"var(--color-green)":n>=.8?"var(--color-cyan)":n>=.7?"var(--color-yellow)":"var(--color-red)")};case"interval":return{text:(t=bi(a).interval,t<1?"< 1天":t<30?`${t}天`:t<365?`${Math.floor(t/30)}个月`:`${(t/365).toFixed(1)}年`),color:"var(--text-muted)"};case"difficulty":return{text:bi(a).difficulty.toFixed(1),color:(e=bi(a).difficulty,e<=3?"var(--color-green)":e<=5?"var(--color-yellow)":e<=7?"var(--color-orange)":"var(--color-red)")};case"review_count":return{text:`${bi(a).reviewCount}次`,color:"var(--text-normal)"};default:return{text:"-",color:"var(--text-muted)"}}var e,t,n});var s={get card(){return n()},set card(e){n(e),hn()},get column(){return i()},set column(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=_m(),l=Gt(o),c=Gt(l,!0);return zt(l),zt(o),zi(()=>{var e;ja(l,`color: ${null!=(e=bi(r).color)?e:""}; font-size: 13px;`),va(c,bi(r).text)}),pa(e,o),St(s)}var Im=la('<td class="modified-cell svelte-1yw1igu"><span class="modified-text svelte-1yw1igu"> </span></td>');function Dm(e,t){if(new.target)return Er({component:Dm,...e});kt(t,!0);let n=Ar(t,"card",7);const i=In(()=>function(e){try{return e.modified?new Date(e.modified):new Date(e.created)}catch(t){return _e.error("[CardReviewData] 获取修改时间失败:",t),new Date}}(n())),a=In(()=>()=>{const e=(new Date).getTime()-bi(i).getTime(),t=Math.floor(e/864e5);return 0===t?"今天":1===t?"昨天":t<7?`${t}天前`:t<30?`${Math.floor(t/7)}周前`:t<365?`${Math.floor(t/30)}月前`:`${Math.floor(t/365)}年前`});var r={get card(){return n()},set card(e){n(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=Im(),o=Gt(s),l=Gt(o,!0);return zt(o),zt(s),zi(e=>{er(s,"title",e),va(l,bi(a))},[()=>bi(i).toLocaleString()]),pa(e,s),St(r)}var Tm=la('<td class="tuanki-content-column tuanki-front-column svelte-152r1v9"><div class="tuanki-cell-content"><span class="tuanki-text-content"> </span></div></td>'),Mm=la('<td class="tuanki-content-column tuanki-back-column svelte-152r1v9"><div class="tuanki-cell-content"><span class="tuanki-text-content"> </span></div></td>'),Am=la('<td class="tuanki-status-column svelte-152r1v9"><!></td>'),Em=la('<td class="tuanki-uuid-column svelte-152r1v9"><div class="tuanki-cell-content"><span class="tuanki-uuid-text"><!> </span></div></td>'),zm=la('<td class="tuanki-date-column svelte-152r1v9"><span class="tuanki-text-content"> </span></td>'),Pm=(e,t,n)=>{var i,a;return null==(a=(i=t()).onJumpToSource)?void 0:a.call(i,n())},Rm=la('<button class="tuanki-source-link"><!> <span> </span> <!></button>'),$m=la('<span class="tuanki-text-muted">-</span>'),Om=la('<td class="tuanki-source-document-column svelte-152r1v9"><!></td>'),Lm=la('<div class="tuanki-cell-content"><!> <span> </span></div>'),Nm=la('<span class="tuanki-text-muted">未知</span>'),Fm=la('<td class="tuanki-field-template-column svelte-152r1v9"><!></td>'),Bm=la('<div class="tuanki-cell-content"><!> <span> </span></div>'),jm=la('<span class="tuanki-text-muted">-</span>'),Um=la('<td class="tuanki-source-status-column svelte-152r1v9"><!></td>'),Vm=la('<td class="tuanki-question-type-column svelte-152r1v9"><span class="tuanki-text-content"> </span></td>'),qm=la('<td class="tuanki-accuracy-column svelte-152r1v9"><span> </span></td>'),Hm=la('<td class="tuanki-test-attempts-column svelte-152r1v9"><span class="tuanki-text-content"> </span></td>'),Wm=la('<td class="tuanki-last-test-column svelte-152r1v9"><span class="tuanki-text-content"> </span></td>'),Gm=la('<td class="tuanki-error-level-column svelte-152r1v9"><span class="tuanki-text-content"> </span></td>'),Qm=la('<td class="tuanki-source-card-column svelte-152r1v9"><span class="tuanki-text-content"> </span></td>'),Km=la('<td class="tuanki-actions-column svelte-152r1v9"><!></td>'),Zm=la('<tr><td class="tuanki-checkbox-column svelte-152r1v9"><!></td><!></tr>');function Ym(e,t){if(new.target)return Er({component:Ym,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"selected",7),a=Ar(t,"columnVisibility",7),r=Ar(t,"columnOrder",7),s=Ar(t,"tableViewMode",7),o=Ar(t,"callbacks",7),l=Ar(t,"plugin",7),c=Ar(t,"decks",23,()=>[]),d=Ar(t,"fieldTemplates",23,()=>[]),u=Ar(t,"availableTags",23,()=>[]),h=Ar(t,"onSelect",7),p=Ar(t,"onDragSelectStart",7),g=Ar(t,"onDragSelectMove",7),v=Ar(t,"isDragSelectActive",7),f=Ar(t,"isVisible",7,!0);let m=Pn(Ot(_f(n().templateId||"",d(),l()))),y=Pn(Ot(Cf(n().sourceDocumentStatus||"")));Ti(()=>{f()&&($n(m,_f(n().templateId||"",d(),l()),!0),$n(y,Cf(n().sourceDocumentStatus||""),!0))});var b={get card(){return n()},set card(e){n(e),hn()},get selected(){return i()},set selected(e){i(e),hn()},get columnVisibility(){return a()},set columnVisibility(e){a(e),hn()},get columnOrder(){return r()},set columnOrder(e){r(e),hn()},get tableViewMode(){return s()},set tableViewMode(e){s(e),hn()},get callbacks(){return o()},set callbacks(e){o(e),hn()},get plugin(){return l()},set plugin(e){l(e),hn()},get decks(){return c()},set decks(e=[]){c(e),hn()},get fieldTemplates(){return d()},set fieldTemplates(e=[]){d(e),hn()},get availableTags(){return u()},set availableTags(e=[]){u(e),hn()},get onSelect(){return h()},set onSelect(e){h(e),hn()},get onDragSelectStart(){return p()},set onDragSelectStart(e){p(e),hn()},get onDragSelectMove(){return g()},set onDragSelectMove(e){g(e),hn()},get isDragSelectActive(){return v()},set isDragSelectActive(e){v(e),hn()},get isVisible(){return f()},set isVisible(e=!0){f(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},w=Zm();let k;var S=Gt(w);return qf(Gt(S),{get checked(){return i()},onchange:function(e){h()(n().uuid,e)},ariaLabel:"选择卡片",get cardId(){return n().uuid},get onDragSelectStart(){return p()},get onDragSelectMove(){return g()},get isDragSelectActive(){return v()}}),zt(S),Ca(Kt(S),16,r,e=>e,(e,t)=>{var i=ha(),a=Qt(i),r=e=>{var t=Tm(),i=Gt(t),a=Gt(i),r=Gt(a,!0);zt(a),zt(i),zt(t),zi(e=>va(r,e),[()=>{var e,t;return If(n().front||(null==(e=n().fields)?void 0:e.front)||(null==(t=n().fields)?void 0:t.question)||"")}]),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Mm(),i=Gt(t),a=Gt(i),r=Gt(a,!0);zt(a),zt(i),zt(t),zi(e=>va(r,e),[()=>{var e,t;return If(n().back||(null==(e=n().fields)?void 0:e.back)||(null==(t=n().fields)?void 0:t.answer)||"")}]),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Am(),i=Gt(t);{let e=In(()=>n().fsrs?n().fsrs.state:0);Uf(i,{get state(){return bi(e)}})}zt(t),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{gm(e,{get card(){return n()},get decks(){return c()}})},s=e=>{var i=ha(),a=Qt(i),r=e=>{om(e,{get card(){return n()},get availableTags(){return u()},get onTagsUpdate(){return o().onTagsUpdate}})},s=e=>{var i=ha(),a=Qt(i),r=e=>{dm(e,{get card(){return n()},get onPriorityUpdate(){return o().onPriorityUpdate}})},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Em(),i=Gt(t),a=Gt(i),r=Gt(a);Ng(r,{get name(){return Pg},size:14});var s=Kt(r);zt(a),zt(i),zt(t),zi(e=>{er(a,"title",n().uuid),va(s,` ${null!=e?e:""}`)},[()=>If(n().uuid||"N/A",8)]),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=zm(),i=Gt(t),a=Gt(i,!0);zt(i),zt(t),zi(e=>va(a,e),[()=>function(e){if(!e)return"-";try{let t;if(t="string"==typeof e&&/^\d+$/.test(e)?new Date(Number(e)):new Date(e),isNaN(t.getTime()))return"-";const n=new Date;if(t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate()){return`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}{const e=t.getFullYear();return`${e}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}}catch(t){return"-"}}(n().created)]),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{Dm(e,{get card(){return n()}})},s=e=>{var i=ha(),a=Qt(i),r=e=>{Cm(e,{get card(){return n()},get column(){return t}})},s=e=>{var i=ha(),a=Qt(i),r=e=>{ym(e,{get card(){return n()},get plugin(){return l()}})},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Om(),i=Gt(t),a=e=>{var t=Rm();t.__click=[Pm,o,n];var i=Gt(t);Ng(i,{name:"file-text",size:14});var a=Kt(i,2),r=Gt(a,!0);zt(a);var s=Kt(a,2),l=e=>{Ng(e,{name:"link",size:12,class:"tuanki-has-block-indicator"})};xa(s,e=>{var t;(n().sourceBlock||(null==(t=n().customFields)?void 0:t.blockId))&&e(l)}),zt(t),zi(e=>{var i;er(t,"title",n().sourceBlock||(null==(i=n().customFields)?void 0:i.blockId)?"点击打开源文档并定位到块引用位置":"点击打开源文档"),va(r,e)},[()=>If(function(e){var t;if(e.sourceFile)return e.sourceFile.split("/").pop()||e.sourceFile;if(null==(t=e.customFields)?void 0:t.obsidianFilePath){const t=e.customFields.obsidianFilePath;return t.split("/").pop()||t}return""}(n()),20)]),pa(e,t)},r=e=>{pa(e,$m())};xa(i,e=>{var t;n().sourceFile||(null==(t=n().customFields)?void 0:t.obsidianFilePath)?e(a):e(r,!1)}),zt(t),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Fm(),n=Gt(t),i=e=>{var t=Lm(),n=Gt(t);Ng(n,{get name(){return bi(m).icon},size:14});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(()=>{Fa(i,1,$a(bi(m).class),"svelte-152r1v9"),va(a,bi(m).name)}),pa(e,t)},a=e=>{pa(e,Nm())};xa(n,e=>{bi(m)?e(i):e(a,!1)}),zt(t),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Um(),i=Gt(t),a=e=>{var t=Bm(),n=Gt(t);Ng(n,{get name(){return bi(y).icon},size:14});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(()=>{Fa(i,1,$a(bi(y).class),"svelte-152r1v9"),er(i,"title",bi(y).tooltip),va(a,bi(y).text)}),pa(e,t)},r=e=>{pa(e,jm())};xa(i,e=>{var t;n().sourceFile||(null==(t=n().customFields)?void 0:t.obsidianFilePath)?e(a):e(r,!1)}),zt(t),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Vm(),i=Gt(t),a=Gt(i,!0);zt(i),zt(t),zi(()=>va(a,n().question_type||"-")),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=qm(),i=Gt(t),a=Gt(i,!0);zt(i),zt(t),zi(()=>{var e;Fa(i,1,`tuanki-text-content ${null!=(e=n().accuracy_class||"")?e:""}`,"svelte-152r1v9"),va(a,n().accuracy||"-")}),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Hm(),i=Gt(t),a=Gt(i,!0);zt(i),zt(t),zi(()=>va(a,n().test_attempts||0)),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Wm(),i=Gt(t),a=Gt(i,!0);zt(i),zt(t),zi(()=>va(a,n().last_test||"-")),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Gm(),i=Gt(t),a=Gt(i,!0);zt(i),zt(t),zi(()=>va(a,n().error_level||"-")),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Qm(),i=Gt(t),a=Gt(i,!0);zt(i),zt(t),zi(e=>{er(i,"title",n().source_card||"-"),va(a,e)},[()=>If(n().source_card||"-",30)]),pa(e,t)},s=e=>{var i=ha(),a=Qt(i),r=e=>{var t=Km();km(Gt(t),{get card(){return n()},get onView(){return o().onView},get onTempFileEdit(){return o().onTempFileEdit},get onEdit(){return o().onEdit},get onDelete(){return o().onDelete}}),zt(t),pa(e,t)};xa(a,e=>{"actions"===t&&e(r)},!0),pa(e,i)};xa(a,e=>{"source_card"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"error_level"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"last_test"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"test_attempts"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"accuracy"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"question_type"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"source_document_status"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"field_template"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"source_document"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"obsidian_block_link"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"next_review"===t||"retention"===t||"interval"===t||"difficulty"===t||"review_count"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"modified"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"created"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"uuid"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"priority"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"tags"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"deck"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"status"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"back"===t?e(r):e(s,!1)},!0),pa(e,i)};xa(a,e=>{"front"===t?e(r):e(s,!1)}),pa(e,i)}),zt(w),zi(e=>k=Fa(w,1,"tuanki-table-row svelte-152r1v9",null,k,e),[()=>({selected:i()})]),pa(e,w),St(b)}ia(["click"]);var Xm=la('<div class="tuanki-table-top-scrollbar svelte-lbp4f0"><div class="tuanki-table-scrollbar-content svelte-lbp4f0"></div></div>'),Jm=la('<div style="overflow-x: auto; overflow-y: hidden;"><table class="tuanki-table svelte-lbp4f0"><!><tbody class="tuanki-table-body svelte-lbp4f0"></tbody></table></div>'),ey=la('<div class="tuanki-table-wrapper svelte-lbp4f0"><!> <div class="tuanki-table-container svelte-lbp4f0"><!></div></div>');function ty(e,t){if(new.target)return Er({component:ty,...e});kt(t,!0);let n=Ar(t,"cards",7),i=Ar(t,"selectedCards",7),a=Ar(t,"onCardSelect",7),r=Ar(t,"onSelectAll",7),s=Ar(t,"onSort",7),o=Ar(t,"sortConfig",7),l=Ar(t,"columnVisibility",7),c=Ar(t,"columnOrder",7),d=Ar(t,"tableViewMode",7,"basic"),u=Ar(t,"onEdit",7),h=Ar(t,"onDelete",7),p=Ar(t,"onTagsUpdate",7),g=Ar(t,"onPriorityUpdate",7),v=Ar(t,"loading",7,!1),f=Ar(t,"isSorting",7,!1),m=Ar(t,"fieldTemplates",23,()=>[]),y=Ar(t,"plugin",7),b=Ar(t,"onTempFileEdit",7),w=Ar(t,"decks",23,()=>[]),k=Ar(t,"onView",7),S=Ar(t,"availableTags",23,()=>[]),x=Ar(t,"onJumpToSource",7),_=Ar(t,"isVisible",7,!0),C=In(()=>Array.isArray(n())?n().filter(e=>e&&e.uuid):[]);const I="tuanki-table-column-widths",D={checkbox:48,front:200,back:200,status:140,deck:150,tags:160,priority:100,created:120,modified:120,next_review:130,retention:100,interval:90,difficulty:90,review_count:100,actions:60,uuid:120,obsidian_block_link:150,source_document:180,field_template:160,source_document_status:120,question_type:120,accuracy:100,test_attempts:110,last_test:130,error_level:110,source_card:200},T={basic:["front","back","status","deck","tags","priority","created","modified","source_document","obsidian_block_link"],review:["front","back","status","next_review","retention","interval","difficulty","review_count"],questionBank:["front","back","deck","tags","priority","question_type","accuracy","test_attempts","last_test","error_level","source_card","created"]};let M=Pn(Ot({...D})),A=null,E=null,z=null,P=null,R=null,$=In(()=>{const e=T[d()],t={basic:[],review:["modified","next_review","retention","interval","difficulty","review_count"],questionBank:["question_type","accuracy","test_attempts","last_test","error_level","source_card"]}[d()],n=c().filter(n=>"actions"===n||!!e.includes(n)&&(!!t.includes(n)||!1!==l()[n]));return n});function O(e){"top"===e&&E&&z?z.scrollLeft=E.scrollLeft:"bottom"===e&&E&&z&&(E.scrollLeft=z.scrollLeft)}function L(){P&&R&&setTimeout(()=>{if(P&&R){const e=P.scrollWidth;R.style.width=`${e}px`}},0)}let N=null;Ti(()=>{bi(M)&&bi($)&&l()&&d()&&(null!==N&&clearTimeout(N),N=window.setTimeout(()=>{L(),N=null},50))});let F=null;function B(){try{localStorage.setItem(I,JSON.stringify(bi(M)))}catch(e){_e.warn("Failed to save column widths:",e)}}function j(e,t){const n=bi(M)[e],i=Math.max(50,n+t);$n(M,{...bi(M),[e]:i},!0),B()}Ti(()=>{n()&&(null!==F&&clearTimeout(F),F=window.setTimeout(()=>{L(),F=null},100))}),Pr(()=>{const e=function(){const e=["sort","sort-up","sort-down","edit","trash","eye","check","check-circle","warning","question-circle","tag","download","help","info","bar-chart-2"].filter(e=>!dg(e));return e.length>0&&_e.error("[Tuanki Table] 缺失的图标:",e),{valid:0===e.length,missingIcons:e}}();e.valid||_e.warn("[Tuanki Table] 部分图标缺失，可能影响显示效果",e.missingIcons),function(){try{const e=localStorage.getItem(I);if(e){const t=JSON.parse(e);$n(M,{...D,...t},!0)}}catch(e){_e.warn("Failed to load column widths:",e)}}();const t=()=>{$n(M,{...D},!0),B()};A&&A.addEventListener("resetColumnWidths",t);let n=null,i=null;return P&&(n=new ResizeObserver(()=>{null!==i&&clearTimeout(i),i=window.setTimeout(()=>{L(),i=null},100)}),n.observe(P)),()=>{A&&A.removeEventListener("resetColumnWidths",t),null!==i&&clearTimeout(i),n&&P&&(n.unobserve(P),n.disconnect()),null!==N&&clearTimeout(N),null!==F&&clearTimeout(F)}});let U=Pn(!1),V=Pn(null);function q(e){$n(U,!0),$n(V,e,!0),document.body.style.overflow="hidden",document.addEventListener("mouseup",W)}function H(e){if(!bi(U)||!bi(V))return;const t=n().findIndex(e=>e.uuid===bi(V)),r=n().findIndex(t=>t.uuid===e);if(-1===t||-1===r)return;const s=Math.min(t,r),o=Math.max(t,r),l=new Set(i()),c=i().has(bi(V));for(let i=s;i<=o;i++){const e=n()[i];e&&e.uuid&&(c?l.add(e.uuid):l.delete(e.uuid))}for(const n of l)i().has(n)||a()(n,!0);for(const n of i())l.has(n)||a()(n,!1)}function W(){bi(U)&&($n(U,!1),$n(V,null),document.body.style.overflow="",document.removeEventListener("mouseup",W))}const G={onEdit:u(),onDelete:h(),onTagsUpdate:p(),onPriorityUpdate:g(),onTempFileEdit:b(),onView:k(),onJumpToSource:x()};var Q={get cards(){return n()},set cards(e){n(e),hn()},get selectedCards(){return i()},set selectedCards(e){i(e),hn()},get onCardSelect(){return a()},set onCardSelect(e){a(e),hn()},get onSelectAll(){return r()},set onSelectAll(e){r(e),hn()},get onSort(){return s()},set onSort(e){s(e),hn()},get sortConfig(){return o()},set sortConfig(e){o(e),hn()},get columnVisibility(){return l()},set columnVisibility(e){l(e),hn()},get columnOrder(){return c()},set columnOrder(e){c(e),hn()},get tableViewMode(){return d()},set tableViewMode(e="basic"){d(e),hn()},get onEdit(){return u()},set onEdit(e){u(e),hn()},get onDelete(){return h()},set onDelete(e){h(e),hn()},get onTagsUpdate(){return p()},set onTagsUpdate(e){p(e),hn()},get onPriorityUpdate(){return g()},set onPriorityUpdate(e){g(e),hn()},get loading(){return v()},set loading(e=!1){v(e),hn()},get isSorting(){return f()},set isSorting(e=!1){f(e),hn()},get fieldTemplates(){return m()},set fieldTemplates(e=[]){m(e),hn()},get plugin(){return y()},set plugin(e){y(e),hn()},get onTempFileEdit(){return b()},set onTempFileEdit(e){b(e),hn()},get decks(){return w()},set decks(e=[]){w(e),hn()},get onView(){return k()},set onView(e){k(e),hn()},get availableTags(){return S()},set availableTags(e=[]){S(e),hn()},get onJumpToSource(){return x()},set onJumpToSource(e){x(e),hn()},get isVisible(){return _()},set isVisible(e=!0){_(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},K=ey(),Z=Gt(K),Y=e=>{var t=Xm();kr(Gt(t),e=>R=e,()=>R),zt(t),kr(t,e=>E=e,()=>E),na("scroll",t,()=>O("top")),pa(e,t)};xa(Z,e=>{!v()&&Array.isArray(n())&&n().length>0&&e(Y)});var X=Kt(Z,2),J=Gt(X),ee=e=>{var t=Jm(),c=Gt(t),u=Gt(c);Bf(u,{get columnVisibility(){return l()},get columnOrder(){return bi($)},get tableViewMode(){return d()},get sortConfig(){return o()},get selectedCards(){return i()},get totalCards(){return n().length},get columnWidths(){return bi(M)},get onSelectAll(){return r()},get onSort(){return s()},get isSorting(){return f()},onColumnResize:j});var h=Kt(u);Ca(h,21,()=>bi(C),e=>e.uuid,(e,t)=>{{let n=In(()=>i().has(bi(t).uuid));Ym(e,{get card(){return bi(t)},get selected(){return bi(n)},get columnVisibility(){return l()},get columnOrder(){return bi($)},get tableViewMode(){return d()},get callbacks(){return G},get plugin(){return y()},get decks(){return w()},get fieldTemplates(){return m()},get availableTags(){return S()},get onSelect(){return a()},onDragSelectStart:q,onDragSelectMove:H,get isDragSelectActive(){return bi(U)},get isVisible(){return _()}})}}),zt(h),zt(c),kr(c,e=>P=e,()=>P),zt(t),kr(t,e=>z=e,()=>z),pa(e,t)};return xa(J,e=>{v()||e(ee)}),zt(X),kr(X,e=>A=e,()=>A),zt(K),na("scroll",X,()=>O("bottom")),pa(e,K),St(Q)}var ny=la('<div class="sorting-overlay svelte-cg6ikp" role="status" aria-label="正在排序"><div class="newtons-cradle svelte-cg6ikp"><div class="newtons-cradle__dot svelte-cg6ikp"></div> <div class="newtons-cradle__dot svelte-cg6ikp"></div> <div class="newtons-cradle__dot svelte-cg6ikp"></div> <div class="newtons-cradle__dot svelte-cg6ikp"></div></div></div>');function iy(e,t){if(new.target)return Er({component:iy,...e});kt(t,!0);let n=Ar(t,"show",7,!1);var i={get show(){return n()},set show(e=!1){n(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},a=ha(),r=Qt(a),s=e=>{pa(e,ny())};return xa(r,e=>{n()&&e(s)}),pa(e,a),St(i)}class ay{constructor(e){oe(this,"dataStorage"),oe(this,"updateHistory",[]),oe(this,"decks",[]),this.dataStorage=e}setDecks(e){this.decks=e}async updateCardState(e,t){try{const n=await this.dataStorage.getCardByUUID(e);if(!n||!n.fsrs)return _e.error("卡片不存在或fsrs未初始化:",e),!1;const i=n.fsrs.state;return n.fsrs.state=t,this.updateRelatedFields(n,t),await this.dataStorage.updateCard(n),this.updateHistory.push({cardId:e,newState:t,oldState:i,timestamp:new Date}),_e.debug(`卡片 ${e} 状态从 ${i} 更新为 ${t}`),!0}catch(n){return _e.error("更新卡片状态失败:",n),!1}}async batchUpdateCardStates(e){return await Promise.all(e.map(e=>this.updateCardState(e.cardId,e.newState)))}updateRelatedFields(e,t){if(!e.fsrs)return;const n=new Date,i=n.toISOString();switch(t){case 0:e.fsrs.due=i,e.fsrs.stability=0,e.fsrs.difficulty=5,e.fsrs.elapsedDays=0,e.fsrs.scheduledDays=0,e.fsrs.reps=0,e.fsrs.lapses=0;break;case 1:e.fsrs.due=new Date(n.getTime()+6e5).toISOString(),e.fsrs.scheduledDays=0;break;case 2:if(e.fsrs.stability>0){const t=Math.max(1,Math.round(e.fsrs.stability));e.fsrs.due=new Date(n.getTime()+24*t*60*60*1e3).toISOString(),e.fsrs.scheduledDays=t}else e.fsrs.due=new Date(n.getTime()+864e5).toISOString(),e.fsrs.scheduledDays=1;break;case 3:e.fsrs.due=i,e.fsrs.lapses=(e.fsrs.lapses||0)+1,e.fsrs.scheduledDays=0}e.fsrs.lastReview=i}getStateGroups(){return[{key:"0",label:"新卡片",color:"#6b7280",icon:"plus-circle",cards:[],count:0,dueCount:0},{key:"1",label:"学习中",color:"#3b82f6",icon:"book-open",cards:[],count:0,dueCount:0},{key:"2",label:"复习",color:"#10b981",icon:"refresh-cw",cards:[],count:0,dueCount:0},{key:"3",label:"重新学习",color:"#f59e0b",icon:"rotate-ccw",cards:[],count:0,dueCount:0}]}getTypeGroups(){return[{key:"basic",label:"基础问答",color:"var(--interactive-accent)",icon:"message-circle",cards:[],count:0,dueCount:0},{key:"cloze",label:"挖空填词",color:"#ec4899",icon:"edit-3",cards:[],count:0,dueCount:0},{key:"multiple",label:"多选题",color:"#06b6d4",icon:"check-square",cards:[],count:0,dueCount:0},{key:"code",label:"代码题",color:"#84cc16",icon:"code",cards:[],count:0,dueCount:0}]}getPriorityGroups(){return[{key:"4",label:"高优先级",color:"#ef4444",icon:"alert-triangle",cards:[],count:0,dueCount:0},{key:"3",label:"中优先级",color:"#f59e0b",icon:"flag",cards:[],count:0,dueCount:0},{key:"2",label:"低优先级",color:"#10b981",icon:"minus-circle",cards:[],count:0,dueCount:0},{key:"1",label:"无优先级",color:"#6b7280",icon:"circle",cards:[],count:0,dueCount:0}]}getDeckGroups(e){const t=new Set;e.forEach(e=>{e.deckId&&t.add(e.deckId)});const n=new Map;this.decks.forEach(e=>{n.set(e.id,e)});const i=[],a=["#3b82f6","#10b981","#f59e0b","#ec4899","var(--interactive-accent)","#06b6d4"];let r=0;return t.forEach(e=>{var t;const s=n.get(e),o=null!=(t=null==s?void 0:s.name)?t:e;i.push({key:e,label:o,color:a[r%a.length],icon:"layers",cards:[],count:0,dueCount:0}),r++}),i.push({key:"_none",label:"无牌组",color:"#6b7280",icon:"inbox",cards:[],count:0,dueCount:0}),i}getCreateTimeGroups(){return[{key:"today",label:"今天",color:"#3b82f6",icon:"calendar",cards:[],count:0,dueCount:0},{key:"yesterday",label:"昨天",color:"#10b981",icon:"calendar",cards:[],count:0,dueCount:0},{key:"last7days",label:"过去7天",color:"#f59e0b",icon:"calendar",cards:[],count:0,dueCount:0},{key:"last30days",label:"过去30天",color:"#ec4899",icon:"calendar",cards:[],count:0,dueCount:0},{key:"earlier",label:"更早",color:"#6b7280",icon:"calendar",cards:[],count:0,dueCount:0}]}groupCards(e,t){const n={};let i;switch(t){case"status":default:i=this.getStateGroups();break;case"type":i=this.getTypeGroups();break;case"priority":i=this.getPriorityGroups();break;case"deck":i=this.getDeckGroups(e);break;case"createTime":i=this.getCreateTimeGroups()}return i.forEach(e=>{n[e.key]=[]}),e.forEach(e=>{if(!e.fsrs)return;let i;switch(t){case"status":i=e.fsrs.state.toString();break;case"type":i=e.type;break;case"priority":i=(e.priority||1).toString();break;case"deck":i=e.deckId||"_none";break;case"createTime":i=this.getTimeGroupKey(e.created);break;default:i="0"}n[i]&&n[i].push(e)}),n}getTimeGroupKey(e){const t=new Date,n=new Date(e),i=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(i.getTime()-864e5),r=new Date(i.getTime()-6048e5),s=new Date(i.getTime()-2592e6);return n>=i?"today":n>=a?"yesterday":n>=r?"last7days":n>=s?"last30days":"earlier"}isCardDue(e){if(!e.fsrs)return!1;const t=new Date;return new Date(e.fsrs.due)<=t}getGroupStats(e,t,n){const i=e.filter(e=>{var i;switch(n){case"status":return(null==(i=e.fsrs)?void 0:i.state.toString())===t;case"type":return e.type===t;case"priority":return(e.priority||1).toString()===t;default:return!1}});return{total:i.length,due:i.filter(e=>this.isCardDue(e)).length,new:i.filter(e=>{var t;return 0===(null==(t=e.fsrs)?void 0:t.state)}).length,learning:i.filter(e=>{var t;return 1===(null==(t=e.fsrs)?void 0:t.state)}).length,review:i.filter(e=>{var t;return 2===(null==(t=e.fsrs)?void 0:t.state)}).length}}getUpdateHistory(){return[...this.updateHistory]}clearUpdateHistory(){this.updateHistory=[]}async undoLastUpdate(){const e=this.updateHistory.pop();if(!e)return!1;try{return await this.updateCardState(e.cardId,e.oldState),this.updateHistory.pop(),!0}catch(t){return _e.error("撤销状态更新失败:",t),this.updateHistory.push(e),!1}}}var ry=la('<div class="markdown-preview-helper markdown-reading-view svelte-155ldpz"></div>');function sy(e,t){if(new.target)return Er({component:sy,...e});kt(t,!0);let n,i=Ar(t,"plugin",7),a=Ar(t,"source",7),r=Ar(t,"sourcePath",7,""),s=null;async function o(){n&&(s&&s.unload(),n.innerHTML="",s=new ge.Component,await ge.MarkdownRenderer.render(i().app,a()||"*空内容*",n,r(),s),s.load())}Pr(()=>{o()}),Ti(()=>{n&&o()}),Rr(()=>{s&&s.unload()});var l={get plugin(){return i()},set plugin(e){i(e),hn()},get source(){return a()},set source(e){a(e),hn()},get sourcePath(){return r()},set sourcePath(e=""){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=ry();return kr(c,e=>n=e,()=>n),pa(e,c),St(l)}function oy(e,t,n){var i;let a,r=null!=(i=n.initialDeps)?i:[];function s(){var i,s,o,l;let c;n.key&&(null==(i=n.debug)?void 0:i.call(n))&&(c=Date.now());const d=e();if(!(d.length!==r.length||d.some((e,t)=>r[t]!==e)))return a;let u;if(r=d,n.key&&(null==(s=n.debug)?void 0:s.call(n))&&(u=Date.now()),a=t(...d),n.key&&(null==(o=n.debug)?void 0:o.call(n))){Math.round(100*(Date.now()-c)),Math.round(100*(Date.now()-u))}return null==(l=null==n?void 0:n.onChange)||l.call(n,a),a}return s.updateDeps=e=>{r=e},s}function ly(e,t){if(void 0===e)throw new Error("Unexpected undefined");return e}const cy=(e,t,n)=>{let i;return function(...a){e.clearTimeout(i),i=e.setTimeout(()=>t.apply(this,a),n)}},dy=e=>{const{offsetWidth:t,offsetHeight:n}=e;return{width:t,height:n}},uy=e=>e,hy=e=>{const t=Math.max(e.startIndex-e.overscan,0),n=Math.min(e.endIndex+e.overscan,e.count-1),i=[];for(let a=t;a<=n;a++)i.push(a);return i},py=(e,t)=>{const n=e.scrollElement;if(!n)return;const i=e.targetWindow;if(!i)return;const a=e=>{const{width:n,height:i}=e;t({width:Math.round(n),height:Math.round(i)})};if(a(dy(n)),!i.ResizeObserver)return()=>{};const r=new i.ResizeObserver(t=>{const i=()=>{const e=t[0];if(null==e?void 0:e.borderBoxSize){const t=e.borderBoxSize[0];if(t)return void a({width:t.inlineSize,height:t.blockSize})}a(dy(n))};e.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(i):i()});return r.observe(n,{box:"border-box"}),()=>{r.unobserve(n)}},gy={passive:!0},vy="undefined"==typeof window||"onscrollend"in window,fy=(e,t)=>{const n=e.scrollElement;if(!n)return;const i=e.targetWindow;if(!i)return;let a=0;const r=e.options.useScrollendEvent&&vy?()=>{}:cy(i,()=>{t(a,!1)},e.options.isScrollingResetDelay),s=i=>()=>{const{horizontal:s,isRtl:o}=e.options;a=s?n.scrollLeft*(o?-1:1):n.scrollTop,r(),t(a,i)},o=s(!0),l=s(!1);l(),n.addEventListener("scroll",o,gy);const c=e.options.useScrollendEvent&&vy;return c&&n.addEventListener("scrollend",l,gy),()=>{n.removeEventListener("scroll",o),c&&n.removeEventListener("scrollend",l)}},my=(e,t,n)=>{if(null==t?void 0:t.borderBoxSize){const e=t.borderBoxSize[0];if(e){return Math.round(e[n.options.horizontal?"inlineSize":"blockSize"])}}return e[n.options.horizontal?"offsetWidth":"offsetHeight"]},yy=(e,{adjustments:t=0,behavior:n},i)=>{var a,r;const s=e+t;null==(r=null==(a=i.scrollElement)?void 0:a.scrollTo)||r.call(a,{[i.options.horizontal?"left":"top"]:s,behavior:n})};class by{constructor(e){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let e=null;const t=()=>e||(this.targetWindow&&this.targetWindow.ResizeObserver?e=new this.targetWindow.ResizeObserver(e=>{e.forEach(e=>{const t=()=>{this._measureElement(e.target,e)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()})}):null);return{disconnect:()=>{var n;null==(n=t())||n.disconnect(),e=null},observe:e=>{var n;return null==(n=t())?void 0:n.observe(e,{box:"border-box"})},unobserve:e=>{var n;return null==(n=t())?void 0:n.unobserve(e)}}})(),this.range=null,this.setOptions=e=>{Object.entries(e).forEach(([t,n])=>{void 0===n&&delete e[t]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:uy,rangeExtractor:hy,onChange:()=>{},measureElement:my,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}},this.notify=e=>{var t,n;null==(n=(t=this.options).onChange)||n.call(t,this,e)},this.maybeNotify=oy(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var e,t;const n=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==n){if(this.cleanup(),!n)return void this.maybeNotify();this.scrollElement=n,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=null!=(e=null==(t=this.scrollElement)?void 0:t.window)?e:null,this.elementsCache.forEach(e=>{this.observer.observe(e)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,e=>{this.scrollRect=e,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(e,t)=>{this.scrollAdjustments=0,this.scrollDirection=t?this.getScrollOffset()<e?"forward":"backward":null,this.scrollOffset=e,this.isScrolling=t,this.maybeNotify()}))}},this.getSize=()=>{var e;return this.options.enabled?(this.scrollRect=null!=(e=this.scrollRect)?e:this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0)},this.getScrollOffset=()=>{var e;return this.options.enabled?(this.scrollOffset=null!=(e=this.scrollOffset)?e:"function"==typeof this.options.initialOffset?this.options.initialOffset():this.options.initialOffset,this.scrollOffset):(this.scrollOffset=null,0)},this.getFurthestMeasurement=(e,t)=>{const n=new Map,i=new Map;for(let a=t-1;a>=0;a--){const t=e[a];if(n.has(t.lane))continue;const r=i.get(t.lane);if(null==r||t.end>r.end?i.set(t.lane,t):t.end<r.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return i.size===this.options.lanes?Array.from(i.values()).sort((e,t)=>e.end===t.end?e.index-t.index:e.end-t.end)[0]:void 0},this.getMeasurementOptions=oy(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(e,t,n,i,a)=>(this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:t,scrollMargin:n,getItemKey:i,enabled:a}),{key:!1}),this.getMeasurements=oy(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:t,scrollMargin:n,getItemKey:i,enabled:a},r)=>{if(!a)return this.measurementsCache=[],this.itemSizeCache.clear(),[];0===this.measurementsCache.length&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(e=>{this.itemSizeCache.set(e.key,e.size)}));const s=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const o=this.measurementsCache.slice(0,s);for(let l=s;l<e;l++){const e=i(l),a=1===this.options.lanes?o[l-1]:this.getFurthestMeasurement(o,l),s=a?a.end+this.options.gap:t+n,c=r.get(e),d="number"==typeof c?c:this.options.estimateSize(l),u=s+d,h=a?a.lane:l%this.options.lanes;o[l]={index:l,start:s,size:d,end:u,key:e,lane:h}}return this.measurementsCache=o,o},{key:!1,debug:()=>this.options.debug}),this.calculateRange=oy(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,t,n,i)=>this.range=e.length>0&&t>0?function({measurements:e,outerSize:t,scrollOffset:n,lanes:i}){const a=e.length-1,r=t=>e[t].start;if(e.length<=i)return{startIndex:0,endIndex:a};let s=wy(0,a,r,n),o=s;if(1===i)for(;o<a&&e[o].end<n+t;)o++;else if(i>1){const r=Array(i).fill(0);for(;o<a&&r.some(e=>e<n+t);){const t=e[o];r[t.lane]=t.end,o++}const l=Array(i).fill(n+t);for(;s>=0&&l.some(e=>e>=n);){const t=e[s];l[t.lane]=t.start,s--}s=Math.max(0,s-s%i),o=Math.min(a,o+(i-1-o%i))}return{startIndex:s,endIndex:o}}({measurements:e,outerSize:t,scrollOffset:n,lanes:i}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=oy(()=>{let e=null,t=null;const n=this.calculateRange();return n&&(e=n.startIndex,t=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,t]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,t]},(e,t,n,i,a)=>null===i||null===a?[]:e({startIndex:i,endIndex:a,overscan:t,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=e=>{const t=this.options.indexAttribute,n=e.getAttribute(t);return n?parseInt(n,10):-1},this._measureElement=(e,t)=>{const n=this.indexFromElement(e),i=this.measurementsCache[n];if(!i)return;const a=i.key,r=this.elementsCache.get(a);r!==e&&(r&&this.observer.unobserve(r),this.observer.observe(e),this.elementsCache.set(a,e)),e.isConnected&&this.resizeItem(n,this.options.measureElement(e,t,this))},this.resizeItem=(e,t)=>{var n;const i=this.measurementsCache[e];if(!i)return;const a=t-(null!=(n=this.itemSizeCache.get(i.key))?n:i.size);0!==a&&((void 0!==this.shouldAdjustScrollPositionOnItemSizeChange?this.shouldAdjustScrollPositionOnItemSizeChange(i,a,this):i.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=a,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(i.index),this.itemSizeCache=new Map(this.itemSizeCache.set(i.key,t)),this.notify(!1))},this.measureElement=e=>{e?this._measureElement(e,void 0):this.elementsCache.forEach((e,t)=>{e.isConnected||(this.observer.unobserve(e),this.elementsCache.delete(t))})},this.getVirtualItems=oy(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,t)=>{const n=[];for(let i=0,a=e.length;i<a;i++){const a=t[e[i]];n.push(a)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=e=>{const t=this.getMeasurements();if(0!==t.length)return ly(t[wy(0,t.length-1,e=>ly(t[e]).start,e)])},this.getOffsetForAlignment=(e,t,n=0)=>{const i=this.getSize(),a=this.getScrollOffset();"auto"===t&&(t=e>=a+i?"end":"start"),"center"===t?e+=(n-i)/2:"end"===t&&(e-=i);const r=this.getTotalSize()+this.options.scrollMargin-i;return Math.max(Math.min(r,e),0)},this.getOffsetForIndex=(e,t="auto")=>{e=Math.max(0,Math.min(e,this.options.count-1));const n=this.measurementsCache[e];if(!n)return;const i=this.getSize(),a=this.getScrollOffset();if("auto"===t)if(n.end>=a+i-this.options.scrollPaddingEnd)t="end";else{if(!(n.start<=a+this.options.scrollPaddingStart))return[a,t];t="start"}const r="end"===t?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(r,t,n.size),t]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(e,{align:t="start",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode(),this._scrollToOffset(this.getOffsetForAlignment(e,t),{adjustments:void 0,behavior:n})},this.scrollToIndex=(e,{align:t="auto",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode(),e=Math.max(0,Math.min(e,this.options.count-1));let i=0;const a=t=>{if(!this.targetWindow)return;const i=this.getOffsetForIndex(e,t);if(!i)return;const[a,s]=i;this._scrollToOffset(a,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const t=this.getScrollOffset(),n=this.getOffsetForIndex(e,s);var i,a;n&&(i=n[0],a=t,Math.abs(i-a)<1.01||r(s))})},r=e=>{this.targetWindow&&(i++,i<10&&this.targetWindow.requestAnimationFrame(()=>a(e)))};a(t)},this.scrollBy=(e,{behavior:t}={})=>{"smooth"===t&&this.isDynamicMode(),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:t})},this.getTotalSize=()=>{var e,t;const n=this.getMeasurements();let i;if(0===n.length)i=this.options.paddingStart;else if(1===this.options.lanes)i=null!=(e=null==(t=n[n.length-1])?void 0:t.end)?e:0;else{const e=Array(this.options.lanes).fill(null);let t=n.length-1;for(;t>=0&&e.some(e=>null===e);){const i=n[t];null===e[i.lane]&&(e[i.lane]=i.end),t--}i=Math.max(...e.filter(e=>null!==e))}return Math.max(i-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(e,{adjustments:t,behavior:n})=>{this.options.scrollToFn(e,{behavior:n,adjustments:t},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(e)}}const wy=(e,t,n,i)=>{for(;e<=t;){const a=(e+t)/2|0,r=n(a);if(r<i)e=a+1;else{if(!(r>i))return a;t=a-1}}return e>0?e-1:0};function ky(e){return function(e){const t=new by(e),n=t.setOptions;let i;const a=e=>{const a={...t.options,...e,onChange:e.onChange};n({...a,onChange:(e,t)=>{var n;i.set(e),null==(n=a.onChange)||n.call(a,e,t)}}),t._willUpdate()};return i=Fr(t,()=>(a(e),t._didMount())),Br(i,e=>Object.assign(e,{setOptions:a}))}({observeElementRect:py,observeElementOffset:fy,scrollToFn:yy,...e})}const Sy={compact:120,comfortable:180,spacious:240};function xy(e,t="comfortable",n=!0){let i=Sy[t];return i=function(e,t){var n,i,a,r;const s=(null==(n=t.fields)?void 0:n.front)||(null==(i=t.fields)?void 0:i.question)||"",o=(null==(a=t.fields)?void 0:a.back)||(null==(r=t.fields)?void 0:r.answer)||"",l=(s+o).length;return l<50?.8*e:l<200?e:1.5*e}(i,e),n&&(i=function(e,t){var n,i,a,r;const s=(null==(n=t.fields)?void 0:n.front)||(null==(i=t.fields)?void 0:i.question)||"",o=(null==(a=t.fields)?void 0:a.back)||(null==(r=t.fields)?void 0:r.answer)||"",l=s+o;let c=0;const d=l.match(/```[\s\S]*?```/g);d&&d.length>0&&(c+=80);const u=l.match(/!\[.*?\]\(.*?\)|!\[\[.*?\]\]/g);u&&u.length>0&&(c+=120);const h=l.match(/^[\s]*[-*+]|\d+\./gm);h&&h.length>2&&(c+=40);const p=l.match(/^[\s]*>/gm);p&&p.length>0&&(c+=30);return e+c}(i,e)),i=function(e,t){const n=t.tags||[],i=Math.min(n.length,3);return e+8*i}(i,e),function(e){return Math.max(100,Math.min(e,500))}(i)}class _y{constructor(e=1e3){oe(this,"cache"),oe(this,"maxSize"),oe(this,"hits",0),oe(this,"misses",0),this.cache=new Map,this.maxSize=e}get(e){const t=this.cache.get(e);return t?(t.lastAccessed=Date.now(),this.hits++,t.value):(this.misses++,null)}set(e,t){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictLRU(),this.cache.set(e,{key:e,value:t,lastAccessed:Date.now()})}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),this.hits=0,this.misses=0}prune(e){const t=e||Math.floor(.8*this.maxSize);if(this.cache.size<=t)return;const n=Array.from(this.cache.values()).sort((e,t)=>e.lastAccessed-t.lastAccessed),i=this.cache.size-t;for(let a=0;a<i;a++)this.cache.delete(n[a].key)}evictLRU(){let e=null,t=Number.POSITIVE_INFINITY;for(const[n,i]of Array.from(this.cache.entries()))i.lastAccessed<t&&(t=i.lastAccessed,e=n);e&&this.cache.delete(e)}size(){return this.cache.size}getMaxSize(){return this.maxSize}getHitRate(){const e=this.hits+this.misses;return e>0?this.hits/e:0}getStats(){return{size:this.cache.size,maxSize:this.maxSize,hits:this.hits,misses:this.misses,hitRate:this.getHitRate(),utilizationRate:this.cache.size/this.maxSize}}resetStats(){this.hits=0,this.misses=0}getBatch(e){const t=new Map;for(const n of e){const e=this.get(n);null!==e&&t.set(n,e)}return t}setBatch(e){for(const[t,n]of Array.from(e.entries()))this.set(t,n)}}const Cy={showAvatar:!1,showTitle:!0,showContent:!0,showFooter:!0,animationDuration:1500,contentLines:3,enableShimmer:!0};var Iy=la('<div class="skeleton-avatar svelte-1hva2mh"></div>'),Dy=la('<div class="skeleton-title svelte-1hva2mh"></div>'),Ty=la("<div></div>"),My=la('<div class="skeleton-content svelte-1hva2mh"></div>'),Ay=la('<div class="skeleton-footer svelte-1hva2mh"><div class="skeleton-tag svelte-1hva2mh"></div> <div class="skeleton-tag svelte-1hva2mh"></div></div>'),Ey=la('<div role="status" aria-label="加载中..."><div class="skeleton-header svelte-1hva2mh"><!> <!></div> <!> <!></div>');function zy(e,t){if(new.target)return Er({component:zy,...e});kt(t,!0);let n=Ar(t,"config",7),i=Ar(t,"layoutMode",7,"comfortable"),a=Ar(t,"estimatedHeight",7);const r={compact:"0.625rem",comfortable:"0.75rem",spacious:"1rem"},s=In(()=>r[i()]);var o={get config(){return n()},set config(e){n(e),hn()},get layoutMode(){return i()},set layoutMode(e="comfortable"){i(e),hn()},get estimatedHeight(){return a()},set estimatedHeight(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=Ey();let c;var d=Gt(l),u=Gt(d),h=e=>{pa(e,Iy())};xa(u,e=>{n().showAvatar&&e(h)});var p=Kt(u,2),g=e=>{pa(e,Dy())};xa(p,e=>{n().showTitle&&e(g)}),zt(d);var v=Kt(d,2),f=e=>{var t=My();Ca(t,21,()=>Array(n().contentLines||3),_a,(e,t,i)=>{var a=Ty();let r;zi(e=>r=Fa(a,1,"skeleton-line svelte-1hva2mh",null,r,e),[()=>({short:i===(n().contentLines||3)-1})]),pa(e,a)}),zt(t),pa(e,t)};xa(v,e=>{n().showContent&&e(f)});var m=Kt(v,2),y=e=>{pa(e,Ay())};return xa(m,e=>{n().showFooter&&e(y)}),zt(l),zi(e=>{var t,n;c=Fa(l,1,"card-skeleton svelte-1hva2mh",null,c,e),ja(l,`min-height: ${null!=(t=a())?t:""}px; padding: ${null!=(n=bi(s))?n:""};`)},[()=>({"enable-shimmer":n().enableShimmer})]),pa(e,l),St(o)}function Py(e,t){t()&&t()()}var Ry=(e,t,n)=>{!t()||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n())},$y=la('<div class="card-priority svelte-1ivr128"><!></div>'),Oy=la('<div class="card-front svelte-1ivr128"><!></div>'),Ly=la('<div class="card-front-text svelte-1ivr128"> </div>'),Ny=la('<div class="card-back-text svelte-1ivr128"> </div>'),Fy=la('<div class="card-back svelte-1ivr128"><!></div>'),By=la('<span class="card-tag svelte-1ivr128"> </span>'),jy=la('<span class="card-tag-more svelte-1ivr128"> </span>'),Uy=la('<div class="card-tags svelte-1ivr128"><!> <!></div>'),Vy=la('<div><div class="card-header svelte-1ivr128"><div class="card-type svelte-1ivr128"><!> <span> </span></div> <!></div> <!> <!> <div class="card-footer svelte-1ivr128"><!></div></div>'),qy=la('<div class="card-placeholder svelte-1ivr128"><div class="placeholder-content svelte-1ivr128"><span class="placeholder-text svelte-1ivr128"> </span></div></div>'),Hy=la("<div><!></div>");function Wy(e,t){if(new.target)return Er({component:Wy,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"renderMode",7),a=Ar(t,"estimatedHeight",7),r=Ar(t,"onHeightMeasured",7),s=Ar(t,"layoutMode",7,"comfortable"),o=Ar(t,"plugin",7),l=Ar(t,"selected",7,!1),c=Ar(t,"hovered",7,!1),d=Ar(t,"onClick",7),u=Ar(t,"onDoubleClick",7),h=Pn(void 0),p=null;function g(e){var t,i,a,r;return"front"===e?(null==(t=n().fields)?void 0:t.front)||(null==(i=n().fields)?void 0:i.question)||"":(null==(a=n().fields)?void 0:a.back)||(null==(r=n().fields)?void 0:r.answer)||""}function v(){const e=g("front");return e.length>50?e.substring(0,50)+"...":e}function f(){d()&&d()()}Pr(()=>("full"===i()&&bi(h)&&r()&&(p=new ResizeObserver(e=>{for(const t of e){const e=t.contentRect.height;e>0&&r()&&r()(e)}}),p.observe(bi(h))),()=>{p&&(p.disconnect(),p=null)}));var m={get card(){return n()},set card(e){n(e),hn()},get renderMode(){return i()},set renderMode(e){i(e),hn()},get estimatedHeight(){return a()},set estimatedHeight(e){a(e),hn()},get onHeightMeasured(){return r()},set onHeightMeasured(e){r(e),hn()},get layoutMode(){return s()},set layoutMode(e="comfortable"){s(e),hn()},get plugin(){return o()},set plugin(e){o(e),hn()},get selected(){return l()},set selected(e=!1){l(e),hn()},get hovered(){return c()},set hovered(e=!1){c(e),hn()},get onClick(){return d()},set onClick(e){d(e),hn()},get onDoubleClick(){return u()},set onDoubleClick(e){u(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=Hy();let b;y.__click=f,y.__dblclick=[Py,u],y.__keydown=[Ry,d,f];var w=Gt(y),k=e=>{var t=Vy();let i;var a=Gt(t),r=Gt(a),l=Gt(r);Ng(l,{name:"file-text",size:14});var c=Kt(l,2),d=Gt(c,!0);zt(c),zt(r);var u=Kt(r,2),h=e=>{var t=$y();Ng(Gt(t),{name:"flag",size:12}),zt(t),pa(e,t)};xa(u,e=>{n().priority&&n().priority>2&&e(h)}),zt(a);var p=Kt(a,2),v=e=>{var t=Oy(),i=Gt(t);{let e=In(()=>g("front")),t=In(()=>{var e;return String((null==(e=n().fields)?void 0:e.source_document)||"")});sy(i,{get plugin(){return o()},get source(){return bi(e)},get sourcePath(){return bi(t)}})}zt(t),pa(e,t)},f=e=>{var t=Ly(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>g("front")]),pa(e,t)};xa(p,e=>{o()&&g("front")?e(v):e(f,!1)});var m=Kt(p,2),y=e=>{var t=Fy(),i=Gt(t),a=e=>{{let t=In(()=>g("back")),i=In(()=>{var e;return String((null==(e=n().fields)?void 0:e.source_document)||"")});sy(e,{get plugin(){return o()},get source(){return bi(t)},get sourcePath(){return bi(i)}})}},r=e=>{var t=Ny(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>g("back")]),pa(e,t)};xa(i,e=>{o()?e(a):e(r,!1)}),zt(t),pa(e,t)};xa(m,e=>{g("back")&&e(y)});var b=Kt(m,2),w=Gt(b),k=e=>{var t=Uy(),i=Gt(t);Ca(i,17,()=>n().tags.slice(0,3),_a,(e,t)=>{var n=By(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)});var a=Kt(i,2),r=e=>{var t=jy(),i=Gt(t);zt(t),zi(()=>va(i,"+"+(n().tags.length-3))),pa(e,t)};xa(a,e=>{n().tags.length>3&&e(r)}),zt(t),pa(e,t)};xa(w,e=>{n().tags&&n().tags.length>0&&e(k)}),zt(b),zt(t),zi(e=>{i=Fa(t,1,"card-full-content svelte-1ivr128",null,i,e),va(d,n().type)},[()=>({"layout-compact":"compact"===s(),"layout-comfortable":"comfortable"===s(),"layout-spacious":"spacious"===s()})]),pa(e,t)},S=e=>{var t=ha(),n=Qt(t),r=e=>{zy(e,{get config(){return Cy},get layoutMode(){return s()},get estimatedHeight(){return a()}})},o=e=>{var t=qy(),n=Gt(t),i=Gt(n),r=Gt(i,!0);zt(i),zt(n),zt(t),zi(e=>{var n;ja(t,`height: ${null!=(n=a())?n:""}px;`),va(r,e)},[v]),pa(e,t)};xa(n,e=>{"skeleton"===i()?e(r):e(o,!1)},!0),pa(e,t)};return xa(w,e=>{"full"===i()?e(k):e(S,!1)}),zt(y),kr(y,e=>$n(h,e),()=>bi(h)),zi(e=>{var t;b=Fa(y,1,"virtual-card-wrapper svelte-1ivr128",null,b,e),ja(y,`min-height: ${null!=(t="placeholder"===i()?a():0)?t:""}px;`),er(y,"role",d()?"button":"article"),er(y,"tabindex",d()?0:-1)},[()=>({selected:l(),hovered:c(),"full-render":"full"===i(),"skeleton-render":"skeleton"===i(),"placeholder-render":"placeholder"===i()})]),pa(e,y),St(m)}ia(["click","dblclick","keydown"]);var Gy=la('<div role="listitem" draggable="true"><!></div>'),Qy=la('<div class="virtual-column-container svelte-1ht4vru"></div>'),Ky=la('<div class="virtual-column-loading svelte-1ht4vru"><p>初始化虚拟滚动...</p></div>'),Zy=la('<div class="virtual-kanban-column-scroll svelte-1ht4vru" style="height: 100%; max-height: 100%; overflow-y: auto; overflow-x: hidden;"><!></div>');function Yy(e,t){if(new.target)return Er({component:Yy,...e});kt(t,!0);let n,i=Ar(t,"cards",7),a=Ar(t,"groupKey",7),r=Ar(t,"columnConfig",7),s=Ar(t,"onCardSelect",7),o=Ar(t,"onCardUpdate",7),l=Ar(t,"onCardDelete",7),c=Ar(t,"plugin",7),d=Ar(t,"layoutMode",7,"comfortable"),u=Pn(void 0),h=Pn(null),p=Pn(null),g=Pn(Ot(new Set));n=new _y(50*r().overscan);let v=Pn(null),f=Pn(0);function m(){if(bi(u))if(0!==i().length)try{$n(v,ky({count:i().length,getScrollElement:()=>bi(u),estimateSize:e=>k(e),overscan:r().overscan,measureElement:e=>{const t=e.getBoundingClientRect().height,a=e.getAttribute("data-index");if(a){const e=i()[parseInt(a)];e&&n.set(e.uuid,t)}return t}}),!0),$n(f,i().length,!0),_e.debug(`[VirtualKanbanColumn] 虚拟化器初始化成功: ${i().length} 张卡片`)}catch(e){_e.error("[VirtualKanbanColumn] 虚拟化器初始化失败:",e),$n(v,null)}else _e.warn("[VirtualKanbanColumn] 卡片列表为空，跳过初始化");else _e.warn("[VirtualKanbanColumn] scrollElement 未就绪，跳过初始化")}var y;y=()=>{const e=i().length;bi(v)&&e!==bi(f)&&e>0&&(_e.debug(`[VirtualKanbanColumn] 卡片数量变化: ${bi(f)} -> ${e}`),m())},Ci(),Ii(1048584,y,!0);const b=In(()=>{if(!bi(v))return[];try{return bi(v).getVirtualItems()}catch(e){return _e.warn("Failed to get virtual items:",e),[]}}),w=In(()=>{if(!bi(v))return 0;try{return bi(v).getTotalSize()}catch(e){return _e.warn("Failed to get total size:",e),0}});function k(e){const t=i()[e];if(!t)return r().estimatedItemSize;const a=n.get(t.uuid);return null!==a?a:xy(t,d(),!0)}Pr(()=>(_e.debug(`[VirtualKanbanColumn] 挂载列 ${a()}，卡片数: ${i().length}`),yi().then(()=>{bi(u)&&i().length>0?m():_e.warn("[VirtualKanbanColumn] 初始化条件不满足:",{hasScrollElement:!!bi(u),cardCount:i().length})}),()=>{n.clear(),_e.debug(`[VirtualKanbanColumn] 清理列 ${a()}`)}));var S={get cards(){return i()},set cards(e){i(e),hn()},get groupKey(){return a()},set groupKey(e){a(e),hn()},get columnConfig(){return r()},set columnConfig(e){r(e),hn()},get onCardSelect(){return s()},set onCardSelect(e){s(e),hn()},get onCardUpdate(){return o()},set onCardUpdate(e){o(e),hn()},get onCardDelete(){return l()},set onCardDelete(e){l(e),hn()},get plugin(){return c()},set plugin(e){c(e),hn()},get layoutMode(){return d()},set layoutMode(e="comfortable"){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},x=Zy(),_=Gt(x),C=e=>{var t=Qy();Ca(t,21,()=>bi(b),e=>e.key,(e,t)=>{const a=In(()=>i()[bi(t).index]),o=In(()=>function(e){var t,n;if(!bi(v))return"skeleton";const i=bi(v).getVirtualItems();if(new Set(i.map(e=>e.index)).has(e))return"full";const a=Math.max(0,(null==(t=i[0])?void 0:t.index)-r().overscan),s=(null==(n=i[i.length-1])?void 0:n.index)+r().overscan;return e>=a&&e<=s?"skeleton":"placeholder"}(bi(t).index)),l=In(()=>bi(g).has(bi(a).uuid)),u=In(()=>bi(p)===bi(a).uuid),f=In(()=>bi(h)===bi(a).uuid);var m=Gy();let y;var b=Gt(m);{let e=In(()=>k(bi(t).index));Wy(b,{get card(){return bi(a)},get renderMode(){return bi(o)},get estimatedHeight(){return bi(e)},onHeightMeasured:e=>function(e,t){n.set(e,t),bi(v)&&bi(v).measure()}(bi(a).uuid,e),get layoutMode(){return d()},get plugin(){return c()},get selected(){return bi(l)},get hovered(){return bi(u)},onClick:()=>function(e){bi(g).has(e.uuid)?bi(g).delete(e.uuid):bi(g).add(e.uuid),$n(g,new Set(bi(g)),!0)}(bi(a)),onDoubleClick:()=>function(e){s()&&s()(e)}(bi(a))})}zt(m),zi(e=>{var n;er(m,"data-index",bi(t).index),er(m,"data-card-id",bi(a).uuid),y=Fa(m,1,"virtual-card-item svelte-1ht4vru",null,y,e),ja(m,`\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            transform: translateY(${null!=(n=bi(t).start)?n:""}px);\n          `)},[()=>({dragging:bi(f)})]),na("dragstart",m,e=>{var t;t=bi(a).uuid,$n(h,t,!0),e.dataTransfer&&(e.dataTransfer.setData("application/x-tuanki-kanban-card",bi(a).uuid),e.dataTransfer.effectAllowed="move")}),na("dragend",m,()=>{$n(h,null)}),na("mouseenter",m,()=>{return e=bi(a).uuid,void $n(p,e,!0);var e}),na("mouseleave",m,()=>{$n(p,null)}),pa(e,m)}),zt(t),zi(()=>{var e;return ja(t,`\n        height: ${null!=(e=bi(w))?e:""}px;\n        width: 100%;\n        position: relative;\n      `)}),pa(e,t)},I=e=>{pa(e,Ky())};return xa(_,e=>{bi(v)?e(C):e(I,!1)}),zt(x),kr(x,e=>$n(u,e),()=>bi(u)),pa(e,x),St(S)}const Xy="tuanki-virtualization-config",Jy={enabled:!0,strategy:"virtual",estimatedItemSize:200,overscan:5,measurementCache:!0,autoTriggerThreshold:200,initialCardsPerColumn:30,batchSize:20,enableColumnVirtualization:!0,releaseThreshold:1e3,columnScrollBehavior:"independent"},eb={enabled:!1,strategy:"none",estimatedItemSize:60,overscan:5,measurementCache:!0,autoTriggerThreshold:200,rowHeight:"dynamic",enableVirtualScroll:!1,fallbackToPagination:!0,paginationThreshold:500};class tb{static getKanbanConfig(){const e=this.loadFromStorage();return(null==e?void 0:e.kanban)?{...Jy,...e.kanban}:{...Jy}}static getTableConfig(){const e=this.loadFromStorage();return(null==e?void 0:e.table)?{...eb,...e.table}:{...eb}}static shouldEnableVirtualization(e,t){if(!("kanban"===t?this.getKanbanConfig():this.getTableConfig()).enabled)return!1;switch(t){case"kanban":return e>200;case"table":return e>500;case"grid":return e>300;default:return!1}}static getOptimalStrategy(e){return e<100?"immediate":e<500?"progressive":"virtual"}static updateKanbanConfig(e){const t={...this.getKanbanConfig(),...e},n=this.loadFromStorage()||{};n.kanban=t,this.saveToStorage(n)}static updateTableConfig(e){const t={...this.getTableConfig(),...e},n=this.loadFromStorage()||{};n.table=t,this.saveToStorage(n)}static resetToDefaults(){const e={kanban:Jy,table:eb};this.saveToStorage(e)}static loadFromStorage(){try{const e=localStorage.getItem(Xy);if(e)return JSON.parse(e)}catch(e){_e.error("[VirtualizationConfigManager] 加载配置失败:",e)}return null}static saveToStorage(e){try{localStorage.setItem(Xy,JSON.stringify(e)),_e.debug("[VirtualizationConfigManager] 配置已保存")}catch(t){_e.error("[VirtualizationConfigManager] 保存配置失败:",t)}}static getAllConfigs(){return{kanban:this.getKanbanConfig(),table:this.getTableConfig()}}static calculateRecommendedOverscan(e,t,n){const i=Math.ceil(t/n);return Math.max(3,Math.min(10,Math.ceil(.5*i)))}static validateConfig(e){return"boolean"==typeof e.enabled&&(!!["none","progressive","virtual"].includes(e.strategy)&&(!("number"!=typeof e.estimatedItemSize||e.estimatedItemSize<=0)&&!("number"!=typeof e.overscan||e.overscan<0)))}}function nb(e){return e?e.replace(/\{\{c\d+::([^}:]+)(?:::[^}]+)?\}\}/g,"$1"):e}function ib(e,t){e.stopPropagation(),$n(t,!bi(t))}function ab(e,t,n,i){var a;e.stopPropagation(),$n(t,!1),null==(a=n())||a(i())}function rb(e,t,n,i){var a;e.stopPropagation(),$n(t,!1),null==(a=n())||a(i())}function sb(e,t,n,i){var a;e.stopPropagation(),$n(t,!1),null==(a=n())||a(i())}var ob=(e,t)=>"Enter"===e.key&&t(e),lb=la('<div class="selected-indicator svelte-1upy7re"><div class="checkmark-circle svelte-1upy7re"><!></div></div>'),cb=la('<button class="action-menu-item svelte-1upy7re" title="编辑"><!></button>'),db=la('<button class="action-menu-item danger svelte-1upy7re" title="删除"><!></button>'),ub=la('<button class="action-menu-item svelte-1upy7re" title="查看"><!></button>'),hb=la('<div class="action-menu svelte-1upy7re"><button class="action-menu-item close-menu svelte-1upy7re" title="关闭"><!></button> <!> <!> <!></div>'),pb=la('<div class="skeleton-line svelte-1upy7re"></div> <div class="skeleton-line svelte-1upy7re"></div> <div class="skeleton-line svelte-1upy7re"></div>',1),gb=la("<span> </span>"),vb=la('<span class="tag-more svelte-1upy7re"> </span>'),fb=la('<div class="card-tags svelte-1upy7re"><!> <!></div>'),mb=la('<div class="card-source svelte-1upy7re"><!> <span class="svelte-1upy7re"> </span></div>'),yb=la('<div class="selected-overlay svelte-1upy7re"></div>'),bb=la('<div role="button" tabindex="0"><!> <div class="card-uuid svelte-1upy7re"> </div> <div class="card-actions svelte-1upy7re"><button class="menu-button svelte-1upy7re" title="更多操作"><!></button> <!></div> <div class="card-body svelte-1upy7re"><div><!></div></div> <div class="card-footer svelte-1upy7re"><!> <!></div> <!></div>');function wb(e,t){if(new.target)return Er({component:wb,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"selected",7,!1),a=Ar(t,"plugin",7),r=Ar(t,"layoutMode",7,"fixed"),s=Ar(t,"viewContext",7,"grid"),o=Ar(t,"onClick",7),l=Ar(t,"onEdit",7),c=Ar(t,"onDelete",7),d=Ar(t,"onView",7),u=Pn(void 0),h=Pn(!1),p=null,g=Pn(!1),v=Pn(!1),f=null;const m=In(()=>{var e,t;return(null==(e=n().fields)?void 0:e.front)||(null==(t=n().fields)?void 0:t.question)||""}),y=In(()=>{var e,t;return(null==(e=n().fields)?void 0:e.back)||(null==(t=n().fields)?void 0:t.answer)||""}),b=In(()=>n().tags||[]),w=In(()=>{var e;return(null==(e=n().fields)?void 0:e.source_document)||""}),k=In(()=>()=>{if(n().content&&n().content.trim())return nb(n().content);const e=bi(m).trim(),t=bi(y).trim();if(!e&&!t)return"";if(!t)return nb(e);return nb(`${e}\n\n---\n\n${t}`)}),S=In(()=>()=>{var e,t;if(null==(e=n().fields)?void 0:e.source_document){const e=n().fields.source_document;return e.endsWith(".md")?e:`${e}.md`}return(null==(t=n().customFields)?void 0:t.obsidianFilePath)?n().customFields.obsidianFilePath:""});const x=In(()=>()=>{const e=n().uuid;return e.length>12?`${e.slice(0,8)}...${e.slice(-4)}`:e});function _(e){var t;e.target.closest(".card-tags, .card-source, .card-actions")||(p?(clearTimeout(p),p=null,null==(t=l())||t(n())):p=setTimeout(()=>{var e;null==(e=o())||e(n()),p=null},250))}Pr(async()=>{await yi();const e=bi(k)();bi(u)&&e&&(f=await async function(e,t,i){var r;if(!e||!t||!(null==(r=a())?void 0:r.app))return null;$n(h,!0),e.innerHTML="";try{i&&i.unload();const r=new ge.Component;return await ge.MarkdownRenderer.render(a().app,t,e,bi(S)(),r),r.load(),_e.debug("[GridCard] Markdown 渲染成功",{cardId:n().uuid,sourcePath:bi(S)(),contentLength:t.length}),r}catch(s){return _e.error("[GridCard] Markdown 渲染失败:",s),e.textContent=t,null}finally{$n(h,!1)}}(bi(u),e,f))}),Rr(()=>{f&&(f.unload(),f=null)});var C={get card(){return n()},set card(e){n(e),hn()},get selected(){return i()},set selected(e=!1){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get layoutMode(){return r()},set layoutMode(e="fixed"){r(e),hn()},get viewContext(){return s()},set viewContext(e="grid"){s(e),hn()},get onClick(){return o()},set onClick(e){o(e),hn()},get onEdit(){return l()},set onEdit(e){l(e),hn()},get onDelete(){return c()},set onDelete(e){c(e),hn()},get onView(){return d()},set onView(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},I=bb();let D;I.__click=_,I.__keydown=[ob,_];var T=Gt(I),M=e=>{var t=lb(),n=Gt(t);Ng(Gt(n),{name:"check",size:14}),zt(n),zt(t),pa(e,t)};xa(T,e=>{i()&&e(M)});var A=Kt(T,2),E=Gt(A,!0);zt(A);var z=Kt(A,2),P=Gt(z);P.__click=[ib,v],Ng(Gt(P),{name:"more-horizontal",size:16}),zt(P);var R=Kt(P,2),$=e=>{var t=hb(),i=Gt(t);i.__click=[ib,v],Ng(Gt(i),{name:"x",size:16}),zt(i);var a=Kt(i,2),r=e=>{var t=cb();t.__click=[ab,v,l,n],Ng(Gt(t),{name:"edit",size:16}),zt(t),pa(e,t)};xa(a,e=>{l()&&e(r)});var s=Kt(a,2),o=e=>{var t=db();t.__click=[rb,v,c,n],Ng(Gt(t),{name:"trash-2",size:16}),zt(t),pa(e,t)};xa(s,e=>{c()&&e(o)});var u=Kt(s,2),h=e=>{var t=ub();t.__click=[sb,v,d,n],Ng(Gt(t),{name:"eye",size:16}),zt(t),pa(e,t)};xa(u,e=>{d()&&e(h)}),zt(t),pa(e,t)};xa(R,e=>{bi(v)&&e($)}),zt(z);var O=Kt(z,2),L=Gt(O);let N;var F=Gt(L),B=e=>{var t=pb();Pt(4),pa(e,t)};xa(F,e=>{bi(h)&&e(B)}),zt(L),kr(L,e=>$n(u,e),()=>bi(u)),zt(O);var j=Kt(O,2),U=Gt(j),V=e=>{var t=fb(),n=Gt(t);Ca(n,17,()=>bi(b).slice(0,3),_a,(e,t)=>{var n=gb(),i=Gt(n,!0);zt(n),zi(e=>{Fa(n,1,`tag tag-${null!=e?e:""}`,"svelte-1upy7re"),va(i,bi(t))},[()=>function(e){const t=["blue","purple","pink","red","orange","green","cyan","gray"];let n=0;for(let i=0;i<e.length;i++)n=e.charCodeAt(i)+((n<<5)-n);return t[Math.abs(n)%t.length]}(bi(t))]),pa(e,n)});var i=Kt(n,2),a=e=>{var t=vb(),n=Gt(t);zt(t),zi(()=>va(n,"+"+(bi(b).length-3))),pa(e,t)};xa(i,e=>{bi(b).length>3&&e(a)}),zt(t),pa(e,t)};xa(U,e=>{bi(b).length>0&&e(V)});var q=Kt(U,2),H=e=>{var t=mb(),n=Gt(t);Ng(n,{name:"file-text",size:12});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(()=>va(a,bi(w))),pa(e,t)};xa(q,e=>{bi(w)&&e(H)}),zt(j);var W=Kt(j,2),G=e=>{pa(e,yb())};return xa(W,e=>{i()&&e(G)}),zt(I),zi((e,t,n)=>{D=Fa(I,1,"grid-card svelte-1upy7re",null,D,e),va(E,t),N=Fa(L,1,"content-area markdown-rendered svelte-1upy7re",null,N,n)},[()=>({selected:i(),hovered:bi(g),"fixed-height":"fixed"===r(),masonry:"masonry"===r(),"grid-card--kanban":"kanban"===s()}),()=>bi(x)(),()=>({rendering:bi(h)})]),na("mouseenter",I,function(){$n(g,!0)}),na("mouseleave",I,function(){$n(g,!1),$n(v,!1)}),pa(e,I),St(C)}function kb(e,t){"groupby"===bi(t)||"sort"===bi(t)?$n(t,"main"):"sort-add"===bi(t)&&$n(t,"sort")}function Sb(e,t){e.target===e.currentTarget&&t()}ia(["click","keydown"]);var xb=(e,t)=>$n(t,!bi(t)),_b=(e,t)=>{"Escape"===e.key&&t()},Cb=(e,t)=>$n(t,"groupby"),Ib=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),$n(t,"groupby"))},Db=(e,t)=>$n(t,"sort"),Tb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),$n(t,"sort"))},Mb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},Ab=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},Eb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},zb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},Pb=(e,t,n)=>{e.stopPropagation(),t(bi(n).key)},Rb=la('<div role="button" tabindex="0" draggable="true"><div class="notion-drag-handle svelte-79ivf0">⋮⋮</div> <div class="notion-group-name svelte-79ivf0"> </div> <div class="notion-group-actions svelte-79ivf0"><button><!></button></div></div>'),$b=la('<div class="notion-menu-header svelte-79ivf0"><div class="notion-menu-title svelte-79ivf0"><!> <span class="svelte-79ivf0">视图选项</span></div> <button class="notion-close-btn svelte-79ivf0"><!></button></div> <div class="notion-menu-row notion-menu-row--clickable svelte-79ivf0" role="button" tabindex="0"><span class="notion-menu-label svelte-79ivf0">分组方式</span> <div class="notion-menu-value svelte-79ivf0"><span class="svelte-79ivf0"> </span> <!></div></div> <div class="notion-menu-row notion-menu-row--clickable svelte-79ivf0" role="button" tabindex="0"><span class="notion-menu-label svelte-79ivf0">排序</span> <div class="notion-menu-value svelte-79ivf0"><span class="svelte-79ivf0"> </span> <!></div></div> <div class="notion-divider svelte-79ivf0"></div> <div class="notion-menu-row svelte-79ivf0"><span class="notion-menu-label svelte-79ivf0">隐藏空白分组</span> <div role="switch" aria-label="切换隐藏空白分组" tabindex="0"><div class="notion-toggle-thumb svelte-79ivf0"></div></div></div> <div class="notion-menu-row svelte-79ivf0"><span class="notion-menu-label svelte-79ivf0">填充列背景颜色</span> <div role="switch" aria-label="切换填充列背景颜色" tabindex="0"><div class="notion-toggle-thumb svelte-79ivf0"></div></div></div> <div class="notion-divider svelte-79ivf0"></div> <div class="notion-section-header svelte-79ivf0"><span class="notion-section-title svelte-79ivf0">群组</span> <div class="notion-action-group svelte-79ivf0"><span class="notion-section-action svelte-79ivf0" role="button" tabindex="0">重置</span> <span class="notion-separator svelte-79ivf0">·</span> <span class="notion-section-action svelte-79ivf0" role="button" tabindex="0"> </span></div></div> <div class="notion-menu-content svelte-79ivf0"></div>',1),Ob=(e,t)=>t("status"),Lb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t("status"))},Nb=(e,t)=>t("type"),Fb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t("type"))},Bb=(e,t)=>t("priority"),jb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t("priority"))},Ub=(e,t)=>t("deck"),Vb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t("deck"))},qb=(e,t)=>t("createTime"),Hb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t("createTime"))},Wb=la('<div class="notion-menu-header svelte-79ivf0"><button class="notion-back-btn svelte-79ivf0"><!> <span class="svelte-79ivf0">分组方式</span></button> <button class="notion-close-btn svelte-79ivf0"><!></button></div> <div class="notion-menu-content svelte-79ivf0"><div role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0">学习状态</span></div> <!></div> <div role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0">题型</span></div> <!></div> <div role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0">优先级</span></div> <!></div> <div role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0">牌组</span></div> <!></div> <div role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0">创建时间</span></div> <!></div></div>',1),Gb=la('<div role="button" tabindex="0" draggable="true"><div class="notion-drag-handle svelte-79ivf0">⋮⋮</div> <div class="notion-sort-rule-content svelte-79ivf0"><!> <span class="svelte-79ivf0"> </span></div> <button class="notion-sort-direction-btn svelte-79ivf0"><!></button> <button class="notion-icon-btn svelte-79ivf0" title="删除排序规则"><!></button></div>'),Qb=la('<div class="notion-sort-rules-list svelte-79ivf0"></div> <div class="notion-divider svelte-79ivf0"></div>',1),Kb=(e,t)=>$n(t,"sort-add"),Zb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),$n(t,"sort-add"))},Yb=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},Xb=la('<div class="notion-divider svelte-79ivf0"></div> <div class="notion-menu-row notion-menu-row--clickable notion-menu-row--danger svelte-79ivf0" role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0">清除所有排序</span></div></div>',1),Jb=la('<div class="notion-menu-header svelte-79ivf0"><button class="notion-back-btn svelte-79ivf0"><!> <span class="svelte-79ivf0">排序</span></button> <button class="notion-close-btn svelte-79ivf0"><!></button></div> <div class="notion-menu-content svelte-79ivf0"><!> <div class="notion-menu-row notion-menu-row--clickable svelte-79ivf0" role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0">添加排序规则</span></div> <!></div> <!></div>',1),ew=(e,t,n)=>t(bi(n).key,"asc"),tw=(e,t,n)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t(bi(n).key,"asc"))},nw=(e,t,n)=>{e.stopPropagation(),t(bi(n).key,"asc")},iw=(e,t,n)=>{e.stopPropagation(),t(bi(n).key,"desc")},aw=la('<div class="notion-sort-option-group svelte-79ivf0"><div class="notion-menu-row notion-menu-row--option svelte-79ivf0" role="button" tabindex="0"><div class="notion-option-content svelte-79ivf0"><!> <span class="svelte-79ivf0"> </span></div> <div class="notion-sort-direction-options svelte-79ivf0"><button class="notion-direction-btn svelte-79ivf0" title="升序"><!></button> <button class="notion-direction-btn svelte-79ivf0" title="降序"><!></button></div></div></div>'),rw=la('<div class="notion-menu-header svelte-79ivf0"><button class="notion-back-btn svelte-79ivf0"><!> <span class="svelte-79ivf0">选择属性</span></button> <button class="notion-close-btn svelte-79ivf0"><!></button></div> <div class="notion-menu-content svelte-79ivf0"></div>',1),sw=la('<div class="tuanki-column-menu-overlay svelte-79ivf0" role="presentation"><div class="tuanki-column-menu svelte-79ivf0" role="dialog" aria-label="列设置" tabindex="-1"><!> <!> <!> <!></div></div>'),ow=(e,t,n)=>t(bi(n).key),lw=la('<span class="tuanki-due-badge svelte-79ivf0"> </span>'),cw=la('<span class="tuanki-selected-badge svelte-79ivf0"> </span>'),dw=la('<div class="tuanki-column-stats svelte-79ivf0"><div class="tuanki-progress-bar svelte-79ivf0"><div class="tuanki-progress-fill svelte-79ivf0"></div></div> <div class="tuanki-stats-text svelte-79ivf0"><!> <!></div></div>'),uw=la('<div class="tuanki-drop-indicator svelte-79ivf0"></div>'),hw=la('<!> <div role="listitem" draggable="true"><!></div>',1),pw=(e,t,n)=>t(bi(n).key),gw=la('<div class="tuanki-load-more-container svelte-79ivf0"><button class="tuanki-load-more-btn svelte-79ivf0"><!> </button></div>'),vw=la("<!> <!>",1),fw=la('<div class="tuanki-kanban-column svelte-79ivf0" role="region"><div><div class="tuanki-column-title-row svelte-79ivf0"><div class="tuanki-title-content svelte-79ivf0"><!> <span class="svelte-79ivf0"> </span> <span class="tuanki-column-count svelte-79ivf0"> </span></div> <button class="tuanki-column-action tuanki-select-all svelte-79ivf0" title="全选此分组"><!></button></div> <!></div> <div role="list"><!></div></div>'),mw=la('<div class="tuanki-kanban-view svelte-79ivf0"><button title="列设置" style="display: none;"><!></button> <!> <div><!></div></div>');function yw(e,t){if(new.target)return Er({component:yw,...e});kt(t,!0);let n=Ar(t,"cards",7),i=Ar(t,"dataStorage",7),a=Ar(t,"plugin",7),r=Ar(t,"decks",23,()=>[]),s=Ar(t,"onCardSelect",7),o=Ar(t,"onCardUpdate",7),l=Ar(t,"onCardDelete",7),c=Ar(t,"onStartStudy",7),d=Ar(t,"groupBy",7,"status"),u=Ar(t,"showStats",7,!0),h=Ar(t,"layoutMode",7,"comfortable");let p=Pn(Ot(tb.getKanbanConfig()));let g=Pn(Ot(new Set)),v=Pn(null),f=Pn(null),m=Pn(Ot({})),y=Pn(null),b=Pn(-1),w=Pn(Ot({})),k=Pn(!1),S=Pn("main"),x=Pn(null),_=Pn(null);const C={status:"学习状态",type:"题型",priority:"优先级",deck:"牌组",createTime:"创建时间"},I=In(()=>C[d()]||d()),D={created:{key:"created",label:"创建时间",icon:"calendar"},due:{key:"due",label:"到期时间",icon:"clock"},modified:{key:"modified",label:"修改时间",icon:"history"},priority:{key:"priority",label:"优先级",icon:"flag"},difficulty:{key:"difficulty",label:"难度",icon:"chart-bar"},title:{key:"title",label:"标题",icon:"heading"}};let T=In(n),M=In(()=>bi(f)?bi(f).groupCards(n(),d()):{});const A={status:{title:"按学习状态分组",icon:"layers",groups:[{key:"0",label:"新卡片",color:"#6b7280",icon:"plus-circle"},{key:"1",label:"学习中",color:"#3b82f6",icon:"book-open"},{key:"2",label:"复习",color:"#10b981",icon:"refresh-cw"},{key:"3",label:"重新学习",color:"#f59e0b",icon:"rotate-ccw"}]},type:{title:"按题型分组",icon:"grid",groups:[{key:"basic",label:"基础问答",color:"var(--interactive-accent)",icon:"file-text"},{key:"cloze",label:"挖空填词",color:"#ec4899",icon:"edit"},{key:"multiple",label:"多选题",color:"#06b6d4",icon:"check-circle"},{key:"code",label:"代码题",color:"#84cc16",icon:"code"}]},priority:{title:"按优先级分组",icon:"flag",groups:[{key:"4",label:"高优先级",color:"#ef4444",icon:"alert-triangle"},{key:"3",label:"中优先级",color:"#f59e0b",icon:"flag"},{key:"2",label:"低优先级",color:"#10b981",icon:"minus-circle"},{key:"1",label:"无优先级",color:"#6b7280",icon:"circle"}]},deck:{title:"按牌组分组",icon:"folder",groups:[]},createTime:{title:"按创建时间分组",icon:"calendar",groups:[{key:"today",label:"今天",color:"#3b82f6",icon:"calendar"},{key:"yesterday",label:"昨天",color:"#10b981",icon:"calendar"},{key:"last7days",label:"过去7天",color:"#f59e0b",icon:"calendar"},{key:"last30days",label:"过去30天",color:"#ec4899",icon:"calendar"},{key:"earlier",label:"更早",color:"#6b7280",icon:"calendar"}]}},E=In(()=>{if("deck"===d()&&bi(f)){return{title:"按牌组分组",icon:"folder",groups:bi(f).getDeckGroups(bi(T))}}return A[d()]}),z=In(()=>{const e=U();let t=bi(E).groups.filter(t=>!e.hidden.includes(t.key));return e.hideEmptyGroups&&(t=t.filter(e=>(bi(M)[e.key]||[]).length>0)),t.sort((t,n)=>{const i=e.order.indexOf(t.key),a=e.order.indexOf(n.key);return-1===i&&-1===a?0:-1===i?1:-1===a?-1:i-a})}),P=In(()=>bi(z));function R(e){if(!bi(p).enabled)return!1;if(!bi(p).enableColumnVirtualization)return!1;return(bi(M)[e]||[]).length>200}function $(){const e={};bi(E).groups.forEach(t=>{e[t.key]=20}),$n(m,e,!0)}function O(e,t,n){var i,a,r,s;switch(n){case"created":return new Date(e.created).getTime()-new Date(t.created).getTime();case"due":return e.fsrs&&t.fsrs?new Date(e.fsrs.due).getTime()-new Date(t.fsrs.due).getTime():0;case"modified":return new Date(e.modified).getTime()-new Date(t.modified).getTime();case"priority":return(t.priority||0)-(e.priority||0);case"difficulty":return e.fsrs&&t.fsrs?(e.fsrs.difficulty||0)-(t.fsrs.difficulty||0):0;case"title":const n=(null==(i=e.fields)?void 0:i.front)||(null==(a=e.fields)?void 0:a.question)||"",o=(null==(r=t.fields)?void 0:r.front)||(null==(s=t.fields)?void 0:s.question)||"";return n.localeCompare(o,"zh-CN");default:return 0}}function L(e){const t=bi(M)[e]||[],n=U(),i=(a=t,0===(r=n.sortRules).length?a:[...a].sort((e,t)=>{for(const n of r){const i=O(e,t,n.property);if(0!==i)return"asc"===n.direction?i:-i}return 0}));var a,r;const s=bi(m)[e]||20;return i.slice(0,s)}function N(e){const t=bi(m)[e]||20,n=(bi(M)[e]||[]).length,i=Math.min(t+20,n);bi(m)[e]=i}function F(e){if(Array.isArray(e))return e;if(e&&"object"==typeof e)try{return Array.from(e)}catch(t){return[]}return[]}function B(e){if(e&&"object"==typeof e&&!Array.isArray(e)){if(e instanceof Map||e.entries&&"function"==typeof e.entries)try{return Object.fromEntries(e)}catch(t){return{}}return e}return{}}function j(e){const t=A[e];if(!t)return{hidden:[],colors:{},order:[],hideEmptyGroups:!1,useColoredBackground:!0,sortMode:"manual",sortRules:[]};return{hidden:[],colors:{},order:("deck"===e&&bi(f)?bi(f).getDeckGroups(bi(T)):t.groups).map(e=>e.key),hideEmptyGroups:!1,useColoredBackground:!0,sortMode:"manual",sortRules:[]}}function U(){var e,t,n;const i=bi(w)[d()];return i?{hidden:F(i.hidden),colors:B(i.colors),order:Array.isArray(i.order)?i.order:[],hideEmptyGroups:null!=(e=i.hideEmptyGroups)&&e,useColoredBackground:null==(t=i.useColoredBackground)||t,sortMode:null!=(n=i.sortMode)?n:"manual",sortRules:Array.isArray(i.sortRules)?i.sortRules:[]}:j(d())}function V(){var e,t,n;bi(w)[d()]||(bi(w)[d()]=j(d()));const i=bi(w)[d()];return bi(w)[d()]={hidden:F(i.hidden),colors:B(i.colors),order:Array.isArray(i.order)?i.order:[],hideEmptyGroups:null!=(e=i.hideEmptyGroups)&&e,useColoredBackground:null==(t=i.useColoredBackground)||t,sortMode:null!=(n=i.sortMode)?n:"manual",sortRules:Array.isArray(i.sortRules)?i.sortRules:[]},bi(w)[d()]}function q(e){const t=V();t.hidden.includes(e)?t.hidden=t.hidden.filter(t=>t!==e):t.hidden=[...t.hidden,e],ie()}function H(){bi(W)?(V().hidden=[],ie()):(V().hidden=bi(E).groups.map(e=>e.key),ie())}Ti(()=>{d()&&!bi(w)[d()]&&(bi(w)[d()]=j(d()))});const W=In(()=>{const e=U(),t=bi(E).groups.length;return e.hidden.length>=t});function G(){bi(w)[d()]=j(d()),ie()}function Q(){const e=V();e.hideEmptyGroups=!e.hideEmptyGroups,ie()}function K(){const e=V();e.useColoredBackground=!e.useColoredBackground,ie()}function Z(){$n(k,!1),$n(S,"main")}function Y(e){d(e),$(),$n(S,"main"),ie()}function X(e,t){V().sortRules.push({property:e,direction:t}),ie(),$n(S,"sort")}function J(){V().sortRules=[],ie()}let ee=Pn(-1),te=Pn(-1);function ne(){$n(x,null),$n(_,null)}function ie(){try{localStorage.setItem("tuanki-kanban-column-config-v4",JSON.stringify(bi(w)))}catch(e){_e.error("[KanbanView] 保存列配置失败:",e)}}function ae(e){const t=bi(M)[e]||[];t.length>0&&t.every(e=>bi(g).has(e.uuid))?t.forEach(e=>bi(g).delete(e.uuid)):t.forEach(e=>bi(g).add(e.uuid)),$n(g,new Set(bi(g)),!0)}function re(){$n(v,null),$n(y,null),$n(b,-1)}function se(e,t,n=-1){e.preventDefault(),$n(y,t,!0),$n(b,n,!0)}function oe(){$n(y,null),$n(b,-1)}async function le(e){var t,n;if(bi(v)&&bi(f))try{const i=bi(T).find(e=>e.uuid===bi(v).uuid);if(!i)return;const r=function(e){switch(d()){case"status":return e.fsrs?String(e.fsrs.state):"0";case"type":return e.type;case"priority":return String(e.priority||1);case"deck":return e.deckId||"_none";case"createTime":return function(e){const t=new Date,n=new Date(e),i=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(i.getTime()-864e5),r=new Date(i.getTime()-6048e5),s=new Date(i.getTime()-2592e6);return n>=i?"today":n>=a?"yesterday":n>=r?"last7days":n>=s?"last30days":"earlier"}(e.created);default:return""}}(i),s=function(e,t){if(e===t)return{allowed:!0};switch(d()){case"status":return{allowed:!1,reason:"学习状态由FSRS6算法自动管理，无法手动修改。\n请通过学习功能来更新卡片状态。"};case"type":return{allowed:!1,reason:"卡片类型无法通过拖拽修改"};case"createTime":return{allowed:!1,reason:"创建时间无法修改"};default:return{allowed:!0}}}(r,e);if(!s.allowed)return void(s.reason&&(t=s.reason,(null==(n=a())?void 0:n.app)?new(a().app.Notice)(t,4e3):alert(t)));let l=null;switch(d()){case"status":case"type":case"createTime":break;case"priority":const t=parseInt(e);l={...i,priority:t};break;case"deck":const n="_none"===e?"":e;l={...i,deckId:n}}l&&o()&&await o()(l)}catch(i){_e.error("拖拽更新失败:",i)}finally{$n(v,null)}}Pr(async()=>{$n(f,new ay(i()),!0),r()&&r().length>0&&bi(f).setDecks(r());try{const e="tuanki-kanban-collapsed-columns";localStorage.getItem(e)&&localStorage.removeItem(e)}catch(e){}!function(){try{const e=localStorage.getItem("tuanki-kanban-column-config-v2"),t=localStorage.getItem("tuanki-kanban-column-config-v3");let n=localStorage.getItem("tuanki-kanban-column-config-v4");if(!n&&(e||t)){const n=t||e;if(n){_e.debug("[KanbanView] 从旧版本迁移配置...");const i=JSON.parse(n),a={};return Object.keys(i).forEach(e=>{var t,n,r;const s=i[e];a[e]={hidden:F(s.hidden),colors:B(s.colors),order:Array.isArray(s.order)?s.order:[],hideEmptyGroups:null!=(t=s.hideEmptyGroups)&&t,useColoredBackground:null==(n=s.useColoredBackground)||n,sortMode:null!=(r=s.sortMode)?r:"manual",sortRules:Array.isArray(s.sortRules)?s.sortRules:[]}}),$n(w,a,!0),ie(),e&&localStorage.removeItem("tuanki-kanban-column-config-v2"),t&&localStorage.removeItem("tuanki-kanban-column-config-v3"),void _e.debug("[KanbanView] 配置迁移完成")}}if(n){const e=JSON.parse(n),t={};Object.keys(e).forEach(n=>{var i,a,r;const s=e[n];t[n]={hidden:F(s.hidden),colors:B(s.colors),order:Array.isArray(s.order)?s.order:[],hideEmptyGroups:null!=(i=s.hideEmptyGroups)&&i,useColoredBackground:null==(a=s.useColoredBackground)||a,sortMode:null!=(r=s.sortMode)?r:"manual",sortRules:Array.isArray(s.sortRules)?s.sortRules:[]}}),$n(w,t,!0)}}catch(e){_e.error("[KanbanView] 加载列配置失败:",e),$n(w,{},!0)}}(),$()}),Ti(()=>{bi(f)&&r()&&r().length>0&&bi(f).setDecks(r())});var ce={get cards(){return n()},set cards(e){n(e),hn()},get dataStorage(){return i()},set dataStorage(e){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get decks(){return r()},set decks(e=[]){r(e),hn()},get onCardSelect(){return s()},set onCardSelect(e){s(e),hn()},get onCardUpdate(){return o()},set onCardUpdate(e){o(e),hn()},get onCardDelete(){return l()},set onCardDelete(e){l(e),hn()},get onStartStudy(){return c()},set onStartStudy(e){c(e),hn()},get groupBy(){return d()},set groupBy(e="status"){d(e),hn()},get showStats(){return u()},set showStats(e=!0){u(e),hn()},get layoutMode(){return h()},set layoutMode(e="comfortable"){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},de=mw(),ue=Gt(de);let he;ue.__click=[xb,k],Ng(Gt(ue),{name:"sliders",size:"16"}),zt(ue);var pe=Kt(ue,2),ge=e=>{var t=sw();t.__click=[Sb,Z],t.__keydown=[_b,Z];var n=Gt(t),i=Gt(n),a=e=>{var t=$b(),n=Qt(t),i=Gt(n);Ng(Gt(i),{name:"sliders",size:"14"}),Pt(2),zt(i);var a=Kt(i,2);a.__click=Z,Ng(Gt(a),{name:"x",size:"14"}),zt(a),zt(n);var r=Kt(n,2);r.__click=[Cb,S],r.__keydown=[Ib,S];var s=Kt(Gt(r),2),o=Gt(s),l=Gt(o,!0);zt(o),Ng(Kt(o,2),{name:"chevron-right",size:"12"}),zt(s),zt(r);var c=Kt(r,2);c.__click=[Db,S],c.__keydown=[Tb,S];var d=Kt(Gt(c),2),u=Gt(d),h=Gt(u,!0);zt(u),Ng(Kt(u,2),{name:"chevron-right",size:"12"}),zt(d),zt(c);var p=Kt(c,4),g=Kt(Gt(p),2);g.__click=Q,g.__keydown=[Mb,Q],zt(p);var v=Kt(p,2),f=Kt(Gt(v),2);f.__click=K,f.__keydown=[Ab,K],zt(v);var m=Kt(v,4),y=Kt(Gt(m),2),b=Gt(y);b.__click=G,b.__keydown=[Eb,G];var w=Kt(b,4);w.__click=H,w.__keydown=[zb,H];var k=Gt(w,!0);zt(w),zt(y),zt(m);var C=Kt(m,2);Ca(C,21,()=>bi(E).groups,e=>e.key,(e,t)=>{const n=In(U),i=In(()=>bi(n).hidden.includes(bi(t).key));var a=Rb();let r;var s=Kt(Gt(a),2),o=Gt(s,!0);zt(s);var l=Kt(s,2),c=Gt(l);let d;c.__click=[Pb,q,t];var u=Gt(c);{let e=In(()=>bi(i)?"eye-off":"eye");Ng(u,{get name(){return bi(e)},size:"12"})}zt(c),zt(l),zt(a),zi((e,n)=>{r=Fa(a,1,"notion-group-item svelte-79ivf0",null,r,e),va(o,bi(t).label),d=Fa(c,1,"notion-icon-btn svelte-79ivf0",null,d,n),er(c,"title",bi(i)?"显示列":"隐藏列")},[()=>({dragging:bi(x)===bi(t).key,"drag-over":bi(_)===bi(t).key}),()=>({active:!bi(i)})]),na("dragstart",a,()=>function(e){$n(x,e,!0)}(bi(t).key)),na("dragover",a,e=>function(e,t){e.preventDefault(),bi(x)&&bi(x)!==t&&$n(_,t,!0)}(e,bi(t).key)),na("drop",a,()=>function(e){if(!bi(x)||bi(x)===e)return void ne();const t=V(),n=[...t.order],i=n.indexOf(bi(x)),a=n.indexOf(e);-1!==i&&-1!==a?(n.splice(i,1),n.splice(a,0,bi(x)),t.order=n,ie(),ne()):ne()}(bi(t).key)),na("dragend",a,ne),pa(e,a)}),zt(C),zi((e,t,n,i,a)=>{va(l,bi(I)),va(h,e),Fa(g,1,`notion-toggle-mini ${null!=t?t:""}`,"svelte-79ivf0"),er(g,"aria-checked",n),Fa(f,1,`notion-toggle-mini ${null!=i?i:""}`,"svelte-79ivf0"),er(f,"aria-checked",a),er(w,"title",bi(W)?"显示所有列":"隐藏所有列"),va(k,bi(W)?"全部显示":"全部隐藏")},[()=>U().sortRules.length>0?`${U().sortRules.length} 条规则`:"无",()=>U().hideEmptyGroups?"active":"",()=>U().hideEmptyGroups,()=>U().useColoredBackground?"active":"",()=>U().useColoredBackground]),pa(e,t)};xa(i,e=>{"main"===bi(S)&&e(a)});var r=Kt(i,2),s=e=>{var t=Wb(),n=Qt(t),i=Gt(n);i.__click=[kb,S],Ng(Gt(i),{name:"arrow-left",size:"14"}),Pt(2),zt(i);var a=Kt(i,2);a.__click=Z,Ng(Gt(a),{name:"x",size:"14"}),zt(a),zt(n);var r=Kt(n,2),s=Gt(r);let o;s.__click=[Ob,Y],s.__keydown=[Lb,Y];var l=Gt(s);Ng(Gt(l),{name:"layers",size:"14"}),Pt(2),zt(l);var c=Kt(l,2),u=e=>{Ng(e,{name:"check",size:"14"})};xa(c,e=>{"status"===d()&&e(u)}),zt(s);var h=Kt(s,2);let p;h.__click=[Nb,Y],h.__keydown=[Fb,Y];var g=Gt(h);Ng(Gt(g),{name:"grid",size:"14"}),Pt(2),zt(g);var v=Kt(g,2),f=e=>{Ng(e,{name:"check",size:"14"})};xa(v,e=>{"type"===d()&&e(f)}),zt(h);var m=Kt(h,2);let y;m.__click=[Bb,Y],m.__keydown=[jb,Y];var b=Gt(m);Ng(Gt(b),{name:"flag",size:"14"}),Pt(2),zt(b);var w=Kt(b,2),k=e=>{Ng(e,{name:"check",size:"14"})};xa(w,e=>{"priority"===d()&&e(k)}),zt(m);var x=Kt(m,2);let _;x.__click=[Ub,Y],x.__keydown=[Vb,Y];var C=Gt(x);Ng(Gt(C),{name:"folder",size:"14"}),Pt(2),zt(C);var I=Kt(C,2),D=e=>{Ng(e,{name:"check",size:"14"})};xa(I,e=>{"deck"===d()&&e(D)}),zt(x);var T=Kt(x,2);let M;T.__click=[qb,Y],T.__keydown=[Hb,Y];var A=Gt(T);Ng(Gt(A),{name:"calendar",size:"14"}),Pt(2),zt(A);var E=Kt(A,2),z=e=>{Ng(e,{name:"check",size:"14"})};xa(E,e=>{"createTime"===d()&&e(z)}),zt(T),zt(r),zi((e,t,n,i,a)=>{o=Fa(s,1,"notion-menu-row notion-menu-row--option svelte-79ivf0",null,o,e),p=Fa(h,1,"notion-menu-row notion-menu-row--option svelte-79ivf0",null,p,t),y=Fa(m,1,"notion-menu-row notion-menu-row--option svelte-79ivf0",null,y,n),_=Fa(x,1,"notion-menu-row notion-menu-row--option svelte-79ivf0",null,_,i),M=Fa(T,1,"notion-menu-row notion-menu-row--option svelte-79ivf0",null,M,a)},[()=>({"notion-menu-row--selected":"status"===d()}),()=>({"notion-menu-row--selected":"type"===d()}),()=>({"notion-menu-row--selected":"priority"===d()}),()=>({"notion-menu-row--selected":"deck"===d()}),()=>({"notion-menu-row--selected":"createTime"===d()})]),pa(e,t)};xa(r,e=>{"groupby"===bi(S)&&e(s)});var o=Kt(r,2),l=e=>{var t=Jb(),n=Qt(t),i=Gt(n);i.__click=[kb,S],Ng(Gt(i),{name:"arrow-left",size:"14"}),Pt(2),zt(i);var a=Kt(i,2);a.__click=Z,Ng(Gt(a),{name:"x",size:"14"}),zt(a),zt(n);var r=Kt(n,2),s=Gt(r),o=e=>{var t=Qb(),n=Qt(t);Ca(n,21,()=>U().sortRules,_a,(e,t,n)=>{const i=In(()=>D[bi(t).property]);var a=Gb();let r;var s=Kt(Gt(a),2),o=Gt(s);Ng(o,{get name(){return bi(i).icon},size:"12"});var l=Kt(o,2),c=Gt(l,!0);zt(l),zt(s);var d=Kt(s,2);d.__click=e=>{e.stopPropagation(),function(e){const t=V().sortRules[e];t&&(t.direction="asc"===t.direction?"desc":"asc",ie())}(n)};var u=Gt(d);{let e=In(()=>"asc"===bi(t).direction?"chevron-up":"chevron-down");Ng(u,{get name(){return bi(e)},size:"12"})}zt(d);var h=Kt(d,2);h.__click=e=>{e.stopPropagation(),function(e){V().sortRules.splice(e,1),ie()}(n)},Ng(Gt(h),{name:"x",size:"12"}),zt(h),zt(a),zi(e=>{r=Fa(a,1,"notion-sort-rule-item svelte-79ivf0",null,r,e),va(c,bi(i).label),er(d,"title","asc"===bi(t).direction?"升序":"降序")},[()=>({dragging:bi(ee)===n,"drag-over":bi(te)===n})]),na("dragstart",a,()=>function(e){$n(ee,e,!0)}(n)),na("dragover",a,e=>function(e,t){e.preventDefault(),-1!==bi(ee)&&bi(ee)!==t&&$n(te,t,!0)}(e,n)),na("drop",a,()=>function(e){if(-1===bi(ee)||bi(ee)===e)return $n(ee,-1),void $n(te,-1);const t=V(),n=[...t.sortRules],[i]=n.splice(bi(ee),1);n.splice(e,0,i),t.sortRules=n,ie(),$n(ee,-1),$n(te,-1)}(n)),na("dragend",a,()=>{$n(ee,-1),$n(te,-1)}),pa(e,a)}),zt(n),Pt(2),pa(e,t)};xa(s,e=>{U().sortRules.length>0&&e(o)});var l=Kt(s,2);l.__click=[Kb,S],l.__keydown=[Zb,S];var c=Gt(l);Ng(Gt(c),{name:"plus",size:"14"}),Pt(2),zt(c),Ng(Kt(c,2),{name:"chevron-right",size:"12"}),zt(l);var d=Kt(l,2),u=e=>{var t=Xb(),n=Kt(Qt(t),2);n.__click=J,n.__keydown=[Yb,J];var i=Gt(n);Ng(Gt(i),{name:"refresh-cw",size:"14"}),Pt(2),zt(i),zt(n),pa(e,t)};xa(d,e=>{U().sortRules.length>0&&e(u)}),zt(r),pa(e,t)};xa(o,e=>{"sort"===bi(S)&&e(l)});var c=Kt(o,2),u=e=>{var t=rw(),n=Qt(t),i=Gt(n);i.__click=[kb,S],Ng(Gt(i),{name:"arrow-left",size:"14"}),Pt(2),zt(i);var a=Kt(i,2);a.__click=Z,Ng(Gt(a),{name:"x",size:"14"}),zt(a),zt(n);var r=Kt(n,2);Ca(r,21,()=>Object.values(D),e=>e.key,(e,t)=>{var n=aw(),i=Gt(n);i.__click=[ew,X,t],i.__keydown=[tw,X,t];var a=Gt(i),r=Gt(a);Ng(r,{get name(){return bi(t).icon},size:"14"});var s=Kt(r,2),o=Gt(s,!0);zt(s),zt(a);var l=Kt(a,2),c=Gt(l);c.__click=[nw,X,t],Ng(Gt(c),{name:"chevron-up",size:"10"}),zt(c);var d=Kt(c,2);d.__click=[iw,X,t],Ng(Gt(d),{name:"chevron-down",size:"10"}),zt(d),zt(l),zt(i),zt(n),zi(()=>va(o,bi(t).label)),pa(e,n)}),zt(r),pa(e,t)};xa(c,e=>{"sort-add"===bi(S)&&e(u)}),zt(n),zt(t),pa(e,t)};xa(pe,e=>{bi(k)&&e(ge)});var ve=Kt(pe,2);let fe;var me=Gt(ve),ye=e=>{var t=ha();Ca(Qt(t),17,()=>bi(P),e=>e.key,(e,t)=>{const n=In(()=>function(e){const t=bi(M)[e]||[],n=t.length,i=t.filter(e=>bi(g).has(e.uuid)).length,a=new Date;return{total:n,selected:i,due:t.filter(e=>e.fsrs&&new Date(e.fsrs.due)<=a).length}}(bi(t).key));var i=fw(),r=Gt(i);let c;var d=Gt(r),f=Gt(d),w=Gt(f);Ng(w,{get name(){return bi(t).icon},size:"18"});var k=Kt(w,2),S=Gt(k,!0);zt(k);var x=Kt(k,2),_=Gt(x);zt(x),zt(f);var C=Kt(f,2);C.__click=[ow,ae,t],Ng(Gt(C),{name:"check-square",size:"14"}),zt(C),zt(d);var I=Kt(d,2),D=e=>{var t=dw(),i=Gt(t),a=Gt(i);zt(i);var r=Kt(i,2),s=Gt(r),o=e=>{var t=lw(),i=Gt(t);zt(t),zi(()=>{var e;return va(i,`${null!=(e=bi(n).due)?e:""} 到期`)}),pa(e,t)};xa(s,e=>{bi(n).due>0&&e(o)});var l=Kt(s,2),c=e=>{var t=cw(),i=Gt(t);zt(t),zi(()=>{var e;return va(i,`${null!=(e=bi(n).selected)?e:""} 已选`)}),pa(e,t)};xa(l,e=>{bi(n).selected>0&&e(c)}),zt(r),zt(t),zi(()=>ja(a,`width: ${bi(n).total>0?bi(n).due/bi(n).total*100:0}%`)),pa(e,t)};xa(I,e=>{u()&&e(D)}),zt(r);var T=Kt(r,2);let A;var E=Gt(T),z=e=>{{let n=In(()=>bi(M)[bi(t).key]||[]);Yy(e,{get cards(){return bi(n)},get groupKey(){return bi(t).key},get columnConfig(){return bi(p)},get onCardSelect(){return s()},get onCardUpdate(){return o()},get onCardDelete(){return l()},get plugin(){return a()},get layoutMode(){return h()}})}},P=e=>{var n=vw(),i=Qt(n);Ca(i,19,()=>L(bi(t).key),e=>e.uuid,(e,n,i)=>{var r=hw(),o=Qt(r),c=e=>{pa(e,uw())};xa(o,e=>{bi(v)&&bi(y)===bi(t).key&&bi(b)===bi(i)&&e(c)});var d=Kt(o,2);let u;var h=Gt(d);{let e=In(()=>bi(g).has(bi(n).uuid));wb(h,{get card(){return bi(n)},get selected(){return bi(e)},get plugin(){return a()},layoutMode:"masonry",viewContext:"kanban",onClick:()=>function(e){bi(g).has(e.uuid)?bi(g).delete(e.uuid):bi(g).add(e.uuid),$n(g,new Set(bi(g)),!0)}(bi(n)),onEdit:()=>{var e;return null==(e=s())?void 0:e(bi(n))},onDelete:()=>function(e){l()&&l()(e.uuid)}(bi(n)),onView:()=>{var e;return null==(e=s())?void 0:e(bi(n))}})}zt(d),zi(e=>u=Fa(d,1,"tuanki-kanban-card-wrapper svelte-79ivf0",null,u,e),[()=>{var e;return{dragging:(null==(e=bi(v))?void 0:e.uuid)===bi(n).uuid}}]),na("dragstart",d,e=>function(e,t){$n(v,t,!0),e.dataTransfer&&(e.dataTransfer.setData("application/x-tuanki-kanban-card",t.uuid),e.dataTransfer.effectAllowed="move")}(e,bi(n))),na("dragend",d,re),na("dragover",d,e=>se(e,bi(t).key,bi(i))),pa(e,r)});var r=Kt(i,2),o=e=>{var n=gw(),i=Gt(n);i.__click=[pw,N,t];var a=Gt(i);Ng(a,{name:"chevron-down",size:16});var r=Kt(a);zt(i),zt(n),zi(()=>va(r,` 加载更多 (${(bi(M)[bi(t).key]||[]).length-(bi(m)[bi(t).key]||20)} 张剩余)`)),pa(e,n)};xa(r,e=>{L(bi(t).key).length<(bi(M)[bi(t).key]||[]).length&&e(o)}),pa(e,n)};xa(E,e=>{R(bi(t).key)?e(z):e(P,!1)}),zt(T),zt(i),zi((e,a,s)=>{var o;er(i,"aria-label",`${bi(t).label}分组`),c=Fa(r,1,"tuanki-column-header svelte-79ivf0",null,c,e),ja(r,`--group-color: ${null!=a?a:""}`),va(S,bi(t).label),va(_,`(${null!=(o=bi(n).total)?o:""})`),A=Fa(T,1,"tuanki-column-content svelte-79ivf0",null,A,s)},[()=>({"colored-bg":U().useColoredBackground}),()=>{return e=bi(t).key,n=bi(t).color,U().colors[e]||n;var e,n},()=>({"drag-over":bi(y)===bi(t).key,virtualized:R(bi(t).key)})]),na("drop",i,()=>le(bi(t).key)),na("dragover",i,e=>e.preventDefault()),na("dragover",T,e=>se(e,bi(t).key)),na("dragleave",T,oe),na("drop",T,()=>le(bi(t).key)),pa(e,i)}),pa(e,t)};return xa(me,e=>{bi(f)&&e(ye)}),zt(ve),zt(de),zi((e,t)=>{he=Fa(ue,1,"tuanki-hidden-column-btn svelte-79ivf0",null,he,e),fe=Fa(ve,1,"tuanki-kanban-board svelte-79ivf0",null,fe,t)},[()=>({active:bi(k)}),()=>({"layout-compact":"compact"===h(),"layout-comfortable":"comfortable"===h(),"layout-spacious":"spacious"===h()})]),pa(e,de),St(ce)}function bw(e,t,n){var i;e.stopPropagation(),null==(i=t())||i(n())}function ww(e,t,n){var i;e.stopPropagation(),null==(i=t())||i(n())}function kw(e,t,n){var i;e.stopPropagation(),null==(i=t())||i(n())}ia(["click","keydown"]);var Sw=(e,t)=>"Enter"===e.key&&t(e),xw=la('<div class="selected-indicator svelte-1ngcbl4"><div class="checkmark-circle svelte-1ngcbl4"><!></div></div>'),_w=la('<div class="card-attribute svelte-1ngcbl4"><!> <span class="svelte-1ngcbl4"> </span></div>'),Cw=la('<button class="action-menu-item svelte-1ngcbl4" title="编辑"><!></button>'),Iw=la('<button class="action-menu-item danger svelte-1ngcbl4" title="删除"><!></button>'),Dw=la('<button class="action-menu-item svelte-1ngcbl4" title="查看"><!></button>'),Tw=la('<div class="content-area markdown-rendered svelte-1ngcbl4"></div>'),Mw=la('<div class="skeleton-placeholder svelte-1ngcbl4"><div class="skeleton-line svelte-1ngcbl4"></div> <div class="skeleton-line short svelte-1ngcbl4"></div> <div class="skeleton-line svelte-1ngcbl4"></div> <div class="skeleton-line medium svelte-1ngcbl4"></div></div>'),Aw=la("<span> </span>"),Ew=la('<span class="tag-more svelte-1ngcbl4"> </span>'),zw=la('<div class="card-tags svelte-1ngcbl4"><!> <!></div>'),Pw=la('<div class="card-source svelte-1ngcbl4"><!> <span class="svelte-1ngcbl4"> </span></div>'),Rw=la('<div class="card-footer svelte-1ngcbl4"><!> <!></div>'),$w=la('<div class="selected-overlay svelte-1ngcbl4"></div>'),Ow=la('<div role="button" tabindex="0"><!> <!> <div><!> <!> <!></div> <div class="card-body svelte-1ngcbl4"><!></div> <!> <!></div>');function Lw(e,t){if(new.target)return Er({component:Lw,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"selected",7,!1),a=Ar(t,"plugin",7),r=Ar(t,"layoutMode",7,"fixed"),s=Ar(t,"attributeType",7,"uuid"),o=Ar(t,"onClick",7),l=Ar(t,"onEdit",7),c=Ar(t,"onDelete",7),d=Ar(t,"onView",7),u=Pn(void 0),h=Pn(void 0),p=Pn(!1),g=Pn(!1),v=null,f=Pn(!1),m=null,y=null;const b=In(()=>{var e,t;return(null==(e=n().fields)?void 0:e.front)||(null==(t=n().fields)?void 0:t.question)||""}),w=In(()=>{var e,t;return(null==(e=n().fields)?void 0:e.back)||(null==(t=n().fields)?void 0:t.answer)||""}),k=In(()=>n().tags||[]),S=In(()=>{var e;return(null==(e=n().fields)?void 0:e.source_document)||""}),x=In(()=>()=>{if(n().content&&n().content.trim())return nb(n().content);const e=bi(b).trim(),t=bi(w).trim();if(!e&&!t)return"";if(!t)return nb(e);return nb(`${e}\n\n---\n\n${t}`)}),_=In(()=>()=>{var e,t;if(null==(e=n().fields)?void 0:e.source_document){const e=n().fields.source_document;return e.endsWith(".md")?e:`${e}.md`}return(null==(t=n().customFields)?void 0:t.obsidianFilePath)?n().customFields.obsidianFilePath:""});const C=In(()=>()=>{const e=n().uuid;return e.length>12?`${e.slice(0,8)}...${e.slice(-4)}`:e}),I=In(()=>()=>{var e;if("none"===s())return null;switch(s()){case"uuid":return{label:"ID",value:bi(C)(),icon:"hash"};case"source":const t=bi(S)||"未知来源";return{label:"来源",value:t.length>20?t.slice(0,20)+"...":t,icon:"file-text"};case"priority":const i=n().priority||0;return{label:"优先级",value:3===i?"高":2===i?"中":1===i?"低":"无",icon:"flag"};case"retention":return{label:"记忆率",value:`${(null==(e=n().fsrs)?void 0:e.retrievability)?Math.round(100*n().fsrs.retrievability):0}%`,icon:"activity"};case"modified":const a=n().modified||n().created||(new Date).toISOString(),r=new Date(a);return{label:"修改",value:`${r.getMonth()+1}/${r.getDate()}`,icon:"clock"};default:return null}});function D(e){var t;e.target.closest(".card-tags, .card-source, .card-actions")||(v?(clearTimeout(v),v=null,null==(t=l())||t(n())):v=setTimeout(()=>{var e;null==(e=o())||e(n()),v=null},250))}Ti(()=>{bi(p)&&bi(h)&&!m&&setTimeout(()=>{!async function(){var e;if(bi(h)&&(null==(e=a())?void 0:e.app)&&!bi(g)&&!m){$n(g,!0);try{bi(h).innerHTML="";const e=new ge.Component,t=bi(x)();await ge.MarkdownRenderer.render(a().app,t,bi(h),bi(_)(),e),e.load(),m=e}catch(t){_e.error("[LazyGridCard] Render failed:",t),bi(h)&&(bi(h).textContent=bi(x)())}finally{$n(g,!1)}}}()},0)}),Pr(()=>{if(bi(u))return y=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&!bi(p)&&($n(p,!0),null==y||y.disconnect())})},{root:null,rootMargin:"500px",threshold:0}),y.observe(bi(u)),()=>{null==y||y.disconnect(),null==m||m.unload(),v&&clearTimeout(v)}}),Rr(()=>{null==y||y.disconnect(),null==m||m.unload()});var T={get card(){return n()},set card(e){n(e),hn()},get selected(){return i()},set selected(e=!1){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get layoutMode(){return r()},set layoutMode(e="fixed"){r(e),hn()},get attributeType(){return s()},set attributeType(e="uuid"){s(e),hn()},get onClick(){return o()},set onClick(e){o(e),hn()},get onEdit(){return l()},set onEdit(e){l(e),hn()},get onDelete(){return c()},set onDelete(e){c(e),hn()},get onView(){return d()},set onView(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},M=Ow();let A;M.__click=D,M.__keydown=[Sw,D];var E=Gt(M),z=e=>{var t=xw(),n=Gt(t);Ng(Gt(n),{name:"check",size:14}),zt(n),zt(t),pa(e,t)};xa(E,e=>{i()&&e(z)});var P=Kt(E,2),R=e=>{var t=_w(),n=Gt(t);{let e=In(()=>{var e;return(null==(e=bi(I)())?void 0:e.icon)||"tag"});Ng(n,{get name(){return bi(e)},size:12})}var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi((e,n)=>{er(t,"title",e),va(a,n)},[()=>{var e;return null==(e=bi(I)())?void 0:e.label},()=>{var e;return null==(e=bi(I)())?void 0:e.value}]),pa(e,t)};xa(P,e=>{bi(I)()&&e(R)});var $=Kt(P,2);let O;var L=Gt($),N=e=>{var t=Cw();t.__click=[bw,l,n],Ng(Gt(t),{name:"edit",size:16}),zt(t),pa(e,t)};xa(L,e=>{l()&&e(N)});var F=Kt(L,2),B=e=>{var t=Iw();t.__click=[ww,c,n],Ng(Gt(t),{name:"trash-2",size:16}),zt(t),pa(e,t)};xa(F,e=>{c()&&e(B)});var j=Kt(F,2),U=e=>{var t=Dw();t.__click=[kw,d,n],Ng(Gt(t),{name:"eye",size:16}),zt(t),pa(e,t)};xa(j,e=>{d()&&e(U)}),zt($);var V=Kt($,2),q=Gt(V),H=e=>{var t=Tw();kr(t,e=>$n(h,e),()=>bi(h)),pa(e,t)},W=e=>{pa(e,Mw())};xa(q,e=>{bi(p)?e(H):e(W,!1)}),zt(V);var G=Kt(V,2),Q=e=>{var t=Rw(),n=Gt(t),i=e=>{var t=zw(),n=Gt(t);Ca(n,17,()=>bi(k).slice(0,3),_a,(e,t)=>{var n=Aw(),i=Gt(n,!0);zt(n),zi(e=>{Fa(n,1,`tag tag-${null!=e?e:""}`,"svelte-1ngcbl4"),va(i,bi(t))},[()=>function(e){const t=["blue","purple","pink","red","orange","green","cyan","gray"];let n=0;for(let i=0;i<e.length;i++)n=e.charCodeAt(i)+((n<<5)-n);return t[Math.abs(n)%t.length]}(bi(t))]),pa(e,n)});var i=Kt(n,2),a=e=>{var t=Ew(),n=Gt(t);zt(t),zi(()=>va(n,"+"+(bi(k).length-3))),pa(e,t)};xa(i,e=>{bi(k).length>3&&e(a)}),zt(t),pa(e,t)};xa(n,e=>{bi(k).length>0&&e(i)});var a=Kt(n,2),r=e=>{var t=Pw(),n=Gt(t);Ng(n,{name:"file-text",size:12});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(()=>va(a,bi(S))),pa(e,t)};xa(a,e=>{bi(S)&&e(r)}),zt(t),pa(e,t)};xa(G,e=>{(bi(k).length>0||bi(S))&&e(Q)});var K=Kt(G,2),Z=e=>{pa(e,$w())};return xa(K,e=>{i()&&e(Z)}),zt(M),kr(M,e=>$n(u,e),()=>bi(u)),zi((e,t)=>{A=Fa(M,1,"lazy-grid-card svelte-1ngcbl4",null,A,e),O=Fa($,1,"card-actions svelte-1ngcbl4",null,O,t)},[()=>({selected:i(),hovered:bi(f),"fixed-height":"fixed"===r(),masonry:"masonry"===r(),rendering:bi(g)}),()=>({hovered:bi(f)})]),na("mouseenter",M,function(){$n(f,!0)}),na("mouseleave",M,function(){$n(f,!1)}),pa(e,M),St(T)}ia(["click","keydown"]);var Nw=la('<div class="tuanki-loading-state"><div class="tuanki-spinner"></div> <p>加载中...</p></div>'),Fw=la('<div class="loading-more svelte-y6nqlq"><div class="tuanki-spinner-small"></div> <span>加载更多...</span></div>'),Bw=la('<div class="load-more-sentinel svelte-y6nqlq"><!></div>'),jw=la('<div class="performance-hint svelte-y6nqlq"><!> <span> </span></div>'),Uw=la("<div></div> <!> <!>",1),Vw=la('<div class="grid-view svelte-y6nqlq"><!></div>');function qw(e,t){if(new.target)return Er({component:qw,...e});kt(t,!0);let n,i=Ar(t,"cards",7),a=Ar(t,"selectedCards",7),r=Ar(t,"plugin",7),s=Ar(t,"layoutMode",7,"fixed"),o=Ar(t,"attributeType",7,"uuid"),l=Ar(t,"onCardClick",7),c=Ar(t,"onCardEdit",7),d=Ar(t,"onCardDelete",7),u=Ar(t,"onCardView",7),h=Ar(t,"loading",7,!1),p=Pn(void 0),g=Pn(30),v=Pn(!1),f=Pn(void 0),m=null,y=Pn(4),b=0;const w=In(()=>i().length>100),k=In(()=>bi(w)?i():i().slice(0,bi(g))),S=In(()=>!bi(w)&&bi(g)<i().length);function x(){bi(w)||(m=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&bi(S)&&!bi(v)&&!bi(v)&&bi(S)&&($n(v,!0),setTimeout(()=>{$n(g,Math.min(bi(g)+30,i().length),!0),$n(v,!1)},100))})},{root:n,rootMargin:"200px",threshold:.1}),bi(f)&&m.observe(bi(f)))}function _(e){var t;null==(t=l())||t(e)}function C(e){var t;null==(t=c())||t(e)}function I(e){if(Math.abs(e-b)<10)return;let t;b=e,t=e>=1400?4:e>=1024?3:e>=768?2:1,t!==bi(y)&&$n(y,t,!0)}Pr(()=>{let e=null;return yi().then(()=>{x(),setTimeout(()=>{e=function(){if(!bi(p))return null;let e=null;const t=new ResizeObserver(t=>{null!==e&&cancelAnimationFrame(e),e=requestAnimationFrame(()=>{for(const e of t)I(e.contentRect.width);e=null})});return t.observe(bi(p)),requestAnimationFrame(()=>{bi(p)&&I(bi(p).clientWidth)}),t}()},100)}),()=>{m&&m.disconnect(),e&&e.disconnect()}}),Ti(()=>{bi(w)||$n(g,Math.min(30,i().length),!0)});var D={get cards(){return i()},set cards(e){i(e),hn()},get selectedCards(){return a()},set selectedCards(e){a(e),hn()},get plugin(){return r()},set plugin(e){r(e),hn()},get layoutMode(){return s()},set layoutMode(e="fixed"){s(e),hn()},get attributeType(){return o()},set attributeType(e="uuid"){o(e),hn()},get onCardClick(){return l()},set onCardClick(e){l(e),hn()},get onCardEdit(){return c()},set onCardEdit(e){c(e),hn()},get onCardDelete(){return d()},set onCardDelete(e){d(e),hn()},get onCardView(){return u()},set onCardView(e){u(e),hn()},get loading(){return h()},set loading(e=!1){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},T=Vw(),M=Gt(T),A=e=>{pa(e,Nw())},E=e=>{var t=Uw(),n=Qt(t);let l;Ca(n,21,()=>bi(k),e=>e.uuid||"unknown",(e,t)=>{{let n=In(()=>{return e=bi(t).uuid,a().has(e);var e});Lw(e,{get card(){return bi(t)},get selected(){return bi(n)},get plugin(){return r()},get layoutMode(){return s()},get attributeType(){return o()},onClick:_,onEdit:C,get onDelete(){return d()},get onView(){return u()}})}}),zt(n),kr(n,e=>$n(p,e),()=>bi(p));var c=Kt(n,2),h=e=>{var t=Bw(),n=Gt(t),i=e=>{pa(e,Fw())};xa(n,e=>{bi(v)&&e(i)}),zt(t),kr(t,e=>$n(f,e),()=>bi(f)),pa(e,t)};xa(c,e=>{!bi(w)&&bi(S)&&e(h)});var g=Kt(c,2),m=e=>{var t=jw(),n=Gt(t);Ng(n,{name:"zap",size:14});var a=Kt(n,2),r=Gt(a);zt(a),zt(t),zi(()=>{var e;return va(r,`已启用虚拟滚动优化（${null!=(e=i().length)?e:""} 张卡片）`)}),pa(e,t)};xa(g,e=>{bi(w)&&e(m)}),zi(e=>{var t;l=Fa(n,1,"grid-container svelte-y6nqlq",null,l,e),ja(n,`--column-count: ${null!=(t=bi(y))?t:""}`)},[()=>({"fixed-layout":"fixed"===s(),"masonry-layout":"masonry"===s()})]),pa(e,t)};return xa(M,e=>{h()?e(A):e(E,!1)}),zt(T),kr(T,e=>n=e,()=>n),pa(e,T),St(D)}var Hw=la('<div class="masonry-top-scrollbar svelte-1pm656r"><div class="masonry-scrollbar-content svelte-1pm656r"></div></div>'),Ww=la('<div class="tuanki-loading-state"><div class="tuanki-spinner"></div> <p>加载中...</p></div>'),Gw=la('<div class="masonry-card-wrapper svelte-1pm656r"><!></div>'),Qw=la('<div class="masonry-column svelte-1pm656r"></div>'),Kw=la('<div class="loading-indicator svelte-1pm656r"><div class="tuanki-spinner"></div> <span>正在加载更多卡片...</span></div>'),Zw=la('<div class="load-more-sentinel svelte-1pm656r"><!></div>'),Yw=la('<span class="performance-hint svelte-1pm656r"><!> 提示：固定高度模式性能更佳</span>'),Xw=la('<div class="performance-stats svelte-1pm656r"><span class="stats-text svelte-1pm656r">已显示 <strong class="svelte-1pm656r"> </strong> </span> <!></div>'),Jw=la('<div class="masonry-columns svelte-1pm656r"></div> <!> <!>',1),ek=la('<div class="masonry-grid-view svelte-1pm656r"><!> <div class="masonry-container svelte-1pm656r"><!></div></div>');function tk(e,t){if(new.target)return Er({component:tk,...e});kt(t,!0);let n,i=Ar(t,"cards",7),a=Ar(t,"selectedCards",7),r=Ar(t,"plugin",7),s=Ar(t,"attributeType",7,"uuid"),o=Ar(t,"onCardClick",7),l=Ar(t,"onCardEdit",7),c=Ar(t,"onCardDelete",7),d=Ar(t,"onCardView",7),u=Ar(t,"columnCount",7,4),h=Ar(t,"loading",7,!1),p=Pn(Ot([])),g=Pn(Ot(u())),v=Pn(void 0),f=Pn(void 0),m=Pn(void 0),y=Pn(void 0),b=null,w=null,k=0;let S=Pn(40),x=Pn(!1),_=Pn(void 0),C=null;function I(){if(!n)return u();const e=n.clientWidth;return e>=1400?4:e>=1024?3:e>=768?2:1}const D=In(()=>i().slice(0,bi(S))),T=In(()=>bi(S)<i().length);function M(){null!==w&&cancelAnimationFrame(w),w=requestAnimationFrame(()=>{const e=Array.from({length:bi(g)},()=>[]);bi(D).forEach((t,n)=>{const i=n%bi(g);e[i].push(t)}),$n(p,e,!0),w=null})}function A(){const e=I();e!==bi(g)&&($n(g,e,!0),M())}function E(e){var t;null==(t=o())||t(e)}function z(e){var t;null==(t=l())||t(e)}function P(e){"top"===e&&bi(v)&&bi(f)?bi(f).scrollLeft=bi(v).scrollLeft:"bottom"===e&&bi(v)&&bi(f)&&(bi(v).scrollLeft=bi(f).scrollLeft)}function R(){C&&C.disconnect(),C=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&bi(T)&&!bi(x)&&!bi(x)&&bi(T)&&($n(x,!0),requestAnimationFrame(()=>{$n(S,Math.min(bi(S)+30,i().length),!0),$n(x,!1)}))})},{rootMargin:"400px",threshold:.1}),bi(_)&&C.observe(bi(_))}Pr(()=>(yi().then(()=>{$n(g,I(),!0),M(),bi(T)&&R()}),window.addEventListener("resize",A),()=>{window.removeEventListener("resize",A),C&&C.disconnect(),null!==b&&cancelAnimationFrame(b),null!==w&&cancelAnimationFrame(w)})),Ti(()=>{i().length;bi(S)>0&&M()}),Ti(()=>{const e=bi(T),t=!!bi(_);e&&t&&R()}),Ti(()=>{const e=bi(g);i().length;const t=bi(S);e>0&&t>0&&(null!==b&&cancelAnimationFrame(b),b=requestAnimationFrame(()=>{if(bi(y)&&bi(m)){const e=bi(y).scrollWidth;Math.abs(e-k)>1&&(k=e,bi(m).style.width=`${e}px`)}b=null}))});var $={get cards(){return i()},set cards(e){i(e),hn()},get selectedCards(){return a()},set selectedCards(e){a(e),hn()},get plugin(){return r()},set plugin(e){r(e),hn()},get attributeType(){return s()},set attributeType(e="uuid"){s(e),hn()},get onCardClick(){return o()},set onCardClick(e){o(e),hn()},get onCardEdit(){return l()},set onCardEdit(e){l(e),hn()},get onCardDelete(){return c()},set onCardDelete(e){c(e),hn()},get onCardView(){return d()},set onCardView(e){d(e),hn()},get columnCount(){return u()},set columnCount(e=4){u(e),hn()},get loading(){return h()},set loading(e=!1){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},O=ek(),L=Gt(O),N=e=>{var t=Hw();kr(Gt(t),e=>$n(m,e),()=>bi(m)),zt(t),kr(t,e=>$n(v,e),()=>bi(v)),na("scroll",t,()=>P("top")),pa(e,t)};xa(L,e=>{!h()&&i().length>0&&e(N)});var F=Kt(L,2),B=Gt(F),j=e=>{pa(e,Ww())},U=e=>{var t=Jw(),n=Qt(t);Ca(n,21,()=>bi(p),_a,(e,t)=>{var n=Qw();Ca(n,21,()=>bi(t),e=>e.uuid||"unknown",(e,t)=>{var n=Gw(),i=Gt(n);{let e=In(()=>{return e=bi(t).uuid,a().has(e);var e});Lw(i,{get card(){return bi(t)},get selected(){return bi(e)},get plugin(){return r()},layoutMode:"masonry",get attributeType(){return s()},onClick:E,onEdit:z,get onDelete(){return c()},get onView(){return d()}})}zt(n),pa(e,n)}),zt(n),pa(e,n)}),zt(n),kr(n,e=>$n(y,e),()=>bi(y));var o=Kt(n,2),l=e=>{var t=Zw(),n=Gt(t),i=e=>{pa(e,Kw())};xa(n,e=>{bi(x)&&e(i)}),zt(t),kr(t,e=>$n(_,e),()=>bi(_)),pa(e,t)};xa(o,e=>{bi(T)&&e(l)});var u=Kt(o,2),h=e=>{var t=Xw(),n=Gt(t),a=Kt(Gt(n)),r=Gt(a,!0);zt(a);var s=Kt(a);zt(n);var o=Kt(n,2),l=e=>{var t=Yw();Ng(Gt(t),{name:"zap",size:12}),Pt(),zt(t),pa(e,t)};xa(o,e=>{i().length>100&&e(l)}),zt(t),zi(()=>{var e;va(r,bi(S)),va(s,` / ${null!=(e=i().length)?e:""} 张卡片`)}),pa(e,t)};xa(u,e=>{i().length>0&&e(h)}),zi(()=>{var e;return ja(n,`--column-count: ${null!=(e=bi(g))?e:""}`)}),pa(e,t)};return xa(B,e=>{h()?e(j):e(U,!1)}),zt(F),kr(F,e=>$n(f,e),()=>bi(f)),zt(O),kr(O,e=>n=e,()=>n),na("scroll",F,()=>P("bottom")),pa(e,O),St($)}class nk{constructor(){oe(this,"storage"),oe(this,"storageKey","tuanki-saved-filters"),this.storage=this.loadStorage(),this.initializeBuiltInFilters()}initializeBuiltInFilters(){[{id:"builtin-new-cards",name:"新卡片",description:"所有新创建的卡片",icon:"plus-circle",color:"#3b82f6",config:{groups:[{id:"g1",logic:"AND",conditions:[{id:"c1",field:"status",operator:"equals",value:"new",enabled:!0}]}],globalLogic:"AND"},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),useCount:0,isPinned:!0,isBuiltIn:!0},{id:"builtin-learning",name:"学习中",description:"正在学习的卡片",icon:"book-open",color:"#f59e0b",config:{groups:[{id:"g1",logic:"AND",conditions:[{id:"c1",field:"status",operator:"equals",value:"learning",enabled:!0}]}],globalLogic:"AND"},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),useCount:0,isPinned:!0,isBuiltIn:!0},{id:"builtin-review",name:"复习中",description:"正在复习的卡片",icon:"repeat",color:"var(--interactive-accent)",config:{groups:[{id:"g1",logic:"AND",conditions:[{id:"c1",field:"status",operator:"equals",value:"review",enabled:!0}]}],globalLogic:"AND"},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),useCount:0,isPinned:!0,isBuiltIn:!0},{id:"builtin-due-soon",name:"即将到期",description:"未来1天内需要复习的卡片",icon:"clock",color:"#ef4444",config:{groups:[{id:"g1",logic:"AND",conditions:[{id:"c1",field:"status",operator:"not_equals",value:"new",enabled:!0},{id:"c2",field:"due",operator:"in_last",value:1,enabled:!0}]}],globalLogic:"AND"},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),useCount:0,isPinned:!0,isBuiltIn:!0},{id:"builtin-recent",name:"最近创建",description:"最近7天创建的卡片",icon:"calendar-plus",color:"#10b981",config:{groups:[{id:"g1",logic:"AND",conditions:[{id:"c1",field:"created",operator:"in_last",value:7,enabled:!0}]}],globalLogic:"AND"},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),useCount:0,isPinned:!1,isBuiltIn:!0}].forEach(e=>{this.storage.savedFilters.find(t=>t.id===e.id)||this.storage.savedFilters.push(e)}),this.saveStorage()}saveFilter(e){const t={...e,id:`filter-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),useCount:0,isBuiltIn:!1};return this.storage.savedFilters.push(t),this.saveStorage(),_e.debug("[FilterManager] 筛选器已保存:",t.name),t}updateFilter(e,t){const n=this.storage.savedFilters.findIndex(t=>t.id===e);if(-1===n)return _e.warn("[FilterManager] 筛选器不存在:",e),null;const i=this.storage.savedFilters[n];if(i.isBuiltIn&&t.config)throw _e.error("[FilterManager] 无法修改内置筛选器的配置"),new Error("Cannot modify built-in filter configuration");return this.storage.savedFilters[n]={...i,...t,id:i.id,isBuiltIn:i.isBuiltIn,updatedAt:(new Date).toISOString()},this.saveStorage(),_e.debug("[FilterManager] 筛选器已更新:",e),this.storage.savedFilters[n]}deleteFilter(e){const t=this.storage.savedFilters.find(t=>t.id===e);return t?t.isBuiltIn?(_e.error("[FilterManager] 无法删除内置筛选器"),!1):(this.storage.savedFilters=this.storage.savedFilters.filter(t=>t.id!==e),this.storage.recentFilterIds=this.storage.recentFilterIds.filter(t=>t!==e),this.storage.defaultFilterId===e&&(this.storage.defaultFilterId=void 0),this.saveStorage(),_e.debug("[FilterManager] 筛选器已删除:",e),!0):(_e.warn("[FilterManager] 筛选器不存在:",e),!1)}getFilter(e){return this.storage.savedFilters.find(t=>t.id===e)||null}getAllFilters(){return[...this.storage.savedFilters]}getPinnedFilters(){return this.storage.savedFilters.filter(e=>e.isPinned).sort((e,t)=>t.useCount-e.useCount)}getRecentFilters(e=5){return this.storage.recentFilterIds.map(e=>this.storage.savedFilters.find(t=>t.id===e)).filter(e=>void 0!==e).slice(0,e)}togglePinned(e){const t=this.storage.savedFilters.find(t=>t.id===e);return!!t&&(t.isPinned=!t.isPinned,this.saveStorage(),_e.debug("[FilterManager] 筛选器固定状态已切换:",e,t.isPinned),t.isPinned)}recordFilterUsage(e){const t=this.storage.savedFilters.find(t=>t.id===e);t&&(t.useCount++,t.lastUsed=(new Date).toISOString(),this.storage.recentFilterIds=[e,...this.storage.recentFilterIds.filter(t=>t!==e)].slice(0,5),this.saveStorage())}setDefaultFilter(e){this.storage.defaultFilterId=e,this.saveStorage(),_e.debug("[FilterManager] 默认筛选器已设置:",e)}getDefaultFilter(){return this.storage.defaultFilterId?this.getFilter(this.storage.defaultFilterId):null}applyFilter(e,t,n=[]){return t.groups&&0!==t.groups.length?e.filter(e=>this.evaluateFilterConfig(e,t,n)):e}evaluateFilterConfig(e,t,n=[]){if(0===t.groups.length)return!0;const i=t.groups.map(t=>this.evaluateFilterGroup(e,t,n));return"AND"===t.globalLogic?i.every(e=>e):i.some(e=>e)}evaluateFilterGroup(e,t,n=[]){const i=t.conditions.filter(e=>e.enabled);if(0===i.length)return!0;const a=i.map(t=>this.evaluateCondition(e,t,n));return"AND"===t.logic?a.every(e=>e):a.some(e=>e)}evaluateCondition(e,t,n=[]){const i=this.getFieldValue(e,t.field,n),a=t.value;switch(t.operator){case"equals":return i===a;case"not_equals":return i!==a;case"contains":return Array.isArray(i)?i.some(e=>String(e).toLowerCase().includes(String(a).toLowerCase())):String(i).toLowerCase().includes(String(a).toLowerCase());case"not_contains":return Array.isArray(i)?!i.some(e=>String(e).toLowerCase().includes(String(a).toLowerCase())):!String(i).toLowerCase().includes(String(a).toLowerCase());case"starts_with":return String(i).toLowerCase().startsWith(String(a).toLowerCase());case"ends_with":return String(i).toLowerCase().endsWith(String(a).toLowerCase());case"greater_than":return Number(i)>Number(a);case"less_than":return Number(i)<Number(a);case"greater_equal":return Number(i)>=Number(a);case"less_equal":return Number(i)<=Number(a);case"is_empty":return Array.isArray(i)?0===i.length:!i||""===i;case"is_not_empty":return Array.isArray(i)?i.length>0:!!i&&""!==i;case"in_last":return this.isInLastDays(i,Number(a));case"not_in_last":return!this.isInLastDays(i,Number(a));default:return _e.warn("[FilterManager] 未知操作符:",t.operator),!1}}getFieldValue(e,t,n=[]){var i,a,r,s,o,l,c,d;switch(t){case"status":return this.getStatusString(null!=(a=null==(i=e.fsrs)?void 0:i.state)?a:0);case"deck":return e.deckId;case"tags":return e.tags||[];case"created":return new Date(e.created);case"modified":return new Date(e.modified);case"due":return(null==(r=e.fsrs)?void 0:r.due)?new Date(e.fsrs.due):new Date;case"difficulty":return null!=(o=null==(s=e.fsrs)?void 0:s.difficulty)?o:0;case"stability":return null!=(c=null==(l=e.fsrs)?void 0:l.stability)?c:0;case"source_document":return(null==(d=e.fields)?void 0:d.source_document)||"";case"front":return Yu(e,"front",n);case"back":return Yu(e,"back",n);default:return""}}getStatusString(e){switch(e){case 0:return"new";case 1:return"learning";case 2:return"review";case 3:return"mastered";default:return"unknown"}}isInLastDays(e,t){if(!e||Number.isNaN(e.getTime()))return!1;const n=((new Date).getTime()-e.getTime())/864e5;return n>=0&&n<=t}loadStorage(){try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);return _e.debug("[FilterManager] 已加载筛选器存储:",t.savedFilters.length,"个筛选器"),t}}catch(e){_e.error("[FilterManager] 加载筛选器存储失败:",e)}return _e.debug("[FilterManager] 初始化新的筛选器存储"),{version:"1.0",savedFilters:[],recentFilterIds:[]}}saveStorage(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.storage))}catch(e){_e.error("[FilterManager] 保存筛选器存储失败:",e)}}exportFilters(){return JSON.stringify(this.storage,null,2)}importFilters(e){try{const t=JSON.parse(e);if(!t.savedFilters||!Array.isArray(t.savedFilters))return{success:!1,imported:0,error:"无效的筛选器数据格式"};const n=t.savedFilters.filter(e=>!e.isBuiltIn);return n.forEach(e=>{e.id=`filter-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,e.createdAt=(new Date).toISOString(),e.updatedAt=(new Date).toISOString(),this.storage.savedFilters.push(e)}),this.saveStorage(),_e.debug("[FilterManager] 已导入筛选器:",n.length,"个"),{success:!0,imported:n.length}}catch(t){return _e.error("[FilterManager] 导入筛选器失败:",t),{success:!1,imported:0,error:t instanceof Error?t.message:"未知错误"}}}}function ik(e,t){var n;null==(n=t())||n()}function ak(e,t){var n;null==(n=t())||n()}function rk(e,t){var n;null==(n=t())||n()}function sk(e,t){var n;null==(n=t())||n()}function ok(e,t,n,i){var a;confirm(bi(t)("cardManagement.batchDelete.confirm").replace("{count}",String(n())))&&(null==(a=i())||a())}function lk(e,t){var n;null==(n=t())||n()}new nk,ia(["click"]);var ck=la('<button class="tuanki-toolbar-btn svelte-jiypmi"><!></button>'),dk=la('<div><div class="tuanki-toolbar-info svelte-jiypmi"><span> </span></div> <div class="tuanki-toolbar-actions svelte-jiypmi"><button class="tuanki-toolbar-btn svelte-jiypmi"><!></button> <button class="tuanki-toolbar-btn tuanki-btn-danger svelte-jiypmi"><!></button> <!> <button class="tuanki-toolbar-btn svelte-jiypmi"><!></button> <button class="tuanki-toolbar-btn svelte-jiypmi"><!></button> <button class="tuanki-toolbar-btn tuanki-btn-secondary svelte-jiypmi"><!></button></div></div>');function uk(e,t){if(new.target)return Er({component:uk,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"selectedCount",7),s=Ar(t,"visible",7),o=Ar(t,"onBatchCopy",7),l=Ar(t,"onBatchChangeDeck",7),c=Ar(t,"onBatchAddTags",7),d=Ar(t,"onBatchRemoveTags",7),u=Ar(t,"onBatchDelete",7),h=Ar(t,"onClearSelection",7),p=In(n);var g={get selectedCount(){return r()},set selectedCount(e){r(e),hn()},get visible(){return s()},set visible(e){s(e),hn()},get onBatchCopy(){return o()},set onBatchCopy(e){o(e),hn()},get onBatchChangeDeck(){return l()},set onBatchChangeDeck(e){l(e),hn()},get onBatchAddTags(){return c()},set onBatchAddTags(e){c(e),hn()},get onBatchRemoveTags(){return d()},set onBatchRemoveTags(e){d(e),hn()},get onBatchDelete(){return u()},set onBatchDelete(e){u(e),hn()},get onClearSelection(){return h()},set onClearSelection(e){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},v=ha(),f=Qt(v),m=e=>{var t=dk();let n;var i=Gt(t),a=Gt(i),s=Gt(a,!0);zt(a),zt(i);var g=Kt(i,2),v=Gt(g);v.__click=[ik,o],Ng(Gt(v),{name:"copy",size:16}),zt(v);var f=Kt(v,2);f.__click=[ok,p,r,u],Ng(Gt(f),{name:"trash-2",size:16}),zt(f);var m=Kt(f,2),y=e=>{var t=ck();t.__click=[ak,l],Ng(Gt(t),{name:"folder",size:16}),zt(t),zi(e=>er(t,"title",e),[()=>bi(p)("cardManagement.batchToolbar.changeDeck")]),pa(e,t)};xa(m,e=>{l()&&e(y)});var b=Kt(m,2);b.__click=[sk,d],Ng(Gt(b),{name:"tag-x",size:16}),zt(b);var w=Kt(b,2);w.__click=[rk,c],Ng(Gt(w),{name:"tag-plus",size:16}),zt(w);var k=Kt(w,2);k.__click=[lk,h],Ng(Gt(k),{name:"x",size:16}),zt(k),zt(g),zt(t),zi((e,i,a,r,o,l,c)=>{n=Fa(t,1,"tuanki-batch-toolbar svelte-jiypmi",null,n,e),va(s,i),er(v,"title",a),er(f,"title",r),er(b,"title",o),er(w,"title",l),er(k,"title",c)},[()=>({visible:r()>0}),()=>bi(p)("cardManagement.batchToolbar.selected").replace("{count}",String(r())),()=>bi(p)("cardManagement.batchToolbar.copy"),()=>bi(p)("ui.delete"),()=>bi(p)("cardManagement.batchToolbar.removeTags"),()=>bi(p)("cardManagement.batchToolbar.addTags"),()=>bi(p)("ui.cancel")]),pa(e,t)};xa(f,e=>{s()&&e(m)}),pa(e,v);var y=St(g);return a(),y}ia(["click"]);var hk=(e,t)=>{e.currentTarget===e.target&&t()},pk=(e,t)=>{"Escape"===e.key&&t()},gk=(e,t,n)=>t(bi(n).id),vk=(e,t,n)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t(bi(n).id))},fk=la('<div class="bdc-deck-desc svelte-u6d7i5"> </div>'),mk=la('<div class="bdc-deck-check svelte-u6d7i5"><!></div>'),yk=la('<div role="button" tabindex="0"><div class="bdc-deck-icon svelte-u6d7i5"><!></div> <div class="bdc-deck-info svelte-u6d7i5"><div class="bdc-deck-name svelte-u6d7i5"> </div> <!></div> <!></div>'),bk=la('<div class="bdc-empty svelte-u6d7i5"><!> <p class="svelte-u6d7i5">没有找到匹配的牌组</p></div>'),wk=la(" <!>",1),kk=la('<div class="bdc-overlay svelte-u6d7i5" role="button" tabindex="0"><div class="bdc-modal svelte-u6d7i5" role="dialog" aria-labelledby="bdc-title"><header class="bdc-header svelte-u6d7i5"><h2 id="bdc-title" class="svelte-u6d7i5"> </h2> <!></header> <main class="bdc-main svelte-u6d7i5"><div class="bdc-operation-type svelte-u6d7i5"><div class="bdc-operation-label svelte-u6d7i5"><!> <span> </span></div> <div class="bdc-radio-group svelte-u6d7i5"><label><input type="radio" name="operation-type" class="svelte-u6d7i5"/> <div class="bdc-radio-content svelte-u6d7i5"><!> <div><div class="bdc-radio-title svelte-u6d7i5"> </div> <div class="bdc-radio-desc svelte-u6d7i5"> </div></div></div></label> <label><input type="radio" name="operation-type" class="svelte-u6d7i5"/> <div class="bdc-radio-content svelte-u6d7i5"><!> <div><div class="bdc-radio-title svelte-u6d7i5"> </div> <div class="bdc-radio-desc svelte-u6d7i5"> </div></div></div></label></div></div> <div class="bdc-search svelte-u6d7i5"><!> <input type="text" class="svelte-u6d7i5"/></div> <div class="bdc-deck-list svelte-u6d7i5"><!> <!></div></main> <footer class="bdc-footer svelte-u6d7i5"><!> <!></footer></div></div>');function Sk(e,t){if(new.target)return Er({component:Sk,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr(),r=[];let s=Ar(t,"open",7),o=Ar(t,"selectedCards",7),l=Ar(t,"decks",7),c=Ar(t,"onconfirm",7),d=Ar(t,"oncancel",7),u=In(n),h=Pn(""),p=Pn(""),g=Pn("move"),v=In(()=>{if(!bi(p).trim())return l();const e=bi(p).toLowerCase();return l().filter(t=>{var n;return t.name.toLowerCase().includes(e)||(null==(n=t.description)?void 0:n.toLowerCase().includes(e))})});function f(){$n(h,""),$n(p,""),$n(g,"move")}function m(e){$n(h,e,!0)}function y(){var e;bi(h)&&(null==(e=c())||e(bi(h),bi(g)),f())}function b(){var e;null==(e=d())||e(),f()}Ti(()=>{s()||f()});var w={get open(){return s()},set open(e){s(e),hn()},get selectedCards(){return o()},set selectedCards(e){o(e),hn()},get decks(){return l()},set decks(e){l(e),hn()},get onconfirm(){return c()},set onconfirm(e){c(e),hn()},get oncancel(){return d()},set oncancel(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},k=ha(),S=Qt(k),x=e=>{var t=kk();t.__click=[hk,b],t.__keydown=[pk,b];var n=Gt(t),i=Gt(n),a=Gt(i),s=Gt(a,!0);zt(a),Hg(Kt(a,2),{variant:"secondary",size:"sm",onclick:b,children:(e,t)=>{Ng(e,{get name(){return yg},size:16})},$$slots:{default:!0}}),zt(i);var l=Kt(i,2),c=Gt(l),d=Gt(c),f=Gt(d);Ng(f,{get name(){return Ig},size:16});var w=Kt(f,2),k=Gt(w,!0);zt(w),zt(d);var S=Kt(d,2),x=Gt(S);let _;var C=Gt(x);Za(C),C.value=C.__value="move";var I=Kt(C,2),D=Gt(I);Ng(D,{get name(){return _g},size:16});var T=Kt(D,2),M=Gt(T),A=Gt(M,!0);zt(M);var E=Kt(M,2),z=Gt(E,!0);zt(E),zt(T),zt(I),zt(x);var P=Kt(x,2);let R;var $=Gt(P);Za($),$.value=$.__value="copy";var O=Kt($,2),L=Gt(O);Ng(L,{get name(){return wg},size:16});var N=Kt(L,2),F=Gt(N),B=Gt(F,!0);zt(F);var j=Kt(F,2),U=Gt(j,!0);zt(j),zt(N),zt(O),zt(P),zt(S),zt(c);var V=Kt(c,2),q=Gt(V);Ng(q,{get name(){return Cg},size:16});var H=Kt(q,2);Za(H),zt(V);var W=Kt(V,2),G=Gt(W);Ca(G,17,()=>bi(v),e=>e.id,(e,t)=>{var n=yk();let i;n.__click=[gk,m,t],n.__keydown=[vk,m,t];var a=Gt(n);Ng(Gt(a),{get name(){return Rg},size:20}),zt(a);var r=Kt(a,2),s=Gt(r),o=Gt(s,!0);zt(s);var l=Kt(s,2),c=e=>{var n=fk(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t).description)),pa(e,n)};xa(l,e=>{bi(t).description&&e(c)}),zt(r);var d=Kt(r,2),p=e=>{var t=mk();Ng(Gt(t),{get name(){return Ag},size:20}),zt(t),pa(e,t)};xa(d,e=>{bi(h)===bi(t).id&&e(p)}),zt(n),zi((e,a)=>{i=Fa(n,1,"bdc-deck-item svelte-u6d7i5",null,i,e),er(n,"aria-label",a),va(o,bi(t).name)},[()=>({selected:bi(h)===bi(t).id}),()=>bi(u)("modals.batchDeckChange.selectDeck").replace("{name}",bi(t).name)]),pa(e,n)});var Q=Kt(G,2),K=e=>{var t=bk();Ng(Gt(t),{get name(){return Mg},size:24}),Pt(2),zt(t),pa(e,t)};xa(Q,e=>{0===bi(v).length&&e(K)}),zt(W),zt(l);var Z=Kt(l,2),Y=Gt(Z);Hg(Y,{variant:"secondary",onclick:b,children:(e,t)=>{Pt();var n=ua();zi(e=>va(n,e),[()=>bi(u)("modals.batchDeckChange.cancel")]),pa(e,n)},$$slots:{default:!0}});var X=Kt(Y,2);{let e=In(()=>!bi(h));Hg(X,{variant:"primary",onclick:y,get disabled(){return bi(e)},children:(e,t)=>{Pt();var n=wk(),i=Qt(n),a=Kt(i);{let e=In(()=>"move"===bi(g)?_g:wg);Ng(a,{get name(){return bi(e)},size:16})}zi(e=>va(i,`${null!=e?e:""} `),[()=>bi(u)("modals.batchDeckChange.confirm")]),pa(e,n)},$$slots:{default:!0}})}zt(Z),zt(n),zt(t),zi((e,t,n,i,a,r,o,l,c)=>{va(s,e),va(k,t),_=Fa(x,1,"bdc-radio-option svelte-u6d7i5",null,_,n),va(A,i),va(z,a),R=Fa(P,1,"bdc-radio-option svelte-u6d7i5",null,R,r),va(B,o),va(U,l),er(H,"placeholder",c)},[()=>bi(u)("modals.batchDeckChange.title"),()=>bi(u)("modals.batchDeckChange.operationType"),()=>({selected:"move"===bi(g)}),()=>bi(u)("modals.batchDeckChange.move"),()=>bi(u)("modals.batchDeckChange.moveDesc").replace("{count}",String(o().length)),()=>({selected:"copy"===bi(g)}),()=>bi(u)("modals.batchDeckChange.copy"),()=>bi(u)("modals.batchDeckChange.copyDesc").replace("{count}",String(o().length)),()=>bi(u)("modals.batchDeckChange.searchPlaceholder")]),vr(r,[],C,()=>bi(g),e=>$n(g,e)),vr(r,[],$,()=>bi(g),e=>$n(g,e)),pr(H,()=>bi(p),e=>$n(p,e)),pa(e,t)};xa(S,e=>{s()&&e(x)}),pa(e,k);var _=St(w);return a(),_}function xk(e,t,n){$n(t,e.target.value,!0),$n(n,!0)}function _k(e,t,n,i){if("Enter"===e.key){e.preventDefault();bi(t).split(",").map(e=>e.trim()).filter(Boolean).forEach(e=>n(e)),$n(t,""),$n(i,!1)}else"Escape"===e.key&&$n(i,!1)}ia(["click","keydown"]);var Ck=(e,t)=>{e.currentTarget===e.target&&t()},Ik=(e,t)=>{"Escape"===e.key&&t()},Dk=la('<span class="bat-tag-stat svelte-1dsydo2"> <span class="bat-tag-count svelte-1dsydo2"> </span></span>'),Tk=la('<div class="bat-current-tags svelte-1dsydo2"><h4 class="svelte-1dsydo2">当前标签：</h4> <div class="bat-tag-cloud svelte-1dsydo2"></div></div>'),Mk=(e,t,n)=>t(bi(n)),Ak=(e,t,n)=>{"Enter"===e.key&&t(bi(n))},Ek=la('<div class="bat-suggestion-item svelte-1dsydo2" role="button" tabindex="0"><!> <span> </span></div>'),zk=la('<div class="bat-suggestions svelte-1dsydo2"></div>'),Pk=(e,t,n)=>t(bi(n)),Rk=la('<div class="bat-tag-item svelte-1dsydo2"><span> </span> <button class="bat-tag-remove svelte-1dsydo2"><!></button></div>'),$k=la('<div class="bat-added-tags svelte-1dsydo2"><h4 class="svelte-1dsydo2">待添加标签：</h4> <div class="bat-tag-list svelte-1dsydo2"></div></div>'),Ok=la(" <!>",1),Lk=la('<div class="bat-overlay svelte-1dsydo2" role="button" tabindex="0"><div class="bat-modal svelte-1dsydo2" role="dialog" aria-labelledby="bat-title"><header class="bat-header svelte-1dsydo2"><h2 id="bat-title" class="svelte-1dsydo2"> </h2> <!></header> <main class="bat-main svelte-1dsydo2"><div class="bat-info svelte-1dsydo2"><!> <span>将为选中的 <strong> </strong> 张卡片添加标签</span></div> <!> <div class="bat-input-container svelte-1dsydo2"><label for="tag-input" class="svelte-1dsydo2">新标签：</label> <div class="bat-input-wrapper svelte-1dsydo2"><input id="tag-input" type="text" class="bat-tag-input svelte-1dsydo2"/> <!></div> <small class="svelte-1dsydo2">提示：按 Enter 键添加标签</small></div> <!></main> <footer class="bat-footer svelte-1dsydo2"><!> <!></footer></div></div>');function Nk(e,t){if(new.target)return Er({component:Nk,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"open",7),s=Ar(t,"selectedCards",7),o=Ar(t,"existingTags",7),l=Ar(t,"onconfirm",7),c=Ar(t,"oncancel",7),d=In(n),u=Pn(""),h=Pn(Ot([])),p=Pn(!1),g=In(()=>()=>{var e;if(!bi(u).trim()||bi(u).endsWith(","))return[];const t=(null==(e=bi(u).split(",").pop())?void 0:e.trim().toLowerCase())||"";return t?o().filter(e=>e.toLowerCase().includes(t)&&!bi(h).includes(e)).slice(0,8):[]}),v=In(()=>()=>{const e=new Map;return s().forEach(t=>{var n;null==(n=t.tags)||n.forEach(t=>{e.set(t,(e.get(t)||0)+1)})}),Array.from(e.entries()).map(([e,t])=>({tag:e,count:t})).sort((e,t)=>t.count-e.count)});function f(){$n(u,""),$n(h,[],!0),$n(p,!1)}function m(e){const t=bi(u).split(",");t[t.length-1]=e,$n(u,t.join(", ")+", "),$n(p,!1),setTimeout(()=>{const e=document.querySelector(".bat-tag-input");null==e||e.focus()},0)}function y(e){const t=e.trim();t&&!bi(h).includes(t)&&$n(h,[...bi(h),t],!0)}function b(e){$n(h,bi(h).filter(t=>t!==e),!0)}function w(){var e;const t=bi(u).split(",").map(e=>e.trim()).filter(Boolean),n=[...new Set([...bi(h),...t])];0!==n.length&&(null==(e=l())||e(n),f())}function k(){var e;null==(e=c())||e(),f()}Ti(()=>{r()||f()});var S={get open(){return r()},set open(e){r(e),hn()},get selectedCards(){return s()},set selectedCards(e){s(e),hn()},get existingTags(){return o()},set existingTags(e){o(e),hn()},get onconfirm(){return l()},set onconfirm(e){l(e),hn()},get oncancel(){return c()},set oncancel(e){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},x=ha(),_=Qt(x),C=e=>{var t=Lk();t.__click=[Ck,k],t.__keydown=[Ik,k];var n=Gt(t),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a),Hg(Kt(a,2),{variant:"secondary",size:"sm",onclick:k,children:(e,t)=>{Ng(e,{get name(){return yg},size:16})},$$slots:{default:!0}}),zt(i);var o=Kt(i,2),l=Gt(o),c=Gt(l);Ng(c,{get name(){return Ig},size:16});var f=Kt(c,2),S=Kt(Gt(f)),x=Gt(S,!0);zt(S),Pt(),zt(f),zt(l);var _=Kt(l,2),C=e=>{var t=Tk(),n=Kt(Gt(t),2);Ca(n,21,()=>bi(v)().slice(0,10),_a,(e,t)=>{var n=Dk(),i=Gt(n),a=Kt(i),r=Gt(a);zt(a),zt(n),zi(()=>{var e,n;va(i,`${null!=(e=bi(t).tag)?e:""} `),va(r,`(${null!=(n=bi(t).count)?n:""})`)}),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(_,e=>{bi(v)().length>0&&e(C)});var I=Kt(_,2),D=Kt(Gt(I),2),T=Gt(D);Za(T),T.__input=[xk,u,p],T.__keydown=[_k,u,y,p];var M=Kt(T,2),A=e=>{var t=zk();Ca(t,21,()=>bi(g)(),_a,(e,t)=>{var n=Ek();n.__click=[Mk,m,t],n.__keydown=[Ak,m,t];var i=Gt(n);Ng(i,{get name(){return zg},size:14});var a=Kt(i,2),r=Gt(a,!0);zt(a),zt(n),zi(()=>va(r,bi(t))),pa(e,n)}),zt(t),pa(e,t)};xa(M,e=>{bi(g)().length>0&&bi(p)&&e(A)}),zt(D),Pt(2),zt(I);var E=Kt(I,2),z=e=>{var t=$k(),n=Kt(Gt(t),2);Ca(n,21,()=>bi(h),_a,(e,t)=>{var n=Rk(),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2);r.__click=[Pk,b,t],Ng(Gt(r),{get name(){return $g},size:14}),zt(r),zt(n),zi(()=>{va(a,bi(t)),er(r,"aria-label",`删除标签 ${bi(t)}`)}),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(E,e=>{bi(h).length>0&&e(z)}),zt(o);var P=Kt(o,2),R=Gt(P);Hg(R,{variant:"secondary",onclick:k,children:(e,t)=>{Pt();var n=ua();zi(e=>va(n,e),[()=>bi(d)("modals.batchAddTags.cancel")]),pa(e,n)},$$slots:{default:!0}});var $=Kt(R,2);{let e=In(()=>""===bi(u).trim()&&0===bi(h).length);Hg($,{variant:"primary",onclick:w,get disabled(){return bi(e)},children:(e,t)=>{Pt();var n=Ok(),i=Qt(n);Ng(Kt(i),{get name(){return bg},size:16}),zi(e=>va(i,`${null!=e?e:""} `),[()=>bi(d)("modals.batchAddTags.confirm")]),pa(e,n)},$$slots:{default:!0}})}zt(P),zt(n),zt(t),zi((e,t)=>{va(r,e),va(x,s().length),er(T,"placeholder",t)},[()=>bi(d)("modals.batchAddTags.title"),()=>bi(d)("modals.batchAddTags.inputPlaceholder")]),na("focus",T,()=>$n(p,!0)),pr(T,()=>bi(u),e=>$n(u,e)),pa(e,t)};xa(_,e=>{r()&&e(C)}),pa(e,x);var I=St(S);return a(),I}ia(["click","keydown","input"]);var Fk=(e,t)=>{e.currentTarget===e.target&&t()},Bk=(e,t)=>{"Escape"===e.key&&t()},jk=la('<div class="brt-empty svelte-npo0dh"><!> <p class="svelte-npo0dh"> </p></div>'),Uk=(e,t,n)=>t(bi(n).tag),Vk=la('<label class="brt-tag-item svelte-npo0dh"><input type="checkbox" class="svelte-npo0dh"/> <div class="brt-tag-content svelte-npo0dh"><div class="brt-tag-name svelte-npo0dh"><!> <span> </span></div> <div class="brt-tag-stats svelte-npo0dh"><span class="brt-tag-count svelte-npo0dh"> </span> <div class="brt-tag-bar svelte-npo0dh"><div class="brt-tag-bar-fill svelte-npo0dh"></div></div> <span class="brt-tag-percentage svelte-npo0dh"> </span></div></div></label>'),qk=la('<span class="brt-preview-tag svelte-npo0dh"> </span>'),Hk=la('<div class="brt-preview svelte-npo0dh"><h4 class="svelte-npo0dh">将删除以下标签：</h4> <div class="brt-preview-tags svelte-npo0dh"></div> <p class="brt-warning svelte-npo0dh"><!> 注意：只会从包含这些标签的卡片中删除</p></div>'),Wk=la('<div class="brt-actions svelte-npo0dh"><!> <!> <span class="brt-selection-count svelte-npo0dh">已选择 <strong> </strong> 个标签</span></div> <div class="brt-tag-list svelte-npo0dh"></div> <!>',1),Gk=la(" <!>",1),Qk=la('<div class="brt-overlay svelte-npo0dh" role="button" tabindex="0"><div class="brt-modal svelte-npo0dh" role="dialog" aria-labelledby="brt-title"><header class="brt-header svelte-npo0dh"><h2 id="brt-title" class="svelte-npo0dh"> </h2> <!></header> <main class="brt-main svelte-npo0dh"><div class="brt-info svelte-npo0dh"><!> <span> </span></div> <!></main> <footer class="brt-footer svelte-npo0dh"><!> <!></footer></div></div>');function Kk(e,t){if(new.target)return Er({component:Kk,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"open",7),s=Ar(t,"selectedCards",7),o=Ar(t,"onconfirm",7),l=Ar(t,"oncancel",7),c=In(n),d=Pn(Ot(new Set)),u=In(()=>()=>{const e=new Map;return s().forEach(t=>{var n;null==(n=t.tags)||n.forEach(t=>{e.set(t,(e.get(t)||0)+1)})}),Array.from(e.entries()).map(([e,t])=>({tag:e,count:t,percentage:t/s().length*100})).sort((e,t)=>t.count-e.count)});function h(){$n(d,new Set,!0)}function p(e){const t=new Set(bi(d));t.has(e)?t.delete(e):t.add(e),$n(d,t,!0)}function g(){$n(d,new Set(bi(u)().map(e=>e.tag)),!0)}function v(){$n(d,new Set,!0)}function f(){var e;0!==bi(d).size&&(null==(e=o())||e(Array.from(bi(d))),h())}function m(){var e;null==(e=l())||e(),h()}Ti(()=>{r()||h()});var y={get open(){return r()},set open(e){r(e),hn()},get selectedCards(){return s()},set selectedCards(e){s(e),hn()},get onconfirm(){return o()},set onconfirm(e){o(e),hn()},get oncancel(){return l()},set oncancel(e){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},b=ha(),w=Qt(b),k=e=>{var t=Qk();t.__click=[Fk,m],t.__keydown=[Bk,m];var n=Gt(t),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a),Hg(Kt(a,2),{variant:"secondary",size:"sm",onclick:m,children:(e,t)=>{Ng(e,{get name(){return yg},size:16})},$$slots:{default:!0}}),zt(i);var o=Kt(i,2),l=Gt(o),h=Gt(l);Ng(h,{get name(){return Ig},size:16});var y=Kt(h,2),b=Gt(y,!0);zt(y),zt(l);var w=Kt(l,2),k=e=>{var t=jk(),n=Gt(t);Ng(n,{get name(){return Mg},size:32});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(e=>va(a,e),[()=>bi(c)("modals.batchRemoveTags.noTags")]),pa(e,t)},S=e=>{var t=Wk(),n=Qt(t),i=Gt(n);Hg(i,{variant:"secondary",size:"sm",onclick:g,children:(e,t)=>{Pt();var n=ua();zi(e=>va(n,e),[()=>bi(c)("modals.batchRemoveTags.selectAll")]),pa(e,n)},$$slots:{default:!0}});var a=Kt(i,2);Hg(a,{variant:"secondary",size:"sm",onclick:v,children:(e,t)=>{Pt();var n=ua();zi(e=>va(n,e),[()=>bi(c)("modals.batchRemoveTags.clearAll")]),pa(e,n)},$$slots:{default:!0}});var r=Kt(a,2),s=Kt(Gt(r)),o=Gt(s,!0);zt(s),Pt(),zt(r),zt(n);var l=Kt(n,2);Ca(l,21,()=>bi(u)(),e=>e.tag,(e,t)=>{var n=Vk(),i=Gt(n);Za(i),i.__change=[Uk,p,t];var a=Kt(i,2),r=Gt(a),s=Gt(r);Ng(s,{get name(){return zg},size:14});var o=Kt(s,2),l=Gt(o,!0);zt(o),zt(r);var c=Kt(r,2),u=Gt(c),h=Gt(u);zt(u);var g=Kt(u,2),v=Gt(g);zt(g);var f=Kt(g,2),m=Gt(f);zt(f),zt(c),zt(a),zt(n),zi((e,n)=>{var a,r;Xa(i,e),va(l,bi(t).tag),va(h,`${null!=(a=bi(t).count)?a:""} 张卡片`),ja(v,`width: ${null!=(r=bi(t).percentage)?r:""}%`),va(m,`${null!=n?n:""}%`)},[()=>bi(d).has(bi(t).tag),()=>bi(t).percentage.toFixed(0)]),pa(e,n)}),zt(l);var h=Kt(l,2),f=e=>{var t=Hk(),n=Kt(Gt(t),2);Ca(n,21,()=>Array.from(bi(d)),_a,(e,t)=>{var n=qk(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(n);var i=Kt(n,2);Ng(Gt(i),{get name(){return Mg},size:14}),Pt(),zt(i),zt(t),pa(e,t)};xa(h,e=>{bi(d).size>0&&e(f)}),zi(()=>va(o,bi(d).size)),pa(e,t)};xa(w,e=>{0===bi(u)().length?e(k):e(S,!1)}),zt(o);var x=Kt(o,2),_=Gt(x);Hg(_,{variant:"secondary",onclick:m,children:(e,t)=>{Pt();var n=ua();zi(e=>va(n,e),[()=>bi(c)("modals.batchRemoveTags.cancel")]),pa(e,n)},$$slots:{default:!0}});var C=Kt(_,2);{let e=In(()=>0===bi(d).size);Hg(C,{variant:"danger",onclick:f,get disabled(){return bi(e)},children:(e,t)=>{Pt();var n=Gk(),i=Qt(n);Ng(Kt(i),{get name(){return fg},size:16}),zi(e=>va(i,`${null!=e?e:""} `),[()=>bi(c)("modals.batchRemoveTags.confirm")]),pa(e,n)},$$slots:{default:!0}})}zt(x),zt(n),zt(t),zi((e,t)=>{va(r,e),va(b,t)},[()=>bi(c)("modals.batchRemoveTags.title"),()=>bi(c)("modals.batchRemoveTags.info").replace("{count}",String(s().length))]),pa(e,t)};xa(w,e=>{r()&&e(k)}),pa(e,b);var S=St(y);return a(),S}ia(["click","keydown","change"]);class Zk extends ge.Component{constructor(e,t,n={}){var i;super(),oe(this,"widget"),oe(this,"app"),oe(this,"containerEl"),oe(this,"scope"),oe(this,"options"),this.app=e,this.containerEl=t,this.options=n,this.scope=new ge.Scope(this.app.scope),_e.debug("[EmbeddableEditor v3] 开始创建编辑器...");try{this.widget=this.app.embedRegistry.embedByExtension.md({app:this.app,containerEl:t},null,n.value||""),this.widget.editable=!0,this.widget.showEditor(),_e.debug("[EmbeddableEditor v3] ✅ Widget 创建成功"),_e.debug("[EmbeddableEditor v3] editMode:",!!this.widget.editMode),_e.debug("[EmbeddableEditor v3] editor:",!!(null==(i=this.widget.editMode)?void 0:i.editor)),requestAnimationFrame(()=>{setTimeout(()=>{this.initialize()},50)})}catch(a){throw _e.error("[EmbeddableEditor v3] ❌ 创建失败:",a),a}}initialize(){try{if(_e.debug("[EmbeddableEditor v3] 开始初始化..."),!this.widget||!this.widget.editMode)throw new Error("Widget 或 editMode 不存在");this.options.value&&this.widget.editMode.set(this.options.value),this.registerHotkeys(),this.registerEvents(),queueMicrotask(()=>{$s.getInstance().registerActive(this),_e.debug("[EmbeddableEditor v3] ✅ 已注册到全局上下文")}),_e.debug("[EmbeddableEditor v3] ✅ 初始化完成")}catch(e){throw _e.error("[EmbeddableEditor v3] ❌ 初始化失败:",e),e}}registerHotkeys(){this.scope.register(["Mod"],"Enter",()=>{var e,t;return null==(t=(e=this.options).onSubmit)||t.call(e,this),!0}),this.scope.register([],"Escape",()=>{var e,t;return null==(t=(e=this.options).onEscape)||t.call(e,this),!0}),this.app.keymap.pushScope(this.scope)}registerEvents(){var e,t;const n=null==(t=null==(e=this.widget.editMode)?void 0:e.editor)?void 0:t.cm;if(!n)return void _e.warn("[EmbeddableEditor v3] CM 不存在，跳过事件注册");if(this.options.onChange){const e=()=>{var e,t;null==(t=(e=this.options).onChange)||t.call(e,this)};n.contentDOM.addEventListener("input",e),this.register(()=>{n.contentDOM.removeEventListener("input",e)})}const i=()=>{_e.debug("[EmbeddableEditor v3] 编辑器获得焦点，重新注册到全局上下文"),$s.getInstance().registerActive(this)};n.contentDOM.addEventListener("focus",i);const a=()=>{_e.debug("[EmbeddableEditor v3] 编辑器失焦，取消全局注册"),$s.getInstance().unregisterActive(this),this.options.onBlur&&this.options.onBlur(this)};n.contentDOM.addEventListener("blur",a),this.register(()=>{n.contentDOM.removeEventListener("focus",i),n.contentDOM.removeEventListener("blur",a),$s.getInstance().unregisterActive(this)})}getCM(){var e,t,n;return null==(n=null==(t=null==(e=this.widget)?void 0:e.editMode)?void 0:t.editor)?void 0:n.cm}get value(){var e,t,n;try{return(null==(n=null==(t=null==(e=this.widget.editMode)?void 0:e.editor)?void 0:t.cm)?void 0:n.state.doc.toString())||""}catch(i){return _e.error("[EmbeddableEditor v3] 获取内容失败:",i),""}}setValue(e){var t;try{null==(t=this.widget.editMode)||t.set(e)}catch(n){_e.error("[EmbeddableEditor v3] 设置内容失败:",n)}}focus(){var e,t,n;try{null==(n=null==(t=null==(e=this.widget.editMode)?void 0:e.editor)?void 0:t.cm)||n.focus()}catch(i){_e.error("[EmbeddableEditor v3] 聚焦失败:",i)}}destroy(){_e.debug("[EmbeddableEditor v3] 开始销毁...");try{$s.getInstance().unregisterActive(this),this.app.keymap.popScope(this.scope),this.widget&&(this.widget.unload(),this.widget=null),this.containerEl.empty(),_e.debug("[EmbeddableEditor v3] ✅ 销毁完成")}catch(e){_e.error("[EmbeddableEditor v3] 销毁失败:",e)}}onunload(){this.destroy()}}class Yk{constructor(e){oe(this,"app"),oe(this,"sessions",new Map),oe(this,"STUDY_SESSION_CARD_ID","tuanki-study-session-editor"),oe(this,"currentEditingCardUuid",""),this.app=e,_e.debug("[EmbeddableEditorManager] 初始化")}get studySessionCardId(){return this.STUDY_SESSION_CARD_ID}setCurrentEditingCard(e){_e.debug("[EmbeddableEditorManager] 设置当前编辑卡片:",e),this.currentEditingCardUuid=e}async createEditorSession(e,t){try{const n=(null==t?void 0:t.isStudySession)?t.sessionId||this.STUDY_SESSION_CARD_ID:e.uuid;return _e.debug("[EmbeddableEditorManager] 创建编辑会话:",n),this.sessions.set(n,{editor:null,card:{...e},container:null}),{success:!0,sessionId:n,filePath:`virtual://card/${n}`}}catch(n){return _e.error("[EmbeddableEditorManager] 创建编辑会话失败:",n),{success:!1,error:n instanceof Error?n.message:"创建会话失败"}}}async createEmbeddedEditor(e,t,n,i){try{const a=this.sessions.get(t);if(!a)throw new Error(`会话不存在: ${t}`);_e.debug("[EmbeddableEditorManager] 创建嵌入式编辑器:",t),a.container=e;const r=new Zk(this.app,e,{value:a.card.content||"",placeholder:"在此编辑卡片内容...",onSubmit:e=>{_e.debug("[EmbeddableEditorManager] 编辑器保存回调"),n(e.value)},onEscape:()=>{_e.debug("[EmbeddableEditorManager] 编辑器取消回调"),i()},onChange:e=>{a.card.content=e.value}});return a.editor=r,_e.debug("[EmbeddableEditorManager] ✅ 编辑器创建成功"),{success:!0,cleanup:()=>{_e.debug("[EmbeddableEditorManager] 清理编辑器:",t),a.editor&&(a.editor.destroy(),a.editor=null),this.sessions.delete(t)}}}catch(a){return _e.error("[EmbeddableEditorManager] 创建编辑器失败:",a),{success:!1,error:a instanceof Error?a.message:"创建编辑器失败"}}}async finishEditing(e,t=!1,n){try{const i=this.sessions.get(e);if(!i)throw new Error(`会话不存在: ${e}`);_e.debug("[EmbeddableEditorManager] 完成编辑:",{sessionId:e,shouldSync:t,options:n,hasEditor:!!i.editor,sessionCardUuid:i.card.uuid});let a="";if(i.editor){const e=i.editor.value;_e.debug("[EmbeddableEditorManager] 从编辑器读取内容:",{editorValueLength:(null==e?void 0:e.length)||0,editorValuePreview:null==e?void 0:e.substring(0,100)}),a=e||""}a&&0!==a.trim().length||(_e.warn("[EmbeddableEditorManager] ⚠️ 编辑器内容为空，尝试使用session.card.content"),a=i.card.content||"");const r={...i.card,content:a,modified:(new Date).toISOString()};return _e.debug("[EmbeddableEditorManager] ✅ 编辑完成",{finalContentLength:a.length,updatedCardUuid:r.uuid}),{success:!0,updatedCard:r}}catch(i){return _e.error("[EmbeddableEditorManager] 完成编辑失败:",i),{success:!1,error:i instanceof Error?i.message:"完成编辑失败"}}}async cancelEditing(e){_e.debug("[EmbeddableEditorManager] 取消编辑:",e);const t=this.sessions.get(e);t&&(t.editor&&t.editor.destroy(),this.sessions.delete(e))}async updateSessionContent(e,t,n){try{const n=this.sessions.get(e);if(!n)throw new Error(`会话不存在: ${e}`);return _e.debug("[EmbeddableEditorManager] 更新会话内容:",e),n.card.content=t||"",n.editor&&(n.editor.setValue(t||""),_e.debug("[EmbeddableEditorManager] ✅ 编辑器内容已更新")),{success:!0}}catch(i){return _e.error("[EmbeddableEditorManager] 更新会话内容失败:",i),{success:!1,error:i instanceof Error?i.message:"更新内容失败"}}}async updateSessionCard(e,t){var n;try{const i=this.sessions.get(e);if(!i)throw new Error(`会话不存在: ${e}`);if(_e.debug("[EmbeddableEditorManager] 更新会话卡片对象:",{sessionId:e,newCardUuid:t.uuid,newCardContent:(null==(n=t.content)?void 0:n.substring(0,50))||"(空)"}),i.card={...t},i.editor){const e=t.content||"";i.editor.setValue(e),await new Promise(e=>setTimeout(e,50));const n=i.editor.value;_e.debug("[EmbeddableEditorManager] 编辑器内容设置验证:",{expectedLength:e.length,actualLength:(null==n?void 0:n.length)||0,success:n===e}),n!==e?_e.warn("[EmbeddableEditorManager] ⚠️ 编辑器内容设置可能失败，期望与实际不符"):_e.debug("[EmbeddableEditorManager] ✅ 会话卡片对象和编辑器内容已更新")}else _e.warn("[EmbeddableEditorManager] ⚠️ 会话中没有编辑器实例");return{success:!0}}catch(i){return _e.error("[EmbeddableEditorManager] 更新会话卡片对象失败:",i),{success:!1,error:i instanceof Error?i.message:"更新卡片对象失败"}}}cleanup(){_e.debug("[EmbeddableEditorManager] 清理所有会话");for(const[e,t]of this.sessions.entries())t.editor&&t.editor.destroy();this.sessions.clear()}}const Xk=Object.freeze(Object.defineProperty({__proto__:null,EmbeddableEditorManager:Yk},Symbol.toStringTag,{value:"Module"})),Jk=["front","back","status","deck","tags","priority","question_type","accuracy","test_attempts","last_test","error_level","source_card","created","modified","next_review","retention","interval","difficulty","review_count","uuid","obsidian_block_link","source_document","field_template","source_document_status","actions"],eS={basic:["front","back","status","deck","tags","priority","created","modified","source_document","obsidian_block_link"],review:["front","back","status","next_review","retention","interval","difficulty","review_count"],advanced:["uuid","field_template","source_document_status"],shared:["front","back","status"]};function tS(e,t,n){$n(t,!bi(t)),localStorage.setItem(n,String(bi(t)))}var nS=(e,t,n)=>t()(bi(n),e.currentTarget.checked),iS=la('<span class="shared-badge svelte-1yu97fo">[通用]</span>'),aS=la('<li draggable="true"><label class="svelte-1yu97fo"><input type="checkbox" class="svelte-1yu97fo"/> <span class="column-label svelte-1yu97fo"> <!></span></label></li>'),rS=(e,t,n)=>t()(bi(n),e.currentTarget.checked),sS=la('<li draggable="true"><label class="svelte-1yu97fo"><input type="checkbox" class="svelte-1yu97fo"/> <span class="column-label svelte-1yu97fo"> </span></label></li>'),oS=(e,t,n)=>t()(bi(n),e.currentTarget.checked),lS=la('<li draggable="true"><label class="svelte-1yu97fo"><input type="checkbox" class="svelte-1yu97fo"/> <span class="column-label svelte-1yu97fo"> </span></label></li>'),cS=la('<ul class="advanced-section-list svelte-1yu97fo"></ul>'),dS=la('<div class="column-manager svelte-1yu97fo"><div class="column-manager-header svelte-1yu97fo"><span>显示字段</span> <span class="drag-hint svelte-1yu97fo">拖拽调整顺序</span></div> <div class="column-manager-grid svelte-1yu97fo"><div class="column-group svelte-1yu97fo"><div class="column-group-header svelte-1yu97fo">基础信息</div> <ul class="column-group-list svelte-1yu97fo"></ul></div> <div class="column-group svelte-1yu97fo"><div class="column-group-header svelte-1yu97fo">复习数据</div> <ul class="column-group-list svelte-1yu97fo"></ul></div></div> <div><div class="advanced-section-header svelte-1yu97fo"><span> </span> <span class="toggle-icon svelte-1yu97fo"> </span></div> <!></div></div>');function uS(e,t){if(new.target)return Er({component:uS,...e});kt(t,!0);let n=Ar(t,"visibility",7),i=Ar(t,"columnOrder",7),a=Ar(t,"onVisibilityChange",7),r=Ar(t,"onOrderChange",7);const s={front:"正面内容",back:"背面内容",status:"状态",deck:"牌组",tags:"标签",priority:"优先级",created:"创建时间",modified:"修改时间",next_review:"下次复习",retention:"记忆率",interval:"间隔",difficulty:"难度",review_count:"复习次数",actions:"操作",uuid:"唯一标识符",obsidian_block_link:"Obsidian块链接",source_document:"来源文档",field_template:"字段模板",source_document_status:"来源状态"},o="tuanki-column-manager-advanced-expanded";let l=Pn(!1),c=Pn(null),d=Pn(null),u=Pn(null);const h=In(()=>i().filter(e=>eS.basic.includes(e)&&!eS.advanced.includes(e))),p=In(()=>i().filter(e=>eS.review.includes(e)&&!eS.basic.includes(e)&&!eS.advanced.includes(e))),g=In(()=>i().filter(e=>eS.advanced.includes(e)));function v(e,t,n){$n(c,t,!0),$n(d,n,!0),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",""))}function f(e,t,n){e.preventDefault(),bi(d)===n?(e.dataTransfer&&(e.dataTransfer.dropEffect="move"),$n(u,t,!0)):e.dataTransfer&&(e.dataTransfer.dropEffect="none")}function m(){$n(u,null)}function y(e,t,n){if(e.preventDefault(),!bi(c)||bi(d)!==n||bi(c)===t)return $n(c,null),$n(d,null),void $n(u,null);const a=i().indexOf(bi(c)),s=i().indexOf(t);if(-1===a||-1===s)return $n(c,null),$n(d,null),void $n(u,null);const o=[...i()],[l]=o.splice(a,1);o.splice(s,0,l),r()(o),$n(c,null),$n(d,null),$n(u,null)}function b(){$n(c,null),$n(d,null),$n(u,null)}Pr(()=>{const e=localStorage.getItem(o);null!==e&&$n(l,"true"===e)});var w={get visibility(){return n()},set visibility(e){n(e),hn()},get columnOrder(){return i()},set columnOrder(e){i(e),hn()},get onVisibilityChange(){return a()},set onVisibilityChange(e){a(e),hn()},get onOrderChange(){return r()},set onOrderChange(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},k=dS(),S=Kt(Gt(k),2),x=Gt(S),_=Kt(Gt(x),2);Ca(_,21,()=>bi(h),_a,(e,t)=>{var i=aS();let r;var o=Gt(i),l=Gt(o);Za(l),l.__change=[nS,a,t];var d=Kt(l,2),h=Gt(d),p=Kt(h),g=e=>{pa(e,iS())};xa(p,e=>{(function(e){return eS.shared.includes(e)})(bi(t))&&e(g)}),zt(d),zt(o),zt(i),zi(e=>{var a;r=Fa(i,1,"column-manager-item svelte-1yu97fo",null,r,e),Xa(l,n()[bi(t)]),va(h,`${null!=(a=s[bi(t)])?a:""} `)},[()=>({dragging:bi(c)===bi(t),"drag-over":bi(u)===bi(t)})]),na("dragstart",i,e=>v(e,bi(t),"basic")),na("dragover",i,e=>f(e,bi(t),"basic")),na("dragleave",i,m),na("drop",i,e=>y(e,bi(t),"basic")),na("dragend",i,b),pa(e,i)}),zt(_),zt(x);var C=Kt(x,2),I=Kt(Gt(C),2);Ca(I,21,()=>bi(p),_a,(e,t)=>{var i=sS();let r;var o=Gt(i),l=Gt(o);Za(l),l.__change=[rS,a,t];var d=Kt(l,2),h=Gt(d,!0);zt(d),zt(o),zt(i),zi(e=>{r=Fa(i,1,"column-manager-item svelte-1yu97fo",null,r,e),Xa(l,n()[bi(t)]),va(h,s[bi(t)])},[()=>({dragging:bi(c)===bi(t),"drag-over":bi(u)===bi(t)})]),na("dragstart",i,e=>v(e,bi(t),"review")),na("dragover",i,e=>f(e,bi(t),"review")),na("dragleave",i,m),na("drop",i,e=>y(e,bi(t),"review")),na("dragend",i,b),pa(e,i)}),zt(I),zt(C),zt(S);var D=Kt(S,2);let T;var M=Gt(D);M.__click=[tS,l,o];var A=Gt(M),E=Gt(A);zt(A);var z=Kt(A,2),P=Gt(z,!0);zt(z),zt(M);var R=Kt(M,2),$=e=>{var t=cS();Ca(t,21,()=>bi(g),_a,(e,t)=>{var i=lS();let r;var o=Gt(i),l=Gt(o);Za(l),l.__change=[oS,a,t];var d=Kt(l,2),h=Gt(d,!0);zt(d),zt(o),zt(i),zi(e=>{r=Fa(i,1,"column-manager-item svelte-1yu97fo",null,r,e),Xa(l,n()[bi(t)]),va(h,s[bi(t)])},[()=>({dragging:bi(c)===bi(t),"drag-over":bi(u)===bi(t)})]),na("dragstart",i,e=>v(e,bi(t),"advanced")),na("dragover",i,e=>f(e,bi(t),"advanced")),na("dragleave",i,m),na("drop",i,e=>y(e,bi(t),"advanced")),na("dragend",i,b),pa(e,i)}),zt(t),pa(e,t)};return xa(R,e=>{bi(l)&&e($)}),zt(D),zt(k),zi(e=>{T=Fa(D,1,"advanced-section svelte-1yu97fo",null,T,e),va(E,`高级选项（点击${bi(l)?"收起":"展开"}）`),va(P,bi(l)?"▲":"▼")},[()=>({expanded:bi(l)})]),pa(e,k),St(w)}function hS(e,t){const n=parseInt(e.target.value,10);t()(n)}ia(["change","click"]);var pS=la('<option class="svelte-12hy393"> </option>'),gS=(e,t)=>t(1),vS=(e,t,n)=>t(n()-1),fS=(e,t,n)=>t(n()+1),mS=(e,t,n)=>t(bi(n)),yS=la('<div><div class="items-per-page svelte-12hy393"><select class="svelte-12hy393"></select></div> <div class="pagination-controls svelte-12hy393"><button class="svelte-12hy393">&laquo;</button> <button class="svelte-12hy393">&lsaquo;</button> <span class="page-info svelte-12hy393"> </span> <button class="svelte-12hy393">&rsaquo;</button> <button class="svelte-12hy393">&raquo;</button></div> <div class="total-items svelte-12hy393"> </div></div>');function bS(e,t){if(new.target)return Er({component:bS,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"currentPage",7),s=Ar(t,"totalItems",7),o=Ar(t,"itemsPerPage",7),l=Ar(t,"onPageChange",7),c=Ar(t,"onItemsPerPageChange",7),d=In(n);const u=[20,50,100,200,500];let h=In(()=>Math.ceil(s()/o())),p=Pn(!1);function g(e){e>=1&&e<=bi(h)&&!bi(p)&&($n(p,!0),l()(e),setTimeout(()=>{$n(p,!1)},300))}var v={get currentPage(){return r()},set currentPage(e){r(e),hn()},get totalItems(){return s()},set totalItems(e){s(e),hn()},get itemsPerPage(){return o()},set itemsPerPage(e){o(e),hn()},get onPageChange(){return l()},set onPageChange(e){l(e),hn()},get onItemsPerPageChange(){return c()},set onItemsPerPageChange(e){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},f=yS();let m;var y,b=Gt(f),w=Gt(b);w.__change=[hS,c],Ca(w,21,()=>u,_a,(e,t)=>{var n=pS(),i=Gt(n,!0);zt(n);var a={};zi(()=>{var e;va(i,bi(t)),a!==(a=bi(t))&&(n.value=null!=(e=n.__value=bi(t))?e:"")}),pa(e,n)}),zt(w),Va(w),zt(b);var k=Kt(b,2),S=Gt(k);S.__click=[gS,g];var x=Kt(S,2);x.__click=[vS,g,r];var _=Kt(x,2),C=Gt(_,!0);zt(_);var I=Kt(_,2);I.__click=[fS,g,r];var D=Kt(I,2);D.__click=[mS,g,h],zt(k);var T=Kt(k,2),M=Gt(T,!0);zt(T),zt(f),zi((e,t,n,i,a,s,l)=>{var c;m=Fa(f,1,"table-pagination svelte-12hy393",null,m,e),y!==(y=o())&&(w.value=null!=(c=w.__value=o())?c:"",Ua(w,o())),S.disabled=1===r(),er(S,"title",t),x.disabled=1===r(),er(x,"title",n),va(C,i),I.disabled=r()===bi(h),er(I,"title",a),D.disabled=r()===bi(h),er(D,"title",s),va(M,l)},[()=>({transitioning:bi(p)}),()=>bi(d)("ui.pagination.previous"),()=>bi(d)("ui.pagination.previous"),()=>bi(d)("ui.pagination.page").replace("{n}",`${r()}/${bi(h)}`),()=>bi(d)("ui.pagination.next"),()=>bi(d)("ui.pagination.next"),()=>bi(d)("ui.pagination.total").replace("{n}",String(s()))]),pa(e,f);var A=St(v);return a(),A}function wS(e){let t=e;return t=t.replace(/\.md$/i,""),t=t.replace(/^\/+/,""),t=t.toLowerCase(),t=t.replace(/\\/g,"/"),t}function kS(e){const t=e.replace(/\\/g,"/").split("/");return t[t.length-1].replace(/\.md$/i,"").toLowerCase()}function SS(e,t){return t?e.filter(e=>function(e,t){const n=function(e){var t,n;return e.sourceFile?e.sourceFile:(null==(t=e.fields)?void 0:t.source_document)?e.fields.source_document:(null==(n=e.customFields)?void 0:n.obsidianFilePath)?e.customFields.obsidianFilePath:null}(e);if(!n||!t)return!1;const i=wS(n),a=wS(t);if(i===a)return!0;const r=kS(n);return r===kS(t)&&""!==r||!(!a.endsWith(`/${i}`)&&!a.endsWith(i))||!(!i.endsWith(`/${a}`)&&!i.endsWith(a))}(e,t)):[]}function xS(e){return e.startsWith("#")?e.slice(1):e}function _S(e,t){if(!e||0===e.length)return!1;const n=xS(t);return e.some(e=>{const t=xS(e);return t===n||t.startsWith(`${n}/`)})}ia(["change","click"]);var CS=(e=>(e.BASIC_QA="basic-qa",e.SINGLE_CHOICE="single-choice",e.MULTIPLE_CHOICE="multiple-choice",e.CLOZE_DELETION="cloze-deletion",e.FILL_IN_BLANK="fill-in-blank",e.SEQUENCE="sequence",e.EXTENSIBLE="extensible",e))(CS||{});const IS={"basic-qa":{id:"basic-qa",name:"问答题",description:"基础问答卡片，上方显示问题，下方显示答案",displayMode:"vertical-split",renderingHints:{questionPosition:"top",answerReveal:"click",interactionMode:"click-reveal",showProgress:!1,enableAnimations:!0,keyboardNavigation:!0,autoFocus:!1},supportedFields:["question","answer","hint","explanation"],supportsMedia:!0,supportsMath:!0,supportsCode:!0},"single-choice":{id:"single-choice",name:"单选题",description:"单选题卡片，显示问题和选项，只有一个正确答案",displayMode:"interactive",renderingHints:{questionPosition:"top",answerReveal:"auto",interactionMode:"select",showProgress:!0,enableAnimations:!0,keyboardNavigation:!0,autoFocus:!0},supportedFields:["question","options","correct_answer","explanation"],supportsMedia:!0,supportsMath:!0,supportsCode:!1},"multiple-choice":{id:"multiple-choice",name:"多选题",description:"多选题卡片，显示问题和选项，有多个正确答案",displayMode:"interactive",renderingHints:{questionPosition:"top",answerReveal:"auto",interactionMode:"select",showProgress:!0,enableAnimations:!0,keyboardNavigation:!0,autoFocus:!0},supportedFields:["question","options","correct_answers","explanation"],supportsMedia:!0,supportsMath:!0,supportsCode:!1},"cloze-deletion":{id:"cloze-deletion",name:"挖空题",description:"挖空卡片，在原文位置隐藏部分内容，点击显示答案",displayMode:"inline",renderingHints:{questionPosition:"inline",answerReveal:"click",interactionMode:"click-reveal",showProgress:!0,enableAnimations:!0,keyboardNavigation:!0,autoFocus:!1},supportedFields:["content","cloze","hint"],supportsMedia:!0,supportsMath:!0,supportsCode:!0},"fill-in-blank":{id:"fill-in-blank",name:"填空题",description:"填空卡片，提供输入框让用户填写答案",displayMode:"interactive",renderingHints:{questionPosition:"top",answerReveal:"manual",interactionMode:"input",showProgress:!0,enableAnimations:!0,keyboardNavigation:!0,autoFocus:!0},supportedFields:["question","blanks","answers","hint"],supportsMedia:!0,supportsMath:!0,supportsCode:!1},sequence:{id:"sequence",name:"顺序题",description:"顺序卡片，按顺序逐步显示内容",displayMode:"progressive",renderingHints:{questionPosition:"top",answerReveal:"progressive",interactionMode:"click-reveal",showProgress:!0,enableAnimations:!0,keyboardNavigation:!0,autoFocus:!1},supportedFields:["title","steps","conclusion"],supportsMedia:!0,supportsMath:!0,supportsCode:!0},extensible:{id:"extensible",name:"扩展题型",description:"可扩展的自定义题型",displayMode:"interactive",renderingHints:{questionPosition:"top",answerReveal:"manual",interactionMode:"auto",showProgress:!1,enableAnimations:!0,keyboardNavigation:!0,autoFocus:!1},supportedFields:["content"],supportsMedia:!0,supportsMath:!0,supportsCode:!0}},DS=[{from:"basic",to:"basic-qa",confidence:1,requiresConfirmation:!1},{from:"qa",to:"basic-qa",confidence:1,requiresConfirmation:!1},{from:"cloze",to:"cloze-deletion",confidence:1,requiresConfirmation:!1},{from:"multiple",to:"multiple-choice",confidence:1,requiresConfirmation:!1},{from:"mcq",to:"multiple-choice",confidence:1,requiresConfirmation:!1},{from:"single",to:"single-choice",confidence:1,requiresConfirmation:!1},{from:"choice",to:"single-choice",confidence:.9,requiresConfirmation:!1},{from:"code",to:"basic-qa",confidence:.8,requiresConfirmation:!0},{from:"basic-qa",to:"basic-qa",confidence:1,requiresConfirmation:!1},{from:"single-choice",to:"single-choice",confidence:1,requiresConfirmation:!1},{from:"multiple-choice",to:"multiple-choice",confidence:1,requiresConfirmation:!1},{from:"cloze-deletion",to:"cloze-deletion",confidence:1,requiresConfirmation:!1},{from:"extensible",to:"extensible",confidence:1,requiresConfirmation:!1}];function TS(e){if(!e)return CS.BASIC_QA;if(e.templateId){const t=xf.find(t=>t.id===e.templateId);if(t){const e=t.cardType;if(e){const t=DS.find(t=>t.from===e);if(t)return t.to}}const n=e.templateId.toLowerCase();if(n.includes("choice")||n.includes("mcq")||n.includes("multiple"))return n.includes("single")?CS.SINGLE_CHOICE:n.includes("multiple")?CS.MULTIPLE_CHOICE:CS.SINGLE_CHOICE;if(n.includes("cloze")||n.includes("挖空"))return CS.CLOZE_DELETION;if(n.includes("fill")||n.includes("blank")||n.includes("填空"))return CS.FILL_IN_BLANK;if(n.includes("sequence")||n.includes("顺序"))return CS.SEQUENCE}if(e.type){const t=DS.find(t=>t.from===e.type.toLowerCase());if(t)return t.to}return CS.BASIC_QA}const MS={light:{label:"轻度错题",icon:"alert-circle",color:"var(--color-yellow)",bgColor:"rgba(245, 158, 11, 0.1)",range:"1-2次错误",description:"偶尔出错，需要适度复习",threshold:{min:1,max:2}},medium:{label:"中度错题",icon:"alert-triangle",color:"var(--color-orange)",bgColor:"rgba(249, 115, 22, 0.1)",range:"3-5次错误",description:"多次出错，需要重点关注",threshold:{min:3,max:5}},severe:{label:"重度错题",icon:"alert-octagon",color:"var(--color-red)",bgColor:"rgba(239, 68, 68, 0.1)",range:"6+次错误",description:"频繁出错，强烈建议深入学习",threshold:{min:6,max:1/0}}};function AS(e){return 0===e||e<0?null:e<=MS.light.threshold.max?"light":e<=MS.medium.threshold.max?"medium":"severe"}function ES(e){var t,n,i;return(null==e?void 0:e.stats)?(null==(t=e.stats.errorTracking)?void 0:t.errorLevel)?e.stats.errorTracking.errorLevel:void 0!==(null==(n=e.stats.errorTracking)?void 0:n.errorCount)?AS(e.stats.errorTracking.errorCount):void 0!==(null==(i=e.stats.choiceStats)?void 0:i.errorCount)?AS(e.stats.choiceStats.errorCount):null:null}function zS(){const e=new Date;return{start:new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0,0).getTime(),end:new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59,999).getTime()}}function PS(e){const{start:t,end:n}=zS(),i="number"==typeof e?e:e.getTime();return i>=t&&i<=n}function RS(e){var t;if(!(null==(t=e.fsrs)?void 0:t.due))return!1;return PS("number"==typeof e.fsrs.due?e.fsrs.due:Number(e.fsrs.due))}function $S(e){if(!e.created)return!1;return PS("string"==typeof e.created?new Date(e.created).getTime():Number(e.created))}function OS(e){return!!e.lastSyncTime&&PS(e.lastSyncTime)}function LS(e){var t;if(!(null==(t=e.fsrs)?void 0:t.reviewHistory)||0===e.fsrs.reviewHistory.length)return!1;const n=e.fsrs.reviewHistory[e.fsrs.reviewHistory.length-1];if(null==n?void 0:n.review){return PS(new Date(n.review).getTime())}return!1}function NS(e){var t;return 1===(null==(t=e.fsrs)?void 0:t.state)}function FS(e){var t;return 3===(null==(t=e.fsrs)?void 0:t.state)&&LS(e)}function BS(e){var t;return!(null==(t=e.fsrs)?void 0:t.reviewHistory)||0===e.fsrs.reviewHistory.length}async function jS(e,t,n,i){const a=Date.now(),r={total:e.length,success:0,failed:0,errors:[],duration:0};for(let o=0;o<e.length;o++){const i=e[o];try{const e=t(i),a=await n.saveCard(e);a.success?r.success++:(r.failed++,r.errors.push({cardId:i.uuid,cardTitle:US(i),error:a.error||"保存失败"}),_e.error(`[BatchOperation] 保存卡片失败: ${i.uuid}`,a.error))}catch(s){r.failed++,r.errors.push({cardId:i.uuid,cardTitle:US(i),error:s instanceof Error?s.message:"未知错误"}),_e.error(`[BatchOperation] 更新卡片失败: ${i.uuid}`,s)}(o+1)%10==0&&await new Promise(e=>setTimeout(e,0))}return r.duration=Date.now()-a,_e.debug("[BatchOperation] 批量操作完成:",r),r}function US(e){var t,n,i,a;return(null==(t=e.fields)?void 0:t.front)||(null==(n=e.fields)?void 0:n.question)||(null==(i=e.fields)?void 0:i.word)||(null==(a=e.fields)?void 0:a.term)||`卡片 ${e.uuid.substring(0,8)}`}const VS=[{id:"basic",label:"settings.categories.basic"},{id:"fsrs6",label:"settings.categories.fsrs6"},{id:"annotation",label:"settings.categories.annotation"},{id:"card-parsing",label:"settings.categories.cardParsing"},{id:"ai-config",label:"settings.categories.aiConfig"},{id:"virtualization",label:"settings.categories.virtualization"},{id:"data-management",label:"settings.categories.dataManagement"},{id:"anki-connect",label:"settings.categories.ankiConnect"},{id:"about",label:"settings.categories.about"}],qS="basic",HS=5e3,WS=3e3,GS={small:{width:600,height:400,label:"小 (600×400)"},medium:{width:700,height:500,label:"中 (700×500)"},large:{width:800,height:600,label:"大 (800×600)"},"extra-large":{width:1e3,height:700,label:"超大 (1000×700)"},custom:{width:800,height:600,label:"自定义"}},QS=400,KS=1400,ZS=300,YS=900,XS="Tuanki - 智能记忆卡片插件",JS="v0.5.0",ex={openai:"https://api.openai.com/v1",gemini:"https://generativelanguage.googleapis.com/v1beta",anthropic:"https://api.anthropic.com",deepseek:"https://api.deepseek.com",zhipu:"https://open.bigmodel.cn/api/paas/v4",siliconflow:"https://api.siliconflow.cn/v1",xai:"https://api.x.ai/v1"},tx={apiKeys:{openai:{apiKey:"",model:"gpt-4o-mini",verified:!1,baseUrl:void 0},gemini:{apiKey:"",model:"gemini-1.5-pro",verified:!1,baseUrl:void 0},anthropic:{apiKey:"",model:"claude-3-5-sonnet-20241022",verified:!1,baseUrl:void 0},deepseek:{apiKey:"",model:"deepseek-chat",verified:!1,baseUrl:void 0},zhipu:{apiKey:"",model:"glm-4-flash",verified:!1,baseUrl:void 0},siliconflow:{apiKey:"",model:"Qwen/Qwen2.5-7B-Instruct",verified:!1,baseUrl:void 0},xai:{apiKey:"",model:"grok-3",verified:!1,baseUrl:void 0}},defaultProvider:"zhipu",lastUsedProvider:void 0,lastUsedModel:void 0,formattingProvider:void 0,splittingProvider:void 0,formatting:{enabled:!0},globalParams:{temperature:.7,maxTokens:2e3,requestTimeout:30,concurrentLimit:3},systemPromptConfig:{useBuiltin:!0,customPrompt:"",lastModified:void 0,customSystemPrompts:[],selectedSystemPromptId:void 0},promptTemplates:{official:[{id:"standard-qa",name:"标准问答生成",prompt:"请根据以下内容生成{count}张问答卡片，难度为{difficulty}。要求问题简洁明确，答案完整准确。",useBuiltinSystemPrompt:!0,description:"适用于一般性学习材料，生成标准问答卡片，包含多种题型",variables:["count","difficulty","template"],createdAt:(new Date).toISOString()},{id:"concept-explain",name:"概念解释型",prompt:"请提取关键概念并生成解释型卡片，包含定义、特点、应用场景。",useBuiltinSystemPrompt:!0,description:"专注于概念理解，生成定义类、解释类卡片",variables:["count"],createdAt:(new Date).toISOString()},{id:"deep-understanding",name:"深度理解型",prompt:"生成需要深度思考的卡片，重点考察理解、分析、应用能力。避免简单记忆型问题。",useBuiltinSystemPrompt:!0,description:"生成高阶思维卡片，强调理解和应用",variables:["count","difficulty"],createdAt:(new Date).toISOString()},{id:"cloze-fill",name:"挖空填充型",prompt:"生成挖空题，使用{{c1::}}语法标记关键词。每张卡片1-3个挖空点。",useBuiltinSystemPrompt:!0,description:"专注于生成挖空题，适合记忆关键术语和概念",variables:["count"],createdAt:(new Date).toISOString()}],custom:[]},imageGeneration:{defaultSyntax:"wiki",attachmentDir:"attachments/ai-generated",autoCreateSubfolders:!0,includeTimestamp:!0,includeCaption:!0},history:{enabled:!0,retentionDays:30,showCostStats:!0,autoCleanFailures:!0},statistics:{totalGenerations:0,totalCards:0,successfulImports:0,totalCost:0,monthlyCost:0},security:{encryptApiKeys:!0,enableContentFilter:!0,anonymousStats:!1},shortcuts:{},cardSplitting:{enabled:!0,defaultTargetCount:0,minContentLength:100,maxContentLength:5e3,autoInheritTags:!0,autoInheritSource:!0,requireConfirmation:!0,defaultInstruction:""},customFormatActions:[],customTestGenActions:[]},nx={openai:[{id:"gpt-5",label:"GPT-5",description:"2025年最新旗舰模型，27万tokens上下文"},{id:"gpt-4.1",label:"GPT-4.1",description:"100万tokens上下文，通用问题解决"},{id:"o3-mini",label:"o3-mini",description:"推理专用模型，数学和编程优化"},{id:"gpt-4o",label:"GPT-4o",description:"经典多模态模型"},{id:"gpt-4-turbo",label:"GPT-4 Turbo",description:"高性能版本"},{id:"gpt-3.5-turbo",label:"GPT-3.5 Turbo",description:"经济型选择"}],gemini:[{id:"gemini-2.5-pro",label:"Gemini 2.5 Pro",description:"2025最新版，深度思考模式，100万tokens"},{id:"gemini-2.0-flash-thinking",label:"Gemini 2.0 Flash Thinking",description:"推理增强版，快速响应"},{id:"gemini-1.5-pro",label:"Gemini 1.5 Pro",description:"经典版本"},{id:"gemini-1.5-flash",label:"Gemini 1.5 Flash",description:"快速响应"}],anthropic:[{id:"claude-4-opus-20250522",label:"Claude 4 Opus",description:"2025最新旗舰，代码能力世界第一，20万tokens"},{id:"claude-4-sonnet-20250522",label:"Claude 4 Sonnet",description:"2025平衡版，高效处理复杂任务"},{id:"claude-3-5-sonnet-20241022",label:"Claude 3.5 Sonnet",description:"经典高性能版本"},{id:"claude-3-opus-20240229",label:"Claude 3 Opus",description:"传统最强性能"}],deepseek:[{id:"deepseek-r1-0528",label:"DeepSeek R1 0528",description:"2025最新推理模型，数学能力大幅提升"},{id:"deepseek-v3",label:"DeepSeek V3",description:"67.1B参数MoE架构，成本极低"},{id:"deepseek-chat",label:"DeepSeek Chat",description:"通用对话模型"},{id:"deepseek-coder",label:"DeepSeek Coder",description:"代码专用模型"}],zhipu:[{id:"glm-4-plus",label:"GLM-4 Plus",description:"2025增强版，性能全面提升"},{id:"glm-4-flash",label:"GLM-4 Flash",description:"快速响应，免费使用"},{id:"glm-4-air",label:"GLM-4 Air",description:"轻量版本，经济实惠"},{id:"glm-4",label:"GLM-4",description:"标准版本，性能均衡"}],siliconflow:[{id:"Qwen/Qwen3-235B-A22B-Thinking-2507",label:"Qwen3 235B Thinking",description:"2025年7月最新推理模型"},{id:"Qwen/Qwen2.5-72B-Instruct",label:"Qwen2.5 72B",description:"通义千问 - 高性能"},{id:"Qwen/Qwen2.5-7B-Instruct",label:"Qwen2.5 7B",description:"通义千问 - 快速响应"},{id:"deepseek-ai/DeepSeek-V3",label:"DeepSeek V3",description:"深度求索2025最新版"},{id:"deepseek-ai/DeepSeek-R1-0528",label:"DeepSeek R1 0528",description:"2025年5月推理增强版"},{id:"THUDM/glm-4-9b-chat",label:"GLM-4 9B",description:"智谱清言"},{id:"meta-llama/Llama-3.3-70B-Instruct",label:"Llama 3.3 70B",description:"Meta开源最新版"},{id:"google/gemma-2-9b-it",label:"Gemma 2 9B",description:"Google轻量版"},{id:"Pro/01-ai/Yi-Lightning",label:"Yi Lightning",description:"零一万物 - 极速版"}],xai:[{id:"grok-4",label:"Grok 4",description:"2025年7月发布，xAI最新模型，25.6万tokens"},{id:"grok-3",label:"Grok 3",description:"xAI推理革新模型"}]},ix={openai:"OpenAI",gemini:"Google Gemini",anthropic:"Anthropic Claude",deepseek:"DeepSeek",zhipu:"智谱清言",siliconflow:"硅基流动",xai:"xAI Grok"},ax=[{id:"fsrs",name:"FSRS算法",icon:"🧠",description:"科学的间隔重复算法",url:"https://github.com/open-spaced-repetition/fsrs4anki"},{id:"obsidian",name:"Obsidian",icon:"💎",description:"优秀的知识管理平台",url:"https://obsidian.md/"},{id:"anki",name:"Anki",icon:"🎴",description:"间隔重复学习先驱",url:"https://apps.ankiweb.net/"},{id:"samdagreatwzzz",name:"SamdaGreatzzz",icon:"🎬",description:"AI制卡设计灵感",url:"https://space.bilibili.com/22291849/"}];function rx(e,t,n){"Escape"===e.key&&t()&&(e.preventDefault(),e.stopPropagation(),n())}var sx=la('<h2 id="modal-title"> </h2>'),ox=la('<div class="modal-header-actions svelte-1u6nh71"><!></div>'),lx=la('<button class="modal-close-btn svelte-1u6nh71" aria-label="关闭">✕</button>'),cx=la('<header><div class="modal-header-left svelte-1u6nh71"><!></div> <div class="modal-header-right svelte-1u6nh71"><!> <!></div></header>'),dx=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t(e))},ux=la('<button type="button" class="top-drag-handle svelte-1u6nh71" aria-label="拖动窗口"><span class="drag-handle-icon">⋮⋮</span></button>'),hx=(e,t)=>t(e,"right"),px=(e,t)=>t(e,"right"),gx=(e,t)=>t(e,"bottom"),vx=(e,t)=>t(e,"bottom"),fx=(e,t)=>t(e,"left"),mx=(e,t)=>t(e,"left"),yx=(e,t)=>t(e,"top"),bx=(e,t)=>t(e,"top"),kx=(e,t)=>t(e,"bottom-right"),Sx=(e,t)=>t(e,"bottom-right"),xx=(e,t)=>t(e,"top-left"),_x=(e,t)=>t(e,"top-left"),Cx=(e,t)=>t(e,"top-right"),Ix=(e,t)=>t(e,"top-right"),Dx=(e,t)=>t(e,"bottom-left"),Tx=(e,t)=>t(e,"bottom-left"),Mx=la('<div class="resize-handle resize-handle-right svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口右边缘"></div> <div class="resize-handle resize-handle-bottom svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口下边缘"></div> <div class="resize-handle resize-handle-left svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口左边缘"></div> <div class="resize-handle resize-handle-top svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口上边缘"></div> <div class="resize-handle resize-handle-bottom-right svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口右下角"></div> <div class="resize-handle resize-handle-top-left svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口左上角"></div> <div class="resize-handle resize-handle-top-right svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口右上角"></div> <div class="resize-handle resize-handle-bottom-left svelte-1u6nh71" role="button" tabindex="0" aria-label="调整窗口左下角"></div>',1),Ax=la('<div class="size-indicator svelte-1u6nh71"> </div>'),Ex=la('<div role="presentation"><div role="dialog" aria-modal="true" tabindex="-1"><!> <!> <main class="modal-content svelte-1u6nh71"><!></main> <!> <!></div></div>');function zx(e,t){if(new.target)return Er({component:zx,...e});kt(t,!0);let n=Ar(t,"open",15),i=Ar(t,"onClose",7),a=Ar(t,"plugin",7),r=Ar(t,"title",7),s=Ar(t,"closable",7,!0),o=Ar(t,"maskClosable",7,!0),l=Ar(t,"keyboard",7,!0),c=Ar(t,"className",7,""),d=Ar(t,"enableTransparentMask",7,!1),u=Ar(t,"enableWindowDrag",7,!1),h=Ar(t,"children",7),p=Ar(t,"headerActions",7),g=Ar(t,"modalSizeKey",7,"editorModalSize"),v=Ar(t,"accentColor",7,"blue"),f=Pn(void 0),m=Pn(!1),y=Pn(""),b=Pn(0),w=Pn(0),k=Pn(0),S=Pn(0),x=Pn(0),_=Pn(0),C=Pn(!1),I=Pn(0),D=Pn(0),T=Pn(0),M=Pn(0),A=Pn(!1),E=Pn(!1),z=In(()=>a().settings[g()]||{preset:"large",customWidth:800,customHeight:600,rememberLastSize:!0,enableResize:!0}),P=Pn(800),R=Pn(600);function $(){O(),n(!1),i()()}async function O(){try{a().settings[g()]={...bi(z),customWidth:bi(P),customHeight:bi(R),preset:"custom"},await a().saveSettings(),_e.debug(`[ResizableModal] 保存${g()}尺寸:`,{width:bi(P),height:bi(R)})}catch(e){_e.error(`保存${g()}尺寸失败:`,e)}}function L(e,t){bi(z).enableResize&&(bi(A)||($n(A,!0),_e.debug("[ResizableModal] 拖拽功能已初始化")),e.preventDefault(),$n(m,!0),$n(y,t,!0),$n(b,e.clientX,!0),$n(w,e.clientY,!0),$n(k,bi(P),!0),$n(S,bi(R),!0),document.addEventListener("mousemove",F),document.addEventListener("mouseup",B),document.body.style.cursor=function(e){switch(e){case"right":case"left":return"ew-resize";case"top":case"bottom":return"ns-resize";case"top-left":case"bottom-right":return"nw-resize";case"top-right":case"bottom-left":return"ne-resize";default:return"default"}}(t),document.body.style.userSelect="none")}function N(e,t){if(bi(z).enableResize&&("Enter"===e.key||" "===e.key)){e.preventDefault();const n=e.target.getBoundingClientRect();L(new MouseEvent("mousedown",{clientX:n.left+n.width/2,clientY:n.top+n.height/2,bubbles:!0}),t)}}function F(e){if(!bi(m))return;const t=e.clientX-bi(b),n=e.clientY-bi(w);let i=bi(k),a=bi(S);switch(bi(y)){case"right":i=bi(k)+t;break;case"bottom":a=bi(S)+n;break;case"bottom-right":i=bi(k)+t,a=bi(S)+n;break;case"left":i=bi(k)-t;break;case"top":a=bi(S)-n;break;case"top-left":i=bi(k)-t,a=bi(S)-n;break;case"top-right":i=bi(k)+t,a=bi(S)-n;break;case"bottom-left":i=bi(k)-t,a=bi(S)+n}i=Math.max(QS,Math.min(KS,i)),a=Math.max(ZS,Math.min(YS,a)),$n(P,i,!0),$n(R,a,!0)}function B(){bi(m)&&($n(m,!1),$n(y,""),document.removeEventListener("mousemove",F),document.removeEventListener("mouseup",B),document.body.style.cursor="",document.body.style.userSelect="",O())}function j(e){if(!u())return;const t=e.target;if("BUTTON"===t.tagName||t.closest("button"))return;if("INPUT"===t.tagName||"SELECT"===t.tagName||t.closest("input")||t.closest("select"))return;if(t.classList.contains("custom-dropdown")||t.closest(".custom-dropdown")||t.classList.contains("dropdown-panel")||t.closest(".dropdown-panel")||t.classList.contains("dropdown-item")||t.closest(".dropdown-item"))return;t.closest(".modal-header")&&(bi(E)||(0===bi(x)&&0===bi(_)&&($n(x,Math.max(0,(window.innerWidth-bi(P))/2),!0),$n(_,Math.max(50,(window.innerHeight-bi(R))/2),!0)),$n(E,!0),_e.debug("[ResizableModal] 窗口拖拽功能已初始化")),e.preventDefault(),$n(C,!0),$n(I,e.clientX,!0),$n(D,e.clientY,!0),$n(T,bi(x),!0),$n(M,bi(_),!0),bi(f)&&bi(f).dispatchEvent(new CustomEvent("modal-drag-start",{bubbles:!0,composed:!0})),document.addEventListener("mousemove",U),document.addEventListener("mouseup",V),document.body.style.cursor="move",document.body.style.userSelect="none")}function U(e){if(!bi(C))return;const t=e.clientX-bi(I),n=e.clientY-bi(D);$n(x,bi(T)+t),$n(_,bi(M)+n);const i=window.innerWidth-Math.min(bi(P),100),a=window.innerHeight-100,r=-(bi(P)-100);$n(x,Math.max(r,Math.min(bi(x),i)),!0),$n(_,Math.max(0,Math.min(bi(_),a)),!0)}function V(){bi(C)&&($n(C,!1),document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",V),document.body.style.cursor="",document.body.style.userSelect="")}Ti(()=>{const e=a().settings[g()];e?($n(P,e.customWidth||800,!0),$n(R,e.customHeight||600,!0)):($n(P,800),$n(R,600))}),Pr(()=>{const e=bi(z).preset;if("custom"!==bi(z).preset&&GS[e]){const t=GS[e];$n(P,t.width,!0),$n(R,t.height,!0)}u()&&($n(x,Math.max(0,(window.innerWidth-bi(P))/2),!0),$n(_,Math.max(50,(window.innerHeight-bi(R))/2),!0),$n(E,!0))}),Rr(()=>{document.removeEventListener("mousemove",F),document.removeEventListener("mouseup",B),document.body.style.cursor="",document.body.style.userSelect=""});var q={get open(){return n()},set open(e){n(e),hn()},get onClose(){return i()},set onClose(e){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get title(){return r()},set title(e){r(e),hn()},get closable(){return s()},set closable(e=!0){s(e),hn()},get maskClosable(){return o()},set maskClosable(e=!0){o(e),hn()},get keyboard(){return l()},set keyboard(e=!0){l(e),hn()},get className(){return c()},set className(e=""){c(e),hn()},get enableTransparentMask(){return d()},set enableTransparentMask(e=!1){d(e),hn()},get enableWindowDrag(){return u()},set enableWindowDrag(e=!1){u(e),hn()},get children(){return h()},set children(e){h(e),hn()},get headerActions(){return p()},set headerActions(e){p(e),hn()},get modalSizeKey(){return g()},set modalSizeKey(e="editorModalSize"){g(e),hn()},get accentColor(){return v()},set accentColor(e="blue"){v(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},H=ha();na("keydown",Ft,function(e){l()&&"Escape"===e.key&&n()&&$()});var W=Qt(H),G=e=>{var t=Ex();let n;t.__click=function(...e){var t;null==(t=o()?e=>{e.target===e.currentTarget&&$()}:void 0)||t.apply(this,e)};var i=Gt(t);let a;i.__keydown=[rx,l,$];var g=Gt(i),y=e=>{var t=cx();let n;t.__mousedown=function(...e){var t;null==(t=u()?j:void 0)||t.apply(this,e)};var i=Gt(t),a=Gt(i),o=e=>{var t=sx(),n=Gt(t,!0);zt(t),zi(()=>{var e;Fa(t,1,`modal-title with-accent-bar accent-${null!=(e=v())?e:""}`,"svelte-1u6nh71"),va(n,r())}),pa(e,t)};xa(a,e=>{r()&&e(o)}),zt(i);var l=Kt(i,2),c=Gt(l),d=e=>{var t=ox();Ea(Gt(t),p),zt(t),pa(e,t)};xa(c,e=>{p()&&e(d)});var h=Kt(c,2),g=e=>{var t=lx();t.__click=$,pa(e,t)};xa(h,e=>{s()&&e(g)}),zt(l),zt(t),zi(e=>{n=Fa(t,1,"modal-header svelte-1u6nh71",null,n,e),er(t,"role",u()?"button":void 0),er(t,"aria-label",u()?"拖拽移动模态窗":void 0),er(t,"tabindex",u()?"0":void 0)},[()=>({draggable:u(),minimal:!r()&&!p()})]),pa(e,t)};xa(g,e=>{(r()||s()||p())&&e(y)});var b=Kt(g,2),w=e=>{var t=ux();t.__mousedown=j,t.__keydown=[dx,j],pa(e,t)};xa(b,e=>{!u()||r()||s()||p()||e(w)});var k=Kt(b,2);Ea(Gt(k),()=>{var e;return null!=(e=h())?e:je}),zt(k);var S=Kt(k,2),C=e=>{var t=Mx(),n=Qt(t);n.__mousedown=[hx,L],n.__keydown=[px,N];var i=Kt(n,2);i.__mousedown=[gx,L],i.__keydown=[vx,N];var a=Kt(i,2);a.__mousedown=[fx,L],a.__keydown=[mx,N];var r=Kt(a,2);r.__mousedown=[yx,L],r.__keydown=[bx,N];var s=Kt(r,2);s.__mousedown=[kx,L],s.__keydown=[Sx,N];var o=Kt(s,2);o.__mousedown=[xx,L],o.__keydown=[_x,N];var l=Kt(o,2);l.__mousedown=[Cx,L],l.__keydown=[Ix,N];var c=Kt(l,2);c.__mousedown=[Dx,L],c.__keydown=[Tx,N],pa(e,t)};xa(S,e=>{bi(z).enableResize&&e(C)});var I=Kt(S,2),D=e=>{var t=Ax(),n=Gt(t);zt(t),zi(()=>{var e,t;return va(n,`${null!=(e=bi(P))?e:""} × ${null!=(t=bi(R))?t:""}`)}),pa(e,t)};xa(I,e=>{bi(m)&&e(D)}),zt(i),kr(i,e=>$n(f,e),()=>bi(f)),zt(t),zi((e,s)=>{var o;n=Fa(t,1,"resizable-modal-overlay svelte-1u6nh71",null,n,e),Fa(i,1,`resizable-modal ${null!=(o=c())?o:""}`,"svelte-1u6nh71"),er(i,"aria-labelledby",r()?"modal-title":void 0),a=ja(i,"",a,s)},[()=>({transparent:d()}),()=>{var e,t;return{width:`${null!=(e=bi(P))?e:""}px`,height:`${null!=(t=bi(R))?t:""}px`,left:u()?`${bi(x)}px`:void 0,top:u()?`${bi(_)}px`:void 0,transform:u()?"none":void 0}}]),pa(e,t)};return xa(W,e=>{n()&&e(G)}),pa(e,H),St(q)}ia(["click","keydown","mousedown"]);var Px=(e,t,n)=>t()(bi(n).id),Rx=la('<button role="tab"><!> <span class="tab-label svelte-u7ms9g"> </span></button>'),$x=la('<div class="tab-navigation svelte-u7ms9g" role="tablist" tabindex="0"><!> <div class="tab-indicator svelte-u7ms9g"></div></div>');function Ox(e,t){if(new.target)return Er({component:Ox,...e});kt(t,!0);let n=Ar(t,"tabs",7),i=Ar(t,"activeTab",7),a=Ar(t,"onTabChange",7),r=In(()=>()=>{const e=n().findIndex(e=>e.id===i());return-1===e?0:e*(100/n().length)}),s=In(()=>100/n().length);var o={get tabs(){return n()},set tabs(e){n(e),hn()},get activeTab(){return i()},set activeTab(e){i(e),hn()},get onTabChange(){return a()},set onTabChange(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=$x();l.__keydown=function(e){const t=n().findIndex(e=>e.id===i());if(-1===t)return;let r=t;"ArrowLeft"===e.key?(e.preventDefault(),r=t>0?t-1:n().length-1):"ArrowRight"===e.key&&(e.preventDefault(),r=t<n().length-1?t+1:0),r!==t&&a()(n()[r].id)};var c=Gt(l);Ca(c,17,n,_a,(e,t)=>{var n=Rx();let r;n.__click=[Px,a,t];var s=Gt(n),o=e=>{Ng(e,{get name(){return bi(t).icon},size:16})};xa(s,e=>{bi(t).icon&&e(o)});var l=Kt(s,2),c=Gt(l,!0);zt(l),zt(n),zi(e=>{var a;r=Fa(n,1,"tab-button svelte-u7ms9g",null,r,e),er(n,"aria-selected",i()===bi(t).id),er(n,"aria-controls",`${null!=(a=bi(t).id)?a:""}-panel`),er(n,"aria-disabled",bi(t).disabled),er(n,"tabindex",i()===bi(t).id?0:-1),n.disabled=bi(t).disabled,va(c,bi(t).label)},[()=>({active:i()===bi(t).id,disabled:bi(t).disabled})]),pa(e,n)});var d=Kt(c,2);return zt(l),zi(e=>{var t;return ja(d,`left: ${null!=e?e:""}%; width: ${null!=(t=bi(s))?t:""}%`)},[()=>bi(r)()]),pa(e,l),St(o)}function Lx(e,t){return e.length<=t?e:`${e.substring(0,t)}...`}ia(["keydown","click"]);var Nx=(e=>(e.MANUAL="manual",e.AI_SPLIT="ai-split",e.INCREMENTAL="incremental",e.IMPORT="import",e.CLOZE_PROGRESSIVE="cloze-progressive",e))(Nx||{});function Fx(e){return e?e.replace(/<[^>]*>/g,"").trim():""}function Bx(e,t=100){var n;if(null==(n=e.fields)?void 0:n.front){const n=Fx(e.fields.front);return n.length>t?`${n.substring(0,t)}...`:n}if(e.content){const n=Fx(e.content);return n.length>t?`${n.substring(0,t)}...`:n}return`卡片 ${e.uuid.substring(0,16)}...`}function jx(e){return{[Nx.AI_SPLIT]:"AI拆分",[Nx.MANUAL]:"手动拆解",[Nx.INCREMENTAL]:"渐进式阅读",[Nx.IMPORT]:"外部导入"}[e]||e}function Ux(e){try{const t=new Date(e),n=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0");return`${n}/${i}/${a} ${r}:${String(t.getMinutes()).padStart(2,"0")}`}catch(t){return e}}function Vx(e,t,n){navigator.clipboard.writeText(t().uuid),new ge.Notice(bi(n)("modals.cardInfoTab.copyUUID"))}async function qx(e,t,n,i){var a,r,s;try{let e,o;if(t().sourceFile?(e=t().sourceFile,o=null==(a=t().sourceBlock)?void 0:a.replace(/^\^/,"")):(null==(r=t().customFields)?void 0:r.obsidianFilePath)?(e=t().customFields.obsidianFilePath,o=t().customFields.blockId):(null==(s=t().fields)?void 0:s.source_document)&&(e=t().fields.source_document),!e)return void new ge.Notice(bi(n)("modals.cardInfoTab.noSource"));const l=i().app.vault.getAbstractFileByPath(e);if(!l)return void new ge.Notice(bi(n)("modals.cardInfoTab.sourceDeleted"));const c=i().app.workspace.getLeaf(!1);if(await c.openFile(l),o){const e=i().app.workspace.getActiveViewOfType(ge.MarkdownView);if(e&&e.editor){const t=(await i().app.vault.read(l)).split("\n");let n=-1;for(let e=0;e<t.length;e++)if(t[e].includes(`^${o}`)){n=e;break}if(n>=0){e.editor.setCursor({line:n,ch:0}),e.editor.scrollIntoView({from:{line:n,ch:0},to:{line:n,ch:0}},!0);const i=t[n],a=i.match(/\s*\^\w+$/),r=a?i.length-a[0].length:i.length;e.editor.setSelection({line:n,ch:0},{line:n,ch:r}),new ge.Notice("已跳转到源文档")}else new ge.Notice("无法找到源文本块")}}else new ge.Notice("已打开源文档")}catch(o){_e.error("[CardInfoTab] 跳转到源文档失败:",o),new ge.Notice("跳转失败")}}function Hx(e,t){$n(t,!bi(t))}function Wx(e,t){$n(t,!bi(t))}async function Gx(e,t,n,i,a){const r=[];if(t().uuid&&r.push(t().uuid),bi(n).forEach(e=>{e.uuid&&r.push(e.uuid)}),0!==r.length){_e.debug("[CardInfoTab] 查看全部兄弟卡片:",r);try{if(i()&&"function"==typeof i().activateView){const{VIEW_TYPE_WEAVE:e}=await Promise.resolve().then(()=>Me);await i().activateView(e),_e.debug("[CardInfoTab] 已激活 Tuanki 插件视图")}window.dispatchEvent(new CustomEvent("tuanki:navigate",{detail:"tuanki-card-management"})),setTimeout(()=>{window.dispatchEvent(new CustomEvent("tuanki:filter-by-cards",{detail:{cardIds:r,filterName:`兄弟卡片 (共${r.length}张)`,parentCardPreview:bi(a)?Bx(bi(a),50):void 0}}))},150),new window.Notice(`正在筛选显示 ${r.length} 张兄弟卡片...`)}catch(s){_e.error("[CardInfoTab] 激活视图失败:",s),new window.Notice("切换视图失败，请手动切换到 Tuanki 插件标签页")}}else new window.Notice("没有找到兄弟卡片")}function Qx(e,t,n,i){bi(t)&&($n(n,bi(t),!0),$n(i,!0))}var Kx=la('<span class="relation-badge method-badge ai-method svelte-kmg2n5">🤖 AI拆分</span>'),Zx=la('<span class="relation-badge method-badge cloze-method svelte-kmg2n5">🧬 渐进挖空</span>'),Yx=la('<span class="relation-badge method-badge manual-method svelte-kmg2n5">✂️ 手动拆分</span>'),Xx=la('<span class="relation-badge method-badge svelte-kmg2n5"> </span>'),Jx=la('<span class="relation-badge child-card svelte-kmg2n5"><!> 子卡片</span> <!>',1),e_=la('<span class="relation-badge count-badge svelte-kmg2n5"> </span>'),t_=la('<span class="relation-badge parent-card svelte-kmg2n5"><!> 父卡片</span> <!>',1),n_=la('<span class="relation-badge normal-card svelte-kmg2n5"><!> 独立卡片</span>'),i_=la('<div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">优先级</span> <span class="info-value svelte-kmg2n5"><span> </span></span></div>'),a_=la('<span class="tag svelte-kmg2n5"> </span>'),r_=la('<section class="info-section svelte-kmg2n5"><h3 class="section-title with-accent-bar accent-purple svelte-kmg2n5"> </h3> <div class="tags-container svelte-kmg2n5"></div></section>'),s_=la('<button class="link-button svelte-kmg2n5" title="点击跳转"><!> <span class="svelte-kmg2n5"> </span></button>'),o_=la('<span class="text-muted svelte-kmg2n5">无源文档</span>'),l_=la('<span class="mono svelte-kmg2n5"> </span>'),c_=la('<span class="text-muted svelte-kmg2n5">无块引用</span>'),d_=la('<span class="status-indicator status-exists svelte-kmg2n5">✓ 存在</span>'),u_=la('<span class="status-indicator status-missing svelte-kmg2n5">✗ 已删除</span>'),h_=la('<span class="text-muted svelte-kmg2n5">未知</span>'),p_=la('<span class="text-muted svelte-kmg2n5">加载中...</span>'),g_=la('<div class="source-card-compact svelte-kmg2n5"><span class="source-card-id svelte-kmg2n5" title="源记忆卡片ID"> </span> <button class="view-source-btn-small svelte-kmg2n5" title="查看源记忆卡片详情"><!> 查看</button></div>'),v_=la('<span class="text-muted svelte-kmg2n5">不存在或已删除</span>'),f_=la('<span class="text-muted svelte-kmg2n5">无</span>'),m_=la('<div class="info-row source-memory-card-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">源记忆卡片</span> <span class="info-value svelte-kmg2n5"><!></span></div>'),y_=la('<button class="expand-toggle svelte-kmg2n5"> </button>'),b_=la('<span class="timeline-item svelte-kmg2n5">📄 父卡片</span> <span class="timeline-arrow svelte-kmg2n5">→</span>',1),w_=(e,t,n)=>bi(t)&&n(bi(t)),k_=la('<button class="link-button svelte-kmg2n5">[查看父卡片]</button>'),S_=(e,t,n)=>bi(t)[0]&&n(bi(t)[0]),x_=la('<button class="link-button svelte-kmg2n5"> </button>'),__=la('<div class="timeline-simple svelte-kmg2n5"><!> <span class="timeline-item svelte-kmg2n5"> <!></span> <span class="timeline-arrow svelte-kmg2n5">→</span> <span class="timeline-item current svelte-kmg2n5">✨ 你</span> <div class="timeline-actions svelte-kmg2n5"><!> <!></div></div>'),C_=(e,t,n)=>bi(t)&&n(bi(t)),I_=la('<button class="link-button-small svelte-kmg2n5">[查看]</button>'),D_=la('<div class="timeline-event-compact svelte-kmg2n5"><div class="event-time svelte-kmg2n5"> </div> <div> </div> <div class="event-content svelte-kmg2n5"><span class="event-icon svelte-kmg2n5"><!></span> <span class="event-description svelte-kmg2n5"> </span> <!></div></div>'),T_=la('<span class="sibling-tag svelte-kmg2n5"> </span>'),M_=la('<span class="sibling-more svelte-kmg2n5"> </span>'),A_=la('<div class="siblings-preview svelte-kmg2n5"><span class="siblings-label svelte-kmg2n5">👥 兄弟卡片:</span> <!> <!> <button class="link-button-small svelte-kmg2n5">[查看全部]</button></div>'),E_=la('<div class="timeline-compact svelte-kmg2n5"><!> <!></div>'),z_=(e,t,n)=>bi(t)&&n(bi(t)),P_=la('<div class="event-detail svelte-kmg2n5"><div class="parent-card-preview svelte-kmg2n5"> </div> <button class="link-button-small svelte-kmg2n5">[查看详情]</button></div>'),R_=(e,t,n)=>t(bi(n)),$_=la('<button class="child-card-item svelte-kmg2n5"><span class="child-index svelte-kmg2n5"></span> <span class="child-preview svelte-kmg2n5"> </span> <!></button>'),O_=la('<div class="sibling-actions svelte-kmg2n5"><button class="expand-siblings-btn svelte-kmg2n5"> </button> <button class="view-in-grid-btn svelte-kmg2n5" title="在卡片管理页面的网格视图中查看所有兄弟卡片"><!> 在网格中查看</button></div>'),L_=la('<div class="sibling-actions svelte-kmg2n5"><button class="expand-siblings-btn svelte-kmg2n5">[收起]</button> <button class="view-in-grid-btn svelte-kmg2n5" title="在卡片管理页面的网格视图中查看所有兄弟卡片"><!> 在网格中查看</button></div>'),N_=la('<button class="view-in-grid-btn svelte-kmg2n5" title="在卡片管理页面的网格视图中查看所有兄弟卡片"><!> 在网格中查看</button>'),F_=la('<div class="timeline-branch svelte-kmg2n5"><div class="branch-header svelte-kmg2n5"> </div> <!> <div class="child-card-item current-card-highlight svelte-kmg2n5"><span class="child-index svelte-kmg2n5"> </span> <span class="child-preview svelte-kmg2n5"> </span></div> <!></div>'),B_=la('<div class="timeline-event svelte-kmg2n5"><div></div> <div class="event-header svelte-kmg2n5"><span class="event-time svelte-kmg2n5"> </span></div> <div class="event-body svelte-kmg2n5"><div class="event-title svelte-kmg2n5"><span class="event-icon svelte-kmg2n5"><!></span> <span class="svelte-kmg2n5"> </span></div> <!></div></div>'),j_=la('<div class="timeline-full svelte-kmg2n5"><div class="timeline-axis svelte-kmg2n5"></div></div>'),U_=la('<section class="info-section timeline-section svelte-kmg2n5"><h3 class="section-title with-accent-bar accent-cyan svelte-kmg2n5">卡片演化历史 <!></h3> <!></section>'),V_=la('<div class="card-info-tab svelte-kmg2n5" role="tabpanel" id="info-panel"><section class="info-section svelte-kmg2n5"><h3 class="section-title with-accent-bar accent-red svelte-kmg2n5"> </h3> <div class="info-grid svelte-kmg2n5"><div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5"> </span> <span class="info-value svelte-kmg2n5"><button class="uuid-button svelte-kmg2n5" title="点击复制"><!> <span class="svelte-kmg2n5"> </span></button></span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">卡片类型</span> <span class="info-value svelte-kmg2n5"> </span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">卡片状态</span> <span class="info-value svelte-kmg2n5"><span class="status-badge svelte-kmg2n5"> </span></span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">卡片关系</span> <span class="info-value svelte-kmg2n5"><div class="relation-badges-group svelte-kmg2n5"><!></div></span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5"> </span> <span class="info-value svelte-kmg2n5"> </span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5"> </span> <span class="info-value svelte-kmg2n5"> </span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5"> </span> <span class="info-value svelte-kmg2n5"> </span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5"> </span> <span class="info-value svelte-kmg2n5"> </span></div> <!></div></section> <!> <section class="info-section svelte-kmg2n5"><h3 class="section-title with-accent-bar accent-orange svelte-kmg2n5">溯源信息</h3> <div class="info-grid svelte-kmg2n5"><div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">源文档</span> <span class="info-value svelte-kmg2n5"><!></span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">块引用</span> <span class="info-value svelte-kmg2n5"><!></span></div> <div class="info-row svelte-kmg2n5"><span class="info-label svelte-kmg2n5">文档状态</span> <span class="info-value svelte-kmg2n5"><!></span></div> <!></div></section> <!></div> <!>',1);function q_(e,t){if(new.target)return Er({component:q_,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"card",7),s=Ar(t,"plugin",7),o=Ar(t,"deckName",7),l=Ar(t,"templateName",7),c=In(n),d=Pn(null),u=Pn(Ot([])),h=Pn(!1),p=Pn(Ot([])),g=Pn("simple"),v=Pn(!1),f=Pn(!1),m=Pn(!1),y=Pn(null),b=Pn(null),w=Pn(!1);const k=In(()=>{var e;return"test"===r().cardPurpose&&(null==(e=r().metadata)?void 0:e.sourceCardId)}),S=In(()=>{var e;return null==(e=r().metadata)?void 0:e.sourceCardId});async function x(e){try{return await s().directFileReader.getCardByUUID(e)}catch(t){return _e.error("[CardInfoTab] 查找卡片失败:",t),null}}async function _(){var e,t;if(!bi(h))try{if($n(h,!0),$n(p,function(e){var t;const n=[];if(e.created&&n.push({timestamp:e.created,type:"created",description:e.parentCardId?"从父卡片拆分而来":"卡片创建",actor:e.parentCardId?"ai":"user"}),null==(t=e.relationMetadata)?void 0:t.derivationMetadata){const t=e.relationMetadata.derivationMetadata;n.push({timestamp:t.splitTimestamp,type:"split",description:`${jx(t.method)}生成`,actor:t.method===Nx.AI_SPLIT?"ai":"user",splitMethod:t.method,relatedCardIds:e.parentCardId?[e.parentCardId]:void 0})}return e.modified&&e.modified!==e.created&&n.push({timestamp:e.modified,type:"modified",description:"内容修改",actor:"user"}),n.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime())}(r()),!0),r().parentCardId&&$n(d,await x(r().parentCardId),!0),null==(t=null==(e=bi(d))?void 0:e.relationMetadata)?void 0:t.childCardIds){const e=bi(d).relationMetadata.childCardIds.filter(e=>e!==r().uuid),t=await Promise.all(e.map(e=>x(e)));$n(u,t.filter(e=>null!==e),!0)}$n(g,function(e,t,n){return e.parentCardId&&n>5||t>5?"full":t>=3&&t<=5?"compact":"simple"}(r(),bi(p).length,bi(u).length),!0),_e.debug("[CardInfoTab] 关系数据加载完成:",{parentCard:!!bi(d),siblingCount:bi(u).length,timelineMode:bi(g),eventsCount:bi(p).length})}catch(n){_e.error("[CardInfoTab] 加载关系数据失败:",n)}finally{$n(h,!1)}}function C(e){$n(y,e,!0),$n(m,!0)}function I(){$n(m,!1),$n(y,null)}Pr(()=>{var e;_(),"test"===r().cardPurpose&&(null==(e=r().metadata)?void 0:e.sourceCardId)&&async function(){const e=bi(S);if(e&&!bi(w)){$n(w,!0);try{const t=(await s().dataStorage.getCards()).find(t=>t.uuid===e);t&&$n(b,t,!0)}catch(t){_e.error("[CardInfoTab] 获取源记忆卡片失败:",t)}finally{$n(w,!1)}}}()});var D={get card(){return r()},set card(e){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},get deckName(){return o()},set deckName(e){o(e),hn()},get templateName(){return l()},set templateName(e){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},T=V_(),M=Qt(T),A=Gt(M),E=Gt(A),z=Gt(E,!0);zt(E);var P=Kt(E,2),R=Gt(P),$=Gt(R),O=Gt($,!0);zt($);var L=Kt($,2),N=Gt(L);N.__click=[Vx,r,c];var F=Gt(N);Ng(F,{name:"hash",size:12});var B=Kt(F,2),j=Gt(B,!0);zt(B),zt(N),zt(L),zt(R);var U=Kt(R,2),V=Kt(Gt(U),2),q=Gt(V,!0);zt(V),zt(U);var H=Kt(U,2),W=Kt(Gt(H),2),G=Gt(W),Q=Gt(G,!0);zt(G),zt(W),zt(H);var K=Kt(H,2),Z=Kt(Gt(K),2),Y=Gt(Z),X=Gt(Y),J=e=>{var t=Jx(),n=Qt(t);Ng(Gt(n),{name:"file-text",size:12}),Pt(),zt(n);var i=Kt(n,2),a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,Kx())},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,Zx())},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,Yx())},a=e=>{var t=Xx(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>jx(r().relationMetadata.derivationMetadata.method)]),pa(e,t)};xa(n,e=>{"manual"===r().relationMetadata.derivationMetadata.method?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{"cloze-progressive"===r().relationMetadata.derivationMetadata.method?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{"ai-split"===r().relationMetadata.derivationMetadata.method?e(i):e(a,!1)}),pa(e,t)};xa(i,e=>{var t,n;(null==(n=null==(t=r().relationMetadata)?void 0:t.derivationMetadata)?void 0:n.method)&&e(a)}),pa(e,t)},ee=e=>{var t=ha(),n=Qt(t),i=e=>{var t=t_(),n=Qt(t);Ng(Gt(n),{name:"folder",size:12}),Pt(),zt(n);var i=Kt(n,2),a=e=>{var t=e_(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`👥 含${null!=(e=r().relationMetadata.childCardIds.length)?e:""}张子卡片`)}),pa(e,t)};xa(i,e=>{var t;(null==(t=r().relationMetadata)?void 0:t.childCardIds)&&e(a)}),pa(e,t)},a=e=>{var t=n_();Ng(Gt(t),{name:"file",size:12}),Pt(),zt(t),pa(e,t)};xa(n,e=>{var t,n;(null==(t=r().relationMetadata)?void 0:t.isParent)||(null==(n=r().relationMetadata)?void 0:n.childCardIds)&&r().relationMetadata.childCardIds.length>0?e(i):e(a,!1)},!0),pa(e,t)};xa(X,e=>{r().parentCardId?e(J):e(ee,!1)}),zt(Y),zt(Z),zt(K);var te=Kt(K,2),ne=Gt(te),ie=Gt(ne,!0);zt(ne);var ae=Kt(ne,2),re=Gt(ae,!0);zt(ae),zt(te);var se=Kt(te,2),oe=Gt(se),le=Gt(oe,!0);zt(oe);var ce=Kt(oe,2),de=Gt(ce,!0);zt(ce),zt(se);var ue=Kt(se,2),he=Gt(ue),pe=Gt(he,!0);zt(he);var ge=Kt(he,2),ve=Gt(ge,!0);zt(ge),zt(ue);var fe=Kt(ue,2),me=Gt(fe),ye=Gt(me,!0);zt(me);var be=Kt(me,2),we=Gt(be,!0);zt(be),zt(fe);var ke=Kt(fe,2),Se=e=>{var t=i_(),n=Kt(Gt(t),2),i=Gt(n),a=Gt(i);zt(i),zt(n),zt(t),zi(()=>{var e,t;Fa(i,1,`priority-badge priority-${null!=(e=r().priority)?e:""}`,"svelte-kmg2n5"),va(a,`P${null!=(t=r().priority)?t:""}`)}),pa(e,t)};xa(ke,e=>{r().priority&&e(Se)}),zt(P),zt(A);var xe=Kt(A,2),Ce=e=>{var t=r_(),n=Gt(t),i=Gt(n,!0);zt(n);var a=Kt(n,2);Ca(a,21,()=>r().tags,_a,(e,t)=>{var n=a_(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(a),zt(t),zi(e=>va(i,e),[()=>bi(c)("modals.cardInfoTab.tags")]),pa(e,t)};xa(xe,e=>{r().tags&&r().tags.length>0&&e(Ce)});var Ie=Kt(xe,2),De=Kt(Gt(Ie),2),Te=Gt(De),Me=Kt(Gt(Te),2),Ae=Gt(Me),Ee=e=>{var t=s_();t.__click=[qx,r,c,s];var n=Gt(t);Ng(n,{name:"external-link",size:12});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(()=>{var e;return va(a,r().sourceFile||(null==(e=r().fields)?void 0:e.source_document))}),pa(e,t)},ze=e=>{pa(e,o_())};xa(Ae,e=>{var t;r().sourceFile||(null==(t=r().fields)?void 0:t.source_document)?e(Ee):e(ze,!1)}),zt(Me),zt(Te);var Pe=Kt(Te,2),Re=Kt(Gt(Pe),2),$e=Gt(Re),Oe=e=>{var t=l_(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>{var e;return Lx(r().sourceBlock||(null==(e=r().fields)?void 0:e.obsidian_block_link)||"",30)}]),pa(e,t)},Le=e=>{pa(e,c_())};xa($e,e=>{var t;r().sourceBlock||(null==(t=r().fields)?void 0:t.obsidian_block_link)?e(Oe):e(Le,!1)}),zt(Re),zt(Pe);var Ne=Kt(Pe,2),Fe=Kt(Gt(Ne),2),Be=Gt(Fe),je=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,d_())},a=e=>{pa(e,u_())};xa(n,e=>{r().sourceExists?e(i):e(a,!1)}),pa(e,t)},Ue=e=>{pa(e,h_())};xa(Be,e=>{void 0!==r().sourceExists?e(je):e(Ue,!1)}),zt(Fe),zt(Ne);var Ve=Kt(Ne,2),qe=e=>{var t=m_(),n=Kt(Gt(t),2),i=Gt(n),a=e=>{pa(e,p_())},r=e=>{var t=ha(),n=Qt(t),i=e=>{var t=g_(),n=Gt(t),i=Gt(n,!0);zt(n);var a=Kt(n,2);a.__click=[Qx,b,y,m],Ng(Gt(a),{name:"eye",size:12}),Pt(),zt(a),zt(t),zi(()=>va(i,bi(b).uuid)),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,v_())},a=e=>{pa(e,f_())};xa(n,e=>{bi(S)?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{bi(b)?e(i):e(a,!1)},!0),pa(e,t)};xa(i,e=>{bi(w)?e(a):e(r,!1)}),zt(n),zt(t),pa(e,t)};xa(Ve,e=>{bi(k)&&e(qe)}),zt(De),zt(Ie);var He=Kt(Ie,2),We=e=>{var t=U_(),n=Gt(t),i=Kt(Gt(n)),a=e=>{var t=y_();t.__click=[Hx,v];var n=Gt(t,!0);zt(t),zi(()=>{er(t,"title",bi(v)?"收起":"展开"),va(n,bi(v)?"▲":"▼")}),pa(e,t)};xa(i,e=>{("full"===bi(g)||"compact"===bi(g)&&bi(u).length>0)&&e(a)}),zt(n);var o=Kt(n,2),l=e=>{var t=__(),n=Gt(t),i=e=>{var t=b_();Pt(2),pa(e,t)};xa(n,e=>{bi(d)&&e(i)});var a=Kt(n,2),s=Gt(a),o=Kt(s),l=e=>{var t=ua();zi(()=>va(t,`(${bi(u).length+1}张)`)),pa(e,t)};xa(o,e=>{bi(u).length>0&&e(l)}),zt(a);var c=Kt(a,6),h=Gt(c),p=e=>{var t=k_();t.__click=[w_,d,C],pa(e,t)};xa(h,e=>{bi(d)&&e(p)});var g=Kt(h,2),v=e=>{var t=x_();t.__click=[S_,u,C];var n=Gt(t);zt(t),zi(()=>{var e;return va(n,`[查看兄弟卡片(${null!=(e=bi(u).length)?e:""}张)]`)}),pa(e,t)};xa(g,e=>{bi(u).length>0&&e(v)}),zt(c),zt(t),zi(e=>va(s,`🤖 ${null!=e?e:""} `),[()=>{var e;return(null==(e=r().relationMetadata)?void 0:e.derivationMetadata)?jx(r().relationMetadata.derivationMetadata.method):"创建"}]),pa(e,t)},c=e=>{var t=ha(),n=Qt(t),i=e=>{var t=E_(),n=Gt(t);Ca(n,17,()=>bi(p),_a,(e,t)=>{var n=D_(),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r,!0);zt(r);var o=Kt(r,2),l=Gt(o),c=Gt(l),u=e=>{pa(e,ua("📄"))},h=e=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ua("🤖"))},r=e=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ua("📝"))};xa(i,e=>{"modified"===bi(t).type&&e(a)},!0),pa(e,n)};xa(i,e=>{"split"===bi(t).type?e(a):e(r,!1)},!0),pa(e,n)};xa(c,e=>{"created"===bi(t).type?e(u):e(h,!1)}),zt(l);var p=Kt(l,2),g=Gt(p,!0);zt(p);var v=Kt(p,2),f=e=>{var t=I_();t.__click=[C_,d,C],pa(e,t)};xa(v,e=>{"split"===bi(t).type&&bi(d)&&e(f)}),zt(o),zt(n),zi(e=>{va(a,e),Fa(r,1,"event-node "+("split"===bi(t).type?"important":""),"svelte-kmg2n5"),va(s,"split"===bi(t).type?"●":"○"),va(g,bi(t).description)},[()=>Ux(bi(t).timestamp)]),pa(e,n)});var i=Kt(n,2),a=e=>{var t=A_(),n=Kt(Gt(t),2);Ca(n,17,()=>bi(u).slice(0,3),_a,(e,t,n)=>{var i=T_(),a=Gt(i);zt(i),zi(e=>va(a,`#${n+1} ${null!=e?e:""}`),[()=>Bx(bi(t),20)]),pa(e,i)});var i=Kt(n,2),a=e=>{var t=M_(),n=Gt(t);zt(t),zi(()=>va(n,"+"+(bi(u).length-3))),pa(e,t)};xa(i,e=>{bi(u).length>3&&e(a)}),Kt(i,2).__click=[Gx,r,u,s,d],zt(t),pa(e,t)};xa(i,e=>{bi(u).length>0&&e(a)}),zt(t),pa(e,t)},a=e=>{var t=j_(),n=Gt(t);Ca(n,21,()=>bi(p),_a,(e,t)=>{var n=B_(),i=Gt(n),a=Kt(i,2),o=Gt(a),l=Gt(o,!0);zt(o),zt(a);var c=Kt(a,2),h=Gt(c),p=Gt(h),g=Gt(p),v=e=>{pa(e,ua("📄"))},m=e=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ua("🤖"))},r=e=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ua("📝"))};xa(i,e=>{"modified"===bi(t).type&&e(a)},!0),pa(e,n)};xa(i,e=>{"split"===bi(t).type?e(a):e(r,!1)},!0),pa(e,n)};xa(g,e=>{"created"===bi(t).type?e(v):e(m,!1)}),zt(p);var y=Kt(p,2),b=Gt(y,!0);zt(y),zt(h);var w=Kt(h,2),k=e=>{var t=P_(),n=Gt(t),i=Gt(n,!0);zt(n),Kt(n,2).__click=[z_,d,C],zt(t),zi(e=>va(i,e),[()=>Bx(bi(d),100)]),pa(e,t)},S=e=>{var n=ha(),i=Qt(n),a=e=>{var t=F_(),n=Gt(t),i=Gt(n);zt(n);var a=Kt(n,2);Ca(a,17,()=>bi(u).slice(0,bi(f)?void 0:3),_a,(e,t,n)=>{var i=$_();i.__click=[R_,C,t];var a=Gt(i);a.textContent=`#${n+1}`;var r=Kt(a,2),s=Gt(r,!0);zt(r),Ng(Kt(r,2),{name:"eye",size:14}),zt(i),zi(e=>va(s,e),[()=>Bx(bi(t),60)]),pa(e,i)});var o=Kt(a,2),l=Gt(o),c=Gt(l);zt(l);var h=Kt(l,2),p=Gt(h);zt(h),zt(o);var g=Kt(o,2),v=e=>{var t=O_(),n=Gt(t);n.__click=[Wx,f];var i=Gt(n);zt(n);var a=Kt(n,2);a.__click=[Gx,r,u,s,d],Ng(Gt(a),{name:"grid",size:12}),Pt(),zt(a),zt(t),zi(()=>va(i,`还有 ${bi(u).length-3} 张... [展开全部]`)),pa(e,t)},m=e=>{var t=ha(),n=Qt(t),i=e=>{var t=L_(),n=Gt(t);n.__click=[Wx,f];var i=Kt(n,2);i.__click=[Gx,r,u,s,d],Ng(Gt(i),{name:"grid",size:12}),Pt(),zt(i),zt(t),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=N_();t.__click=[Gx,r,u,s,d],Ng(Gt(t),{name:"grid",size:12}),Pt(),zt(t),pa(e,t)};xa(n,e=>{bi(u).length>0&&e(i)},!0),pa(e,t)};xa(n,e=>{bi(f)&&bi(u).length>3?e(i):e(a,!1)},!0),pa(e,t)};xa(g,e=>{bi(u).length>3&&!bi(f)?e(v):e(m,!1)}),zt(t),zi(e=>{va(i,`生成 ${bi(u).length+1} 张子卡片:`),va(c,`#${bi(u).length+1}`),va(p,`${null!=e?e:""} ✨ (当前)`)},[()=>Bx(r(),60)]),pa(e,t)};xa(i,e=>{"split"===bi(t).type&&e(a)},!0),pa(e,n)};xa(w,e=>{"created"===bi(t).type&&bi(d)?e(k):e(S,!1)}),zt(c),zt(n),zi(e=>{Fa(i,1,"timeline-node "+("split"===bi(t).type?"important":""),"svelte-kmg2n5"),va(l,e),va(b,bi(t).description)},[()=>Ux(bi(t).timestamp)]),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(n,e=>{"compact"!==bi(g)||bi(v)&&0!==bi(u).length?e(a,!1):e(i)},!0),pa(e,t)};xa(o,e=>{"simple"===bi(g)?e(l):e(c,!1)}),zt(t),pa(e,t)};xa(He,e=>{(bi(p).length>0||bi(d)||bi(u).length>0)&&e(We)}),zt(M);var Ge=Kt(M,2),Qe=e=>{X4(e,{get card(){return bi(y)},get plugin(){return s()},onClose:I,get open(){return bi(m)},set open(e){$n(m,e,!0)}})};xa(Ge,e=>{bi(m)&&bi(y)&&e(Qe)}),zi((e,t,n,i,a,r,s,c,d,u,h)=>{va(z,e),va(O,t),va(j,n),va(q,i),va(Q,a),va(ie,r),va(re,o()),va(le,s),va(de,l()),va(pe,c),va(ve,d),va(ye,u),va(we,h)},[()=>bi(c)("modals.cardInfoTab.basicInfo"),()=>bi(c)("modals.cardInfoTab.uuid"),()=>Lx(r().uuid,32),()=>function(e){switch(e.type){case"basic":return"基础卡片";case"cloze":return"填空题";case"progressive-parent":return"渐进式挖空（父卡片）";case"progressive-child":return"渐进式挖空（子卡片）";case"multiple":return"选择题";case"code":return"代码题";default:return e.type}}(r()),()=>{var e;return function(e){switch(e){case 0:return"新卡片";case 1:return"学习中";case 2:return"复习中";case 3:return"重新学习";default:return"未知"}}((null==(e=r().fsrs)?void 0:e.state)||0)},()=>bi(c)("modals.cardInfoTab.deckLabel"),()=>bi(c)("modals.cardInfoTab.templateLabel"),()=>bi(c)("modals.cardInfoTab.createdAt"),()=>Ku(r().created),()=>bi(c)("modals.cardInfoTab.updatedAt"),()=>Ku(r().modified)]),pa(e,T);var Ke=St(D);return a(),Ke}ia(["click"]);var H_=la('<span class="stat-unit svelte-wikwsz"> </span>'),W_=la('<div class="stat-trend svelte-wikwsz"><span class="trend-indicator svelte-wikwsz"> </span> <span> </span></div>'),G_=la('<div><div class="stat-content svelte-wikwsz"><div class="stat-label svelte-wikwsz"> </div> <div class="stat-value-row svelte-wikwsz"><span class="stat-value svelte-wikwsz"> </span> <!></div> <!></div></div>');function Q_(e,t){if(new.target)return Er({component:Q_,...e});kt(t,!0);let n=Ar(t,"icon",7),i=Ar(t,"iconColor",7),a=Ar(t,"label",7),r=Ar(t,"value",7),s=Ar(t,"unit",7),o=Ar(t,"trend",7),l=Ar(t,"trendDirection",7,"neutral"),c=Ar(t,"size",7,"md"),d=Ar(t,"highlighted",7,!1);const u=In(()=>()=>{switch(l()){case"up":return"var(--text-success)";case"down":return"var(--text-error)";default:return"var(--text-muted)"}});var h={get icon(){return n()},set icon(e){n(e),hn()},get iconColor(){return i()},set iconColor(e){i(e),hn()},get label(){return a()},set label(e){a(e),hn()},get value(){return r()},set value(e){r(e),hn()},get unit(){return s()},set unit(e){s(e),hn()},get trend(){return o()},set trend(e){o(e),hn()},get trendDirection(){return l()},set trendDirection(e="neutral"){l(e),hn()},get size(){return c()},set size(e="md"){c(e),hn()},get highlighted(){return d()},set highlighted(e=!1){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=G_();let g;var v=Gt(p),f=Gt(v),m=Gt(f,!0);zt(f);var y=Kt(f,2),b=Gt(y),w=Gt(b,!0);zt(b);var k=Kt(b,2),S=e=>{var t=H_(),n=Gt(t,!0);zt(t),zi(()=>va(n,s())),pa(e,t)};xa(k,e=>{s()&&e(S)}),zt(y);var x=Kt(y,2),_=e=>{var t=W_();let n;var i=Gt(t),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r,!0);zt(r),zt(t),zi(e=>{n=ja(t,"",n,e),va(a,"up"===l()?"↗":"down"===l()?"↘":"→"),va(s,o())},[()=>({color:bi(u)()})]),pa(e,t)};return xa(x,e=>{o()&&e(_)}),zt(v),zt(p),zi(e=>{g=Fa(p,1,"stat-card svelte-wikwsz",null,g,e),va(m,a()),va(w,r())},[()=>({highlighted:d(),"size-sm":"sm"===c(),"size-md":"md"===c(),"size-lg":"lg"===c()})]),pa(e,p),St(h)}function K_(e,t){const n=Z_(t);return null===n?e:e.filter(e=>e.day<=n)}function Z_(e){switch(e){case"7d":return 7;case"14d":return 14;case"30d":return 30;case"60d":return 60;case"90d":return 90;case"all":return null}}function Y_(e,t="30d"){var n,i,a;const r=Z_(t)||90,s=function(e,t=60,n=100){const i=[],a=t/n;for(let r=0;r<=n;r++){const t=r*a,n=Math.exp(-t/Math.max(e,.01));i.push({day:Math.round(10*t)/10,retrievability:100*n,isActual:!1})}return i}((null==(n=e.fsrs)?void 0:n.stability)||0,r,100),o=function(e,t,n){const i=[];return[...e].sort((e,t)=>new Date(e.review).getTime()-new Date(t.review).getTime()).forEach(e=>{const t=Math.exp(-e.elapsedDays/Math.max(e.stability,.01));i.push({day:e.elapsedDays,retrievability:100*t,isActual:!0,rating:e.rating})}),t>0&&i.push({day:t,retrievability:100*n,isActual:!0}),i}(e.reviewHistory||[],(null==(i=e.fsrs)?void 0:i.elapsedDays)||0,(null==(a=e.fsrs)?void 0:a.retrievability)||0),l=(e.reviewHistory||[]).map(e=>{const t=Math.exp(-e.elapsedDays/Math.max(e.stability,.01));return{day:e.elapsedDays,retrievability:100*t,rating:e.rating}});return{predicted:K_(s,t),actual:K_(o,t),reviewMarkers:l.filter(e=>{const n=Z_(t);return null===n||e.day<=n})}}function X_(e){switch(e){case 1:return"#ef4444";case 2:return"#f59e0b";case 3:return"#22c55e";case 4:return"#3b82f6";default:return"#6b7280"}}var J_=la('<div class="timeline-empty svelte-4aghng"><!> <p class="svelte-4aghng">暂无复习记录</p></div>'),eC=la('<div class="timeline-connector svelte-4aghng"></div>'),tC=la('<div class="timeline-item svelte-4aghng"><div class="timeline-marker svelte-4aghng"><!></div> <div class="timeline-content svelte-4aghng"><div class="timeline-header svelte-4aghng"><span class="timeline-rating svelte-4aghng"> </span> <span class="timeline-time svelte-4aghng"> </span></div> <div class="timeline-details svelte-4aghng"><span class="detail-item svelte-4aghng"><!> </span> <span class="detail-item svelte-4aghng"><!> </span> <span class="detail-item svelte-4aghng"><!> </span></div></div> <!></div>'),nC=la('<div class="timeline-more svelte-4aghng"> </div>'),iC=la("<!> <!>",1),aC=la('<div class="review-timeline svelte-4aghng"><!></div>');function rC(e,t){if(new.target)return Er({component:rC,...e});kt(t,!0);let n=Ar(t,"reviews",7),i=Ar(t,"maxItems",7,20);const a=In(()=>()=>[...n()].sort((e,t)=>new Date(t.review).getTime()-new Date(e.review).getTime()).slice(0,i()));var r={get reviews(){return n()},set reviews(e){n(e),hn()},get maxItems(){return i()},set maxItems(e=20){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=aC(),o=Gt(s),l=e=>{var t=J_();Ng(Gt(t),{name:"clock",size:32}),Pt(2),zt(t),pa(e,t)},c=e=>{var t=iC(),r=Qt(t);Ca(r,17,()=>bi(a)(),_a,(e,t,n)=>{var i=tC();let r;var s=Gt(i),o=Gt(s);{let e=In(()=>function(e){switch(e){case 1:return"x-circle";case 2:return"alert-circle";case 3:return"check-circle";case 4:return"star";default:return"circle"}}(bi(t).rating));Ng(o,{get name(){return bi(e)},size:16})}zt(s);var l=Kt(s,2),c=Gt(l),d=Gt(c),u=Gt(d,!0);zt(d);var h=Kt(d,2),p=Gt(h,!0);zt(h),zt(c);var g=Kt(c,2),v=Gt(g),f=Gt(v);Ng(f,{name:"calendar",size:12});var m=Kt(f);zt(v);var y=Kt(v,2),b=Gt(y);Ng(b,{name:"trending-up",size:12});var w=Kt(b);zt(y);var k=Kt(y,2),S=Gt(k);Ng(S,{name:"activity",size:12});var x=Kt(S);zt(k),zt(g),zt(l);var _=Kt(l,2),C=e=>{pa(e,eC())};xa(_,e=>{n<bi(a)().length-1&&e(C)}),zt(i),zi((e,n,a,s,o)=>{var l;r=ja(i,"",r,e),va(u,n),va(p,a),va(m,` 间隔 ${null!=(l=bi(t).scheduledDays)?l:""}天`),va(w,` 稳定性 ${null!=s?s:""}天`),va(x,` 难度 ${null!=o?o:""}`)},[()=>({"--rating-color":X_(bi(t).rating)}),()=>function(e){switch(e){case 1:return"遗忘";case 2:return"困难";case 3:return"良好";case 4:return"简单";default:return"未知"}}(bi(t).rating),()=>Qu(bi(t).review),()=>bi(t).stability.toFixed(1),()=>bi(t).difficulty.toFixed(1)]),pa(e,i)});var s=Kt(r,2),o=e=>{var t=nC(),a=Gt(t);zt(t),zi(()=>va(a,`还有 ${n().length-i()} 条复习记录`)),pa(e,t)};xa(s,e=>{n().length>i()&&e(o)}),pa(e,t)};return xa(o,e=>{0===bi(a)().length?e(l):e(c,!1)}),zt(s),pa(e,s),St(r)}function sC(e){if(e<60)return`${Math.round(e)}秒`;if(e<3600){return`${Math.floor(e/60)}分钟`}{const t=Math.floor(e/3600),n=Math.floor(e%3600/60);return n>0?`${t}小时${n}分钟`:`${t}小时`}}var oC=la('<section class="stats-section svelte-tiz7ge"><h3 class="section-title with-accent-bar accent-purple svelte-tiz7ge">学习时间</h3> <div class="time-stats svelte-tiz7ge"><div class="time-item svelte-tiz7ge"><span class="time-label svelte-tiz7ge">总学习时间</span> <span class="time-value svelte-tiz7ge"> </span></div> <div class="time-item svelte-tiz7ge"><span class="time-label svelte-tiz7ge">平均学习时间</span> <span class="time-value svelte-tiz7ge"> </span></div></div></section>'),lC=la('<div class="review-stats-tab svelte-tiz7ge" role="tabpanel" id="stats-panel"><section class="stats-section svelte-tiz7ge"><h3 class="section-title with-accent-bar accent-blue svelte-tiz7ge"> </h3> <div class="stats-grid svelte-tiz7ge"><!> <!> <!> <!></div></section> <section class="stats-section svelte-tiz7ge"><h3 class="section-title with-accent-bar accent-green svelte-tiz7ge">FSRS参数</h3> <div class="fsrs-metrics svelte-tiz7ge"><div class="metric-card svelte-tiz7ge"><div class="metric-header svelte-tiz7ge"><span class="metric-label svelte-tiz7ge">稳定性</span></div> <div class="metric-value svelte-tiz7ge"> <span class="metric-unit svelte-tiz7ge">天</span></div> <div class="metric-progress svelte-tiz7ge"><div class="progress-bar svelte-tiz7ge"></div></div></div> <div class="metric-card svelte-tiz7ge"><div class="metric-header svelte-tiz7ge"><span class="metric-label svelte-tiz7ge">难度</span></div> <div class="metric-value svelte-tiz7ge"> <span class="metric-unit svelte-tiz7ge">/10</span></div> <div class="metric-progress svelte-tiz7ge"><div class="progress-bar svelte-tiz7ge"></div></div></div> <div class="metric-card svelte-tiz7ge"><div class="metric-header svelte-tiz7ge"><span class="metric-label svelte-tiz7ge">可提取性</span></div> <div class="metric-value svelte-tiz7ge"> <span class="metric-unit svelte-tiz7ge">%</span></div> <div class="metric-progress svelte-tiz7ge"><div class="progress-bar svelte-tiz7ge"></div></div></div></div></section> <section class="stats-section svelte-tiz7ge"><h3 class="section-title with-accent-bar accent-orange svelte-tiz7ge">复习计划</h3> <div class="schedule-grid svelte-tiz7ge"><div class="schedule-item svelte-tiz7ge"><div class="schedule-content svelte-tiz7ge"><span class="schedule-label svelte-tiz7ge">上次复习</span> <span class="schedule-value svelte-tiz7ge"><!></span></div></div> <div class="schedule-item svelte-tiz7ge"><div class="schedule-content svelte-tiz7ge"><span class="schedule-label svelte-tiz7ge">下次复习</span> <span class="schedule-value svelte-tiz7ge"> </span></div></div> <div class="schedule-item svelte-tiz7ge"><div class="schedule-content svelte-tiz7ge"><span class="schedule-label svelte-tiz7ge">已过天数</span> <span class="schedule-value svelte-tiz7ge"> </span></div></div> <div class="schedule-item svelte-tiz7ge"><div class="schedule-content svelte-tiz7ge"><span class="schedule-label svelte-tiz7ge">预定间隔</span> <span class="schedule-value svelte-tiz7ge"> </span></div></div></div></section> <!> <section class="stats-section svelte-tiz7ge"><h3 class="section-title with-accent-bar accent-cyan svelte-tiz7ge">复习历史</h3> <!></section></div>');function cC(e,t){if(new.target)return Er({component:cC,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"card",7),s=In(n);const o=In(()=>function(e){var t,n,i,a;const r=e.reviewHistory||[],s=r.filter(e=>e.rating>=3).length,o=r.length>0?s/r.length:0,l=function(e){if(0===e.length)return 0;return e.reduce((e,t)=>e+t.scheduledDays,0)/e.length}(r);return{totalReviews:(null==(t=e.stats)?void 0:t.totalReviews)||0,lapses:(null==(n=e.fsrs)?void 0:n.lapses)||0,successRate:o,averageInterval:l,totalStudyTime:(null==(i=e.stats)?void 0:i.totalTime)||0,averageStudyTime:(null==(a=e.stats)?void 0:a.averageTime)||0}}(r())),l=In(()=>function(e){var t,n,i,a,r;return{stability:(null==(t=e.fsrs)?void 0:t.stability)||0,difficulty:(null==(n=e.fsrs)?void 0:n.difficulty)||0,retrievability:(null==(i=e.fsrs)?void 0:i.retrievability)||0,elapsedDays:(null==(a=e.fsrs)?void 0:a.elapsedDays)||0,scheduledDays:(null==(r=e.fsrs)?void 0:r.scheduledDays)||0}}(r())),c=In(()=>(100*bi(o).successRate).toFixed(1)),d=In(()=>bi(l).stability.toFixed(1)),u=In(()=>bi(l).difficulty.toFixed(1)),h=In(()=>(100*bi(l).retrievability).toFixed(1));var p={get card(){return r()},set card(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},g=lC(),v=Gt(g),f=Gt(v),m=Gt(f,!0);zt(f);var y=Kt(f,2),b=Gt(y);{let e=In(()=>bi(s)("modals.reviewStatsTab.totalReviews")),t=In(()=>bi(s)("modals.reviewStatsTab.times"));Q_(b,{icon:"rotate-cw",iconColor:"#3b82f6",get label(){return bi(e)},get value(){return bi(o).totalReviews},get unit(){return bi(t)}})}var w=Kt(b,2);{let e=In(()=>bi(s)("modals.reviewStatsTab.lapses")),t=In(()=>bi(s)("modals.reviewStatsTab.times"));Q_(w,{icon:"x-circle",iconColor:"#ef4444",get label(){return bi(e)},get value(){return bi(o).lapses},get unit(){return bi(t)}})}var k=Kt(w,2);{let e=In(()=>bi(o).successRate>=.8);Q_(k,{icon:"trending-up",iconColor:"#22c55e",label:"成功率",get value(){return bi(c)},unit:"%",get highlighted(){return bi(e)}})}var S=Kt(k,2);{let e=In(()=>bi(o).averageInterval.toFixed(1));Q_(S,{icon:"calendar",iconColor:"#f59e0b",label:"平均间隔",get value(){return bi(e)},unit:"天"})}zt(y),zt(v);var x=Kt(v,2),_=Kt(Gt(x),2),C=Gt(_),I=Kt(Gt(C),2),D=Gt(I,!0);Pt(),zt(I);var T=Kt(I,2),M=Gt(T);zt(T),zt(C);var A=Kt(C,2),E=Kt(Gt(A),2),z=Gt(E,!0);Pt(),zt(E);var P=Kt(E,2),R=Gt(P);zt(P),zt(A);var $=Kt(A,2),O=Kt(Gt($),2),L=Gt(O,!0);Pt(),zt(O);var N=Kt(O,2),F=Gt(N);zt(N),zt($),zt(_),zt(x);var B=Kt(x,2),j=Kt(Gt(B),2),U=Gt(j),V=Gt(U),q=Kt(Gt(V),2),H=Gt(q),W=e=>{var t=ua();zi(e=>va(t,e),[()=>Ku(r().fsrs.lastReview)]),pa(e,t)},G=e=>{pa(e,ua("从未复习"))};xa(H,e=>{var t;(null==(t=r().fsrs)?void 0:t.lastReview)?e(W):e(G,!1)}),zt(q),zt(V),zt(U);var Q=Kt(U,2),K=Gt(Q),Z=Kt(Gt(K),2),Y=Gt(Z,!0);zt(Z),zt(K),zt(Q);var X=Kt(Q,2),J=Gt(X),ee=Kt(Gt(J),2),te=Gt(ee);zt(ee),zt(J),zt(X);var ne=Kt(X,2),ie=Gt(ne),ae=Kt(Gt(ie),2),re=Gt(ae);zt(ae),zt(ie),zt(ne),zt(j),zt(B);var se=Kt(B,2),oe=e=>{var t=oC(),n=Kt(Gt(t),2),i=Gt(n),a=Kt(Gt(i),2),r=Gt(a,!0);zt(a),zt(i);var s=Kt(i,2),l=Kt(Gt(s),2),c=Gt(l,!0);zt(l),zt(s),zt(n),zt(t),zi((e,t)=>{va(r,e),va(c,t)},[()=>sC(bi(o).totalStudyTime),()=>sC(bi(o).averageStudyTime)]),pa(e,t)};xa(se,e=>{bi(o).totalStudyTime>0&&e(oe)});var le=Kt(se,2),ce=Kt(Gt(le),2);{let e=In(()=>r().reviewHistory||[]);rC(ce,{get reviews(){return bi(e)},maxItems:20})}zt(le),zt(g),zi((e,t,n)=>{var i,a;va(m,e),va(D,bi(d)),ja(M,`width: ${null!=t?t:""}%; background: #3b82f6;`),va(z,bi(u)),ja(R,`width: ${10*bi(l).difficulty}%; background: #f59e0b;`),va(L,bi(h)),ja(F,`width: ${100*bi(l).retrievability}%; background: #22c55e;`),va(Y,n),va(te,`${null!=(i=bi(l).elapsedDays)?i:""} 天`),va(re,`${null!=(a=bi(l).scheduledDays)?a:""} 天`)},[()=>bi(s)("modals.reviewStatsTab.coreMetrics"),()=>Math.min(bi(l).stability/365*100,100),()=>{var e;return(null==(e=r().fsrs)?void 0:e.due)?Ku(r().fsrs.due):"未知"}]),pa(e,g);var de=St(p);return a(),de}var dC=function(e,t){return(dC=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function uC(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}dC(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var hC=function(){return function(){this.firefox=!1,this.ie=!1,this.edge=!1,this.newEdge=!1,this.weChat=!1}}(),pC=new(function(){return function(){this.browser=new hC,this.node=!1,this.wxa=!1,this.worker=!1,this.svgSupported=!1,this.touchEventsSupported=!1,this.pointerEventsSupported=!1,this.domSupported=!1,this.transformSupported=!1,this.transform3dSupported=!1,this.hasGlobalWindow="undefined"!=typeof window}}());"object"==typeof wx&&"function"==typeof wx.getSystemInfoSync?(pC.wxa=!0,pC.touchEventsSupported=!0):"undefined"==typeof document&&"undefined"!=typeof self?pC.worker=!0:!pC.hasGlobalWindow||"Deno"in window||"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Node.js")>-1?(pC.node=!0,pC.svgSupported=!0):function(e,t){var n=t.browser,i=e.match(/Firefox\/([\d.]+)/),a=e.match(/MSIE\s([\d.]+)/)||e.match(/Trident\/.+?rv:(([\d.]+))/),r=e.match(/Edge?\/([\d.]+)/),s=/micromessenger/i.test(e);i&&(n.firefox=!0,n.version=i[1]);a&&(n.ie=!0,n.version=a[1]);r&&(n.edge=!0,n.version=r[1],n.newEdge=+r[1].split(".")[0]>18);s&&(n.weChat=!0);if(t.svgSupported="undefined"!=typeof SVGRect,t.touchEventsSupported="ontouchstart"in window&&!n.ie&&!n.edge,t.pointerEventsSupported="onpointerdown"in window&&(n.edge||n.ie&&+n.version>=11),t.domSupported="undefined"!=typeof document){var o=document.documentElement.style;t.transform3dSupported=(n.ie&&"transition"in o||n.edge||"WebKitCSSMatrix"in window&&"m11"in new WebKitCSSMatrix||"MozPerspective"in o)&&!("OTransition"in o),t.transformSupported=t.transform3dSupported||n.ie&&+n.version>=9}}(navigator.userAgent,pC);var gC="12px sans-serif";var vC=function(e){var t={};if("undefined"==typeof JSON)return t;for(var n=0;n<e.length;n++){var i=String.fromCharCode(n+32),a=(e.charCodeAt(n)-20)/100;t[i]=a}return t}("007LLmW'55;N0500LLLLLLLLLL00NNNLzWW\\\\WQb\\0FWLg\\bWb\\WQ\\WrWWQ000CL5LLFLL0LL**F*gLLLL5F0LF\\FFF5.5N"),fC={createCanvas:function(){return"undefined"!=typeof document&&document.createElement("canvas")},measureText:function(){var e,t;return function(n,i){if(!e){var a=fC.createCanvas();e=a&&a.getContext("2d")}if(e)return t!==i&&(t=e.font=i||gC),e.measureText(n);n=n||"";var r=/((?:\d+)?\.?\d*)px/.exec(i=i||gC),s=r&&+r[1]||12,o=0;if(i.indexOf("mono")>=0)o=s*n.length;else for(var l=0;l<n.length;l++){var c=vC[n[l]];o+=null==c?s:c*s}return{width:o}}}(),loadImage:function(e,t,n){var i=new Image;return i.onload=t,i.onerror=n,i.src=e,i}};function mC(e){for(var t in fC)e[t]&&(fC[t]=e[t])}var yC=VC(["Function","RegExp","Date","Error","CanvasGradient","CanvasPattern","Image","Canvas"],function(e,t){return e["[object "+t+"]"]=!0,e},{}),bC=VC(["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64"],function(e,t){return e["[object "+t+"Array]"]=!0,e},{}),wC=Object.prototype.toString,kC=Array.prototype,SC=kC.forEach,xC=kC.filter,_C=kC.slice,CC=kC.map,IC=function(){}.constructor,DC=IC?IC.prototype:null,TC="__proto__",MC=2311;function AC(){return MC++}function EC(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]}function zC(e){if(null==e||"object"!=typeof e)return e;var t=e,n=wC.call(e);if("[object Array]"===n){if(!mI(e)){t=[];for(var i=0,a=e.length;i<a;i++)t[i]=zC(e[i])}}else if(bC[n]){if(!mI(e)){var r=e.constructor;if(r.from)t=r.from(e);else{t=new r(e.length);for(i=0,a=e.length;i<a;i++)t[i]=e[i]}}}else if(!yC[n]&&!mI(e)&&!iI(e))for(var s in t={},e)e.hasOwnProperty(s)&&s!==TC&&(t[s]=zC(e[s]));return t}function PC(e,t,n){if(!eI(t)||!eI(e))return n?zC(t):e;for(var i in t)if(t.hasOwnProperty(i)&&i!==TC){var a=e[i],r=t[i];!eI(r)||!eI(a)||KC(r)||KC(a)||iI(r)||iI(a)||tI(r)||tI(a)||mI(r)||mI(a)?!n&&i in e||(e[i]=zC(t[i])):PC(a,r,n)}return e}function RC(e,t){if(Object.assign)Object.assign(e,t);else for(var n in t)t.hasOwnProperty(n)&&n!==TC&&(e[n]=t[n]);return e}function $C(e,t,n){for(var i=WC(t),a=0,r=i.length;a<r;a++){var s=i[a];(n?null!=t[s]:null==e[s])&&(e[s]=t[s])}return e}var OC=fC.createCanvas;function LC(e,t){if(e){if(e.indexOf)return e.indexOf(t);for(var n=0,i=e.length;n<i;n++)if(e[n]===t)return n}return-1}function NC(e,t){var n=e.prototype;function i(){}for(var a in i.prototype=t.prototype,e.prototype=new i,n)n.hasOwnProperty(a)&&(e.prototype[a]=n[a]);e.prototype.constructor=e,e.superClass=t}function FC(e,t,n){if(e="prototype"in e?e.prototype:e,t="prototype"in t?t.prototype:t,Object.getOwnPropertyNames)for(var i=Object.getOwnPropertyNames(t),a=0;a<i.length;a++){var r=i[a];"constructor"!==r&&(n?null!=t[r]:null==e[r])&&(e[r]=t[r])}else $C(e,t,n)}function BC(e){return!!e&&("string"!=typeof e&&"number"==typeof e.length)}function jC(e,t,n){if(e&&t)if(e.forEach&&e.forEach===SC)e.forEach(t,n);else if(e.length===+e.length)for(var i=0,a=e.length;i<a;i++)t.call(n,e[i],i,e);else for(var r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r,e)}function UC(e,t,n){if(!e)return[];if(!t)return uI(e);if(e.map&&e.map===CC)return e.map(t,n);for(var i=[],a=0,r=e.length;a<r;a++)i.push(t.call(n,e[a],a,e));return i}function VC(e,t,n,i){if(e&&t){for(var a=0,r=e.length;a<r;a++)n=t.call(i,n,e[a],a,e);return n}}function qC(e,t,n){if(!e)return[];if(!t)return uI(e);if(e.filter&&e.filter===xC)return e.filter(t,n);for(var i=[],a=0,r=e.length;a<r;a++)t.call(n,e[a],a,e)&&i.push(e[a]);return i}function HC(e,t,n){if(e&&t)for(var i=0,a=e.length;i<a;i++)if(t.call(n,e[i],i,e))return e[i]}function WC(e){if(!e)return[];if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}var GC=DC&&ZC(DC.bind)?DC.call.bind(DC.bind):function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return function(){return e.apply(t,n.concat(_C.call(arguments)))}};function QC(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return function(){return e.apply(this,t.concat(_C.call(arguments)))}}function KC(e){return Array.isArray?Array.isArray(e):"[object Array]"===wC.call(e)}function ZC(e){return"function"==typeof e}function YC(e){return"string"==typeof e}function XC(e){return"[object String]"===wC.call(e)}function JC(e){return"number"==typeof e}function eI(e){var t=typeof e;return"function"===t||!!e&&"object"===t}function tI(e){return!!yC[wC.call(e)]}function nI(e){return!!bC[wC.call(e)]}function iI(e){return"object"==typeof e&&"number"==typeof e.nodeType&&"object"==typeof e.ownerDocument}function aI(e){return null!=e.colorStops}function rI(e){return null!=e.image}function sI(e){return"[object RegExp]"===wC.call(e)}function oI(e){return e!=e}function lI(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0,i=e.length;n<i;n++)if(null!=e[n])return e[n]}function cI(e,t){return null!=e?e:t}function dI(e,t,n){return null!=e?e:null!=t?t:n}function uI(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return _C.apply(e,t)}function hI(e){if("number"==typeof e)return[e,e,e,e];var t=e.length;return 2===t?[e[0],e[1],e[0],e[1]]:3===t?[e[0],e[1],e[2],e[1]]:e}function pI(e,t){if(!e)throw new Error(t)}function gI(e){return null==e?null:"function"==typeof e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}var vI="__ec_primitive__";function fI(e){e[vI]=!0}function mI(e){return e[vI]}var yI=function(){function e(){this.data={}}return e.prototype.delete=function(e){var t=this.has(e);return t&&delete this.data[e],t},e.prototype.has=function(e){return this.data.hasOwnProperty(e)},e.prototype.get=function(e){return this.data[e]},e.prototype.set=function(e,t){return this.data[e]=t,this},e.prototype.keys=function(){return WC(this.data)},e.prototype.forEach=function(e){var t=this.data;for(var n in t)t.hasOwnProperty(n)&&e(t[n],n)},e}(),bI="function"==typeof Map;var wI=function(){function e(t){var n=KC(t);this.data=bI?new Map:new yI;var i=this;function a(e,t){n?i.set(e,t):i.set(t,e)}t instanceof e?t.each(a):t&&jC(t,a)}return e.prototype.hasKey=function(e){return this.data.has(e)},e.prototype.get=function(e){return this.data.get(e)},e.prototype.set=function(e,t){return this.data.set(e,t),t},e.prototype.each=function(e,t){this.data.forEach(function(n,i){e.call(t,n,i)})},e.prototype.keys=function(){var e=this.data.keys();return bI?Array.from(e):e},e.prototype.removeKey=function(e){this.data.delete(e)},e}();function kI(e){return new wI(e)}function SI(e,t){for(var n=new e.constructor(e.length+t.length),i=0;i<e.length;i++)n[i]=e[i];var a=e.length;for(i=0;i<t.length;i++)n[i+a]=t[i];return n}function xI(e,t){var n;if(Object.create)n=Object.create(e);else{var i=function(){};i.prototype=e,n=new i}return t&&RC(n,t),n}function _I(e){var t=e.style;t.webkitUserSelect="none",t.userSelect="none",t.webkitTapHighlightColor="rgba(0,0,0,0)",t["-webkit-touch-callout"]="none"}function CI(e,t){return e.hasOwnProperty(t)}function II(){}var DI=180/Math.PI,TI=Number.EPSILON||Math.pow(2,-52);const MI=Object.freeze(Object.defineProperty({__proto__:null,EPSILON:TI,HashMap:wI,RADIAN_TO_DEGREE:DI,assert:pI,bind:GC,clone:zC,concatArray:SI,createCanvas:OC,createHashMap:kI,createObject:xI,curry:QC,defaults:$C,disableUserSelect:_I,each:jC,eqNaN:oI,extend:RC,filter:qC,find:HC,guid:AC,hasOwn:CI,indexOf:LC,inherits:NC,isArray:KC,isArrayLike:BC,isBuiltInObject:tI,isDom:iI,isFunction:ZC,isGradientObject:aI,isImagePatternObject:rI,isNumber:JC,isObject:eI,isPrimitive:mI,isRegExp:sI,isString:YC,isStringSafe:XC,isTypedArray:nI,keys:WC,logError:EC,map:UC,merge:PC,mergeAll:function(e,t){for(var n=e[0],i=1,a=e.length;i<a;i++)n=PC(n,e[i],t);return n},mixin:FC,noop:II,normalizeCssArray:hI,reduce:VC,retrieve:lI,retrieve2:cI,retrieve3:dI,setAsPrimitive:fI,slice:uI,trim:gI},Symbol.toStringTag,{value:"Module"}));var AI=function(e,t){return(AI=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function EI(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}AI(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function zI(e,t){return null==e&&(e=0),null==t&&(t=0),[e,t]}function PI(e){return[e[0],e[1]]}function RI(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function $I(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function OI(e){return Math.sqrt(NI(e))}var LI=OI;function NI(e){return e[0]*e[0]+e[1]*e[1]}var FI=NI;function BI(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e}function jI(e,t){var n=OI(t);return 0===n?(e[0]=0,e[1]=0):(e[0]=t[0]/n,e[1]=t[1]/n),e}function UI(e,t){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}var VI=UI;function qI(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}var HI=qI;function WI(e,t,n,i){return e[0]=t[0]+i*(n[0]-t[0]),e[1]=t[1]+i*(n[1]-t[1]),e}function GI(e,t,n){var i=t[0],a=t[1];return e[0]=n[0]*i+n[2]*a+n[4],e[1]=n[1]*i+n[3]*a+n[5],e}function QI(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e}function KI(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e}const ZI=Object.freeze(Object.defineProperty({__proto__:null,add:RI,applyTransform:GI,clone:PI,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e},create:zI,dist:VI,distSquare:HI,distance:UI,distanceSquare:qI,div:function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]},len:OI,lenSquare:NI,length:LI,lengthSquare:FI,lerp:WI,max:KI,min:QI,mul:function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e},negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e},normalize:jI,scale:BI,scaleAndAdd:function(e,t,n,i){return e[0]=t[0]+n[0]*i,e[1]=t[1]+n[1]*i,e},set:function(e,t,n){return e[0]=t,e[1]=n,e},sub:$I},Symbol.toStringTag,{value:"Module"}));var YI=function(){return function(e,t){this.target=e,this.topTarget=t&&t.topTarget}}(),XI=function(){function e(e){this.handler=e,e.on("mousedown",this._dragStart,this),e.on("mousemove",this._drag,this),e.on("mouseup",this._dragEnd,this)}return e.prototype._dragStart=function(e){for(var t=e.target;t&&!t.draggable;)t=t.parent||t.__hostTarget;t&&(this._draggingTarget=t,t.dragging=!0,this._x=e.offsetX,this._y=e.offsetY,this.handler.dispatchToElement(new YI(t,e),"dragstart",e.event))},e.prototype._drag=function(e){var t=this._draggingTarget;if(t){var n=e.offsetX,i=e.offsetY,a=n-this._x,r=i-this._y;this._x=n,this._y=i,t.drift(a,r,e),this.handler.dispatchToElement(new YI(t,e),"drag",e.event);var s=this.handler.findHover(n,i,t).target,o=this._dropTarget;this._dropTarget=s,t!==s&&(o&&s!==o&&this.handler.dispatchToElement(new YI(o,e),"dragleave",e.event),s&&s!==o&&this.handler.dispatchToElement(new YI(s,e),"dragenter",e.event))}},e.prototype._dragEnd=function(e){var t=this._draggingTarget;t&&(t.dragging=!1),this.handler.dispatchToElement(new YI(t,e),"dragend",e.event),this._dropTarget&&this.handler.dispatchToElement(new YI(this._dropTarget,e),"drop",e.event),this._draggingTarget=null,this._dropTarget=null},e}(),JI=function(){function e(e){e&&(this._$eventProcessor=e)}return e.prototype.on=function(e,t,n,i){this._$handlers||(this._$handlers={});var a=this._$handlers;if("function"==typeof t&&(i=n,n=t,t=null),!n||!e)return this;var r=this._$eventProcessor;null!=t&&r&&r.normalizeQuery&&(t=r.normalizeQuery(t)),a[e]||(a[e]=[]);for(var s=0;s<a[e].length;s++)if(a[e][s].h===n)return this;var o={h:n,query:t,ctx:i||this,callAtLast:n.zrEventfulCallAtLast},l=a[e].length-1,c=a[e][l];return c&&c.callAtLast?a[e].splice(l,0,o):a[e].push(o),this},e.prototype.isSilent=function(e){var t=this._$handlers;return!t||!t[e]||!t[e].length},e.prototype.off=function(e,t){var n=this._$handlers;if(!n)return this;if(!e)return this._$handlers={},this;if(t){if(n[e]){for(var i=[],a=0,r=n[e].length;a<r;a++)n[e][a].h!==t&&i.push(n[e][a]);n[e]=i}n[e]&&0===n[e].length&&delete n[e]}else delete n[e];return this},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(!this._$handlers)return this;var i=this._$handlers[e],a=this._$eventProcessor;if(i)for(var r=t.length,s=i.length,o=0;o<s;o++){var l=i[o];if(!a||!a.filter||null==l.query||a.filter(e,l.query))switch(r){case 0:l.h.call(l.ctx);break;case 1:l.h.call(l.ctx,t[0]);break;case 2:l.h.call(l.ctx,t[0],t[1]);break;default:l.h.apply(l.ctx,t)}}return a&&a.afterTrigger&&a.afterTrigger(e),this},e.prototype.triggerWithContext=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(!this._$handlers)return this;var i=this._$handlers[e],a=this._$eventProcessor;if(i)for(var r=t.length,s=t[r-1],o=i.length,l=0;l<o;l++){var c=i[l];if(!a||!a.filter||null==c.query||a.filter(e,c.query))switch(r){case 0:c.h.call(s);break;case 1:c.h.call(s,t[0]);break;case 2:c.h.call(s,t[0],t[1]);break;default:c.h.apply(s,t.slice(1,r-1))}}return a&&a.afterTrigger&&a.afterTrigger(e),this},e}(),eD=Math.log(2);function tD(e,t,n,i,a,r){var s=i+"-"+a,o=e.length;if(r.hasOwnProperty(s))return r[s];if(1===t){var l=Math.round(Math.log((1<<o)-1&~a)/eD);return e[n][l]}for(var c=i|1<<n,d=n+1;i&1<<d;)d++;for(var u=0,h=0,p=0;h<o;h++){var g=1<<h;g&a||(u+=(p%2?-1:1)*e[n][h]*tD(e,t-1,d,c,a|g,r),p++)}return r[s]=u,u}function nD(e,t){var n=[[e[0],e[1],1,0,0,0,-t[0]*e[0],-t[0]*e[1]],[0,0,0,e[0],e[1],1,-t[1]*e[0],-t[1]*e[1]],[e[2],e[3],1,0,0,0,-t[2]*e[2],-t[2]*e[3]],[0,0,0,e[2],e[3],1,-t[3]*e[2],-t[3]*e[3]],[e[4],e[5],1,0,0,0,-t[4]*e[4],-t[4]*e[5]],[0,0,0,e[4],e[5],1,-t[5]*e[4],-t[5]*e[5]],[e[6],e[7],1,0,0,0,-t[6]*e[6],-t[6]*e[7]],[0,0,0,e[6],e[7],1,-t[7]*e[6],-t[7]*e[7]]],i={},a=tD(n,8,0,0,0,i);if(0!==a){for(var r=[],s=0;s<8;s++)for(var o=0;o<8;o++)null==r[o]&&(r[o]=0),r[o]+=((s+o)%2?-1:1)*tD(n,7,0===s?1:0,1<<s,1<<o,i)/a*t[s];return function(e,t,n){var i=t*r[6]+n*r[7]+1;e[0]=(t*r[0]+n*r[1]+r[2])/i,e[1]=(t*r[3]+n*r[4]+r[5])/i}}}var iD="___zrEVENTSAVED",aD=[];function rD(e,t,n,i,a){if(t.getBoundingClientRect&&pC.domSupported&&!sD(t)){var r=t[iD]||(t[iD]={}),s=function(e,t){var n=t.markers;if(n)return n;n=t.markers=[];for(var i=["left","right"],a=["top","bottom"],r=0;r<4;r++){var s=document.createElement("div"),o=r%2,l=(r>>1)%2;s.style.cssText=["position: absolute","visibility: hidden","padding: 0","margin: 0","border-width: 0","user-select: none","width:0","height:0",i[o]+":0",a[l]+":0",i[1-o]+":auto",a[1-l]+":auto",""].join("!important;"),e.appendChild(s),n.push(s)}return t.clearMarkers=function(){jC(n,function(e){e.parentNode&&e.parentNode.removeChild(e)})},n}(t,r),o=function(e,t,n){for(var i=n?"invTrans":"trans",a=t[i],r=t.srcCoords,s=[],o=[],l=!0,c=0;c<4;c++){var d=e[c].getBoundingClientRect(),u=2*c,h=d.left,p=d.top;s.push(h,p),l=l&&r&&h===r[u]&&p===r[u+1],o.push(e[c].offsetLeft,e[c].offsetTop)}return l&&a?a:(t.srcCoords=s,t[i]=n?nD(o,s):nD(s,o))}(s,r,a);if(o)return o(e,n,i),!0}return!1}function sD(e){return"CANVAS"===e.nodeName.toUpperCase()}var oD=/([&<>"'])/g,lD={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function cD(e){return null==e?"":(e+"").replace(oD,function(e,t){return lD[t]})}var dD=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,uD=[],hD=pC.browser.firefox&&+pC.browser.version.split(".")[0]<39;function pD(e,t,n,i){return n=n||{},i?gD(e,t,n):hD&&null!=t.layerX&&t.layerX!==t.offsetX?(n.zrX=t.layerX,n.zrY=t.layerY):null!=t.offsetX?(n.zrX=t.offsetX,n.zrY=t.offsetY):gD(e,t,n),n}function gD(e,t,n){if(pC.domSupported&&e.getBoundingClientRect){var i=t.clientX,a=t.clientY;if(sD(e)){var r=e.getBoundingClientRect();return n.zrX=i-r.left,void(n.zrY=a-r.top)}if(rD(uD,e,i,a))return n.zrX=uD[0],void(n.zrY=uD[1])}n.zrX=n.zrY=0}function vD(e){return e||window.event}function fD(e,t,n){if(null!=(t=vD(t)).zrX)return t;var i=t.type;if(i&&i.indexOf("touch")>=0){var a="touchend"!==i?t.targetTouches[0]:t.changedTouches[0];a&&pD(e,a,t,n)}else{pD(e,t,t,n);var r=function(e){var t=e.wheelDelta;if(t)return t;var n=e.deltaX,i=e.deltaY;if(null==n||null==i)return t;return 3*(0!==i?Math.abs(i):Math.abs(n))*(i>0?-1:i<0?1:n>0?-1:1)}(t);t.zrDelta=r?r/120:-(t.detail||0)/3}var s=t.button;return null==t.which&&void 0!==s&&dD.test(t.type)&&(t.which=1&s?1:2&s?3:4&s?2:0),t}function mD(e,t,n,i){e.addEventListener(t,n,i)}function yD(e,t,n,i){e.removeEventListener(t,n,i)}var bD=function(e){e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0};function wD(e){return 2===e.which||3===e.which}var kD=function(){function e(){this._track=[]}return e.prototype.recognize=function(e,t,n){return this._doTrack(e,t,n),this._recognize(e)},e.prototype.clear=function(){return this._track.length=0,this},e.prototype._doTrack=function(e,t,n){var i=e.touches;if(i){for(var a={points:[],touches:[],target:t,event:e},r=0,s=i.length;r<s;r++){var o=i[r],l=pD(n,o,{});a.points.push([l.zrX,l.zrY]),a.touches.push(o)}this._track.push(a)}},e.prototype._recognize=function(e){for(var t in xD)if(xD.hasOwnProperty(t)){var n=xD[t](this._track,e);if(n)return n}},e}();function SD(e){var t=e[1][0]-e[0][0],n=e[1][1]-e[0][1];return Math.sqrt(t*t+n*n)}var xD={pinch:function(e,t){var n=e.length;if(n){var i,a=(e[n-1]||{}).points,r=(e[n-2]||{}).points||a;if(r&&r.length>1&&a&&a.length>1){var s=SD(a)/SD(r);!isFinite(s)&&(s=1),t.pinchScale=s;var o=[((i=a)[0][0]+i[1][0])/2,(i[0][1]+i[1][1])/2];return t.pinchX=o[0],t.pinchY=o[1],{type:"pinch",target:e[0].target,event:t}}}}};function _D(){return[1,0,0,1,0,0]}function CD(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e}function ID(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function DD(e,t,n){var i=t[0]*n[0]+t[2]*n[1],a=t[1]*n[0]+t[3]*n[1],r=t[0]*n[2]+t[2]*n[3],s=t[1]*n[2]+t[3]*n[3],o=t[0]*n[4]+t[2]*n[5]+t[4],l=t[1]*n[4]+t[3]*n[5]+t[5];return e[0]=i,e[1]=a,e[2]=r,e[3]=s,e[4]=o,e[5]=l,e}function TD(e,t,n){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4]+n[0],e[5]=t[5]+n[1],e}function MD(e,t,n,i){void 0===i&&(i=[0,0]);var a=t[0],r=t[2],s=t[4],o=t[1],l=t[3],c=t[5],d=Math.sin(n),u=Math.cos(n);return e[0]=a*u+o*d,e[1]=-a*d+o*u,e[2]=r*u+l*d,e[3]=-r*d+u*l,e[4]=u*(s-i[0])+d*(c-i[1])+i[0],e[5]=u*(c-i[1])-d*(s-i[0])+i[1],e}function AD(e,t,n){var i=n[0],a=n[1];return e[0]=t[0]*i,e[1]=t[1]*a,e[2]=t[2]*i,e[3]=t[3]*a,e[4]=t[4]*i,e[5]=t[5]*a,e}function ED(e,t){var n=t[0],i=t[2],a=t[4],r=t[1],s=t[3],o=t[5],l=n*s-r*i;return l?(l=1/l,e[0]=s*l,e[1]=-r*l,e[2]=-i*l,e[3]=n*l,e[4]=(i*o-s*a)*l,e[5]=(r*a-n*o)*l,e):null}const zD=Object.freeze(Object.defineProperty({__proto__:null,clone:function(e){var t=[1,0,0,1,0,0];return ID(t,e),t},copy:ID,create:_D,identity:CD,invert:ED,mul:DD,rotate:MD,scale:AD,translate:TD},Symbol.toStringTag,{value:"Module"}));var PD=function(){function e(e,t){this.x=e||0,this.y=t||0}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.set=function(e,t){return this.x=e,this.y=t,this},e.prototype.equal=function(e){return e.x===this.x&&e.y===this.y},e.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},e.prototype.scale=function(e){this.x*=e,this.y*=e},e.prototype.scaleAndAdd=function(e,t){this.x+=e.x*t,this.y+=e.y*t},e.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},e.prototype.dot=function(e){return this.x*e.x+this.y*e.y},e.prototype.len=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.lenSquare=function(){return this.x*this.x+this.y*this.y},e.prototype.normalize=function(){var e=this.len();return this.x/=e,this.y/=e,this},e.prototype.distance=function(e){var t=this.x-e.x,n=this.y-e.y;return Math.sqrt(t*t+n*n)},e.prototype.distanceSquare=function(e){var t=this.x-e.x,n=this.y-e.y;return t*t+n*n},e.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},e.prototype.transform=function(e){if(e){var t=this.x,n=this.y;return this.x=e[0]*t+e[2]*n+e[4],this.y=e[1]*t+e[3]*n+e[5],this}},e.prototype.toArray=function(e){return e[0]=this.x,e[1]=this.y,e},e.prototype.fromArray=function(e){this.x=e[0],this.y=e[1]},e.set=function(e,t,n){e.x=t,e.y=n},e.copy=function(e,t){e.x=t.x,e.y=t.y},e.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},e.lenSquare=function(e){return e.x*e.x+e.y*e.y},e.dot=function(e,t){return e.x*t.x+e.y*t.y},e.add=function(e,t,n){e.x=t.x+n.x,e.y=t.y+n.y},e.sub=function(e,t,n){e.x=t.x-n.x,e.y=t.y-n.y},e.scale=function(e,t,n){e.x=t.x*n,e.y=t.y*n},e.scaleAndAdd=function(e,t,n,i){e.x=t.x+n.x*i,e.y=t.y+n.y*i},e.lerp=function(e,t,n,i){var a=1-i;e.x=a*t.x+i*n.x,e.y=a*t.y+i*n.y},e}(),RD=Math.min,$D=Math.max,OD=Math.abs,LD=["x","y"],ND=["width","height"],FD=new PD,BD=new PD,jD=new PD,UD=new PD,VD=YD(),qD=VD.minTv,HD=VD.maxTv,WD=[0,0],GD=function(){function e(t,n,i,a){e.set(this,t,n,i,a)}return e.set=function(e,t,n,i,a){return i<0&&(t+=i,i=-i),a<0&&(n+=a,a=-a),e.x=t,e.y=n,e.width=i,e.height=a,e},e.prototype.union=function(e){var t=RD(e.x,this.x),n=RD(e.y,this.y);isFinite(this.x)&&isFinite(this.width)?this.width=$D(e.x+e.width,this.x+this.width)-t:this.width=e.width,isFinite(this.y)&&isFinite(this.height)?this.height=$D(e.y+e.height,this.y+this.height)-n:this.height=e.height,this.x=t,this.y=n},e.prototype.applyTransform=function(t){e.applyTransform(this,this,t)},e.prototype.calculateTransform=function(e){var t=this,n=e.width/t.width,i=e.height/t.height,a=[1,0,0,1,0,0];return TD(a,a,[-t.x,-t.y]),AD(a,a,[n,i]),TD(a,a,[e.x,e.y]),a},e.prototype.intersect=function(t,n,i){return e.intersect(this,t,n,i)},e.intersect=function(t,n,i,a){i&&PD.set(i,0,0);var r=a&&a.outIntersectRect||null,s=a&&a.clamp;if(r&&(r.x=r.y=r.width=r.height=NaN),!t||!n)return!1;t instanceof e||(t=e.set(QD,t.x,t.y,t.width,t.height)),n instanceof e||(n=e.set(KD,n.x,n.y,n.width,n.height));var o=!!i;VD.reset(a,o);var l=VD.touchThreshold,c=t.x+l,d=t.x+t.width-l,u=t.y+l,h=t.y+t.height-l,p=n.x+l,g=n.x+n.width-l,v=n.y+l,f=n.y+n.height-l;if(c>d||u>h||p>g||v>f)return!1;var m=!(d<p||g<c||h<v||f<u);return(o||r)&&(WD[0]=1/0,WD[1]=0,ZD(c,d,p,g,0,o,r,s),ZD(u,h,v,f,1,o,r,s),o&&PD.copy(i,m?VD.useDir?VD.dirMinTv:qD:HD)),m},e.contain=function(e,t,n){return t>=e.x&&t<=e.x+e.width&&n>=e.y&&n<=e.y+e.height},e.prototype.contain=function(t,n){return e.contain(this,t,n)},e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height)},e.prototype.copy=function(t){e.copy(this,t)},e.prototype.plain=function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},e.prototype.isFinite=function(){return isFinite(this.x)&&isFinite(this.y)&&isFinite(this.width)&&isFinite(this.height)},e.prototype.isZero=function(){return 0===this.width||0===this.height},e.create=function(t){return new e(t.x,t.y,t.width,t.height)},e.copy=function(e,t){return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e},e.applyTransform=function(t,n,i){if(i){if(i[1]<1e-5&&i[1]>-1e-5&&i[2]<1e-5&&i[2]>-1e-5){var a=i[0],r=i[3],s=i[4],o=i[5];return t.x=n.x*a+s,t.y=n.y*r+o,t.width=n.width*a,t.height=n.height*r,t.width<0&&(t.x+=t.width,t.width=-t.width),void(t.height<0&&(t.y+=t.height,t.height=-t.height))}FD.x=jD.x=n.x,FD.y=UD.y=n.y,BD.x=UD.x=n.x+n.width,BD.y=jD.y=n.y+n.height,FD.transform(i),UD.transform(i),BD.transform(i),jD.transform(i),t.x=RD(FD.x,BD.x,jD.x,UD.x),t.y=RD(FD.y,BD.y,jD.y,UD.y);var l=$D(FD.x,BD.x,jD.x,UD.x),c=$D(FD.y,BD.y,jD.y,UD.y);t.width=l-t.x,t.height=c-t.y}else t!==n&&e.copy(t,n)},e}(),QD=new GD(0,0,0,0),KD=new GD(0,0,0,0);function ZD(e,t,n,i,a,r,s,o){var l=OD(t-n),c=OD(i-e),d=RD(l,c),u=LD[a],h=LD[1-a],p=ND[a];t<n||i<e?l<c?(r&&(HD[u]=-l),o&&(s[u]=t,s[p]=0)):(r&&(HD[u]=c),o&&(s[u]=e,s[p]=0)):(s&&(s[u]=$D(e,n),s[p]=RD(t,i)-s[u]),r&&(d<WD[0]||VD.useDir)&&(WD[0]=RD(d,WD[0]),(l<c||!VD.bidirectional)&&(qD[u]=l,qD[h]=0,VD.useDir&&VD.calcDirMTV()),(l>=c||!VD.bidirectional)&&(qD[u]=-c,qD[h]=0,VD.useDir&&VD.calcDirMTV())))}function YD(){var e=0,t=new PD,n=new PD,i={minTv:new PD,maxTv:new PD,useDir:!1,dirMinTv:new PD,touchThreshold:0,bidirectional:!0,negativeSize:!1,reset:function(a,r){i.touchThreshold=0,a&&null!=a.touchThreshold&&(i.touchThreshold=$D(0,a.touchThreshold)),i.negativeSize=!1,r&&(i.minTv.set(1/0,1/0),i.maxTv.set(0,0),i.useDir=!1,a&&null!=a.direction&&(i.useDir=!0,i.dirMinTv.copy(i.minTv),n.copy(i.minTv),e=a.direction,i.bidirectional=null==a.bidirectional||!!a.bidirectional,i.bidirectional||t.set(Math.cos(e),Math.sin(e))))},calcDirMTV:function(){var r=i.minTv,s=i.dirMinTv,o=r.y*r.y+r.x*r.x,l=Math.sin(e),c=Math.cos(e),d=l*r.y+c*r.x;a(d)?a(r.x)&&a(r.y)&&s.set(0,0):(n.x=o*c/d,n.y=o*l/d,a(n.x)&&a(n.y)?s.set(0,0):(i.bidirectional||t.dot(n)>0)&&n.len()<s.len()&&s.copy(n))}};function a(e){return OD(e)<1e-10}return i}var XD="silent";function JD(){bD(this.event)}var eT=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.handler=null,t}return EI(t,e),t.prototype.dispose=function(){},t.prototype.setCursor=function(){},t}(JI),tT=function(){return function(e,t){this.x=e,this.y=t}}(),nT=["click","dblclick","mousewheel","mouseout","mouseup","mousedown","mousemove","contextmenu"],iT=new GD(0,0,0,0),aT=function(e){function t(t,n,i,a,r){var s=e.call(this)||this;return s._hovered=new tT(0,0),s.storage=t,s.painter=n,s.painterRoot=a,s._pointerSize=r,i=i||new eT,s.proxy=null,s.setHandlerProxy(i),s._draggingMgr=new XI(s),s}return EI(t,e),t.prototype.setHandlerProxy=function(e){this.proxy&&this.proxy.dispose(),e&&(jC(nT,function(t){e.on&&e.on(t,this[t],this)},this),e.handler=this),this.proxy=e},t.prototype.mousemove=function(e){var t=e.zrX,n=e.zrY,i=oT(this,t,n),a=this._hovered,r=a.target;r&&!r.__zr&&(r=(a=this.findHover(a.x,a.y)).target);var s=this._hovered=i?new tT(t,n):this.findHover(t,n),o=s.target,l=this.proxy;l.setCursor&&l.setCursor(o?o.cursor:"default"),r&&o!==r&&this.dispatchToElement(a,"mouseout",e),this.dispatchToElement(s,"mousemove",e),o&&o!==r&&this.dispatchToElement(s,"mouseover",e)},t.prototype.mouseout=function(e){var t=e.zrEventControl;"only_globalout"!==t&&this.dispatchToElement(this._hovered,"mouseout",e),"no_globalout"!==t&&this.trigger("globalout",{type:"globalout",event:e})},t.prototype.resize=function(){this._hovered=new tT(0,0)},t.prototype.dispatch=function(e,t){var n=this[e];n&&n.call(this,t)},t.prototype.dispose=function(){this.proxy.dispose(),this.storage=null,this.proxy=null,this.painter=null},t.prototype.setCursorStyle=function(e){var t=this.proxy;t.setCursor&&t.setCursor(e)},t.prototype.dispatchToElement=function(e,t,n){var i=(e=e||{}).target;if(!i||!i.silent){for(var a="on"+t,r=function(e,t,n){return{type:e,event:n,target:t.target,topTarget:t.topTarget,cancelBubble:!1,offsetX:n.zrX,offsetY:n.zrY,gestureEvent:n.gestureEvent,pinchX:n.pinchX,pinchY:n.pinchY,pinchScale:n.pinchScale,wheelDelta:n.zrDelta,zrByTouch:n.zrByTouch,which:n.which,stop:JD}}(t,e,n);i&&(i[a]&&(r.cancelBubble=!!i[a].call(i,r)),i.trigger(t,r),i=i.__hostTarget?i.__hostTarget:i.parent,!r.cancelBubble););r.cancelBubble||(this.trigger(t,r),this.painter&&this.painter.eachOtherLayer&&this.painter.eachOtherLayer(function(e){"function"==typeof e[a]&&e[a].call(e,r),e.trigger&&e.trigger(t,r)}))}},t.prototype.findHover=function(e,t,n){var i=this.storage.getDisplayList(),a=new tT(e,t);if(sT(i,a,e,t,n),this._pointerSize&&!a.target){for(var r=[],s=this._pointerSize,o=s/2,l=new GD(e-o,t-o,s,s),c=i.length-1;c>=0;c--){var d=i[c];d===n||d.ignore||d.ignoreCoarsePointer||d.parent&&d.parent.ignoreCoarsePointer||(iT.copy(d.getBoundingRect()),d.transform&&iT.applyTransform(d.transform),iT.intersect(l)&&r.push(d))}if(r.length)for(var u=Math.PI/12,h=2*Math.PI,p=0;p<o;p+=4)for(var g=0;g<h;g+=u){if(sT(r,a,e+p*Math.cos(g),t+p*Math.sin(g),n),a.target)return a}}return a},t.prototype.processGesture=function(e,t){this._gestureMgr||(this._gestureMgr=new kD);var n=this._gestureMgr;"start"===t&&n.clear();var i=n.recognize(e,this.findHover(e.zrX,e.zrY,null).target,this.proxy.dom);if("end"===t&&n.clear(),i){var a=i.type;e.gestureEvent=a;var r=new tT;r.target=i.target,this.dispatchToElement(r,a,i.event)}},t}(JI);function rT(e,t,n){if(e[e.rectHover?"rectContain":"contain"](t,n)){for(var i=e,a=void 0,r=!1;i;){if(i.ignoreClip&&(r=!0),!r){var s=i.getClipPath();if(s&&!s.contain(t,n))return!1}i.silent&&(a=!0);var o=i.__hostTarget;i=o?i.ignoreHostSilent?null:o:i.parent}return!a||XD}return!1}function sT(e,t,n,i,a){for(var r=e.length-1;r>=0;r--){var s=e[r],o=void 0;if(s!==a&&!s.ignore&&(o=rT(s,n,i))&&(!t.topTarget&&(t.topTarget=s),o!==XD)){t.target=s;break}}}function oT(e,t,n){var i=e.painter;return t<0||t>i.getWidth()||n<0||n>i.getHeight()}jC(["click","mousedown","mouseup","mousewheel","dblclick","contextmenu"],function(e){aT.prototype[e]=function(t){var n,i,a=t.zrX,r=t.zrY,s=oT(this,a,r);if("mouseup"===e&&s||(i=(n=this.findHover(a,r)).target),"mousedown"===e)this._downEl=i,this._downPoint=[t.zrX,t.zrY],this._upEl=i;else if("mouseup"===e)this._upEl=i;else if("click"===e){if(this._downEl!==this._upEl||!this._downPoint||VI(this._downPoint,[t.zrX,t.zrY])>4)return;this._downPoint=null}this.dispatchToElement(n,e,t)}});function lT(e,t,n,i){var a=t+1;if(a===n)return 1;if(i(e[a++],e[t])<0){for(;a<n&&i(e[a],e[a-1])<0;)a++;!function(e,t,n){n--;for(;t<n;){var i=e[t];e[t++]=e[n],e[n--]=i}}(e,t,a)}else for(;a<n&&i(e[a],e[a-1])>=0;)a++;return a-t}function cT(e,t,n,i,a){for(i===t&&i++;i<n;i++){for(var r,s=e[i],o=t,l=i;o<l;)a(s,e[r=o+l>>>1])<0?l=r:o=r+1;var c=i-o;switch(c){case 3:e[o+3]=e[o+2];case 2:e[o+2]=e[o+1];case 1:e[o+1]=e[o];break;default:for(;c>0;)e[o+c]=e[o+c-1],c--}e[o]=s}}function dT(e,t,n,i,a,r){var s=0,o=0,l=1;if(r(e,t[n+a])>0){for(o=i-a;l<o&&r(e,t[n+a+l])>0;)s=l,(l=1+(l<<1))<=0&&(l=o);l>o&&(l=o),s+=a,l+=a}else{for(o=a+1;l<o&&r(e,t[n+a-l])<=0;)s=l,(l=1+(l<<1))<=0&&(l=o);l>o&&(l=o);var c=s;s=a-l,l=a-c}for(s++;s<l;){var d=s+(l-s>>>1);r(e,t[n+d])>0?s=d+1:l=d}return l}function uT(e,t,n,i,a,r){var s=0,o=0,l=1;if(r(e,t[n+a])<0){for(o=a+1;l<o&&r(e,t[n+a-l])<0;)s=l,(l=1+(l<<1))<=0&&(l=o);l>o&&(l=o);var c=s;s=a-l,l=a-c}else{for(o=i-a;l<o&&r(e,t[n+a+l])>=0;)s=l,(l=1+(l<<1))<=0&&(l=o);l>o&&(l=o),s+=a,l+=a}for(s++;s<l;){var d=s+(l-s>>>1);r(e,t[n+d])<0?l=d:s=d+1}return l}function hT(e,t){var n,i,a=7,r=0,s=[];function o(o){var l=n[o],c=i[o],d=n[o+1],u=i[o+1];i[o]=c+u,o===r-3&&(n[o+1]=n[o+2],i[o+1]=i[o+2]),r--;var h=uT(e[d],e,l,c,0,t);l+=h,0!==(c-=h)&&0!==(u=dT(e[l+c-1],e,d,u,u-1,t))&&(c<=u?function(n,i,r,o){var l=0;for(l=0;l<i;l++)s[l]=e[n+l];var c=0,d=r,u=n;if(e[u++]=e[d++],0===--o){for(l=0;l<i;l++)e[u+l]=s[c+l];return}if(1===i){for(l=0;l<o;l++)e[u+l]=e[d+l];return void(e[u+o]=s[c])}var h,p,g,v=a;for(;;){h=0,p=0,g=!1;do{if(t(e[d],s[c])<0){if(e[u++]=e[d++],p++,h=0,0===--o){g=!0;break}}else if(e[u++]=s[c++],h++,p=0,1===--i){g=!0;break}}while((h|p)<v);if(g)break;do{if(0!==(h=uT(e[d],s,c,i,0,t))){for(l=0;l<h;l++)e[u+l]=s[c+l];if(u+=h,c+=h,(i-=h)<=1){g=!0;break}}if(e[u++]=e[d++],0===--o){g=!0;break}if(0!==(p=dT(s[c],e,d,o,0,t))){for(l=0;l<p;l++)e[u+l]=e[d+l];if(u+=p,d+=p,0===(o-=p)){g=!0;break}}if(e[u++]=s[c++],1===--i){g=!0;break}v--}while(h>=7||p>=7);if(g)break;v<0&&(v=0),v+=2}if((a=v)<1&&(a=1),1===i){for(l=0;l<o;l++)e[u+l]=e[d+l];e[u+o]=s[c]}else{if(0===i)throw new Error;for(l=0;l<i;l++)e[u+l]=s[c+l]}}(l,c,d,u):function(n,i,r,o){var l=0;for(l=0;l<o;l++)s[l]=e[r+l];var c=n+i-1,d=o-1,u=r+o-1,h=0,p=0;if(e[u--]=e[c--],0===--i){for(h=u-(o-1),l=0;l<o;l++)e[h+l]=s[l];return}if(1===o){for(p=(u-=i)+1,h=(c-=i)+1,l=i-1;l>=0;l--)e[p+l]=e[h+l];return void(e[u]=s[d])}var g=a;for(;;){var v=0,f=0,m=!1;do{if(t(s[d],e[c])<0){if(e[u--]=e[c--],v++,f=0,0===--i){m=!0;break}}else if(e[u--]=s[d--],f++,v=0,1===--o){m=!0;break}}while((v|f)<g);if(m)break;do{if(0!==(v=i-uT(s[d],e,n,i,i-1,t))){for(i-=v,p=(u-=v)+1,h=(c-=v)+1,l=v-1;l>=0;l--)e[p+l]=e[h+l];if(0===i){m=!0;break}}if(e[u--]=s[d--],1===--o){m=!0;break}if(0!==(f=o-dT(e[c],s,0,o,o-1,t))){for(o-=f,p=(u-=f)+1,h=(d-=f)+1,l=0;l<f;l++)e[p+l]=s[h+l];if(o<=1){m=!0;break}}if(e[u--]=e[c--],0===--i){m=!0;break}g--}while(v>=7||f>=7);if(m)break;g<0&&(g=0),g+=2}(a=g)<1&&(a=1);if(1===o){for(p=(u-=i)+1,h=(c-=i)+1,l=i-1;l>=0;l--)e[p+l]=e[h+l];e[u]=s[d]}else{if(0===o)throw new Error;for(h=u-(o-1),l=0;l<o;l++)e[h+l]=s[l]}}(l,c,d,u))}return n=[],i=[],{mergeRuns:function(){for(;r>1;){var e=r-2;if(e>=1&&i[e-1]<=i[e]+i[e+1]||e>=2&&i[e-2]<=i[e]+i[e-1])i[e-1]<i[e+1]&&e--;else if(i[e]>i[e+1])break;o(e)}},forceMergeRuns:function(){for(;r>1;){var e=r-2;e>0&&i[e-1]<i[e+1]&&e--,o(e)}},pushRun:function(e,t){n[r]=e,i[r]=t,r+=1}}}function pT(e,t,n,i){n||(n=0),i||(i=e.length);var a=i-n;if(!(a<2)){var r=0;if(a<32)cT(e,n,i,n+(r=lT(e,n,i,t)),t);else{var s=hT(e,t),o=function(e){for(var t=0;e>=32;)t|=1&e,e>>=1;return e+t}(a);do{if((r=lT(e,n,i,t))<o){var l=a;l>o&&(l=o),cT(e,n,n+l,n+r,t),r=l}s.pushRun(n,r),s.mergeRuns(),a-=r,n+=r}while(0!==a);s.forceMergeRuns()}}}var gT=!1;function vT(){gT||(gT=!0)}function fT(e,t){return e.zlevel===t.zlevel?e.z===t.z?e.z2-t.z2:e.z-t.z:e.zlevel-t.zlevel}var mT,yT=function(){function e(){this._roots=[],this._displayList=[],this._displayListLen=0,this.displayableSortFunc=fT}return e.prototype.traverse=function(e,t){for(var n=0;n<this._roots.length;n++)this._roots[n].traverse(e,t)},e.prototype.getDisplayList=function(e,t){t=t||!1;var n=this._displayList;return!e&&n.length||this.updateDisplayList(t),n},e.prototype.updateDisplayList=function(e){this._displayListLen=0;for(var t=this._roots,n=this._displayList,i=0,a=t.length;i<a;i++)this._updateAndAddDisplayable(t[i],null,e);n.length=this._displayListLen,pT(n,fT)},e.prototype._updateAndAddDisplayable=function(e,t,n){if(!e.ignore||n){e.beforeUpdate(),e.update(),e.afterUpdate();var i=e.getClipPath(),a=t&&t.length,r=0,s=e.__clipPaths;if(!e.ignoreClip&&(a||i)){if(s||(s=e.__clipPaths=[]),a)for(var o=0;o<t.length;o++)s[r++]=t[o];for(var l=i,c=e;l;)l.parent=c,l.updateTransform(),s[r++]=l,c=l,l=l.getClipPath()}if(s&&(s.length=r),e.childrenRef){for(var d=e.childrenRef(),u=0;u<d.length;u++){var h=d[u];e.__dirty&&(h.__dirty|=1),this._updateAndAddDisplayable(h,s,n)}e.__dirty=0}else{var p=e;isNaN(p.z)&&(vT(),p.z=0),isNaN(p.z2)&&(vT(),p.z2=0),isNaN(p.zlevel)&&(vT(),p.zlevel=0),this._displayList[this._displayListLen++]=p}var g=e.getDecalElement&&e.getDecalElement();g&&this._updateAndAddDisplayable(g,s,n);var v=e.getTextGuideLine();v&&this._updateAndAddDisplayable(v,s,n);var f=e.getTextContent();f&&this._updateAndAddDisplayable(f,s,n)}},e.prototype.addRoot=function(e){e.__zr&&e.__zr.storage===this||this._roots.push(e)},e.prototype.delRoot=function(e){if(e instanceof Array)for(var t=0,n=e.length;t<n;t++)this.delRoot(e[t]);else{var i=LC(this._roots,e);i>=0&&this._roots.splice(i,1)}},e.prototype.delAllRoots=function(){this._roots=[],this._displayList=[],this._displayListLen=0},e.prototype.getRoots=function(){return this._roots},e.prototype.dispose=function(){this._displayList=null,this._roots=null},e}();mT=pC.hasGlobalWindow&&(window.requestAnimationFrame&&window.requestAnimationFrame.bind(window)||window.msRequestAnimationFrame&&window.msRequestAnimationFrame.bind(window)||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(e){return setTimeout(e,16)};var bT={linear:function(e){return e},quadraticIn:function(e){return e*e},quadraticOut:function(e){return e*(2-e)},quadraticInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:function(e){return e*e*e},cubicOut:function(e){return--e*e*e+1},cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quarticIn:function(e){return e*e*e*e},quarticOut:function(e){return 1- --e*e*e*e},quarticInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quinticIn:function(e){return e*e*e*e*e},quinticOut:function(e){return--e*e*e*e*e+1},quinticInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sinusoidalIn:function(e){return 1-Math.cos(e*Math.PI/2)},sinusoidalOut:function(e){return Math.sin(e*Math.PI/2)},sinusoidalInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},exponentialIn:function(e){return 0===e?0:Math.pow(1024,e-1)},exponentialOut:function(e){return 1===e?1:1-Math.pow(2,-10*e)},exponentialInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circularIn:function(e){return 1-Math.sqrt(1-e*e)},circularOut:function(e){return Math.sqrt(1- --e*e)},circularInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:function(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))},elasticOut:function(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)},elasticInOut:function(e){var t,n=.1,i=.4;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=i*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)*.5+1)},backIn:function(e){var t=1.70158;return e*e*((t+1)*e-t)},backOut:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},bounceIn:function(e){return 1-bT.bounceOut(1-e)},bounceOut:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},bounceInOut:function(e){return e<.5?.5*bT.bounceIn(2*e):.5*bT.bounceOut(2*e-1)+.5}},wT=Math.pow,kT=Math.sqrt,ST=1e-8,xT=1e-4,_T=kT(3),CT=1/3,IT=zI(),DT=zI(),TT=zI();function MT(e){return e>-1e-8&&e<ST}function AT(e){return e>ST||e<-1e-8}function ET(e,t,n,i,a){var r=1-a;return r*r*(r*e+3*a*t)+a*a*(a*i+3*r*n)}function zT(e,t,n,i,a){var r=1-a;return 3*(((t-e)*r+2*(n-t)*a)*r+(i-n)*a*a)}function PT(e,t,n,i,a,r){var s=i+3*(t-n)-e,o=3*(n-2*t+e),l=3*(t-e),c=e-a,d=o*o-3*s*l,u=o*l-9*s*c,h=l*l-3*o*c,p=0;if(MT(d)&&MT(u)){if(MT(o))r[0]=0;else(_=-l/o)>=0&&_<=1&&(r[p++]=_)}else{var g=u*u-4*d*h;if(MT(g)){var v=u/d,f=-v/2;(_=-o/s+v)>=0&&_<=1&&(r[p++]=_),f>=0&&f<=1&&(r[p++]=f)}else if(g>0){var m=kT(g),y=d*o+1.5*s*(-u+m),b=d*o+1.5*s*(-u-m);(_=(-o-((y=y<0?-wT(-y,CT):wT(y,CT))+(b=b<0?-wT(-b,CT):wT(b,CT))))/(3*s))>=0&&_<=1&&(r[p++]=_)}else{var w=(2*d*o-3*s*u)/(2*kT(d*d*d)),k=Math.acos(w)/3,S=kT(d),x=Math.cos(k),_=(-o-2*S*x)/(3*s),C=(f=(-o+S*(x+_T*Math.sin(k)))/(3*s),(-o+S*(x-_T*Math.sin(k)))/(3*s));_>=0&&_<=1&&(r[p++]=_),f>=0&&f<=1&&(r[p++]=f),C>=0&&C<=1&&(r[p++]=C)}}return p}function RT(e,t,n,i,a){var r=6*n-12*t+6*e,s=9*t+3*i-3*e-9*n,o=3*t-3*e,l=0;if(MT(s)){if(AT(r))(d=-o/r)>=0&&d<=1&&(a[l++]=d)}else{var c=r*r-4*s*o;if(MT(c))a[0]=-r/(2*s);else if(c>0){var d,u=kT(c),h=(-r-u)/(2*s);(d=(-r+u)/(2*s))>=0&&d<=1&&(a[l++]=d),h>=0&&h<=1&&(a[l++]=h)}}return l}function $T(e,t,n,i,a,r){var s=(t-e)*a+e,o=(n-t)*a+t,l=(i-n)*a+n,c=(o-s)*a+s,d=(l-o)*a+o,u=(d-c)*a+c;r[0]=e,r[1]=s,r[2]=c,r[3]=u,r[4]=u,r[5]=d,r[6]=l,r[7]=i}function OT(e,t,n,i,a,r,s,o,l,c,d){var u,h,p,g,v,f=.005,m=1/0;IT[0]=l,IT[1]=c;for(var y=0;y<1;y+=.05)DT[0]=ET(e,n,a,s,y),DT[1]=ET(t,i,r,o,y),(g=HI(IT,DT))<m&&(u=y,m=g);m=1/0;for(var b=0;b<32&&!(f<xT);b++)h=u-f,p=u+f,DT[0]=ET(e,n,a,s,h),DT[1]=ET(t,i,r,o,h),g=HI(DT,IT),h>=0&&g<m?(u=h,m=g):(TT[0]=ET(e,n,a,s,p),TT[1]=ET(t,i,r,o,p),v=HI(TT,IT),p<=1&&v<m?(u=p,m=v):f*=.5);return d&&(d[0]=ET(e,n,a,s,u),d[1]=ET(t,i,r,o,u)),kT(m)}function LT(e,t,n,i,a,r,s,o,l){for(var c=e,d=t,u=0,h=1/l,p=1;p<=l;p++){var g=p*h,v=ET(e,n,a,s,g),f=ET(t,i,r,o,g),m=v-c,y=f-d;u+=Math.sqrt(m*m+y*y),c=v,d=f}return u}function NT(e,t,n,i){var a=1-i;return a*(a*e+2*i*t)+i*i*n}function FT(e,t,n,i){return 2*((1-i)*(t-e)+i*(n-t))}function BT(e,t,n){var i=e+n-2*t;return 0===i?.5:(e-t)/i}function jT(e,t,n,i,a){var r=(t-e)*i+e,s=(n-t)*i+t,o=(s-r)*i+r;a[0]=e,a[1]=r,a[2]=o,a[3]=o,a[4]=s,a[5]=n}function UT(e,t,n,i,a,r,s,o,l){var c,d=.005,u=1/0;IT[0]=s,IT[1]=o;for(var h=0;h<1;h+=.05){DT[0]=NT(e,n,a,h),DT[1]=NT(t,i,r,h),(f=HI(IT,DT))<u&&(c=h,u=f)}u=1/0;for(var p=0;p<32&&!(d<xT);p++){var g=c-d,v=c+d;DT[0]=NT(e,n,a,g),DT[1]=NT(t,i,r,g);var f=HI(DT,IT);if(g>=0&&f<u)c=g,u=f;else{TT[0]=NT(e,n,a,v),TT[1]=NT(t,i,r,v);var m=HI(TT,IT);v<=1&&m<u?(c=v,u=m):d*=.5}}return l&&(l[0]=NT(e,n,a,c),l[1]=NT(t,i,r,c)),kT(u)}function VT(e,t,n,i,a,r,s){for(var o=e,l=t,c=0,d=1/s,u=1;u<=s;u++){var h=u*d,p=NT(e,n,a,h),g=NT(t,i,r,h),v=p-o,f=g-l;c+=Math.sqrt(v*v+f*f),o=p,l=g}return c}var qT=/cubic-bezier\(([0-9,\.e ]+)\)/;function HT(e){var t=e&&qT.exec(e);if(t){var n=t[1].split(","),i=+gI(n[0]),a=+gI(n[1]),r=+gI(n[2]),s=+gI(n[3]);if(isNaN(i+a+r+s))return;var o=[];return function(e){return e<=0?0:e>=1?1:PT(0,i,r,1,e,o)&&ET(0,a,s,1,o[0])}}}var WT=function(){function e(e){this._inited=!1,this._startTime=0,this._pausedTime=0,this._paused=!1,this._life=e.life||1e3,this._delay=e.delay||0,this.loop=e.loop||!1,this.onframe=e.onframe||II,this.ondestroy=e.ondestroy||II,this.onrestart=e.onrestart||II,e.easing&&this.setEasing(e.easing)}return e.prototype.step=function(e,t){if(this._inited||(this._startTime=e+this._delay,this._inited=!0),!this._paused){var n=this._life,i=e-this._startTime-this._pausedTime,a=i/n;a<0&&(a=0),a=Math.min(a,1);var r=this.easingFunc,s=r?r(a):a;if(this.onframe(s),1===a){if(!this.loop)return!0;var o=i%n;this._startTime=e-o,this._pausedTime=0,this.onrestart()}return!1}this._pausedTime+=t},e.prototype.pause=function(){this._paused=!0},e.prototype.resume=function(){this._paused=!1},e.prototype.setEasing=function(e){this.easing=e,this.easingFunc=ZC(e)?e:bT[e]||HT(e)},e}(),GT=function(){return function(e){this.value=e}}(),QT=function(){function e(){this._len=0}return e.prototype.insert=function(e){var t=new GT(e);return this.insertEntry(t),t},e.prototype.insertEntry=function(e){this.head?(this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e):this.head=this.tail=e,this._len++},e.prototype.remove=function(e){var t=e.prev,n=e.next;t?t.next=n:this.head=n,n?n.prev=t:this.tail=t,e.next=e.prev=null,this._len--},e.prototype.len=function(){return this._len},e.prototype.clear=function(){this.head=this.tail=null,this._len=0},e}(),KT=function(){function e(e){this._list=new QT,this._maxSize=10,this._map={},this._maxSize=e}return e.prototype.put=function(e,t){var n=this._list,i=this._map,a=null;if(null==i[e]){var r=n.len(),s=this._lastRemovedEntry;if(r>=this._maxSize&&r>0){var o=n.head;n.remove(o),delete i[o.key],a=o.value,this._lastRemovedEntry=o}s?s.value=t:s=new GT(t),s.key=e,n.insertEntry(s),i[e]=s}return a},e.prototype.get=function(e){var t=this._map[e],n=this._list;if(null!=t)return t!==n.tail&&(n.remove(t),n.insertEntry(t)),t.value},e.prototype.clear=function(){this._list.clear(),this._map={}},e.prototype.len=function(){return this._list.len()},e}(),ZT={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function YT(e){return(e=Math.round(e))<0?0:e>255?255:e}function XT(e){return e<0?0:e>1?1:e}function JT(e){var t=e;return t.length&&"%"===t.charAt(t.length-1)?YT(parseFloat(t)/100*255):YT(parseInt(t,10))}function eM(e){var t=e;return t.length&&"%"===t.charAt(t.length-1)?XT(parseFloat(t)/100):XT(parseFloat(t))}function tM(e,t,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?e+(t-e)*n*6:2*n<1?t:3*n<2?e+(t-e)*(2/3-n)*6:e}function nM(e,t,n){return e+(t-e)*n}function iM(e,t,n,i,a){return e[0]=t,e[1]=n,e[2]=i,e[3]=a,e}function aM(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}var rM=new KT(20),sM=null;function oM(e,t){sM&&aM(sM,t),sM=rM.put(e,sM||t.slice())}function lM(e,t){if(e){t=t||[];var n=rM.get(e);if(n)return aM(t,n);var i=(e+="").replace(/ /g,"").toLowerCase();if(i in ZT)return aM(t,ZT[i]),oM(e,t),t;var a,r=i.length;if("#"===i.charAt(0))return 4===r||5===r?(a=parseInt(i.slice(1,4),16))>=0&&a<=4095?(iM(t,(3840&a)>>4|(3840&a)>>8,240&a|(240&a)>>4,15&a|(15&a)<<4,5===r?parseInt(i.slice(4),16)/15:1),oM(e,t),t):void iM(t,0,0,0,1):7===r||9===r?(a=parseInt(i.slice(1,7),16))>=0&&a<=16777215?(iM(t,(16711680&a)>>16,(65280&a)>>8,255&a,9===r?parseInt(i.slice(7),16)/255:1),oM(e,t),t):void iM(t,0,0,0,1):void 0;var s=i.indexOf("("),o=i.indexOf(")");if(-1!==s&&o+1===r){var l=i.substr(0,s),c=i.substr(s+1,o-(s+1)).split(","),d=1;switch(l){case"rgba":if(4!==c.length)return 3===c.length?iM(t,+c[0],+c[1],+c[2],1):iM(t,0,0,0,1);d=eM(c.pop());case"rgb":return c.length>=3?(iM(t,JT(c[0]),JT(c[1]),JT(c[2]),3===c.length?d:eM(c[3])),oM(e,t),t):void iM(t,0,0,0,1);case"hsla":return 4!==c.length?void iM(t,0,0,0,1):(c[3]=eM(c[3]),cM(c,t),oM(e,t),t);case"hsl":return 3!==c.length?void iM(t,0,0,0,1):(cM(c,t),oM(e,t),t);default:return}}iM(t,0,0,0,1)}}function cM(e,t){var n=(parseFloat(e[0])%360+360)%360/360,i=eM(e[1]),a=eM(e[2]),r=a<=.5?a*(i+1):a+i-a*i,s=2*a-r;return iM(t=t||[],YT(255*tM(s,r,n+1/3)),YT(255*tM(s,r,n)),YT(255*tM(s,r,n-1/3)),1),4===e.length&&(t[3]=e[3]),t}function dM(e,t){var n=lM(e);if(n){for(var i=0;i<3;i++)n[i]=t<0?n[i]*(1-t)|0:(255-n[i])*t+n[i]|0,n[i]>255?n[i]=255:n[i]<0&&(n[i]=0);return mM(n,4===n.length?"rgba":"rgb")}}function uM(e,t,n){if(t&&t.length&&e>=0&&e<=1){n=n||[];var i=e*(t.length-1),a=Math.floor(i),r=Math.ceil(i),s=t[a],o=t[r],l=i-a;return n[0]=YT(nM(s[0],o[0],l)),n[1]=YT(nM(s[1],o[1],l)),n[2]=YT(nM(s[2],o[2],l)),n[3]=XT(nM(s[3],o[3],l)),n}}var hM=uM;function pM(e,t,n){if(t&&t.length&&e>=0&&e<=1){var i=e*(t.length-1),a=Math.floor(i),r=Math.ceil(i),s=lM(t[a]),o=lM(t[r]),l=i-a,c=mM([YT(nM(s[0],o[0],l)),YT(nM(s[1],o[1],l)),YT(nM(s[2],o[2],l)),XT(nM(s[3],o[3],l))],"rgba");return n?{color:c,leftIndex:a,rightIndex:r,value:i}:c}}var gM=pM;function vM(e,t,n,i){var a=lM(e);if(e)return a=function(e){if(e){var t,n,i=e[0]/255,a=e[1]/255,r=e[2]/255,s=Math.min(i,a,r),o=Math.max(i,a,r),l=o-s,c=(o+s)/2;if(0===l)t=0,n=0;else{n=c<.5?l/(o+s):l/(2-o-s);var d=((o-i)/6+l/2)/l,u=((o-a)/6+l/2)/l,h=((o-r)/6+l/2)/l;i===o?t=h-u:a===o?t=1/3+d-h:r===o&&(t=2/3+u-d),t<0&&(t+=1),t>1&&(t-=1)}var p=[360*t,n,c];return null!=e[3]&&p.push(e[3]),p}}(a),null!=t&&(a[0]=function(e){return(e=Math.round(e))<0?0:e>360?360:e}(ZC(t)?t(a[0]):t)),null!=n&&(a[1]=eM(ZC(n)?n(a[1]):n)),null!=i&&(a[2]=eM(ZC(i)?i(a[2]):i)),mM(cM(a),"rgba")}function fM(e,t){var n=lM(e);if(n&&null!=t)return n[3]=XT(t),mM(n,"rgba")}function mM(e,t){if(e&&e.length){var n=e[0]+","+e[1]+","+e[2];return"rgba"!==t&&"hsva"!==t&&"hsla"!==t||(n+=","+e[3]),t+"("+n+")"}}function yM(e,t){var n=lM(e);return n?(.299*n[0]+.587*n[1]+.114*n[2])*n[3]/255+(1-n[3])*t:0}var bM=new KT(100);function wM(e){if(YC(e)){var t=bM.get(e);return t||(t=dM(e,-.1),bM.put(e,t)),t}if(aI(e)){var n=RC({},e);return n.colorStops=UC(e.colorStops,function(e){return{offset:e.offset,color:dM(e.color,-.1)}}),n}return e}const kM=Object.freeze(Object.defineProperty({__proto__:null,fastLerp:uM,fastMapToColor:hM,lerp:pM,lift:dM,liftColor:wM,lum:yM,mapToColor:gM,modifyAlpha:fM,modifyHSL:vM,parse:lM,parseCssFloat:eM,parseCssInt:JT,random:function(){return mM([Math.round(255*Math.random()),Math.round(255*Math.random()),Math.round(255*Math.random())],"rgb")},stringify:mM,toHex:function(e){var t=lM(e);if(t)return((1<<24)+(t[0]<<16)+(t[1]<<8)+ +t[2]).toString(16).slice(1)}},Symbol.toStringTag,{value:"Module"}));pC.hasGlobalWindow&&ZC(window.btoa);var SM=Array.prototype.slice;function xM(e,t,n){return(t-e)*n+e}function _M(e,t,n,i){for(var a=t.length,r=0;r<a;r++)e[r]=xM(t[r],n[r],i);return e}function CM(e,t,n,i){for(var a=t.length,r=0;r<a;r++)e[r]=t[r]+n[r]*i;return e}function IM(e,t,n,i){for(var a=t.length,r=a&&t[0].length,s=0;s<a;s++){e[s]||(e[s]=[]);for(var o=0;o<r;o++)e[s][o]=t[s][o]+n[s][o]*i}return e}function DM(e,t){for(var n=e.length,i=t.length,a=n>i?t:e,r=Math.min(n,i),s=a[r-1]||{color:[0,0,0,0],offset:0},o=r;o<Math.max(n,i);o++)a.push({offset:s.offset,color:s.color.slice()})}function TM(e,t,n){var i=e,a=t;if(i.push&&a.push){var r=i.length,s=a.length;if(r!==s)if(r>s)i.length=s;else for(var o=r;o<s;o++)i.push(1===n?a[o]:SM.call(a[o]));var l=i[0]&&i[0].length;for(o=0;o<i.length;o++)if(1===n)isNaN(i[o])&&(i[o]=a[o]);else for(var c=0;c<l;c++)isNaN(i[o][c])&&(i[o][c]=a[o][c])}}function MM(e){if(BC(e)){var t=e.length;if(BC(e[0])){for(var n=[],i=0;i<t;i++)n.push(SM.call(e[i]));return n}return SM.call(e)}return e}function AM(e){return e[0]=Math.floor(e[0])||0,e[1]=Math.floor(e[1])||0,e[2]=Math.floor(e[2])||0,e[3]=null==e[3]?1:e[3],"rgba("+e.join(",")+")"}function EM(e){return 4===e||5===e}function zM(e){return 1===e||2===e}var PM=[0,0,0,0],RM=function(){function e(e){this.keyframes=[],this.discrete=!1,this._invalid=!1,this._needsSort=!1,this._lastFr=0,this._lastFrP=0,this.propName=e}return e.prototype.isFinished=function(){return this._finished},e.prototype.setFinished=function(){this._finished=!0,this._additiveTrack&&this._additiveTrack.setFinished()},e.prototype.needsAnimate=function(){return this.keyframes.length>=1},e.prototype.getAdditiveTrack=function(){return this._additiveTrack},e.prototype.addKeyframe=function(e,t,n){this._needsSort=!0;var i=this.keyframes,a=i.length,r=!1,s=6,o=t;if(BC(t)){var l=function(e){return BC(e&&e[0])?2:1}(t);s=l,(1===l&&!JC(t[0])||2===l&&!JC(t[0][0]))&&(r=!0)}else if(JC(t)&&!oI(t))s=0;else if(YC(t))if(isNaN(+t)){var c=lM(t);c&&(o=c,s=3)}else s=0;else if(aI(t)){var d=RC({},o);d.colorStops=UC(t.colorStops,function(e){return{offset:e.offset,color:lM(e.color)}}),"linear"===t.type?s=4:function(e){return"radial"===e.type}(t)&&(s=5),o=d}0===a?this.valType=s:s===this.valType&&6!==s||(r=!0),this.discrete=this.discrete||r;var u={time:e,value:o,rawValue:t,percent:0};return n&&(u.easing=n,u.easingFunc=ZC(n)?n:bT[n]||HT(n)),i.push(u),u},e.prototype.prepare=function(e,t){var n=this.keyframes;this._needsSort&&n.sort(function(e,t){return e.time-t.time});for(var i=this.valType,a=n.length,r=n[a-1],s=this.discrete,o=zM(i),l=EM(i),c=0;c<a;c++){var d=n[c],u=d.value,h=r.value;d.percent=d.time/e,s||(o&&c!==a-1?TM(u,h,i):l&&DM(u.colorStops,h.colorStops))}if(!s&&5!==i&&t&&this.needsAnimate()&&t.needsAnimate()&&i===t.valType&&!t._finished){this._additiveTrack=t;var p=n[0].value;for(c=0;c<a;c++)0===i?n[c].additiveValue=n[c].value-p:3===i?n[c].additiveValue=CM([],n[c].value,p,-1):zM(i)&&(n[c].additiveValue=1===i?CM([],n[c].value,p,-1):IM([],n[c].value,p,-1))}},e.prototype.step=function(e,t){if(!this._finished){this._additiveTrack&&this._additiveTrack._finished&&(this._additiveTrack=null);var n,i,a,r=null!=this._additiveTrack,s=r?"additiveValue":"value",o=this.valType,l=this.keyframes,c=l.length,d=this.propName,u=3===o,h=this._lastFr,p=Math.min;if(1===c)i=a=l[0];else{if(t<0)n=0;else if(t<this._lastFrP){for(n=p(h+1,c-1);n>=0&&!(l[n].percent<=t);n--);n=p(n,c-2)}else{for(n=h;n<c&&!(l[n].percent>t);n++);n=p(n-1,c-2)}a=l[n+1],i=l[n]}if(i&&a){this._lastFr=n,this._lastFrP=t;var g=a.percent-i.percent,v=0===g?1:p((t-i.percent)/g,1);a.easingFunc&&(v=a.easingFunc(v));var f=r?this._additiveValue:u?PM:e[d];if(!zM(o)&&!u||f||(f=this._additiveValue=[]),this.discrete)e[d]=v<1?i.rawValue:a.rawValue;else if(zM(o))1===o?_M(f,i[s],a[s],v):function(e,t,n,i){for(var a=t.length,r=a&&t[0].length,s=0;s<a;s++){e[s]||(e[s]=[]);for(var o=0;o<r;o++)e[s][o]=xM(t[s][o],n[s][o],i)}}(f,i[s],a[s],v);else if(EM(o)){var m=i[s],y=a[s],b=4===o;e[d]={type:b?"linear":"radial",x:xM(m.x,y.x,v),y:xM(m.y,y.y,v),colorStops:UC(m.colorStops,function(e,t){var n=y.colorStops[t];return{offset:xM(e.offset,n.offset,v),color:AM(_M([],e.color,n.color,v))}}),global:y.global},b?(e[d].x2=xM(m.x2,y.x2,v),e[d].y2=xM(m.y2,y.y2,v)):e[d].r=xM(m.r,y.r,v)}else if(u)_M(f,i[s],a[s],v),r||(e[d]=AM(f));else{var w=xM(i[s],a[s],v);r?this._additiveValue=w:e[d]=w}r&&this._addToTarget(e)}}},e.prototype._addToTarget=function(e){var t=this.valType,n=this.propName,i=this._additiveValue;0===t?e[n]=e[n]+i:3===t?(lM(e[n],PM),CM(PM,PM,i,1),e[n]=AM(PM)):1===t?CM(e[n],e[n],i,1):2===t&&IM(e[n],e[n],i,1)},e}(),$M=function(){function e(e,t,n,i){this._tracks={},this._trackKeys=[],this._maxTime=0,this._started=0,this._clip=null,this._target=e,this._loop=t,t&&i?EC("Can' use additive animation on looped animation."):(this._additiveAnimators=i,this._allowDiscrete=n)}return e.prototype.getMaxTime=function(){return this._maxTime},e.prototype.getDelay=function(){return this._delay},e.prototype.getLoop=function(){return this._loop},e.prototype.getTarget=function(){return this._target},e.prototype.changeTarget=function(e){this._target=e},e.prototype.when=function(e,t,n){return this.whenWithKeys(e,t,WC(t),n)},e.prototype.whenWithKeys=function(e,t,n,i){for(var a=this._tracks,r=0;r<n.length;r++){var s=n[r],o=a[s];if(!o){o=a[s]=new RM(s);var l=void 0,c=this._getAdditiveTrack(s);if(c){var d=c.keyframes,u=d[d.length-1];l=u&&u.value,3===c.valType&&l&&(l=AM(l))}else l=this._target[s];if(null==l)continue;e>0&&o.addKeyframe(0,MM(l),i),this._trackKeys.push(s)}o.addKeyframe(e,MM(t[s]),i)}return this._maxTime=Math.max(this._maxTime,e),this},e.prototype.pause=function(){this._clip.pause(),this._paused=!0},e.prototype.resume=function(){this._clip.resume(),this._paused=!1},e.prototype.isPaused=function(){return!!this._paused},e.prototype.duration=function(e){return this._maxTime=e,this._force=!0,this},e.prototype._doneCallback=function(){this._setTracksFinished(),this._clip=null;var e=this._doneCbs;if(e)for(var t=e.length,n=0;n<t;n++)e[n].call(this)},e.prototype._abortedCallback=function(){this._setTracksFinished();var e=this.animation,t=this._abortedCbs;if(e&&e.removeClip(this._clip),this._clip=null,t)for(var n=0;n<t.length;n++)t[n].call(this)},e.prototype._setTracksFinished=function(){for(var e=this._tracks,t=this._trackKeys,n=0;n<t.length;n++)e[t[n]].setFinished()},e.prototype._getAdditiveTrack=function(e){var t,n=this._additiveAnimators;if(n)for(var i=0;i<n.length;i++){var a=n[i].getTrack(e);a&&(t=a)}return t},e.prototype.start=function(e){if(!(this._started>0)){this._started=1;for(var t=this,n=[],i=this._maxTime||0,a=0;a<this._trackKeys.length;a++){var r=this._trackKeys[a],s=this._tracks[r],o=this._getAdditiveTrack(r),l=s.keyframes,c=l.length;if(s.prepare(i,o),s.needsAnimate())if(!this._allowDiscrete&&s.discrete){var d=l[c-1];d&&(t._target[s.propName]=d.rawValue),s.setFinished()}else n.push(s)}if(n.length||this._force){var u=new WT({life:i,loop:this._loop,delay:this._delay||0,onframe:function(e){t._started=2;var i=t._additiveAnimators;if(i){for(var a=!1,r=0;r<i.length;r++)if(i[r]._clip){a=!0;break}a||(t._additiveAnimators=null)}for(r=0;r<n.length;r++)n[r].step(t._target,e);var s=t._onframeCbs;if(s)for(r=0;r<s.length;r++)s[r](t._target,e)},ondestroy:function(){t._doneCallback()}});this._clip=u,this.animation&&this.animation.addClip(u),e&&u.setEasing(e)}else this._doneCallback();return this}},e.prototype.stop=function(e){if(this._clip){var t=this._clip;e&&t.onframe(1),this._abortedCallback()}},e.prototype.delay=function(e){return this._delay=e,this},e.prototype.during=function(e){return e&&(this._onframeCbs||(this._onframeCbs=[]),this._onframeCbs.push(e)),this},e.prototype.done=function(e){return e&&(this._doneCbs||(this._doneCbs=[]),this._doneCbs.push(e)),this},e.prototype.aborted=function(e){return e&&(this._abortedCbs||(this._abortedCbs=[]),this._abortedCbs.push(e)),this},e.prototype.getClip=function(){return this._clip},e.prototype.getTrack=function(e){return this._tracks[e]},e.prototype.getTracks=function(){var e=this;return UC(this._trackKeys,function(t){return e._tracks[t]})},e.prototype.stopTracks=function(e,t){if(!e.length||!this._clip)return!0;for(var n=this._tracks,i=this._trackKeys,a=0;a<e.length;a++){var r=n[e[a]];r&&!r.isFinished()&&(t?r.step(this._target,1):1===this._started&&r.step(this._target,0),r.setFinished())}var s=!0;for(a=0;a<i.length;a++)if(!n[i[a]].isFinished()){s=!1;break}return s&&this._abortedCallback(),s},e.prototype.saveTo=function(e,t,n){if(e){t=t||this._trackKeys;for(var i=0;i<t.length;i++){var a=t[i],r=this._tracks[a];if(r&&!r.isFinished()){var s=r.keyframes,o=s[n?0:s.length-1];o&&(e[a]=MM(o.rawValue))}}}},e.prototype.__changeFinalValue=function(e,t){t=t||WC(e);for(var n=0;n<t.length;n++){var i=t[n],a=this._tracks[i];if(a){var r=a.keyframes;if(r.length>1){var s=r.pop();a.addKeyframe(s.time,e[i]),a.prepare(this._maxTime,a.getAdditiveTrack())}}}},e}();function OM(){return(new Date).getTime()}var LM,NM,FM=function(e){function t(t){var n=e.call(this)||this;return n._running=!1,n._time=0,n._pausedTime=0,n._pauseStart=0,n._paused=!1,t=t||{},n.stage=t.stage||{},n}return EI(t,e),t.prototype.addClip=function(e){e.animation&&this.removeClip(e),this._head?(this._tail.next=e,e.prev=this._tail,e.next=null,this._tail=e):this._head=this._tail=e,e.animation=this},t.prototype.addAnimator=function(e){e.animation=this;var t=e.getClip();t&&this.addClip(t)},t.prototype.removeClip=function(e){if(e.animation){var t=e.prev,n=e.next;t?t.next=n:this._head=n,n?n.prev=t:this._tail=t,e.next=e.prev=e.animation=null}},t.prototype.removeAnimator=function(e){var t=e.getClip();t&&this.removeClip(t),e.animation=null},t.prototype.update=function(e){for(var t=OM()-this._pausedTime,n=t-this._time,i=this._head;i;){var a=i.next;i.step(t,n)?(i.ondestroy(),this.removeClip(i),i=a):i=a}this._time=t,e||(this.trigger("frame",n),this.stage.update&&this.stage.update())},t.prototype._startLoop=function(){var e=this;this._running=!0,mT(function t(){e._running&&(mT(t),!e._paused&&e.update())})},t.prototype.start=function(){this._running||(this._time=OM(),this._pausedTime=0,this._startLoop())},t.prototype.stop=function(){this._running=!1},t.prototype.pause=function(){this._paused||(this._pauseStart=OM(),this._paused=!0)},t.prototype.resume=function(){this._paused&&(this._pausedTime+=OM()-this._pauseStart,this._paused=!1)},t.prototype.clear=function(){for(var e=this._head;e;){var t=e.next;e.prev=e.next=e.animation=null,e=t}this._head=this._tail=null},t.prototype.isFinished=function(){return null==this._head},t.prototype.animate=function(e,t){t=t||{},this.start();var n=new $M(e,t.loop);return this.addAnimator(n),n},t}(JI),BM=pC.domSupported,jM=(NM={pointerdown:1,pointerup:1,pointermove:1,pointerout:1},{mouse:LM=["click","dblclick","mousewheel","wheel","mouseout","mouseup","mousedown","mousemove","contextmenu"],touch:["touchstart","touchend","touchmove"],pointer:UC(LM,function(e){var t=e.replace("mouse","pointer");return NM.hasOwnProperty(t)?t:e})}),UM=["mousemove","mouseup"],VM=["pointermove","pointerup"],qM=!1;function HM(e){var t=e.pointerType;return"pen"===t||"touch"===t}function WM(e){e&&(e.zrByTouch=!0)}function GM(e,t){for(var n=t,i=!1;n&&9!==n.nodeType&&!(i=n.domBelongToZr||n!==t&&n===e.painterRoot);)n=n.parentNode;return i}var QM=function(){return function(e,t){this.stopPropagation=II,this.stopImmediatePropagation=II,this.preventDefault=II,this.type=t.type,this.target=this.currentTarget=e.dom,this.pointerType=t.pointerType,this.clientX=t.clientX,this.clientY=t.clientY}}(),KM={mousedown:function(e){e=fD(this.dom,e),this.__mayPointerCapture=[e.zrX,e.zrY],this.trigger("mousedown",e)},mousemove:function(e){e=fD(this.dom,e);var t=this.__mayPointerCapture;!t||e.zrX===t[0]&&e.zrY===t[1]||this.__togglePointerCapture(!0),this.trigger("mousemove",e)},mouseup:function(e){e=fD(this.dom,e),this.__togglePointerCapture(!1),this.trigger("mouseup",e)},mouseout:function(e){GM(this,(e=fD(this.dom,e)).toElement||e.relatedTarget)||(this.__pointerCapturing&&(e.zrEventControl="no_globalout"),this.trigger("mouseout",e))},wheel:function(e){qM=!0,e=fD(this.dom,e),this.trigger("mousewheel",e)},mousewheel:function(e){qM||(e=fD(this.dom,e),this.trigger("mousewheel",e))},touchstart:function(e){WM(e=fD(this.dom,e)),this.__lastTouchMoment=new Date,this.handler.processGesture(e,"start"),KM.mousemove.call(this,e),KM.mousedown.call(this,e)},touchmove:function(e){WM(e=fD(this.dom,e)),this.handler.processGesture(e,"change"),KM.mousemove.call(this,e)},touchend:function(e){WM(e=fD(this.dom,e)),this.handler.processGesture(e,"end"),KM.mouseup.call(this,e),+new Date-+this.__lastTouchMoment<300&&KM.click.call(this,e)},pointerdown:function(e){KM.mousedown.call(this,e)},pointermove:function(e){HM(e)||KM.mousemove.call(this,e)},pointerup:function(e){KM.mouseup.call(this,e)},pointerout:function(e){HM(e)||KM.mouseout.call(this,e)}};jC(["click","dblclick","contextmenu"],function(e){KM[e]=function(t){t=fD(this.dom,t),this.trigger(e,t)}});var ZM={pointermove:function(e){HM(e)||ZM.mousemove.call(this,e)},pointerup:function(e){ZM.mouseup.call(this,e)},mousemove:function(e){this.trigger("mousemove",e)},mouseup:function(e){var t=this.__pointerCapturing;this.__togglePointerCapture(!1),this.trigger("mouseup",e),t&&(e.zrEventControl="only_globalout",this.trigger("mouseout",e))}};function YM(e,t){var n=t.domHandlers;pC.pointerEventsSupported?jC(jM.pointer,function(i){JM(t,i,function(t){n[i].call(e,t)})}):(pC.touchEventsSupported&&jC(jM.touch,function(i){JM(t,i,function(a){n[i].call(e,a),function(e){e.touching=!0,null!=e.touchTimer&&(clearTimeout(e.touchTimer),e.touchTimer=null),e.touchTimer=setTimeout(function(){e.touching=!1,e.touchTimer=null},700)}(t)})}),jC(jM.mouse,function(i){JM(t,i,function(a){a=vD(a),t.touching||n[i].call(e,a)})}))}function XM(e,t){function n(n){JM(t,n,function(i){i=vD(i),GM(e,i.target)||(i=function(e,t){return fD(e.dom,new QM(e,t),!0)}(e,i),t.domHandlers[n].call(e,i))},{capture:!0})}pC.pointerEventsSupported?jC(VM,n):pC.touchEventsSupported||jC(UM,n)}function JM(e,t,n,i){e.mounted[t]=n,e.listenerOpts[t]=i,mD(e.domTarget,t,n,i)}function eA(e){var t=e.mounted;for(var n in t)t.hasOwnProperty(n)&&yD(e.domTarget,n,t[n],e.listenerOpts[n]);e.mounted={}}var tA=function(){return function(e,t){this.mounted={},this.listenerOpts={},this.touching=!1,this.domTarget=e,this.domHandlers=t}}(),nA=function(e){function t(t,n){var i=e.call(this)||this;return i.__pointerCapturing=!1,i.dom=t,i.painterRoot=n,i._localHandlerScope=new tA(t,KM),BM&&(i._globalHandlerScope=new tA(document,ZM)),YM(i,i._localHandlerScope),i}return EI(t,e),t.prototype.dispose=function(){eA(this._localHandlerScope),BM&&eA(this._globalHandlerScope)},t.prototype.setCursor=function(e){this.dom.style&&(this.dom.style.cursor=e||"default")},t.prototype.__togglePointerCapture=function(e){if(this.__mayPointerCapture=null,BM&&+this.__pointerCapturing^+e){this.__pointerCapturing=e;var t=this._globalHandlerScope;e?XM(this,t):eA(t)}},t}(JI),iA=1;pC.hasGlobalWindow&&(iA=Math.max(window.devicePixelRatio||window.screen&&window.screen.deviceXDPI/window.screen.logicalXDPI||1,1));var aA=iA,rA="#333",sA="#ccc",oA=CD,lA=5e-5;function cA(e){return e>lA||e<-5e-5}var dA,uA=[],hA=[],pA=[1,0,0,1,0,0],gA=Math.abs,vA=function(){function e(){}var t;return e.prototype.getLocalTransform=function(t){return e.getLocalTransform(this,t)},e.prototype.setPosition=function(e){this.x=e[0],this.y=e[1]},e.prototype.setScale=function(e){this.scaleX=e[0],this.scaleY=e[1]},e.prototype.setSkew=function(e){this.skewX=e[0],this.skewY=e[1]},e.prototype.setOrigin=function(e){this.originX=e[0],this.originY=e[1]},e.prototype.needLocalTransform=function(){return cA(this.rotation)||cA(this.x)||cA(this.y)||cA(this.scaleX-1)||cA(this.scaleY-1)||cA(this.skewX)||cA(this.skewY)},e.prototype.updateTransform=function(){var e=this.parent&&this.parent.transform,t=this.needLocalTransform(),n=this.transform;t||e?(n=n||[1,0,0,1,0,0],t?this.getLocalTransform(n):oA(n),e&&(t?DD(n,e,n):ID(n,e)),this.transform=n,this._resolveGlobalScaleRatio(n)):n&&(oA(n),this.invTransform=null)},e.prototype._resolveGlobalScaleRatio=function(e){var t=this.globalScaleRatio;if(null!=t&&1!==t){this.getGlobalScale(uA);var n=uA[0]<0?-1:1,i=uA[1]<0?-1:1,a=((uA[0]-n)*t+n)/uA[0]||0,r=((uA[1]-i)*t+i)/uA[1]||0;e[0]*=a,e[1]*=a,e[2]*=r,e[3]*=r}this.invTransform=this.invTransform||[1,0,0,1,0,0],ED(this.invTransform,e)},e.prototype.getComputedTransform=function(){for(var e=this,t=[];e;)t.push(e),e=e.parent;for(;e=t.pop();)e.updateTransform();return this.transform},e.prototype.setLocalTransform=function(e){if(e){var t=e[0]*e[0]+e[1]*e[1],n=e[2]*e[2]+e[3]*e[3],i=Math.atan2(e[1],e[0]),a=Math.PI/2+i-Math.atan2(e[3],e[2]);n=Math.sqrt(n)*Math.cos(a),t=Math.sqrt(t),this.skewX=a,this.skewY=0,this.rotation=-i,this.x=+e[4],this.y=+e[5],this.scaleX=t,this.scaleY=n,this.originX=0,this.originY=0}},e.prototype.decomposeTransform=function(){if(this.transform){var e=this.parent,t=this.transform;e&&e.transform&&(e.invTransform=e.invTransform||[1,0,0,1,0,0],DD(hA,e.invTransform,t),t=hA);var n=this.originX,i=this.originY;(n||i)&&(pA[4]=n,pA[5]=i,DD(hA,t,pA),hA[4]-=n,hA[5]-=i,t=hA),this.setLocalTransform(t)}},e.prototype.getGlobalScale=function(e){var t=this.transform;return e=e||[],t?(e[0]=Math.sqrt(t[0]*t[0]+t[1]*t[1]),e[1]=Math.sqrt(t[2]*t[2]+t[3]*t[3]),t[0]<0&&(e[0]=-e[0]),t[3]<0&&(e[1]=-e[1]),e):(e[0]=1,e[1]=1,e)},e.prototype.transformCoordToLocal=function(e,t){var n=[e,t],i=this.invTransform;return i&&GI(n,n,i),n},e.prototype.transformCoordToGlobal=function(e,t){var n=[e,t],i=this.transform;return i&&GI(n,n,i),n},e.prototype.getLineScale=function(){var e=this.transform;return e&&gA(e[0]-1)>1e-10&&gA(e[3]-1)>1e-10?Math.sqrt(gA(e[0]*e[3]-e[2]*e[1])):1},e.prototype.copyTransform=function(e){mA(this,e)},e.getLocalTransform=function(e,t){t=t||[];var n=e.originX||0,i=e.originY||0,a=e.scaleX,r=e.scaleY,s=e.anchorX,o=e.anchorY,l=e.rotation||0,c=e.x,d=e.y,u=e.skewX?Math.tan(e.skewX):0,h=e.skewY?Math.tan(-e.skewY):0;if(n||i||s||o){var p=n+s,g=i+o;t[4]=-p*a-u*g*r,t[5]=-g*r-h*p*a}else t[4]=t[5]=0;return t[0]=a,t[3]=r,t[1]=h*a,t[2]=u*r,l&&MD(t,t,l),t[4]+=n+c,t[5]+=i+d,t},e.initDefaultProps=((t=e.prototype).scaleX=t.scaleY=t.globalScaleRatio=1,void(t.x=t.y=t.originX=t.originY=t.skewX=t.skewY=t.rotation=t.anchorX=t.anchorY=0)),e}(),fA=["x","y","originX","originY","anchorX","anchorY","rotation","scaleX","scaleY","skewX","skewY"];function mA(e,t){for(var n=0;n<fA.length;n++){var i=fA[n];e[i]=t[i]}}function yA(e){dA||(dA=new KT(100)),e=e||gC;var t=dA.get(e);return t||(t={font:e,strWidthCache:new KT(500),asciiWidthMap:null,asciiWidthMapTried:!1,stWideCharWidth:fC.measureText("国",e).width,asciiCharWidth:fC.measureText("a",e).width},dA.put(e,t)),t}var bA=0,wA=5;function kA(e,t){return e.asciiWidthMapTried||(e.asciiWidthMap=function(e){if(!(bA>=wA)){e=e||gC;for(var t=[],n=+new Date,i=0;i<=127;i++)t[i]=fC.measureText(String.fromCharCode(i),e).width;var a=+new Date-n;return a>16?bA=wA:a>2&&bA++,t}}(e.font),e.asciiWidthMapTried=!0),0<=t&&t<=127?null!=e.asciiWidthMap?e.asciiWidthMap[t]:e.asciiCharWidth:e.stWideCharWidth}function SA(e,t){var n=e.strWidthCache,i=n.get(t);return null==i&&(i=fC.measureText(t,e.font).width,n.put(t,i)),i}function xA(e,t,n,i){var a=SA(yA(t),e),r=DA(t),s=CA(0,a,n),o=IA(0,r,i);return new GD(s,o,a,r)}function _A(e,t,n,i){var a=((e||"")+"").split("\n");if(1===a.length)return xA(a[0],t,n,i);for(var r=new GD(0,0,0,0),s=0;s<a.length;s++){var o=xA(a[s],t,n,i);0===s?r.copy(o):r.union(o)}return r}function CA(e,t,n,i){return"right"===n?i?e+=t:e-=t:"center"===n&&(i?e+=t/2:e-=t/2),e}function IA(e,t,n,i){return"middle"===n?i?e+=t/2:e-=t/2:"bottom"===n&&(i?e+=t:e-=t),e}function DA(e){return yA(e).stWideCharWidth}function TA(e,t){return"string"==typeof e?e.lastIndexOf("%")>=0?parseFloat(e)/100*t:parseFloat(e):e}function MA(e,t,n){var i=t.position||"inside",a=null!=t.distance?t.distance:5,r=n.height,s=n.width,o=r/2,l=n.x,c=n.y,d="left",u="top";if(i instanceof Array)l+=TA(i[0],n.width),c+=TA(i[1],n.height),d=null,u=null;else switch(i){case"left":l-=a,c+=o,d="right",u="middle";break;case"right":l+=a+s,c+=o,u="middle";break;case"top":l+=s/2,c-=a,d="center",u="bottom";break;case"bottom":l+=s/2,c+=r+a,d="center";break;case"inside":l+=s/2,c+=o,d="center",u="middle";break;case"insideLeft":l+=a,c+=o,u="middle";break;case"insideRight":l+=s-a,c+=o,d="right",u="middle";break;case"insideTop":l+=s/2,c+=a,d="center";break;case"insideBottom":l+=s/2,c+=r-a,d="center",u="bottom";break;case"insideTopLeft":l+=a,c+=a;break;case"insideTopRight":l+=s-a,c+=a,d="right";break;case"insideBottomLeft":l+=a,c+=r-a,u="bottom";break;case"insideBottomRight":l+=s-a,c+=r-a,d="right",u="bottom"}return(e=e||{}).x=l,e.y=c,e.align=d,e.verticalAlign=u,e}var AA="__zr_normal__",EA=fA.concat(["ignore"]),zA=VC(fA,function(e,t){return e[t]=!0,e},{ignore:!1}),PA={},RA=new GD(0,0,0,0),$A=[],OA=function(){function e(e){this.id=AC(),this.animators=[],this.currentStates=[],this.states={},this._init(e)}return e.prototype._init=function(e){this.attr(e)},e.prototype.drift=function(e,t,n){switch(this.draggable){case"horizontal":t=0;break;case"vertical":e=0}var i=this.transform;i||(i=this.transform=[1,0,0,1,0,0]),i[4]+=e,i[5]+=t,this.decomposeTransform(),this.markRedraw()},e.prototype.beforeUpdate=function(){},e.prototype.afterUpdate=function(){},e.prototype.update=function(){this.updateTransform(),this.__dirty&&this.updateInnerText()},e.prototype.updateInnerText=function(e){var t=this._textContent;if(t&&(!t.ignore||e)){this.textConfig||(this.textConfig={});var n=this.textConfig,i=n.local,a=t.innerTransformable,r=void 0,s=void 0,o=!1;a.parent=i?this:null;var l=!1;a.copyTransform(t);var c=null!=n.position,d=n.autoOverflowArea,u=void 0;if((d||c)&&(u=RA,n.layoutRect?u.copy(n.layoutRect):u.copy(this.getBoundingRect()),i||u.applyTransform(this.transform)),c){this.calculateTextPosition?this.calculateTextPosition(PA,n,u):MA(PA,n,u),a.x=PA.x,a.y=PA.y,r=PA.align,s=PA.verticalAlign;var h=n.origin;if(h&&null!=n.rotation){var p=void 0,g=void 0;"center"===h?(p=.5*u.width,g=.5*u.height):(p=TA(h[0],u.width),g=TA(h[1],u.height)),l=!0,a.originX=-a.x+p+(i?0:u.x),a.originY=-a.y+g+(i?0:u.y)}}null!=n.rotation&&(a.rotation=n.rotation);var v=n.offset;v&&(a.x+=v[0],a.y+=v[1],l||(a.originX=-v[0],a.originY=-v[1]));var f=this._innerTextDefaultStyle||(this._innerTextDefaultStyle={});if(d){var m=f.overflowRect=f.overflowRect||new GD(0,0,0,0);a.getLocalTransform($A),ED($A,$A),GD.copy(m,u),m.applyTransform($A)}else f.overflowRect=null;var y=void 0,b=void 0,w=void 0;(null==n.inside?"string"==typeof n.position&&n.position.indexOf("inside")>=0:n.inside)&&this.canBeInsideText()?(y=n.insideFill,b=n.insideStroke,null!=y&&"auto"!==y||(y=this.getInsideTextFill()),null!=b&&"auto"!==b||(b=this.getInsideTextStroke(y),w=!0)):(y=n.outsideFill,b=n.outsideStroke,null!=y&&"auto"!==y||(y=this.getOutsideFill()),null!=b&&"auto"!==b||(b=this.getOutsideStroke(y),w=!0)),(y=y||"#000")===f.fill&&b===f.stroke&&w===f.autoStroke&&r===f.align&&s===f.verticalAlign||(o=!0,f.fill=y,f.stroke=b,f.autoStroke=w,f.align=r,f.verticalAlign=s,t.setDefaultTextStyle(f)),t.__dirty|=1,o&&t.dirtyStyle(!0)}},e.prototype.canBeInsideText=function(){return!0},e.prototype.getInsideTextFill=function(){return"#fff"},e.prototype.getInsideTextStroke=function(e){return"#000"},e.prototype.getOutsideFill=function(){return this.__zr&&this.__zr.isDarkMode()?sA:rA},e.prototype.getOutsideStroke=function(e){var t=this.__zr&&this.__zr.getBackgroundColor(),n="string"==typeof t&&lM(t);n||(n=[255,255,255,1]);for(var i=n[3],a=this.__zr.isDarkMode(),r=0;r<3;r++)n[r]=n[r]*i+(a?0:255)*(1-i);return n[3]=1,mM(n,"rgba")},e.prototype.traverse=function(e,t){},e.prototype.attrKV=function(e,t){"textConfig"===e?this.setTextConfig(t):"textContent"===e?this.setTextContent(t):"clipPath"===e?this.setClipPath(t):"extra"===e?(this.extra=this.extra||{},RC(this.extra,t)):this[e]=t},e.prototype.hide=function(){this.ignore=!0,this.markRedraw()},e.prototype.show=function(){this.ignore=!1,this.markRedraw()},e.prototype.attr=function(e,t){if("string"==typeof e)this.attrKV(e,t);else if(eI(e))for(var n=WC(e),i=0;i<n.length;i++){var a=n[i];this.attrKV(a,e[a])}return this.markRedraw(),this},e.prototype.saveCurrentToNormalState=function(e){this._innerSaveToNormal(e);for(var t=this._normalState,n=0;n<this.animators.length;n++){var i=this.animators[n],a=i.__fromStateTransition;if(!(i.getLoop()||a&&a!==AA)){var r=i.targetName,s=r?t[r]:t;i.saveTo(s)}}},e.prototype._innerSaveToNormal=function(e){var t=this._normalState;t||(t=this._normalState={}),e.textConfig&&!t.textConfig&&(t.textConfig=this.textConfig),this._savePrimaryToNormal(e,t,EA)},e.prototype._savePrimaryToNormal=function(e,t,n){for(var i=0;i<n.length;i++){var a=n[i];null==e[a]||a in t||(t[a]=this[a])}},e.prototype.hasState=function(){return this.currentStates.length>0},e.prototype.getState=function(e){return this.states[e]},e.prototype.ensureState=function(e){var t=this.states;return t[e]||(t[e]={}),t[e]},e.prototype.clearStates=function(e){this.useState(AA,!1,e)},e.prototype.useState=function(e,t,n,i){var a=e===AA;if(this.hasState()||!a){var r=this.currentStates,s=this.stateTransition;if(!(LC(r,e)>=0)||!t&&1!==r.length){var o;if(this.stateProxy&&!a&&(o=this.stateProxy(e)),o||(o=this.states&&this.states[e]),o||a){a||this.saveCurrentToNormalState(o);var l=!!(o&&o.hoverLayer||i);l&&this._toggleHoverLayerFlag(!0),this._applyStateObj(e,o,this._normalState,t,!n&&!this.__inHover&&s&&s.duration>0,s);var c=this._textContent,d=this._textGuide;return c&&c.useState(e,t,n,l),d&&d.useState(e,t,n,l),a?(this.currentStates=[],this._normalState={}):t?this.currentStates.push(e):this.currentStates=[e],this._updateAnimationTargets(),this.markRedraw(),!l&&this.__inHover&&(this._toggleHoverLayerFlag(!1),this.__dirty&=-2),o}EC("State "+e+" not exists.")}}},e.prototype.useStates=function(e,t,n){if(e.length){var i=[],a=this.currentStates,r=e.length,s=r===a.length;if(s)for(var o=0;o<r;o++)if(e[o]!==a[o]){s=!1;break}if(s)return;for(o=0;o<r;o++){var l=e[o],c=void 0;this.stateProxy&&(c=this.stateProxy(l,e)),c||(c=this.states[l]),c&&i.push(c)}var d=i[r-1],u=!!(d&&d.hoverLayer||n);u&&this._toggleHoverLayerFlag(!0);var h=this._mergeStates(i),p=this.stateTransition;this.saveCurrentToNormalState(h),this._applyStateObj(e.join(","),h,this._normalState,!1,!t&&!this.__inHover&&p&&p.duration>0,p);var g=this._textContent,v=this._textGuide;g&&g.useStates(e,t,u),v&&v.useStates(e,t,u),this._updateAnimationTargets(),this.currentStates=e.slice(),this.markRedraw(),!u&&this.__inHover&&(this._toggleHoverLayerFlag(!1),this.__dirty&=-2)}else this.clearStates()},e.prototype.isSilent=function(){for(var e=this;e;){if(e.silent)return!0;var t=e.__hostTarget;e=t?e.ignoreHostSilent?null:t:e.parent}return!1},e.prototype._updateAnimationTargets=function(){for(var e=0;e<this.animators.length;e++){var t=this.animators[e];t.targetName&&t.changeTarget(this[t.targetName])}},e.prototype.removeState=function(e){var t=LC(this.currentStates,e);if(t>=0){var n=this.currentStates.slice();n.splice(t,1),this.useStates(n)}},e.prototype.replaceState=function(e,t,n){var i=this.currentStates.slice(),a=LC(i,e),r=LC(i,t)>=0;a>=0?r?i.splice(a,1):i[a]=t:n&&!r&&i.push(t),this.useStates(i)},e.prototype.toggleState=function(e,t){t?this.useState(e,!0):this.removeState(e)},e.prototype._mergeStates=function(e){for(var t,n={},i=0;i<e.length;i++){var a=e[i];RC(n,a),a.textConfig&&RC(t=t||{},a.textConfig)}return t&&(n.textConfig=t),n},e.prototype._applyStateObj=function(e,t,n,i,a,r){var s=!(t&&i);t&&t.textConfig?(this.textConfig=RC({},i?this.textConfig:n.textConfig),RC(this.textConfig,t.textConfig)):s&&n.textConfig&&(this.textConfig=n.textConfig);for(var o={},l=!1,c=0;c<EA.length;c++){var d=EA[c],u=a&&zA[d];t&&null!=t[d]?u?(l=!0,o[d]=t[d]):this[d]=t[d]:s&&null!=n[d]&&(u?(l=!0,o[d]=n[d]):this[d]=n[d])}if(!a)for(c=0;c<this.animators.length;c++){var h=this.animators[c],p=h.targetName;h.getLoop()||h.__changeFinalValue(p?(t||n)[p]:t||n)}l&&this._transitionState(e,o,r)},e.prototype._attachComponent=function(e){if((!e.__zr||e.__hostTarget)&&e!==this){var t=this.__zr;t&&e.addSelfToZr(t),e.__zr=t,e.__hostTarget=this}},e.prototype._detachComponent=function(e){e.__zr&&e.removeSelfFromZr(e.__zr),e.__zr=null,e.__hostTarget=null},e.prototype.getClipPath=function(){return this._clipPath},e.prototype.setClipPath=function(e){this._clipPath&&this._clipPath!==e&&this.removeClipPath(),this._attachComponent(e),this._clipPath=e,this.markRedraw()},e.prototype.removeClipPath=function(){var e=this._clipPath;e&&(this._detachComponent(e),this._clipPath=null,this.markRedraw())},e.prototype.getTextContent=function(){return this._textContent},e.prototype.setTextContent=function(e){var t=this._textContent;t!==e&&(t&&t!==e&&this.removeTextContent(),e.innerTransformable=new vA,this._attachComponent(e),this._textContent=e,this.markRedraw())},e.prototype.setTextConfig=function(e){this.textConfig||(this.textConfig={}),RC(this.textConfig,e),this.markRedraw()},e.prototype.removeTextConfig=function(){this.textConfig=null,this.markRedraw()},e.prototype.removeTextContent=function(){var e=this._textContent;e&&(e.innerTransformable=null,this._detachComponent(e),this._textContent=null,this._innerTextDefaultStyle=null,this.markRedraw())},e.prototype.getTextGuideLine=function(){return this._textGuide},e.prototype.setTextGuideLine=function(e){this._textGuide&&this._textGuide!==e&&this.removeTextGuideLine(),this._attachComponent(e),this._textGuide=e,this.markRedraw()},e.prototype.removeTextGuideLine=function(){var e=this._textGuide;e&&(this._detachComponent(e),this._textGuide=null,this.markRedraw())},e.prototype.markRedraw=function(){this.__dirty|=1;var e=this.__zr;e&&(this.__inHover?e.refreshHover():e.refresh()),this.__hostTarget&&this.__hostTarget.markRedraw()},e.prototype.dirty=function(){this.markRedraw()},e.prototype._toggleHoverLayerFlag=function(e){this.__inHover=e;var t=this._textContent,n=this._textGuide;t&&(t.__inHover=e),n&&(n.__inHover=e)},e.prototype.addSelfToZr=function(e){if(this.__zr!==e){this.__zr=e;var t=this.animators;if(t)for(var n=0;n<t.length;n++)e.animation.addAnimator(t[n]);this._clipPath&&this._clipPath.addSelfToZr(e),this._textContent&&this._textContent.addSelfToZr(e),this._textGuide&&this._textGuide.addSelfToZr(e)}},e.prototype.removeSelfFromZr=function(e){if(this.__zr){this.__zr=null;var t=this.animators;if(t)for(var n=0;n<t.length;n++)e.animation.removeAnimator(t[n]);this._clipPath&&this._clipPath.removeSelfFromZr(e),this._textContent&&this._textContent.removeSelfFromZr(e),this._textGuide&&this._textGuide.removeSelfFromZr(e)}},e.prototype.animate=function(e,t,n){var i=e?this[e]:this,a=new $M(i,t,n);return e&&(a.targetName=e),this.addAnimator(a,e),a},e.prototype.addAnimator=function(e,t){var n=this.__zr,i=this;e.during(function(){i.updateDuringAnimation(t)}).done(function(){var t=i.animators,n=LC(t,e);n>=0&&t.splice(n,1)}),this.animators.push(e),n&&n.animation.addAnimator(e),n&&n.wakeUp()},e.prototype.updateDuringAnimation=function(e){this.markRedraw()},e.prototype.stopAnimation=function(e,t){for(var n=this.animators,i=n.length,a=[],r=0;r<i;r++){var s=n[r];e&&e!==s.scope?a.push(s):s.stop(t)}return this.animators=a,this},e.prototype.animateTo=function(e,t,n){LA(this,e,t,n)},e.prototype.animateFrom=function(e,t,n){LA(this,e,t,n,!0)},e.prototype._transitionState=function(e,t,n,i){for(var a=LA(this,t,n,i),r=0;r<a.length;r++)a[r].__fromStateTransition=e},e.prototype.getBoundingRect=function(){return null},e.prototype.getPaintRect=function(){return null},e.initDefaultProps=function(){var t=e.prototype;function n(e,n,i,a){function r(e,t){Object.defineProperty(t,0,{get:function(){return e[i]},set:function(t){e[i]=t}}),Object.defineProperty(t,1,{get:function(){return e[a]},set:function(t){e[a]=t}})}Object.defineProperty(t,e,{get:function(){this[n]||r(this,this[n]=[]);return this[n]},set:function(e){this[i]=e[0],this[a]=e[1],this[n]=e,r(this,e)}})}t.type="element",t.name="",t.ignore=t.silent=t.ignoreHostSilent=t.isGroup=t.draggable=t.dragging=t.ignoreClip=t.__inHover=!1,t.__dirty=1,Object.defineProperty&&(n("position","_legacyPos","x","y"),n("scale","_legacyScale","scaleX","scaleY"),n("origin","_legacyOrigin","originX","originY"))}(),e}();function LA(e,t,n,i,a){var r=[];BA(e,"",e,t,n=n||{},i,r,a);var s=r.length,o=!1,l=n.done,c=n.aborted,d=function(){o=!0,--s<=0&&(o?l&&l():c&&c())},u=function(){--s<=0&&(o?l&&l():c&&c())};s||l&&l(),r.length>0&&n.during&&r[0].during(function(e,t){n.during(t)});for(var h=0;h<r.length;h++){var p=r[h];d&&p.done(d),u&&p.aborted(u),n.force&&p.duration(n.duration),p.start(n.easing)}return r}function NA(e,t,n){for(var i=0;i<n;i++)e[i]=t[i]}function FA(e,t,n){if(BC(t[n]))if(BC(e[n])||(e[n]=[]),nI(t[n])){var i=t[n].length;e[n].length!==i&&(e[n]=new t[n].constructor(i),NA(e[n],t[n],i))}else{var a=t[n],r=e[n],s=a.length;if(BC(a[0]))for(var o=a[0].length,l=0;l<s;l++)r[l]?NA(r[l],a[l],o):r[l]=Array.prototype.slice.call(a[l]);else NA(r,a,s);r.length=a.length}else e[n]=t[n]}function BA(e,t,n,i,a,r,s,o){for(var l=WC(i),c=a.duration,d=a.delay,u=a.additive,h=a.setToFinal,p=!eI(r),g=e.animators,v=[],f=0;f<l.length;f++){var m=l[f],y=i[m];if(null!=y&&null!=n[m]&&(p||r[m]))if(!eI(y)||BC(y)||aI(y))v.push(m);else{if(t){o||(n[m]=y,e.updateDuringAnimation(t));continue}BA(e,m,n[m],y,a,r&&r[m],s,o)}else o||(n[m]=y,e.updateDuringAnimation(t),v.push(m))}var b=v.length;if(!u&&b)for(var w=0;w<g.length;w++){if((S=g[w]).targetName===t)if(S.stopTracks(v)){var k=LC(g,S);g.splice(k,1)}}if(a.force||(v=qC(v,function(e){return t=i[e],a=n[e],!(t===a||BC(t)&&BC(a)&&function(e,t){var n=e.length;if(n!==t.length)return!1;for(var i=0;i<n;i++)if(e[i]!==t[i])return!1;return!0}(t,a));var t,a}),b=v.length),b>0||a.force&&!s.length){var S,x=void 0,_=void 0,C=void 0;if(o){_={},h&&(x={});for(w=0;w<b;w++){_[m=v[w]]=n[m],h?x[m]=i[m]:n[m]=i[m]}}else if(h){C={};for(w=0;w<b;w++){C[m=v[w]]=MM(n[m]),FA(n,i,m)}}(S=new $M(n,!1,!1,u?qC(g,function(e){return e.targetName===t}):null)).targetName=t,a.scope&&(S.scope=a.scope),h&&x&&S.whenWithKeys(0,x,v),C&&S.whenWithKeys(0,C,v),S.whenWithKeys(null==c?500:c,o?_:i,v).delay(d||0),e.addAnimator(S,t),s.push(S)}}FC(OA,JI),FC(OA,vA);var jA=function(e){function t(t){var n=e.call(this)||this;return n.isGroup=!0,n._children=[],n.attr(t),n}return EI(t,e),t.prototype.childrenRef=function(){return this._children},t.prototype.children=function(){return this._children.slice()},t.prototype.childAt=function(e){return this._children[e]},t.prototype.childOfName=function(e){for(var t=this._children,n=0;n<t.length;n++)if(t[n].name===e)return t[n]},t.prototype.childCount=function(){return this._children.length},t.prototype.add=function(e){return e&&e!==this&&e.parent!==this&&(this._children.push(e),this._doAdd(e)),this},t.prototype.addBefore=function(e,t){if(e&&e!==this&&e.parent!==this&&t&&t.parent===this){var n=this._children,i=n.indexOf(t);i>=0&&(n.splice(i,0,e),this._doAdd(e))}return this},t.prototype.replace=function(e,t){var n=LC(this._children,e);return n>=0&&this.replaceAt(t,n),this},t.prototype.replaceAt=function(e,t){var n=this._children,i=n[t];if(e&&e!==this&&e.parent!==this&&e!==i){n[t]=e,i.parent=null;var a=this.__zr;a&&i.removeSelfFromZr(a),this._doAdd(e)}return this},t.prototype._doAdd=function(e){e.parent&&e.parent.remove(e),e.parent=this;var t=this.__zr;t&&t!==e.__zr&&e.addSelfToZr(t),t&&t.refresh()},t.prototype.remove=function(e){var t=this.__zr,n=this._children,i=LC(n,e);return i<0||(n.splice(i,1),e.parent=null,t&&e.removeSelfFromZr(t),t&&t.refresh()),this},t.prototype.removeAll=function(){for(var e=this._children,t=this.__zr,n=0;n<e.length;n++){var i=e[n];t&&i.removeSelfFromZr(t),i.parent=null}return e.length=0,this},t.prototype.eachChild=function(e,t){for(var n=this._children,i=0;i<n.length;i++){var a=n[i];e.call(t,a,i)}return this},t.prototype.traverse=function(e,t){for(var n=0;n<this._children.length;n++){var i=this._children[n],a=e.call(t,i);i.isGroup&&!a&&i.traverse(e,t)}return this},t.prototype.addSelfToZr=function(t){e.prototype.addSelfToZr.call(this,t);for(var n=0;n<this._children.length;n++){this._children[n].addSelfToZr(t)}},t.prototype.removeSelfFromZr=function(t){e.prototype.removeSelfFromZr.call(this,t);for(var n=0;n<this._children.length;n++){this._children[n].removeSelfFromZr(t)}},t.prototype.getBoundingRect=function(e){for(var t=new GD(0,0,0,0),n=e||this._children,i=[],a=null,r=0;r<n.length;r++){var s=n[r];if(!s.ignore&&!s.invisible){var o=s.getBoundingRect(),l=s.getLocalTransform(i);l?(GD.applyTransform(t,o,l),(a=a||t.clone()).union(t)):(a=a||o.clone()).union(o)}}return a||t},t}(OA);jA.prototype.type="group";var UA={},VA={};var qA,HA=function(){function e(e,t,n){var i=this;this._sleepAfterStill=10,this._stillFrameAccum=0,this._needsRefresh=!0,this._needsRefreshHover=!0,this._darkMode=!1,n=n||{},this.dom=t,this.id=e;var a=new yT,r=n.renderer||"canvas";UA[r]||(r=WC(UA)[0]),n.useDirtyRect=null!=n.useDirtyRect&&n.useDirtyRect;var s=new UA[r](t,a,n,e),o=n.ssr||s.ssrOnly;this.storage=a,this.painter=s;var l,c=pC.node||pC.worker||o?null:new nA(s.getViewportRoot(),s.root),d=n.useCoarsePointer;(null==d||"auto"===d?pC.touchEventsSupported:!!d)&&(l=cI(n.pointerSize,44)),this.handler=new aT(a,s,c,s.root,l),this.animation=new FM({stage:{update:o?null:function(){return i._flush(!0)}}}),o||this.animation.start()}return e.prototype.add=function(e){!this._disposed&&e&&(this.storage.addRoot(e),e.addSelfToZr(this),this.refresh())},e.prototype.remove=function(e){!this._disposed&&e&&(this.storage.delRoot(e),e.removeSelfFromZr(this),this.refresh())},e.prototype.configLayer=function(e,t){this._disposed||(this.painter.configLayer&&this.painter.configLayer(e,t),this.refresh())},e.prototype.setBackgroundColor=function(e){this._disposed||(this.painter.setBackgroundColor&&this.painter.setBackgroundColor(e),this.refresh(),this._backgroundColor=e,this._darkMode=function(e){if(!e)return!1;if("string"==typeof e)return yM(e,1)<.4;if(e.colorStops){for(var t=e.colorStops,n=0,i=t.length,a=0;a<i;a++)n+=yM(t[a].color,1);return(n/=i)<.4}return!1}(e))},e.prototype.getBackgroundColor=function(){return this._backgroundColor},e.prototype.setDarkMode=function(e){this._darkMode=e},e.prototype.isDarkMode=function(){return this._darkMode},e.prototype.refreshImmediately=function(e){this._disposed||(e||this.animation.update(!0),this._needsRefresh=!1,this.painter.refresh(),this._needsRefresh=!1)},e.prototype.refresh=function(){this._disposed||(this._needsRefresh=!0,this.animation.start())},e.prototype.flush=function(){this._disposed||this._flush(!1)},e.prototype._flush=function(e){var t,n=OM();this._needsRefresh&&(t=!0,this.refreshImmediately(e)),this._needsRefreshHover&&(t=!0,this.refreshHoverImmediately());var i=OM();t?(this._stillFrameAccum=0,this.trigger("rendered",{elapsedTime:i-n})):this._sleepAfterStill>0&&(this._stillFrameAccum++,this._stillFrameAccum>this._sleepAfterStill&&this.animation.stop())},e.prototype.setSleepAfterStill=function(e){this._sleepAfterStill=e},e.prototype.wakeUp=function(){this._disposed||(this.animation.start(),this._stillFrameAccum=0)},e.prototype.refreshHover=function(){this._needsRefreshHover=!0},e.prototype.refreshHoverImmediately=function(){this._disposed||(this._needsRefreshHover=!1,this.painter.refreshHover&&"canvas"===this.painter.getType()&&this.painter.refreshHover())},e.prototype.resize=function(e){this._disposed||(e=e||{},this.painter.resize(e.width,e.height),this.handler.resize())},e.prototype.clearAnimation=function(){this._disposed||this.animation.clear()},e.prototype.getWidth=function(){if(!this._disposed)return this.painter.getWidth()},e.prototype.getHeight=function(){if(!this._disposed)return this.painter.getHeight()},e.prototype.setCursorStyle=function(e){this._disposed||this.handler.setCursorStyle(e)},e.prototype.findHover=function(e,t){if(!this._disposed)return this.handler.findHover(e,t)},e.prototype.on=function(e,t,n){return this._disposed||this.handler.on(e,t,n),this},e.prototype.off=function(e,t){this._disposed||this.handler.off(e,t)},e.prototype.trigger=function(e,t){this._disposed||this.handler.trigger(e,t)},e.prototype.clear=function(){if(!this._disposed){for(var e=this.storage.getRoots(),t=0;t<e.length;t++)e[t]instanceof jA&&e[t].removeSelfFromZr(this);this.storage.delAllRoots(),this.painter.clear()}},e.prototype.dispose=function(){var e;this._disposed||(this.animation.stop(),this.clear(),this.storage.dispose(),this.painter.dispose(),this.handler.dispose(),this.animation=this.storage=this.painter=this.handler=null,this._disposed=!0,e=this.id,delete VA[e])},e}();function WA(e,t){var n=new HA(AC(),e,t);return VA[n.id]=n,n}function GA(e,t){UA[e]=t}function QA(e){qA=e}const KA=Object.freeze(Object.defineProperty({__proto__:null,dispose:function(e){e.dispose()},disposeAll:function(){for(var e in VA)VA.hasOwnProperty(e)&&VA[e].dispose();VA={}},getElementSSRData:function(e){if("function"==typeof qA)return qA(e)},getInstance:function(e){return VA[e]},init:WA,registerPainter:GA,registerSSRDataGetter:QA,version:"6.0.0"},Symbol.toStringTag,{value:"Module"}));var ZA=1e-4;var YA=Math.min,XA=Math.max,JA=Math.abs;function eE(e,t,n,i){var a=t[0],r=t[1],s=n[0],o=n[1],l=r-a,c=o-s;if(0===l)return 0===c?s:(s+o)/2;if(i)if(l>0){if(e<=a)return s;if(e>=r)return o}else{if(e>=a)return s;if(e<=r)return o}else{if(e===a)return s;if(e===r)return o}return(e-a)/l*c+s}var tE=function(e,t,n){switch(e){case"center":case"middle":e="50%";break;case"left":case"top":e="0%";break;case"right":case"bottom":e="100%"}return nE(e,t,n)};function nE(e,t,n){return YC(e)?(i=e,i.replace(/^\s+|\s+$/g,"")).match(/%$/)?parseFloat(e)/100*t+(n||0):parseFloat(e):null==e?NaN:+e;var i}function iE(e,t,n){return null==t&&(t=10),t=Math.min(Math.max(0,t),20),e=(+e).toFixed(t),n?e:+e}function aE(e){return e.sort(function(e,t){return e-t}),e}function rE(e){if(e=+e,isNaN(e))return 0;if(e>1e-14)for(var t=1,n=0;n<15;n++,t*=10)if(Math.round(e*t)/t===e)return n;return sE(e)}function sE(e){var t=e.toString().toLowerCase(),n=t.indexOf("e"),i=n>0?+t.slice(n+1):0,a=n>0?n:t.length,r=t.indexOf("."),s=r<0?0:a-1-r;return Math.max(0,s-i)}function oE(e,t){var n=Math.log,i=Math.LN10,a=Math.floor(n(e[1]-e[0])/i),r=Math.round(n(JA(t[1]-t[0]))/i),s=Math.min(Math.max(-a+r,0),20);return isFinite(s)?s:20}function lE(e,t){var n=VC(e,function(e,t){return e+(isNaN(t)?0:t)},0);if(0===n)return[];for(var i=Math.pow(10,t),a=UC(e,function(e){return(isNaN(e)?0:e)/n*i*100}),r=100*i,s=UC(a,function(e){return Math.floor(e)}),o=VC(s,function(e,t){return e+t},0),l=UC(a,function(e,t){return e-s[t]});o<r;){for(var c=Number.NEGATIVE_INFINITY,d=null,u=0,h=l.length;u<h;++u)l[u]>c&&(c=l[u],d=u);++s[d],l[d]=0,++o}return UC(s,function(e){return e/i})}function cE(e,t){var n=Math.max(rE(e),rE(t)),i=e+t;return n>20?i:iE(i,n)}function dE(e){var t=2*Math.PI;return(e%t+t)%t}function uE(e){return e>-1e-4&&e<ZA}var hE=/^(?:(\d{4})(?:[-\/](\d{1,2})(?:[-\/](\d{1,2})(?:[T ](\d{1,2})(?::(\d{1,2})(?::(\d{1,2})(?:[.,](\d+))?)?)?(Z|[\+\-]\d\d:?\d\d)?)?)?)?)?$/;function pE(e){if(e instanceof Date)return e;if(YC(e)){var t=hE.exec(e);if(!t)return new Date(NaN);if(t[8]){var n=+t[4]||0;return"Z"!==t[8].toUpperCase()&&(n-=+t[8].slice(0,3)),new Date(Date.UTC(+t[1],+(t[2]||1)-1,+t[3]||1,n,+(t[5]||0),+t[6]||0,t[7]?+t[7].substring(0,3):0))}return new Date(+t[1],+(t[2]||1)-1,+t[3]||1,+t[4]||0,+(t[5]||0),+t[6]||0,t[7]?+t[7].substring(0,3):0)}return null==e?new Date(NaN):new Date(Math.round(e))}function gE(e){return Math.pow(10,vE(e))}function vE(e){if(0===e)return 0;var t=Math.floor(Math.log(e)/Math.LN10);return e/Math.pow(10,t)>=10&&t++,t}function fE(e,t){var n=vE(e),i=Math.pow(10,n),a=e/i;return e=(t?a<1.5?1:a<2.5?2:a<4?3:a<7?5:10:a<1?1:a<2?2:a<3?3:a<5?5:10)*i,n>=-20?+e.toFixed(n<0?-n:0):e}function mE(e){e.sort(function(e,t){return o(e,t,0)?-1:1});for(var t=-1/0,n=1,i=0;i<e.length;){for(var a=e[i].interval,r=e[i].close,s=0;s<2;s++)a[s]<=t&&(a[s]=t,r[s]=s?1:1-n),t=a[s],n=r[s];a[0]===a[1]&&r[0]*r[1]!==1?e.splice(i,1):i++}return e;function o(e,t,n){return e.interval[n]<t.interval[n]||e.interval[n]===t.interval[n]&&(e.close[n]-t.close[n]===(n?-1:1)||!n&&o(e,t,1))}}function yE(e){var t=parseFloat(e);return t==e&&(0!==t||!YC(e)||e.indexOf("x")<=0)?t:NaN}function bE(e){return!isNaN(yE(e))}function wE(){return Math.round(9*Math.random())}function kE(e,t){return 0===t?e:kE(t,e%t)}function SE(e,t){return null==e?t:null==t?e:e*t/kE(e,t)}"undefined"!=typeof console&&console.warn&&console.log;function xE(e,t){}function _E(e){throw new Error(e)}function CE(e,t,n){return(t-e)*n+e}var IE="series\0",DE="\0_ec_\0";function TE(e){return e instanceof Array?e:null==e?[]:[e]}function ME(e,t,n){if(e){e[t]=e[t]||{},e.emphasis=e.emphasis||{},e.emphasis[t]=e.emphasis[t]||{};for(var i=0,a=n.length;i<a;i++){var r=n[i];!e.emphasis[t].hasOwnProperty(r)&&e[t].hasOwnProperty(r)&&(e.emphasis[t][r]=e[t][r])}}}var AE=["fontStyle","fontWeight","fontSize","fontFamily","rich","tag","color","textBorderColor","textBorderWidth","width","height","lineHeight","align","verticalAlign","baseline","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","textShadowColor","textShadowBlur","textShadowOffsetX","textShadowOffsetY","backgroundColor","borderColor","borderWidth","borderRadius","padding"];function EE(e){return!eI(e)||KC(e)||e instanceof Date?e:e.value}function zE(e){return eI(e)&&!(e instanceof Array)}function PE(e,t,n){var i="normalMerge"===n,a="replaceMerge"===n,r="replaceAll"===n;e=e||[],t=(t||[]).slice();var s=kI();jC(t,function(e,n){eI(e)||(t[n]=null)});var o,l,c=function(e,t,n){var i=[];if("replaceAll"===n)return i;for(var a=0;a<e.length;a++){var r=e[a];r&&null!=r.id&&t.set(r.id,a),i.push({existing:"replaceMerge"===n||NE(r)?null:r,newOption:null,keyInfo:null,brandNew:null})}return i}(e,s,n);return(i||a)&&function(e,t,n,i){jC(i,function(a,r){if(a&&null!=a.id){var s=$E(a.id),o=n.get(s);if(null!=o){var l=e[o];pI(!l.newOption,'Duplicated option on id "'+s+'".'),l.newOption=a,l.existing=t[o],i[r]=null}}})}(c,e,s,t),i&&function(e,t){jC(t,function(n,i){if(n&&null!=n.name)for(var a=0;a<e.length;a++){var r=e[a].existing;if(!e[a].newOption&&r&&(null==r.id||null==n.id)&&!NE(n)&&!NE(r)&&RE("name",r,n))return e[a].newOption=n,void(t[i]=null)}})}(c,t),i||a?function(e,t,n){jC(t,function(t){if(t){for(var i,a=0;(i=e[a])&&(i.newOption||NE(i.existing)||i.existing&&null!=t.id&&!RE("id",t,i.existing));)a++;i?(i.newOption=t,i.brandNew=n):e.push({newOption:t,brandNew:n,existing:null,keyInfo:null}),a++}})}(c,t,a):r&&function(e,t){jC(t,function(t){e.push({newOption:t,brandNew:!0,existing:null,keyInfo:null})})}(c,t),o=c,l=kI(),jC(o,function(e){var t=e.existing;t&&l.set(t.id,e)}),jC(o,function(e){var t=e.newOption;pI(!t||null==t.id||!l.get(t.id)||l.get(t.id)===e,"id duplicates: "+(t&&t.id)),t&&null!=t.id&&l.set(t.id,e),!e.keyInfo&&(e.keyInfo={})}),jC(o,function(e,t){var n=e.existing,i=e.newOption,a=e.keyInfo;if(eI(i)){if(a.name=null!=i.name?$E(i.name):n?n.name:IE+t,n)a.id=$E(n.id);else if(null!=i.id)a.id=$E(i.id);else{var r=0;do{a.id="\0"+a.name+"\0"+r++}while(l.get(a.id))}l.set(a.id,e)}}),c}function RE(e,t,n){var i=OE(t[e],null),a=OE(n[e],null);return null!=i&&null!=a&&i===a}function $E(e){return OE(e,"")}function OE(e,t){return null==e?t:YC(e)?e:JC(e)||XC(e)?e+"":t}function LE(e){var t=e.name;return!(!t||!t.indexOf(IE))}function NE(e){return e&&null!=e.id&&0===$E(e.id).indexOf(DE)}function FE(e,t){return null!=t.dataIndexInside?t.dataIndexInside:null!=t.dataIndex?KC(t.dataIndex)?UC(t.dataIndex,function(t){return e.indexOfRawIndex(t)}):e.indexOfRawIndex(t.dataIndex):null!=t.name?KC(t.name)?UC(t.name,function(t){return e.indexOfName(t)}):e.indexOfName(t.name):void 0}function BE(){var e="__ec_inner_"+jE++;return function(t){return t[e]||(t[e]={})}}var jE=wE();function UE(e,t,n){var i=VE(t,n),a=i.mainTypeSpecified,r=i.queryOptionMap,s=i.others,o=n?n.defaultMainType:null;return!a&&o&&r.set(o,{}),r.each(function(t,i){var a=WE(e,i,t,{useDefault:o===i,enableAll:!n||null==n.enableAll||n.enableAll,enableNone:!n||null==n.enableNone||n.enableNone});s[i+"Models"]=a.models,s[i+"Model"]=a.models[0]}),s}function VE(e,t){var n;if(YC(e)){var i={};i[e+"Index"]=0,n=i}else n=e;var a=kI(),r={},s=!1;return jC(n,function(e,n){if("dataIndex"!==n&&"dataIndexInside"!==n){var i=n.match(/^(\w+)(Index|Id|Name)$/)||[],o=i[1],l=(i[2]||"").toLowerCase();if(o&&l&&!(t&&t.includeMainTypes&&LC(t.includeMainTypes,o)<0))s=s||!!o,(a.get(o)||a.set(o,{}))[l]=e}else r[n]=e}),{mainTypeSpecified:s,queryOptionMap:a,others:r}}var qE={useDefault:!0,enableAll:!1,enableNone:!1},HE={useDefault:!1,enableAll:!0,enableNone:!0};function WE(e,t,n,i){i=i||qE;var a=n.index,r=n.id,s=n.name,o={models:null,specified:null!=a||null!=r||null!=s};if(!o.specified){var l=void 0;return o.models=i.useDefault&&(l=e.getComponent(t))?[l]:[],o}if("none"===a||!1===a){if(i.enableNone)return o.models=[],o;a=-1}return"all"===a&&(a=i.enableAll?r=s=null:-1),o.models=e.queryComponents({mainType:t,index:a,id:r,name:s}),o}function GE(e,t,n){e.setAttribute?e.setAttribute(t,n):e[t]=n}function QE(e,t,n,i,a){var r=null==t||"auto"===t;if(null==i)return i;if(JC(i))return iE(g=CE(n||0,i,a),r?Math.max(rE(n||0),rE(i)):t);if(YC(i))return a<1?n:i;for(var s=[],o=n,l=i,c=Math.max(o?o.length:0,l.length),d=0;d<c;++d){var u=e.getDimensionInfo(d);if(u&&"ordinal"===u.type)s[d]=(a<1&&o?o:l)[d];else{var h=o&&o[d]?o[d]:0,p=l[d],g=CE(h,p,a);s[d]=iE(g,r?Math.max(rE(h),rE(p)):t)}}return s}var KE="___EC__COMPONENT__CONTAINER___",ZE="___EC__EXTENDED_CLASS___";function YE(e){var t={main:"",sub:""};if(e){var n=e.split(".");t.main=n[0]||"",t.sub=n[1]||""}return t}function XE(e,t){e.$constructor=e,e.extend=function(e){var t,n,i=this;return ZC(n=i)&&/^class\s/.test(Function.prototype.toString.call(n))?t=function(e){function t(){return e.apply(this,arguments)||this}return uC(t,e),t}(i):(t=function(){(e.$constructor||i).apply(this,arguments)},NC(t,this)),RC(t.prototype,e),t[ZE]=!0,t.extend=this.extend,t.superCall=tz,t.superApply=nz,t.superClass=i,t}}function JE(e,t){e.extend=t.extend}var ez=Math.round(10*Math.random());function tz(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return this.superClass.prototype[t].apply(e,n)}function nz(e,t,n){return this.superClass.prototype[t].apply(e,n)}function iz(e){var t={};e.registerClass=function(e){var n,i=e.type||e.prototype.type;if(i){pI(/^[a-zA-Z0-9_]+([.][a-zA-Z0-9_]+)?$/.test(n=i),'componentType "'+n+'" illegal'),e.prototype.type=i;var a=YE(i);if(a.sub){if(a.sub!==KE){var r=function(e){var n=t[e.main];n&&n[KE]||((n=t[e.main]={})[KE]=!0);return n}(a);r[a.sub]=e}}else t[a.main]=e}return e},e.getClass=function(e,n,i){var a=t[e];if(a&&a[KE]&&(a=n?a[n]:null),i&&!a)throw new Error(n?"Component "+e+"."+(n||"")+" is used but not imported.":e+".type should be specified.");return a},e.getClassesByMainType=function(e){var n=YE(e),i=[],a=t[n.main];return a&&a[KE]?jC(a,function(e,t){t!==KE&&i.push(e)}):i.push(a),i},e.hasClass=function(e){var n=YE(e);return!!t[n.main]},e.getAllClassMainTypes=function(){var e=[];return jC(t,function(t,n){e.push(n)}),e},e.hasSubTypes=function(e){var n=YE(e),i=t[n.main];return i&&i[KE]}}function az(e,t){for(var n=0;n<e.length;n++)e[n][1]||(e[n][1]=e[n][0]);return t=t||!1,function(n,i,a){for(var r={},s=0;s<e.length;s++){var o=e[s][1];if(!(i&&LC(i,o)>=0||a&&LC(a,o)<0)){var l=n.getShallow(o,t);null!=l&&(r[e[s][0]]=l)}}return r}}var rz=az([["fill","color"],["shadowBlur"],["shadowOffsetX"],["shadowOffsetY"],["opacity"],["shadowColor"]]),sz=function(){function e(){}return e.prototype.getAreaStyle=function(e,t){return rz(this,e,t)},e}(),oz=new KT(50);function lz(e){if("string"==typeof e){var t=oz.get(e);return t&&t.image}return e}function cz(e,t,n,i,a){if(e){if("string"==typeof e){if(t&&t.__zrImageSrc===e||!n)return t;var r=oz.get(e),s={hostEl:n,cb:i,cbPayload:a};return r?!uz(t=r.image)&&r.pending.push(s):((t=fC.loadImage(e,dz,dz)).__zrImageSrc=e,oz.put(e,t.__cachedImgObj={image:t,pending:[s]})),t}return e}return t}function dz(){var e=this.__cachedImgObj;this.onload=this.onerror=this.__cachedImgObj=null;for(var t=0;t<e.pending.length;t++){var n=e.pending[t],i=n.cb;i&&i(this,n.cbPayload),n.hostEl.dirty()}e.pending.length=0}function uz(e){return e&&e.width&&e.height}var hz=/\{([a-zA-Z0-9_]+)\|([^}]*)\}/g;function pz(e,t,n,i,a,r){if(!n)return e.text="",void(e.isTruncated=!1);var s=(t+"").split("\n");r=gz(n,i,a,r);for(var o=!1,l={},c=0,d=s.length;c<d;c++)vz(l,s[c],r),s[c]=l.textLine,o=o||l.isTruncated;e.text=s.join("\n"),e.isTruncated=o}function gz(e,t,n,i){var a=RC({},i=i||{});n=cI(n,"..."),a.maxIterations=cI(i.maxIterations,2);var r=a.minChar=cI(i.minChar,0),s=a.fontMeasureInfo=yA(t),o=s.asciiCharWidth;a.placeholder=cI(i.placeholder,"");for(var l=e=Math.max(0,e-1),c=0;c<r&&l>=o;c++)l-=o;var d=SA(s,n);return d>l&&(n="",d=0),l=e-d,a.ellipsis=n,a.ellipsisWidth=d,a.contentWidth=l,a.containerWidth=e,a}function vz(e,t,n){var i=n.containerWidth,a=n.contentWidth,r=n.fontMeasureInfo;if(!i)return e.textLine="",void(e.isTruncated=!1);var s=SA(r,t);if(s<=i)return e.textLine=t,void(e.isTruncated=!1);for(var o=0;;o++){if(s<=a||o>=n.maxIterations){t+=n.ellipsis;break}var l=0===o?fz(t,a,r):s>0?Math.floor(t.length*a/s):0;s=SA(r,t=t.substr(0,l))}""===t&&(t=n.placeholder),e.textLine=t,e.isTruncated=!0}function fz(e,t,n){for(var i=0,a=0,r=e.length;a<r&&i<t;a++)i+=kA(n,e.charCodeAt(a));return a}var mz=function(){return function(){}}(),yz=function(){return function(e){this.tokens=[],e&&(this.tokens=e)}}(),bz=function(){return function(){this.width=0,this.height=0,this.contentWidth=0,this.contentHeight=0,this.outerWidth=0,this.outerHeight=0,this.lines=[],this.isTruncated=!1}}();function wz(e,t,n,i,a){var r,s,o=""===t,l=a&&n.rich[a]||{},c=e.lines,d=l.font||n.font,u=!1;if(i){var h=l.padding,p=h?h[1]+h[3]:0;if(null!=l.width&&"auto"!==l.width){var g=TA(l.width,i.width)+p;c.length>0&&g+i.accumWidth>i.width&&(r=t.split("\n"),u=!0),i.accumWidth=g}else{var v=xz(t,d,i.width,i.breakAll,i.accumWidth);i.accumWidth=v.accumWidth+p,s=v.linesWidths,r=v.lines}}r||(r=t.split("\n"));for(var f=yA(d),m=0;m<r.length;m++){var y=r[m],b=new mz;if(b.styleName=a,b.text=y,b.isLineHolder=!y&&!o,"number"==typeof l.width?b.width=l.width:b.width=s?s[m]:SA(f,y),m||u)c.push(new yz([b]));else{var w=(c[c.length-1]||(c[0]=new yz)).tokens,k=w.length;1===k&&w[0].isLineHolder?w[0]=b:(y||!k||o)&&w.push(b)}}}var kz=VC(",&?/;] ".split(""),function(e,t){return e[t]=!0,e},{});function Sz(e){return!function(e){var t=e.charCodeAt(0);return t>=32&&t<=591||t>=880&&t<=4351||t>=4608&&t<=5119||t>=7680&&t<=8303}(e)||!!kz[e]}function xz(e,t,n,i,a){for(var r=[],s=[],o="",l="",c=0,d=0,u=yA(t),h=0;h<e.length;h++){var p=e.charAt(h);if("\n"!==p){var g=kA(u,p.charCodeAt(0)),v=!i&&!Sz(p);(r.length?d+g>n:a+d+g>n)?d?(o||l)&&(v?(o||(o=l,l="",d=c=0),r.push(o),s.push(d-c),l+=p,o="",d=c+=g):(l&&(o+=l,l="",c=0),r.push(o),s.push(d),o=p,d=g)):v?(r.push(l),s.push(c),l=p,c=g):(r.push(p),s.push(g)):(d+=g,v?(l+=p,c+=g):(l&&(o+=l,l="",c=0),o+=p))}else l&&(o+=l,d+=c),r.push(o),s.push(d),o="",l="",c=0,d=0}return l&&(o+=l),o&&(r.push(o),s.push(d)),1===r.length&&(d+=a),{accumWidth:d,lines:r,linesWidths:s}}function _z(e,t,n,i,a,r){if(e.baseX=n,e.baseY=i,e.outerWidth=e.outerHeight=null,t){var s=2*t.width,o=2*t.height;GD.set(Cz,CA(n,s,a),IA(i,o,r),s,o),GD.intersect(t,Cz,null,Iz);var l=Iz.outIntersectRect;e.outerWidth=l.width,e.outerHeight=l.height,e.baseX=CA(l.x,l.width,a,!0),e.baseY=IA(l.y,l.height,r,!0)}}var Cz=new GD(0,0,0,0),Iz={outIntersectRect:{},clamp:!0};function Dz(e){return null!=e?e+="":e=""}function Tz(e,t,n,i){var a=new GD(CA(e.x||0,t,e.textAlign),IA(e.y||0,n,e.textBaseline),t,n),r=null!=i?i:Mz(e)?e.lineWidth:0;return r>0&&(a.x-=r/2,a.y-=r/2,a.width+=r,a.height+=r),a}function Mz(e){var t=e.stroke;return null!=t&&"none"!==t&&e.lineWidth>0}var Az="__zr_style_"+Math.round(10*Math.random()),Ez={shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,shadowColor:"#000",opacity:1,blend:"source-over"},zz={style:{shadowBlur:!0,shadowOffsetX:!0,shadowOffsetY:!0,shadowColor:!0,opacity:!0}};Ez[Az]=!0;var Pz=["z","z2","invisible"],Rz=["invisible"],$z=function(e){function t(t){return e.call(this,t)||this}var n;return EI(t,e),t.prototype._init=function(t){for(var n=WC(t),i=0;i<n.length;i++){var a=n[i];"style"===a?this.useStyle(t[a]):e.prototype.attrKV.call(this,a,t[a])}this.style||this.useStyle({})},t.prototype.beforeBrush=function(){},t.prototype.afterBrush=function(){},t.prototype.innerBeforeBrush=function(){},t.prototype.innerAfterBrush=function(){},t.prototype.shouldBePainted=function(e,t,n,i){var a=this.transform;if(this.ignore||this.invisible||0===this.style.opacity||this.culling&&function(e,t,n){Oz.copy(e.getBoundingRect()),e.transform&&Oz.applyTransform(e.transform);return Lz.width=t,Lz.height=n,!Oz.intersect(Lz)}(this,e,t)||a&&!a[0]&&!a[3])return!1;if(n&&this.__clipPaths&&this.__clipPaths.length)for(var r=0;r<this.__clipPaths.length;++r)if(this.__clipPaths[r].isZeroArea())return!1;if(i&&this.parent)for(var s=this.parent;s;){if(s.ignore)return!1;s=s.parent}return!0},t.prototype.contain=function(e,t){return this.rectContain(e,t)},t.prototype.traverse=function(e,t){e.call(t,this)},t.prototype.rectContain=function(e,t){var n=this.transformCoordToLocal(e,t);return this.getBoundingRect().contain(n[0],n[1])},t.prototype.getPaintRect=function(){var e=this._paintRect;if(!this._paintRect||this.__dirty){var t=this.transform,n=this.getBoundingRect(),i=this.style,a=i.shadowBlur||0,r=i.shadowOffsetX||0,s=i.shadowOffsetY||0;e=this._paintRect||(this._paintRect=new GD(0,0,0,0)),t?GD.applyTransform(e,n,t):e.copy(n),(a||r||s)&&(e.width+=2*a+Math.abs(r),e.height+=2*a+Math.abs(s),e.x=Math.min(e.x,e.x+r-a),e.y=Math.min(e.y,e.y+s-a));var o=this.dirtyRectTolerance;e.isZero()||(e.x=Math.floor(e.x-o),e.y=Math.floor(e.y-o),e.width=Math.ceil(e.width+1+2*o),e.height=Math.ceil(e.height+1+2*o))}return e},t.prototype.setPrevPaintRect=function(e){e?(this._prevPaintRect=this._prevPaintRect||new GD(0,0,0,0),this._prevPaintRect.copy(e)):this._prevPaintRect=null},t.prototype.getPrevPaintRect=function(){return this._prevPaintRect},t.prototype.animateStyle=function(e){return this.animate("style",e)},t.prototype.updateDuringAnimation=function(e){"style"===e?this.dirtyStyle():this.markRedraw()},t.prototype.attrKV=function(t,n){"style"!==t?e.prototype.attrKV.call(this,t,n):this.style?this.setStyle(n):this.useStyle(n)},t.prototype.setStyle=function(e,t){return"string"==typeof e?this.style[e]=t:RC(this.style,e),this.dirtyStyle(),this},t.prototype.dirtyStyle=function(e){e||this.markRedraw(),this.__dirty|=2,this._rect&&(this._rect=null)},t.prototype.dirty=function(){this.dirtyStyle()},t.prototype.styleChanged=function(){return!!(2&this.__dirty)},t.prototype.styleUpdated=function(){this.__dirty&=-3},t.prototype.createStyle=function(e){return xI(Ez,e)},t.prototype.useStyle=function(e){e[Az]||(e=this.createStyle(e)),this.__inHover?this.__hoverStyle=e:this.style=e,this.dirtyStyle()},t.prototype.isStyleObject=function(e){return e[Az]},t.prototype._innerSaveToNormal=function(t){e.prototype._innerSaveToNormal.call(this,t);var n=this._normalState;t.style&&!n.style&&(n.style=this._mergeStyle(this.createStyle(),this.style)),this._savePrimaryToNormal(t,n,Pz)},t.prototype._applyStateObj=function(t,n,i,a,r,s){e.prototype._applyStateObj.call(this,t,n,i,a,r,s);var o,l=!(n&&a);if(n&&n.style?r?a?o=n.style:(o=this._mergeStyle(this.createStyle(),i.style),this._mergeStyle(o,n.style)):(o=this._mergeStyle(this.createStyle(),a?this.style:i.style),this._mergeStyle(o,n.style)):l&&(o=i.style),o)if(r){var c=this.style;if(this.style=this.createStyle(l?{}:c),l)for(var d=WC(c),u=0;u<d.length;u++){(p=d[u])in o&&(o[p]=o[p],this.style[p]=c[p])}var h=WC(o);for(u=0;u<h.length;u++){var p=h[u];this.style[p]=this.style[p]}this._transitionState(t,{style:o},s,this.getAnimationStyleProps())}else this.useStyle(o);var g=this.__inHover?Rz:Pz;for(u=0;u<g.length;u++){p=g[u];n&&null!=n[p]?this[p]=n[p]:l&&null!=i[p]&&(this[p]=i[p])}},t.prototype._mergeStates=function(t){for(var n,i=e.prototype._mergeStates.call(this,t),a=0;a<t.length;a++){var r=t[a];r.style&&(n=n||{},this._mergeStyle(n,r.style))}return n&&(i.style=n),i},t.prototype._mergeStyle=function(e,t){return RC(e,t),e},t.prototype.getAnimationStyleProps=function(){return zz},t.initDefaultProps=((n=t.prototype).type="displayable",n.invisible=!1,n.z=0,n.z2=0,n.zlevel=0,n.culling=!1,n.cursor="pointer",n.rectHover=!1,n.incremental=!1,n._rect=null,n.dirtyRectTolerance=0,void(n.__dirty=3)),t}(OA),Oz=new GD(0,0,0,0),Lz=new GD(0,0,0,0);var Nz=Math.min,Fz=Math.max,Bz=Math.sin,jz=Math.cos,Uz=2*Math.PI,Vz=zI(),qz=zI(),Hz=zI();function Wz(e,t,n,i,a,r){a[0]=Nz(e,n),a[1]=Nz(t,i),r[0]=Fz(e,n),r[1]=Fz(t,i)}var Gz=[],Qz=[];function Kz(e,t,n,i,a,r,s,o,l,c){var d=RT,u=ET,h=d(e,n,a,s,Gz);l[0]=1/0,l[1]=1/0,c[0]=-1/0,c[1]=-1/0;for(var p=0;p<h;p++){var g=u(e,n,a,s,Gz[p]);l[0]=Nz(g,l[0]),c[0]=Fz(g,c[0])}h=d(t,i,r,o,Qz);for(p=0;p<h;p++){var v=u(t,i,r,o,Qz[p]);l[1]=Nz(v,l[1]),c[1]=Fz(v,c[1])}l[0]=Nz(e,l[0]),c[0]=Fz(e,c[0]),l[0]=Nz(s,l[0]),c[0]=Fz(s,c[0]),l[1]=Nz(t,l[1]),c[1]=Fz(t,c[1]),l[1]=Nz(o,l[1]),c[1]=Fz(o,c[1])}function Zz(e,t,n,i,a,r,s,o){var l=BT,c=NT,d=Fz(Nz(l(e,n,a),1),0),u=Fz(Nz(l(t,i,r),1),0),h=c(e,n,a,d),p=c(t,i,r,u);s[0]=Nz(e,a,h),s[1]=Nz(t,r,p),o[0]=Fz(e,a,h),o[1]=Fz(t,r,p)}function Yz(e,t,n,i,a,r,s,o,l){var c=QI,d=KI,u=Math.abs(a-r);if(u%Uz<1e-4&&u>1e-4)return o[0]=e-n,o[1]=t-i,l[0]=e+n,void(l[1]=t+i);if(Vz[0]=jz(a)*n+e,Vz[1]=Bz(a)*i+t,qz[0]=jz(r)*n+e,qz[1]=Bz(r)*i+t,c(o,Vz,qz),d(l,Vz,qz),(a%=Uz)<0&&(a+=Uz),(r%=Uz)<0&&(r+=Uz),a>r&&!s?r+=Uz:a<r&&s&&(a+=Uz),s){var h=r;r=a,a=h}for(var p=0;p<r;p+=Math.PI/2)p>a&&(Hz[0]=jz(p)*n+e,Hz[1]=Bz(p)*i+t,c(o,Hz,o),d(l,Hz,l))}var Xz={M:1,L:2,C:3,Q:4,A:5,Z:6,R:7},Jz=[],eP=[],tP=[],nP=[],iP=[],aP=[],rP=Math.min,sP=Math.max,oP=Math.cos,lP=Math.sin,cP=Math.abs,dP=Math.PI,uP=2*dP,hP="undefined"!=typeof Float32Array,pP=[];function gP(e){return Math.round(e/dP*1e8)/1e8%2*dP}function vP(e,t){var n=gP(e[0]);n<0&&(n+=uP);var i=n-e[0],a=e[1];a+=i,!t&&a-n>=uP?a=n+uP:t&&n-a>=uP?a=n-uP:!t&&n>a?a=n+(uP-gP(n-a)):t&&n<a&&(a=n-(uP-gP(a-n))),e[0]=n,e[1]=a}var fP=function(){function e(e){this.dpr=1,this._xi=0,this._yi=0,this._x0=0,this._y0=0,this._len=0,e&&(this._saveData=!1),this._saveData&&(this.data=[])}var t;return e.prototype.increaseVersion=function(){this._version++},e.prototype.getVersion=function(){return this._version},e.prototype.setScale=function(e,t,n){(n=n||0)>0&&(this._ux=cP(n/aA/e)||0,this._uy=cP(n/aA/t)||0)},e.prototype.setDPR=function(e){this.dpr=e},e.prototype.setContext=function(e){this._ctx=e},e.prototype.getContext=function(){return this._ctx},e.prototype.beginPath=function(){return this._ctx&&this._ctx.beginPath(),this.reset(),this},e.prototype.reset=function(){this._saveData&&(this._len=0),this._pathSegLen&&(this._pathSegLen=null,this._pathLen=0),this._version++},e.prototype.moveTo=function(e,t){return this._drawPendingPt(),this.addData(Xz.M,e,t),this._ctx&&this._ctx.moveTo(e,t),this._x0=e,this._y0=t,this._xi=e,this._yi=t,this},e.prototype.lineTo=function(e,t){var n=cP(e-this._xi),i=cP(t-this._yi),a=n>this._ux||i>this._uy;if(this.addData(Xz.L,e,t),this._ctx&&a&&this._ctx.lineTo(e,t),a)this._xi=e,this._yi=t,this._pendingPtDist=0;else{var r=n*n+i*i;r>this._pendingPtDist&&(this._pendingPtX=e,this._pendingPtY=t,this._pendingPtDist=r)}return this},e.prototype.bezierCurveTo=function(e,t,n,i,a,r){return this._drawPendingPt(),this.addData(Xz.C,e,t,n,i,a,r),this._ctx&&this._ctx.bezierCurveTo(e,t,n,i,a,r),this._xi=a,this._yi=r,this},e.prototype.quadraticCurveTo=function(e,t,n,i){return this._drawPendingPt(),this.addData(Xz.Q,e,t,n,i),this._ctx&&this._ctx.quadraticCurveTo(e,t,n,i),this._xi=n,this._yi=i,this},e.prototype.arc=function(e,t,n,i,a,r){this._drawPendingPt(),pP[0]=i,pP[1]=a,vP(pP,r),i=pP[0];var s=(a=pP[1])-i;return this.addData(Xz.A,e,t,n,n,i,s,0,r?0:1),this._ctx&&this._ctx.arc(e,t,n,i,a,r),this._xi=oP(a)*n+e,this._yi=lP(a)*n+t,this},e.prototype.arcTo=function(e,t,n,i,a){return this._drawPendingPt(),this._ctx&&this._ctx.arcTo(e,t,n,i,a),this},e.prototype.rect=function(e,t,n,i){return this._drawPendingPt(),this._ctx&&this._ctx.rect(e,t,n,i),this.addData(Xz.R,e,t,n,i),this},e.prototype.closePath=function(){this._drawPendingPt(),this.addData(Xz.Z);var e=this._ctx,t=this._x0,n=this._y0;return e&&e.closePath(),this._xi=t,this._yi=n,this},e.prototype.fill=function(e){e&&e.fill(),this.toStatic()},e.prototype.stroke=function(e){e&&e.stroke(),this.toStatic()},e.prototype.len=function(){return this._len},e.prototype.setData=function(e){if(this._saveData){var t=e.length;this.data&&this.data.length===t||!hP||(this.data=new Float32Array(t));for(var n=0;n<t;n++)this.data[n]=e[n];this._len=t}},e.prototype.appendPath=function(e){if(this._saveData){e instanceof Array||(e=[e]);for(var t=e.length,n=0,i=this._len,a=0;a<t;a++)n+=e[a].len();var r=this.data;if(hP&&(r instanceof Float32Array||!r)&&(this.data=new Float32Array(i+n),i>0&&r))for(var s=0;s<i;s++)this.data[s]=r[s];for(a=0;a<t;a++){var o=e[a].data;for(s=0;s<o.length;s++)this.data[i++]=o[s]}this._len=i}},e.prototype.addData=function(e,t,n,i,a,r,s,o,l){if(this._saveData){var c=this.data;this._len+arguments.length>c.length&&(this._expandData(),c=this.data);for(var d=0;d<arguments.length;d++)c[this._len++]=arguments[d]}},e.prototype._drawPendingPt=function(){this._pendingPtDist>0&&(this._ctx&&this._ctx.lineTo(this._pendingPtX,this._pendingPtY),this._pendingPtDist=0)},e.prototype._expandData=function(){if(!(this.data instanceof Array)){for(var e=[],t=0;t<this._len;t++)e[t]=this.data[t];this.data=e}},e.prototype.toStatic=function(){if(this._saveData){this._drawPendingPt();var e=this.data;e instanceof Array&&(e.length=this._len,hP&&this._len>11&&(this.data=new Float32Array(e)))}},e.prototype.getBoundingRect=function(){tP[0]=tP[1]=iP[0]=iP[1]=Number.MAX_VALUE,nP[0]=nP[1]=aP[0]=aP[1]=-Number.MAX_VALUE;var e,t=this.data,n=0,i=0,a=0,r=0;for(e=0;e<this._len;){var s=t[e++],o=1===e;switch(o&&(a=n=t[e],r=i=t[e+1]),s){case Xz.M:n=a=t[e++],i=r=t[e++],iP[0]=a,iP[1]=r,aP[0]=a,aP[1]=r;break;case Xz.L:Wz(n,i,t[e],t[e+1],iP,aP),n=t[e++],i=t[e++];break;case Xz.C:Kz(n,i,t[e++],t[e++],t[e++],t[e++],t[e],t[e+1],iP,aP),n=t[e++],i=t[e++];break;case Xz.Q:Zz(n,i,t[e++],t[e++],t[e],t[e+1],iP,aP),n=t[e++],i=t[e++];break;case Xz.A:var l=t[e++],c=t[e++],d=t[e++],u=t[e++],h=t[e++],p=t[e++]+h;e+=1;var g=!t[e++];o&&(a=oP(h)*d+l,r=lP(h)*u+c),Yz(l,c,d,u,h,p,g,iP,aP),n=oP(p)*d+l,i=lP(p)*u+c;break;case Xz.R:Wz(a=n=t[e++],r=i=t[e++],a+t[e++],r+t[e++],iP,aP);break;case Xz.Z:n=a,i=r}QI(tP,tP,iP),KI(nP,nP,aP)}return 0===e&&(tP[0]=tP[1]=nP[0]=nP[1]=0),new GD(tP[0],tP[1],nP[0]-tP[0],nP[1]-tP[1])},e.prototype._calculateLength=function(){var e=this.data,t=this._len,n=this._ux,i=this._uy,a=0,r=0,s=0,o=0;this._pathSegLen||(this._pathSegLen=[]);for(var l=this._pathSegLen,c=0,d=0,u=0;u<t;){var h=e[u++],p=1===u;p&&(s=a=e[u],o=r=e[u+1]);var g=-1;switch(h){case Xz.M:a=s=e[u++],r=o=e[u++];break;case Xz.L:var v=e[u++],f=(b=e[u++])-r;(cP(M=v-a)>n||cP(f)>i||u===t-1)&&(g=Math.sqrt(M*M+f*f),a=v,r=b);break;case Xz.C:var m=e[u++],y=e[u++],b=(v=e[u++],e[u++]),w=e[u++],k=e[u++];g=LT(a,r,m,y,v,b,w,k,10),a=w,r=k;break;case Xz.Q:g=VT(a,r,m=e[u++],y=e[u++],v=e[u++],b=e[u++],10),a=v,r=b;break;case Xz.A:var S=e[u++],x=e[u++],_=e[u++],C=e[u++],I=e[u++],D=e[u++],T=D+I;u+=1,p&&(s=oP(I)*_+S,o=lP(I)*C+x),g=sP(_,C)*rP(uP,Math.abs(D)),a=oP(T)*_+S,r=lP(T)*C+x;break;case Xz.R:s=a=e[u++],o=r=e[u++],g=2*e[u++]+2*e[u++];break;case Xz.Z:var M=s-a;f=o-r;g=Math.sqrt(M*M+f*f),a=s,r=o}g>=0&&(l[d++]=g,c+=g)}return this._pathLen=c,c},e.prototype.rebuildPath=function(e,t){var n,i,a,r,s,o,l,c,d,u,h=this.data,p=this._ux,g=this._uy,v=this._len,f=t<1,m=0,y=0,b=0;if(!f||(this._pathSegLen||this._calculateLength(),l=this._pathSegLen,c=t*this._pathLen))e:for(var w=0;w<v;){var k=h[w++],S=1===w;switch(S&&(n=a=h[w],i=r=h[w+1]),k!==Xz.L&&b>0&&(e.lineTo(d,u),b=0),k){case Xz.M:n=a=h[w++],i=r=h[w++],e.moveTo(a,r);break;case Xz.L:s=h[w++],o=h[w++];var x=cP(s-a),_=cP(o-r);if(x>p||_>g){if(f){if(m+(Q=l[y++])>c){var C=(c-m)/Q;e.lineTo(a*(1-C)+s*C,r*(1-C)+o*C);break e}m+=Q}e.lineTo(s,o),a=s,r=o,b=0}else{var I=x*x+_*_;I>b&&(d=s,u=o,b=I)}break;case Xz.C:var D=h[w++],T=h[w++],M=h[w++],A=h[w++],E=h[w++],z=h[w++];if(f){if(m+(Q=l[y++])>c){$T(a,D,M,E,C=(c-m)/Q,Jz),$T(r,T,A,z,C,eP),e.bezierCurveTo(Jz[1],eP[1],Jz[2],eP[2],Jz[3],eP[3]);break e}m+=Q}e.bezierCurveTo(D,T,M,A,E,z),a=E,r=z;break;case Xz.Q:D=h[w++],T=h[w++],M=h[w++],A=h[w++];if(f){if(m+(Q=l[y++])>c){jT(a,D,M,C=(c-m)/Q,Jz),jT(r,T,A,C,eP),e.quadraticCurveTo(Jz[1],eP[1],Jz[2],eP[2]);break e}m+=Q}e.quadraticCurveTo(D,T,M,A),a=M,r=A;break;case Xz.A:var P=h[w++],R=h[w++],$=h[w++],O=h[w++],L=h[w++],N=h[w++],F=h[w++],B=!h[w++],j=$>O?$:O,U=cP($-O)>.001,V=L+N,q=!1;if(f)m+(Q=l[y++])>c&&(V=L+N*(c-m)/Q,q=!0),m+=Q;if(U&&e.ellipse?e.ellipse(P,R,$,O,F,L,V,B):e.arc(P,R,j,L,V,B),q)break e;S&&(n=oP(L)*$+P,i=lP(L)*O+R),a=oP(V)*$+P,r=lP(V)*O+R;break;case Xz.R:n=a=h[w],i=r=h[w+1],s=h[w++],o=h[w++];var H=h[w++],W=h[w++];if(f){if(m+(Q=l[y++])>c){var G=c-m;e.moveTo(s,o),e.lineTo(s+rP(G,H),o),(G-=H)>0&&e.lineTo(s+H,o+rP(G,W)),(G-=W)>0&&e.lineTo(s+sP(H-G,0),o+W),(G-=H)>0&&e.lineTo(s,o+sP(W-G,0));break e}m+=Q}e.rect(s,o,H,W);break;case Xz.Z:if(f){var Q;if(m+(Q=l[y++])>c){C=(c-m)/Q;e.lineTo(a*(1-C)+n*C,r*(1-C)+i*C);break e}m+=Q}e.closePath(),a=n,r=i}}},e.prototype.clone=function(){var t=new e,n=this.data;return t.data=n.slice?n.slice():Array.prototype.slice.call(n),t._len=this._len,t},e.prototype.canSave=function(){return!!this._saveData},e.CMD=Xz,e.initDefaultProps=((t=e.prototype)._saveData=!0,t._ux=0,t._uy=0,t._pendingPtDist=0,void(t._version=0)),e}();function mP(e,t,n,i,a,r,s){if(0===a)return!1;var o=a,l=0;if(s>t+o&&s>i+o||s<t-o&&s<i-o||r>e+o&&r>n+o||r<e-o&&r<n-o)return!1;if(e===n)return Math.abs(r-e)<=o/2;var c=(l=(t-i)/(e-n))*r-s+(e*i-n*t)/(e-n);return c*c/(l*l+1)<=o/2*o/2}function yP(e,t,n,i,a,r,s,o,l,c,d){if(0===l)return!1;var u=l;return!(d>t+u&&d>i+u&&d>r+u&&d>o+u||d<t-u&&d<i-u&&d<r-u&&d<o-u||c>e+u&&c>n+u&&c>a+u&&c>s+u||c<e-u&&c<n-u&&c<a-u&&c<s-u)&&OT(e,t,n,i,a,r,s,o,c,d,null)<=u/2}function bP(e,t,n,i,a,r,s,o,l){if(0===s)return!1;var c=s;return!(l>t+c&&l>i+c&&l>r+c||l<t-c&&l<i-c&&l<r-c||o>e+c&&o>n+c&&o>a+c||o<e-c&&o<n-c&&o<a-c)&&UT(e,t,n,i,a,r,o,l,null)<=c/2}var wP=2*Math.PI;function kP(e){return(e%=wP)<0&&(e+=wP),e}var SP=2*Math.PI;function xP(e,t,n,i,a,r,s,o,l){if(0===s)return!1;var c=s;o-=e,l-=t;var d=Math.sqrt(o*o+l*l);if(d-c>n||d+c<n)return!1;if(Math.abs(i-a)%SP<1e-4)return!0;if(r){var u=i;i=kP(a),a=kP(u)}else i=kP(i),a=kP(a);i>a&&(a+=SP);var h=Math.atan2(l,o);return h<0&&(h+=SP),h>=i&&h<=a||h+SP>=i&&h+SP<=a}function _P(e,t,n,i,a,r){if(r>t&&r>i||r<t&&r<i)return 0;if(i===t)return 0;var s=(r-t)/(i-t),o=i<t?1:-1;1!==s&&0!==s||(o=i<t?.5:-.5);var l=s*(n-e)+e;return l===a?1/0:l>a?o:0}var CP=fP.CMD,IP=2*Math.PI;var DP=[-1,-1,-1],TP=[-1,-1];function MP(){var e=TP[0];TP[0]=TP[1],TP[1]=e}function AP(e,t,n,i,a,r,s,o,l,c){if(c>t&&c>i&&c>r&&c>o||c<t&&c<i&&c<r&&c<o)return 0;var d=PT(t,i,r,o,c,DP);if(0===d)return 0;for(var u=0,h=-1,p=void 0,g=void 0,v=0;v<d;v++){var f=DP[v],m=0===f||1===f?.5:1;ET(e,n,a,s,f)<l||(h<0&&(h=RT(t,i,r,o,TP),TP[1]<TP[0]&&h>1&&MP(),p=ET(t,i,r,o,TP[0]),h>1&&(g=ET(t,i,r,o,TP[1]))),2===h?f<TP[0]?u+=p<t?m:-m:f<TP[1]?u+=g<p?m:-m:u+=o<g?m:-m:f<TP[0]?u+=p<t?m:-m:u+=o<p?m:-m)}return u}function EP(e,t,n,i,a,r,s,o){if(o>t&&o>i&&o>r||o<t&&o<i&&o<r)return 0;var l=function(e,t,n,i,a){var r=e-2*t+n,s=2*(t-e),o=e-i,l=0;if(MT(r))AT(s)&&(d=-o/s)>=0&&d<=1&&(a[l++]=d);else{var c=s*s-4*r*o;if(MT(c))(d=-s/(2*r))>=0&&d<=1&&(a[l++]=d);else if(c>0){var d,u=kT(c),h=(-s-u)/(2*r);(d=(-s+u)/(2*r))>=0&&d<=1&&(a[l++]=d),h>=0&&h<=1&&(a[l++]=h)}}return l}(t,i,r,o,DP);if(0===l)return 0;var c=BT(t,i,r);if(c>=0&&c<=1){for(var d=0,u=NT(t,i,r,c),h=0;h<l;h++){var p=0===DP[h]||1===DP[h]?.5:1;NT(e,n,a,DP[h])<s||(DP[h]<c?d+=u<t?p:-p:d+=r<u?p:-p)}return d}p=0===DP[0]||1===DP[0]?.5:1;return NT(e,n,a,DP[0])<s?0:r<t?p:-p}function zP(e,t,n,i,a,r,s,o){if((o-=t)>n||o<-n)return 0;var l=Math.sqrt(n*n-o*o);DP[0]=-l,DP[1]=l;var c=Math.abs(i-a);if(c<1e-4)return 0;if(c>=IP-1e-4){i=0,a=IP;var d=r?1:-1;return s>=DP[0]+e&&s<=DP[1]+e?d:0}if(i>a){var u=i;i=a,a=u}i<0&&(i+=IP,a+=IP);for(var h=0,p=0;p<2;p++){var g=DP[p];if(g+e>s){var v=Math.atan2(o,g);d=r?1:-1;v<0&&(v=IP+v),(v>=i&&v<=a||v+IP>=i&&v+IP<=a)&&(v>Math.PI/2&&v<1.5*Math.PI&&(d=-d),h+=d)}}return h}function PP(e,t,n,i,a){for(var r,s,o,l,c=e.data,d=e.len(),u=0,h=0,p=0,g=0,v=0,f=0;f<d;){var m=c[f++],y=1===f;switch(m===CP.M&&f>1&&(n||(u+=_P(h,p,g,v,i,a))),y&&(g=h=c[f],v=p=c[f+1]),m){case CP.M:h=g=c[f++],p=v=c[f++];break;case CP.L:if(n){if(mP(h,p,c[f],c[f+1],t,i,a))return!0}else u+=_P(h,p,c[f],c[f+1],i,a)||0;h=c[f++],p=c[f++];break;case CP.C:if(n){if(yP(h,p,c[f++],c[f++],c[f++],c[f++],c[f],c[f+1],t,i,a))return!0}else u+=AP(h,p,c[f++],c[f++],c[f++],c[f++],c[f],c[f+1],i,a)||0;h=c[f++],p=c[f++];break;case CP.Q:if(n){if(bP(h,p,c[f++],c[f++],c[f],c[f+1],t,i,a))return!0}else u+=EP(h,p,c[f++],c[f++],c[f],c[f+1],i,a)||0;h=c[f++],p=c[f++];break;case CP.A:var b=c[f++],w=c[f++],k=c[f++],S=c[f++],x=c[f++],_=c[f++];f+=1;var C=!!(1-c[f++]);r=Math.cos(x)*k+b,s=Math.sin(x)*S+w,y?(g=r,v=s):u+=_P(h,p,r,s,i,a);var I=(i-b)*S/k+b;if(n){if(xP(b,w,S,x,x+_,C,t,I,a))return!0}else u+=zP(b,w,S,x,x+_,C,I,a);h=Math.cos(x+_)*k+b,p=Math.sin(x+_)*S+w;break;case CP.R:if(g=h=c[f++],v=p=c[f++],r=g+c[f++],s=v+c[f++],n){if(mP(g,v,r,v,t,i,a)||mP(r,v,r,s,t,i,a)||mP(r,s,g,s,t,i,a)||mP(g,s,g,v,t,i,a))return!0}else u+=_P(r,v,r,s,i,a),u+=_P(g,s,g,v,i,a);break;case CP.Z:if(n){if(mP(h,p,g,v,t,i,a))return!0}else u+=_P(h,p,g,v,i,a);h=g,p=v}}return n||(o=p,l=v,Math.abs(o-l)<1e-4)||(u+=_P(h,p,g,v,i,a)||0),0!==u}var RP=$C({fill:"#000",stroke:null,strokePercent:1,fillOpacity:1,strokeOpacity:1,lineDashOffset:0,lineWidth:1,lineCap:"butt",miterLimit:10,strokeNoScale:!1,strokeFirst:!1},Ez),$P={style:$C({fill:!0,stroke:!0,strokePercent:!0,fillOpacity:!0,strokeOpacity:!0,lineDashOffset:!0,lineWidth:!0,miterLimit:!0},zz.style)},OP=fA.concat(["invisible","culling","z","z2","zlevel","parent"]),LP=function(e){function t(t){return e.call(this,t)||this}var n;return EI(t,e),t.prototype.update=function(){var n=this;e.prototype.update.call(this);var i=this.style;if(i.decal){var a=this._decalEl=this._decalEl||new t;a.buildPath===t.prototype.buildPath&&(a.buildPath=function(e){n.buildPath(e,n.shape)}),a.silent=!0;var r=a.style;for(var s in i)r[s]!==i[s]&&(r[s]=i[s]);r.fill=i.fill?i.decal:null,r.decal=null,r.shadowColor=null,i.strokeFirst&&(r.stroke=null);for(var o=0;o<OP.length;++o)a[OP[o]]=this[OP[o]];a.__dirty|=1}else this._decalEl&&(this._decalEl=null)},t.prototype.getDecalElement=function(){return this._decalEl},t.prototype._init=function(t){var n=WC(t);this.shape=this.getDefaultShape();var i=this.getDefaultStyle();i&&this.useStyle(i);for(var a=0;a<n.length;a++){var r=n[a],s=t[r];"style"===r?this.style?RC(this.style,s):this.useStyle(s):"shape"===r?RC(this.shape,s):e.prototype.attrKV.call(this,r,s)}this.style||this.useStyle({})},t.prototype.getDefaultStyle=function(){return null},t.prototype.getDefaultShape=function(){return{}},t.prototype.canBeInsideText=function(){return this.hasFill()},t.prototype.getInsideTextFill=function(){var e=this.style.fill;if("none"!==e){if(YC(e)){var t=yM(e,0);return t>.5?rA:t>.2?"#eee":sA}if(e)return sA}return rA},t.prototype.getInsideTextStroke=function(e){var t=this.style.fill;if(YC(t)){var n=this.__zr;if(!(!n||!n.isDarkMode())===yM(e,0)<.4)return t}},t.prototype.buildPath=function(e,t,n){},t.prototype.pathUpdated=function(){this.__dirty&=-5},t.prototype.getUpdatedPathProxy=function(e){return!this.path&&this.createPathProxy(),this.path.beginPath(),this.buildPath(this.path,this.shape,e),this.path},t.prototype.createPathProxy=function(){this.path=new fP(!1)},t.prototype.hasStroke=function(){var e=this.style,t=e.stroke;return!(null==t||"none"===t||!(e.lineWidth>0))},t.prototype.hasFill=function(){var e=this.style.fill;return null!=e&&"none"!==e},t.prototype.getBoundingRect=function(){var e=this._rect,t=this.style,n=!e;if(n){var i=!1;this.path||(i=!0,this.createPathProxy());var a=this.path;(i||4&this.__dirty)&&(a.beginPath(),this.buildPath(a,this.shape,!1),this.pathUpdated()),e=a.getBoundingRect()}if(this._rect=e,this.hasStroke()&&this.path&&this.path.len()>0){var r=this._rectStroke||(this._rectStroke=e.clone());if(this.__dirty||n){r.copy(e);var s=t.strokeNoScale?this.getLineScale():1,o=t.lineWidth;if(!this.hasFill()){var l=this.strokeContainThreshold;o=Math.max(o,null==l?4:l)}s>1e-10&&(r.width+=o/s,r.height+=o/s,r.x-=o/s/2,r.y-=o/s/2)}return r}return e},t.prototype.contain=function(e,t){var n=this.transformCoordToLocal(e,t),i=this.getBoundingRect(),a=this.style;if(e=n[0],t=n[1],i.contain(e,t)){var r=this.path;if(this.hasStroke()){var s=a.lineWidth,o=a.strokeNoScale?this.getLineScale():1;if(o>1e-10&&(this.hasFill()||(s=Math.max(s,this.strokeContainThreshold)),function(e,t,n,i){return PP(e,t,!0,n,i)}(r,s/o,e,t)))return!0}if(this.hasFill())return function(e,t,n){return PP(e,0,!1,t,n)}(r,e,t)}return!1},t.prototype.dirtyShape=function(){this.__dirty|=4,this._rect&&(this._rect=null),this._decalEl&&this._decalEl.dirtyShape(),this.markRedraw()},t.prototype.dirty=function(){this.dirtyStyle(),this.dirtyShape()},t.prototype.animateShape=function(e){return this.animate("shape",e)},t.prototype.updateDuringAnimation=function(e){"style"===e?this.dirtyStyle():"shape"===e?this.dirtyShape():this.markRedraw()},t.prototype.attrKV=function(t,n){"shape"===t?this.setShape(n):e.prototype.attrKV.call(this,t,n)},t.prototype.setShape=function(e,t){var n=this.shape;return n||(n=this.shape={}),"string"==typeof e?n[e]=t:RC(n,e),this.dirtyShape(),this},t.prototype.shapeChanged=function(){return!!(4&this.__dirty)},t.prototype.createStyle=function(e){return xI(RP,e)},t.prototype._innerSaveToNormal=function(t){e.prototype._innerSaveToNormal.call(this,t);var n=this._normalState;t.shape&&!n.shape&&(n.shape=RC({},this.shape))},t.prototype._applyStateObj=function(t,n,i,a,r,s){e.prototype._applyStateObj.call(this,t,n,i,a,r,s);var o,l=!(n&&a);if(n&&n.shape?r?a?o=n.shape:(o=RC({},i.shape),RC(o,n.shape)):(o=RC({},a?this.shape:i.shape),RC(o,n.shape)):l&&(o=i.shape),o)if(r){this.shape=RC({},this.shape);for(var c={},d=WC(o),u=0;u<d.length;u++){var h=d[u];"object"==typeof o[h]?this.shape[h]=o[h]:c[h]=o[h]}this._transitionState(t,{shape:c},s)}else this.shape=o,this.dirtyShape()},t.prototype._mergeStates=function(t){for(var n,i=e.prototype._mergeStates.call(this,t),a=0;a<t.length;a++){var r=t[a];r.shape&&(n=n||{},this._mergeStyle(n,r.shape))}return n&&(i.shape=n),i},t.prototype.getAnimationStyleProps=function(){return $P},t.prototype.isZeroArea=function(){return!1},t.extend=function(e){var n=function(t){function n(n){var i=t.call(this,n)||this;return e.init&&e.init.call(i,n),i}return EI(n,t),n.prototype.getDefaultStyle=function(){return zC(e.style)},n.prototype.getDefaultShape=function(){return zC(e.shape)},n}(t);for(var i in e)"function"==typeof e[i]&&(n.prototype[i]=e[i]);return n},t.initDefaultProps=((n=t.prototype).type="path",n.strokeContainThreshold=5,n.segmentIgnoreThreshold=0,n.subPixelOptimize=!1,n.autoBatch=!1,void(n.__dirty=7)),t}($z),NP=$C({strokeFirst:!0,font:gC,x:0,y:0,textAlign:"left",textBaseline:"top",miterLimit:2},RP),FP=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return EI(t,e),t.prototype.hasStroke=function(){return Mz(this.style)},t.prototype.hasFill=function(){var e=this.style.fill;return null!=e&&"none"!==e},t.prototype.createStyle=function(e){return xI(NP,e)},t.prototype.setBoundingRect=function(e){this._rect=e},t.prototype.getBoundingRect=function(){var e,t,n;return this._rect||(this._rect=(e=this.style,t=Dz(e.text),n=e.font,Tz(e,SA(yA(n),t),DA(n),null))),this._rect},t.initDefaultProps=void(t.prototype.dirtyRectTolerance=10),t}($z);FP.prototype.type="tspan";var BP=$C({x:0,y:0},Ez),jP={style:$C({x:!0,y:!0,width:!0,height:!0,sx:!0,sy:!0,sWidth:!0,sHeight:!0},zz.style)};var UP=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return EI(t,e),t.prototype.createStyle=function(e){return xI(BP,e)},t.prototype._getSize=function(e){var t=this.style,n=t[e];if(null!=n)return n;var i,a=(i=t.image)&&"string"!=typeof i&&i.width&&i.height?t.image:this.__image;if(!a)return 0;var r="width"===e?"height":"width",s=t[r];return null==s?a[e]:a[e]/a[r]*s},t.prototype.getWidth=function(){return this._getSize("width")},t.prototype.getHeight=function(){return this._getSize("height")},t.prototype.getAnimationStyleProps=function(){return jP},t.prototype.getBoundingRect=function(){var e=this.style;return this._rect||(this._rect=new GD(e.x||0,e.y||0,this.getWidth(),this.getHeight())),this._rect},t}($z);UP.prototype.type="image";var VP=Math.round;function qP(e,t,n){if(t){var i=t.x1,a=t.x2,r=t.y1,s=t.y2;e.x1=i,e.x2=a,e.y1=r,e.y2=s;var o=n&&n.lineWidth;return o?(VP(2*i)===VP(2*a)&&(e.x1=e.x2=WP(i,o,!0)),VP(2*r)===VP(2*s)&&(e.y1=e.y2=WP(r,o,!0)),e):e}}function HP(e,t,n){if(t){var i=t.x,a=t.y,r=t.width,s=t.height;e.x=i,e.y=a,e.width=r,e.height=s;var o=n&&n.lineWidth;return o?(e.x=WP(i,o,!0),e.y=WP(a,o,!0),e.width=Math.max(WP(i+r,o,!1)-e.x,0===r?0:1),e.height=Math.max(WP(a+s,o,!1)-e.y,0===s?0:1),e):e}}function WP(e,t,n){if(!t)return e;var i=VP(2*e);return(i+VP(t))%2==0?i/2:(i+(n?1:-1))/2}var GP=function(){return function(){this.x=0,this.y=0,this.width=0,this.height=0}}(),QP={},KP=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultShape=function(){return new GP},t.prototype.buildPath=function(e,t){var n,i,a,r;if(this.subPixelOptimize){var s=HP(QP,t,this.style);n=s.x,i=s.y,a=s.width,r=s.height,s.r=t.r,t=s}else n=t.x,i=t.y,a=t.width,r=t.height;t.r?function(e,t){var n,i,a,r,s,o=t.x,l=t.y,c=t.width,d=t.height,u=t.r;c<0&&(o+=c,c=-c),d<0&&(l+=d,d=-d),"number"==typeof u?n=i=a=r=u:u instanceof Array?1===u.length?n=i=a=r=u[0]:2===u.length?(n=a=u[0],i=r=u[1]):3===u.length?(n=u[0],i=r=u[1],a=u[2]):(n=u[0],i=u[1],a=u[2],r=u[3]):n=i=a=r=0,n+i>c&&(n*=c/(s=n+i),i*=c/s),a+r>c&&(a*=c/(s=a+r),r*=c/s),i+a>d&&(i*=d/(s=i+a),a*=d/s),n+r>d&&(n*=d/(s=n+r),r*=d/s),e.moveTo(o+n,l),e.lineTo(o+c-i,l),0!==i&&e.arc(o+c-i,l+i,i,-Math.PI/2,0),e.lineTo(o+c,l+d-a),0!==a&&e.arc(o+c-a,l+d-a,a,0,Math.PI/2),e.lineTo(o+r,l+d),0!==r&&e.arc(o+r,l+d-r,r,Math.PI/2,Math.PI),e.lineTo(o,l+n),0!==n&&e.arc(o+n,l+n,n,Math.PI,1.5*Math.PI)}(e,t):e.rect(n,i,a,r)},t.prototype.isZeroArea=function(){return!this.shape.width||!this.shape.height},t}(LP);KP.prototype.type="rect";var ZP={fill:"#000"},YP={},XP={style:$C({fill:!0,stroke:!0,fillOpacity:!0,strokeOpacity:!0,lineWidth:!0,fontSize:!0,lineHeight:!0,width:!0,height:!0,textShadowColor:!0,textShadowBlur:!0,textShadowOffsetX:!0,textShadowOffsetY:!0,backgroundColor:!0,padding:!0,borderColor:!0,borderWidth:!0,borderRadius:!0},zz.style)},JP=function(e){function t(t){var n=e.call(this)||this;return n.type="text",n._children=[],n._defaultStyle=ZP,n.attr(t),n}return EI(t,e),t.prototype.childrenRef=function(){return this._children},t.prototype.update=function(){e.prototype.update.call(this),this.styleChanged()&&this._updateSubTexts();for(var t=0;t<this._children.length;t++){var n=this._children[t];n.zlevel=this.zlevel,n.z=this.z,n.z2=this.z2,n.culling=this.culling,n.cursor=this.cursor,n.invisible=this.invisible}},t.prototype.updateTransform=function(){var t=this.innerTransformable;t?(t.updateTransform(),t.transform&&(this.transform=t.transform)):e.prototype.updateTransform.call(this)},t.prototype.getLocalTransform=function(t){var n=this.innerTransformable;return n?n.getLocalTransform(t):e.prototype.getLocalTransform.call(this,t)},t.prototype.getComputedTransform=function(){return this.__hostTarget&&(this.__hostTarget.getComputedTransform(),this.__hostTarget.updateInnerText(!0)),e.prototype.getComputedTransform.call(this)},t.prototype._updateSubTexts=function(){var e;this._childCursor=0,rR(e=this.style),jC(e.rich,rR),this.style.rich?this._updateRichTexts():this._updatePlainTexts(),this._children.length=this._childCursor,this.styleUpdated()},t.prototype.addSelfToZr=function(t){e.prototype.addSelfToZr.call(this,t);for(var n=0;n<this._children.length;n++)this._children[n].__zr=t},t.prototype.removeSelfFromZr=function(t){e.prototype.removeSelfFromZr.call(this,t);for(var n=0;n<this._children.length;n++)this._children[n].__zr=null},t.prototype.getBoundingRect=function(){if(this.styleChanged()&&this._updateSubTexts(),!this._rect){for(var e=new GD(0,0,0,0),t=this._children,n=[],i=null,a=0;a<t.length;a++){var r=t[a],s=r.getBoundingRect(),o=r.getLocalTransform(n);o?(e.copy(s),e.applyTransform(o),(i=i||e.clone()).union(e)):(i=i||s.clone()).union(s)}this._rect=i||e}return this._rect},t.prototype.setDefaultTextStyle=function(e){this._defaultStyle=e||ZP},t.prototype.setTextContent=function(e){},t.prototype._mergeStyle=function(e,t){if(!t)return e;var n=t.rich,i=e.rich||n&&{};return RC(e,t),n&&i?(this._mergeRich(i,n),e.rich=i):i&&(e.rich=i),e},t.prototype._mergeRich=function(e,t){for(var n=WC(t),i=0;i<n.length;i++){var a=n[i];e[a]=e[a]||{},RC(e[a],t[a])}},t.prototype.getAnimationStyleProps=function(){return XP},t.prototype._getOrCreateChild=function(e){var t=this._children[this._childCursor];return t&&t instanceof e||(t=new e),this._children[this._childCursor++]=t,t.__zr=this.__zr,t.parent=this,t},t.prototype._updatePlainTexts=function(){var e=this.style,t=e.font||gC,n=e.padding,i=this._defaultStyle,a=e.x||0,r=e.y||0,s=e.align||i.align||"left",o=e.verticalAlign||i.verticalAlign||"top";_z(YP,i.overflowRect,a,r,s,o),a=YP.baseX,r=YP.baseY;var l=function(e,t,n,i){var a=Dz(e),r=t.overflow,s=t.padding,o=s?s[1]+s[3]:0,l=s?s[0]+s[2]:0,c=t.font,d="truncate"===r,u=DA(c),h=cI(t.lineHeight,u),p="truncate"===t.lineOverflow,g=!1,v=t.width;null==v&&null!=n&&(v=n-o);var f,m=t.height;null==m&&null!=i&&(m=i-l);var y=(f=null==v||"break"!==r&&"breakAll"!==r?a?a.split("\n"):[]:a?xz(a,t.font,v,"breakAll"===r,0).lines:[]).length*h;if(null==m&&(m=y),y>m&&p){var b=Math.floor(m/h);g=g||f.length>b,y=(f=f.slice(0,b)).length*h}if(a&&d&&null!=v)for(var w=gz(v,c,t.ellipsis,{minChar:t.truncateMinChar,placeholder:t.placeholder}),k={},S=0;S<f.length;S++)vz(k,f[S],w),f[S]=k.textLine,g=g||k.isTruncated;var x=m,_=0,C=yA(c);for(S=0;S<f.length;S++)_=Math.max(SA(C,f[S]),_);null==v&&(v=_);var I=v;return{lines:f,height:m,outerWidth:I+=o,outerHeight:x+=l,lineHeight:h,calculatedLineHeight:u,contentWidth:_,contentHeight:y,width:v,isTruncated:g}}(cR(e),e,YP.outerWidth,YP.outerHeight),c=dR(e),d=!!e.backgroundColor,u=l.outerHeight,h=l.outerWidth,p=l.lines,g=l.lineHeight;this.isTruncated=!!l.isTruncated;var v=a,f=IA(r,l.contentHeight,o);if(c||n){var m=CA(a,h,s),y=IA(r,u,o);c&&this._renderBackground(e,e,m,y,h,u)}f+=g/2,n&&(v=lR(a,s,n),"top"===o?f+=n[0]:"bottom"===o&&(f-=n[2]));for(var b=0,w=!1,k=!1,S=(oR("fill"in e?e.fill:(k=!0,i.fill))),x=(sR("stroke"in e?e.stroke:d||i.autoStroke&&!k?null:(b=2,w=!0,i.stroke))),_=e.textShadowBlur>0,C=0;C<p.length;C++){var I=this._getOrCreateChild(FP),D=I.createStyle();I.useStyle(D),D.text=p[C],D.x=v,D.y=f,D.textAlign=s,D.textBaseline="middle",D.opacity=e.opacity,D.strokeFirst=!0,_&&(D.shadowBlur=e.textShadowBlur||0,D.shadowColor=e.textShadowColor||"transparent",D.shadowOffsetX=e.textShadowOffsetX||0,D.shadowOffsetY=e.textShadowOffsetY||0),D.stroke=x,D.fill=S,x&&(D.lineWidth=e.lineWidth||b,D.lineDash=e.lineDash,D.lineDashOffset=e.lineDashOffset||0),D.font=t,aR(D,e),f+=g,I.setBoundingRect(Tz(D,l.contentWidth,l.calculatedLineHeight,w?0:null))}},t.prototype._updateRichTexts=function(){var e=this.style,t=this._defaultStyle,n=e.align||t.align,i=e.verticalAlign||t.verticalAlign,a=e.x||0,r=e.y||0;_z(YP,t.overflowRect,a,r,n,i),a=YP.baseX,r=YP.baseY;var s=function(e,t,n,i,a){var r=new bz,s=Dz(e);if(!s)return r;var o=t.padding,l=o?o[1]+o[3]:0,c=o?o[0]+o[2]:0,d=t.width;null==d&&null!=n&&(d=n-l);var u=t.height;null==u&&null!=i&&(u=i-c);for(var h,p=t.overflow,g="break"!==p&&"breakAll"!==p||null==d?null:{width:d,accumWidth:0,breakAll:"breakAll"===p},v=hz.lastIndex=0;null!=(h=hz.exec(s));){var f=h.index;f>v&&wz(r,s.substring(v,f),t,g),wz(r,h[2],t,g,h[1]),v=hz.lastIndex}v<s.length&&wz(r,s.substring(v,s.length),t,g);var m=[],y=0,b=0,w="truncate"===p,k="truncate"===t.lineOverflow,S={};function x(e,t,n){e.width=t,e.lineHeight=n,y+=n,b=Math.max(b,t)}e:for(var _=0;_<r.lines.length;_++){for(var C=r.lines[_],I=0,D=0,T=0;T<C.tokens.length;T++){var M=(B=C.tokens[T]).styleName&&t.rich[B.styleName]||{},A=B.textPadding=M.padding,E=A?A[1]+A[3]:0,z=B.font=M.font||t.font;B.contentHeight=DA(z);var P=cI(M.height,B.contentHeight);if(B.innerHeight=P,A&&(P+=A[0]+A[2]),B.height=P,B.lineHeight=dI(M.lineHeight,t.lineHeight,P),B.align=M&&M.align||a,B.verticalAlign=M&&M.verticalAlign||"middle",k&&null!=u&&y+B.lineHeight>u){var R=r.lines.length;T>0?(C.tokens=C.tokens.slice(0,T),x(C,D,I),r.lines=r.lines.slice(0,_+1)):r.lines=r.lines.slice(0,_),r.isTruncated=r.isTruncated||r.lines.length<R;break e}var $=M.width,O=null==$||"auto"===$;if("string"==typeof $&&"%"===$.charAt($.length-1))B.percentWidth=$,m.push(B),B.contentWidth=SA(yA(z),B.text);else{if(O){var L=M.backgroundColor,N=L&&L.image;N&&uz(N=lz(N))&&(B.width=Math.max(B.width,N.width*P/N.height))}var F=w&&null!=d?d-D:null;null!=F&&F<B.width?!O||F<E?(B.text="",B.width=B.contentWidth=0):(pz(S,B.text,F-E,z,t.ellipsis,{minChar:t.truncateMinChar}),B.text=S.text,r.isTruncated=r.isTruncated||S.isTruncated,B.width=B.contentWidth=SA(yA(z),B.text)):B.contentWidth=SA(yA(z),B.text)}B.width+=E,D+=B.width,M&&(I=Math.max(I,B.lineHeight))}x(C,D,I)}for(r.outerWidth=r.width=cI(d,b),r.outerHeight=r.height=cI(u,y),r.contentHeight=y,r.contentWidth=b,r.outerWidth+=l,r.outerHeight+=c,_=0;_<m.length;_++){var B,j=(B=m[_]).percentWidth;B.width=parseInt(j,10)/100*r.width}return r}(cR(e),e,YP.outerWidth,YP.outerHeight,n),o=s.width,l=s.outerWidth,c=s.outerHeight,d=e.padding;this.isTruncated=!!s.isTruncated;var u=CA(a,l,n),h=IA(r,c,i),p=u,g=h;d&&(p+=d[3],g+=d[0]);var v=p+o;dR(e)&&this._renderBackground(e,e,u,h,l,c);for(var f=!!e.backgroundColor,m=0;m<s.lines.length;m++){for(var y=s.lines[m],b=y.tokens,w=b.length,k=y.lineHeight,S=y.width,x=0,_=p,C=v,I=w-1,D=void 0;x<w&&(!(D=b[x]).align||"left"===D.align);)this._placeToken(D,e,k,g,_,"left",f),S-=D.width,_+=D.width,x++;for(;I>=0&&"right"===(D=b[I]).align;)this._placeToken(D,e,k,g,C,"right",f),S-=D.width,C-=D.width,I--;for(_+=(o-(_-p)-(v-C)-S)/2;x<=I;)D=b[x],this._placeToken(D,e,k,g,_+D.width/2,"center",f),_+=D.width,x++;g+=k}},t.prototype._placeToken=function(e,t,n,i,a,r,s){var o=t.rich[e.styleName]||{};o.text=e.text;var l=e.verticalAlign,c=i+n/2;"top"===l?c=i+e.height/2:"bottom"===l&&(c=i+n-e.height/2),!e.isLineHolder&&dR(o)&&this._renderBackground(o,t,"right"===r?a-e.width:"center"===r?a-e.width/2:a,c-e.height/2,e.width,e.height);var d=!!o.backgroundColor,u=e.textPadding;u&&(a=lR(a,r,u),c-=e.height/2-u[0]-e.innerHeight/2);var h=this._getOrCreateChild(FP),p=h.createStyle();h.useStyle(p);var g=this._defaultStyle,v=!1,f=0,m=!1,y=oR("fill"in o?o.fill:"fill"in t?t.fill:(v=!0,g.fill)),b=sR("stroke"in o?o.stroke:"stroke"in t?t.stroke:d||s||g.autoStroke&&!v?null:(f=2,m=!0,g.stroke)),w=o.textShadowBlur>0||t.textShadowBlur>0;p.text=e.text,p.x=a,p.y=c,w&&(p.shadowBlur=o.textShadowBlur||t.textShadowBlur||0,p.shadowColor=o.textShadowColor||t.textShadowColor||"transparent",p.shadowOffsetX=o.textShadowOffsetX||t.textShadowOffsetX||0,p.shadowOffsetY=o.textShadowOffsetY||t.textShadowOffsetY||0),p.textAlign=r,p.textBaseline="middle",p.font=e.font||gC,p.opacity=dI(o.opacity,t.opacity,1),aR(p,o),b&&(p.lineWidth=dI(o.lineWidth,t.lineWidth,f),p.lineDash=cI(o.lineDash,t.lineDash),p.lineDashOffset=t.lineDashOffset||0,p.stroke=b),y&&(p.fill=y),h.setBoundingRect(Tz(p,e.contentWidth,e.contentHeight,m?0:null))},t.prototype._renderBackground=function(e,t,n,i,a,r){var s,o,l,c=e.backgroundColor,d=e.borderWidth,u=e.borderColor,h=c&&c.image,p=c&&!h,g=e.borderRadius,v=this;if(p||e.lineHeight||d&&u){(s=this._getOrCreateChild(KP)).useStyle(s.createStyle()),s.style.fill=null;var f=s.shape;f.x=n,f.y=i,f.width=a,f.height=r,f.r=g,s.dirtyShape()}if(p)(l=s.style).fill=c||null,l.fillOpacity=cI(e.fillOpacity,1);else if(h){(o=this._getOrCreateChild(UP)).onload=function(){v.dirtyStyle()};var m=o.style;m.image=c.image,m.x=n,m.y=i,m.width=a,m.height=r}d&&u&&((l=s.style).lineWidth=d,l.stroke=u,l.strokeOpacity=cI(e.strokeOpacity,1),l.lineDash=e.borderDash,l.lineDashOffset=e.borderDashOffset||0,s.strokeContainThreshold=0,s.hasFill()&&s.hasStroke()&&(l.strokeFirst=!0,l.lineWidth*=2));var y=(s||o).style;y.shadowBlur=e.shadowBlur||0,y.shadowColor=e.shadowColor||"transparent",y.shadowOffsetX=e.shadowOffsetX||0,y.shadowOffsetY=e.shadowOffsetY||0,y.opacity=dI(e.opacity,t.opacity,1)},t.makeFont=function(e){var t="";return function(e){return null!=e.fontSize||e.fontFamily||e.fontWeight}(e)&&(t=[e.fontStyle,e.fontWeight,iR(e.fontSize),e.fontFamily||"sans-serif"].join(" ")),t&&gI(t)||e.textFont||e.font},t}($z),eR={left:!0,right:1,center:1},tR={top:1,bottom:1,middle:1},nR=["fontStyle","fontWeight","fontSize","fontFamily"];function iR(e){return"string"!=typeof e||-1===e.indexOf("px")&&-1===e.indexOf("rem")&&-1===e.indexOf("em")?isNaN(+e)?"12px":e+"px":e}function aR(e,t){for(var n=0;n<nR.length;n++){var i=nR[n],a=t[i];null!=a&&(e[i]=a)}}function rR(e){if(e){e.font=JP.makeFont(e);var t=e.align;"middle"===t&&(t="center"),e.align=null==t||eR[t]?t:"left";var n=e.verticalAlign;"center"===n&&(n="middle"),e.verticalAlign=null==n||tR[n]?n:"top",e.padding&&(e.padding=hI(e.padding))}}function sR(e,t){return null==e||t<=0||"transparent"===e||"none"===e?null:e.image||e.colorStops?"#000":e}function oR(e){return null==e||"none"===e?null:e.image||e.colorStops?"#000":e}function lR(e,t,n){return"right"===t?e-n[1]:"center"===t?e+n[3]/2-n[1]/2:e+n[3]}function cR(e){var t=e.text;return null!=t&&(t+=""),t}function dR(e){return!!(e.backgroundColor||e.lineHeight||e.borderWidth&&e.borderColor)}var uR=BE(),hR=1,pR={},gR=BE(),vR=BE(),fR=["emphasis","blur","select"],mR=["normal","emphasis","blur","select"],yR="highlight",bR="downplay",wR="select",kR="unselect",SR="toggleSelect",xR="selectchanged";function _R(e){return null!=e&&"none"!==e}function CR(e,t,n){e.onHoverStateChange&&(e.hoverState||0)!==n&&e.onHoverStateChange(t),e.hoverState=n}function IR(e){CR(e,"emphasis",2)}function DR(e){2===e.hoverState&&CR(e,"normal",0)}function TR(e){CR(e,"blur",1)}function MR(e){1===e.hoverState&&CR(e,"normal",0)}function AR(e){e.selected=!0}function ER(e){e.selected=!1}function zR(e,t,n){t(e,n)}function PR(e,t,n){zR(e,t,n),e.isGroup&&e.traverse(function(e){zR(e,t,n)})}function RR(e,t){switch(t){case"emphasis":e.hoverState=2;break;case"normal":e.hoverState=0;break;case"blur":e.hoverState=1;break;case"select":e.selected=!0}}function $R(e,t){var n=this.states[e];if(this.style){if("emphasis"===e)return function(e,t,n,i){var a=n&&LC(n,"select")>=0,r=!1;if(e instanceof LP){var s=gR(e),o=a&&s.selectFill||s.normalFill,l=a&&s.selectStroke||s.normalStroke;if(_R(o)||_R(l)){var c=(i=i||{}).style||{};"inherit"===c.fill?(r=!0,i=RC({},i),(c=RC({},c)).fill=o):!_R(c.fill)&&_R(o)?(r=!0,i=RC({},i),(c=RC({},c)).fill=wM(o)):!_R(c.stroke)&&_R(l)&&(r||(i=RC({},i),c=RC({},c)),c.stroke=wM(l)),i.style=c}}if(i&&null==i.z2){r||(i=RC({},i));var d=e.z2EmphasisLift;i.z2=e.z2+(null!=d?d:10)}return i}(this,0,t,n);if("blur"===e)return function(e,t,n){var i=LC(e.currentStates,t)>=0,a=e.style.opacity,r=i?null:function(e,t,n,i){for(var a=e.style,r={},s=0;s<t.length;s++){var o=t[s],l=a[o];r[o]=null==l?i&&i[o]:l}for(s=0;s<e.animators.length;s++){var c=e.animators[s];c.__fromStateTransition&&c.__fromStateTransition.indexOf(n)<0&&"style"===c.targetName&&c.saveTo(r,t)}return r}(e,["opacity"],t,{opacity:1}),s=(n=n||{}).style||{};return null==s.opacity&&(n=RC({},n),s=RC({opacity:i?a:.1*r.opacity},s),n.style=s),n}(this,e,n);if("select"===e)return function(e,t,n){if(n&&null==n.z2){n=RC({},n);var i=e.z2SelectLift;n.z2=e.z2+(null!=i?i:9)}return n}(this,0,n)}return n}function OR(e){e.stateProxy=$R;var t=e.getTextContent(),n=e.getTextGuideLine();t&&(t.stateProxy=$R),n&&(n.stateProxy=$R)}function LR(e,t){!HR(e,t)&&!e.__highByOuter&&PR(e,IR)}function NR(e,t){!HR(e,t)&&!e.__highByOuter&&PR(e,DR)}function FR(e,t){e.__highByOuter|=1<<(t||0),PR(e,IR)}function BR(e,t){!(e.__highByOuter&=~(1<<(t||0)))&&PR(e,DR)}function jR(e){PR(e,TR)}function UR(e){PR(e,MR)}function VR(e){PR(e,AR)}function qR(e){PR(e,ER)}function HR(e,t){return e.__highDownSilentOnTouch&&t.zrByTouch}function WR(e){var t=e.getModel(),n=[],i=[];t.eachComponent(function(t,a){var r=vR(a),s="series"===t,o=s?e.getViewOfSeriesModel(a):e.getViewOfComponentModel(a);!s&&i.push(o),r.isBlured&&(o.group.traverse(function(e){MR(e)}),s&&n.push(a)),r.isBlured=!1}),jC(i,function(e){e&&e.toggleBlurSeries&&e.toggleBlurSeries(n,!1,t)})}function GR(e,t,n,i){var a=i.getModel();function r(e,t){for(var n=0;n<t.length;n++){var i=e.getItemGraphicEl(t[n]);i&&UR(i)}}if(n=n||"coordinateSystem",null!=e&&t&&"none"!==t){var s=a.getSeriesByIndex(e),o=s.coordinateSystem;o&&o.master&&(o=o.master);var l=[];a.eachSeries(function(e){var a=s===e,c=e.coordinateSystem;if(c&&c.master&&(c=c.master),!("series"===n&&!a||"coordinateSystem"===n&&!(c&&o?c===o:a)||"series"===t&&a)){if(i.getViewOfSeriesModel(e).group.traverse(function(e){e.__highByOuter&&a&&"self"===t||TR(e)}),BC(t))r(e.getData(),t);else if(eI(t))for(var d=WC(t),u=0;u<d.length;u++)r(e.getData(d[u]),t[d[u]]);l.push(e),vR(e).isBlured=!0}}),a.eachComponent(function(e,t){if("series"!==e){var n=i.getViewOfComponentModel(t);n&&n.toggleBlurSeries&&n.toggleBlurSeries(l,!0,a)}})}}function QR(e,t,n){if(null!=e&&null!=t){var i=n.getModel().getComponent(e,t);if(i){vR(i).isBlured=!0;var a=n.getViewOfComponentModel(i);a&&a.focusBlurEnabled&&a.group.traverse(function(e){TR(e)})}}}function KR(e,t,n,i){var a={focusSelf:!1,dispatchers:null};if(null==e||"series"===e||null==t||null==n)return a;var r=i.getModel().getComponent(e,t);if(!r)return a;var s=i.getViewOfComponentModel(r);if(!s||!s.findHighDownDispatchers)return a;for(var o,l=s.findHighDownDispatchers(n),c=0;c<l.length;c++)if("self"===uR(l[c]).focus){o=!0;break}return{focusSelf:o,dispatchers:l}}function ZR(e){jC(e.getAllData(),function(t){var n=t.data,i=t.type;n.eachItemGraphicEl(function(t,n){e.isSelected(n,i)?VR(t):qR(t)})})}function YR(e){var t=[];return e.eachSeries(function(e){jC(e.getAllData(),function(n){n.data;var i=n.type,a=e.getSelectedDataIndices();if(a.length>0){var r={dataIndex:a,seriesIndex:e.seriesIndex};null!=i&&(r.dataType=i),t.push(r)}})}),t}function XR(e,t,n){i$(e,!0),PR(e,OR),function(e,t,n){var i=uR(e);null!=t?(i.focus=t,i.blurScope=n):i.focus&&(i.focus=null)}(e,t,n)}function JR(e,t,n,i){i?function(e){i$(e,!1)}(e):XR(e,t,n)}var e$=["emphasis","blur","select"],t$={itemStyle:"getItemStyle",lineStyle:"getLineStyle",areaStyle:"getAreaStyle"};function n$(e,t,n,i){n=n||"itemStyle";for(var a=0;a<e$.length;a++){var r=e$[a],s=t.getModel([r,n]);e.ensureState(r).style=s[t$[n]]()}}function i$(e,t){var n=!1===t,i=e;e.highDownSilentOnTouch&&(i.__highDownSilentOnTouch=e.highDownSilentOnTouch),n&&!i.__highDownDispatcher||(i.__highByOuter=i.__highByOuter||0,i.__highDownDispatcher=!n)}function a$(e){return!(!e||!e.__highDownDispatcher)}function r$(e){var t=e.type;return t===wR||t===kR||t===SR}function s$(e){var t=e.type;return t===yR||t===bR}var o$=fP.CMD,l$=[[],[],[]],c$=Math.sqrt,d$=Math.atan2;var u$=Math.sqrt,h$=Math.sin,p$=Math.cos,g$=Math.PI;function v$(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function f$(e,t){return(e[0]*t[0]+e[1]*t[1])/(v$(e)*v$(t))}function m$(e,t){return(e[0]*t[1]<e[1]*t[0]?-1:1)*Math.acos(f$(e,t))}function y$(e,t,n,i,a,r,s,o,l,c,d){var u=l*(g$/180),h=p$(u)*(e-n)/2+h$(u)*(t-i)/2,p=-1*h$(u)*(e-n)/2+p$(u)*(t-i)/2,g=h*h/(s*s)+p*p/(o*o);g>1&&(s*=u$(g),o*=u$(g));var v=(a===r?-1:1)*u$((s*s*(o*o)-s*s*(p*p)-o*o*(h*h))/(s*s*(p*p)+o*o*(h*h)))||0,f=v*s*p/o,m=v*-o*h/s,y=(e+n)/2+p$(u)*f-h$(u)*m,b=(t+i)/2+h$(u)*f+p$(u)*m,w=m$([1,0],[(h-f)/s,(p-m)/o]),k=[(h-f)/s,(p-m)/o],S=[(-1*h-f)/s,(-1*p-m)/o],x=m$(k,S);if(f$(k,S)<=-1&&(x=g$),f$(k,S)>=1&&(x=0),x<0){var _=Math.round(x/g$*1e6)/1e6;x=2*g$+_%2*g$}d.addData(c,y,b,s,o,w,x,u,r)}var b$=/([mlvhzcqtsa])([^mlvhzcqtsa]*)/gi,w$=/-?([0-9]*\.)?[0-9]+([eE]-?[0-9]+)?/g;var k$=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return EI(t,e),t.prototype.applyTransform=function(e){},t}(LP);function S$(e){return null!=e.setData}function x$(e,t){var n=function(e){var t=new fP;if(!e)return t;var n,i=0,a=0,r=i,s=a,o=fP.CMD,l=e.match(b$);if(!l)return t;for(var c=0;c<l.length;c++){for(var d=l[c],u=d.charAt(0),h=void 0,p=d.match(w$)||[],g=p.length,v=0;v<g;v++)p[v]=parseFloat(p[v]);for(var f=0;f<g;){var m=void 0,y=void 0,b=void 0,w=void 0,k=void 0,S=void 0,x=void 0,_=i,C=a,I=void 0,D=void 0;switch(u){case"l":i+=p[f++],a+=p[f++],h=o.L,t.addData(h,i,a);break;case"L":i=p[f++],a=p[f++],h=o.L,t.addData(h,i,a);break;case"m":i+=p[f++],a+=p[f++],h=o.M,t.addData(h,i,a),r=i,s=a,u="l";break;case"M":i=p[f++],a=p[f++],h=o.M,t.addData(h,i,a),r=i,s=a,u="L";break;case"h":i+=p[f++],h=o.L,t.addData(h,i,a);break;case"H":i=p[f++],h=o.L,t.addData(h,i,a);break;case"v":a+=p[f++],h=o.L,t.addData(h,i,a);break;case"V":a=p[f++],h=o.L,t.addData(h,i,a);break;case"C":h=o.C,t.addData(h,p[f++],p[f++],p[f++],p[f++],p[f++],p[f++]),i=p[f-2],a=p[f-1];break;case"c":h=o.C,t.addData(h,p[f++]+i,p[f++]+a,p[f++]+i,p[f++]+a,p[f++]+i,p[f++]+a),i+=p[f-2],a+=p[f-1];break;case"S":m=i,y=a,I=t.len(),D=t.data,n===o.C&&(m+=i-D[I-4],y+=a-D[I-3]),h=o.C,_=p[f++],C=p[f++],i=p[f++],a=p[f++],t.addData(h,m,y,_,C,i,a);break;case"s":m=i,y=a,I=t.len(),D=t.data,n===o.C&&(m+=i-D[I-4],y+=a-D[I-3]),h=o.C,_=i+p[f++],C=a+p[f++],i+=p[f++],a+=p[f++],t.addData(h,m,y,_,C,i,a);break;case"Q":_=p[f++],C=p[f++],i=p[f++],a=p[f++],h=o.Q,t.addData(h,_,C,i,a);break;case"q":_=p[f++]+i,C=p[f++]+a,i+=p[f++],a+=p[f++],h=o.Q,t.addData(h,_,C,i,a);break;case"T":m=i,y=a,I=t.len(),D=t.data,n===o.Q&&(m+=i-D[I-4],y+=a-D[I-3]),i=p[f++],a=p[f++],h=o.Q,t.addData(h,m,y,i,a);break;case"t":m=i,y=a,I=t.len(),D=t.data,n===o.Q&&(m+=i-D[I-4],y+=a-D[I-3]),i+=p[f++],a+=p[f++],h=o.Q,t.addData(h,m,y,i,a);break;case"A":b=p[f++],w=p[f++],k=p[f++],S=p[f++],x=p[f++],y$(_=i,C=a,i=p[f++],a=p[f++],S,x,b,w,k,h=o.A,t);break;case"a":b=p[f++],w=p[f++],k=p[f++],S=p[f++],x=p[f++],y$(_=i,C=a,i+=p[f++],a+=p[f++],S,x,b,w,k,h=o.A,t)}}"z"!==u&&"Z"!==u||(h=o.Z,t.addData(h),i=r,a=s),n=h}return t.toStatic(),t}(e),i=RC({},t);return i.buildPath=function(e){var t,i=S$(e);i&&e.canSave()?(e.appendPath(n),(t=e.getContext())&&e.rebuildPath(t,1)):(t=i?e.getContext():e)&&n.rebuildPath(t,1)},i.applyTransform=function(e){!function(e,t){if(t){var n,i,a,r,s,o,l=e.data,c=e.len(),d=o$.M,u=o$.C,h=o$.L,p=o$.R,g=o$.A,v=o$.Q;for(a=0,r=0;a<c;){switch(n=l[a++],r=a,i=0,n){case d:case h:i=1;break;case u:i=3;break;case v:i=2;break;case g:var f=t[4],m=t[5],y=c$(t[0]*t[0]+t[1]*t[1]),b=c$(t[2]*t[2]+t[3]*t[3]),w=d$(-t[1]/b,t[0]/y);l[a]*=y,l[a++]+=f,l[a]*=b,l[a++]+=m,l[a++]*=y,l[a++]*=b,l[a++]+=w,l[a++]+=w,r=a+=2;break;case p:o[0]=l[a++],o[1]=l[a++],GI(o,o,t),l[r++]=o[0],l[r++]=o[1],o[0]+=l[a++],o[1]+=l[a++],GI(o,o,t),l[r++]=o[0],l[r++]=o[1]}for(s=0;s<i;s++){var k=l$[s];k[0]=l[a++],k[1]=l[a++],GI(k,k,t),l[r++]=k[0],l[r++]=k[1]}}e.increaseVersion()}}(n,e),this.dirtyShape()},i}var _$=function(){return function(){this.cx=0,this.cy=0,this.r=0}}(),C$=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultShape=function(){return new _$},t.prototype.buildPath=function(e,t){e.moveTo(t.cx+t.r,t.cy),e.arc(t.cx,t.cy,t.r,0,2*Math.PI)},t}(LP);C$.prototype.type="circle";var I$=function(){return function(){this.cx=0,this.cy=0,this.rx=0,this.ry=0}}(),D$=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultShape=function(){return new I$},t.prototype.buildPath=function(e,t){var n=.5522848,i=t.cx,a=t.cy,r=t.rx,s=t.ry,o=r*n,l=s*n;e.moveTo(i-r,a),e.bezierCurveTo(i-r,a-l,i-o,a-s,i,a-s),e.bezierCurveTo(i+o,a-s,i+r,a-l,i+r,a),e.bezierCurveTo(i+r,a+l,i+o,a+s,i,a+s),e.bezierCurveTo(i-o,a+s,i-r,a+l,i-r,a),e.closePath()},t}(LP);D$.prototype.type="ellipse";var T$=Math.PI,M$=2*T$,A$=Math.sin,E$=Math.cos,z$=Math.acos,P$=Math.atan2,R$=Math.abs,$$=Math.sqrt,O$=Math.max,L$=Math.min,N$=1e-4;function F$(e,t,n,i,a,r,s){var o=e-n,l=t-i,c=(s?r:-r)/$$(o*o+l*l),d=c*l,u=-c*o,h=e+d,p=t+u,g=n+d,v=i+u,f=(h+g)/2,m=(p+v)/2,y=g-h,b=v-p,w=y*y+b*b,k=a-r,S=h*v-g*p,x=(b<0?-1:1)*$$(O$(0,k*k*w-S*S)),_=(S*b-y*x)/w,C=(-S*y-b*x)/w,I=(S*b+y*x)/w,D=(-S*y+b*x)/w,T=_-f,M=C-m,A=I-f,E=D-m;return T*T+M*M>A*A+E*E&&(_=I,C=D),{cx:_,cy:C,x0:-d,y0:-u,x1:_*(a/k-1),y1:C*(a/k-1)}}function B$(e,t){var n,i=O$(t.r,0),a=O$(t.r0||0,0),r=i>0;if(r||a>0){if(r||(i=a,a=0),a>i){var s=i;i=a,a=s}var o=t.startAngle,l=t.endAngle;if(!isNaN(o)&&!isNaN(l)){var c=t.cx,d=t.cy,u=!!t.clockwise,h=R$(l-o),p=h>M$&&h%M$;if(p>N$&&(h=p),i>N$)if(h>M$-N$)e.moveTo(c+i*E$(o),d+i*A$(o)),e.arc(c,d,i,o,l,!u),a>N$&&(e.moveTo(c+a*E$(l),d+a*A$(l)),e.arc(c,d,a,l,o,u));else{var g=void 0,v=void 0,f=void 0,m=void 0,y=void 0,b=void 0,w=void 0,k=void 0,S=void 0,x=void 0,_=void 0,C=void 0,I=void 0,D=void 0,T=void 0,M=void 0,A=i*E$(o),E=i*A$(o),z=a*E$(l),P=a*A$(l),R=h>N$;if(R){var $=t.cornerRadius;$&&(g=(n=function(e){var t;if(KC(e)){var n=e.length;if(!n)return e;t=1===n?[e[0],e[0],0,0]:2===n?[e[0],e[0],e[1],e[1]]:3===n?e.concat(e[2]):e}else t=[e,e,e,e];return t}($))[0],v=n[1],f=n[2],m=n[3]);var O=R$(i-a)/2;if(y=L$(O,f),b=L$(O,m),w=L$(O,g),k=L$(O,v),_=S=O$(y,b),C=x=O$(w,k),(S>N$||x>N$)&&(I=i*E$(l),D=i*A$(l),T=a*E$(o),M=a*A$(o),h<T$)){var L=function(e,t,n,i,a,r,s,o){var l=n-e,c=i-t,d=s-a,u=o-r,h=u*l-d*c;if(!(h*h<N$))return[e+(h=(d*(t-r)-u*(e-a))/h)*l,t+h*c]}(A,E,T,M,I,D,z,P);if(L){var N=A-L[0],F=E-L[1],B=I-L[0],j=D-L[1],U=1/A$(z$((N*B+F*j)/($$(N*N+F*F)*$$(B*B+j*j)))/2),V=$$(L[0]*L[0]+L[1]*L[1]);_=L$(S,(i-V)/(U+1)),C=L$(x,(a-V)/(U-1))}}}if(R)if(_>N$){var q=L$(f,_),H=L$(m,_),W=F$(T,M,A,E,i,q,u),G=F$(I,D,z,P,i,H,u);e.moveTo(c+W.cx+W.x0,d+W.cy+W.y0),_<S&&q===H?e.arc(c+W.cx,d+W.cy,_,P$(W.y0,W.x0),P$(G.y0,G.x0),!u):(q>0&&e.arc(c+W.cx,d+W.cy,q,P$(W.y0,W.x0),P$(W.y1,W.x1),!u),e.arc(c,d,i,P$(W.cy+W.y1,W.cx+W.x1),P$(G.cy+G.y1,G.cx+G.x1),!u),H>0&&e.arc(c+G.cx,d+G.cy,H,P$(G.y1,G.x1),P$(G.y0,G.x0),!u))}else e.moveTo(c+A,d+E),e.arc(c,d,i,o,l,!u);else e.moveTo(c+A,d+E);if(a>N$&&R)if(C>N$){q=L$(g,C),W=F$(z,P,I,D,a,-(H=L$(v,C)),u),G=F$(A,E,T,M,a,-q,u);e.lineTo(c+W.cx+W.x0,d+W.cy+W.y0),C<x&&q===H?e.arc(c+W.cx,d+W.cy,C,P$(W.y0,W.x0),P$(G.y0,G.x0),!u):(H>0&&e.arc(c+W.cx,d+W.cy,H,P$(W.y0,W.x0),P$(W.y1,W.x1),!u),e.arc(c,d,a,P$(W.cy+W.y1,W.cx+W.x1),P$(G.cy+G.y1,G.cx+G.x1),u),q>0&&e.arc(c+G.cx,d+G.cy,q,P$(G.y1,G.x1),P$(G.y0,G.x0),!u))}else e.lineTo(c+z,d+P),e.arc(c,d,a,l,o,u);else e.lineTo(c+z,d+P)}else e.moveTo(c,d);e.closePath()}}}var j$=function(){return function(){this.cx=0,this.cy=0,this.r0=0,this.r=0,this.startAngle=0,this.endAngle=2*Math.PI,this.clockwise=!0,this.cornerRadius=0}}(),U$=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultShape=function(){return new j$},t.prototype.buildPath=function(e,t){B$(e,t)},t.prototype.isZeroArea=function(){return this.shape.startAngle===this.shape.endAngle||this.shape.r===this.shape.r0},t}(LP);U$.prototype.type="sector";var V$=function(){return function(){this.cx=0,this.cy=0,this.r=0,this.r0=0}}(),q$=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultShape=function(){return new V$},t.prototype.buildPath=function(e,t){var n=t.cx,i=t.cy,a=2*Math.PI;e.moveTo(n+t.r,i),e.arc(n,i,t.r,0,a,!1),e.moveTo(n+t.r0,i),e.arc(n,i,t.r0,0,a,!0)},t}(LP);function H$(e,t,n){var i=t.smooth,a=t.points;if(a&&a.length>=2){if(i){var r=function(e,t,n,i){var a,r,s,o,l=[],c=[],d=[],u=[];if(i){s=[1/0,1/0],o=[-1/0,-1/0];for(var h=0,p=e.length;h<p;h++)QI(s,s,e[h]),KI(o,o,e[h]);QI(s,s,i[0]),KI(o,o,i[1])}for(h=0,p=e.length;h<p;h++){var g=e[h];if(n)a=e[h?h-1:p-1],r=e[(h+1)%p];else{if(0===h||h===p-1){l.push(PI(e[h]));continue}a=e[h-1],r=e[h+1]}$I(c,r,a),BI(c,c,t);var v=UI(g,a),f=UI(g,r),m=v+f;0!==m&&(v/=m,f/=m),BI(d,c,-v),BI(u,c,f);var y=RI([],g,d),b=RI([],g,u);i&&(KI(y,y,s),QI(y,y,o),KI(b,b,s),QI(b,b,o)),l.push(y),l.push(b)}return n&&l.push(l.shift()),l}(a,i,n,t.smoothConstraint);e.moveTo(a[0][0],a[0][1]);for(var s=a.length,o=0;o<(n?s:s-1);o++){var l=r[2*o],c=r[2*o+1],d=a[(o+1)%s];e.bezierCurveTo(l[0],l[1],c[0],c[1],d[0],d[1])}}else{e.moveTo(a[0][0],a[0][1]);o=1;for(var u=a.length;o<u;o++)e.lineTo(a[o][0],a[o][1])}n&&e.closePath()}}q$.prototype.type="ring";var W$=function(){return function(){this.points=null,this.smooth=0,this.smoothConstraint=null}}(),G$=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultShape=function(){return new W$},t.prototype.buildPath=function(e,t){H$(e,t,!0)},t}(LP);G$.prototype.type="polygon";var Q$=function(){return function(){this.points=null,this.percent=1,this.smooth=0,this.smoothConstraint=null}}(),K$=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},t.prototype.getDefaultShape=function(){return new Q$},t.prototype.buildPath=function(e,t){H$(e,t,!1)},t}(LP);K$.prototype.type="polyline";var Z$={},Y$=function(){return function(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.percent=1}}(),X$=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},t.prototype.getDefaultShape=function(){return new Y$},t.prototype.buildPath=function(e,t){var n,i,a,r;if(this.subPixelOptimize){var s=qP(Z$,t,this.style);n=s.x1,i=s.y1,a=s.x2,r=s.y2}else n=t.x1,i=t.y1,a=t.x2,r=t.y2;var o=t.percent;0!==o&&(e.moveTo(n,i),o<1&&(a=n*(1-o)+a*o,r=i*(1-o)+r*o),e.lineTo(a,r))},t.prototype.pointAt=function(e){var t=this.shape;return[t.x1*(1-e)+t.x2*e,t.y1*(1-e)+t.y2*e]},t}(LP);X$.prototype.type="line";var J$=[],eO=function(){return function(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.cpx1=0,this.cpy1=0,this.percent=1}}();function tO(e,t,n){var i=e.cpx2,a=e.cpy2;return null!=i||null!=a?[(n?zT:ET)(e.x1,e.cpx1,e.cpx2,e.x2,t),(n?zT:ET)(e.y1,e.cpy1,e.cpy2,e.y2,t)]:[(n?FT:NT)(e.x1,e.cpx1,e.x2,t),(n?FT:NT)(e.y1,e.cpy1,e.y2,t)]}var nO=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},t.prototype.getDefaultShape=function(){return new eO},t.prototype.buildPath=function(e,t){var n=t.x1,i=t.y1,a=t.x2,r=t.y2,s=t.cpx1,o=t.cpy1,l=t.cpx2,c=t.cpy2,d=t.percent;0!==d&&(e.moveTo(n,i),null==l||null==c?(d<1&&(jT(n,s,a,d,J$),s=J$[1],a=J$[2],jT(i,o,r,d,J$),o=J$[1],r=J$[2]),e.quadraticCurveTo(s,o,a,r)):(d<1&&($T(n,s,l,a,d,J$),s=J$[1],l=J$[2],a=J$[3],$T(i,o,c,r,d,J$),o=J$[1],c=J$[2],r=J$[3]),e.bezierCurveTo(s,o,l,c,a,r)))},t.prototype.pointAt=function(e){return tO(this.shape,e,!1)},t.prototype.tangentAt=function(e){var t=tO(this.shape,e,!0);return jI(t,t)},t}(LP);nO.prototype.type="bezier-curve";var iO=function(){return function(){this.cx=0,this.cy=0,this.r=0,this.startAngle=0,this.endAngle=2*Math.PI,this.clockwise=!0}}(),aO=function(e){function t(t){return e.call(this,t)||this}return EI(t,e),t.prototype.getDefaultStyle=function(){return{stroke:"#000",fill:null}},t.prototype.getDefaultShape=function(){return new iO},t.prototype.buildPath=function(e,t){var n=t.cx,i=t.cy,a=Math.max(t.r,0),r=t.startAngle,s=t.endAngle,o=t.clockwise,l=Math.cos(r),c=Math.sin(r);e.moveTo(l*a+n,c*a+i),e.arc(n,i,a,r,s,!o)},t}(LP);aO.prototype.type="arc";var rO=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="compound",t}return EI(t,e),t.prototype._updatePathDirty=function(){for(var e=this.shape.paths,t=this.shapeChanged(),n=0;n<e.length;n++)t=t||e[n].shapeChanged();t&&this.dirtyShape()},t.prototype.beforeBrush=function(){this._updatePathDirty();for(var e=this.shape.paths||[],t=this.getGlobalScale(),n=0;n<e.length;n++)e[n].path||e[n].createPathProxy(),e[n].path.setScale(t[0],t[1],e[n].segmentIgnoreThreshold)},t.prototype.buildPath=function(e,t){for(var n=t.paths||[],i=0;i<n.length;i++)n[i].buildPath(e,n[i].shape,!0)},t.prototype.afterBrush=function(){for(var e=this.shape.paths||[],t=0;t<e.length;t++)e[t].pathUpdated()},t.prototype.getBoundingRect=function(){return this._updatePathDirty.call(this),LP.prototype.getBoundingRect.call(this)},t}(LP),sO=function(){function e(e){this.colorStops=e||[]}return e.prototype.addColorStop=function(e,t){this.colorStops.push({offset:e,color:t})},e}(),oO=function(e){function t(t,n,i,a,r,s){var o=e.call(this,r)||this;return o.x=null==t?0:t,o.y=null==n?0:n,o.x2=null==i?1:i,o.y2=null==a?0:a,o.type="linear",o.global=s||!1,o}return EI(t,e),t}(sO),lO=function(e){function t(t,n,i,a,r){var s=e.call(this,a)||this;return s.x=null==t?.5:t,s.y=null==n?.5:n,s.r=null==i?.5:i,s.type="radial",s.global=r||!1,s}return EI(t,e),t}(sO),cO=Math.min,dO=Math.max,uO=Math.abs,hO=[0,0],pO=[0,0],gO=YD(),vO=gO.minTv,fO=gO.maxTv,mO=function(){function e(e,t){this._corners=[],this._axes=[],this._origin=[0,0];for(var n=0;n<4;n++)this._corners[n]=new PD;for(n=0;n<2;n++)this._axes[n]=new PD;e&&this.fromBoundingRect(e,t)}return e.prototype.fromBoundingRect=function(e,t){var n=this._corners,i=this._axes,a=e.x,r=e.y,s=a+e.width,o=r+e.height;if(n[0].set(a,r),n[1].set(s,r),n[2].set(s,o),n[3].set(a,o),t)for(var l=0;l<4;l++)n[l].transform(t);PD.sub(i[0],n[1],n[0]),PD.sub(i[1],n[3],n[0]),i[0].normalize(),i[1].normalize();for(l=0;l<2;l++)this._origin[l]=i[l].dot(n[0])},e.prototype.intersect=function(e,t,n){var i=!0,a=!t;return t&&PD.set(t,0,0),gO.reset(n,!a),!this._intersectCheckOneSide(this,e,a,1)&&(i=!1,a)||!this._intersectCheckOneSide(e,this,a,-1)&&(i=!1,a)||a||gO.negativeSize||PD.copy(t,i?gO.useDir?gO.dirMinTv:vO:fO),i},e.prototype._intersectCheckOneSide=function(e,t,n,i){for(var a=!0,r=0;r<2;r++){var s=e._axes[r];if(e._getProjMinMaxOnAxis(r,e._corners,hO),e._getProjMinMaxOnAxis(r,t._corners,pO),gO.negativeSize||hO[1]<pO[0]||hO[0]>pO[1]){if(a=!1,gO.negativeSize||n)return a;var o=uO(pO[0]-hO[1]),l=uO(hO[0]-pO[1]);cO(o,l)>fO.len()&&(o<l?PD.scale(fO,s,-o*i):PD.scale(fO,s,l*i))}else if(!n){o=uO(pO[0]-hO[1]),l=uO(hO[0]-pO[1]);(gO.useDir||cO(o,l)<vO.len())&&((o<l||!gO.bidirectional)&&(PD.scale(vO,s,o*i),gO.useDir&&gO.calcDirMTV()),(o>=l||!gO.bidirectional)&&(PD.scale(vO,s,-l*i),gO.useDir&&gO.calcDirMTV()))}}return a},e.prototype._getProjMinMaxOnAxis=function(e,t,n){for(var i=this._axes[e],a=this._origin,r=t[0].dot(i)+a[e],s=r,o=r,l=1;l<t.length;l++){var c=t[l].dot(i)+a[e];s=cO(c,s),o=dO(c,o)}n[0]=s+gO.touchThreshold,n[1]=o-gO.touchThreshold,gO.negativeSize=n[1]<n[0]},e}(),yO=[],bO=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.notClear=!0,t.incremental=!0,t._displayables=[],t._temporaryDisplayables=[],t._cursor=0,t}return EI(t,e),t.prototype.traverse=function(e,t){e.call(t,this)},t.prototype.useStyle=function(){this.style={}},t.prototype.getCursor=function(){return this._cursor},t.prototype.innerAfterBrush=function(){this._cursor=this._displayables.length},t.prototype.clearDisplaybles=function(){this._displayables=[],this._temporaryDisplayables=[],this._cursor=0,this.markRedraw(),this.notClear=!1},t.prototype.clearTemporalDisplayables=function(){this._temporaryDisplayables=[]},t.prototype.addDisplayable=function(e,t){t?this._temporaryDisplayables.push(e):this._displayables.push(e),this.markRedraw()},t.prototype.addDisplayables=function(e,t){t=t||!1;for(var n=0;n<e.length;n++)this.addDisplayable(e[n],t)},t.prototype.getDisplayables=function(){return this._displayables},t.prototype.getTemporalDisplayables=function(){return this._temporaryDisplayables},t.prototype.eachPendingDisplayable=function(e){for(var t=this._cursor;t<this._displayables.length;t++)e&&e(this._displayables[t]);for(t=0;t<this._temporaryDisplayables.length;t++)e&&e(this._temporaryDisplayables[t])},t.prototype.update=function(){this.updateTransform();for(var e=this._cursor;e<this._displayables.length;e++){(t=this._displayables[e]).parent=this,t.update(),t.parent=null}for(e=0;e<this._temporaryDisplayables.length;e++){var t;(t=this._temporaryDisplayables[e]).parent=this,t.update(),t.parent=null}},t.prototype.getBoundingRect=function(){if(!this._rect){for(var e=new GD(1/0,1/0,-1/0,-1/0),t=0;t<this._displayables.length;t++){var n=this._displayables[t],i=n.getBoundingRect().clone();n.needLocalTransform()&&i.applyTransform(n.getLocalTransform(yO)),e.union(i)}this._rect=e}return this._rect},t.prototype.contain=function(e,t){var n=this.transformCoordToLocal(e,t);if(this.getBoundingRect().contain(n[0],n[1]))for(var i=0;i<this._displayables.length;i++){if(this._displayables[i].contain(e,t))return!0}return!1},t}($z),wO=BE();function kO(e,t,n,i,a,r,s){var o,l=!1;ZC(a)?(s=r,r=a,a=null):eI(a)&&(r=a.cb,s=a.during,l=a.isFrom,o=a.removeOpt,a=a.dataIndex);var c="leave"===e;c||t.stopAnimation("leave");var d=function(e,t,n,i,a){var r;if(t&&t.ecModel){var s=t.ecModel.getUpdatePayload();r=s&&s.animation}var o="update"===e;if(t&&t.isAnimationEnabled()){var l=void 0,c=void 0,d=void 0;return i?(l=cI(i.duration,200),c=cI(i.easing,"cubicOut"),d=0):(l=t.getShallow(o?"animationDurationUpdate":"animationDuration"),c=t.getShallow(o?"animationEasingUpdate":"animationEasing"),d=t.getShallow(o?"animationDelayUpdate":"animationDelay")),r&&(null!=r.duration&&(l=r.duration),null!=r.easing&&(c=r.easing),null!=r.delay&&(d=r.delay)),ZC(d)&&(d=d(n,a)),ZC(l)&&(l=l(n)),{duration:l||0,delay:d,easing:c}}return null}(e,i,a,c?o||{}:null,i&&i.getAnimationDelayParams?i.getAnimationDelayParams(t,a):null);if(d&&d.duration>0){var u={duration:d.duration,delay:d.delay||0,easing:d.easing,done:r,force:!!r||!!s,setToFinal:!c,scope:e,during:s};l?t.animateFrom(n,u):t.animateTo(n,u)}else t.stopAnimation(),!l&&t.attr(n),s&&s(1),r&&r()}function SO(e,t,n,i,a,r){kO("update",e,t,n,i,a,r)}function xO(e,t,n,i,a,r){kO("enter",e,t,n,i,a,r)}function _O(e){if(!e.__zr)return!0;for(var t=0;t<e.animators.length;t++){if("leave"===e.animators[t].scope)return!0}return!1}function CO(e,t,n,i,a,r){_O(e)||kO("leave",e,t,n,i,a,r)}function IO(e,t,n,i){e.removeTextContent(),e.removeTextGuideLine(),CO(e,{style:{opacity:0}},t,n,i)}function DO(e,t,n){function i(){e.parent&&e.parent.remove(e)}e.isGroup?e.traverse(function(e){e.isGroup||IO(e,t,n,i)}):IO(e,t,n,i)}function TO(e){wO(e).oldStyle=e.style}var MO={},AO=["x","y"],EO=["width","height"];function zO(e){return LP.extend(e)}var PO=function(e,t){var n=x$(e,t);return function(e){function t(t){var i=e.call(this,t)||this;return i.applyTransform=n.applyTransform,i.buildPath=n.buildPath,i}return EI(t,e),t}(k$)};function RO(e,t){return PO(e,t)}function $O(e,t){MO[e]=t}function OO(e){if(MO.hasOwnProperty(e))return MO[e]}function LO(e,t,n,i){var a=function(e,t){return new k$(x$(e,t))}(e,t);return n&&("center"===i&&(n=FO(n,a.getBoundingRect())),jO(a,n)),a}function NO(e,t,n){var i=new UP({style:{image:e,x:t.x,y:t.y,width:t.width,height:t.height},onload:function(e){if("center"===n){var a={width:e.width,height:e.height};i.setStyle(FO(t,a))}}});return i}function FO(e,t){var n,i=t.width/t.height,a=e.height*i;return n=a<=e.width?e.height:(a=e.width)/i,{x:e.x+e.width/2-a/2,y:e.y+e.height/2-n/2,width:a,height:n}}var BO=function(e,t){for(var n=[],i=e.length,a=0;a<i;a++){var r=e[a];n.push(r.getUpdatedPathProxy(!0))}var s=new LP(t);return s.createPathProxy(),s.buildPath=function(e){if(S$(e)){e.appendPath(n);var t=e.getContext();t&&e.rebuildPath(t,1)}},s};function jO(e,t){if(e.applyTransform){var n=e.getBoundingRect().calculateTransform(t);e.applyTransform(n)}}function UO(e,t){return qP(e,e,{lineWidth:t}),e}var VO=WP;function qO(e,t){for(var n=CD([]);e&&e!==t;)DD(n,e.getLocalTransform(),n),e=e.parent;return n}function HO(e,t,n){return t&&!BC(t)&&(t=vA.getLocalTransform(t)),n&&(t=ED([],t)),GI([],e,t)}function WO(e,t,n){var i=0===t[4]||0===t[5]||0===t[0]?1:JA(2*t[4]/t[0]),a=0===t[4]||0===t[5]||0===t[2]?1:JA(2*t[4]/t[2]),r=["left"===e?-i:"right"===e?i:0,"top"===e?-a:"bottom"===e?a:0];return r=HO(r,t,n),JA(r[0])>JA(r[1])?r[0]>0?"right":"left":r[1]>0?"bottom":"top"}function GO(e){return!e.isGroup}function QO(e,t,n){if(e&&t){var i,a=(i={},e.traverse(function(e){GO(e)&&e.anid&&(i[e.anid]=e)}),i);t.traverse(function(e){if(GO(e)&&e.anid){var t=a[e.anid];if(t){var i=r(e);e.attr(r(t)),SO(e,i,n,uR(e).dataIndex)}}})}function r(e){var t={x:e.x,y:e.y,rotation:e.rotation};return function(e){return null!=e.shape}(e)&&(t.shape=zC(e.shape)),t}}function KO(e,t){return UC(e,function(e){var n=e[0];n=XA(n,t.x),n=YA(n,t.x+t.width);var i=e[1];return i=XA(i,t.y),[n,i=YA(i,t.y+t.height)]})}function ZO(e,t){var n=XA(e.x,t.x),i=YA(e.x+e.width,t.x+t.width),a=XA(e.y,t.y),r=YA(e.y+e.height,t.y+t.height);if(i>=n&&r>=a)return{x:n,y:a,width:i-n,height:r-a}}function YO(e,t,n){var i=RC({rectHover:!0},t),a=i.style={strokeNoScale:!0};if(n=n||{x:-1,y:-1,width:2,height:2},e)return 0===e.indexOf("image://")?(a.image=e.slice(8),$C(a,n),new UP(i)):LO(e.replace("path://",""),i,n,"center")}function XO(e,t,n,i,a,r,s,o){var l,c=n-e,d=i-t,u=s-a,h=o-r,p=JO(u,h,c,d);if((l=p)<=1e-6&&l>=-1e-6)return!1;var g=e-a,v=t-r,f=JO(g,v,c,d)/p;if(f<0||f>1)return!1;var m=JO(g,v,u,h)/p;return!(m<0||m>1)}function JO(e,t,n,i){return e*i-n*t}function eL(e,t,n,i,a){return null==t||(JC(t)?tL[0]=tL[1]=tL[2]=tL[3]=t:(tL[0]=t[0],tL[1]=t[1],tL[2]=t[2],tL[3]=t[3]),i&&(tL[0]=XA(0,tL[0]),tL[1]=XA(0,tL[1]),tL[2]=XA(0,tL[2]),tL[3]=XA(0,tL[3])),n&&(tL[0]=-tL[0],tL[1]=-tL[1],tL[2]=-tL[2],tL[3]=-tL[3]),nL(e,tL,"x","width",3,1,a&&a[0]||0),nL(e,tL,"y","height",0,2,a&&a[1]||0)),e}var tL=[0,0,0,0];function nL(e,t,n,i,a,r,s){var o=t[r]+t[a],l=e[i];e[i]+=o,s=XA(0,YA(s,l)),e[i]<s?(e[i]=s,e[n]+=t[a]>=0?-t[a]:t[r]>=0?l+t[r]:JA(o)>1e-8?(l-s)*t[a]/o:0):e[n]-=t[a]}function iL(e){var t=e.itemTooltipOption,n=e.componentModel,i=e.itemName,a=YC(t)?{formatter:t}:t,r=n.mainType,s=n.componentIndex,o={componentType:r,name:i,$vars:["name"]};o[r+"Index"]=s;var l=e.formatterParamsExtra;l&&jC(WC(l),function(e){CI(o,e)||(o[e]=l[e],o.$vars.push(e))});var c=uR(e.el);c.componentMainType=r,c.componentIndex=s,c.tooltipConfig={name:i,option:$C({content:i,encodeHTMLContent:!0,formatterParams:o},a)}}function aL(e,t){var n;e.isGroup&&(n=t(e)),n||e.traverse(t)}function rL(e,t){if(e)if(KC(e))for(var n=0;n<e.length;n++)aL(e[n],t);else aL(e,t)}function sL(e){return!e||JA(e[1])<oL&&JA(e[2])<oL||JA(e[0])<oL&&JA(e[3])<oL}var oL=1e-5;function lL(e,t){return e?GD.copy(e,t):t.clone()}function cL(e,t){return t?ID(e||[1,0,0,1,0,0],t):void 0}function dL(e){return{z:e.get("z")||0,zlevel:e.get("zlevel")||0}}function uL(e,t,n){hL(e,t,n,-1/0)}function hL(e,t,n,i){if(e.ignoreModelZ)return i;var a=e.getTextContent(),r=e.getTextGuideLine();if(e.isGroup)for(var s=e.childrenRef(),o=0;o<s.length;o++)i=XA(hL(s[o],t,n,i),i);else e.z=t,e.zlevel=n,i=XA(e.z2||0,i);if(a&&(a.z=t,a.zlevel=n,isFinite(i)&&(a.z2=i+2)),r){var l=e.textGuideLineConfig;r.z=t,r.zlevel=n,isFinite(i)&&(r.z2=i+(l&&l.showAbove?1:-1))}return i}$O("circle",C$),$O("ellipse",D$),$O("sector",U$),$O("ring",q$),$O("polygon",G$),$O("polyline",K$),$O("rect",KP),$O("line",X$),$O("bezierCurve",nO),$O("arc",aO);const pL=Object.freeze(Object.defineProperty({__proto__:null,Arc:aO,BezierCurve:nO,BoundingRect:GD,Circle:C$,CompoundPath:rO,Ellipse:D$,Group:jA,Image:UP,IncrementalDisplayable:bO,Line:X$,LinearGradient:oO,OrientedBoundingRect:mO,Path:LP,Point:PD,Polygon:G$,Polyline:K$,RadialGradient:lO,Rect:KP,Ring:q$,Sector:U$,Text:JP,WH:EO,XY:AO,applyTransform:HO,calcZ2Range:function(e){var t=-1/0,n=1/0;function i(e){if(e&&!e.isGroup){var t=e.currentStates;if(t.length)for(var n=0;n<t.length;n++)a(e.states[t[n]]);a(e)}}function a(e){if(e){var i=e.z2;i>t&&(t=i),i<n&&(n=i)}}return aL(e,function(e){i(e),i(e.getTextContent()),i(e.getTextGuideLine())}),n>t&&(n=t=0),{min:n,max:t}},clipPointsByRect:KO,clipRectByRect:ZO,createIcon:YO,ensureCopyRect:lL,ensureCopyTransform:cL,expandOrShrinkRect:eL,extendPath:RO,extendShape:zO,getShapeClass:OO,getTransform:qO,groupTransition:QO,initProps:xO,isBoundingRectAxisAligned:sL,isElementRemoved:_O,lineLineIntersect:XO,linePolygonIntersect:function(e,t,n,i,a){for(var r=0,s=a[a.length-1];r<a.length;r++){var o=a[r];if(XO(e,t,n,i,o[0],o[1],s[0],s[1]))return!0;s=o}},makeImage:NO,makePath:LO,mergePath:BO,registerShape:$O,removeElement:CO,removeElementWithFadeOut:DO,resizePath:jO,retrieveZInfo:dL,setTooltipConfig:iL,subPixelOptimize:VO,subPixelOptimizeLine:UO,subPixelOptimizeRect:function(e,t){return HP(e,e,t),e},transformDirection:WO,traverseElements:rL,traverseUpdateZ:uL,updateProps:SO},Symbol.toStringTag,{value:"Module"}));var gL={};function vL(e,t){for(var n=0;n<fR.length;n++){var i=fR[n],a=t[i],r=e.ensureState(i);r.style=r.style||{},r.style.text=a}var s=e.currentStates.slice();e.clearStates(!0),e.setStyle({text:t.normal}),e.useStates(s,!0)}function fL(e,t,n){var i,a=e.labelFetcher,r=e.labelDataIndex,s=e.labelDimIndex,o=t.normal;a&&(i=a.getFormattedLabel(r,"normal",null,s,o&&o.get("formatter"),null!=n?{interpolatedValue:n}:null)),null==i&&(i=ZC(e.defaultText)?e.defaultText(r,e,n):e.defaultText);for(var l={normal:i},c=0;c<fR.length;c++){var d=fR[c],u=t[d];l[d]=cI(a?a.getFormattedLabel(r,d,null,s,u&&u.get("formatter")):null,i)}return l}function mL(e,t,n,i){n=n||gL;for(var a=e instanceof JP,r=!1,s=0;s<mR.length;s++){if((h=t[mR[s]])&&h.getShallow("show")){r=!0;break}}var o=a?e:e.getTextContent();if(r){a||(o||(o=new JP,e.setTextContent(o)),e.stateProxy&&(o.stateProxy=e.stateProxy));var l=fL(n,t),c=t.normal,d=!!c.getShallow("show"),u=bL(c,i&&i.normal,n,!1,!a);u.text=l.normal,a||e.setTextConfig(wL(c,n,!1));for(s=0;s<fR.length;s++){var h,p=fR[s];if(h=t[p]){var g=o.ensureState(p),v=!!cI(h.getShallow("show"),d);if(v!==d&&(g.ignore=!v),g.style=bL(h,i&&i[p],n,!0,!a),g.style.text=l[p],!a)e.ensureState(p).textConfig=wL(h,n,!0)}}o.silent=!!c.getShallow("silent"),null!=o.style.x&&(u.x=o.style.x),null!=o.style.y&&(u.y=o.style.y),o.ignore=!d,o.useStyle(u),o.dirty(),n.enableTextSetter&&(IL(o).setLabelText=function(e){var i=fL(n,t,e);vL(o,i)})}else o&&(o.ignore=!0);e.dirty()}function yL(e,t){t=t||"label";for(var n={normal:e.getModel(t)},i=0;i<fR.length;i++){var a=fR[i];n[a]=e.getModel([a,t])}return n}function bL(e,t,n,i,a){var r={};return function(e,t,n,i,a){n=n||gL;var r,s=t.ecModel,o=s&&s.option.textStyle,l=function(e){var t;for(;e&&e!==e.ecModel;){var n=(e.option||gL).rich;if(n){t=t||{};for(var i=WC(n),a=0;a<i.length;a++){t[i[a]]=1}}e=e.parentModel}return t}(t);if(l){r={};var c="richInheritPlainLabel",d=cI(t.get(c),s?s.get(c):void 0);for(var u in l)if(l.hasOwnProperty(u)){var h=t.getModel(["rich",u]);_L(r[u]={},h,o,t,d,n,i,a,!1,!0)}}r&&(e.rich=r);var p=t.get("overflow");p&&(e.overflow=p);var g=t.get("lineOverflow");g&&(e.lineOverflow=g);var v=e,f=t.get("minMargin");if(null!=f)f=JC(f)?f/2:0,v.margin=[f,f,f,f],v.__marginType=ML.minMargin;else{var m=t.get("textMargin");null!=m&&(v.margin=hI(m),v.__marginType=ML.textMargin)}_L(e,t,o,null,null,n,i,a,!0,!1)}(r,e,n,i,a),t&&RC(r,t),r}function wL(e,t,n){t=t||{};var i,a={},r=e.getShallow("rotate"),s=cI(e.getShallow("distance"),n?null:5),o=e.getShallow("offset");return"outside"===(i=e.getShallow("position")||(n?null:"inside"))&&(i=t.defaultOutsidePosition||"top"),null!=i&&(a.position=i),null!=o&&(a.offset=o),null!=r&&(r*=Math.PI/180,a.rotation=r),null!=s&&(a.distance=s),a.outsideFill="inherit"===e.get("color")?t.inheritColor||null:"auto",null!=t.autoOverflowArea&&(a.autoOverflowArea=t.autoOverflowArea),null!=t.layoutRect&&(a.layoutRect=t.layoutRect),a}var kL=["fontStyle","fontWeight","fontSize","fontFamily","textShadowColor","textShadowBlur","textShadowOffsetX","textShadowOffsetY"],SL=["align","lineHeight","width","height","tag","verticalAlign","ellipsis"],xL=["padding","borderWidth","borderRadius","borderDashOffset","backgroundColor","borderColor","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY"];function _L(e,t,n,i,a,r,s,o,l,c){n=!s&&n||gL;var d=r&&r.inheritColor,u=t.getShallow("color"),h=t.getShallow("textBorderColor"),p=cI(t.getShallow("opacity"),n.opacity);"inherit"!==u&&"auto"!==u||(u=d||null),"inherit"!==h&&"auto"!==h||(h=d||null),o||(u=u||n.color,h=h||n.textBorderColor),null!=u&&(e.fill=u),null!=h&&(e.stroke=h);var g=cI(t.getShallow("textBorderWidth"),n.textBorderWidth);null!=g&&(e.lineWidth=g);var v=cI(t.getShallow("textBorderType"),n.textBorderType);null!=v&&(e.lineDash=v);var f=cI(t.getShallow("textBorderDashOffset"),n.textBorderDashOffset);null!=f&&(e.lineDashOffset=f),s||null!=p||c||(p=r&&r.defaultOpacity),null!=p&&(e.opacity=p),s||o||null==e.fill&&r.inheritColor&&(e.fill=r.inheritColor);for(var m=0;m<kL.length;m++){var y=kL[m];null!=(w=!1!==a&&i?dI(t.getShallow(y),i.getShallow(y),n[y]):cI(t.getShallow(y),n[y]))&&(e[y]=w)}for(m=0;m<SL.length;m++){y=SL[m];null!=(w=t.getShallow(y))&&(e[y]=w)}if(null==e.verticalAlign){var b=t.getShallow("baseline");null!=b&&(e.verticalAlign=b)}if(!l||!r.disableBox){for(m=0;m<xL.length;m++){var w;y=xL[m];null!=(w=t.getShallow(y))&&(e[y]=w)}var k=t.getShallow("borderType");null!=k&&(e.borderDash=k),"auto"!==e.backgroundColor&&"inherit"!==e.backgroundColor||!d||(e.backgroundColor=d),"auto"!==e.borderColor&&"inherit"!==e.borderColor||!d||(e.borderColor=d)}}function CL(e,t){var n=t&&t.getModel("textStyle");return gI([e.fontStyle||n&&n.getShallow("fontStyle")||"",e.fontWeight||n&&n.getShallow("fontWeight")||"",(e.fontSize||n&&n.getShallow("fontSize")||12)+"px",e.fontFamily||n&&n.getShallow("fontFamily")||"sans-serif"].join(" "))}var IL=BE();var DL,TL,ML={minMargin:1,textMargin:2},AL=["textStyle","color"],EL=["fontStyle","fontWeight","fontSize","fontFamily","padding","lineHeight","rich","width","height","overflow"],zL=new JP,PL=function(){function e(){}return e.prototype.getTextColor=function(e){var t=this.ecModel;return this.getShallow("color")||(!e&&t?t.get(AL):null)},e.prototype.getFont=function(){return CL({fontStyle:this.getShallow("fontStyle"),fontWeight:this.getShallow("fontWeight"),fontSize:this.getShallow("fontSize"),fontFamily:this.getShallow("fontFamily")},this.ecModel)},e.prototype.getTextRect=function(e){for(var t={text:e,verticalAlign:this.getShallow("verticalAlign")||this.getShallow("baseline")},n=0;n<EL.length;n++)t[EL[n]]=this.getShallow(EL[n]);return zL.useStyle(t),zL.update(),zL.getBoundingRect()},e}(),RL=[["lineWidth","width"],["stroke","color"],["opacity"],["shadowBlur"],["shadowOffsetX"],["shadowOffsetY"],["shadowColor"],["lineDash","type"],["lineDashOffset","dashOffset"],["lineCap","cap"],["lineJoin","join"],["miterLimit"]],$L=az(RL),OL=function(){function e(){}return e.prototype.getLineStyle=function(e){return $L(this,e)},e}(),LL=[["fill","color"],["stroke","borderColor"],["lineWidth","borderWidth"],["opacity"],["shadowBlur"],["shadowOffsetX"],["shadowOffsetY"],["shadowColor"],["lineDash","borderType"],["lineDashOffset","borderDashOffset"],["lineCap","borderCap"],["lineJoin","borderJoin"],["miterLimit","borderMiterLimit"]],NL=az(LL),FL=function(){function e(){}return e.prototype.getItemStyle=function(e,t){return NL(this,e,t)},e}(),BL=function(){function e(e,t,n){this.parentModel=t,this.ecModel=n,this.option=e}return e.prototype.init=function(e,t,n){},e.prototype.mergeOption=function(e,t){PC(this.option,e,!0)},e.prototype.get=function(e,t){return null==e?this.option:this._doGet(this.parsePath(e),!t&&this.parentModel)},e.prototype.getShallow=function(e,t){var n=this.option,i=null==n?n:n[e];if(null==i&&!t){var a=this.parentModel;a&&(i=a.getShallow(e))}return i},e.prototype.getModel=function(t,n){var i=null!=t,a=i?this.parsePath(t):null;return new e(i?this._doGet(a):this.option,n=n||this.parentModel&&this.parentModel.getModel(this.resolveParentPath(a)),this.ecModel)},e.prototype.isEmpty=function(){return null==this.option},e.prototype.restoreData=function(){},e.prototype.clone=function(){return new(0,this.constructor)(zC(this.option))},e.prototype.parsePath=function(e){return"string"==typeof e?e.split("."):e},e.prototype.resolveParentPath=function(e){return e},e.prototype.isAnimationEnabled=function(){if(!pC.node&&this.option){if(null!=this.option.animation)return!!this.option.animation;if(this.parentModel)return this.parentModel.isAnimationEnabled()}},e.prototype._doGet=function(e,t){var n=this.option;if(!e)return n;for(var i=0;i<e.length&&(!e[i]||null!=(n=n&&"object"==typeof n?n[e[i]]:null));i++);return null==n&&t&&(n=t._doGet(this.resolveParentPath(e),t.parentModel)),n},e}();XE(BL),DL=BL,TL=["__\0is_clz",ez++].join("_"),DL.prototype[TL]=!0,DL.isInstance=function(e){return!(!e||!e[TL])},FC(BL,OL),FC(BL,FL),FC(BL,sz),FC(BL,PL);var jL=Math.round(10*Math.random());function UL(e){return[e||"",jL++].join("_")}function VL(e,t){return PC(PC({},e,!0),t,!0)}var qL="ZH",HL="EN",WL=HL,GL={},QL={},KL=pC.domSupported&&(document.documentElement.lang||navigator.language||navigator.browserLanguage||WL).toUpperCase().indexOf(qL)>-1?qL:WL;function ZL(e,t){e=e.toUpperCase(),QL[e]=new BL(t),GL[e]=t}ZL(HL,{time:{month:["January","February","March","April","May","June","July","August","September","October","November","December"],monthAbbr:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayOfWeek:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayOfWeekAbbr:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},legend:{selector:{all:"All",inverse:"Inv"}},toolbox:{brush:{title:{rect:"Box Select",polygon:"Lasso Select",lineX:"Horizontally Select",lineY:"Vertically Select",keep:"Keep Selections",clear:"Clear Selections"}},dataView:{title:"Data View",lang:["Data View","Close","Refresh"]},dataZoom:{title:{zoom:"Zoom",back:"Zoom Reset"}},magicType:{title:{line:"Switch to Line Chart",bar:"Switch to Bar Chart",stack:"Stack",tiled:"Tile"}},restore:{title:"Restore"},saveAsImage:{title:"Save as Image",lang:["Right Click to Save Image"]}},series:{typeNames:{pie:"Pie chart",bar:"Bar chart",line:"Line chart",scatter:"Scatter plot",effectScatter:"Ripple scatter plot",radar:"Radar chart",tree:"Tree",treemap:"Treemap",boxplot:"Boxplot",candlestick:"Candlestick",k:"K line chart",heatmap:"Heat map",map:"Map",parallel:"Parallel coordinate map",lines:"Line graph",graph:"Relationship graph",sankey:"Sankey diagram",funnel:"Funnel chart",gauge:"Gauge",pictorialBar:"Pictorial bar",themeRiver:"Theme River Map",sunburst:"Sunburst",custom:"Custom chart",chart:"Chart"}},aria:{general:{withTitle:'This is a chart about "{title}"',withoutTitle:"This is a chart"},series:{single:{prefix:"",withName:" with type {seriesType} named {seriesName}.",withoutName:" with type {seriesType}."},multiple:{prefix:". It consists of {seriesCount} series count.",withName:" The {seriesId} series is a {seriesType} representing {seriesName}.",withoutName:" The {seriesId} series is a {seriesType}.",separator:{middle:"",end:""}}},data:{allData:"The data is as follows: ",partialData:"The first {displayCnt} items are: ",withName:"the data for {name} is {value}",withoutName:"{value}",separator:{middle:", ",end:". "}}}}),ZL(qL,{time:{month:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],monthAbbr:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],dayOfWeek:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayOfWeekAbbr:["日","一","二","三","四","五","六"]},legend:{selector:{all:"全选",inverse:"反选"}},toolbox:{brush:{title:{rect:"矩形选择",polygon:"圈选",lineX:"横向选择",lineY:"纵向选择",keep:"保持选择",clear:"清除选择"}},dataView:{title:"数据视图",lang:["数据视图","关闭","刷新"]},dataZoom:{title:{zoom:"区域缩放",back:"区域缩放还原"}},magicType:{title:{line:"切换为折线图",bar:"切换为柱状图",stack:"切换为堆叠",tiled:"切换为平铺"}},restore:{title:"还原"},saveAsImage:{title:"保存为图片",lang:["右键另存为图片"]}},series:{typeNames:{pie:"饼图",bar:"柱状图",line:"折线图",scatter:"散点图",effectScatter:"涟漪散点图",radar:"雷达图",tree:"树图",treemap:"矩形树图",boxplot:"箱型图",candlestick:"K线图",k:"K线图",heatmap:"热力图",map:"地图",parallel:"平行坐标图",lines:"线图",graph:"关系图",sankey:"桑基图",funnel:"漏斗图",gauge:"仪表盘图",pictorialBar:"象形柱图",themeRiver:"主题河流图",sunburst:"旭日图",custom:"自定义图表",chart:"图表"}},aria:{general:{withTitle:"这是一个关于“{title}”的图表。",withoutTitle:"这是一个图表，"},series:{single:{prefix:"",withName:"图表类型是{seriesType}，表示{seriesName}。",withoutName:"图表类型是{seriesType}。"},multiple:{prefix:"它由{seriesCount}个图表系列组成。",withName:"第{seriesId}个系列是一个表示{seriesName}的{seriesType}，",withoutName:"第{seriesId}个系列是一个{seriesType}，",separator:{middle:"；",end:"。"}}},data:{allData:"其数据是——",partialData:"其中，前{displayCnt}项是——",withName:"{name}的数据是{value}",withoutName:"{value}",separator:{middle:"，",end:""}}}});function YL(){return null}var XL=1e3,JL=6e4,eN=36e5,tN=864e5,nN=31536e6,iN={year:/({yyyy}|{yy})/,month:/({MMMM}|{MMM}|{MM}|{M})/,day:/({dd}|{d})/,hour:/({HH}|{H}|{hh}|{h})/,minute:/({mm}|{m})/,second:/({ss}|{s})/,millisecond:/({SSS}|{S})/},aN={year:"{yyyy}",month:"{MMM}",day:"{d}",hour:"{HH}:{mm}",minute:"{HH}:{mm}",second:"{HH}:{mm}:{ss}",millisecond:"{HH}:{mm}:{ss} {SSS}"},rN="{yyyy}-{MM}-{dd}",sN={year:"{yyyy}",month:"{yyyy}-{MM}",day:rN,hour:rN+" "+aN.hour,minute:rN+" "+aN.minute,second:rN+" "+aN.second,millisecond:"{yyyy}-{MM}-{dd} {HH}:{mm}:{ss} {SSS}"},oN=["year","month","day","hour","minute","second","millisecond"],lN=["year","half-year","quarter","month","week","half-week","day","half-day","quarter-day","hour","minute","second","millisecond"];function cN(e){return YC(e)||ZC(e)?e:function(e){e=e||{};var t={},n=!0;return jC(oN,function(t){n&&(n=null==e[t])}),jC(oN,function(i,a){var r=e[i];t[i]={};for(var s=null,o=a;o>=0;o--){var l=oN[o],c=eI(r)&&!KC(r)?r[l]:r,d=void 0;KC(c)?s=(d=c.slice())[0]||"":YC(c)?d=[s=c]:(null==s?s=aN[i]:iN[l].test(s)||(s=t[l][l][0]+" "+s),d=[s],n&&(d[1]="{primary|"+s+"}")),t[i][l]=d}}),t}(e)}function dN(e,t){return"0000".substr(0,t-(e+="").length)+e}function uN(e){switch(e){case"half-year":case"quarter":return"month";case"week":case"half-week":return"day";case"half-day":case"quarter-day":return"hour";default:return e}}function hN(e){return e===uN(e)}function pN(e,t,n,i){var a=pE(e),r=a[fN(n)](),s=a[mN(n)]()+1,o=Math.floor((s-1)/3)+1,l=a[yN(n)](),c=a["get"+(n?"UTC":"")+"Day"](),d=a[bN(n)](),u=(d-1)%12+1,h=a[wN(n)](),p=a[kN(n)](),g=a[SN(n)](),v=d>=12?"pm":"am",f=v.toUpperCase(),m=i instanceof BL?i:function(e){return QL[e]}(i||KL)||QL[WL],y=m.getModel("time"),b=y.get("month"),w=y.get("monthAbbr"),k=y.get("dayOfWeek"),S=y.get("dayOfWeekAbbr");return(t||"").replace(/{a}/g,v+"").replace(/{A}/g,f+"").replace(/{yyyy}/g,r+"").replace(/{yy}/g,dN(r%100+"",2)).replace(/{Q}/g,o+"").replace(/{MMMM}/g,b[s-1]).replace(/{MMM}/g,w[s-1]).replace(/{MM}/g,dN(s,2)).replace(/{M}/g,s+"").replace(/{dd}/g,dN(l,2)).replace(/{d}/g,l+"").replace(/{eeee}/g,k[c]).replace(/{ee}/g,S[c]).replace(/{e}/g,c+"").replace(/{HH}/g,dN(d,2)).replace(/{H}/g,d+"").replace(/{hh}/g,dN(u+"",2)).replace(/{h}/g,u+"").replace(/{mm}/g,dN(h,2)).replace(/{m}/g,h+"").replace(/{ss}/g,dN(p,2)).replace(/{s}/g,p+"").replace(/{SSS}/g,dN(g,3)).replace(/{S}/g,g+"")}function gN(e,t){var n=pE(e),i=n[mN(t)]()+1,a=n[yN(t)](),r=n[bN(t)](),s=n[wN(t)](),o=n[kN(t)](),l=0===n[SN(t)](),c=l&&0===o,d=c&&0===s,u=d&&0===r,h=u&&1===a;return h&&1===i?"year":h?"month":u?"day":d?"hour":c?"minute":l?"second":"millisecond"}function vN(e,t,n){switch(t){case"year":e[_N(n)](0);case"month":e[CN(n)](1);case"day":e[IN(n)](0);case"hour":e[DN(n)](0);case"minute":e[TN(n)](0);case"second":e[MN(n)](0)}return e}function fN(e){return e?"getUTCFullYear":"getFullYear"}function mN(e){return e?"getUTCMonth":"getMonth"}function yN(e){return e?"getUTCDate":"getDate"}function bN(e){return e?"getUTCHours":"getHours"}function wN(e){return e?"getUTCMinutes":"getMinutes"}function kN(e){return e?"getUTCSeconds":"getSeconds"}function SN(e){return e?"getUTCMilliseconds":"getMilliseconds"}function xN(e){return e?"setUTCFullYear":"setFullYear"}function _N(e){return e?"setUTCMonth":"setMonth"}function CN(e){return e?"setUTCDate":"setDate"}function IN(e){return e?"setUTCHours":"setHours"}function DN(e){return e?"setUTCMinutes":"setMinutes"}function TN(e){return e?"setUTCSeconds":"setSeconds"}function MN(e){return e?"setUTCMilliseconds":"setMilliseconds"}function AN(e){if(!bE(e))return YC(e)?e:"-";var t=(e+"").split(".");return t[0].replace(/(\d{1,3})(?=(?:\d{3})+(?!\d))/g,"$1,")+(t.length>1?"."+t[1]:"")}function EN(e,t){return e=(e||"").toLowerCase().replace(/-(.)/g,function(e,t){return t.toUpperCase()}),t&&e&&(e=e.charAt(0).toUpperCase()+e.slice(1)),e}var zN=hI;function PN(e,t,n){function i(e){return e&&gI(e)?e:"-"}function a(e){return!(null==e||isNaN(e)||!isFinite(e))}var r="time"===t,s=e instanceof Date;if(r||s){var o=r?pE(e):e;if(!isNaN(+o))return pN(o,"{yyyy}-{MM}-{dd} {HH}:{mm}:{ss}",n);if(s)return"-"}if("ordinal"===t)return XC(e)?i(e):JC(e)&&a(e)?e+"":"-";var l=yE(e);return a(l)?AN(l):XC(e)?i(e):"boolean"==typeof e?e+"":"-"}var RN=["a","b","c","d","e","f","g"],$N=function(e,t){return"{"+e+(null==t?"":t)+"}"};function ON(e,t,n){KC(t)||(t=[t]);var i=t.length;if(!i)return"";for(var a=t[0].$vars||[],r=0;r<a.length;r++){var s=RN[r];e=e.replace($N(s),$N(s,0))}for(var o=0;o<i;o++)for(var l=0;l<a.length;l++){var c=t[o][a[l]];e=e.replace($N(RN[l],o),n?cD(c):c)}return e}function LN(e,t){var n=YC(e)?{color:e,extraCssText:t}:e||{},i=n.color,a=n.type;t=n.extraCssText;var r=n.renderMode||"html";return i?"html"===r?"subItem"===a?'<span style="display:inline-block;vertical-align:middle;margin-right:8px;margin-left:3px;border-radius:4px;width:4px;height:4px;background-color:'+cD(i)+";"+(t||"")+'"></span>':'<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:'+cD(i)+";"+(t||"")+'"></span>':{renderMode:r,content:"{"+(n.markerId||"markerX")+"|}  ",style:"subItem"===a?{width:4,height:4,borderRadius:2,backgroundColor:i}:{width:10,height:10,borderRadius:5,backgroundColor:i}}:""}function NN(e,t){return t=t||"transparent",YC(e)?e:eI(e)&&e.colorStops&&(e.colorStops[0]||{}).color||t}function FN(e,t){if("_blank"===t||"blank"===t){var n=window.open();n.opener=null,n.location.href=e}else window.open(e,t)}var BN={},jN={},UN=function(){function e(){this._normalMasterList=[],this._nonSeriesBoxMasterList=[]}return e.prototype.create=function(e,t){function n(n,i){var a=[];return jC(n,function(n,i){var r=n.create(e,t);a=a.concat(r||[])}),a}this._nonSeriesBoxMasterList=n(BN),this._normalMasterList=n(jN)},e.prototype.update=function(e,t){jC(this._normalMasterList,function(n){n.update&&n.update(e,t)})},e.prototype.getCoordinateSystems=function(){return this._normalMasterList.concat(this._nonSeriesBoxMasterList)},e.register=function(e,t){"matrix"!==e&&"calendar"!==e?jN[e]=t:BN[e]=t},e.get=function(e){return jN[e]||BN[e]},e}();var VN=1,qN=2;var HN=kI();var WN=0,GN=1,QN=2;function KN(e,t){var n=e.getShallow("coordinateSystem"),i=e.getShallow("coordinateSystemUsage",!0),a=WN;if(n){var r="series"===e.mainType;null==i&&(i=r?"data":"box"),"data"===i?(a=GN,r||(a=WN)):"box"===i&&(a=QN,r||function(e){return!!BN[e]}(n)||(a=WN))}return{coordSysType:n,kind:a}}var ZN=jC,YN=["left","right","top","bottom","width","height"],XN=[["width","left","right"],["height","top","bottom"]];function JN(e,t,n,i,a){var r=0,s=0;null==i&&(i=1/0),null==a&&(a=1/0);var o=0;t.eachChild(function(l,c){var d,u,h=l.getBoundingRect(),p=t.childAt(c+1),g=p&&p.getBoundingRect();if("horizontal"===e){var v=h.width+(g?-g.x+h.x:0);(d=r+v)>i||l.newline?(r=0,d=v,s+=o+n,o=h.height):o=Math.max(o,h.height)}else{var f=h.height+(g?-g.y+h.y:0);(u=s+f)>a||l.newline?(r+=o+n,s=0,u=f,o=h.width):o=Math.max(o,h.width)}l.newline||(l.x=r,l.y=s,l.markRedraw(),"horizontal"===e?r=d+n:s=u+n)})}var eF=JN;function tF(e,t){var n=function(e,t){var n,i,a=aF(e,t,{enableLayoutOnlyByCenter:!0}),r=e.getBoxLayoutParams();if(a.type===iF.point)i=a.refPoint,n=nF(r,{width:t.getWidth(),height:t.getHeight()});else{var s=e.get("center"),o=KC(s)?s:[s,s];n=nF(r,a.refContainer),i=a.boxCoordFrom===qN?a.refPoint:[tE(o[0],n.width)+n.x,tE(o[1],n.height)+n.y]}return{viewRect:n,center:i}}(e,t),i=n.viewRect,a=n.center,r=e.get("radius");KC(r)||(r=[0,r]);var s=tE(i.width,t.getWidth()),o=tE(i.height,t.getHeight()),l=Math.min(s,o),c=tE(r[0],l/2),d=tE(r[1],l/2);return{cx:a[0],cy:a[1],r0:c,r:d,viewRect:i}}function nF(e,t,n){n=zN(n||0);var i=t.width,a=t.height,r=tE(e.left,i),s=tE(e.top,a),o=tE(e.right,i),l=tE(e.bottom,a),c=tE(e.width,i),d=tE(e.height,a),u=n[2]+n[0],h=n[1]+n[3],p=e.aspect;switch(isNaN(c)&&(c=i-o-h-r),isNaN(d)&&(d=a-l-u-s),null!=p&&(isNaN(c)&&isNaN(d)&&(p>i/a?c=.8*i:d=.8*a),isNaN(c)&&(c=p*d),isNaN(d)&&(d=c/p)),isNaN(r)&&(r=i-o-c-h),isNaN(s)&&(s=a-l-d-u),e.left||e.right){case"center":r=i/2-c/2-n[3];break;case"right":r=i-c-h}switch(e.top||e.bottom){case"middle":case"center":s=a/2-d/2-n[0];break;case"bottom":s=a-d-u}r=r||0,s=s||0,isNaN(c)&&(c=i-h-r-(o||0)),isNaN(d)&&(d=a-u-s-(l||0));var g=new GD((t.x||0)+r+n[3],(t.y||0)+s+n[0],c,d);return g.margin=n,g}QC(JN,"vertical"),QC(JN,"horizontal");var iF={rect:1,point:2};function aF(e,t,n){var i,a,r,s,o=e.boxCoordinateSystem;if(o){var l=function(e){var t=e.getShallow("coord",!0),n=VN;if(null==t){var i=HN.get(e.type);i&&i.getCoord2&&(n=qN,t=i.getCoord2(e))}return{coord:t,from:n}}(e),c=l.coord,d=l.from;if(o.dataToLayout){r=iF.rect,s=d;var u=o.dataToLayout(c);i=u.contentRect||u.rect}else n&&n.enableLayoutOnlyByCenter&&o.dataToPoint&&(r=iF.point,s=d,a=o.dataToPoint(c))}return null==r&&(r=iF.rect),r===iF.rect&&(i||(i={x:0,y:0,width:t.getWidth(),height:t.getHeight()}),a=[i.x+i.width/2,i.y+i.height/2]),{type:r,refContainer:i,refPoint:a,boxCoordFrom:s}}function rF(e,t,n,i,a,r){var s;if((r=r||e).x=e.x,r.y=e.y,s=e.getBoundingRect(),e.needLocalTransform()){var o=e.getLocalTransform();(s=s.clone()).applyTransform(o)}var l=nF($C({width:s.width,height:s.height},t),n,i),c=l.x-s.x,d=l.y-s.y;return r.x+=c,r.y+=d,r===e&&e.markRedraw(),!0}function sF(e){var t=e.layoutMode||e.constructor.layoutMode;return eI(t)?t:t?{type:t}:null}function oF(e,t,n){var i=n&&n.ignoreSize;!KC(i)&&(i=[i,i]);var a=s(XN[0],0),r=s(XN[1],1);function s(n,a){var r={},s=0,l={},c=0;if(ZN(n,function(t){l[t]=e[t]}),ZN(n,function(e){CI(t,e)&&(r[e]=l[e]=t[e]),o(r,e)&&s++,o(l,e)&&c++}),i[a])return o(t,n[1])?l[n[2]]=null:o(t,n[2])&&(l[n[1]]=null),l;if(2!==c&&s){if(s>=2)return r;for(var d=0;d<n.length;d++){var u=n[d];if(!CI(r,u)&&CI(e,u)){r[u]=e[u];break}}return r}return l}function o(e,t){return null!=e[t]&&"auto"!==e[t]}function l(e,t,n){ZN(e,function(e){t[e]=n[e]})}l(XN[0],e,a),l(XN[1],e,r)}function lF(e){return function(e,t){return t&&e&&ZN(YN,function(n){CI(t,n)&&(e[n]=t[n])}),e}({},e)}var cF=BE(),dF=function(e){function t(t,n,i){var a=e.call(this,t,n,i)||this;return a.uid=UL("ec_cpt_model"),a}var n;return uC(t,e),t.prototype.init=function(e,t,n){this.mergeDefaultAndTheme(e,n)},t.prototype.mergeDefaultAndTheme=function(e,t){var n=sF(this),i=n?lF(e):{};PC(e,t.getTheme().get(this.mainType)),PC(e,this.getDefaultOption()),n&&oF(e,i,n)},t.prototype.mergeOption=function(e,t){PC(this.option,e,!0);var n=sF(this);n&&oF(this.option,e,n)},t.prototype.optionUpdated=function(e,t){},t.prototype.getDefaultOption=function(){var e=this.constructor;if(!function(e){return!(!e||!e[ZE])}(e))return e.defaultOption;var t=cF(this);if(!t.defaultOption){for(var n=[],i=e;i;){var a=i.prototype.defaultOption;a&&n.push(a),i=i.superClass}for(var r={},s=n.length-1;s>=0;s--)r=PC(r,n[s],!0);t.defaultOption=r}return t.defaultOption},t.prototype.getReferringComponents=function(e,t){var n=e+"Index",i=e+"Id";return WE(this.ecModel,e,{index:this.get(n,!0),id:this.get(i,!0)},t)},t.prototype.getBoxLayoutParams=function(){return t=!1,{left:(e=this).getShallow("left",t),top:e.getShallow("top",t),right:e.getShallow("right",t),bottom:e.getShallow("bottom",t),width:e.getShallow("width",t),height:e.getShallow("height",t)};var e,t},t.prototype.getZLevelKey=function(){return""},t.prototype.setZLevel=function(e){this.option.zlevel=e},t.protoInitialize=((n=t.prototype).type="component",n.id="",n.name="",n.mainType="",n.subType="",void(n.componentIndex=0)),t}(BL);JE(dF,BL),iz(dF),function(e){var t={};e.registerSubTypeDefaulter=function(e,n){var i=YE(e);t[i.main]=n},e.determineSubType=function(n,i){var a=i.type;if(!a){var r=YE(n).main;e.hasSubTypes(n)&&t[r]&&(a=t[r](i))}return a}}(dF),function(e,t){function n(e,t){return e[t]||(e[t]={predecessor:[],successor:[]}),e[t]}e.topologicalTravel=function(e,i,a,r){if(e.length){var s=function(e){var i={},a=[];return jC(e,function(r){var s=n(i,r),o=function(e,t){var n=[];return jC(e,function(e){LC(t,e)>=0&&n.push(e)}),n}(s.originalDeps=t(r),e);s.entryCount=o.length,0===s.entryCount&&a.push(r),jC(o,function(e){LC(s.predecessor,e)<0&&s.predecessor.push(e);var t=n(i,e);LC(t.successor,e)<0&&t.successor.push(r)})}),{graph:i,noEntryList:a}}(i),o=s.graph,l=s.noEntryList,c={};for(jC(e,function(e){c[e]=!0});l.length;){var d=l.pop(),u=o[d],h=!!c[d];h&&(a.call(r,d,u.originalDeps.slice()),delete c[d]),jC(u.successor,h?g:p)}jC(c,function(){throw new Error("")})}function p(e){o[e].entryCount--,0===o[e].entryCount&&l.push(e)}function g(e){c[e]=!0,p(e)}}}(dF,function(e){var t=[];jC(dF.getClassesByMainType(e),function(e){t=t.concat(e.dependencies||e.prototype.dependencies||[])}),t=UC(t,function(e){return YE(e).main}),"dataset"!==e&&LC(t,"dataset")<=0&&t.unshift("dataset");return t});var uF={color:{},darkColor:{},size:{}},hF=uF.color={theme:["#5070dd","#b6d634","#505372","#ff994d","#0ca8df","#ffd10a","#fb628b","#785db0","#3fbe95"],neutral00:"#fff",neutral05:"#f4f7fd",neutral10:"#e8ebf0",neutral15:"#dbdee4",neutral20:"#cfd2d7",neutral25:"#c3c5cb",neutral30:"#b7b9be",neutral35:"#aaacb2",neutral40:"#9ea0a5",neutral45:"#929399",neutral50:"#86878c",neutral55:"#797b7f",neutral60:"#6d6e73",neutral65:"#616266",neutral70:"#54555a",neutral75:"#48494d",neutral80:"#3c3c41",neutral85:"#303034",neutral90:"#232328",neutral95:"#17171b",neutral99:"#000",accent05:"#eff1f9",accent10:"#e0e4f2",accent15:"#d0d6ec",accent20:"#c0c9e6",accent25:"#b1bbdf",accent30:"#a1aed9",accent35:"#91a0d3",accent40:"#8292cc",accent45:"#7285c6",accent50:"#6578ba",accent55:"#5c6da9",accent60:"#536298",accent65:"#4a5787",accent70:"#404c76",accent75:"#374165",accent80:"#2e3654",accent85:"#252b43",accent90:"#1b2032",accent95:"#121521",transparent:"rgba(0,0,0,0)",highlight:"rgba(255,231,130,0.8)"};for(var pF in RC(hF,{primary:hF.neutral80,secondary:hF.neutral70,tertiary:hF.neutral60,quaternary:hF.neutral50,disabled:hF.neutral20,border:hF.neutral30,borderTint:hF.neutral20,borderShade:hF.neutral40,background:hF.neutral05,backgroundTint:"rgba(234,237,245,0.5)",backgroundTransparent:"rgba(255,255,255,0)",backgroundShade:hF.neutral10,shadow:"rgba(0,0,0,0.2)",shadowTint:"rgba(129,130,136,0.2)",axisLine:hF.neutral70,axisLineTint:hF.neutral40,axisTick:hF.neutral70,axisTickMinor:hF.neutral60,axisLabel:hF.neutral70,axisSplitLine:hF.neutral15,axisMinorSplitLine:hF.neutral05}),hF)if(hF.hasOwnProperty(pF)){var gF=hF[pF];"theme"===pF?uF.darkColor.theme=hF.theme.slice():"highlight"===pF?uF.darkColor.highlight="rgba(255,231,130,0.4)":0===pF.indexOf("accent")?uF.darkColor[pF]=vM(gF,null,function(e){return.5*e},function(e){return Math.min(1,1.3-e)}):uF.darkColor[pF]=vM(gF,null,function(e){return.9*e},function(e){return 1-Math.pow(e,1.5)})}uF.size={xxs:2,xs:5,s:10,m:15,l:20,xl:30,xxl:40,xxxl:50};var vF="";"undefined"!=typeof navigator&&(vF=navigator.platform||"");var fF="rgba(0, 0, 0, 0.2)",mF=uF.color.theme[0],yF=vM(mF,null,null,.9);const bF={darkMode:"auto",colorBy:"series",color:uF.color.theme,gradientColor:[yF,mF],aria:{decal:{decals:[{color:fF,dashArrayX:[1,0],dashArrayY:[2,5],symbolSize:1,rotation:Math.PI/6},{color:fF,symbol:"circle",dashArrayX:[[8,8],[0,8,8,0]],dashArrayY:[6,0],symbolSize:.8},{color:fF,dashArrayX:[1,0],dashArrayY:[4,3],rotation:-Math.PI/4},{color:fF,dashArrayX:[[6,6],[0,6,6,0]],dashArrayY:[6,0]},{color:fF,dashArrayX:[[1,0],[1,6]],dashArrayY:[1,0,6,0],rotation:Math.PI/4},{color:fF,symbol:"triangle",dashArrayX:[[9,9],[0,9,9,0]],dashArrayY:[7,2],symbolSize:.75}]}},textStyle:{fontFamily:vF.match(/^Win/)?"Microsoft YaHei":"sans-serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"},blendMode:null,stateAnimation:{duration:300,easing:"cubicOut"},animation:"auto",animationDuration:1e3,animationDurationUpdate:500,animationEasing:"cubicInOut",animationEasingUpdate:"cubicInOut",animationThreshold:2e3,progressiveThreshold:3e3,progressive:400,hoverLayerThreshold:3e3,useUTC:!1};var wF=kI(["tooltip","label","itemName","itemId","itemGroupId","itemChildGroupId","seriesName"]),kF="original",SF="arrayRows",xF="objectRows",_F="keyedColumns",CF="typedArray",IF="unknown",DF="column",TF="row",MF=1,AF=2,EF=3,zF=BE();function PF(e,t,n){var i={},a=$F(t);if(!a||!e)return i;var r,s,o=[],l=[],c=t.ecModel,d=zF(c).datasetMap,u=a.uid+"_"+n.seriesLayoutBy;jC(e=e.slice(),function(t,n){var a=eI(t)?t:e[n]={name:t};"ordinal"===a.type&&null==r&&(r=n,s=g(a)),i[a.name]=[]});var h=d.get(u)||d.set(u,{categoryWayDim:s,valueWayDim:0});function p(e,t,n){for(var i=0;i<n;i++)e.push(t+i)}function g(e){var t=e.dimsDef;return t?t.length:1}return jC(e,function(e,t){var n=e.name,a=g(e);if(null==r){var s=h.valueWayDim;p(i[n],s,a),p(l,s,a),h.valueWayDim+=a}else if(r===t)p(i[n],0,a),p(o,0,a);else{s=h.categoryWayDim;p(i[n],s,a),p(l,s,a),h.categoryWayDim+=a}}),o.length&&(i.itemName=o),l.length&&(i.seriesName=l),i}function RF(e,t,n){var i={};if(!$F(e))return i;var a,r=t.sourceFormat,s=t.dimensionsDefine;r!==xF&&r!==_F||jC(s,function(e,t){"name"===(eI(e)?e.name:e)&&(a=t)});var o=function(){for(var e={},i={},o=[],l=0,c=Math.min(5,n);l<c;l++){var d=LF(t.data,r,t.seriesLayoutBy,s,t.startIndex,l);o.push(d);var u=d===EF;if(u&&null==e.v&&l!==a&&(e.v=l),(null==e.n||e.n===e.v||!u&&o[e.n]===EF)&&(e.n=l),h(e)&&o[e.n]!==EF)return e;u||(d===AF&&null==i.v&&l!==a&&(i.v=l),null!=i.n&&i.n!==i.v||(i.n=l))}function h(e){return null!=e.v&&null!=e.n}return h(e)?e:h(i)?i:null}();if(o){i.value=[o.v];var l=null!=a?a:o.n;i.itemName=[l],i.seriesName=[l]}return i}function $F(e){if(!e.get("data",!0))return WE(e.ecModel,"dataset",{index:e.get("datasetIndex",!0),id:e.get("datasetId",!0)},qE).models[0]}function OF(e,t){return LF(e.data,e.sourceFormat,e.seriesLayoutBy,e.dimensionsDefine,e.startIndex,t)}function LF(e,t,n,i,a,r){var s,o,l;if(nI(e))return EF;if(i){var c=i[r];eI(c)?(o=c.name,l=c.type):YC(c)&&(o=c)}if(null!=l)return"ordinal"===l?MF:EF;if(t===SF){var d=e;if(n===TF){for(var u=d[r],h=0;h<(u||[]).length&&h<5;h++)if(null!=(s=y(u[a+h])))return s}else for(h=0;h<d.length&&h<5;h++){var p=d[a+h];if(p&&null!=(s=y(p[r])))return s}}else if(t===xF){var g=e;if(!o)return EF;for(h=0;h<g.length&&h<5;h++){if((f=g[h])&&null!=(s=y(f[o])))return s}}else if(t===_F){if(!o)return EF;if(!(u=e[o])||nI(u))return EF;for(h=0;h<u.length&&h<5;h++)if(null!=(s=y(u[h])))return s}else if(t===kF){var v=e;for(h=0;h<v.length&&h<5;h++){var f,m=EE(f=v[h]);if(!KC(m))return EF;if(null!=(s=y(m[r])))return s}}function y(e){var t=YC(e);return null!=e&&Number.isFinite(Number(e))&&""!==e?t?AF:EF:t&&"-"!==e?MF:void 0}return EF}var NF=kI();var FF=BE();BE();var BF,jF,UF,VF=function(){function e(){}return e.prototype.getColorFromPalette=function(e,t,n){var i=TE(this.get("color",!0)),a=this.get("colorLayer",!0);return function(e,t,n,i,a,r,s){r=r||e;var o=t(r),l=o.paletteIdx||0,c=o.paletteNameMap=o.paletteNameMap||{};if(c.hasOwnProperty(a))return c[a];var d=null!=s&&i?function(e,t){for(var n=e.length,i=0;i<n;i++)if(e[i].length>t)return e[i];return e[n-1]}(i,s):n;if(d=d||n,!d||!d.length)return;var u=d[l];a&&(c[a]=u);return o.paletteIdx=(l+1)%d.length,u}(this,FF,i,a,e,t,n)},e.prototype.clearColorPalette=function(){var e,t;(t=FF)(e=this).paletteIdx=0,t(e).paletteNameMap={}},e}();var qF="\0_ec_inner",HF=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.init=function(e,t,n,i,a,r){i=i||{},this.option=null,this._theme=new BL(i),this._locale=new BL(a),this._optionManager=r},t.prototype.setOption=function(e,t,n){var i=QF(t);this._optionManager.setOption(e,n,i),this._resetOption(null,i)},t.prototype.resetOption=function(e,t){return this._resetOption(e,QF(t))},t.prototype._resetOption=function(e,t){var n=!1,i=this._optionManager;if(!e||"recreate"===e){var a=i.mountOption("recreate"===e);this.option&&"recreate"!==e?(this.restoreData(),this._mergeOption(a,t)):UF(this,a),n=!0}if("timeline"!==e&&"media"!==e||this.restoreData(),!e||"recreate"===e||"timeline"===e){var r=i.getTimelineOption(this);r&&(n=!0,this._mergeOption(r,t))}if(!e||"recreate"===e||"media"===e){var s=i.getMediaOption(this);s.length&&jC(s,function(e){n=!0,this._mergeOption(e,t)},this)}return n},t.prototype.mergeOption=function(e){this._mergeOption(e,null)},t.prototype._mergeOption=function(e,t){var n=this.option,i=this._componentsMap,a=this._componentsCount,r=[],s=kI(),o=t&&t.replaceMergeMainTypeMap;zF(this).datasetMap=kI(),jC(e,function(e,t){null!=e&&(dF.hasClass(t)?t&&(r.push(t),s.set(t,!0)):n[t]=null==n[t]?zC(e):PC(n[t],e,!0))}),o&&o.each(function(e,t){dF.hasClass(t)&&!s.get(t)&&(r.push(t),s.set(t,!0))}),dF.topologicalTravel(r,dF.getAllClassMainTypes(),function(t){var r=function(e,t,n){var i=NF.get(t);if(!i)return n;var a=i(e);return a?n.concat(a):n}(this,t,TE(e[t])),s=i.get(t),l=s?o&&o.get(t)?"replaceMerge":"normalMerge":"replaceAll",c=PE(s,r,l);(function(e,t,n){jC(e,function(e){var i=e.newOption;eI(i)&&(e.keyInfo.mainType=t,e.keyInfo.subType=function(e,t,n,i){return t.type?t.type:n?n.subType:i.determineSubType(e,t)}(t,i,e.existing,n))})})(c,t,dF),n[t]=null,i.set(t,null),a.set(t,0);var d,u=[],h=[],p=0;jC(c,function(e,n){var i=e.existing,a=e.newOption;if(a){var r="series"===t,s=dF.getClass(t,e.keyInfo.subType,!r);if(!s)return;if("tooltip"===t){if(d)return;d=!0}if(i&&i.constructor===s)i.name=e.keyInfo.name,i.mergeOption(a,this),i.optionUpdated(a,!1);else{var o=RC({componentIndex:n},e.keyInfo);RC(i=new s(a,this,this,o),o),e.brandNew&&(i.__requireNewView=!0),i.init(a,this,this),i.optionUpdated(null,!0)}}else i&&(i.mergeOption({},this),i.optionUpdated({},!1));i?(u.push(i.option),h.push(i),p++):(u.push(void 0),h.push(void 0))},this),n[t]=u,i.set(t,h),a.set(t,p),"series"===t&&BF(this)},this),this._seriesIndices||BF(this)},t.prototype.getOption=function(){var e=zC(this.option);return jC(e,function(t,n){if(dF.hasClass(n)){for(var i=TE(t),a=i.length,r=!1,s=a-1;s>=0;s--)i[s]&&!NE(i[s])?r=!0:(i[s]=null,!r&&a--);i.length=a,e[n]=i}}),delete e[qF],e},t.prototype.setTheme=function(e){this._theme=new BL(e),this._resetOption("recreate",null)},t.prototype.getTheme=function(){return this._theme},t.prototype.getLocaleModel=function(){return this._locale},t.prototype.setUpdatePayload=function(e){this._payload=e},t.prototype.getUpdatePayload=function(){return this._payload},t.prototype.getComponent=function(e,t){var n=this._componentsMap.get(e);if(n){var i=n[t||0];if(i)return i;if(null==t)for(var a=0;a<n.length;a++)if(n[a])return n[a]}},t.prototype.queryComponents=function(e){var t=e.mainType;if(!t)return[];var n,i=e.index,a=e.id,r=e.name,s=this._componentsMap.get(t);return s&&s.length?(null!=i?(n=[],jC(TE(i),function(e){s[e]&&n.push(s[e])})):n=null!=a?WF("id",a,s):null!=r?WF("name",r,s):qC(s,function(e){return!!e}),GF(n,e)):[]},t.prototype.findComponents=function(e){var t,n,i,a,r,s=e.query,o=e.mainType,l=(n=o+"Index",i=o+"Id",a=o+"Name",!(t=s)||null==t[n]&&null==t[i]&&null==t[a]?null:{mainType:o,index:t[n],id:t[i],name:t[a]}),c=l?this.queryComponents(l):qC(this._componentsMap.get(o),function(e){return!!e});return r=GF(c,e),e.filter?qC(r,e.filter):r},t.prototype.eachComponent=function(e,t,n){var i=this._componentsMap;if(ZC(e)){var a=t,r=e;i.each(function(e,t){for(var n=0;e&&n<e.length;n++){var i=e[n];i&&r.call(a,t,i,i.componentIndex)}})}else for(var s=YC(e)?i.get(e):eI(e)?this.findComponents(e):null,o=0;s&&o<s.length;o++){var l=s[o];l&&t.call(n,l,l.componentIndex)}},t.prototype.getSeriesByName=function(e){var t=OE(e,null);return qC(this._componentsMap.get("series"),function(e){return!!e&&null!=t&&e.name===t})},t.prototype.getSeriesByIndex=function(e){return this._componentsMap.get("series")[e]},t.prototype.getSeriesByType=function(e){return qC(this._componentsMap.get("series"),function(t){return!!t&&t.subType===e})},t.prototype.getSeries=function(){return qC(this._componentsMap.get("series"),function(e){return!!e})},t.prototype.getSeriesCount=function(){return this._componentsCount.get("series")},t.prototype.eachSeries=function(e,t){jF(this),jC(this._seriesIndices,function(n){var i=this._componentsMap.get("series")[n];e.call(t,i,n)},this)},t.prototype.eachRawSeries=function(e,t){jC(this._componentsMap.get("series"),function(n){n&&e.call(t,n,n.componentIndex)})},t.prototype.eachSeriesByType=function(e,t,n){jF(this),jC(this._seriesIndices,function(i){var a=this._componentsMap.get("series")[i];a.subType===e&&t.call(n,a,i)},this)},t.prototype.eachRawSeriesByType=function(e,t,n){return jC(this.getSeriesByType(e),t,n)},t.prototype.isSeriesFiltered=function(e){return jF(this),null==this._seriesIndicesMap.get(e.componentIndex)},t.prototype.getCurrentSeriesIndices=function(){return(this._seriesIndices||[]).slice()},t.prototype.filterSeries=function(e,t){jF(this);var n=[];jC(this._seriesIndices,function(i){var a=this._componentsMap.get("series")[i];e.call(t,a,i)&&n.push(i)},this),this._seriesIndices=n,this._seriesIndicesMap=kI(n)},t.prototype.restoreData=function(e){BF(this);var t=this._componentsMap,n=[];t.each(function(e,t){dF.hasClass(t)&&n.push(t)}),dF.topologicalTravel(n,dF.getAllClassMainTypes(),function(n){jC(t.get(n),function(t){!t||"series"===n&&function(e,t){if(t){var n=t.seriesIndex,i=t.seriesId,a=t.seriesName;return null!=n&&e.componentIndex!==n||null!=i&&e.id!==i||null!=a&&e.name!==a}}(t,e)||t.restoreData()})})},t.internalField=(BF=function(e){var t=e._seriesIndices=[];jC(e._componentsMap.get("series"),function(e){e&&t.push(e.componentIndex)}),e._seriesIndicesMap=kI(t)},jF=function(e){},void(UF=function(e,t){e.option={},e.option[qF]=1,e._componentsMap=kI({series:[]}),e._componentsCount=kI();var n,i,a,r=t.aria;eI(r)&&null==r.enabled&&(r.enabled=!0),n=t,i=e._theme.option,a=n.color&&!n.colorLayer,jC(i,function(e,t){"colorLayer"===t&&a||"color"===t&&n.color||dF.hasClass(t)||("object"==typeof e?n[t]=n[t]?PC(n[t],e,!1):zC(e):null==n[t]&&(n[t]=e))}),PC(t,bF,!1),e._mergeOption(t,null)})),t}(BL);function WF(e,t,n){if(KC(t)){var i=kI();return jC(t,function(e){null!=e&&(null!=OE(e,null)&&i.set(e,!0))}),qC(n,function(t){return t&&i.get(t[e])})}var a=OE(t,null);return qC(n,function(t){return t&&null!=a&&t[e]===a})}function GF(e,t){return t.hasOwnProperty("subType")?qC(e,function(e){return e&&e.subType===t.subType}):e}function QF(e){var t=kI();return e&&jC(TE(e.replaceMerge),function(e){t.set(e,!0)}),{replaceMergeMainTypeMap:t}}FC(HF,VF);var KF=["getDom","getZr","getWidth","getHeight","getDevicePixelRatio","dispatchAction","isSSR","isDisposed","on","off","getDataURL","getConnectedDataURL","getOption","getId","updateLabelLayout"],ZF=function(){return function(e){jC(KF,function(t){this[t]=GC(e[t],e)},this)}}(),YF=/^(min|max)?(.+)$/,XF=function(){function e(e){this._timelineOptions=[],this._mediaList=[],this._currentMediaIndices=[],this._api=e}return e.prototype.setOption=function(e,t,n){e&&(jC(TE(e.series),function(e){e&&e.data&&nI(e.data)&&fI(e.data)}),jC(TE(e.dataset),function(e){e&&e.source&&nI(e.source)&&fI(e.source)})),e=zC(e);var i=this._optionBackup,a=function(e,t,n){var i,a,r=[],s=e.baseOption,o=e.timeline,l=e.options,c=e.media,d=!!e.media,u=!!(l||o||s&&s.timeline);s?(a=s).timeline||(a.timeline=o):((u||d)&&(e.options=e.media=null),a=e);d&&KC(c)&&jC(c,function(e){e&&e.option&&(e.query?r.push(e):i||(i=e))});function h(e){jC(t,function(t){t(e,n)})}return h(a),jC(l,function(e){return h(e)}),jC(r,function(e){return h(e.option)}),{baseOption:a,timelineOptions:l||[],mediaDefault:i,mediaList:r}}(e,t,!i);this._newBaseOption=a.baseOption,i?(a.timelineOptions.length&&(i.timelineOptions=a.timelineOptions),a.mediaList.length&&(i.mediaList=a.mediaList),a.mediaDefault&&(i.mediaDefault=a.mediaDefault)):this._optionBackup=a},e.prototype.mountOption=function(e){var t=this._optionBackup;return this._timelineOptions=t.timelineOptions,this._mediaList=t.mediaList,this._mediaDefault=t.mediaDefault,this._currentMediaIndices=[],zC(e?t.baseOption:this._newBaseOption)},e.prototype.getTimelineOption=function(e){var t,n=this._timelineOptions;if(n.length){var i=e.getComponent("timeline");i&&(t=zC(n[i.getCurrentIndex()]))}return t},e.prototype.getMediaOption=function(e){var t,n,i=this._api.getWidth(),a=this._api.getHeight(),r=this._mediaList,s=this._mediaDefault,o=[],l=[];if(!r.length&&!s)return l;for(var c=0,d=r.length;c<d;c++)JF(r[c].query,i,a)&&o.push(c);return!o.length&&s&&(o=[-1]),o.length&&(t=o,n=this._currentMediaIndices,t.join(",")!==n.join(","))&&(l=UC(o,function(e){return zC(-1===e?s.option:r[e].option)})),this._currentMediaIndices=o,l},e}();function JF(e,t,n){var i={width:t,height:n,aspectratio:t/n},a=!0;return jC(e,function(e,t){var n=t.match(YF);if(n&&n[1]&&n[2]){var r=n[1],s=n[2].toLowerCase();(function(e,t,n){return"min"===n?e>=t:"max"===n?e<=t:e===t})(i[s],e,r)||(a=!1)}}),a}var eB=jC,tB=eI,nB=["areaStyle","lineStyle","nodeStyle","linkStyle","chordStyle","label","labelLine"];function iB(e){var t=e&&e.itemStyle;if(t)for(var n=0,i=nB.length;n<i;n++){var a=nB[n],r=t.normal,s=t.emphasis;r&&r[a]&&(e[a]=e[a]||{},e[a].normal?PC(e[a].normal,r[a]):e[a].normal=r[a],r[a]=null),s&&s[a]&&(e[a]=e[a]||{},e[a].emphasis?PC(e[a].emphasis,s[a]):e[a].emphasis=s[a],s[a]=null)}}function aB(e,t,n){if(e&&e[t]&&(e[t].normal||e[t].emphasis)){var i=e[t].normal,a=e[t].emphasis;i&&(n?(e[t].normal=e[t].emphasis=null,$C(e[t],i)):e[t]=i),a&&(e.emphasis=e.emphasis||{},e.emphasis[t]=a,a.focus&&(e.emphasis.focus=a.focus),a.blurScope&&(e.emphasis.blurScope=a.blurScope))}}function rB(e){aB(e,"itemStyle"),aB(e,"lineStyle"),aB(e,"areaStyle"),aB(e,"label"),aB(e,"labelLine"),aB(e,"upperLabel"),aB(e,"edgeLabel")}function sB(e,t){var n=tB(e)&&e[t],i=tB(n)&&n.textStyle;if(i)for(var a=0,r=AE.length;a<r;a++){var s=AE[a];i.hasOwnProperty(s)&&(n[s]=i[s])}}function oB(e){e&&(rB(e),sB(e,"label"),e.emphasis&&sB(e.emphasis,"label"))}function lB(e){return KC(e)?e:e?[e]:[]}function cB(e){return(KC(e)?e[0]:e)||{}}function dB(e,t){eB(lB(e.series),function(e){tB(e)&&function(e){if(tB(e)){iB(e),rB(e),sB(e,"label"),sB(e,"upperLabel"),sB(e,"edgeLabel"),e.emphasis&&(sB(e.emphasis,"label"),sB(e.emphasis,"upperLabel"),sB(e.emphasis,"edgeLabel"));var t=e.markPoint;t&&(iB(t),oB(t));var n=e.markLine;n&&(iB(n),oB(n));var i=e.markArea;i&&oB(i);var a=e.data;if("graph"===e.type){a=a||e.nodes;var r=e.links||e.edges;if(r&&!nI(r))for(var s=0;s<r.length;s++)oB(r[s]);jC(e.categories,function(e){rB(e)})}if(a&&!nI(a))for(s=0;s<a.length;s++)oB(a[s]);if((t=e.markPoint)&&t.data){var o=t.data;for(s=0;s<o.length;s++)oB(o[s])}if((n=e.markLine)&&n.data){var l=n.data;for(s=0;s<l.length;s++)KC(l[s])?(oB(l[s][0]),oB(l[s][1])):oB(l[s])}"gauge"===e.type?(sB(e,"axisLabel"),sB(e,"title"),sB(e,"detail")):"treemap"===e.type?(aB(e.breadcrumb,"itemStyle"),jC(e.levels,function(e){rB(e)})):"tree"===e.type&&rB(e.leaves)}}(e)});var n=["xAxis","yAxis","radiusAxis","angleAxis","singleAxis","parallelAxis","radar"];t&&n.push("valueAxis","categoryAxis","logAxis","timeAxis"),eB(n,function(t){eB(lB(e[t]),function(e){e&&(sB(e,"axisLabel"),sB(e.axisPointer,"label"))})}),eB(lB(e.parallel),function(e){var t=e&&e.parallelAxisDefault;sB(t,"axisLabel"),sB(t&&t.axisPointer,"label")}),eB(lB(e.calendar),function(e){aB(e,"itemStyle"),sB(e,"dayLabel"),sB(e,"monthLabel"),sB(e,"yearLabel")}),eB(lB(e.radar),function(e){sB(e,"name"),e.name&&null==e.axisName&&(e.axisName=e.name,delete e.name),null!=e.nameGap&&null==e.axisNameGap&&(e.axisNameGap=e.nameGap,delete e.nameGap)}),eB(lB(e.geo),function(e){tB(e)&&(oB(e),eB(lB(e.regions),function(e){oB(e)}))}),eB(lB(e.timeline),function(e){oB(e),aB(e,"label"),aB(e,"itemStyle"),aB(e,"controlStyle",!0);var t=e.data;KC(t)&&jC(t,function(e){eI(e)&&(aB(e,"label"),aB(e,"itemStyle"))})}),eB(lB(e.toolbox),function(e){aB(e,"iconStyle"),eB(e.feature,function(e){aB(e,"iconStyle")})}),sB(cB(e.axisPointer),"label"),sB(cB(e.tooltip).axisPointer,"label")}function uB(e){e&&jC(hB,function(t){t[0]in e&&!(t[1]in e)&&(e[t[1]]=e[t[0]])})}var hB=[["x","left"],["y","top"],["x2","right"],["y2","bottom"]],pB=["grid","geo","parallel","legend","toolbox","title","visualMap","dataZoom","timeline"],gB=[["borderRadius","barBorderRadius"],["borderColor","barBorderColor"],["borderWidth","barBorderWidth"]];function vB(e){var t=e&&e.itemStyle;if(t)for(var n=0;n<gB.length;n++){var i=gB[n][1],a=gB[n][0];null!=t[i]&&(t[a]=t[i])}}function fB(e){e&&"edge"===e.alignTo&&null!=e.margin&&null==e.edgeDistance&&(e.edgeDistance=e.margin)}function mB(e){e&&e.downplay&&!e.blur&&(e.blur=e.downplay)}function yB(e,t){if(e)for(var n=0;n<e.length;n++)t(e[n]),e[n]&&yB(e[n].children,t)}function bB(e,t){dB(e,t),e.series=TE(e.series),jC(e.series,function(e){if(eI(e)){var t=e.type;if("line"===t)null!=e.clipOverflow&&(e.clip=e.clipOverflow);else if("pie"===t||"gauge"===t){if(null!=e.clockWise&&(e.clockwise=e.clockWise),fB(e.label),(a=e.data)&&!nI(a))for(var n=0;n<a.length;n++)fB(a[n]);null!=e.hoverOffset&&(e.emphasis=e.emphasis||{},(e.emphasis.scaleSize=null)&&(e.emphasis.scaleSize=e.hoverOffset))}else if("gauge"===t){var i=function(e,t){for(var n=t.split(","),i=e,a=0;a<n.length&&null!=(i=i&&i[n[a]]);a++);return i}(e,"pointer.color");null!=i&&function(e,t,n){for(var i,a=t.split(","),r=e,s=0;s<a.length-1;s++)null==r[i=a[s]]&&(r[i]={}),r=r[i];null==r[a[s]]&&(r[a[s]]=n)}(e,"itemStyle.color",i)}else if("bar"===t){var a;if(vB(e),vB(e.backgroundStyle),vB(e.emphasis),(a=e.data)&&!nI(a))for(n=0;n<a.length;n++)"object"==typeof a[n]&&(vB(a[n]),vB(a[n]&&a[n].emphasis))}else if("sunburst"===t){var r=e.highlightPolicy;r&&(e.emphasis=e.emphasis||{},e.emphasis.focus||(e.emphasis.focus=r)),mB(e),yB(e.data,mB)}else"graph"===t||"sankey"===t?function(e){e&&null!=e.focusNodeAdjacency&&(e.emphasis=e.emphasis||{},null==e.emphasis.focus&&(e.emphasis.focus="adjacency"))}(e):"map"===t&&(e.mapType&&!e.map&&(e.map=e.mapType),e.mapLocation&&$C(e,e.mapLocation));null!=e.hoverAnimation&&(e.emphasis=e.emphasis||{},e.emphasis&&null==e.emphasis.scale&&(e.emphasis.scale=e.hoverAnimation)),uB(e)}}),e.dataRange&&(e.visualMap=e.dataRange),jC(pB,function(t){var n=e[t];n&&(KC(n)||(n=[n]),jC(n,function(e){uB(e)}))})}var wB,kB,SB,xB,_B,CB,IB=function(){return function(e){this.data=e.data||(e.sourceFormat===_F?{}:[]),this.sourceFormat=e.sourceFormat||IF,this.seriesLayoutBy=e.seriesLayoutBy||DF,this.startIndex=e.startIndex||0,this.dimensionsDetectedCount=e.dimensionsDetectedCount,this.metaRawOption=e.metaRawOption;var t=this.dimensionsDefine=e.dimensionsDefine;if(t)for(var n=0;n<t.length;n++){var i=t[n];null==i.type&&OF(this,n)===MF&&(i.type="ordinal")}}}();function DB(e){return e instanceof IB}function TB(e,t,n){n=n||AB(e);var i=t.seriesLayoutBy,a=function(e,t,n,i,a){var r,s;if(!e)return{dimensionsDefine:EB(a),startIndex:s,dimensionsDetectedCount:r};if(t===SF){var o=e;"auto"===i||null==i?zB(function(e){null!=e&&"-"!==e&&(YC(e)?null==s&&(s=1):s=0)},n,o,10):s=JC(i)?i:i?1:0,a||1!==s||(a=[],zB(function(e,t){a[t]=null!=e?e+"":""},n,o,1/0)),r=a?a.length:n===TF?o.length:o[0]?o[0].length:null}else if(t===xF)a||(a=function(e){var t,n=0;for(;n<e.length&&!(t=e[n++]););if(t)return WC(t)}(e));else if(t===_F)a||(a=[],jC(e,function(e,t){a.push(t)}));else if(t===kF){var l=EE(e[0]);r=KC(l)&&l.length||1}return{startIndex:s,dimensionsDefine:EB(a),dimensionsDetectedCount:r}}(e,n,i,t.sourceHeader,t.dimensions);return new IB({data:e,sourceFormat:n,seriesLayoutBy:i,dimensionsDefine:a.dimensionsDefine,startIndex:a.startIndex,dimensionsDetectedCount:a.dimensionsDetectedCount,metaRawOption:zC(t)})}function MB(e){return new IB({data:e,sourceFormat:nI(e)?CF:kF})}function AB(e){var t=IF;if(nI(e))t=CF;else if(KC(e)){0===e.length&&(t=SF);for(var n=0,i=e.length;n<i;n++){var a=e[n];if(null!=a){if(KC(a)||nI(a)){t=SF;break}if(eI(a)){t=xF;break}}}}else if(eI(e))for(var r in e)if(CI(e,r)&&BC(e[r])){t=_F;break}return t}function EB(e){if(e){var t=kI();return UC(e,function(e,n){var i={name:(e=eI(e)?e:{name:e}).name,displayName:e.displayName,type:e.type};if(null==i.name)return i;i.name+="",null==i.displayName&&(i.displayName=i.name);var a=t.get(i.name);return a?i.name+="-"+a.count++:t.set(i.name,{count:1}),i})}}function zB(e,t,n,i){if(t===TF)for(var a=0;a<n.length&&a<i;a++)e(n[a]?n[a][0]:null,a);else{var r=n[0]||[];for(a=0;a<r.length&&a<i;a++)e(r[a],a)}}function PB(e){var t=e.sourceFormat;return t===xF||t===_F}var RB=function(){function e(e,t){var n=DB(e)?e:MB(e);this._source=n;var i=this._data=n.data,a=n.sourceFormat;n.seriesLayoutBy,a===CF&&(this._offset=0,this._dimSize=t,this._data=i),CB(this,i,n)}var t;return e.prototype.getSource=function(){return this._source},e.prototype.count=function(){return 0},e.prototype.getItem=function(e,t){},e.prototype.appendData=function(e){},e.prototype.clean=function(){},e.protoInitialize=((t=e.prototype).pure=!1,void(t.persistent=!0)),e.internalField=function(){var e;CB=function(e,a,r){var s=r.sourceFormat,o=r.seriesLayoutBy,l=r.startIndex,c=r.dimensionsDefine;if(RC(e,_B[HB(s,o)]),s===CF)e.getItem=t,e.count=i,e.fillStorage=n;else{var d=NB(s,o);e.getItem=GC(d,null,a,l,c);var u=jB(s,o);e.count=GC(u,null,a,l,c)}};var t=function(e,t){e-=this._offset,t=t||[];for(var n=this._data,i=this._dimSize,a=i*e,r=0;r<i;r++)t[r]=n[a+r];return t},n=function(e,t,n,i){for(var a=this._data,r=this._dimSize,s=0;s<r;s++){for(var o=i[s],l=null==o[0]?1/0:o[0],c=null==o[1]?-1/0:o[1],d=t-e,u=n[s],h=0;h<d;h++){var p=a[h*r+s];u[e+h]=p,p<l&&(l=p),p>c&&(c=p)}o[0]=l,o[1]=c}},i=function(){return this._data?this._data.length/this._dimSize:0};function a(e){for(var t=0;t<e.length;t++)this._data.push(e[t])}(e={})[SF+"_"+DF]={pure:!0,appendData:a},e[SF+"_"+TF]={pure:!0,appendData:function(){throw new Error('Do not support appendData when set seriesLayoutBy: "row".')}},e[xF]={pure:!0,appendData:a},e[_F]={pure:!0,appendData:function(e){var t=this._data;jC(e,function(e,n){for(var i=t[n]||(t[n]=[]),a=0;a<(e||[]).length;a++)i.push(e[a])})}},e[kF]={appendData:a},e[CF]={persistent:!1,pure:!0,appendData:function(e){this._data=e},clean:function(){this._offset+=this.count(),this._data=null}},_B=e}(),e}(),$B=function(e){KC(e)};(wB={})[SF+"_"+DF]=$B,wB[SF+"_"+TF]=$B,wB[xF]=$B,wB[_F]=function(e,t){for(var n=0;n<t.length;n++){null==t[n].name&&xE()}},wB[kF]=$B;var OB=function(e,t,n,i){return e[i]},LB=((kB={})[SF+"_"+DF]=function(e,t,n,i){return e[i+t]},kB[SF+"_"+TF]=function(e,t,n,i,a){i+=t;for(var r=a||[],s=e,o=0;o<s.length;o++){var l=s[o];r[o]=l?l[i]:null}return r},kB[xF]=OB,kB[_F]=function(e,t,n,i,a){for(var r=a||[],s=0;s<n.length;s++){var o=n[s].name,l=null!=o?e[o]:null;r[s]=l?l[i]:null}return r},kB[kF]=OB,kB);function NB(e,t){return LB[HB(e,t)]}var FB=function(e,t,n){return e.length},BB=((SB={})[SF+"_"+DF]=function(e,t,n){return Math.max(0,e.length-t)},SB[SF+"_"+TF]=function(e,t,n){var i=e[0];return i?Math.max(0,i.length-t):0},SB[xF]=FB,SB[_F]=function(e,t,n){var i=n[0].name,a=null!=i?e[i]:null;return a?a.length:0},SB[kF]=FB,SB);function jB(e,t){return BB[HB(e,t)]}var UB=function(e,t,n){return e[t]},VB=((xB={})[SF]=UB,xB[xF]=function(e,t,n){return e[n]},xB[_F]=UB,xB[kF]=function(e,t,n){var i=EE(e);return i instanceof Array?i[t]:i},xB[CF]=UB,xB);function qB(e){return VB[e]}function HB(e,t){return e===SF?e+"_"+t:e}function WB(e,t,n){if(e){var i=e.getRawDataItem(t);if(null!=i){var a=e.getStore(),r=a.getSource().sourceFormat;if(null!=n){var s=e.getDimensionIndex(n),o=a.getDimensionProperty(s);return qB(r)(i,s,o)}var l=i;return r===kF&&(l=EE(i)),l}}}var GB=/\{@(.+?)\}/g,QB=function(){function e(){}return e.prototype.getDataParams=function(e,t){var n=this.getData(t),i=this.getRawValue(e,t),a=n.getRawIndex(e),r=n.getName(e),s=n.getRawDataItem(e),o=n.getItemVisual(e,"style"),l=o&&o[n.getItemVisual(e,"drawType")||"fill"],c=o&&o.stroke,d=this.mainType,u="series"===d,h=n.userOutput&&n.userOutput.get();return{componentType:d,componentSubType:this.subType,componentIndex:this.componentIndex,seriesType:u?this.subType:null,seriesIndex:this.seriesIndex,seriesId:u?this.id:null,seriesName:u?this.name:null,name:r,dataIndex:a,data:s,dataType:t,value:i,color:l,borderColor:c,dimensionNames:h?h.fullDimensions:null,encode:h?h.encode:null,$vars:["seriesName","name","value"]}},e.prototype.getFormattedLabel=function(e,t,n,i,a,r){t=t||"normal";var s=this.getData(n),o=this.getDataParams(e,n);(r&&(o.value=r.interpolatedValue),null!=i&&KC(o.value)&&(o.value=o.value[i]),a)||(a=s.getItemModel(e).get("normal"===t?["label","formatter"]:[t,"label","formatter"]));return ZC(a)?(o.status=t,o.dimensionIndex=i,a(o)):YC(a)?ON(a,o).replace(GB,function(t,n){var i=n.length,a=n;"["===a.charAt(0)&&"]"===a.charAt(i-1)&&(a=+a.slice(1,i-1));var o=WB(s,e,a);if(r&&KC(r.interpolatedValue)){var l=s.getDimensionIndex(a);l>=0&&(o=r.interpolatedValue[l])}return null!=o?o+"":""}):void 0},e.prototype.getRawValue=function(e,t){return WB(this.getData(t),e)},e.prototype.formatTooltip=function(e,t,n){},e}();function KB(e){var t,n;return eI(e)?e.type&&(n=e):t=e,{text:t,frag:n}}function ZB(e){return new YB(e)}var YB=function(){function e(e){e=e||{},this._reset=e.reset,this._plan=e.plan,this._count=e.count,this._onDirty=e.onDirty,this._dirty=!0}return e.prototype.perform=function(e){var t,n=this._upstream,i=e&&e.skip;if(this._dirty&&n){var a=this.context;a.data=a.outputData=n.context.outputData}this.__pipeline&&(this.__pipeline.currentTask=this),this._plan&&!i&&(t=this._plan(this.context));var r,s=d(this._modBy),o=this._modDataCount||0,l=d(e&&e.modBy),c=e&&e.modDataCount||0;function d(e){return!(e>=1)&&(e=1),e}s===l&&o===c||(t="reset"),(this._dirty||"reset"===t)&&(this._dirty=!1,r=this._doReset(i)),this._modBy=l,this._modDataCount=c;var u=e&&e.step;if(this._dueEnd=n?n._outputDueEnd:this._count?this._count(this.context):1/0,this._progress){var h=this._dueIndex,p=Math.min(null!=u?this._dueIndex+u:1/0,this._dueEnd);if(!i&&(r||h<p)){var g=this._progress;if(KC(g))for(var v=0;v<g.length;v++)this._doProgress(g[v],h,p,l,c);else this._doProgress(g,h,p,l,c)}this._dueIndex=p;var f=null!=this._settedOutputEnd?this._settedOutputEnd:p;this._outputDueEnd=f}else this._dueIndex=this._outputDueEnd=null!=this._settedOutputEnd?this._settedOutputEnd:this._dueEnd;return this.unfinished()},e.prototype.dirty=function(){this._dirty=!0,this._onDirty&&this._onDirty(this.context)},e.prototype._doProgress=function(e,t,n,i,a){XB.reset(t,n,i,a),this._callingProgress=e,this._callingProgress({start:t,end:n,count:n-t,next:XB.next},this.context)},e.prototype._doReset=function(e){var t,n;this._dueIndex=this._outputDueEnd=this._dueEnd=0,this._settedOutputEnd=null,!e&&this._reset&&((t=this._reset(this.context))&&t.progress&&(n=t.forceFirstProgress,t=t.progress),KC(t)&&!t.length&&(t=null)),this._progress=t,this._modBy=this._modDataCount=null;var i=this._downstream;return i&&i.dirty(),n},e.prototype.unfinished=function(){return this._progress&&this._dueIndex<this._dueEnd},e.prototype.pipe=function(e){(this._downstream!==e||this._dirty)&&(this._downstream=e,e._upstream=this,e.dirty())},e.prototype.dispose=function(){this._disposed||(this._upstream&&(this._upstream._downstream=null),this._downstream&&(this._downstream._upstream=null),this._dirty=!1,this._disposed=!0)},e.prototype.getUpstream=function(){return this._upstream},e.prototype.getDownstream=function(){return this._downstream},e.prototype.setOutputEnd=function(e){this._outputDueEnd=this._settedOutputEnd=e},e}(),XB=function(){var e,t,n,i,a,r={reset:function(l,c,d,u){t=l,e=c,n=d,i=u,a=Math.ceil(i/n),r.next=n>1&&i>0?o:s}};return r;function s(){return t<e?t++:null}function o(){var r=t%a*n+Math.ceil(t/a),s=t>=e?null:r<i?r:t;return t++,s}}();function JB(e,t){var n=t&&t.type;return"ordinal"===n?e:("time"!==n||JC(e)||null==e||"-"===e||(e=+pE(e)),null==e||""===e?NaN:Number(e))}var ej=kI({number:function(e){return parseFloat(e)},time:function(e){return+pE(e)},trim:function(e){return YC(e)?gI(e):e}});function tj(e){return ej.get(e)}var nj={lt:function(e,t){return e<t},lte:function(e,t){return e<=t},gt:function(e,t){return e>t},gte:function(e,t){return e>=t}},ij=function(){function e(e,t){if(!JC(t)){_E("")}this._opFn=nj[e],this._rvalFloat=yE(t)}return e.prototype.evaluate=function(e){return JC(e)?this._opFn(e,this._rvalFloat):this._opFn(yE(e),this._rvalFloat)},e}(),aj=function(){function e(e,t){var n="desc"===e;this._resultLT=n?1:-1,null==t&&(t=n?"min":"max"),this._incomparable="min"===t?-1/0:1/0}return e.prototype.evaluate=function(e,t){var n=JC(e)?e:yE(e),i=JC(t)?t:yE(t),a=isNaN(n),r=isNaN(i);if(a&&(n=this._incomparable),r&&(i=this._incomparable),a&&r){var s=YC(e),o=YC(t);s&&(n=o?e:0),o&&(i=s?t:0)}return n<i?this._resultLT:n>i?-this._resultLT:0},e}(),rj=function(){function e(e,t){this._rval=t,this._isEQ=e,this._rvalTypeof=typeof t,this._rvalFloat=yE(t)}return e.prototype.evaluate=function(e){var t=e===this._rval;if(!t){var n=typeof e;n===this._rvalTypeof||"number"!==n&&"number"!==this._rvalTypeof||(t=yE(e)===this._rvalFloat)}return this._isEQ?t:!t},e}();function sj(e,t){return"eq"===e||"ne"===e?new rj("eq"===e,t):CI(nj,e)?new ij(e,t):null}var oj=function(){function e(){}return e.prototype.getRawData=function(){throw new Error("not supported")},e.prototype.getRawDataItem=function(e){throw new Error("not supported")},e.prototype.cloneRawData=function(){},e.prototype.getDimensionInfo=function(e){},e.prototype.cloneAllDimensionInfo=function(){},e.prototype.count=function(){},e.prototype.retrieveValue=function(e,t){},e.prototype.retrieveValueFromItem=function(e,t){},e.prototype.convertValue=function(e,t){return JB(e,t)},e}();function lj(e){if(!gj(e.sourceFormat)){_E("")}return e.data}function cj(e){var t=e.sourceFormat,n=e.data;if(!gj(t)){_E("")}if(t===SF){for(var i=[],a=0,r=n.length;a<r;a++)i.push(n[a].slice());return i}if(t===xF){for(i=[],a=0,r=n.length;a<r;a++)i.push(RC({},n[a]));return i}}function dj(e,t,n){if(null!=n)return JC(n)||!isNaN(n)&&!CI(t,n)?e[n]:CI(t,n)?t[n]:void 0}function uj(e){return zC(e)}var hj=kI();function pj(e,t,n,i){t.length||_E(""),eI(e)||_E("");var a=e.type,r=hj.get(a);r||_E("");var s=UC(t,function(e){return function(e,t){var n=new oj,i=e.data,a=n.sourceFormat=e.sourceFormat,r=e.startIndex;e.seriesLayoutBy!==DF&&_E("");var s=[],o={},l=e.dimensionsDefine;if(l)jC(l,function(e,t){var n=e.name,i={index:t,name:n,displayName:e.displayName};s.push(i),null!=n&&(CI(o,n)&&_E(""),o[n]=i)});else for(var c=0;c<e.dimensionsDetectedCount;c++)s.push({index:c});var d=NB(a,DF);t.__isBuiltIn&&(n.getRawDataItem=function(e){return d(i,r,s,e)},n.getRawData=GC(lj,null,e)),n.cloneRawData=GC(cj,null,e);var u=jB(a,DF);n.count=GC(u,null,i,r,s);var h=qB(a);n.retrieveValue=function(e,t){var n=d(i,r,s,e);return p(n,t)};var p=n.retrieveValueFromItem=function(e,t){if(null!=e){var n=s[t];return n?h(e,t,n.name):void 0}};return n.getDimensionInfo=GC(dj,null,s,o),n.cloneAllDimensionInfo=GC(uj,null,s),n}(e,r)});return UC(TE(r.transform({upstream:s[0],upstreamList:s,config:zC(e.config)})),function(e,n){var i;eI(e)||_E(""),e.data||_E(""),gj(AB(e.data))||_E("");var a=t[0];if(a&&0===n&&!e.dimensions){var r=a.startIndex;r&&(e.data=a.data.slice(0,r).concat(e.data)),i={seriesLayoutBy:DF,sourceHeader:r,dimensions:a.metaRawOption.dimensions}}else i={seriesLayoutBy:DF,sourceHeader:0,dimensions:e.dimensions};return TB(e.data,i,null)})}function gj(e){return e===SF||e===xF}var vj,fj="undefined",mj=typeof Uint32Array===fj?Array:Uint32Array,yj=typeof Uint16Array===fj?Array:Uint16Array,bj=typeof Int32Array===fj?Array:Int32Array,wj=typeof Float64Array===fj?Array:Float64Array,kj={float:wj,int:bj,ordinal:Array,number:Array,time:wj};function Sj(e){return e>65535?mj:yj}function xj(){return[1/0,-1/0]}function _j(e){var t=e.constructor;return t===Array?e.slice():new t(e)}function Cj(e,t,n,i,a){var r=kj[n||"float"];if(a){var s=e[t],o=s&&s.length;if(o!==i){for(var l=new r(i),c=0;c<o;c++)l[c]=s[c];e[t]=l}}else e[t]=new r(i)}var Ij=function(){function e(){this._chunks=[],this._rawExtent=[],this._extent=[],this._count=0,this._rawCount=0,this._calcDimNameToIdx=kI()}return e.prototype.initData=function(e,t,n){this._provider=e,this._chunks=[],this._indices=null,this.getRawIndex=this._getRawIdxIdentity;var i=e.getSource(),a=this.defaultDimValueGetter=vj[i.sourceFormat];this._dimValueGetter=n||a,this._rawExtent=[],PB(i),this._dimensions=UC(t,function(e){return{type:e.type,property:e.property}}),this._initDataFromProvider(0,e.count())},e.prototype.getProvider=function(){return this._provider},e.prototype.getSource=function(){return this._provider.getSource()},e.prototype.ensureCalculationDimension=function(e,t){var n=this._calcDimNameToIdx,i=this._dimensions,a=n.get(e);if(null!=a){if(i[a].type===t)return a}else a=i.length;return i[a]={type:t},n.set(e,a),this._chunks[a]=new kj[t||"float"](this._rawCount),this._rawExtent[a]=[1/0,-1/0],a},e.prototype.collectOrdinalMeta=function(e,t){var n=this._chunks[e],i=this._dimensions[e],a=this._rawExtent,r=i.ordinalOffset||0,s=n.length;0===r&&(a[e]=[1/0,-1/0]);for(var o=a[e],l=r;l<s;l++){var c=n[l]=t.parseAndCollect(n[l]);isNaN(c)||(o[0]=Math.min(c,o[0]),o[1]=Math.max(c,o[1]))}i.ordinalMeta=t,i.ordinalOffset=s,i.type="ordinal"},e.prototype.getOrdinalMeta=function(e){return this._dimensions[e].ordinalMeta},e.prototype.getDimensionProperty=function(e){var t=this._dimensions[e];return t&&t.property},e.prototype.appendData=function(e){var t=this._provider,n=this.count();t.appendData(e);var i=t.count();return t.persistent||(i+=n),n<i&&this._initDataFromProvider(n,i,!0),[n,i]},e.prototype.appendValues=function(e,t){for(var n=this._chunks,i=this._dimensions,a=i.length,r=this._rawExtent,s=this.count(),o=s+Math.max(e.length,t||0),l=0;l<a;l++){Cj(n,l,(p=i[l]).type,o,!0)}for(var c=[],d=s;d<o;d++)for(var u=d-s,h=0;h<a;h++){var p=i[h],g=vj.arrayRows.call(this,e[u]||c,p.property,u,h);n[h][d]=g;var v=r[h];g<v[0]&&(v[0]=g),g>v[1]&&(v[1]=g)}return this._rawCount=this._count=o,{start:s,end:o}},e.prototype._initDataFromProvider=function(e,t,n){for(var i=this._provider,a=this._chunks,r=this._dimensions,s=r.length,o=this._rawExtent,l=UC(r,function(e){return e.property}),c=0;c<s;c++){var d=r[c];o[c]||(o[c]=xj()),Cj(a,c,d.type,t,n)}if(i.fillStorage)i.fillStorage(e,t,a,o);else for(var u=[],h=e;h<t;h++){u=i.getItem(h,u);for(var p=0;p<s;p++){var g=a[p],v=this._dimValueGetter(u,l[p],h,p);g[h]=v;var f=o[p];v<f[0]&&(f[0]=v),v>f[1]&&(f[1]=v)}}!i.persistent&&i.clean&&i.clean(),this._rawCount=this._count=t,this._extent=[]},e.prototype.count=function(){return this._count},e.prototype.get=function(e,t){if(!(t>=0&&t<this._count))return NaN;var n=this._chunks[e];return n?n[this.getRawIndex(t)]:NaN},e.prototype.getValues=function(e,t){var n=[],i=[];if(null==t){t=e,e=[];for(var a=0;a<this._dimensions.length;a++)i.push(a)}else i=e;a=0;for(var r=i.length;a<r;a++)n.push(this.get(i[a],t));return n},e.prototype.getByRawIndex=function(e,t){if(!(t>=0&&t<this._rawCount))return NaN;var n=this._chunks[e];return n?n[t]:NaN},e.prototype.getSum=function(e){var t=0;if(this._chunks[e])for(var n=0,i=this.count();n<i;n++){var a=this.get(e,n);isNaN(a)||(t+=a)}return t},e.prototype.getMedian=function(e){var t=[];this.each([e],function(e){isNaN(e)||t.push(e)});var n=t.sort(function(e,t){return e-t}),i=this.count();return 0===i?0:i%2==1?n[(i-1)/2]:(n[i/2]+n[i/2-1])/2},e.prototype.indexOfRawIndex=function(e){if(e>=this._rawCount||e<0)return-1;if(!this._indices)return e;var t=this._indices,n=t[e];if(null!=n&&n<this._count&&n===e)return e;for(var i=0,a=this._count-1;i<=a;){var r=(i+a)/2|0;if(t[r]<e)i=r+1;else{if(!(t[r]>e))return r;a=r-1}}return-1},e.prototype.getIndices=function(){var e,t=this._indices;if(t){var n=t.constructor,i=this._count;if(n===Array){e=new n(i);for(var a=0;a<i;a++)e[a]=t[a]}else e=new n(t.buffer,0,i)}else{e=new(n=Sj(this._rawCount))(this.count());for(a=0;a<e.length;a++)e[a]=a}return e},e.prototype.filter=function(e,t){if(!this._count)return this;for(var n=this.clone(),i=n.count(),a=new(Sj(n._rawCount))(i),r=[],s=e.length,o=0,l=e[0],c=n._chunks,d=0;d<i;d++){var u=void 0,h=n.getRawIndex(d);if(0===s)u=t(d);else if(1===s){u=t(c[l][h],d)}else{for(var p=0;p<s;p++)r[p]=c[e[p]][h];r[p]=d,u=t.apply(null,r)}u&&(a[o++]=h)}return o<i&&(n._indices=a),n._count=o,n._extent=[],n._updateGetRawIdx(),n},e.prototype.selectRange=function(e){var t=this.clone(),n=t._count;if(!n)return this;var i=WC(e),a=i.length;if(!a)return this;var r=t.count(),s=new(Sj(t._rawCount))(r),o=0,l=i[0],c=e[l][0],d=e[l][1],u=t._chunks,h=!1;if(!t._indices){var p=0;if(1===a){for(var g=u[i[0]],v=0;v<n;v++){((b=g[v])>=c&&b<=d||isNaN(b))&&(s[o++]=p),p++}h=!0}else if(2===a){g=u[i[0]];var f=u[i[1]],m=e[i[1]][0],y=e[i[1]][1];for(v=0;v<n;v++){var b=g[v],w=f[v];(b>=c&&b<=d||isNaN(b))&&(w>=m&&w<=y||isNaN(w))&&(s[o++]=p),p++}h=!0}}if(!h)if(1===a)for(v=0;v<r;v++){var k=t.getRawIndex(v);((b=u[i[0]][k])>=c&&b<=d||isNaN(b))&&(s[o++]=k)}else for(v=0;v<r;v++){for(var S=!0,x=(k=t.getRawIndex(v),0);x<a;x++){var _=i[x];((b=u[_][k])<e[_][0]||b>e[_][1])&&(S=!1)}S&&(s[o++]=t.getRawIndex(v))}return o<r&&(t._indices=s),t._count=o,t._extent=[],t._updateGetRawIdx(),t},e.prototype.map=function(e,t){var n=this.clone(e);return this._updateDims(n,e,t),n},e.prototype.modify=function(e,t){this._updateDims(this,e,t)},e.prototype._updateDims=function(e,t,n){for(var i=e._chunks,a=[],r=t.length,s=e.count(),o=[],l=e._rawExtent,c=0;c<t.length;c++)l[t[c]]=xj();for(var d=0;d<s;d++){for(var u=e.getRawIndex(d),h=0;h<r;h++)o[h]=i[t[h]][u];o[r]=d;var p=n&&n.apply(null,o);if(null!=p){"object"!=typeof p&&(a[0]=p,p=a);for(c=0;c<p.length;c++){var g=t[c],v=p[c],f=l[g],m=i[g];m&&(m[u]=v),v<f[0]&&(f[0]=v),v>f[1]&&(f[1]=v)}}}},e.prototype.lttbDownSample=function(e,t){var n,i,a,r=this.clone([e],!0),s=r._chunks[e],o=this.count(),l=0,c=Math.floor(1/t),d=this.getRawIndex(0),u=new(Sj(this._rawCount))(Math.min(2*(Math.ceil(o/c)+2),o));u[l++]=d;for(var h=1;h<o-1;h+=c){for(var p=Math.min(h+c,o-1),g=Math.min(h+2*c,o),v=(g+p)/2,f=0,m=p;m<g;m++){var y=s[C=this.getRawIndex(m)];isNaN(y)||(f+=y)}f/=g-p;var b=h,w=Math.min(h+c,o),k=h-1,S=s[d];n=-1,a=b;var x=-1,_=0;for(m=b;m<w;m++){var C;y=s[C=this.getRawIndex(m)];isNaN(y)?(_++,x<0&&(x=C)):(i=Math.abs((k-v)*(y-S)-(k-m)*(f-S)))>n&&(n=i,a=C)}_>0&&_<w-b&&(u[l++]=Math.min(x,a),a=Math.max(x,a)),u[l++]=a,d=a}return u[l++]=this.getRawIndex(o-1),r._count=l,r._indices=u,r.getRawIndex=this._getRawIdx,r},e.prototype.minmaxDownSample=function(e,t){for(var n=this.clone([e],!0),i=n._chunks,a=Math.floor(1/t),r=i[e],s=this.count(),o=new(Sj(this._rawCount))(2*Math.ceil(s/a)),l=0,c=0;c<s;c+=a){var d=c,u=r[this.getRawIndex(d)],h=c,p=r[this.getRawIndex(h)],g=a;c+a>s&&(g=s-c);for(var v=0;v<g;v++){var f=r[this.getRawIndex(c+v)];f<u&&(u=f,d=c+v),f>p&&(p=f,h=c+v)}var m=this.getRawIndex(d),y=this.getRawIndex(h);d<h?(o[l++]=m,o[l++]=y):(o[l++]=y,o[l++]=m)}return n._count=l,n._indices=o,n._updateGetRawIdx(),n},e.prototype.downSample=function(e,t,n,i){for(var a=this.clone([e],!0),r=a._chunks,s=[],o=Math.floor(1/t),l=r[e],c=this.count(),d=a._rawExtent[e]=[1/0,-1/0],u=new(Sj(this._rawCount))(Math.ceil(c/o)),h=0,p=0;p<c;p+=o){o>c-p&&(o=c-p,s.length=o);for(var g=0;g<o;g++){var v=this.getRawIndex(p+g);s[g]=l[v]}var f=n(s),m=this.getRawIndex(Math.min(p+i(s,f)||0,c-1));l[m]=f,f<d[0]&&(d[0]=f),f>d[1]&&(d[1]=f),u[h++]=m}return a._count=h,a._indices=u,a._updateGetRawIdx(),a},e.prototype.each=function(e,t){if(this._count)for(var n=e.length,i=this._chunks,a=0,r=this.count();a<r;a++){var s=this.getRawIndex(a);switch(n){case 0:t(a);break;case 1:t(i[e[0]][s],a);break;case 2:t(i[e[0]][s],i[e[1]][s],a);break;default:for(var o=0,l=[];o<n;o++)l[o]=i[e[o]][s];l[o]=a,t.apply(null,l)}}},e.prototype.getDataExtent=function(e){var t=this._chunks[e],n=[1/0,-1/0];if(!t)return n;var i,a=this.count();if(!this._indices)return this._rawExtent[e].slice();if(i=this._extent[e])return i.slice();for(var r=(i=n)[0],s=i[1],o=0;o<a;o++){var l=t[this.getRawIndex(o)];l<r&&(r=l),l>s&&(s=l)}return i=[r,s],this._extent[e]=i,i},e.prototype.getRawDataItem=function(e){var t=this.getRawIndex(e);if(this._provider.persistent)return this._provider.getItem(t);for(var n=[],i=this._chunks,a=0;a<i.length;a++)n.push(i[a][t]);return n},e.prototype.clone=function(t,n){var i=new e,a=this._chunks,r=t&&VC(t,function(e,t){return e[t]=!0,e},{});if(r)for(var s=0;s<a.length;s++)i._chunks[s]=r[s]?_j(a[s]):a[s];else i._chunks=a;return this._copyCommonProps(i),n||(i._indices=this._cloneIndices()),i._updateGetRawIdx(),i},e.prototype._copyCommonProps=function(e){e._count=this._count,e._rawCount=this._rawCount,e._provider=this._provider,e._dimensions=this._dimensions,e._extent=zC(this._extent),e._rawExtent=zC(this._rawExtent)},e.prototype._cloneIndices=function(){if(this._indices){var e=this._indices.constructor,t=void 0;if(e===Array){var n=this._indices.length;t=new e(n);for(var i=0;i<n;i++)t[i]=this._indices[i]}else t=new e(this._indices);return t}return null},e.prototype._getRawIdxIdentity=function(e){return e},e.prototype._getRawIdx=function(e){return e<this._count&&e>=0?this._indices[e]:-1},e.prototype._updateGetRawIdx=function(){this.getRawIndex=this._indices?this._getRawIdx:this._getRawIdxIdentity},e.internalField=function(){function e(e,t,n,i){return JB(e[i],this._dimensions[i])}vj={arrayRows:e,objectRows:function(e,t,n,i){return JB(e[t],this._dimensions[i])},keyedColumns:e,original:function(e,t,n,i){var a=e&&(null==e.value?e:e.value);return JB(a instanceof Array?a[i]:a,this._dimensions[i])},typedArray:function(e,t,n,i){return e[i]}}}(),e}(),Dj=function(){function e(e){this._sourceList=[],this._storeList=[],this._upstreamSignList=[],this._versionSignBase=0,this._dirty=!0,this._sourceHost=e}return e.prototype.dirty=function(){this._setLocalSource([],[]),this._storeList=[],this._dirty=!0},e.prototype._setLocalSource=function(e,t){this._sourceList=e,this._upstreamSignList=t,this._versionSignBase++,this._versionSignBase>9e10&&(this._versionSignBase=0)},e.prototype._getVersionSign=function(){return this._sourceHost.uid+"_"+this._versionSignBase},e.prototype.prepareSource=function(){this._isDirty()&&(this._createSource(),this._dirty=!1)},e.prototype._createSource=function(){this._setLocalSource([],[]);var e,t,n=this._sourceHost,i=this._getUpstreamSourceManagers(),a=!!i.length;if(Tj(n)){var r=n,s=void 0,o=void 0,l=void 0;if(a){var c=i[0];c.prepareSource(),s=(l=c.getSource()).data,o=l.sourceFormat,t=[c._getVersionSign()]}else o=nI(s=r.get("data",!0))?CF:kF,t=[];var d=this._getSourceMetaRawOption()||{},u=l&&l.metaRawOption||{},h=cI(d.seriesLayoutBy,u.seriesLayoutBy)||null,p=cI(d.sourceHeader,u.sourceHeader),g=cI(d.dimensions,u.dimensions);e=h!==u.seriesLayoutBy||!!p!=!!u.sourceHeader||g?[TB(s,{seriesLayoutBy:h,sourceHeader:p,dimensions:g},o)]:[]}else{var v=n;if(a){var f=this._applyTransform(i);e=f.sourceList,t=f.upstreamSignList}else{e=[TB(v.get("source",!0),this._getSourceMetaRawOption(),null)],t=[]}}this._setLocalSource(e,t)},e.prototype._applyTransform=function(e){var t,n=this._sourceHost,i=n.get("transform",!0),a=n.get("fromTransformResult",!0);if(null!=a){1!==e.length&&Mj("")}var r,s=[],o=[];return jC(e,function(e){e.prepareSource();var t=e.getSource(a||0);null==a||t||Mj(""),s.push(t),o.push(e._getVersionSign())}),i?t=function(e,t){var n=TE(e),i=n.length;i||_E("");for(var a=0,r=i;a<r;a++)t=pj(n[a],t),a!==r-1&&(t.length=Math.max(t.length,1));return t}(i,s,n.componentIndex):null!=a&&(t=[(r=s[0],new IB({data:r.data,sourceFormat:r.sourceFormat,seriesLayoutBy:r.seriesLayoutBy,dimensionsDefine:zC(r.dimensionsDefine),startIndex:r.startIndex,dimensionsDetectedCount:r.dimensionsDetectedCount}))]),{sourceList:t,upstreamSignList:o}},e.prototype._isDirty=function(){if(this._dirty)return!0;for(var e=this._getUpstreamSourceManagers(),t=0;t<e.length;t++){var n=e[t];if(n._isDirty()||this._upstreamSignList[t]!==n._getVersionSign())return!0}},e.prototype.getSource=function(e){e=e||0;var t=this._sourceList[e];if(!t){var n=this._getUpstreamSourceManagers();return n[0]&&n[0].getSource(e)}return t},e.prototype.getSharedDataStore=function(e){var t=e.makeStoreSchema();return this._innerGetDataStore(t.dimensions,e.source,t.hash)},e.prototype._innerGetDataStore=function(e,t,n){var i=this._storeList,a=i[0];a||(a=i[0]={});var r=a[n];if(!r){var s=this._getUpstreamSourceManagers()[0];Tj(this._sourceHost)&&s?r=s._innerGetDataStore(e,t,n):(r=new Ij).initData(new RB(t,e.length),e),a[n]=r}return r},e.prototype._getUpstreamSourceManagers=function(){var e=this._sourceHost;if(Tj(e)){var t=$F(e);return t?[t.getSourceManager()]:[]}return UC(function(e){return e.get("transform",!0)||e.get("fromTransformResult",!0)?WE(e.ecModel,"dataset",{index:e.get("fromDatasetIndex",!0),id:e.get("fromDatasetId",!0)},qE).models:[]}(e),function(e){return e.getSourceManager()})},e.prototype._getSourceMetaRawOption=function(){var e,t,n,i=this._sourceHost;if(Tj(i))e=i.get("seriesLayoutBy",!0),t=i.get("sourceHeader",!0),n=i.get("dimensions",!0);else if(!this._getUpstreamSourceManagers().length){var a=i;e=a.get("seriesLayoutBy",!0),t=a.get("sourceHeader",!0),n=a.get("dimensions",!0)}return{seriesLayoutBy:e,sourceHeader:t,dimensions:n}},e}();function Tj(e){return"series"===e.mainType}function Mj(e){throw new Error(e)}function Aj(e){var t=e.lineHeight;return null==t?"line-height:1":"line-height:"+cD(t+"")+"px"}function Ej(e,t){var n=e.color||uF.color.tertiary,i=e.fontSize||12,a=e.fontWeight||"400",r=e.color||uF.color.secondary,s=e.fontSize||14,o=e.fontWeight||"900";return"html"===t?{nameStyle:"font-size:"+cD(i+"")+"px;color:"+cD(n)+";font-weight:"+cD(a+""),valueStyle:"font-size:"+cD(s+"")+"px;color:"+cD(r)+";font-weight:"+cD(o+"")}:{nameStyle:{fontSize:i,fill:n,fontWeight:a},valueStyle:{fontSize:s,fill:r,fontWeight:o}}}var zj=[0,10,20,30],Pj=["","\n","\n\n","\n\n\n"];function Rj(e,t){return t.type=e,t}function $j(e){return"section"===e.type}function Oj(e){return $j(e)?Nj:Fj}function Lj(e){if($j(e)){var t=0,n=e.blocks.length,i=n>1||n>0&&!e.noHeader;return jC(e.blocks,function(e){var n=Lj(e);n>=t&&(t=n+ +(i&&(!n||$j(e)&&!e.noHeader)))}),t}return 0}function Nj(e,t,n,i){var a,r=t.noHeader,s=(a=Lj(t),{html:zj[a],richText:Pj[a]}),o=[],l=t.blocks||[];pI(!l||KC(l)),l=l||[];var c=e.orderMode;if(t.sortBlocks&&c){l=l.slice();var d={valueAsc:"asc",valueDesc:"desc"};if(CI(d,c)){var u=new aj(d[c],null);l.sort(function(e,t){return u.evaluate(e.sortParam,t.sortParam)})}else"seriesDesc"===c&&l.reverse()}jC(l,function(n,a){var r=t.valueFormatter,l=Oj(n)(r?RC(RC({},e),{valueFormatter:r}):e,n,a>0?s.html:0,i);null!=l&&o.push(l)});var h="richText"===e.renderMode?o.join(s.richText):jj(i,o.join(""),r?n:s.html);if(r)return h;var p=PN(t.header,"ordinal",e.useUTC),g=Ej(i,e.renderMode).nameStyle,v=Aj(i);return"richText"===e.renderMode?Uj(e,p,g)+s.richText+h:jj(i,'<div style="'+g+";"+v+';">'+cD(p)+"</div>"+h,n)}function Fj(e,t,n,i){var a=e.renderMode,r=t.noName,s=t.noValue,o=!t.markerType,l=t.name,c=e.useUTC,d=t.valueFormatter||e.valueFormatter||function(e){return UC(e=KC(e)?e:[e],function(e,t){return PN(e,KC(p)?p[t]:p,c)})};if(!r||!s){var u=o?"":e.markupStyleCreator.makeTooltipMarker(t.markerType,t.markerColor||uF.color.secondary,a),h=r?"":PN(l,"ordinal",c),p=t.valueType,g=s?[]:d(t.value,t.dataIndex),v=!o||!r,f=!o&&r,m=Ej(i,a),y=m.nameStyle,b=m.valueStyle;return"richText"===a?(o?"":u)+(r?"":Uj(e,h,y))+(s?"":function(e,t,n,i,a){var r=[a],s=i?10:20;return n&&r.push({padding:[0,0,0,s],align:"right"}),e.markupStyleCreator.wrapRichTextStyle(KC(t)?t.join("  "):t,r)}(e,g,v,f,b)):jj(i,(o?"":u)+(r?"":function(e,t,n){return'<span style="'+n+";"+(t?"margin-left:2px":"")+'">'+cD(e)+"</span>"}(h,!o,y))+(s?"":function(e,t,n,i){var a=n?"10px":"20px",r=t?"float:right;margin-left:"+a:"";return e=KC(e)?e:[e],'<span style="'+r+";"+i+'">'+UC(e,function(e){return cD(e)}).join("&nbsp;&nbsp;")+"</span>"}(g,v,f,b)),n)}}function Bj(e,t,n,i,a,r){if(e)return Oj(e)({useUTC:a,renderMode:n,orderMode:i,markupStyleCreator:t,valueFormatter:e.valueFormatter},e,0,r)}function jj(e,t,n){return'<div style="'+("margin: "+n+"px 0 0")+";"+Aj(e)+';">'+t+'<div style="clear:both"></div></div>'}function Uj(e,t,n){return e.markupStyleCreator.wrapRichTextStyle(t,n)}function Vj(e,t){var n=e.get("padding");return null!=n?n:"richText"===t?[8,10]:10}var qj=function(){function e(){this.richTextStyles={},this._nextStyleNameId=wE()}return e.prototype._generateStyleName=function(){return"__EC_aUTo_"+this._nextStyleNameId++},e.prototype.makeTooltipMarker=function(e,t,n){var i="richText"===n?this._generateStyleName():null,a=LN({color:t,type:e,renderMode:n,markerId:i});return YC(a)?a:(this.richTextStyles[i]=a.style,a.content)},e.prototype.wrapRichTextStyle=function(e,t){var n={};KC(t)?jC(t,function(e){return RC(n,e)}):RC(n,t);var i=this._generateStyleName();return this.richTextStyles[i]=n,"{"+i+"|"+e+"}"},e}();function Hj(e){var t,n,i,a,r=e.series,s=e.dataIndex,o=e.multipleSeries,l=r.getData(),c=l.mapDimensionsAll("defaultedTooltip"),d=c.length,u=r.getRawValue(s),h=KC(u),p=function(e,t){return NN(e.getData().getItemVisual(t,"style")[e.visualDrawType])}(r,s);if(d>1||h&&!d){var g=function(e,t,n,i,a){var r=t.getData(),s=VC(e,function(e,t,n){var i=r.getDimensionInfo(n);return e||i&&!1!==i.tooltip&&null!=i.displayName},!1),o=[],l=[],c=[];function d(e,t){var n=r.getDimensionInfo(t);n&&!1!==n.otherDims.tooltip&&(s?c.push(Rj("nameValue",{markerType:"subItem",markerColor:a,name:n.displayName,value:e,valueType:n.type})):(o.push(e),l.push(n.type)))}return i.length?jC(i,function(e){d(WB(r,n,e),e)}):jC(e,d),{inlineValues:o,inlineValueTypes:l,blocks:c}}(u,r,s,c,p);t=g.inlineValues,n=g.inlineValueTypes,i=g.blocks,a=g.inlineValues[0]}else if(d){var v=l.getDimensionInfo(c[0]);a=t=WB(l,s,c[0]),n=v.type}else a=t=h?u[0]:u;var f=LE(r),m=f&&r.name||"",y=l.getName(s),b=o?m:y;return Rj("section",{header:m,noHeader:o||!f,sortParam:a,blocks:[Rj("nameValue",{markerType:"item",markerColor:p,name:b,noName:!gI(b),value:t,valueType:n,dataIndex:s})].concat(i||[])})}var Wj=BE();function Gj(e,t){return e.getName(t)||e.getId(t)}var Qj=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._selectedDataIndicesMap={},t}var n;return uC(t,e),t.prototype.init=function(e,t,n){this.seriesIndex=this.componentIndex,this.dataTask=ZB({count:Zj,reset:Yj}),this.dataTask.context={model:this},this.mergeDefaultAndTheme(e,n),(Wj(this).sourceManager=new Dj(this)).prepareSource();var i=this.getInitialData(e,n);Jj(i,this),this.dataTask.context.data=i,Wj(this).dataBeforeProcessed=i,Kj(this),this._initSelectedMapFromData(i)},t.prototype.mergeDefaultAndTheme=function(e,t){var n=sF(this),i=n?lF(e):{},a=this.subType;dF.hasClass(a)&&(a+="Series"),PC(e,t.getTheme().get(this.subType)),PC(e,this.getDefaultOption()),ME(e,"label",["show"]),this.fillDataTextStyle(e.data),n&&oF(e,i,n)},t.prototype.mergeOption=function(e,t){e=PC(this.option,e,!0),this.fillDataTextStyle(e.data);var n=sF(this);n&&oF(this.option,e,n);var i=Wj(this).sourceManager;i.dirty(),i.prepareSource();var a=this.getInitialData(e,t);Jj(a,this),this.dataTask.dirty(),this.dataTask.context.data=a,Wj(this).dataBeforeProcessed=a,Kj(this),this._initSelectedMapFromData(a)},t.prototype.fillDataTextStyle=function(e){if(e&&!nI(e))for(var t=["show"],n=0;n<e.length;n++)e[n]&&e[n].label&&ME(e[n],"label",t)},t.prototype.getInitialData=function(e,t){},t.prototype.appendData=function(e){this.getRawData().appendData(e.data)},t.prototype.getData=function(e){var t=tU(this);if(t){var n=t.context.data;return null!=e&&n.getLinkedData?n.getLinkedData(e):n}return Wj(this).data},t.prototype.getAllData=function(){var e=this.getData();return e&&e.getLinkedDataAll?e.getLinkedDataAll():[{data:e}]},t.prototype.setData=function(e){var t=tU(this);if(t){var n=t.context;n.outputData=e,t!==this.dataTask&&(n.data=e)}Wj(this).data=e},t.prototype.getEncode=function(){var e=this.get("encode",!0);if(e)return kI(e)},t.prototype.getSourceManager=function(){return Wj(this).sourceManager},t.prototype.getSource=function(){return this.getSourceManager().getSource()},t.prototype.getRawData=function(){return Wj(this).dataBeforeProcessed},t.prototype.getColorBy=function(){return this.get("colorBy")||"series"},t.prototype.isColorBySeries=function(){return"series"===this.getColorBy()},t.prototype.getBaseAxis=function(){var e=this.coordinateSystem;return e&&e.getBaseAxis&&e.getBaseAxis()},t.prototype.indicesOfNearest=function(e,t,n,i){var a=this.getData(),r=this.coordinateSystem,s=r&&r.getAxis(e);if(!r||!s)return[];var o=s.dataToCoord(n);null==i&&(i=1/0);var l=[],c=1/0,d=-1,u=0;return a.each(t,function(e,t){var n=s.dataToCoord(e),a=o-n,r=Math.abs(a);r<=i&&((r<c||r===c&&a>=0&&d<0)&&(c=r,d=a,u=0),a===d&&(l[u++]=t))}),l.length=u,l},t.prototype.formatTooltip=function(e,t,n){return Hj({series:this,dataIndex:e,multipleSeries:t})},t.prototype.isAnimationEnabled=function(){var e=this.ecModel;if(pC.node&&(!e||!e.ssr))return!1;var t=this.getShallow("animation");return t&&this.getData().count()>this.getShallow("animationThreshold")&&(t=!1),!!t},t.prototype.restoreData=function(){this.dataTask.dirty()},t.prototype.getColorFromPalette=function(e,t,n){var i=this.ecModel,a=VF.prototype.getColorFromPalette.call(this,e,t,n);return a||(a=i.getColorFromPalette(e,t,n)),a},t.prototype.coordDimToDataDim=function(e){return this.getRawData().mapDimensionsAll(e)},t.prototype.getProgressive=function(){return this.get("progressive")},t.prototype.getProgressiveThreshold=function(){return this.get("progressiveThreshold")},t.prototype.select=function(e,t){this._innerSelect(this.getData(t),e)},t.prototype.unselect=function(e,t){var n=this.option.selectedMap;if(n){var i=this.option.selectedMode,a=this.getData(t);if("series"===i||"all"===n)return this.option.selectedMap={},void(this._selectedDataIndicesMap={});for(var r=0;r<e.length;r++){var s=Gj(a,e[r]);n[s]=!1,this._selectedDataIndicesMap[s]=-1}}},t.prototype.toggleSelect=function(e,t){for(var n=[],i=0;i<e.length;i++)n[0]=e[i],this.isSelected(e[i],t)?this.unselect(n,t):this.select(n,t)},t.prototype.getSelectedDataIndices=function(){if("all"===this.option.selectedMap)return[].slice.call(this.getData().getIndices());for(var e=this._selectedDataIndicesMap,t=WC(e),n=[],i=0;i<t.length;i++){var a=e[t[i]];a>=0&&n.push(a)}return n},t.prototype.isSelected=function(e,t){var n=this.option.selectedMap;if(!n)return!1;var i=this.getData(t);return("all"===n||n[Gj(i,e)])&&!i.getItemModel(e).get(["select","disabled"])},t.prototype.isUniversalTransitionEnabled=function(){if(this.__universalTransitionEnabled)return!0;var e=this.option.universalTransition;return!!e&&(!0===e||e&&e.enabled)},t.prototype._innerSelect=function(e,t){var n,i,a=this.option,r=a.selectedMode,s=t.length;if(r&&s)if("series"===r)a.selectedMap="all";else if("multiple"===r){eI(a.selectedMap)||(a.selectedMap={});for(var o=a.selectedMap,l=0;l<s;l++){var c=t[l];o[u=Gj(e,c)]=!0,this._selectedDataIndicesMap[u]=e.getRawIndex(c)}}else if("single"===r||!0===r){var d=t[s-1],u=Gj(e,d);a.selectedMap=((n={})[u]=!0,n),this._selectedDataIndicesMap=((i={})[u]=e.getRawIndex(d),i)}},t.prototype._initSelectedMapFromData=function(e){if(!this.option.selectedMap){var t=[];e.hasItemOption&&e.each(function(n){var i=e.getRawDataItem(n);i&&i.selected&&t.push(n)}),t.length>0&&this._innerSelect(e,t)}},t.registerClass=function(e){return dF.registerClass(e)},t.protoInitialize=((n=t.prototype).type="series.__base__",n.seriesIndex=0,n.ignoreStyleOnData=!1,n.hasSymbolVisual=!1,n.defaultSymbol="circle",n.visualStyleAccessPath="itemStyle",void(n.visualDrawType="fill")),t}(dF);function Kj(e){var t=e.name;LE(e)||(e.name=function(e){var t=e.getRawData(),n=t.mapDimensionsAll("seriesName"),i=[];return jC(n,function(e){var n=t.getDimensionInfo(e);n.displayName&&i.push(n.displayName)}),i.join(" ")}(e)||t)}function Zj(e){return e.model.getRawData().count()}function Yj(e){var t=e.model;return t.setData(t.getRawData().cloneShallow()),Xj}function Xj(e,t){t.outputData&&e.end>t.outputData.count()&&t.model.getRawData().cloneShallow(t.outputData)}function Jj(e,t){jC(SI(e.CHANGABLE_METHODS,e.DOWNSAMPLE_METHODS),function(n){e.wrapMethod(n,QC(eU,t))})}function eU(e,t){var n=tU(e);return n&&n.setOutputEnd((t||this).count()),t}function tU(e){var t=(e.ecModel||{}).scheduler,n=t&&t.getPipeline(e.uid);if(n){var i=n.currentTask;if(i){var a=i.agentStubMap;a&&(i=a.get(e.uid))}return i}}FC(Qj,QB),FC(Qj,VF),JE(Qj,dF);var nU=function(){function e(){this.group=new jA,this.uid=UL("viewComponent")}return e.prototype.init=function(e,t){},e.prototype.render=function(e,t,n,i){},e.prototype.dispose=function(e,t){},e.prototype.updateView=function(e,t,n,i){},e.prototype.updateLayout=function(e,t,n,i){},e.prototype.updateVisual=function(e,t,n,i){},e.prototype.toggleBlurSeries=function(e,t,n){},e.prototype.eachRendered=function(e){var t=this.group;t&&t.traverse(e)},e}();function iU(){var e=BE();return function(t){var n=e(t),i=t.pipelineContext,a=!!n.large,r=!!n.progressiveRender,s=n.large=!(!i||!i.large),o=n.progressiveRender=!(!i||!i.progressiveRender);return!(a===s&&r===o)&&"reset"}}XE(nU),iz(nU);var aU=BE(),rU=iU(),sU=function(){function e(){this.group=new jA,this.uid=UL("viewChart"),this.renderTask=ZB({plan:cU,reset:dU}),this.renderTask.context={view:this}}return e.prototype.init=function(e,t){},e.prototype.render=function(e,t,n,i){},e.prototype.highlight=function(e,t,n,i){var a=e.getData(i&&i.dataType);a&&lU(a,i,"emphasis")},e.prototype.downplay=function(e,t,n,i){var a=e.getData(i&&i.dataType);a&&lU(a,i,"normal")},e.prototype.remove=function(e,t){this.group.removeAll()},e.prototype.dispose=function(e,t){},e.prototype.updateView=function(e,t,n,i){this.render(e,t,n,i)},e.prototype.updateLayout=function(e,t,n,i){this.render(e,t,n,i)},e.prototype.updateVisual=function(e,t,n,i){this.render(e,t,n,i)},e.prototype.eachRendered=function(e){rL(this.group,e)},e.markUpdateMethod=function(e,t){aU(e).updateMethod=t},e.protoInitialize=void(e.prototype.type="chart"),e}();function oU(e,t,n){e&&a$(e)&&("emphasis"===t?FR:BR)(e,n)}function lU(e,t,n){var i=FE(e,t),a=t&&null!=t.highlightKey?function(e){var t=pR[e];return null==t&&hR<=32&&(t=pR[e]=hR++),t}(t.highlightKey):null;null!=i?jC(TE(i),function(t){oU(e.getItemGraphicEl(t),n,a)}):e.eachItemGraphicEl(function(e){oU(e,n,a)})}function cU(e){return rU(e.model)}function dU(e){var t=e.model,n=e.ecModel,i=e.api,a=e.payload,r=t.pipelineContext.progressiveRender,s=e.view,o=a&&aU(a).updateMethod,l=r?"incrementalPrepareRender":o&&s[o]?o:"render";return"render"!==l&&s[l](t,n,i,a),uU[l]}XE(sU),iz(sU);var uU={incrementalPrepareRender:{progress:function(e,t){t.view.incrementalRender(e,t.model,t.ecModel,t.api,t.payload)}},render:{forceFirstProgress:!0,progress:function(e,t){t.view.render(t.model,t.ecModel,t.api,t.payload)}}},hU="\0__throttleOriginMethod",pU="\0__throttleRate",gU="\0__throttleType";function vU(e,t,n){var i,a,r,s,o,l=0,c=0,d=null;function u(){c=(new Date).getTime(),d=null,e.apply(r,s||[])}t=t||0;var h=function(){for(var e=[],h=0;h<arguments.length;h++)e[h]=arguments[h];i=(new Date).getTime(),r=this,s=e;var p=o||t,g=o||n;o=null,a=i-(g?l:c)-p,clearTimeout(d),g?d=setTimeout(u,p):a>=0?u():d=setTimeout(u,-a),l=i};return h.clear=function(){d&&(clearTimeout(d),d=null)},h.debounceNextCall=function(e){o=e},h}function fU(e,t,n,i){var a=e[t];if(a){var r=a[hU]||a,s=a[gU];if(a[pU]!==n||s!==i){if(null==n||!i)return e[t]=r;(a=e[t]=vU(r,n,"debounce"===i))[hU]=r,a[gU]=i,a[pU]=n}return a}}function mU(e,t){var n=e[t];n&&n[hU]&&(n.clear&&n.clear(),e[t]=n[hU])}var yU=BE(),bU={itemStyle:az(LL,!0),lineStyle:az(RL,!0)},wU={lineStyle:"stroke",itemStyle:"fill"};function kU(e,t){var n=e.visualStyleMapper||bU[t];return n||bU.itemStyle}function SU(e,t){var n=e.visualDrawType||wU[t];return n||"fill"}var xU={createOnAllSeries:!0,performRawSeries:!0,reset:function(e,t){var n=e.getData(),i=e.visualStyleAccessPath||"itemStyle",a=e.getModel(i),r=kU(e,i)(a),s=a.getShallow("decal");s&&(n.setVisual("decal",s),s.dirty=!0);var o=SU(e,i),l=r[o],c=ZC(l)?l:null,d="auto"===r.fill||"auto"===r.stroke;if(!r[o]||c||d){var u=e.getColorFromPalette(e.name,null,t.getSeriesCount());r[o]||(r[o]=u,n.setVisual("colorFromPalette",!0)),r.fill="auto"===r.fill||ZC(r.fill)?u:r.fill,r.stroke="auto"===r.stroke||ZC(r.stroke)?u:r.stroke}if(n.setVisual("style",r),n.setVisual("drawType",o),!t.isSeriesFiltered(e)&&c)return n.setVisual("colorFromPalette",!1),{dataEach:function(t,n){var i=e.getDataParams(n),a=RC({},r);a[o]=c(i),t.setItemVisual(n,"style",a)}}}},_U=new BL,CU={createOnAllSeries:!0,performRawSeries:!0,reset:function(e,t){if(!e.ignoreStyleOnData&&!t.isSeriesFiltered(e)){var n=e.getData(),i=e.visualStyleAccessPath||"itemStyle",a=kU(e,i),r=n.getVisual("drawType");return{dataEach:n.hasItemOption?function(e,t){var n=e.getRawDataItem(t);if(n&&n[i]){_U.option=n[i];var s=a(_U);RC(e.ensureUniqueItemVisual(t,"style"),s),_U.option.decal&&(e.setItemVisual(t,"decal",_U.option.decal),_U.option.decal.dirty=!0),r in s&&e.setItemVisual(t,"colorFromPalette",!1)}}:null}}}},IU={performRawSeries:!0,overallReset:function(e){var t=kI();e.eachSeries(function(e){var n=e.getColorBy();if(!e.isColorBySeries()){var i=e.type+"-"+n,a=t.get(i);a||(a={},t.set(i,a)),yU(e).scope=a}}),e.eachSeries(function(t){if(!t.isColorBySeries()&&!e.isSeriesFiltered(t)){var n=t.getRawData(),i={},a=t.getData(),r=yU(t).scope,s=t.visualStyleAccessPath||"itemStyle",o=SU(t,s);a.each(function(e){var t=a.getRawIndex(e);i[t]=e}),n.each(function(e){var s=i[e];if(a.getItemVisual(s,"colorFromPalette")){var l=a.ensureUniqueItemVisual(s,"style"),c=n.getName(e)||e+"",d=n.count();l[o]=t.getColorFromPalette(c,r,d)}})}})}},DU=Math.PI;var TU=function(){function e(e,t,n,i){this._stageTaskMap=kI(),this.ecInstance=e,this.api=t,n=this._dataProcessorHandlers=n.slice(),i=this._visualHandlers=i.slice(),this._allHandlers=n.concat(i)}return e.prototype.restoreData=function(e,t){e.restoreData(t),this._stageTaskMap.each(function(e){var t=e.overallTask;t&&t.dirty()})},e.prototype.getPerformArgs=function(e,t){if(e.__pipeline){var n=this._pipelineMap.get(e.__pipeline.id),i=n.context,a=!t&&n.progressiveEnabled&&(!i||i.progressiveRender)&&e.__idxInPipeline>n.blockIndex?n.step:null,r=i&&i.modDataCount;return{step:a,modBy:null!=r?Math.ceil(r/a):null,modDataCount:r}}},e.prototype.getPipeline=function(e){return this._pipelineMap.get(e)},e.prototype.updateStreamModes=function(e,t){var n=this._pipelineMap.get(e.uid),i=e.getData().count(),a=n.progressiveEnabled&&t.incrementalPrepareRender&&i>=n.threshold,r=e.get("large")&&i>=e.get("largeThreshold"),s="mod"===e.get("progressiveChunkMode")?i:null;e.pipelineContext=n.context={progressiveRender:a,modDataCount:s,large:r}},e.prototype.restorePipelines=function(e){var t=this,n=t._pipelineMap=kI();e.eachSeries(function(e){var i=e.getProgressive(),a=e.uid;n.set(a,{id:a,head:null,tail:null,threshold:e.getProgressiveThreshold(),progressiveEnabled:i&&!(e.preventIncremental&&e.preventIncremental()),blockIndex:-1,step:Math.round(i||700),count:0}),t._pipe(e,e.dataTask)})},e.prototype.prepareStageTasks=function(){var e=this._stageTaskMap,t=this.api.getModel(),n=this.api;jC(this._allHandlers,function(i){var a=e.get(i.uid)||e.set(i.uid,{});pI(!(i.reset&&i.overallReset),""),i.reset&&this._createSeriesStageTask(i,a,t,n),i.overallReset&&this._createOverallStageTask(i,a,t,n)},this)},e.prototype.prepareView=function(e,t,n,i){var a=e.renderTask,r=a.context;r.model=t,r.ecModel=n,r.api=i,a.__block=!e.incrementalPrepareRender,this._pipe(t,a)},e.prototype.performDataProcessorTasks=function(e,t){this._performStageTasks(this._dataProcessorHandlers,e,t,{block:!0})},e.prototype.performVisualTasks=function(e,t,n){this._performStageTasks(this._visualHandlers,e,t,n)},e.prototype._performStageTasks=function(e,t,n,i){i=i||{};var a=!1,r=this;function s(e,t){return e.setDirty&&(!e.dirtyMap||e.dirtyMap.get(t.__pipeline.id))}jC(e,function(e,o){if(!i.visualType||i.visualType===e.visualType){var l=r._stageTaskMap.get(e.uid),c=l.seriesTaskMap,d=l.overallTask;if(d){var u,h=d.agentStubMap;h.each(function(e){s(i,e)&&(e.dirty(),u=!0)}),u&&d.dirty(),r.updatePayload(d,n);var p=r.getPerformArgs(d,i.block);h.each(function(e){e.perform(p)}),d.perform(p)&&(a=!0)}else c&&c.each(function(o,l){s(i,o)&&o.dirty();var c=r.getPerformArgs(o,i.block);c.skip=!e.performRawSeries&&t.isSeriesFiltered(o.context.model),r.updatePayload(o,n),o.perform(c)&&(a=!0)})}}),this.unfinished=a||this.unfinished},e.prototype.performSeriesTasks=function(e){var t;e.eachSeries(function(e){t=e.dataTask.perform()||t}),this.unfinished=t||this.unfinished},e.prototype.plan=function(){this._pipelineMap.each(function(e){var t=e.tail;do{if(t.__block){e.blockIndex=t.__idxInPipeline;break}t=t.getUpstream()}while(t)})},e.prototype.updatePayload=function(e,t){"remain"!==t&&(e.context.payload=t)},e.prototype._createSeriesStageTask=function(e,t,n,i){var a=this,r=t.seriesTaskMap,s=t.seriesTaskMap=kI(),o=e.seriesType,l=e.getTargetSeries;function c(t){var o=t.uid,l=s.set(o,r&&r.get(o)||ZB({plan:PU,reset:RU,count:LU}));l.context={model:t,ecModel:n,api:i,useClearVisual:e.isVisual&&!e.isLayout,plan:e.plan,reset:e.reset,scheduler:a},a._pipe(t,l)}e.createOnAllSeries?n.eachRawSeries(c):o?n.eachRawSeriesByType(o,c):l&&l(n,i).each(c)},e.prototype._createOverallStageTask=function(e,t,n,i){var a=this,r=t.overallTask=t.overallTask||ZB({reset:MU});r.context={ecModel:n,api:i,overallReset:e.overallReset,scheduler:a};var s=r.agentStubMap,o=r.agentStubMap=kI(),l=e.seriesType,c=e.getTargetSeries,d=!0,u=!1;function h(e){var t=e.uid,n=o.set(t,s&&s.get(t)||(u=!0,ZB({reset:AU,onDirty:zU})));n.context={model:e,overallProgress:d},n.agent=r,n.__block=d,a._pipe(e,n)}pI(!e.createOnAllSeries,""),l?n.eachRawSeriesByType(l,h):c?c(n,i).each(h):(d=!1,jC(n.getSeries(),h)),u&&r.dirty()},e.prototype._pipe=function(e,t){var n=e.uid,i=this._pipelineMap.get(n);!i.head&&(i.head=t),i.tail&&i.tail.pipe(t),i.tail=t,t.__idxInPipeline=i.count++,t.__pipeline=i},e.wrapStageHandler=function(e,t){return ZC(e)&&(e={overallReset:e,seriesType:NU(e)}),e.uid=UL("stageHandler"),t&&(e.visualType=t),e},e}();function MU(e){e.overallReset(e.ecModel,e.api,e.payload)}function AU(e){return e.overallProgress&&EU}function EU(){this.agent.dirty(),this.getDownstream().dirty()}function zU(){this.agent&&this.agent.dirty()}function PU(e){return e.plan?e.plan(e.model,e.ecModel,e.api,e.payload):null}function RU(e){e.useClearVisual&&e.data.clearAllVisual();var t=e.resetDefines=TE(e.reset(e.model,e.ecModel,e.api,e.payload));return t.length>1?UC(t,function(e,t){return OU(t)}):$U}var $U=OU(0);function OU(e){return function(t,n){var i=n.data,a=n.resetDefines[e];if(a&&a.dataEach)for(var r=t.start;r<t.end;r++)a.dataEach(i,r);else a&&a.progress&&a.progress(t,i)}}function LU(e){return e.data.count()}function NU(e){FU=null;try{e(BU,jU)}catch(t){}return FU}var FU,BU={},jU={};function UU(e,t){for(var n in t.prototype)e[n]=II}UU(BU,HF),UU(jU,ZF),BU.eachSeriesByType=BU.eachRawSeriesByType=function(e){FU=e},BU.eachComponent=function(e){"series"===e.mainType&&e.subType&&(FU=e.subType)};var VU,qU=uF.darkColor,HU=qU.background,WU=function(){return{axisLine:{lineStyle:{color:qU.axisLine}},splitLine:{lineStyle:{color:qU.axisSplitLine}},splitArea:{areaStyle:{color:[qU.backgroundTint,qU.backgroundTransparent]}},minorSplitLine:{lineStyle:{color:qU.axisMinorSplitLine}},axisLabel:{color:qU.axisLabel},axisName:{}}},GU={label:{color:qU.secondary},itemStyle:{borderColor:qU.borderTint},dividerLineStyle:{color:qU.border}},QU={darkMode:!0,color:qU.theme,backgroundColor:HU,axisPointer:{lineStyle:{color:qU.border},crossStyle:{color:qU.borderShade},label:{color:qU.tertiary}},legend:{textStyle:{color:qU.secondary},pageTextStyle:{color:qU.tertiary}},textStyle:{color:qU.secondary},title:{textStyle:{color:qU.primary},subtextStyle:{color:qU.quaternary}},toolbox:{iconStyle:{borderColor:qU.accent50}},tooltip:{backgroundColor:qU.neutral20,defaultBorderColor:qU.border,textStyle:{color:qU.tertiary}},dataZoom:{borderColor:qU.accent10,textStyle:{color:qU.tertiary},brushStyle:{color:qU.backgroundTint},handleStyle:{color:qU.neutral00,borderColor:qU.accent20},moveHandleStyle:{color:qU.accent40},emphasis:{handleStyle:{borderColor:qU.accent50}},dataBackground:{lineStyle:{color:qU.accent30},areaStyle:{color:qU.accent20}},selectedDataBackground:{lineStyle:{color:qU.accent50},areaStyle:{color:qU.accent30}}},visualMap:{textStyle:{color:qU.secondary},handleStyle:{borderColor:qU.neutral30}},timeline:{lineStyle:{color:qU.accent10},label:{color:qU.tertiary},controlStyle:{color:qU.accent30,borderColor:qU.accent30}},calendar:{itemStyle:{color:qU.neutral00,borderColor:qU.neutral20},dayLabel:{color:qU.tertiary},monthLabel:{color:qU.secondary},yearLabel:{color:qU.secondary}},matrix:{x:GU,y:GU,backgroundColor:{borderColor:qU.axisLine},body:{itemStyle:{borderColor:qU.borderTint}}},timeAxis:WU(),logAxis:WU(),valueAxis:WU(),categoryAxis:WU(),line:{symbol:"circle"},graph:{color:qU.theme},gauge:{title:{color:qU.secondary},axisLine:{lineStyle:{color:[[1,qU.neutral05]]}},axisLabel:{color:qU.axisLabel},detail:{color:qU.primary}},candlestick:{itemStyle:{color:"#f64e56",color0:"#54ea92",borderColor:"#f64e56",borderColor0:"#54ea92"}},funnel:{itemStyle:{borderColor:qU.background}},radar:(VU=WU(),VU.axisName={color:qU.axisLabel},VU.axisLine.lineStyle.color=qU.neutral20,VU),treemap:{breadcrumb:{itemStyle:{color:qU.neutral20,textStyle:{color:qU.secondary}},emphasis:{itemStyle:{color:qU.neutral30}}}},sunburst:{itemStyle:{borderColor:qU.background}},map:{itemStyle:{borderColor:qU.border,areaColor:qU.neutral10},label:{color:qU.tertiary},emphasis:{label:{color:qU.primary},itemStyle:{areaColor:qU.highlight}},select:{label:{color:qU.primary},itemStyle:{areaColor:qU.highlight}}},geo:{itemStyle:{borderColor:qU.border,areaColor:qU.neutral10},emphasis:{label:{color:qU.primary},itemStyle:{areaColor:qU.highlight}},select:{label:{color:qU.primary},itemStyle:{color:qU.highlight}}}};QU.categoryAxis.splitLine.show=!1;var KU=function(){function e(){}return e.prototype.normalizeQuery=function(e){var t={},n={},i={};if(YC(e)){var a=YE(e);t.mainType=a.main||null,t.subType=a.sub||null}else{var r=["Index","Name","Id"],s={name:1,dataIndex:1,dataType:1};jC(e,function(e,a){for(var o=!1,l=0;l<r.length;l++){var c=r[l],d=a.lastIndexOf(c);if(d>0&&d===a.length-c.length){var u=a.slice(0,d);"data"!==u&&(t.mainType=u,t[c.toLowerCase()]=e,o=!0)}}s.hasOwnProperty(a)&&(n[a]=e,o=!0),o||(i[a]=e)})}return{cptQuery:t,dataQuery:n,otherQuery:i}},e.prototype.filter=function(e,t){var n=this.eventInfo;if(!n)return!0;var i=n.targetEl,a=n.packedEvent,r=n.model,s=n.view;if(!r||!s)return!0;var o=t.cptQuery,l=t.dataQuery;return c(o,r,"mainType")&&c(o,r,"subType")&&c(o,r,"index","componentIndex")&&c(o,r,"name")&&c(o,r,"id")&&c(l,a,"name")&&c(l,a,"dataIndex")&&c(l,a,"dataType")&&(!s.filterForExposedEvent||s.filterForExposedEvent(e,t.otherQuery,i,a));function c(e,t,n,i){return null==e[n]||t[i||n]===e[n]}},e.prototype.afterTrigger=function(){this.eventInfo=null},e}(),ZU=["symbol","symbolSize","symbolRotate","symbolOffset"],YU=ZU.concat(["symbolKeepAspect"]),XU={createOnAllSeries:!0,performRawSeries:!0,reset:function(e,t){var n=e.getData();if(e.legendIcon&&n.setVisual("legendIcon",e.legendIcon),e.hasSymbolVisual){for(var i={},a={},r=!1,s=0;s<ZU.length;s++){var o=ZU[s],l=e.get(o);ZC(l)?(r=!0,a[o]=l):i[o]=l}if(i.symbol=i.symbol||e.defaultSymbol,n.setVisual(RC({legendIcon:e.legendIcon||i.symbol,symbolKeepAspect:e.get("symbolKeepAspect")},i)),!t.isSeriesFiltered(e)){var c=WC(a);return{dataEach:r?function(t,n){for(var i=e.getRawValue(n),r=e.getDataParams(n),s=0;s<c.length;s++){var o=c[s];t.setItemVisual(n,o,a[o](i,r))}}:null}}}}},JU={createOnAllSeries:!0,performRawSeries:!0,reset:function(e,t){if(e.hasSymbolVisual&&!t.isSeriesFiltered(e))return{dataEach:e.getData().hasItemOption?function(e,t){for(var n=e.getItemModel(t),i=0;i<YU.length;i++){var a=YU[i],r=n.getShallow(a,!0);null!=r&&e.setItemVisual(t,a,r)}}:null}}};function eV(e,t,n){switch(n){case"color":return e.getItemVisual(t,"style")[e.getVisual("drawType")];case"opacity":return e.getItemVisual(t,"style").opacity;case"symbol":case"symbolSize":case"liftZ":return e.getItemVisual(t,n)}}function tV(e,t){switch(t){case"color":return e.getVisual("style")[e.getVisual("drawType")];case"opacity":return e.getVisual("style").opacity;case"symbol":case"symbolSize":case"liftZ":return e.getVisual(t)}}function nV(e,t,n,i,a){var r=e+t;n.isSilent(r)||i.eachComponent({mainType:"series",subType:"pie"},function(e){for(var t=e.seriesIndex,i=e.option.selectedMap,s=a.selected,o=0;o<s.length;o++)if(s[o].seriesIndex===t){var l=e.getData(),c=FE(l,a.fromActionPayload);n.trigger(r,{type:r,seriesId:e.id,name:KC(c)?l.getName(c[0]):l.getName(c),selected:YC(i)?i:RC({},i)})}})}function iV(e,t,n){for(var i;e&&(!t(e)||(i=e,!n));)e=e.__hostTarget||e.parent;return i}var aV=Math.round(9*Math.random()),rV="function"==typeof Object.defineProperty,sV=function(){function e(){this._id="__ec_inner_"+aV++}return e.prototype.get=function(e){return this._guard(e)[this._id]},e.prototype.set=function(e,t){var n=this._guard(e);return rV?Object.defineProperty(n,this._id,{value:t,enumerable:!1,configurable:!0}):n[this._id]=t,this},e.prototype.delete=function(e){return!!this.has(e)&&(delete this._guard(e)[this._id],!0)},e.prototype.has=function(e){return!!this._guard(e)[this._id]},e.prototype._guard=function(e){if(e!==Object(e))throw TypeError("Value of WeakMap is not a non-null object.");return e},e}(),oV=LP.extend({type:"triangle",shape:{cx:0,cy:0,width:0,height:0},buildPath:function(e,t){var n=t.cx,i=t.cy,a=t.width/2,r=t.height/2;e.moveTo(n,i-r),e.lineTo(n+a,i+r),e.lineTo(n-a,i+r),e.closePath()}}),lV=LP.extend({type:"diamond",shape:{cx:0,cy:0,width:0,height:0},buildPath:function(e,t){var n=t.cx,i=t.cy,a=t.width/2,r=t.height/2;e.moveTo(n,i-r),e.lineTo(n+a,i),e.lineTo(n,i+r),e.lineTo(n-a,i),e.closePath()}}),cV=LP.extend({type:"pin",shape:{x:0,y:0,width:0,height:0},buildPath:function(e,t){var n=t.x,i=t.y,a=t.width/5*3,r=Math.max(a,t.height),s=a/2,o=s*s/(r-s),l=i-r+s+o,c=Math.asin(o/s),d=Math.cos(c)*s,u=Math.sin(c),h=Math.cos(c),p=.6*s,g=.7*s;e.moveTo(n-d,l+o),e.arc(n,l,s,Math.PI-c,2*Math.PI+c),e.bezierCurveTo(n+d-u*p,l+o+h*p,n,i-g,n,i),e.bezierCurveTo(n,i-g,n-d+u*p,l+o+h*p,n-d,l+o),e.closePath()}}),dV=LP.extend({type:"arrow",shape:{x:0,y:0,width:0,height:0},buildPath:function(e,t){var n=t.height,i=t.width,a=t.x,r=t.y,s=i/3*2;e.moveTo(a,r),e.lineTo(a+s,r+n),e.lineTo(a,r+n/4*3),e.lineTo(a-s,r+n),e.lineTo(a,r),e.closePath()}}),uV={line:function(e,t,n,i,a){a.x1=e,a.y1=t+i/2,a.x2=e+n,a.y2=t+i/2},rect:function(e,t,n,i,a){a.x=e,a.y=t,a.width=n,a.height=i},roundRect:function(e,t,n,i,a){a.x=e,a.y=t,a.width=n,a.height=i,a.r=Math.min(n,i)/4},square:function(e,t,n,i,a){var r=Math.min(n,i);a.x=e,a.y=t,a.width=r,a.height=r},circle:function(e,t,n,i,a){a.cx=e+n/2,a.cy=t+i/2,a.r=Math.min(n,i)/2},diamond:function(e,t,n,i,a){a.cx=e+n/2,a.cy=t+i/2,a.width=n,a.height=i},pin:function(e,t,n,i,a){a.x=e+n/2,a.y=t+i/2,a.width=n,a.height=i},arrow:function(e,t,n,i,a){a.x=e+n/2,a.y=t+i/2,a.width=n,a.height=i},triangle:function(e,t,n,i,a){a.cx=e+n/2,a.cy=t+i/2,a.width=n,a.height=i}},hV={};jC({line:X$,rect:KP,roundRect:KP,square:KP,circle:C$,diamond:lV,pin:cV,arrow:dV,triangle:oV},function(e,t){hV[t]=new e});var pV=LP.extend({type:"symbol",shape:{symbolType:"",x:0,y:0,width:0,height:0},calculateTextPosition:function(e,t,n){var i=MA(e,t,n),a=this.shape;return a&&"pin"===a.symbolType&&"inside"===t.position&&(i.y=n.y+.4*n.height),i},buildPath:function(e,t,n){var i=t.symbolType;if("none"!==i){var a=hV[i];a||(a=hV[i="rect"]),uV[i](t.x,t.y,t.width,t.height,a.shape),a.buildPath(e,a.shape,n)}}});function gV(e,t){if("image"!==this.type){var n=this.style;this.__isEmptyBrush?(n.stroke=e,n.fill=t||uF.color.neutral00,n.lineWidth=2):"line"===this.shape.symbolType?n.stroke=e:n.fill=e,this.markRedraw()}}function vV(e,t,n,i,a,r,s){var o,l=0===e.indexOf("empty");return l&&(e=e.substr(5,1).toLowerCase()+e.substr(6)),(o=0===e.indexOf("image://")?NO(e.slice(8),new GD(t,n,i,a),s?"center":"cover"):0===e.indexOf("path://")?LO(e.slice(7),{},new GD(t,n,i,a),s?"center":"cover"):new pV({shape:{symbolType:e,x:t,y:n,width:i,height:a}})).__isEmptyBrush=l,o.setColor=gV,r&&o.setColor(r),o}function fV(e){return KC(e)||(e=[+e,+e]),[e[0]||0,e[1]||0]}function mV(e,t){if(null!=e)return KC(e)||(e=[e,e]),[tE(e[0],t[0])||0,tE(cI(e[1],e[0]),t[1])||0]}function yV(e){return isFinite(e)}function bV(e,t,n){for(var i="radial"===t.type?function(e,t,n){var i=n.width,a=n.height,r=Math.min(i,a),s=null==t.x?.5:t.x,o=null==t.y?.5:t.y,l=null==t.r?.5:t.r;return t.global||(s=s*i+n.x,o=o*a+n.y,l*=r),s=yV(s)?s:.5,o=yV(o)?o:.5,l=l>=0&&yV(l)?l:.5,e.createRadialGradient(s,o,0,s,o,l)}(e,t,n):function(e,t,n){var i=null==t.x?0:t.x,a=null==t.x2?1:t.x2,r=null==t.y?0:t.y,s=null==t.y2?0:t.y2;return t.global||(i=i*n.width+n.x,a=a*n.width+n.x,r=r*n.height+n.y,s=s*n.height+n.y),i=yV(i)?i:0,a=yV(a)?a:1,r=yV(r)?r:0,s=yV(s)?s:0,e.createLinearGradient(i,r,a,s)}(e,t,n),a=t.colorStops,r=0;r<a.length;r++)i.addColorStop(a[r].offset,a[r].color);return i}function wV(e){return parseInt(e,10)}function kV(e,t,n){var i=["width","height"][t],a=["clientWidth","clientHeight"][t],r=["paddingLeft","paddingTop"][t],s=["paddingRight","paddingBottom"][t];if(null!=n[i]&&"auto"!==n[i])return parseFloat(n[i]);var o=document.defaultView.getComputedStyle(e);return(e[a]||wV(o[i])||wV(e.style[i]))-(wV(o[r])||0)-(wV(o[s])||0)|0}function SV(e){var t,n,i=e.style,a=i.lineDash&&i.lineWidth>0&&(t=i.lineDash,n=i.lineWidth,t&&"solid"!==t&&n>0?"dashed"===t?[4*n,2*n]:"dotted"===t?[n]:JC(t)?[t]:KC(t)?t:null:null),r=i.lineDashOffset;if(a){var s=i.strokeNoScale&&e.getLineScale?e.getLineScale():1;s&&1!==s&&(a=UC(a,function(e){return e/s}),r/=s)}return[a,r]}var xV=new fP(!0);function _V(e){var t=e.stroke;return!(null==t||"none"===t||!(e.lineWidth>0))}function CV(e){return"string"==typeof e&&"none"!==e}function IV(e){var t=e.fill;return null!=t&&"none"!==t}function DV(e,t){if(null!=t.fillOpacity&&1!==t.fillOpacity){var n=e.globalAlpha;e.globalAlpha=t.fillOpacity*t.opacity,e.fill(),e.globalAlpha=n}else e.fill()}function TV(e,t){if(null!=t.strokeOpacity&&1!==t.strokeOpacity){var n=e.globalAlpha;e.globalAlpha=t.strokeOpacity*t.opacity,e.stroke(),e.globalAlpha=n}else e.stroke()}function MV(e,t,n){var i=cz(t.image,t.__image,n);if(uz(i)){var a=e.createPattern(i,t.repeat||"repeat");if("function"==typeof DOMMatrix&&a&&a.setTransform){var r=new DOMMatrix;r.translateSelf(t.x||0,t.y||0),r.rotateSelf(0,0,(t.rotation||0)*DI),r.scaleSelf(t.scaleX||1,t.scaleY||1),a.setTransform(r)}return a}}var AV=["shadowBlur","shadowOffsetX","shadowOffsetY"],EV=[["lineCap","butt"],["lineJoin","miter"],["miterLimit",10]];function zV(e,t,n,i,a){var r=!1;if(!i&&t===(n=n||{}))return!1;if(i||t.opacity!==n.opacity){$V(e,a),r=!0;var s=Math.max(Math.min(t.opacity,1),0);e.globalAlpha=isNaN(s)?Ez.opacity:s}(i||t.blend!==n.blend)&&(r||($V(e,a),r=!0),e.globalCompositeOperation=t.blend||Ez.blend);for(var o=0;o<AV.length;o++){var l=AV[o];(i||t[l]!==n[l])&&(r||($V(e,a),r=!0),e[l]=e.dpr*(t[l]||0))}return(i||t.shadowColor!==n.shadowColor)&&(r||($V(e,a),r=!0),e.shadowColor=t.shadowColor||Ez.shadowColor),r}function PV(e,t,n,i,a){var r=OV(t,a.inHover),s=i?null:n&&OV(n,a.inHover)||{};if(r===s)return!1;var o=zV(e,r,s,i,a);if((i||r.fill!==s.fill)&&(o||($V(e,a),o=!0),CV(r.fill)&&(e.fillStyle=r.fill)),(i||r.stroke!==s.stroke)&&(o||($V(e,a),o=!0),CV(r.stroke)&&(e.strokeStyle=r.stroke)),(i||r.opacity!==s.opacity)&&(o||($V(e,a),o=!0),e.globalAlpha=null==r.opacity?1:r.opacity),t.hasStroke()){var l=r.lineWidth/(r.strokeNoScale&&t.getLineScale?t.getLineScale():1);e.lineWidth!==l&&(o||($V(e,a),o=!0),e.lineWidth=l)}for(var c=0;c<EV.length;c++){var d=EV[c],u=d[0];(i||r[u]!==s[u])&&(o||($V(e,a),o=!0),e[u]=r[u]||d[1])}return o}function RV(e,t){var n=t.transform,i=e.dpr||1;n?e.setTransform(i*n[0],i*n[1],i*n[2],i*n[3],i*n[4],i*n[5]):e.setTransform(i,0,0,i,0,0)}function $V(e,t){t.batchFill&&e.fill(),t.batchStroke&&e.stroke(),t.batchFill="",t.batchStroke=""}function OV(e,t){return t&&e.__hoverStyle||e.style}function LV(e,t){NV(e,t,{inHover:!1,viewWidth:0,viewHeight:0},!0)}function NV(e,t,n,i){var a=t.transform;if(!t.shouldBePainted(n.viewWidth,n.viewHeight,!1,!1))return t.__dirty&=-2,void(t.__isRendered=!1);var r=t.__clipPaths,s=n.prevElClipPaths,o=!1,l=!1;if(s&&!function(e,t){if(e===t||!e&&!t)return!1;if(!e||!t||e.length!==t.length)return!0;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!0;return!1}(r,s)||(s&&s.length&&($V(e,n),e.restore(),l=o=!0,n.prevElClipPaths=null,n.allClipped=!1,n.prevEl=null),r&&r.length&&($V(e,n),e.save(),function(e,t,n){for(var i=!1,a=0;a<e.length;a++){var r=e[a];i=i||r.isZeroArea(),RV(t,r),t.beginPath(),r.buildPath(t,r.shape),t.clip()}n.allClipped=i}(r,e,n),o=!0),n.prevElClipPaths=r),n.allClipped)t.__isRendered=!1;else{t.beforeBrush&&t.beforeBrush(),t.innerBeforeBrush();var c=n.prevEl;c||(l=o=!0);var d,u,h=t instanceof LP&&t.autoBatch&&function(e){var t=IV(e),n=_V(e);return!(e.lineDash||!(+t^+n)||t&&"string"!=typeof e.fill||n&&"string"!=typeof e.stroke||e.strokePercent<1||e.strokeOpacity<1||e.fillOpacity<1)}(t.style);o||(d=a,u=c.transform,d&&u?d[0]!==u[0]||d[1]!==u[1]||d[2]!==u[2]||d[3]!==u[3]||d[4]!==u[4]||d[5]!==u[5]:d||u)?($V(e,n),RV(e,t)):h||$V(e,n);var p=OV(t,n.inHover);t instanceof LP?(1!==n.lastDrawType&&(l=!0,n.lastDrawType=1),PV(e,t,c,l,n),h&&(n.batchFill||n.batchStroke)||e.beginPath(),function(e,t,n,i){var a,r=_V(n),s=IV(n),o=n.strokePercent,l=o<1,c=!t.path;t.silent&&!l||!c||t.createPathProxy();var d=t.path||xV,u=t.__dirty;if(!i){var h=n.fill,p=n.stroke,g=s&&!!h.colorStops,v=r&&!!p.colorStops,f=s&&!!h.image,m=r&&!!p.image,y=void 0,b=void 0,w=void 0,k=void 0,S=void 0;(g||v)&&(S=t.getBoundingRect()),g&&(y=u?bV(e,h,S):t.__canvasFillGradient,t.__canvasFillGradient=y),v&&(b=u?bV(e,p,S):t.__canvasStrokeGradient,t.__canvasStrokeGradient=b),f&&(w=u||!t.__canvasFillPattern?MV(e,h,t):t.__canvasFillPattern,t.__canvasFillPattern=w),m&&(k=u||!t.__canvasStrokePattern?MV(e,p,t):t.__canvasStrokePattern,t.__canvasStrokePattern=k),g?e.fillStyle=y:f&&(w?e.fillStyle=w:s=!1),v?e.strokeStyle=b:m&&(k?e.strokeStyle=k:r=!1)}var x,_,C=t.getGlobalScale();d.setScale(C[0],C[1],t.segmentIgnoreThreshold),e.setLineDash&&n.lineDash&&(x=(a=SV(t))[0],_=a[1]);var I=!0;(c||4&u)&&(d.setDPR(e.dpr),l?d.setContext(null):(d.setContext(e),I=!1),d.reset(),t.buildPath(d,t.shape,i),d.toStatic(),t.pathUpdated()),I&&d.rebuildPath(e,l?o:1),x&&(e.setLineDash(x),e.lineDashOffset=_),i||(n.strokeFirst?(r&&TV(e,n),s&&DV(e,n)):(s&&DV(e,n),r&&TV(e,n))),x&&e.setLineDash([])}(e,t,p,h),h&&(n.batchFill=p.fill||"",n.batchStroke=p.stroke||"")):t instanceof FP?(3!==n.lastDrawType&&(l=!0,n.lastDrawType=3),PV(e,t,c,l,n),function(e,t,n){var i,a=n.text;if(null!=a&&(a+=""),a){e.font=n.font||gC,e.textAlign=n.textAlign,e.textBaseline=n.textBaseline;var r=void 0,s=void 0;e.setLineDash&&n.lineDash&&(r=(i=SV(t))[0],s=i[1]),r&&(e.setLineDash(r),e.lineDashOffset=s),n.strokeFirst?(_V(n)&&e.strokeText(a,n.x,n.y),IV(n)&&e.fillText(a,n.x,n.y)):(IV(n)&&e.fillText(a,n.x,n.y),_V(n)&&e.strokeText(a,n.x,n.y)),r&&e.setLineDash([])}}(e,t,p)):t instanceof UP?(2!==n.lastDrawType&&(l=!0,n.lastDrawType=2),function(e,t,n,i,a){zV(e,OV(t,a.inHover),n&&OV(n,a.inHover),i,a)}(e,t,c,l,n),function(e,t,n){var i=t.__image=cz(n.image,t.__image,t,t.onload);if(i&&uz(i)){var a=n.x||0,r=n.y||0,s=t.getWidth(),o=t.getHeight(),l=i.width/i.height;if(null==s&&null!=o?s=o*l:null==o&&null!=s?o=s/l:null==s&&null==o&&(s=i.width,o=i.height),n.sWidth&&n.sHeight){var c=n.sx||0,d=n.sy||0;e.drawImage(i,c,d,n.sWidth,n.sHeight,a,r,s,o)}else if(n.sx&&n.sy){var u=s-(c=n.sx),h=o-(d=n.sy);e.drawImage(i,c,d,u,h,a,r,s,o)}else e.drawImage(i,a,r,s,o)}}(e,t,p)):t.getTemporalDisplayables&&(4!==n.lastDrawType&&(l=!0,n.lastDrawType=4),function(e,t,n){var i=t.getDisplayables(),a=t.getTemporalDisplayables();e.save();var r,s,o={prevElClipPaths:null,prevEl:null,allClipped:!1,viewWidth:n.viewWidth,viewHeight:n.viewHeight,inHover:n.inHover};for(r=t.getCursor(),s=i.length;r<s;r++){(d=i[r]).beforeBrush&&d.beforeBrush(),d.innerBeforeBrush(),NV(e,d,o,r===s-1),d.innerAfterBrush(),d.afterBrush&&d.afterBrush(),o.prevEl=d}for(var l=0,c=a.length;l<c;l++){var d;(d=a[l]).beforeBrush&&d.beforeBrush(),d.innerBeforeBrush(),NV(e,d,o,l===c-1),d.innerAfterBrush(),d.afterBrush&&d.afterBrush(),o.prevEl=d}t.clearTemporalDisplayables(),t.notClear=!0,e.restore()}(e,t,n)),h&&i&&$V(e,n),t.innerAfterBrush(),t.afterBrush&&t.afterBrush(),n.prevEl=t,t.__dirty=0,t.__isRendered=!0}}var FV=new sV,BV=new KT(100),jV=["symbol","symbolSize","symbolKeepAspect","color","backgroundColor","dashArrayX","dashArrayY","maxTileWidth","maxTileHeight"];function UV(e,t){if("none"===e)return null;var n=t.getDevicePixelRatio(),i=t.getZr(),a="svg"===i.painter.type;e.dirty&&FV.delete(e);var r=FV.get(e);if(r)return r;var s=$C(e,{symbol:"rect",symbolSize:1,symbolKeepAspect:!0,color:"rgba(0, 0, 0, 0.2)",backgroundColor:null,dashArrayX:5,dashArrayY:5,rotation:0,maxTileWidth:512,maxTileHeight:512});"none"===s.backgroundColor&&(s.backgroundColor=null);var o={repeat:"repeat"};return function(e){for(var t,r=[n],o=!0,l=0;l<jV.length;++l){var c=s[jV[l]];if(null!=c&&!KC(c)&&!YC(c)&&!JC(c)&&"boolean"!=typeof c){o=!1;break}r.push(c)}if(o){t=r.join(",")+(a?"-svg":"");var d=BV.get(t);d&&(a?e.svgElement=d:e.image=d)}var u,h=qV(s.dashArrayX),p=function(e){if(!e||"object"==typeof e&&0===e.length)return[0,0];if(JC(e)){var t=Math.ceil(e);return[t,t]}var n=UC(e,function(e){return Math.ceil(e)});return e.length%2?n.concat(n):n}(s.dashArrayY),g=VV(s.symbol),v=(w=h,UC(w,function(e){return HV(e)})),f=HV(p),m=!a&&fC.createCanvas(),y=a&&{tag:"g",attrs:{},key:"dcl",children:[]},b=function(){for(var e=1,t=0,n=v.length;t<n;++t)e=SE(e,v[t]);var i=1;for(t=0,n=g.length;t<n;++t)i=SE(i,g[t].length);e*=i;var a=f*v.length*g.length;return{width:Math.max(1,Math.min(e,s.maxTileWidth)),height:Math.max(1,Math.min(a,s.maxTileHeight))}}();var w;m&&(m.width=b.width*n,m.height=b.height*n,u=m.getContext("2d"));(function(){u&&(u.clearRect(0,0,m.width,m.height),s.backgroundColor&&(u.fillStyle=s.backgroundColor,u.fillRect(0,0,m.width,m.height)));for(var e=0,t=0;t<p.length;++t)e+=p[t];if(e<=0)return;var r=-f,o=0,l=0,c=0;for(;r<b.height;){if(o%2==0){for(var d=l/2%g.length,v=0,w=0,k=0;v<2*b.width;){var S=0;for(t=0;t<h[c].length;++t)S+=h[c][t];if(S<=0)break;if(w%2==0){var x=.5*(1-s.symbolSize),_=v+h[c][w]*x,C=r+p[o]*x,I=h[c][w]*s.symbolSize,D=p[o]*s.symbolSize,T=k/2%g[d].length;M(_,C,I,D,g[d][T])}v+=h[c][w],++k,++w===h[c].length&&(w=0)}++c===h.length&&(c=0)}r+=p[o],++l,++o===p.length&&(o=0)}function M(e,t,r,o,l){var c=a?1:n,d=vV(l,e*c,t*c,r*c,o*c,s.color,s.symbolKeepAspect);if(a){var h=i.painter.renderOneToVNode(d);h&&y.children.push(h)}else LV(u,d)}})(),o&&BV.put(t,m||y);e.image=m,e.svgElement=y,e.svgWidth=b.width,e.svgHeight=b.height}(o),o.rotation=s.rotation,o.scaleX=o.scaleY=a?1:1/n,FV.set(e,o),e.dirty=!1,o}function VV(e){if(!e||0===e.length)return[["rect"]];if(YC(e))return[[e]];for(var t=!0,n=0;n<e.length;++n)if(!YC(e[n])){t=!1;break}if(t)return VV([e]);var i=[];for(n=0;n<e.length;++n)YC(e[n])?i.push([e[n]]):i.push(e[n]);return i}function qV(e){if(!e||0===e.length)return[[0,0]];if(JC(e))return[[a=Math.ceil(e),a]];for(var t=!0,n=0;n<e.length;++n)if(!JC(e[n])){t=!1;break}if(t)return qV([e]);var i=[];for(n=0;n<e.length;++n)if(JC(e[n])){var a=Math.ceil(e[n]);i.push([a,a])}else{(a=UC(e[n],function(e){return Math.ceil(e)})).length%2==1?i.push(a.concat(a)):i.push(a)}return i}function HV(e){for(var t=0,n=0;n<e.length;++n)t+=e[n];return e.length%2==1?2*t:t}var WV=new JI,GV={};function QV(e){return GV[e]}var KV=2e3,ZV=4500,YV={PROCESSOR:{FILTER:1e3,SERIES_FILTER:800,STATISTIC:5e3},VISUAL:{LAYOUT:1e3,PROGRESSIVE_LAYOUT:1100,GLOBAL:KV,CHART:3e3,POST_CHART_LAYOUT:4600,COMPONENT:4e3,BRUSH:5e3,CHART_ITEM:ZV,ARIA:6e3,DECAL:7e3}},XV="__flagInMainProcess",JV="__mainProcessVersion",eq="__pendingUpdate",tq="__needsUpdateStatus",nq=/^[a-zA-Z0-9_]+$/,iq="__connectUpdateStatus";function aq(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(!this.isDisposed())return sq(this,e,t);this.id}}function rq(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return sq(this,e,t)}}function sq(e,t,n){return n[0]=n[0]&&n[0].toLowerCase(),JI.prototype[t].apply(e,n)}var oq,lq,cq,dq,uq,hq,pq,gq,vq,fq,mq,yq,bq,wq,kq,Sq,xq,_q,Cq,Iq=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t}(JI),Dq=Iq.prototype;Dq.on=rq("on"),Dq.off=rq("off");var Tq=function(e){function t(t,n,i){var a=e.call(this,new KU)||this;a._chartsViews=[],a._chartsMap={},a._componentsViews=[],a._componentsMap={},a._pendingActions=[],i=i||{},a._dom=t;a[JV]=1,i.ssr&&QA(function(e){var t=uR(e),n=t.dataIndex;if(null!=n){var i=kI();return i.set("series_index",t.seriesIndex),i.set("data_index",n),t.ssrType&&i.set("ssr_type",t.ssrType),i}});var r=a._zr=WA(t,{renderer:i.renderer||"canvas",devicePixelRatio:i.devicePixelRatio,width:i.width,height:i.height,ssr:i.ssr,useDirtyRect:cI(i.useDirtyRect,!1),useCoarsePointer:cI(i.useCoarsePointer,"auto"),pointerSize:i.pointerSize});a._ssr=i.ssr,a._throttledZrFlush=vU(GC(r.flush,r),17),a._updateTheme(n),a._locale=function(e){if(YC(e)){var t=GL[e.toUpperCase()]||{};return e===qL||e===HL?zC(t):PC(zC(t),zC(GL[WL]),!1)}return PC(zC(e),zC(GL[WL]),!1)}(i.locale||KL),a._coordSysMgr=new UN;var s=a._api=kq(a);function o(e,t){return e.__prio-t.__prio}return pT(Oq,o),pT(Rq,o),a._scheduler=new TU(a,s,Rq,Oq),a._messageCenter=new Iq,a._initEvents(),a.resize=GC(a.resize,a),r.animation.on("frame",a._onframe,a),fq(r,a),mq(r,a),fI(a),a}return uC(t,e),t.prototype._onframe=function(){if(!this._disposed){_q(this);var e=this._scheduler;if(this[eq]){var t=this[eq].silent;this[XV]=!0,Cq(this);try{oq(this),dq.update.call(this,null,this[eq].updateParams)}catch(s){throw this[XV]=!1,this[eq]=null,s}this._zr.flush(),this[XV]=!1,this[eq]=null,gq.call(this,t),vq.call(this,t)}else if(e.unfinished){var n=1,i=this._model,a=this._api;e.unfinished=!1;do{var r=+new Date;e.performSeriesTasks(i),e.performDataProcessorTasks(i),hq(this,i),e.performVisualTasks(i),wq(this,this._model,a,"remain",{}),n-=+new Date-r}while(n>0&&e.unfinished);e.unfinished||this._zr.flush()}}},t.prototype.getDom=function(){return this._dom},t.prototype.getId=function(){return this.id},t.prototype.getZr=function(){return this._zr},t.prototype.isSSR=function(){return this._ssr},t.prototype.setOption=function(e,t,n){if(!this[XV])if(this._disposed)this.id;else{var i,a,r;if(eI(t)&&(n=t.lazyUpdate,i=t.silent,a=t.replaceMerge,r=t.transition,t=t.notMerge),this[XV]=!0,Cq(this),!this._model||t){var s=new XF(this._api),o=this._theme,l=this._model=new HF;l.scheduler=this._scheduler,l.ssr=this._ssr,l.init(null,null,null,o,this._locale,s)}this._model.setOption(e,{replaceMerge:a},$q);var c={seriesTransition:r,optionChanged:!0};if(n)this[eq]={silent:i,updateParams:c},this[XV]=!1,this.getZr().wakeUp();else{try{oq(this),dq.update.call(this,null,c)}catch(d){throw this[eq]=null,this[XV]=!1,d}this._ssr||this._zr.flush(),this[eq]=null,this[XV]=!1,gq.call(this,i),vq.call(this,i)}}},t.prototype.setTheme=function(e,t){if(!this[XV])if(this._disposed)this.id;else{var n=this._model;if(n){var i=t&&t.silent,a=null;this[eq]&&(null==i&&(i=this[eq].silent),a=this[eq].updateParams,this[eq]=null),this[XV]=!0,Cq(this);try{this._updateTheme(e),n.setTheme(this._theme),oq(this),dq.update.call(this,{type:"setTheme"},a)}catch(r){throw this[XV]=!1,r}this[XV]=!1,gq.call(this,i),vq.call(this,i)}}},t.prototype._updateTheme=function(e){YC(e)&&(e=Lq[e]),e&&((e=zC(e))&&bB(e,!0),this._theme=e)},t.prototype.getModel=function(){return this._model},t.prototype.getOption=function(){return this._model&&this._model.getOption()},t.prototype.getWidth=function(){return this._zr.getWidth()},t.prototype.getHeight=function(){return this._zr.getHeight()},t.prototype.getDevicePixelRatio=function(){return this._zr.painter.dpr||pC.hasGlobalWindow&&window.devicePixelRatio||1},t.prototype.getRenderedCanvas=function(e){return this.renderToCanvas(e)},t.prototype.renderToCanvas=function(e){return e=e||{},this._zr.painter.getRenderedCanvas({backgroundColor:e.backgroundColor||this._model.get("backgroundColor"),pixelRatio:e.pixelRatio||this.getDevicePixelRatio()})},t.prototype.renderToSVGString=function(e){return e=e||{},this._zr.painter.renderToString({useViewBox:e.useViewBox})},t.prototype.getSvgDataURL=function(){var e=this._zr;return jC(e.storage.getDisplayList(),function(e){e.stopAnimation(null,!0)}),e.painter.toDataURL()},t.prototype.getDataURL=function(e){if(!this._disposed){var t=(e=e||{}).excludeComponents,n=this._model,i=[],a=this;jC(t,function(e){n.eachComponent({mainType:e},function(e){var t=a._componentsMap[e.__viewId];t.group.ignore||(i.push(t),t.group.ignore=!0)})});var r="svg"===this._zr.painter.getType()?this.getSvgDataURL():this.renderToCanvas(e).toDataURL("image/"+(e&&e.type||"png"));return jC(i,function(e){e.group.ignore=!1}),r}this.id},t.prototype.getConnectedDataURL=function(e){if(!this._disposed){var t="svg"===e.type,n=this.group,i=Math.min,a=Math.max,r=1/0;if(Bq[n]){var s=r,o=r,l=-1/0,c=-1/0,d=[],u=e&&e.pixelRatio||this.getDevicePixelRatio();jC(Fq,function(r,u){if(r.group===n){var h=t?r.getZr().painter.getSvgDom().innerHTML:r.renderToCanvas(zC(e)),p=r.getDom().getBoundingClientRect();s=i(p.left,s),o=i(p.top,o),l=a(p.right,l),c=a(p.bottom,c),d.push({dom:h,left:p.left,top:p.top})}});var h=(l*=u)-(s*=u),p=(c*=u)-(o*=u),g=fC.createCanvas(),v=WA(g,{renderer:t?"svg":"canvas"});if(v.resize({width:h,height:p}),t){var f="";return jC(d,function(e){var t=e.left-s,n=e.top-o;f+='<g transform="translate('+t+","+n+')">'+e.dom+"</g>"}),v.painter.getSvgRoot().innerHTML=f,e.connectedBackgroundColor&&v.painter.setBackgroundColor(e.connectedBackgroundColor),v.refreshImmediately(),v.painter.toDataURL()}return e.connectedBackgroundColor&&v.add(new KP({shape:{x:0,y:0,width:h,height:p},style:{fill:e.connectedBackgroundColor}})),jC(d,function(e){var t=new UP({style:{x:e.left*u-s,y:e.top*u-o,image:e.dom}});v.add(t)}),v.refreshImmediately(),g.toDataURL("image/"+(e&&e.type||"png"))}return this.getDataURL(e)}this.id},t.prototype.convertToPixel=function(e,t,n){return uq(this,"convertToPixel",e,t,n)},t.prototype.convertToLayout=function(e,t,n){return uq(this,"convertToLayout",e,t,n)},t.prototype.convertFromPixel=function(e,t,n){return uq(this,"convertFromPixel",e,t,n)},t.prototype.containPixel=function(e,t){var n;if(!this._disposed)return jC(UE(this._model,e),function(e,i){i.indexOf("Models")>=0&&jC(e,function(e){var a=e.coordinateSystem;if(a&&a.containPoint)n=n||!!a.containPoint(t);else if("seriesModels"===i){var r=this._chartsMap[e.__viewId];r&&r.containPoint&&(n=n||r.containPoint(t,e))}},this)},this),!!n;this.id},t.prototype.getVisual=function(e,t){var n=UE(this._model,e,{defaultMainType:"series"}),i=n.seriesModel.getData(),a=n.hasOwnProperty("dataIndexInside")?n.dataIndexInside:n.hasOwnProperty("dataIndex")?i.indexOfRawIndex(n.dataIndex):null;return null!=a?eV(i,a,t):tV(i,t)},t.prototype.getViewOfComponentModel=function(e){return this._componentsMap[e.__viewId]},t.prototype.getViewOfSeriesModel=function(e){return this._chartsMap[e.__viewId]},t.prototype._initEvents=function(){var e=this;jC(Aq,function(t){var n=function(n){var i,a=e.getModel(),r=n.target;if("globalout"===t?i={}:r&&iV(r,function(e){var t=uR(e);if(t&&null!=t.dataIndex){var n=t.dataModel||a.getSeriesByIndex(t.seriesIndex);return i=n&&n.getDataParams(t.dataIndex,t.dataType,r)||{},!0}if(t.eventData)return i=RC({},t.eventData),!0},!0),i){var s=i.componentType,o=i.componentIndex;"markLine"!==s&&"markPoint"!==s&&"markArea"!==s||(s="series",o=i.seriesIndex);var l=s&&null!=o&&a.getComponent(s,o),c=l&&e["series"===l.mainType?"_chartsMap":"_componentsMap"][l.__viewId];i.event=n,i.type=t,e._$eventProcessor.eventInfo={targetEl:r,packedEvent:i,model:l,view:c},e.trigger(t,i)}};n.zrEventfulCallAtLast=!0,e._zr.on(t,n,e)});var t=this._messageCenter;jC(Pq,function(n,i){t.on(i,function(t){e.trigger(i,t)})}),function(e,t,n){e.on("selectchanged",function(e){var i=n.getModel();e.isFromClick?(nV("map","selectchanged",t,i,e),nV("pie","selectchanged",t,i,e)):"select"===e.fromAction?(nV("map","selected",t,i,e),nV("pie","selected",t,i,e)):"unselect"===e.fromAction&&(nV("map","unselected",t,i,e),nV("pie","unselected",t,i,e))})}(t,this,this._api)},t.prototype.isDisposed=function(){return this._disposed},t.prototype.clear=function(){this._disposed?this.id:this.setOption({series:[]},!0)},t.prototype.dispose=function(){if(this._disposed)this.id;else{this._disposed=!0,this.getDom()&&GE(this.getDom(),Vq,"");var e=this,t=e._api,n=e._model;jC(e._componentsViews,function(e){e.dispose(n,t)}),jC(e._chartsViews,function(e){e.dispose(n,t)}),e._zr.dispose(),e._dom=e._model=e._chartsMap=e._componentsMap=e._chartsViews=e._componentsViews=e._scheduler=e._api=e._zr=e._throttledZrFlush=e._theme=e._coordSysMgr=e._messageCenter=null,delete Fq[e.id]}},t.prototype.resize=function(e){if(!this[XV])if(this._disposed)this.id;else{this._zr.resize(e);var t=this._model;if(this._loadingFX&&this._loadingFX.resize(),t){var n=t.resetOption("media"),i=e&&e.silent;this[eq]&&(null==i&&(i=this[eq].silent),n=!0,this[eq]=null),this[XV]=!0,Cq(this);try{n&&oq(this),dq.update.call(this,{type:"resize",animation:RC({duration:0},e&&e.animation)})}catch(a){throw this[XV]=!1,a}this[XV]=!1,gq.call(this,i),vq.call(this,i)}}},t.prototype.showLoading=function(e,t){if(this._disposed)this.id;else if(eI(e)&&(t=e,e=""),e=e||"default",this.hideLoading(),Nq[e]){var n=Nq[e](this._api,t),i=this._zr;this._loadingFX=n,i.add(n)}},t.prototype.hideLoading=function(){this._disposed?this.id:(this._loadingFX&&this._zr.remove(this._loadingFX),this._loadingFX=null)},t.prototype.makeActionFromEvent=function(e){var t=RC({},e);return t.type=zq[e.type],t},t.prototype.dispatchAction=function(e,t){if(this._disposed)this.id;else if(eI(t)||(t={silent:!!t}),Eq[e.type]&&this._model)if(this[XV])this._pendingActions.push(e);else{var n=t.silent;pq.call(this,e,n);var i=t.flush;i?this._zr.flush():!1!==i&&pC.browser.weChat&&this._throttledZrFlush(),gq.call(this,n),vq.call(this,n)}},t.prototype.updateLabelLayout=function(){WV.trigger("series:layoutlabels",this._model,this._api,{updatedSeries:[]})},t.prototype.appendData=function(e){if(this._disposed)this.id;else{var t=e.seriesIndex;this.getModel().getSeriesByIndex(t).appendData(e),this._scheduler.unfinished=!0,this.getZr().wakeUp()}},t.internalField=function(){function e(e){e.clearColorPalette(),e.eachSeries(function(e){e.clearColorPalette()})}function t(e){for(var t=[],n=e.currentStates,i=0;i<n.length;i++){var a=n[i];"emphasis"!==a&&"blur"!==a&&"select"!==a&&t.push(a)}e.selected&&e.states.select&&t.push("select"),2===e.hoverState&&e.states.emphasis?t.push("emphasis"):1===e.hoverState&&e.states.blur&&t.push("blur"),e.useStates(t)}function n(e,t){if(!e.preventAutoZ){var n=dL(e);t.eachRendered(function(e){return uL(e,n.z,n.zlevel),!0})}}function i(e,t){t.eachRendered(function(e){if(!_O(e)){var t=e.getTextContent(),n=e.getTextGuideLine();e.stateTransition&&(e.stateTransition=null),t&&t.stateTransition&&(t.stateTransition=null),n&&n.stateTransition&&(n.stateTransition=null),e.hasState()?(e.prevStates=e.currentStates,e.clearStates()):e.prevStates&&(e.prevStates=null)}})}function a(e,n){var i=e.getModel("stateAnimation"),a=e.isAnimationEnabled(),r=i.get("duration"),s=r>0?{duration:r,delay:i.get("delay"),easing:i.get("easing")}:null;n.eachRendered(function(e){if(e.states&&e.states.emphasis){if(_O(e))return;if(e instanceof LP&&function(e){var t=gR(e);t.normalFill=e.style.fill,t.normalStroke=e.style.stroke;var n=e.states.select||{};t.selectFill=n.style&&n.style.fill||null,t.selectStroke=n.style&&n.style.stroke||null}(e),e.__dirty){var n=e.prevStates;n&&e.useStates(n)}if(a){e.stateTransition=s;var i=e.getTextContent(),r=e.getTextGuideLine();i&&(i.stateTransition=s),r&&(r.stateTransition=s)}e.__dirty&&t(e)}})}oq=function(e){var t=e._scheduler;t.restorePipelines(e._model),t.prepareStageTasks(),lq(e,!0),lq(e,!1),t.plan()},lq=function(e,t){for(var n=e._model,i=e._scheduler,a=t?e._componentsViews:e._chartsViews,r=t?e._componentsMap:e._chartsMap,s=e._zr,o=e._api,l=0;l<a.length;l++)a[l].__alive=!1;function c(e){var l=e.__requireNewView;e.__requireNewView=!1;var c="_ec_"+e.id+"_"+e.type,d=!l&&r[c];if(!d){var u=YE(e.type);(d=new(t?nU.getClass(u.main,u.sub):sU.getClass(u.sub))).init(n,o),r[c]=d,a.push(d),s.add(d.group)}e.__viewId=d.__id=c,d.__alive=!0,d.__model=e,d.group.__ecComponentInfo={mainType:e.mainType,index:e.componentIndex},!t&&i.prepareView(d,e,n,o)}t?n.eachComponent(function(e,t){"series"!==e&&c(t)}):n.eachSeries(c);for(l=0;l<a.length;){var d=a[l];d.__alive?l++:(!t&&d.renderTask.dispose(),s.remove(d.group),d.dispose(n,o),a.splice(l,1),r[d.__id]===d&&delete r[d.__id],d.__id=d.group.__ecComponentInfo=null)}},cq=function(e,t,n,i,a){var r=e._model;if(r.setUpdatePayload(n),i){var s={};s[i+"Id"]=n[i+"Id"],s[i+"Index"]=n[i+"Index"],s[i+"Name"]=n[i+"Name"];var o={mainType:i,query:s};a&&(o.subType=a);var l,c=n.excludeSeriesId;null!=c&&(l=kI(),jC(TE(c),function(e){var t=OE(e,null);null!=t&&l.set(t,!0)})),r&&r.eachComponent(o,function(t){if(!(l&&null!=l.get(t.id)))if(s$(n))if(t instanceof Qj)n.type!==yR||n.notBlur||t.get(["emphasis","disabled"])||function(e,t,n){var i=e.seriesIndex,a=e.getData(t.dataType);if(a){var r=FE(a,t);r=(KC(r)?r[0]:r)||0;var s=a.getItemGraphicEl(r);if(!s)for(var o=a.count(),l=0;!s&&l<o;)s=a.getItemGraphicEl(l++);if(s){var c=uR(s);GR(i,c.focus,c.blurScope,n)}else{var d=e.get(["emphasis","focus"]),u=e.get(["emphasis","blurScope"]);null!=d&&GR(i,d,u,n)}}}(t,n,e._api);else{var i=KR(t.mainType,t.componentIndex,n.name,e._api),a=i.focusSelf,r=i.dispatchers;n.type===yR&&a&&!n.notBlur&&QR(t.mainType,t.componentIndex,e._api),r&&jC(r,function(e){n.type===yR?FR(e):BR(e)})}else r$(n)&&t instanceof Qj&&(!function(e,t){if(r$(t)){var n=t.dataType,i=FE(e.getData(n),t);KC(i)||(i=[i]),e[t.type===SR?"toggleSelect":t.type===wR?"select":"unselect"](i,n)}}(t,n,e._api),ZR(t),xq(e))},e),r&&r.eachComponent(o,function(t){l&&null!=l.get(t.id)||d(e["series"===i?"_chartsMap":"_componentsMap"][t.__viewId])},e)}else jC([].concat(e._componentsViews).concat(e._chartsViews),d);function d(i){i&&i.__alive&&i[t]&&i[t](i.__model,r,e._api,n)}},dq={prepareAndUpdate:function(e){oq(this),dq.update.call(this,e,e&&{optionChanged:null!=e.newOption})},update:function(t,n){var i=this._model,a=this._api,r=this._zr,s=this._coordSysMgr,o=this._scheduler;if(i){i.setUpdatePayload(t),o.restoreData(i,t),o.performSeriesTasks(i),s.create(i,a),o.performDataProcessorTasks(i,t),hq(this,i),s.update(i,a),e(i),o.performVisualTasks(i,t);var l=i.get("backgroundColor")||"transparent";r.setBackgroundColor(l);var c=i.get("darkMode");null!=c&&"auto"!==c&&r.setDarkMode(c),yq(this,i,a,t,n),WV.trigger("afterupdate",i,a)}},updateTransform:function(t){var n=this,i=this._model,a=this._api;if(i){i.setUpdatePayload(t);var r=[];i.eachComponent(function(e,s){if("series"!==e){var o=n.getViewOfComponentModel(s);if(o&&o.__alive)if(o.updateTransform){var l=o.updateTransform(s,i,a,t);l&&l.update&&r.push(o)}else r.push(o)}});var s=kI();i.eachSeries(function(e){var r=n._chartsMap[e.__viewId];if(r.updateTransform){var o=r.updateTransform(e,i,a,t);o&&o.update&&s.set(e.uid,1)}else s.set(e.uid,1)}),e(i),this._scheduler.performVisualTasks(i,t,{setDirty:!0,dirtyMap:s}),wq(this,i,a,t,{},s),WV.trigger("afterupdate",i,a)}},updateView:function(t){var n=this._model;n&&(n.setUpdatePayload(t),sU.markUpdateMethod(t,"updateView"),e(n),this._scheduler.performVisualTasks(n,t,{setDirty:!0}),yq(this,n,this._api,t,{}),WV.trigger("afterupdate",n,this._api))},updateVisual:function(t){var n=this,i=this._model;i&&(i.setUpdatePayload(t),i.eachSeries(function(e){e.getData().clearAllVisual()}),sU.markUpdateMethod(t,"updateVisual"),e(i),this._scheduler.performVisualTasks(i,t,{visualType:"visual",setDirty:!0}),i.eachComponent(function(e,a){if("series"!==e){var r=n.getViewOfComponentModel(a);r&&r.__alive&&r.updateVisual(a,i,n._api,t)}}),i.eachSeries(function(e){n._chartsMap[e.__viewId].updateVisual(e,i,n._api,t)}),WV.trigger("afterupdate",i,this._api))},updateLayout:function(e){dq.update.call(this,e)}},uq=function(e,t,n,i,a){if(e._disposed)e.id;else for(var r,s=e._model,o=e._coordSysMgr.getCoordinateSystems(),l=UE(s,n),c=0;c<o.length;c++){var d=o[c];if(d[t]&&null!=(r=d[t](s,l,i,a)))return r}},hq=function(e,t){var n=e._chartsMap,i=e._scheduler;t.eachSeries(function(e){i.updateStreamModes(e,n[e.__viewId])})},pq=function(e,t){var n=this,i=this.getModel(),a=e.type,r=e.escapeConnect,s=Eq[a],o=(s.update||"update").split(":"),l=o.pop(),c=null!=o[0]&&YE(o[0]);this[XV]=!0,Cq(this);var d=[e],u=!1;e.batch&&(u=!0,d=UC(e.batch,function(t){return(t=$C(RC({},t),e)).batch=null,t}));var h,p=[],g=[],v=s.nonRefinedEventType,f=r$(e),m=s$(e);if(m&&WR(this._api),jC(d,function(t){var a=s.action(t,i,n._api);if(s.refineEvent?g.push(a):h=a,(h=h||RC({},t)).type=v,p.push(h),m){var r=VE(e),o=r.queryOptionMap,d=r.mainTypeSpecified?o.keys()[0]:"series";cq(n,l,t,d),xq(n)}else f?(cq(n,l,t,"series"),xq(n)):c&&cq(n,l,t,c.main,c.sub)}),"none"!==l&&!m&&!f&&!c)try{this[eq]?(oq(this),dq.update.call(this,e),this[eq]=null):dq[l].call(this,e)}catch(k){throw this[XV]=!1,k}if(h=u?{type:v,escapeConnect:r,batch:p}:p[0],this[XV]=!1,!t){var y=void 0;if(s.refineEvent){var b=s.refineEvent(g,e,i,this._api).eventContent;pI(eI(b)),(y=$C({type:s.refinedEventType},b)).fromAction=e.type,y.fromActionPayload=e,y.escapeConnect=!0}var w=this._messageCenter;w.trigger(h.type,h),y&&w.trigger(y.type,y)}},gq=function(e){for(var t=this._pendingActions;t.length;){var n=t.shift();pq.call(this,n,e)}},vq=function(e){!e&&this.trigger("updated")},fq=function(e,t){e.on("rendered",function(n){t.trigger("rendered",n),!e.animation.isFinished()||t[eq]||t._scheduler.unfinished||t._pendingActions.length||t.trigger("finished")})},mq=function(e,t){e.on("mouseover",function(e){var n=iV(e.target,a$);n&&(!function(e,t,n){var i=uR(e),a=KR(i.componentMainType,i.componentIndex,i.componentHighDownName,n),r=a.dispatchers,s=a.focusSelf;r?(s&&QR(i.componentMainType,i.componentIndex,n),jC(r,function(e){return LR(e,t)})):(GR(i.seriesIndex,i.focus,i.blurScope,n),"self"===i.focus&&QR(i.componentMainType,i.componentIndex,n),LR(e,t))}(n,e,t._api),xq(t))}).on("mouseout",function(e){var n=iV(e.target,a$);n&&(!function(e,t,n){WR(n);var i=uR(e),a=KR(i.componentMainType,i.componentIndex,i.componentHighDownName,n).dispatchers;a?jC(a,function(e){return NR(e,t)}):NR(e,t)}(n,e,t._api),xq(t))}).on("click",function(e){var n=iV(e.target,function(e){return null!=uR(e).dataIndex},!0);if(n){var i=n.selected?"unselect":"select",a=uR(n);t._api.dispatchAction({type:i,dataType:a.dataType,dataIndexInside:a.dataIndex,seriesIndex:a.seriesIndex,isFromClick:!0})}})},yq=function(e,t,n,i,a){!function(e){var t=[],n=[],i=!1;if(e.eachComponent(function(e,a){var r=a.get("zlevel")||0,s=a.get("z")||0,o=a.getZLevelKey();i=i||!!o,("series"===e?n:t).push({zlevel:r,z:s,idx:a.componentIndex,type:e,key:o})}),i){var a,r,s=t.concat(n);pT(s,function(e,t){return e.zlevel===t.zlevel?e.z-t.z:e.zlevel-t.zlevel}),jC(s,function(t){var n=e.getComponent(t.type,t.idx),i=t.zlevel,s=t.key;null!=a&&(i=Math.max(a,i)),s?(i===a&&s!==r&&i++,r=s):r&&(i===a&&i++,r=""),a=i,n.setZLevel(i)})}}(t),bq(e,t,n,i,a),jC(e._chartsViews,function(e){e.__alive=!1}),wq(e,t,n,i,a),jC(e._chartsViews,function(e){e.__alive||e.remove(t,n)})},bq=function(e,t,r,s,o,l){jC(l||e._componentsViews,function(e){var o=e.__model;i(o,e),e.render(o,t,r,s),n(o,e),a(o,e)})},wq=function(e,t,r,s,o,l){var c=e._scheduler;o=RC(o||{},{updatedSeries:t.getSeries()}),WV.trigger("series:beforeupdate",t,r,o);var d=!1;t.eachSeries(function(t){var n=e._chartsMap[t.__viewId];n.__alive=!0;var a=n.renderTask;c.updatePayload(a,s),i(t,n),l&&l.get(t.uid)&&a.dirty(),a.perform(c.getPerformArgs(a))&&(d=!0),n.group.silent=!!t.get("silent"),function(e,t){var n=e.get("blendMode")||null;t.eachRendered(function(e){e.isGroup||(e.style.blend=n)})}(t,n),ZR(t)}),c.unfinished=d||c.unfinished,WV.trigger("series:layoutlabels",t,r,o),WV.trigger("series:transition",t,r,o),t.eachSeries(function(t){var i=e._chartsMap[t.__viewId];n(t,i),a(t,i)}),function(e,t){var n=e._zr,i=n.storage,a=0;i.traverse(function(e){e.isGroup||a++}),a>t.get("hoverLayerThreshold")&&!pC.node&&!pC.worker&&t.eachSeries(function(t){if(!t.preventUsingHoverLayer){var n=e._chartsMap[t.__viewId];n.__alive&&n.eachRendered(function(e){e.states.emphasis&&(e.states.emphasis.hoverLayer=!0)})}})}(e,t),WV.trigger("series:afterupdate",t,r,o)},xq=function(e){e[tq]=!0,e.getZr().wakeUp()},Cq=function(e){e[JV]=(e[JV]+1)%1e3},_q=function(e){e[tq]&&(e.getZr().storage.traverse(function(e){_O(e)||t(e)}),e[tq]=!1)},kq=function(e){return new(function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return uC(n,t),n.prototype.getCoordinateSystems=function(){return e._coordSysMgr.getCoordinateSystems()},n.prototype.getComponentByElement=function(t){for(;t;){var n=t.__ecComponentInfo;if(null!=n)return e._model.getComponent(n.mainType,n.index);t=t.parent}},n.prototype.enterEmphasis=function(t,n){FR(t,n),xq(e)},n.prototype.leaveEmphasis=function(t,n){BR(t,n),xq(e)},n.prototype.enterBlur=function(t){jR(t),xq(e)},n.prototype.leaveBlur=function(t){UR(t),xq(e)},n.prototype.enterSelect=function(t){VR(t),xq(e)},n.prototype.leaveSelect=function(t){qR(t),xq(e)},n.prototype.getModel=function(){return e.getModel()},n.prototype.getViewOfComponentModel=function(t){return e.getViewOfComponentModel(t)},n.prototype.getViewOfSeriesModel=function(t){return e.getViewOfSeriesModel(t)},n.prototype.getMainProcessVersion=function(){return e[JV]},n}(ZF))(e)},Sq=function(e){function t(e,t){for(var n=0;n<e.length;n++){e[n][iq]=t}}jC(zq,function(n,i){e._messageCenter.on(i,function(n){if(Bq[e.group]&&0!==e[iq]){if(n&&n.escapeConnect)return;var i=e.makeActionFromEvent(n),a=[];jC(Fq,function(t){t!==e&&t.group===e.group&&a.push(t)}),t(a,0),jC(a,function(e){1!==e[iq]&&e.dispatchAction(i)}),t(a,2)}})})}}(),t}(JI),Mq=Tq.prototype;Mq.on=aq("on"),Mq.off=aq("off"),Mq.one=function(e,t,n){var i=this;this.on.call(this,e,function n(){for(var a=[],r=0;r<arguments.length;r++)a[r]=arguments[r];t&&t.apply&&t.apply(this,a),i.off(e,n)},n)};var Aq=["click","dblclick","mouseover","mouseout","mousemove","mousedown","mouseup","globalout","contextmenu"];var Eq={},zq={},Pq={},Rq=[],$q=[],Oq=[],Lq={},Nq={},Fq={},Bq={},jq=+new Date-0,Uq=+new Date-0,Vq="_echarts_instance_";function qq(e,t,n){var i=!(n&&n.ssr);if(i){var a=Gq(e);if(a)return a}var r=new Tq(e,t,n);return r.id="ec_"+jq++,Fq[r.id]=r,i&&GE(e,Vq,r.id),Sq(r),WV.trigger("afterinit",r),r}function Hq(e){Bq[e]=!1}var Wq=Hq;function Gq(e){return Fq[function(e,t){return e.getAttribute?e.getAttribute(t):e[t]}(e,Vq)]}function Qq(e,t){Lq[e]=t}function Kq(e){LC($q,e)<0&&$q.push(e)}function Zq(e,t){rH(Rq,e,t,2e3)}function Yq(e){Jq("afterinit",e)}function Xq(e){Jq("afterupdate",e)}function Jq(e,t){WV.on(e,t)}function eH(e,t,n){var i,a,r,s,o;function l(e){return e.toLowerCase()}ZC(t)&&(n=t,t=""),eI(e)?(i=e.type,a=e.event,s=e.update,o=e.publishNonRefinedEvent,n||(n=e.action),r=e.refineEvent):(i=e,a=t),a=l(a||i);var c=r?l(i):a;Eq[i]||(pI(nq.test(i)&&nq.test(a)),r&&pI(a!==i),Eq[i]={actionType:i,refinedEventType:a,nonRefinedEventType:c,update:s,action:n,refineEvent:r},Pq[a]=1,r&&o&&(Pq[c]=1),zq[c]=i)}function tH(e,t){UN.register(e,t)}function nH(e,t){rH(Oq,e,t,1e3,"layout")}function iH(e,t){rH(Oq,e,t,3e3,"visual")}var aH=[];function rH(e,t,n,i,a){if((ZC(t)||eI(t))&&(n=t,t=i),!(LC(aH,n)>=0)){aH.push(n);var r=TU.wrapStageHandler(n,a);r.__prio=t,r.__raw=n,e.push(r)}}function sH(e,t){Nq[e]=t}function oH(e,t,n){var i=QV("registerMap");i&&i(e,t,n)}var lH=function(e){var t=(e=zC(e)).type;t||_E("");var n=t.split(":");2!==n.length&&_E("");var i=!1;"echarts"===n[0]&&(t=n[1],i=!0),e.__isBuiltIn=i,hj.set(t,e)};function cH(e,t,n,i){return{eventContent:{selected:YR(n),isFromClick:t.isFromClick||!1}}}iH(KV,xU),iH(ZV,CU),iH(ZV,IU),iH(KV,XU),iH(ZV,JU),iH(7e3,function(e,t){e.eachRawSeries(function(n){if(!e.isSeriesFiltered(n)){var i=n.getData();i.hasItemVisual()&&i.each(function(e){var n=i.getItemVisual(e,"decal");n&&(i.ensureUniqueItemVisual(e,"style").decal=UV(n,t))});var a=i.getVisual("decal");if(a)i.getVisual("style").decal=UV(a,t)}})}),Kq(bB),Zq(900,function(e){var t=kI();e.eachSeries(function(e){var n=e.get("stack");if(n){var i=t.get(n)||t.set(n,[]),a=e.getData(),r={stackResultDimension:a.getCalculationInfo("stackResultDimension"),stackedOverDimension:a.getCalculationInfo("stackedOverDimension"),stackedDimension:a.getCalculationInfo("stackedDimension"),stackedByDimension:a.getCalculationInfo("stackedByDimension"),isStackedByIndex:a.getCalculationInfo("isStackedByIndex"),data:a,seriesModel:e};if(!r.stackedDimension||!r.isStackedByIndex&&!r.stackedByDimension)return;i.push(r)}}),t.each(function(e){0!==e.length&&("seriesDesc"===(e[0].seriesModel.get("stackOrder")||"seriesAsc")&&e.reverse(),jC(e,function(t,n){t.data.setCalculationInfo("stackedOnSeries",n>0?e[n-1].seriesModel:null)}),function(e){jC(e,function(t,n){var i=[],a=[NaN,NaN],r=[t.stackResultDimension,t.stackedOverDimension],s=t.data,o=t.isStackedByIndex,l=t.seriesModel.get("stackStrategy")||"samesign";s.modify(r,function(r,c,d){var u,h,p=s.get(t.stackedDimension,d);if(isNaN(p))return a;o?h=s.getRawIndex(d):u=s.get(t.stackedByDimension,d);for(var g=NaN,v=n-1;v>=0;v--){var f=e[v];if(o||(h=f.data.rawIndexOf(f.stackedByDimension,u)),h>=0){var m=f.data.getByRawIndex(f.stackResultDimension,h);if("all"===l||"positive"===l&&m>0||"negative"===l&&m<0||"samesign"===l&&p>=0&&m>0||"samesign"===l&&p<=0&&m<0){p=cE(p,m),g=m;break}}}return i[0]=p,i[1]=g,i})})}(e))})}),sH("default",function(e,t){$C(t=t||{},{text:"loading",textColor:uF.color.primary,fontSize:12,fontWeight:"normal",fontStyle:"normal",fontFamily:"sans-serif",maskColor:"rgba(255,255,255,0.8)",showSpinner:!0,color:uF.color.theme[0],spinnerRadius:10,lineWidth:5,zlevel:0});var n=new jA,i=new KP({style:{fill:t.maskColor},zlevel:t.zlevel,z:1e4});n.add(i);var a,r=new JP({style:{text:t.text,fill:t.textColor,fontSize:t.fontSize,fontWeight:t.fontWeight,fontStyle:t.fontStyle,fontFamily:t.fontFamily},zlevel:t.zlevel,z:10001}),s=new KP({style:{fill:"none"},textContent:r,textConfig:{position:"right",distance:10},zlevel:t.zlevel,z:10001});return n.add(s),t.showSpinner&&((a=new aO({shape:{startAngle:-DU/2,endAngle:-DU/2+.1,r:t.spinnerRadius},style:{stroke:t.color,lineCap:"round",lineWidth:t.lineWidth},zlevel:t.zlevel,z:10001})).animateShape(!0).when(1e3,{endAngle:3*DU/2}).start("circularInOut"),a.animateShape(!0).when(1e3,{startAngle:3*DU/2}).delay(300).start("circularInOut"),n.add(a)),n.resize=function(){var n=r.getBoundingRect().width,o=t.showSpinner?t.spinnerRadius:0,l=(e.getWidth()-2*o-(t.showSpinner&&n?10:0)-n)/2-(t.showSpinner&&n?0:5+n/2)+(t.showSpinner?0:n/2)+(n?0:o),c=e.getHeight()/2;t.showSpinner&&a.setShape({cx:l,cy:c}),s.setShape({x:l-o,y:c-o,width:2*o,height:2*o}),i.setShape({x:0,y:0,width:e.getWidth(),height:e.getHeight()})},n.resize(),n}),eH({type:yR,event:yR,update:yR},II),eH({type:bR,event:bR,update:bR},II),eH({type:wR,event:xR,update:wR,action:II,refineEvent:cH,publishNonRefinedEvent:!0}),eH({type:kR,event:xR,update:kR,action:II,refineEvent:cH,publishNonRefinedEvent:!0}),eH({type:SR,event:xR,update:SR,action:II,refineEvent:cH,publishNonRefinedEvent:!0}),Qq("default",{}),Qq("dark",QU);function dH(e){return null==e?0:e.length||1}function uH(e){return e}var hH=function(){function e(e,t,n,i,a,r){this._old=e,this._new=t,this._oldKeyGetter=n||uH,this._newKeyGetter=i||uH,this.context=a,this._diffModeMultiple="multiple"===r}return e.prototype.add=function(e){return this._add=e,this},e.prototype.update=function(e){return this._update=e,this},e.prototype.updateManyToOne=function(e){return this._updateManyToOne=e,this},e.prototype.updateOneToMany=function(e){return this._updateOneToMany=e,this},e.prototype.updateManyToMany=function(e){return this._updateManyToMany=e,this},e.prototype.remove=function(e){return this._remove=e,this},e.prototype.execute=function(){this[this._diffModeMultiple?"_executeMultiple":"_executeOneToOne"]()},e.prototype._executeOneToOne=function(){var e=this._old,t=this._new,n={},i=new Array(e.length),a=new Array(t.length);this._initIndexMap(e,null,i,"_oldKeyGetter"),this._initIndexMap(t,n,a,"_newKeyGetter");for(var r=0;r<e.length;r++){var s=i[r],o=n[s],l=dH(o);if(l>1){var c=o.shift();1===o.length&&(n[s]=o[0]),this._update&&this._update(c,r)}else 1===l?(n[s]=null,this._update&&this._update(o,r)):this._remove&&this._remove(r)}this._performRestAdd(a,n)},e.prototype._executeMultiple=function(){var e=this._old,t=this._new,n={},i={},a=[],r=[];this._initIndexMap(e,n,a,"_oldKeyGetter"),this._initIndexMap(t,i,r,"_newKeyGetter");for(var s=0;s<a.length;s++){var o=a[s],l=n[o],c=i[o],d=dH(l),u=dH(c);if(d>1&&1===u)this._updateManyToOne&&this._updateManyToOne(c,l),i[o]=null;else if(1===d&&u>1)this._updateOneToMany&&this._updateOneToMany(c,l),i[o]=null;else if(1===d&&1===u)this._update&&this._update(c,l),i[o]=null;else if(d>1&&u>1)this._updateManyToMany&&this._updateManyToMany(c,l),i[o]=null;else if(d>1)for(var h=0;h<d;h++)this._remove&&this._remove(l[h]);else this._remove&&this._remove(l)}this._performRestAdd(r,i)},e.prototype._performRestAdd=function(e,t){for(var n=0;n<e.length;n++){var i=e[n],a=t[i],r=dH(a);if(r>1)for(var s=0;s<r;s++)this._add&&this._add(a[s]);else 1===r&&this._add&&this._add(a);t[i]=null}},e.prototype._initIndexMap=function(e,t,n,i){for(var a=this._diffModeMultiple,r=0;r<e.length;r++){var s="_ec_"+this[i](e[r],r);if(a||(n[r]=s),t){var o=t[s],l=dH(o);0===l?(t[s]=r,a&&n.push(s)):1===l?t[s]=[o,r]:o.push(r)}}},e}(),pH=function(){function e(e,t){this._encode=e,this._schema=t}return e.prototype.get=function(){return{fullDimensions:this._getFullDimensionNames(),encode:this._encode}},e.prototype._getFullDimensionNames=function(){return this._cachedDimNames||(this._cachedDimNames=this._schema?this._schema.makeOutputDimensionNames():[]),this._cachedDimNames},e}();function gH(e,t){return e.hasOwnProperty(t)||(e[t]=[]),e[t]}var vH=function(){return function(e){this.otherDims={},null!=e&&RC(this,e)}}(),fH=BE(),mH={float:"f",int:"i",ordinal:"o",number:"n",time:"t"},yH=function(){function e(e){this.dimensions=e.dimensions,this._dimOmitted=e.dimensionOmitted,this.source=e.source,this._fullDimCount=e.fullDimensionCount,this._updateDimOmitted(e.dimensionOmitted)}return e.prototype.isDimensionOmitted=function(){return this._dimOmitted},e.prototype._updateDimOmitted=function(e){this._dimOmitted=e,e&&(this._dimNameMap||(this._dimNameMap=kH(this.source)))},e.prototype.getSourceDimensionIndex=function(e){return cI(this._dimNameMap.get(e),-1)},e.prototype.getSourceDimension=function(e){var t=this.source.dimensionsDefine;if(t)return t[e]},e.prototype.makeStoreSchema=function(){for(var e=this._fullDimCount,t=PB(this.source),n=!SH(e),i="",a=[],r=0,s=0;r<e;r++){var o=void 0,l=void 0,c=void 0,d=this.dimensions[s];if(d&&d.storeDimIndex===r)o=t?d.name:null,l=d.type,c=d.ordinalMeta,s++;else{var u=this.getSourceDimension(r);u&&(o=t?u.name:null,l=u.type)}a.push({property:o,type:l,ordinalMeta:c}),!t||null==o||d&&d.isCalculationCoord||(i+=n?o.replace(/\`/g,"`1").replace(/\$/g,"`2"):o),i+="$",i+=mH[l]||"f",c&&(i+=c.uid),i+="$"}var h=this.source;return{dimensions:a,hash:[h.seriesLayoutBy,h.startIndex,i].join("$$")}},e.prototype.makeOutputDimensionNames=function(){for(var e=[],t=0,n=0;t<this._fullDimCount;t++){var i=void 0,a=this.dimensions[n];if(a&&a.storeDimIndex===t)a.isCalculationCoord||(i=a.name),n++;else{var r=this.getSourceDimension(t);r&&(i=r.name)}e.push(i)}return e},e.prototype.appendCalculationDimension=function(e){this.dimensions.push(e),e.isCalculationCoord=!0,this._fullDimCount++,this._updateDimOmitted(!0)},e}();function bH(e){return e instanceof yH}function wH(e){for(var t=kI(),n=0;n<(e||[]).length;n++){var i=e[n],a=eI(i)?i.name:i;null!=a&&null==t.get(a)&&t.set(a,n)}return t}function kH(e){var t=fH(e);return t.dimNameMap||(t.dimNameMap=wH(e.dimensionsDefine))}function SH(e){return e>30}var xH,_H,CH,IH,DH,TH,MH,AH=eI,EH=UC,zH="undefined"==typeof Int32Array?Array:Int32Array,PH=["hasItemOption","_nameList","_idList","_invertedIndicesMap","_dimSummary","userOutput","_rawData","_dimValueGetter","_nameDimIdx","_idDimIdx","_nameRepeatCount"],RH=["_approximateExtent"],$H=function(){function e(e,t){var n;this.type="list",this._dimOmitted=!1,this._nameList=[],this._idList=[],this._visual={},this._layout={},this._itemVisuals=[],this._itemLayouts=[],this._graphicEls=[],this._approximateExtent={},this._calculationInfo={},this.hasItemOption=!1,this.TRANSFERABLE_METHODS=["cloneShallow","downSample","minmaxDownSample","lttbDownSample","map"],this.CHANGABLE_METHODS=["filterSelf","selectRange"],this.DOWNSAMPLE_METHODS=["downSample","minmaxDownSample","lttbDownSample"];var i=!1;bH(e)?(n=e.dimensions,this._dimOmitted=e.isDimensionOmitted(),this._schema=e):(i=!0,n=e),n=n||["x","y"];for(var a={},r=[],s={},o=!1,l={},c=0;c<n.length;c++){var d=n[c],u=YC(d)?new vH({name:d}):d instanceof vH?d:new vH(d),h=u.name;u.type=u.type||"float",u.coordDim||(u.coordDim=h,u.coordDimIndex=0);var p=u.otherDims=u.otherDims||{};r.push(h),a[h]=u,null!=l[h]&&(o=!0),u.createInvertedIndices&&(s[h]=[]);var g=c;JC(u.storeDimIndex)&&(g=u.storeDimIndex),0===p.itemName&&(this._nameDimIdx=g),0===p.itemId&&(this._idDimIdx=g),i&&(u.storeDimIndex=c)}if(this.dimensions=r,this._dimInfos=a,this._initGetDimensionInfo(o),this.hostModel=t,this._invertedIndicesMap=s,this._dimOmitted){var v=this._dimIdxToName=kI();jC(r,function(e){v.set(a[e].storeDimIndex,e)})}}return e.prototype.getDimension=function(e){var t=this._recognizeDimIndex(e);if(null==t)return e;if(t=e,!this._dimOmitted)return this.dimensions[t];var n=this._dimIdxToName.get(t);if(null!=n)return n;var i=this._schema.getSourceDimension(t);return i?i.name:void 0},e.prototype.getDimensionIndex=function(e){var t=this._recognizeDimIndex(e);if(null!=t)return t;if(null==e)return-1;var n=this._getDimInfo(e);return n?n.storeDimIndex:this._dimOmitted?this._schema.getSourceDimensionIndex(e):-1},e.prototype._recognizeDimIndex=function(e){if(JC(e)||null!=e&&!isNaN(e)&&!this._getDimInfo(e)&&(!this._dimOmitted||this._schema.getSourceDimensionIndex(e)<0))return+e},e.prototype._getStoreDimIndex=function(e){return this.getDimensionIndex(e)},e.prototype.getDimensionInfo=function(e){return this._getDimInfo(this.getDimension(e))},e.prototype._initGetDimensionInfo=function(e){var t=this._dimInfos;this._getDimInfo=e?function(e){return t.hasOwnProperty(e)?t[e]:void 0}:function(e){return t[e]}},e.prototype.getDimensionsOnCoord=function(){return this._dimSummary.dataDimsOnCoord.slice()},e.prototype.mapDimension=function(e,t){var n=this._dimSummary;if(null==t)return n.encodeFirstDimNotExtra[e];var i=n.encode[e];return i?i[t]:null},e.prototype.mapDimensionsAll=function(e){return(this._dimSummary.encode[e]||[]).slice()},e.prototype.getStore=function(){return this._store},e.prototype.initData=function(e,t,n){var i,a=this;if(e instanceof Ij&&(i=e),!i){var r=this.dimensions,s=DB(e)||BC(e)?new RB(e,r.length):e;i=new Ij;var o=EH(r,function(e){return{type:a._dimInfos[e].type,property:e}});i.initData(s,o,n)}this._store=i,this._nameList=(t||[]).slice(),this._idList=[],this._nameRepeatCount={},this._doInit(0,i.count()),this._dimSummary=function(e,t){var n={},i=n.encode={},a=kI(),r=[],s=[],o={};jC(e.dimensions,function(t){var n,l=e.getDimensionInfo(t),c=l.coordDim;if(c){var d=l.coordDimIndex;gH(i,c)[d]=t,l.isExtraCoord||(a.set(c,1),"ordinal"!==(n=l.type)&&"time"!==n&&(r[0]=t),gH(o,c)[d]=e.getDimensionIndex(l.name)),l.defaultTooltip&&s.push(t)}wF.each(function(e,t){var n=gH(i,t),a=l.otherDims[t];null!=a&&!1!==a&&(n[a]=l.name)})});var l=[],c={};a.each(function(e,t){var n=i[t];c[t]=n[0],l=l.concat(n)}),n.dataDimsOnCoord=l,n.dataDimIndicesOnCoord=UC(l,function(t){return e.getDimensionInfo(t).storeDimIndex}),n.encodeFirstDimNotExtra=c;var d=i.label;d&&d.length&&(r=d.slice());var u=i.tooltip;return u&&u.length?s=u.slice():s.length||(s=r.slice()),i.defaultedLabel=r,i.defaultedTooltip=s,n.userOutput=new pH(o,t),n}(this,this._schema),this.userOutput=this._dimSummary.userOutput},e.prototype.appendData=function(e){var t=this._store.appendData(e);this._doInit(t[0],t[1])},e.prototype.appendValues=function(e,t){var n=this._store.appendValues(e,t&&t.length),i=n.start,a=n.end,r=this._shouldMakeIdFromName();if(this._updateOrdinalMeta(),t)for(var s=i;s<a;s++){var o=s-i;this._nameList[s]=t[o],r&&MH(this,s)}},e.prototype._updateOrdinalMeta=function(){for(var e=this._store,t=this.dimensions,n=0;n<t.length;n++){var i=this._dimInfos[t[n]];i.ordinalMeta&&e.collectOrdinalMeta(i.storeDimIndex,i.ordinalMeta)}},e.prototype._shouldMakeIdFromName=function(){var e=this._store.getProvider();return null==this._idDimIdx&&e.getSource().sourceFormat!==CF&&!e.fillStorage},e.prototype._doInit=function(e,t){if(!(e>=t)){var n=this._store.getProvider();this._updateOrdinalMeta();var i=this._nameList,a=this._idList;if(n.getSource().sourceFormat===kF&&!n.pure)for(var r=[],s=e;s<t;s++){var o=n.getItem(s,r);if(!this.hasItemOption&&zE(o)&&(this.hasItemOption=!0),o){var l=o.name;null==i[s]&&null!=l&&(i[s]=OE(l,null));var c=o.id;null==a[s]&&null!=c&&(a[s]=OE(c,null))}}if(this._shouldMakeIdFromName())for(s=e;s<t;s++)MH(this,s);xH(this)}},e.prototype.getApproximateExtent=function(e){return this._approximateExtent[e]||this._store.getDataExtent(this._getStoreDimIndex(e))},e.prototype.setApproximateExtent=function(e,t){t=this.getDimension(t),this._approximateExtent[t]=e.slice()},e.prototype.getCalculationInfo=function(e){return this._calculationInfo[e]},e.prototype.setCalculationInfo=function(e,t){AH(e)?RC(this._calculationInfo,e):this._calculationInfo[e]=t},e.prototype.getName=function(e){var t=this.getRawIndex(e),n=this._nameList[t];return null==n&&null!=this._nameDimIdx&&(n=CH(this,this._nameDimIdx,t)),null==n&&(n=""),n},e.prototype._getCategory=function(e,t){var n=this._store.get(e,t),i=this._store.getOrdinalMeta(e);return i?i.categories[n]:n},e.prototype.getId=function(e){return _H(this,this.getRawIndex(e))},e.prototype.count=function(){return this._store.count()},e.prototype.get=function(e,t){var n=this._store,i=this._dimInfos[e];if(i)return n.get(i.storeDimIndex,t)},e.prototype.getByRawIndex=function(e,t){var n=this._store,i=this._dimInfos[e];if(i)return n.getByRawIndex(i.storeDimIndex,t)},e.prototype.getIndices=function(){return this._store.getIndices()},e.prototype.getDataExtent=function(e){return this._store.getDataExtent(this._getStoreDimIndex(e))},e.prototype.getSum=function(e){return this._store.getSum(this._getStoreDimIndex(e))},e.prototype.getMedian=function(e){return this._store.getMedian(this._getStoreDimIndex(e))},e.prototype.getValues=function(e,t){var n=this,i=this._store;return KC(e)?i.getValues(EH(e,function(e){return n._getStoreDimIndex(e)}),t):i.getValues(e)},e.prototype.hasValue=function(e){for(var t=this._dimSummary.dataDimIndicesOnCoord,n=0,i=t.length;n<i;n++)if(isNaN(this._store.get(t[n],e)))return!1;return!0},e.prototype.indexOfName=function(e){for(var t=0,n=this._store.count();t<n;t++)if(this.getName(t)===e)return t;return-1},e.prototype.getRawIndex=function(e){return this._store.getRawIndex(e)},e.prototype.indexOfRawIndex=function(e){return this._store.indexOfRawIndex(e)},e.prototype.rawIndexOf=function(e,t){var n=e&&this._invertedIndicesMap[e],i=n&&n[t];return null==i||isNaN(i)?-1:i},e.prototype.each=function(e,t,n){ZC(e)&&(n=t,t=e,e=[]);var i=n||this,a=EH(IH(e),this._getStoreDimIndex,this);this._store.each(a,i?GC(t,i):t)},e.prototype.filterSelf=function(e,t,n){ZC(e)&&(n=t,t=e,e=[]);var i=n||this,a=EH(IH(e),this._getStoreDimIndex,this);return this._store=this._store.filter(a,i?GC(t,i):t),this},e.prototype.selectRange=function(e){var t=this,n={};return jC(WC(e),function(i){var a=t._getStoreDimIndex(i);n[a]=e[i]}),this._store=this._store.selectRange(n),this},e.prototype.mapArray=function(e,t,n){ZC(e)&&(n=t,t=e,e=[]),n=n||this;var i=[];return this.each(e,function(){i.push(t&&t.apply(this,arguments))},n),i},e.prototype.map=function(e,t,n,i){var a=n||i||this,r=EH(IH(e),this._getStoreDimIndex,this),s=TH(this);return s._store=this._store.map(r,a?GC(t,a):t),s},e.prototype.modify=function(e,t,n,i){var a=n||i||this,r=EH(IH(e),this._getStoreDimIndex,this);this._store.modify(r,a?GC(t,a):t)},e.prototype.downSample=function(e,t,n,i){var a=TH(this);return a._store=this._store.downSample(this._getStoreDimIndex(e),t,n,i),a},e.prototype.minmaxDownSample=function(e,t){var n=TH(this);return n._store=this._store.minmaxDownSample(this._getStoreDimIndex(e),t),n},e.prototype.lttbDownSample=function(e,t){var n=TH(this);return n._store=this._store.lttbDownSample(this._getStoreDimIndex(e),t),n},e.prototype.getRawDataItem=function(e){return this._store.getRawDataItem(e)},e.prototype.getItemModel=function(e){var t=this.hostModel,n=this.getRawDataItem(e);return new BL(n,t,t&&t.ecModel)},e.prototype.diff=function(e){var t=this;return new hH(e?e.getStore().getIndices():[],this.getStore().getIndices(),function(t){return _H(e,t)},function(e){return _H(t,e)})},e.prototype.getVisual=function(e){var t=this._visual;return t&&t[e]},e.prototype.setVisual=function(e,t){this._visual=this._visual||{},AH(e)?RC(this._visual,e):this._visual[e]=t},e.prototype.getItemVisual=function(e,t){var n=this._itemVisuals[e],i=n&&n[t];return null==i?this.getVisual(t):i},e.prototype.hasItemVisual=function(){return this._itemVisuals.length>0},e.prototype.ensureUniqueItemVisual=function(e,t){var n=this._itemVisuals,i=n[e];i||(i=n[e]={});var a=i[t];return null==a&&(KC(a=this.getVisual(t))?a=a.slice():AH(a)&&(a=RC({},a)),i[t]=a),a},e.prototype.setItemVisual=function(e,t,n){var i=this._itemVisuals[e]||{};this._itemVisuals[e]=i,AH(t)?RC(i,t):i[t]=n},e.prototype.clearAllVisual=function(){this._visual={},this._itemVisuals=[]},e.prototype.setLayout=function(e,t){AH(e)?RC(this._layout,e):this._layout[e]=t},e.prototype.getLayout=function(e){return this._layout[e]},e.prototype.getItemLayout=function(e){return this._itemLayouts[e]},e.prototype.setItemLayout=function(e,t,n){this._itemLayouts[e]=n?RC(this._itemLayouts[e]||{},t):t},e.prototype.clearItemLayouts=function(){this._itemLayouts.length=0},e.prototype.setItemGraphicEl=function(e,t){!function(e,t,n,i){if(i){var a=uR(i);a.dataIndex=n,a.dataType=t,a.seriesIndex=e,a.ssrType="chart","group"===i.type&&i.traverse(function(i){var a=uR(i);a.seriesIndex=e,a.dataIndex=n,a.dataType=t,a.ssrType="chart"})}}(this.hostModel&&this.hostModel.seriesIndex,this.dataType,e,t),this._graphicEls[e]=t},e.prototype.getItemGraphicEl=function(e){return this._graphicEls[e]},e.prototype.eachItemGraphicEl=function(e,t){jC(this._graphicEls,function(n,i){n&&e&&e.call(t,n,i)})},e.prototype.cloneShallow=function(t){return t||(t=new e(this._schema?this._schema:EH(this.dimensions,this._getDimInfo,this),this.hostModel)),DH(t,this),t._store=this._store,t},e.prototype.wrapMethod=function(e,t){var n=this[e];ZC(n)&&(this.__wrappedMethods=this.__wrappedMethods||[],this.__wrappedMethods.push(e),this[e]=function(){var e=n.apply(this,arguments);return t.apply(this,[e].concat(uI(arguments)))})},e.internalField=(xH=function(e){var t=e._invertedIndicesMap;jC(t,function(n,i){var a=e._dimInfos[i],r=a.ordinalMeta,s=e._store;if(r){n=t[i]=new zH(r.categories.length);for(var o=0;o<n.length;o++)n[o]=-1;for(o=0;o<s.count();o++)n[s.get(a.storeDimIndex,o)]=o}})},CH=function(e,t,n){return OE(e._getCategory(t,n),null)},_H=function(e,t){var n=e._idList[t];return null==n&&null!=e._idDimIdx&&(n=CH(e,e._idDimIdx,t)),null==n&&(n="e\0\0"+t),n},IH=function(e){return KC(e)||(e=null!=e?[e]:[]),e},TH=function(t){var n=new e(t._schema?t._schema:EH(t.dimensions,t._getDimInfo,t),t.hostModel);return DH(n,t),n},DH=function(e,t){jC(PH.concat(t.__wrappedMethods||[]),function(n){t.hasOwnProperty(n)&&(e[n]=t[n])}),e.__wrappedMethods=t.__wrappedMethods,jC(RH,function(n){e[n]=zC(t[n])}),e._calculationInfo=RC({},t._calculationInfo)},void(MH=function(e,t){var n=e._nameList,i=e._idList,a=e._nameDimIdx,r=e._idDimIdx,s=n[t],o=i[t];if(null==s&&null!=a&&(n[t]=s=CH(e,a,t)),null==o&&null!=r&&(i[t]=o=CH(e,r,t)),null==o&&null!=s){var l=e._nameRepeatCount,c=l[s]=(l[s]||0)+1;o=s,c>1&&(o+="__ec__"+c),i[t]=o}})),e}();function OH(e,t){DB(e)||(e=MB(e));var n=(t=t||{}).coordDimensions||[],i=t.dimensionsDefine||e.dimensionsDefine||[],a=kI(),r=[],s=function(e,t,n,i){var a=Math.max(e.dimensionsDetectedCount||1,t.length,n.length,i||0);return jC(t,function(e){var t;eI(e)&&(t=e.dimsDef)&&(a=Math.max(a,t.length))}),a}(e,n,i,t.dimensionsCount),o=t.canOmitUnusedDimensions&&SH(s),l=i===e.dimensionsDefine,c=l?kH(e):wH(i),d=t.encodeDefine;!d&&t.encodeDefaulter&&(d=t.encodeDefaulter(e,s));for(var u=kI(d),h=new bj(s),p=0;p<h.length;p++)h[p]=-1;function g(e){var t=h[e];if(t<0){var n=i[e],a=eI(n)?n:{name:n},s=new vH,o=a.name;null!=o&&null!=c.get(o)&&(s.name=s.displayName=o),null!=a.type&&(s.type=a.type),null!=a.displayName&&(s.displayName=a.displayName);var l=r.length;return h[e]=l,s.storeDimIndex=e,r.push(s),s}return r[t]}if(!o)for(p=0;p<s;p++)g(p);u.each(function(e,t){var n=TE(e).slice();if(1===n.length&&!YC(n[0])&&n[0]<0)u.set(t,!1);else{var i=u.set(t,[]);jC(n,function(e,n){var a=YC(e)?c.get(e):e;null!=a&&a<s&&(i[n]=a,f(g(a),t,n))})}});var v=0;function f(e,t,n){null!=wF.get(t)?e.otherDims[t]=n:(e.coordDim=t,e.coordDimIndex=n,a.set(t,!0))}jC(n,function(e){var t,n,i,a;if(YC(e))t=e,a={};else{t=(a=e).name;var r=a.ordinalMeta;a.ordinalMeta=null,(a=RC({},a)).ordinalMeta=r,n=a.dimsDef,i=a.otherDims,a.name=a.coordDim=a.coordDimIndex=a.dimsDef=a.otherDims=null}var o=u.get(t);if(!1!==o){if(!(o=TE(o)).length)for(var c=0;c<(n&&n.length||1);c++){for(;v<s&&null!=g(v).coordDim;)v++;v<s&&o.push(v++)}jC(o,function(e,r){var s=g(e);if(l&&null!=a.type&&(s.type=a.type),f($C(s,a),t,r),null==s.name&&n){var o=n[r];!eI(o)&&(o={name:o}),s.name=s.displayName=o.name,s.defaultTooltip=o.defaultTooltip}i&&$C(s.otherDims,i)})}});var m=t.generateCoord,y=t.generateCoordCount,b=null!=y;y=m?y||1:0;var w=m||"value";function k(e){null==e.name&&(e.name=e.coordDim)}if(o)jC(r,function(e){k(e)}),r.sort(function(e,t){return e.storeDimIndex-t.storeDimIndex});else for(var S=0;S<s;S++){var x=g(S);null==x.coordDim&&(x.coordDim=LH(w,a,b),x.coordDimIndex=0,(!m||y<=0)&&(x.isExtraCoord=!0),y--),k(x),null!=x.type||OF(e,S)!==MF&&(!x.isExtraCoord||null==x.otherDims.itemName&&null==x.otherDims.seriesName)||(x.type="ordinal")}return function(e){for(var t=kI(),n=0;n<e.length;n++){var i=e[n],a=i.name,r=t.get(a)||0;r>0&&(i.name=a+(r-1)),r++,t.set(a,r)}}(r),new yH({source:e,dimensions:r,fullDimensionCount:s,dimensionOmitted:o})}function LH(e,t,n){if(n||t.hasKey(e)){for(var i=0;t.hasKey(e+i);)i++;e+=i}return t.set(e,!0),e}var NH=function(){return function(e){this.coordSysDims=[],this.axisMap=kI(),this.categoryAxisMap=kI(),this.coordSysName=e}}();var FH={cartesian2d:function(e,t,n,i){var a=e.getReferringComponents("xAxis",qE).models[0],r=e.getReferringComponents("yAxis",qE).models[0];t.coordSysDims=["x","y"],n.set("x",a),n.set("y",r),BH(a)&&(i.set("x",a),t.firstCategoryDimIndex=0),BH(r)&&(i.set("y",r),null==t.firstCategoryDimIndex&&(t.firstCategoryDimIndex=1))},singleAxis:function(e,t,n,i){var a=e.getReferringComponents("singleAxis",qE).models[0];t.coordSysDims=["single"],n.set("single",a),BH(a)&&(i.set("single",a),t.firstCategoryDimIndex=0)},polar:function(e,t,n,i){var a=e.getReferringComponents("polar",qE).models[0],r=a.findAxisModel("radiusAxis"),s=a.findAxisModel("angleAxis");t.coordSysDims=["radius","angle"],n.set("radius",r),n.set("angle",s),BH(r)&&(i.set("radius",r),t.firstCategoryDimIndex=0),BH(s)&&(i.set("angle",s),null==t.firstCategoryDimIndex&&(t.firstCategoryDimIndex=1))},geo:function(e,t,n,i){t.coordSysDims=["lng","lat"]},parallel:function(e,t,n,i){var a=e.ecModel,r=a.getComponent("parallel",e.get("parallelIndex")),s=t.coordSysDims=r.dimensions.slice();jC(r.parallelAxisIndex,function(e,r){var o=a.getComponent("parallelAxis",e),l=s[r];n.set(l,o),BH(o)&&(i.set(l,o),null==t.firstCategoryDimIndex&&(t.firstCategoryDimIndex=r))})},matrix:function(e,t,n,i){var a=e.getReferringComponents("matrix",qE).models[0];t.coordSysDims=["x","y"];var r=a.getDimensionModel("x"),s=a.getDimensionModel("y");n.set("x",r),n.set("y",s),i.set("x",r),i.set("y",s)}};function BH(e){return"category"===e.get("type")}function jH(e,t,n){var i,a,r,s=(n=n||{}).byIndex,o=n.stackedCoordDimension;!function(e){return!bH(e.schema)}(t)?(a=t.schema,i=a.dimensions,r=t.store):i=t;var l,c,d,u,h=!(!e||!e.get("stack"));if(jC(i,function(e,t){YC(e)&&(i[t]=e={name:e}),h&&!e.isExtraCoord&&(s||l||!e.ordinalMeta||(l=e),c||"ordinal"===e.type||"time"===e.type||o&&o!==e.coordDim||(c=e))}),!c||s||l||(s=!0),c){d="__\0ecstackresult_"+e.id,u="__\0ecstackedover_"+e.id,l&&(l.createInvertedIndices=!0);var p=c.coordDim,g=c.type,v=0;jC(i,function(e){e.coordDim===p&&v++});var f={name:d,coordDim:p,coordDimIndex:v,type:g,isExtraCoord:!0,isCalculationCoord:!0,storeDimIndex:i.length},m={name:u,coordDim:u,coordDimIndex:v+1,type:g,isExtraCoord:!0,isCalculationCoord:!0,storeDimIndex:i.length+1};a?(r&&(f.storeDimIndex=r.ensureCalculationDimension(u,g),m.storeDimIndex=r.ensureCalculationDimension(d,g)),a.appendCalculationDimension(f),a.appendCalculationDimension(m)):(i.push(f),i.push(m))}return{stackedDimension:c&&c.name,stackedByDimension:l&&l.name,isStackedByIndex:s,stackedOverDimension:u,stackResultDimension:d}}function UH(e,t){return!!t&&t===e.getCalculationInfo("stackedDimension")}function VH(e,t){return UH(e,t)?e.getCalculationInfo("stackResultDimension"):t}function qH(e,t,n){n=n||{};var i,a,r=t.getSourceManager();a=(i=r.getSource()).sourceFormat===kF;var s=function(e){var t=e.get("coordinateSystem"),n=new NH(t),i=FH[t];if(i)return i(e,n,n.axisMap,n.categoryAxisMap),n}(t),o=function(e,t){var n,i=e.get("coordinateSystem"),a=UN.get(i);return t&&t.coordSysDims&&(n=UC(t.coordSysDims,function(e){var n={name:e},i=t.axisMap.get(e);if(i){var a=i.get("type");n.type=function(e){return"category"===e?"ordinal":"time"===e?"time":"float"}(a)}return n})),n||(n=a&&(a.getDimensionsInfo?a.getDimensionsInfo():a.dimensions.slice())||["x","y"]),n}(t,s),l=n.useEncodeDefaulter,c=ZC(l)?l:l?QC(PF,o,t):null,d=OH(i,{coordDimensions:o,generateCoord:n.generateCoord,encodeDefine:t.getEncode(),encodeDefaulter:c,canOmitUnusedDimensions:!a}),u=function(e,t,n){var i,a;return n&&jC(e,function(e,r){var s=e.coordDim,o=n.categoryAxisMap.get(s);o&&(null==i&&(i=r),e.ordinalMeta=o.getOrdinalMeta(),t&&(e.createInvertedIndices=!0)),null!=e.otherDims.itemName&&(a=!0)}),a||null==i||(e[i].otherDims.itemName=0),i}(d.dimensions,n.createInvertedIndices,s),h=a?null:r.getSharedDataStore(d),p=jH(t,{schema:d,store:h}),g=new $H(d,t);g.setCalculationInfo(p);var v=null!=u&&function(e){if(e.sourceFormat===kF){var t=function(e){var t=0;for(;t<e.length&&null==e[t];)t++;return e[t]}(e.data||[]);return!KC(EE(t))}}(i)?function(e,t,n,i){return i===u?n:this.defaultDimValueGetter(e,t,n,i)}:null;return g.hasItemOption=!1,g.initData(a?i:h,null,v),g}function HH(e){return"interval"===e.type||"log"===e.type}function WH(e,t,n,i,a){var r={},s=r.interval=fE(t/n,!0);null!=i&&s<i&&(s=r.interval=i),null!=a&&s>a&&(s=r.interval=a);var o=r.intervalPrecision=QH(s);return function(e,t){!isFinite(e[0])&&(e[0]=t[0]),!isFinite(e[1])&&(e[1]=t[1]),KH(e,0,t),KH(e,1,t),e[0]>e[1]&&(e[0]=e[1])}(r.niceTickExtent=[iE(Math.ceil(e[0]/s)*s,o),iE(Math.floor(e[1]/s)*s,o)],e),r}function GH(e){var t=Math.pow(10,vE(e)),n=e/t;return n?2===n?n=3:3===n?n=5:n*=2:n=1,iE(n*t)}function QH(e){return rE(e)+2}function KH(e,t,n){e[t]=Math.max(Math.min(e[t],n[1]),n[0])}function ZH(e,t){return e>=t[0]&&e<=t[1]}var YH=function(){function e(){this.normalize=XH,this.scale=JH}return e.prototype.updateMethods=function(e){e.hasBreaks()?(this.normalize=GC(e.normalize,e),this.scale=GC(e.scale,e)):(this.normalize=XH,this.scale=JH)},e}();function XH(e,t){return t[1]===t[0]?.5:(e-t[0])/(t[1]-t[0])}function JH(e,t){return e*(t[1]-t[0])+t[0]}function eW(e,t,n){var i=Math.log(e);return[Math.log(n?t[0]:Math.max(0,t[0]))/i,Math.log(n?t[1]:Math.max(0,t[1]))/i]}var tW=function(){function e(e){this._calculator=new YH,this._setting=e||{},this._extent=[1/0,-1/0]}return e.prototype.getSetting=function(e){return this._setting[e]},e.prototype._innerUnionExtent=function(e){var t=this._extent;this._innerSetExtent(e[0]<t[0]?e[0]:t[0],e[1]>t[1]?e[1]:t[1])},e.prototype.unionExtentFromData=function(e,t){this._innerUnionExtent(e.getApproximateExtent(t))},e.prototype.getExtent=function(){return this._extent.slice()},e.prototype.setExtent=function(e,t){this._innerSetExtent(e,t)},e.prototype._innerSetExtent=function(e,t){var n=this._extent;isNaN(e)||(n[0]=e),isNaN(t)||(n[1]=t),this._brkCtx&&this._brkCtx.update(n)},e.prototype.setBreaksFromOption=function(e){},e.prototype._innerSetBreak=function(e){this._brkCtx&&(this._brkCtx.setBreaks(e),this._calculator.updateMethods(this._brkCtx),this._brkCtx.update(this._extent))},e.prototype._innerGetBreaks=function(){return this._brkCtx?this._brkCtx.breaks:[]},e.prototype.hasBreaks=function(){return!!this._brkCtx&&this._brkCtx.hasBreaks()},e.prototype._getExtentSpanWithBreaks=function(){return this._brkCtx&&this._brkCtx.hasBreaks()?this._brkCtx.getExtentSpan():this._extent[1]-this._extent[0]},e.prototype.isInExtentRange=function(e){return this._extent[0]<=e&&this._extent[1]>=e},e.prototype.isBlank=function(){return this._isBlank},e.prototype.setBlank=function(e){this._isBlank=e},e}();iz(tW);var nW=0,iW=function(){function e(e){this.categories=e.categories||[],this._needCollect=e.needCollect,this._deduplication=e.deduplication,this.uid=++nW,this._onCollect=e.onCollect}return e.createByAxisModel=function(t){var n=t.option,i=n.data,a=i&&UC(i,aW);return new e({categories:a,needCollect:!a,deduplication:!1!==n.dedplication})},e.prototype.getOrdinal=function(e){return this._getOrCreateMap().get(e)},e.prototype.parseAndCollect=function(e){var t,n=this._needCollect;if(!YC(e)&&!n)return e;if(n&&!this._deduplication)return t=this.categories.length,this.categories[t]=e,this._onCollect&&this._onCollect(e,t),t;var i=this._getOrCreateMap();return null==(t=i.get(e))&&(n?(t=this.categories.length,this.categories[t]=e,i.set(e,t),this._onCollect&&this._onCollect(e,t)):t=NaN),t},e.prototype._getOrCreateMap=function(){return this._map||(this._map=kI(this.categories))},e}();function aW(e){return eI(e)&&null!=e.value?e.value:e+""}var rW=function(e){function t(t){var n=e.call(this,t)||this;n.type="ordinal";var i=n.getSetting("ordinalMeta");return i||(i=new iW({})),KC(i)&&(i=new iW({categories:UC(i,function(e){return eI(e)?e.value:e})})),n._ordinalMeta=i,n._extent=n.getSetting("extent")||[0,i.categories.length-1],n}return uC(t,e),t.prototype.parse=function(e){return null==e?NaN:YC(e)?this._ordinalMeta.getOrdinal(e):Math.round(e)},t.prototype.contain=function(e){return ZH(e,this._extent)&&e>=0&&e<this._ordinalMeta.categories.length},t.prototype.normalize=function(e){return e=this._getTickNumber(e),this._calculator.normalize(e,this._extent)},t.prototype.scale=function(e){return e=Math.round(this._calculator.scale(e,this._extent)),this.getRawOrdinalNumber(e)},t.prototype.getTicks=function(){for(var e=[],t=this._extent,n=t[0];n<=t[1];)e.push({value:n}),n++;return e},t.prototype.getMinorTicks=function(e){},t.prototype.setSortInfo=function(e){if(null!=e){for(var t=e.ordinalNumbers,n=this._ordinalNumbersByTick=[],i=this._ticksByOrdinalNumber=[],a=0,r=this._ordinalMeta.categories.length,s=Math.min(r,t.length);a<s;++a){var o=t[a];n[a]=o,i[o]=a}for(var l=0;a<r;++a){for(;null!=i[l];)l++;n.push(l),i[l]=a}}else this._ordinalNumbersByTick=this._ticksByOrdinalNumber=null},t.prototype._getTickNumber=function(e){var t=this._ticksByOrdinalNumber;return t&&e>=0&&e<t.length?t[e]:e},t.prototype.getRawOrdinalNumber=function(e){var t=this._ordinalNumbersByTick;return t&&e>=0&&e<t.length?t[e]:e},t.prototype.getLabel=function(e){if(!this.isBlank()){var t=this.getRawOrdinalNumber(e.value),n=this._ordinalMeta.categories[t];return null==n?"":n+""}},t.prototype.count=function(){return this._extent[1]-this._extent[0]+1},t.prototype.isInExtentRange=function(e){return e=this._getTickNumber(e),this._extent[0]<=e&&this._extent[1]>=e},t.prototype.getOrdinalMeta=function(){return this._ordinalMeta},t.prototype.calcNiceTicks=function(){},t.prototype.calcNiceExtent=function(){},t.type="ordinal",t}(tW);tW.registerClass(rW);var sW=iE,oW=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="interval",t._interval=0,t._intervalPrecision=2,t}return uC(t,e),t.prototype.parse=function(e){return null==e||""===e?NaN:Number(e)},t.prototype.contain=function(e){return ZH(e,this._extent)},t.prototype.normalize=function(e){return this._calculator.normalize(e,this._extent)},t.prototype.scale=function(e){return this._calculator.scale(e,this._extent)},t.prototype.getInterval=function(){return this._interval},t.prototype.setInterval=function(e){this._interval=e,this._niceExtent=this._extent.slice(),this._intervalPrecision=QH(e)},t.prototype.getTicks=function(e){e=e||{};var t=this._interval,n=this._extent,i=this._niceExtent,a=this._intervalPrecision,r=[];if(!t)return r;e.breakTicks;n[0]<i[0]&&(e.expandToNicedExtent?r.push({value:sW(i[0]-t,a)}):r.push({value:n[0]}));for(var s=function(e,n){return Math.round((n-e)/t)},o=i[0];o<=i[1];){if(r.push({value:o}),o=sW(o+t,a),this._brkCtx){var l=this._brkCtx.calcNiceTickMultiple(o,s);l>=0&&(o=sW(o+l*t,a))}if(r.length>0&&o===r[r.length-1].value)break;if(r.length>1e4)return[]}var c=r.length?r[r.length-1].value:i[1];return n[1]>c&&(e.expandToNicedExtent?r.push({value:sW(c+t,a)}):r.push({value:n[1]})),e.breakTicks,r},t.prototype.getMinorTicks=function(e){for(var t=this.getTicks({expandToNicedExtent:!0}),n=[],i=this.getExtent(),a=1;a<t.length;a++){var r=t[a],s=t[a-1];if(!s.break&&!r.break){for(var o=0,l=[],c=(r.value-s.value)/e,d=QH(c);o<e-1;){var u=sW(s.value+(o+1)*c,d);u>i[0]&&u<i[1]&&l.push(u),o++}var h=YL();h&&h.pruneTicksByBreak("auto",l,this._getNonTransBreaks(),function(e){return e},this._interval,i),n.push(l)}}return n},t.prototype._getNonTransBreaks=function(){return this._brkCtx?this._brkCtx.breaks:[]},t.prototype.getLabel=function(e,t){if(null==e)return"";var n=t&&t.precision;return null==n?n=rE(e.value)||0:"auto"===n&&(n=this._intervalPrecision),AN(sW(e.value,n,!0))},t.prototype.calcNiceTicks=function(e,t,n){e=e||5;var i=this._extent.slice(),a=this._getExtentSpanWithBreaks();if(isFinite(a)){a<0&&(a=-a,i.reverse(),this._innerSetExtent(i[0],i[1]),i=this._extent.slice());var r=WH(i,a,e,t,n);this._intervalPrecision=r.intervalPrecision,this._interval=r.interval,this._niceExtent=r.niceTickExtent}},t.prototype.calcNiceExtent=function(e){var t=this._extent.slice();if(t[0]===t[1])if(0!==t[0]){var n=Math.abs(t[0]);e.fixMax||(t[1]+=n/2),t[0]-=n/2}else t[1]=1;var i=t[1]-t[0];isFinite(i)||(t[0]=0,t[1]=1),this._innerSetExtent(t[0],t[1]),t=this._extent.slice(),this.calcNiceTicks(e.splitNumber,e.minInterval,e.maxInterval);var a=this._interval,r=this._intervalPrecision;e.fixMin||(t[0]=sW(Math.floor(t[0]/a)*a,r)),e.fixMax||(t[1]=sW(Math.ceil(t[1]/a)*a,r)),this._innerSetExtent(t[0],t[1])},t.prototype.setNiceExtent=function(e,t){this._niceExtent=[e,t]},t.type="interval",t}(tW);tW.registerClass(oW);var lW="undefined"!=typeof Float32Array,cW=lW?Float32Array:Array;function dW(e){return KC(e)?lW?new Float32Array(e):e:new cW(e)}function uW(e){return e.get("stack")||"__ec_stack_"+e.seriesIndex}function hW(e){return e.dim+e.index}function pW(e,t){var n=[];return t.eachSeriesByType(e,function(e){fW(e)&&n.push(e)}),n}function gW(e){var t=function(e){var t={};jC(e,function(e){var n=e.coordinateSystem.getBaseAxis();if("time"===n.type||"value"===n.type)for(var i=e.getData(),a=n.dim+"_"+n.index,r=i.getDimensionIndex(i.mapDimension(n.dim)),s=i.getStore(),o=0,l=s.count();o<l;++o){var c=s.get(r,o);t[a]?t[a].push(c):t[a]=[c]}});var n={};for(var i in t)if(t.hasOwnProperty(i)){var a=t[i];if(a){a.sort(function(e,t){return e-t});for(var r=null,s=1;s<a.length;++s){var o=a[s]-a[s-1];o>0&&(r=null===r?o:Math.min(r,o))}n[i]=r}}return n}(e),n=[];return jC(e,function(e){var i,a=e.coordinateSystem.getBaseAxis(),r=a.getExtent();if("category"===a.type)i=a.getBandWidth();else if("value"===a.type||"time"===a.type){var s=a.dim+"_"+a.index,o=t[s],l=Math.abs(r[1]-r[0]),c=a.scale.getExtent(),d=Math.abs(c[1]-c[0]);i=o?l/d*o:l}else{var u=e.getData();i=Math.abs(r[1]-r[0])/u.count()}var h=tE(e.get("barWidth"),i),p=tE(e.get("barMaxWidth"),i),g=tE(e.get("barMinWidth")||(mW(e)?.5:1),i),v=e.get("barGap"),f=e.get("barCategoryGap"),m=e.get("defaultBarGap");n.push({bandWidth:i,barWidth:h,barMaxWidth:p,barMinWidth:g,barGap:v,barCategoryGap:f,defaultBarGap:m,axisKey:hW(a),stackId:uW(e)})}),function(e){var t={};jC(e,function(e,n){var i=e.axisKey,a=e.bandWidth,r=t[i]||{bandWidth:a,remainedWidth:a,autoWidthCount:0,categoryGap:null,gap:e.defaultBarGap||0,stacks:{}},s=r.stacks;t[i]=r;var o=e.stackId;s[o]||r.autoWidthCount++,s[o]=s[o]||{width:0,maxWidth:0};var l=e.barWidth;l&&!s[o].width&&(s[o].width=l,l=Math.min(r.remainedWidth,l),r.remainedWidth-=l);var c=e.barMaxWidth;c&&(s[o].maxWidth=c);var d=e.barMinWidth;d&&(s[o].minWidth=d);var u=e.barGap;null!=u&&(r.gap=u);var h=e.barCategoryGap;null!=h&&(r.categoryGap=h)});var n={};return jC(t,function(e,t){n[t]={};var i=e.stacks,a=e.bandWidth,r=e.categoryGap;if(null==r){var s=WC(i).length;r=Math.max(35-4*s,15)+"%"}var o=tE(r,a),l=tE(e.gap,1),c=e.remainedWidth,d=e.autoWidthCount,u=(c-o)/(d+(d-1)*l);u=Math.max(u,0),jC(i,function(e){var t=e.maxWidth,n=e.minWidth;if(e.width){i=e.width;t&&(i=Math.min(i,t)),n&&(i=Math.max(i,n)),e.width=i,c-=i+l*i,d--}else{var i=u;t&&t<i&&(i=Math.min(t,c)),n&&n>i&&(i=n),i!==u&&(e.width=i,c-=i+l*i,d--)}}),u=(c-o)/(d+(d-1)*l),u=Math.max(u,0);var h,p=0;jC(i,function(e,t){e.width||(e.width=u),h=e,p+=e.width*(1+l)}),h&&(p-=h.width*l);var g=-p/2;jC(i,function(e,i){n[t][i]=n[t][i]||{bandWidth:a,offset:g,width:e.width},g+=e.width*(1+l)})}),n}(n)}function vW(e,t){var n=pW(e,t),i=gW(n);jC(n,function(e){var t=e.getData(),n=e.coordinateSystem.getBaseAxis(),a=uW(e),r=i[hW(n)][a],s=r.offset,o=r.width;t.setLayout({bandWidth:r.bandWidth,offset:s,size:o})})}function fW(e){return e.coordinateSystem&&"cartesian2d"===e.coordinateSystem.type}function mW(e){return e.pipelineContext&&e.pipelineContext.large}var yW=function(e){function t(t){var n=e.call(this,t)||this;return n.type="time",n}return uC(t,e),t.prototype.getLabel=function(e){var t=this.getSetting("useUTC");return pN(e.value,sN[function(e){switch(e){case"year":case"month":return"day";case"millisecond":return"millisecond";default:return"second"}}(uN(this._minLevelUnit))]||sN.second,t,this.getSetting("locale"))},t.prototype.getFormattedLabel=function(e,t,n){var i=this.getSetting("useUTC");return function(e,t,n,i,a){var r=null;if(YC(n))r=n;else if(ZC(n)){var s={time:e.time,level:e.time.level},o=null;o&&o.makeAxisLabelFormatterParamBreak(s,e.break),r=n(e.value,t,s)}else{var l=e.time;if(l){var c=n[l.lowerTimeUnit][l.upperTimeUnit];r=c[Math.min(l.level,c.length-1)]||""}else{var d=gN(e.value,a);r=n[d][d][0]}}return pN(new Date(e.value),r,a,i)}(e,t,n,this.getSetting("locale"),i)},t.prototype.getTicks=function(e){var t=this._interval,n=this._extent,i=[];if(!t)return i;var a=this.getSetting("useUTC"),r=gN(n[1],a);i.push({value:n[0],time:{level:0,upperTimeUnit:r,lowerTimeUnit:r}});var s=function(e,t,n,i,a,r){var s=1e4,o=lN,l=0;function c(e,t,n,a,o,c,d){for(var u=function(e,t){var n=new Date(0);n[e](1);var i=n.getTime();n[e](1+t);var a=n.getTime()-i;return function(e,t){return Math.max(0,Math.round((t-e)/a))}}(o,e),h=t,p=new Date(h);h<n&&h<=i[1]&&(d.push({value:h}),!(l++>s));)if(p[o](p[a]()+e),h=p.getTime(),r){var g=r.calcNiceTickMultiple(h,u);g>0&&(p[o](p[a]()+g*e),h=p.getTime())}d.push({value:h,notAdd:!0})}function d(e,a,r){var s=[],o=!a.length;if(!function(e,t,n,i){return vN(new Date(t),e,i).getTime()===vN(new Date(n),e,i).getTime()}(uN(e),i[0],i[1],n)){o&&(a=[{value:CW(i[0],e,n)},{value:i[1]}]);for(var l=0;l<a.length-1;l++){var d=a[l].value,u=a[l+1].value;if(d!==u){var h=void 0,p=void 0,g=void 0,v=!1;switch(e){case"year":h=Math.max(1,Math.round(t/tN/365)),p=fN(n),g=xN(n);break;case"half-year":case"quarter":case"month":h=kW(t),p=mN(n),g=_N(n);break;case"week":case"half-week":case"day":h=wW(t),p=yN(n),g=CN(n),v=!0;break;case"half-day":case"quarter-day":case"hour":h=SW(t),p=bN(n),g=IN(n);break;case"minute":h=xW(t,!0),p=wN(n),g=DN(n);break;case"second":h=xW(t,!1),p=kN(n),g=TN(n);break;case"millisecond":h=_W(t),p=SN(n),g=MN(n)}u>=i[0]&&d<=i[1]&&c(h,d,u,p,g,v,s),"year"===e&&r.length>1&&0===l&&r.unshift({value:r[0].value-h})}}for(l=0;l<s.length;l++)r.push(s[l])}}for(var u=[],h=[],p=0,g=0,v=0;v<o.length;++v){var f=uN(o[v]);if(hN(o[v]))if(d(o[v],u[u.length-1]||[],h),f!==(o[v+1]?uN(o[v+1]):null)){if(h.length){g=p,h.sort(function(e,t){return e.value-t.value});for(var m=[],y=0;y<h.length;++y){var b=h[y].value;0!==y&&h[y-1].value===b||(m.push(h[y]),b>=i[0]&&b<=i[1]&&p++)}var w=a/t;if(p>1.5*w&&g>w/1.5)break;if(u.push(m),p>w||e===o[v])break}h=[]}}var k=qC(UC(u,function(e){return qC(e,function(e){return e.value>=i[0]&&e.value<=i[1]&&!e.notAdd})}),function(e){return e.length>0}),S=[],x=k.length-1;for(v=0;v<k.length;++v)for(var _=k[v],C=0;C<_.length;++C){var I=gN(_[C].value,n);S.push({value:_[C].value,time:{level:x-v,upperTimeUnit:I,lowerTimeUnit:I}})}S.sort(function(e,t){return e.value-t.value});var D=[];for(v=0;v<S.length;++v)0!==v&&S[v].value===S[v-1].value||D.push(S[v]);return D}(this._minLevelUnit,this._approxInterval,a,n,this._getExtentSpanWithBreaks(),this._brkCtx);i=i.concat(s);var o=gN(n[1],a);i.push({value:n[1],time:{level:0,upperTimeUnit:o,lowerTimeUnit:o}}),this.getSetting("useUTC");var l=oN.length-1,c=0;return jC(i,function(e){l=Math.min(l,LC(oN,e.time.upperTimeUnit)),c=Math.max(c,e.time.level)}),i},t.prototype.calcNiceExtent=function(e){var t=this.getExtent();if(t[0]===t[1]&&(t[0]-=tN,t[1]+=tN),t[1]===-1/0&&t[0]===1/0){var n=new Date;t[1]=+new Date(n.getFullYear(),n.getMonth(),n.getDate()),t[0]=t[1]-tN}this._innerSetExtent(t[0],t[1]),this.calcNiceTicks(e.splitNumber,e.minInterval,e.maxInterval)},t.prototype.calcNiceTicks=function(e,t,n){e=e||10;var i=this._getExtentSpanWithBreaks();this._approxInterval=i/e,null!=t&&this._approxInterval<t&&(this._approxInterval=t),null!=n&&this._approxInterval>n&&(this._approxInterval=n);var a=bW.length,r=Math.min(function(e,t,n,i){for(;n<i;){var a=n+i>>>1;e[a][1]<t?n=a+1:i=a}return n}(bW,this._approxInterval,0,a),a-1);this._interval=bW[r][1],this._intervalPrecision=QH(this._interval),this._minLevelUnit=bW[Math.max(r-1,0)][0]},t.prototype.parse=function(e){return JC(e)?e:+pE(e)},t.prototype.contain=function(e){return ZH(e,this._extent)},t.prototype.normalize=function(e){return this._calculator.normalize(e,this._extent)},t.prototype.scale=function(e){return this._calculator.scale(e,this._extent)},t.type="time",t}(oW),bW=[["second",XL],["minute",JL],["hour",eN],["quarter-day",216e5],["half-day",432e5],["day",10368e4],["half-week",3024e5],["week",6048e5],["month",26784e5],["quarter",8208e6],["half-year",nN/2],["year",nN]];function wW(e,t){return(e/=tN)>16?16:e>7.5?7:e>3.5?4:e>1.5?2:1}function kW(e){return(e/=2592e6)>6?6:e>3?3:e>2?2:1}function SW(e){return(e/=eN)>12?12:e>6?6:e>3.5?4:e>2?2:1}function xW(e,t){return(e/=t?JL:XL)>30?30:e>20?20:e>15?15:e>10?10:e>5?5:e>2?2:1}function _W(e){return fE(e,!0)}function CW(e,t,n){var i=Math.max(0,LC(oN,t)-1);return vN(new Date(e),oN[i],n).getTime()}tW.registerClass(yW);var IW=iE,DW=Math.floor,TW=Math.ceil,MW=Math.pow,AW=Math.log,EW=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="log",t.base=10,t._originalScale=new oW,t}return uC(t,e),t.prototype.getTicks=function(t){t=t||{};var n=this._extent.slice(),i=this._originalScale.getExtent(),a=e.prototype.getTicks.call(this,t),r=this.base;return this._originalScale._innerGetBreaks(),UC(a,function(e){var t=e.value,a=null,s=MW(r,t);return t===n[0]&&this._fixMin?a=i[0]:t===n[1]&&this._fixMax&&(a=i[1]),null!=a&&(s=zW(s,a)),{value:s,break:undefined}},this)},t.prototype._getNonTransBreaks=function(){return this._originalScale._innerGetBreaks()},t.prototype.setExtent=function(t,n){this._originalScale.setExtent(t,n);var i=eW(this.base,[t,n]);e.prototype.setExtent.call(this,i[0],i[1])},t.prototype.getExtent=function(){var t=this.base,n=e.prototype.getExtent.call(this);n[0]=MW(t,n[0]),n[1]=MW(t,n[1]);var i=this._originalScale.getExtent();return this._fixMin&&(n[0]=zW(n[0],i[0])),this._fixMax&&(n[1]=zW(n[1],i[1])),n},t.prototype.unionExtentFromData=function(e,t){this._originalScale.unionExtentFromData(e,t);var n=eW(this.base,e.getApproximateExtent(t),!0);this._innerUnionExtent(n)},t.prototype.calcNiceTicks=function(e){e=e||10;var t=this._extent.slice(),n=this._getExtentSpanWithBreaks();if(isFinite(n)&&!(n<=0)){var i=gE(n);for(e/n*i<=.5&&(i*=10);!isNaN(i)&&Math.abs(i)<1&&Math.abs(i)>0;)i*=10;var a=[IW(TW(t[0]/i)*i),IW(DW(t[1]/i)*i)];this._interval=i,this._intervalPrecision=QH(i),this._niceExtent=a}},t.prototype.calcNiceExtent=function(t){e.prototype.calcNiceExtent.call(this,t),this._fixMin=t.fixMin,this._fixMax=t.fixMax},t.prototype.contain=function(t){return t=AW(t)/AW(this.base),e.prototype.contain.call(this,t)},t.prototype.normalize=function(t){return t=AW(t)/AW(this.base),e.prototype.normalize.call(this,t)},t.prototype.scale=function(t){return t=e.prototype.scale.call(this,t),MW(this.base,t)},t.prototype.setBreaksFromOption=function(e){},t.type="log",t}(oW);function zW(e,t){return IW(e,rE(t))}tW.registerClass(EW);var PW=function(){function e(e,t,n){this._prepareParams(e,t,n)}return e.prototype._prepareParams=function(e,t,n){n[1]<n[0]&&(n=[NaN,NaN]),this._dataMin=n[0],this._dataMax=n[1];var i=this._isOrdinal="ordinal"===e.type;this._needCrossZero="interval"===e.type&&t.getNeedCrossZero&&t.getNeedCrossZero();var a=t.get("min",!0);null==a&&(a=t.get("startValue",!0));var r=this._modelMinRaw=a;ZC(r)?this._modelMinNum=LW(e,r({min:n[0],max:n[1]})):"dataMin"!==r&&(this._modelMinNum=LW(e,r));var s=this._modelMaxRaw=t.get("max",!0);if(ZC(s)?this._modelMaxNum=LW(e,s({min:n[0],max:n[1]})):"dataMax"!==s&&(this._modelMaxNum=LW(e,s)),i)this._axisDataLen=t.getCategories().length;else{var o=t.get("boundaryGap"),l=KC(o)?o:[o||0,o||0];"boolean"==typeof l[0]||"boolean"==typeof l[1]?this._boundaryGapInner=[0,0]:this._boundaryGapInner=[TA(l[0],1),TA(l[1],1)]}},e.prototype.calculate=function(){var e=this._isOrdinal,t=this._dataMin,n=this._dataMax,i=this._axisDataLen,a=this._boundaryGapInner,r=e?null:n-t||Math.abs(t),s="dataMin"===this._modelMinRaw?t:this._modelMinNum,o="dataMax"===this._modelMaxRaw?n:this._modelMaxNum,l=null!=s,c=null!=o;null==s&&(s=e?i?0:NaN:t-a[0]*r),null==o&&(o=e?i?i-1:NaN:n+a[1]*r),(null==s||!isFinite(s))&&(s=NaN),(null==o||!isFinite(o))&&(o=NaN);var d=oI(s)||oI(o)||e&&!i;this._needCrossZero&&(s>0&&o>0&&!l&&(s=0),s<0&&o<0&&!c&&(o=0));var u=this._determinedMin,h=this._determinedMax;return null!=u&&(s=u,l=!0),null!=h&&(o=h,c=!0),{min:s,max:o,minFixed:l,maxFixed:c,isBlank:d}},e.prototype.modifyDataMinMax=function(e,t){this[$W[e]]=t},e.prototype.setDeterminedMinMax=function(e,t){this[RW[e]]=t},e.prototype.freeze=function(){this.frozen=!0},e}(),RW={min:"_determinedMin",max:"_determinedMax"},$W={min:"_dataMin",max:"_dataMax"};function OW(e,t,n){var i=e.rawExtentInfo;return i||(i=new PW(e,t,n),e.rawExtentInfo=i,i)}function LW(e,t){return null==t?null:oI(t)?NaN:e.parse(t)}function NW(e,t){var n=e.type,i=OW(e,t,e.getExtent()).calculate();e.setBlank(i.isBlank);var a=i.min,r=i.max,s=t.ecModel;if(s&&"time"===n){var o=pW("bar",s),l=!1;if(jC(o,function(e){l=l||e.getBaseAxis()===t.axis}),l){var c=gW(o),d=function(e,t,n,i){var a=n.axis.getExtent(),r=Math.abs(a[1]-a[0]),s=function(e,t){if(e&&t)return e[hW(t)]}(i,n.axis);if(void 0===s)return{min:e,max:t};var o=1/0;jC(s,function(e){o=Math.min(e.offset,o)});var l=-1/0;jC(s,function(e){l=Math.max(e.offset+e.width,l)}),o=Math.abs(o),l=Math.abs(l);var c=o+l,d=t-e,u=d/(1-(o+l)/r)-d;return t+=u*(l/c),e-=u*(o/c),{min:e,max:t}}(a,r,t,c);a=d.min,r=d.max}}return{extent:[a,r],fixMin:i.minFixed,fixMax:i.maxFixed}}function FW(e,t){var n=t,i=NW(e,n),a=i.extent,r=n.get("splitNumber");e instanceof EW&&(e.base=n.get("logBase"));var s=e.type,o=n.get("interval"),l="interval"===s||"time"===s;e.setBreaksFromOption(QW(n)),e.setExtent(a[0],a[1]),e.calcNiceExtent({splitNumber:r,fixMin:i.fixMin,fixMax:i.fixMax,minInterval:l?n.get("minInterval"):null,maxInterval:l?n.get("maxInterval"):null}),null!=o&&e.setInterval&&e.setInterval(o)}function BW(e,t){if(t=t||e.get("type"))switch(t){case"category":return new rW({ordinalMeta:e.getOrdinalMeta?e.getOrdinalMeta():e.getCategories(),extent:[1/0,-1/0]});case"time":return new yW({locale:e.ecModel.getLocaleModel(),useUTC:e.ecModel.get("useUTC")});default:return new(tW.getClass(t)||oW)}}function jW(e){var t=e.getLabelModel().get("formatter");if("time"===e.type){var n=cN(t);return function(t,i){return e.scale.getFormattedLabel(t,i,n)}}if(YC(t))return function(n){var i=e.scale.getLabel(n);return t.replace("{value}",null!=i?i:"")};if(ZC(t)){if("category"===e.type)return function(n,i){return t(UW(e,n),n.value-e.scale.getExtent()[0],null)};var i=null;return function(n,a){var r=null;return i&&(r=i.makeAxisLabelFormatterParamBreak(r,n.break)),t(UW(e,n),a,r)}}return function(t){return e.scale.getLabel(t)}}function UW(e,t){return"category"===e.type?e.scale.getLabel(t):t.value}function VW(e){var t=e.get("interval");return null==t?"auto":t}function qW(e){return"category"===e.type&&0===VW(e.getLabelModel())}function HW(e,t){var n={};return jC(e.mapDimensionsAll(t),function(t){n[VH(e,t)]=!0}),WC(n)}function WW(e){return"middle"===e||"center"===e}function GW(e){return e.getShallow("show")}function QW(e){e.get("breaks",!0)}var KW=function(){function e(){}return e.prototype.getNeedCrossZero=function(){return!this.option.scale},e.prototype.getCoordSysModel=function(){},e}();var ZW={isDimensionStacked:UH,enableDataStack:jH,getStackedDimension:VH};const YW=Object.freeze(Object.defineProperty({__proto__:null,createDimensions:function(e,t){return OH(e,t).dimensions},createList:function(e){return qH(0,e)},createScale:function(e,t){var n=t;t instanceof BL||(n=new BL(t));var i=BW(n);return i.setExtent(e[0],e[1]),FW(i,n),i},createSymbol:vV,createTextStyle:function(e,t){return bL(e,null,null,"normal"!==(t=t||{}).state)},dataStack:ZW,enableHoverEmphasis:XR,getECData:uR,getLayoutRect:nF,mixinAxisModelCommonMethods:function(e){FC(e,KW)}},Symbol.toStringTag,{value:"Module"}));var XW=[],JW={registerPreprocessor:Kq,registerProcessor:Zq,registerPostInit:Yq,registerPostUpdate:Xq,registerUpdateLifecycle:Jq,registerAction:eH,registerCoordinateSystem:tH,registerLayout:nH,registerVisual:iH,registerTransform:lH,registerLoading:sH,registerMap:oH,registerImpl:function(e,t){GV[e]=t},PRIORITY:YV,ComponentModel:dF,ComponentView:nU,SeriesModel:Qj,ChartView:sU,registerComponentModel:function(e){dF.registerClass(e)},registerComponentView:function(e){nU.registerClass(e)},registerSeriesModel:function(e){Qj.registerClass(e)},registerChartView:function(e){sU.registerClass(e)},registerCustomSeries:function(e,t){},registerSubTypeDefaulter:function(e,t){dF.registerSubTypeDefaulter(e,t)},registerPainter:function(e,t){GA(e,t)}};function eG(e){KC(e)?jC(e,function(e){eG(e)}):LC(XW,e)>=0||(XW.push(e),ZC(e)&&(e={install:e}),e.install(JW))}function tG(e,t){return Math.abs(e-t)<1e-8}function nG(e,t,n){var i=0,a=e[0];if(!a)return!1;for(var r=1;r<e.length;r++){var s=e[r];i+=_P(a[0],a[1],s[0],s[1],t,n),a=s}var o=e[0];return tG(a[0],o[0])&&tG(a[1],o[1])||(i+=_P(a[0],a[1],o[0],o[1],t,n)),0!==i}var iG=[];function aG(e,t){for(var n=0;n<e.length;n++)GI(e[n],e[n],t)}function rG(e,t,n,i){for(var a=0;a<e.length;a++){var r=e[a];i&&(r=i.project(r)),r&&isFinite(r[0])&&isFinite(r[1])&&(QI(t,t,r),KI(n,n,r))}}var sG=function(){function e(e){this.name=e}return e.prototype.setCenter=function(e){this._center=e},e.prototype.getCenter=function(){var e=this._center;return e||(e=this._center=this.calcCenter()),e},e}(),oG=function(){return function(e,t){this.type="polygon",this.exterior=e,this.interiors=t}}(),lG=function(){return function(e){this.type="linestring",this.points=e}}(),cG=function(e){function t(t,n,i){var a=e.call(this,t)||this;return a.type="geoJSON",a.geometries=n,a._center=i&&[i[0],i[1]],a}return uC(t,e),t.prototype.calcCenter=function(){for(var e,t=this.geometries,n=0,i=0;i<t.length;i++){var a=t[i],r=a.exterior,s=r&&r.length;s>n&&(e=a,n=s)}if(e)return function(e){for(var t=0,n=0,i=0,a=e.length,r=e[a-1][0],s=e[a-1][1],o=0;o<a;o++){var l=e[o][0],c=e[o][1],d=r*c-l*s;t+=d,n+=(r+l)*d,i+=(s+c)*d,r=l,s=c}return t?[n/t/3,i/t/3,t]:[e[0][0]||0,e[0][1]||0]}(e.exterior);var o=this.getBoundingRect();return[o.x+o.width/2,o.y+o.height/2]},t.prototype.getBoundingRect=function(e){var t=this._rect;if(t&&!e)return t;var n=[1/0,1/0],i=[-1/0,-1/0];return jC(this.geometries,function(t){"polygon"===t.type?rG(t.exterior,n,i,e):jC(t.points,function(t){rG(t,n,i,e)})}),isFinite(n[0])&&isFinite(n[1])&&isFinite(i[0])&&isFinite(i[1])||(n[0]=n[1]=i[0]=i[1]=0),t=new GD(n[0],n[1],i[0]-n[0],i[1]-n[1]),e||(this._rect=t),t},t.prototype.contain=function(e){var t=this.getBoundingRect(),n=this.geometries;if(!t.contain(e[0],e[1]))return!1;e:for(var i=0,a=n.length;i<a;i++){var r=n[i];if("polygon"===r.type){var s=r.exterior,o=r.interiors;if(nG(s,e[0],e[1])){for(var l=0;l<(o?o.length:0);l++)if(nG(o[l],e[0],e[1]))continue e;return!0}}}return!1},t.prototype.transformTo=function(e,t,n,i){var a=this.getBoundingRect(),r=a.width/a.height;n?i||(i=n/r):n=r*i;for(var s=new GD(e,t,n,i),o=a.calculateTransform(s),l=this.geometries,c=0;c<l.length;c++){var d=l[c];"polygon"===d.type?(aG(d.exterior,o),jC(d.interiors,function(e){aG(e,o)})):jC(d.points,function(e){aG(e,o)})}(a=this._rect).copy(s),this._center=[a.x+a.width/2,a.y+a.height/2]},t.prototype.cloneShallow=function(e){null==e&&(e=this.name);var n=new t(e,this.geometries,this._center);return n._rect=this._rect,n.transformTo=null,n},t}(sG);function dG(e,t,n){for(var i=0;i<e.length;i++)e[i]=uG(e[i],t[i],n)}function uG(e,t,n){for(var i=[],a=t[0],r=t[1],s=0;s<e.length;s+=2){var o=e.charCodeAt(s)-64,l=e.charCodeAt(s+1)-64;o=o>>1^-(1&o),l=l>>1^-(1&l),a=o+=a,r=l+=r,i.push([o/n,l/n])}return i}function hG(e,t){return UC(qC((e=function(e){if(!e.UTF8Encoding)return e;var t=e,n=t.UTF8Scale;return null==n&&(n=1024),jC(t.features,function(e){var t=e.geometry,i=t.encodeOffsets,a=t.coordinates;if(i)switch(t.type){case"LineString":t.coordinates=uG(a,i,n);break;case"Polygon":case"MultiLineString":dG(a,i,n);break;case"MultiPolygon":jC(a,function(e,t){return dG(e,i[t],n)})}}),t.UTF8Encoding=!1,t}(e)).features,function(e){return e.geometry&&e.properties&&e.geometry.coordinates.length>0}),function(e){var n=e.properties,i=e.geometry,a=[];switch(i.type){case"Polygon":var r=i.coordinates;a.push(new oG(r[0],r.slice(1)));break;case"MultiPolygon":jC(i.coordinates,function(e){e[0]&&a.push(new oG(e[0],e.slice(1)))});break;case"LineString":a.push(new lG([i.coordinates]));break;case"MultiLineString":a.push(new lG(i.coordinates))}var s=new cG(n[t||"name"],a,n.cp);return s.properties=n,s})}!function(e){function t(t,n){var i=e.call(this,t)||this;return i.type="geoSVG",i._elOnlyForCalculate=n,i}uC(t,e),t.prototype.calcCenter=function(){for(var e=this._elOnlyForCalculate,t=e.getBoundingRect(),n=[t.x+t.width/2,t.y+t.height/2],i=CD(iG),a=e;a&&!a.isGeoSVGGraphicRoot;)DD(i,a.getLocalTransform(),i),a=a.parent;return ED(i,i),GI(n,n,i),n}}(sG);const pG=Object.freeze(Object.defineProperty({__proto__:null,MAX_SAFE_INTEGER:9007199254740991,asc:aE,getPercentWithPrecision:function(e,t,n){return e[t]&&lE(e,n)[t]||0},getPixelPrecision:oE,getPrecision:rE,getPrecisionSafe:sE,isNumeric:bE,isRadianAroundZero:uE,linearMap:eE,nice:fE,numericToNumber:yE,parseDate:pE,parsePercent:tE,quantile:function(e,t){var n=(e.length-1)*t+1,i=Math.floor(n),a=+e[i-1],r=n-i;return r?a+r*(e[i]-a):a},quantity:gE,quantityExponent:vE,reformIntervals:mE,remRadian:dE,round:iE},Symbol.toStringTag,{value:"Module"})),gG=Object.freeze(Object.defineProperty({__proto__:null,format:pN,parse:pE,roundTime:vN},Symbol.toStringTag,{value:"Module"})),vG=Object.freeze(Object.defineProperty({__proto__:null,Arc:aO,BezierCurve:nO,BoundingRect:GD,Circle:C$,CompoundPath:rO,Ellipse:D$,Group:jA,Image:UP,IncrementalDisplayable:bO,Line:X$,LinearGradient:oO,Polygon:G$,Polyline:K$,RadialGradient:lO,Rect:KP,Ring:q$,Sector:U$,Text:JP,clipPointsByRect:KO,clipRectByRect:ZO,createIcon:YO,extendPath:RO,extendShape:zO,getShapeClass:OO,getTransform:qO,initProps:xO,makeImage:NO,makePath:LO,mergePath:BO,registerShape:$O,resizePath:jO,updateProps:SO},Symbol.toStringTag,{value:"Module"})),fG=Object.freeze(Object.defineProperty({__proto__:null,addCommas:AN,capitalFirst:function(e){return e?e.charAt(0).toUpperCase()+e.substr(1):e},encodeHTML:cD,formatTime:function(e,t,n){"week"!==e&&"month"!==e&&"quarter"!==e&&"half-year"!==e&&"year"!==e||(e="MM-dd\nyyyy");var i=pE(t),a=n?"getUTC":"get",r=i[a+"FullYear"](),s=i[a+"Month"]()+1,o=i[a+"Date"](),l=i[a+"Hours"](),c=i[a+"Minutes"](),d=i[a+"Seconds"](),u=i[a+"Milliseconds"]();return e=e.replace("MM",dN(s,2)).replace("M",s).replace("yyyy",r).replace("yy",dN(r%100+"",2)).replace("dd",dN(o,2)).replace("d",o).replace("hh",dN(l,2)).replace("h",l).replace("mm",dN(c,2)).replace("m",c).replace("ss",dN(d,2)).replace("s",d).replace("SSS",dN(u,3))},formatTpl:ON,getTextRect:function(e,t,n,i,a,r,s,o){return new JP({style:{text:e,font:t,align:n,verticalAlign:i,padding:a,rich:r,overflow:s?"truncate":null,lineHeight:o}}).getBoundingRect()},getTooltipMarker:LN,normalizeCssArray:zN,toCamelCase:EN,truncateText:function(e,t,n,i,a){var r={};return pz(r,e,t,n,i,a),r.text}},Symbol.toStringTag,{value:"Module"})),mG=Object.freeze(Object.defineProperty({__proto__:null,bind:GC,clone:zC,curry:QC,defaults:$C,each:jC,extend:RC,filter:qC,indexOf:LC,inherits:NC,isArray:KC,isFunction:ZC,isObject:eI,isString:YC,map:UC,merge:PC,reduce:VC},Symbol.toStringTag,{value:"Module"}));var yG=BE(),bG=BE(),wG=1,kG=2;function SG(e){return{out:{noPxChangeTryDetermine:[]},kind:e}}function xG(e,t){var n=UC(t,function(t){return e.scale.parse(t)});return"time"===e.type&&n.length>0&&(n.sort(),n.unshift(n[0]),n.push(n[n.length-1])),n}function _G(e,t){var n=e.getLabelModel().get("customValues");if(n){var i=jW(e),a=e.scale.getExtent();return{labels:UC(qC(xG(e,n),function(e){return e>=a[0]&&e<=a[1]}),function(t){var n={value:t};return{formattedLabel:i(n),rawLabel:e.scale.getLabel(n),tickValue:t,time:void 0,break:void 0}})}}return"category"===e.type?function(e,t){var n=e.getLabelModel(),i=IG(e,n,t);return!n.get("show")||e.scale.isBlank()?{labels:[]}:i}(e,t):function(e){var t=e.scale.getTicks(),n=jW(e);return{labels:UC(t,function(t,i){return{formattedLabel:n(t,i),rawLabel:e.scale.getLabel(t),tickValue:t.value,time:t.time,break:t.break}})}}(e)}function CG(e,t,n){var i=e.getTickModel().get("customValues");if(i){var a=e.scale.getExtent();return{ticks:qC(xG(e,i),function(e){return e>=a[0]&&e<=a[1]})}}return"category"===e.type?function(e,t){var n,i,a=DG(e),r=VW(t),s=AG(a,r);if(s)return s;t.get("show")&&!e.scale.isBlank()||(n=[]);if(ZC(r))n=$G(e,r,!0);else if("auto"===r){var o=IG(e,e.getLabelModel(),SG(kG));i=o.labelCategoryInterval,n=UC(o.labels,function(e){return e.tickValue})}else n=RG(e,i=r,!0);return EG(a,r,{ticks:n,tickCategoryInterval:i})}(e,t):{ticks:UC(e.scale.getTicks(n),function(e){return e.value})}}function IG(e,t,n){var i,a,r=TG(e),s=VW(t),o=n.kind===wG;if(!o){var l=AG(r,s);if(l)return l}ZC(s)?i=$G(e,s):(a="auto"===s?function(e,t){if(t.kind===wG){var n=e.calculateCategoryInterval(t);return t.out.noPxChangeTryDetermine.push(function(){return bG(e).autoInterval=n,!0}),n}var i=bG(e).autoInterval;return null!=i?i:bG(e).autoInterval=e.calculateCategoryInterval(t)}(e,n):s,i=RG(e,a));var c={labels:i,labelCategoryInterval:a};return o?n.out.noPxChangeTryDetermine.push(function(){return EG(r,s,c),!0}):EG(r,s,c),c}var DG=MG("axisTick"),TG=MG("axisLabel");function MG(e){return function(t){return bG(t)[e]||(bG(t)[e]={list:[]})}}function AG(e,t){for(var n=0;n<e.list.length;n++)if(e.list[n].key===t)return e.list[n].value}function EG(e,t,n){return e.list.push({key:t,value:n}),n}function zG(e,t,n){return null==PG(e,t,n)}function PG(e,t,n){var i=yG(e.model),a=e.getExtent(),r=i.lastAutoInterval,s=i.lastTickCount;if(null!=r&&null!=s&&Math.abs(r-t)<=1&&Math.abs(s-n)<=1&&r>t&&i.axisExtent0===a[0]&&i.axisExtent1===a[1])return r;i.lastTickCount=n,i.lastAutoInterval=t,i.axisExtent0=a[0],i.axisExtent1=a[1]}function RG(e,t,n){var i=jW(e),a=e.scale,r=a.getExtent(),s=e.getLabelModel(),o=[],l=Math.max((t||0)+1,1),c=r[0],d=a.count();0!==c&&l>1&&d/l>2&&(c=Math.round(Math.ceil(c/l)*l));var u=qW(e),h=s.get("showMinLabel")||u,p=s.get("showMaxLabel")||u;h&&c!==r[0]&&v(r[0]);for(var g=c;g<=r[1];g+=l)v(g);function v(e){var t={value:e};o.push(n?e:{formattedLabel:i(t),rawLabel:a.getLabel(t),tickValue:e,time:void 0,break:void 0})}return p&&g-l!==r[1]&&v(r[1]),o}function $G(e,t,n){var i=e.scale,a=jW(e),r=[];return jC(i.getTicks(),function(e){var s=i.getLabel(e),o=e.value;t(e.value,s)&&r.push(n?o:{formattedLabel:a(e),rawLabel:s,tickValue:o,time:void 0,break:void 0})}),r}var OG=[0,1],LG=function(){function e(e,t,n){this.onBand=!1,this.inverse=!1,this.dim=e,this.scale=t,this._extent=n||[0,0]}return e.prototype.contain=function(e){var t=this._extent,n=Math.min(t[0],t[1]),i=Math.max(t[0],t[1]);return e>=n&&e<=i},e.prototype.containData=function(e){return this.scale.contain(this.scale.parse(e))},e.prototype.getExtent=function(){return this._extent.slice()},e.prototype.getPixelPrecision=function(e){return oE(e||this.scale.getExtent(),this._extent)},e.prototype.setExtent=function(e,t){var n=this._extent;n[0]=e,n[1]=t},e.prototype.dataToCoord=function(e,t){var n=this._extent,i=this.scale;return e=i.normalize(i.parse(e)),this.onBand&&"ordinal"===i.type&&NG(n=n.slice(),i.count()),eE(e,OG,n,t)},e.prototype.coordToData=function(e,t){var n=this._extent,i=this.scale;this.onBand&&"ordinal"===i.type&&NG(n=n.slice(),i.count());var a=eE(e,n,OG,t);return this.scale.scale(a)},e.prototype.pointToData=function(e,t){},e.prototype.getTicksCoords=function(e){var t=(e=e||{}).tickModel||this.getTickModel(),n=UC(CG(this,t,{breakTicks:e.breakTicks,pruneByBreak:e.pruneByBreak}).ticks,function(e){return{coord:this.dataToCoord("ordinal"===this.scale.type?this.scale.getRawOrdinalNumber(e):e),tickValue:e}},this);return function(e,t,n,i){var a=t.length;if(!e.onBand||n||!a)return;var r,s,o=e.getExtent();if(1===a)t[0].coord=o[0],t[0].onBand=!0,r=t[1]={coord:o[1],tickValue:t[0].tickValue,onBand:!0};else{var l=t[a-1].tickValue-t[0].tickValue,c=(t[a-1].coord-t[0].coord)/l;jC(t,function(e){e.coord-=c/2,e.onBand=!0});var d=e.scale.getExtent();s=1+d[1]-t[a-1].tickValue,r={coord:t[a-1].coord+c*s,tickValue:d[1]+1,onBand:!0},t.push(r)}var u=o[0]>o[1];h(t[0].coord,o[0])&&(i?t[0].coord=o[0]:t.shift());i&&h(o[0],t[0].coord)&&t.unshift({coord:o[0],onBand:!0});h(o[1],r.coord)&&(i?r.coord=o[1]:t.pop());i&&h(r.coord,o[1])&&t.push({coord:o[1],onBand:!0});function h(e,t){return e=iE(e),t=iE(t),u?e>t:e<t}}(this,n,t.get("alignWithLabel"),e.clamp),n},e.prototype.getMinorTicksCoords=function(){if("ordinal"===this.scale.type)return[];var e=this.model.getModel("minorTick").get("splitNumber");return e>0&&e<100||(e=5),UC(this.scale.getMinorTicks(e),function(e){return UC(e,function(e){return{coord:this.dataToCoord(e),tickValue:e}},this)},this)},e.prototype.getViewLabels=function(e){return _G(this,e=e||SG(kG)).labels},e.prototype.getLabelModel=function(){return this.model.getModel("axisLabel")},e.prototype.getTickModel=function(){return this.model.getModel("axisTick")},e.prototype.getBandWidth=function(){var e=this._extent,t=this.scale.getExtent(),n=t[1]-t[0]+(this.onBand?1:0);0===n&&(n=1);var i=Math.abs(e[1]-e[0]);return Math.abs(i)/n},e.prototype.calculateCategoryInterval=function(e){return function(e,t){var n=t.kind,i=function(e){var t=e.getLabelModel();return{axisRotate:e.getRotate?e.getRotate():e.isHorizontal&&!e.isHorizontal()?90:0,labelRotate:t.get("rotate")||0,font:t.getFont()}}(e),a=jW(e),r=(i.axisRotate-i.labelRotate)/180*Math.PI,s=e.scale,o=s.getExtent(),l=s.count();if(o[1]-o[0]<1)return 0;var c=1;l>40&&(c=Math.max(1,Math.floor(l/40)));for(var d=o[0],u=e.dataToCoord(d+1)-e.dataToCoord(d),h=Math.abs(u*Math.cos(r)),p=Math.abs(u*Math.sin(r)),g=0,v=0;d<=o[1];d+=c){var f,m,y=_A(a({value:d}),i.font,"center","top");f=1.3*y.width,m=1.3*y.height,g=Math.max(g,f,7),v=Math.max(v,m,7)}var b=g/h,w=v/p;isNaN(b)&&(b=1/0),isNaN(w)&&(w=1/0);var k=Math.max(0,Math.floor(Math.min(b,w)));if(n===wG)return t.out.noPxChangeTryDetermine.push(GC(zG,null,e,k,l)),k;var S=PG(e,k,l);return null!=S?S:k}(this,e=e||SG(kG))},e}();function NG(e,t){var n=(e[1]-e[0])/t/2;e[0]+=n,e[1]-=n}var FG=2*Math.PI,BG=fP.CMD,jG=["top","right","bottom","left"];function UG(e,t,n,i,a){var r=n.width,s=n.height;switch(e){case"top":i.set(n.x+r/2,n.y-t),a.set(0,-1);break;case"bottom":i.set(n.x+r/2,n.y+s+t),a.set(0,1);break;case"left":i.set(n.x-t,n.y+s/2),a.set(-1,0);break;case"right":i.set(n.x+r+t,n.y+s/2),a.set(1,0)}}function VG(e,t,n,i,a,r,s,o,l){s-=e,o-=t;var c=Math.sqrt(s*s+o*o),d=(s/=c)*n+e,u=(o/=c)*n+t;if(Math.abs(i-a)%FG<1e-4)return l[0]=d,l[1]=u,c-n;if(r){var h=i;i=kP(a),a=kP(h)}else i=kP(i),a=kP(a);i>a&&(a+=FG);var p=Math.atan2(o,s);if(p<0&&(p+=FG),p>=i&&p<=a||p+FG>=i&&p+FG<=a)return l[0]=d,l[1]=u,c-n;var g=n*Math.cos(i)+e,v=n*Math.sin(i)+t,f=n*Math.cos(a)+e,m=n*Math.sin(a)+t,y=(g-s)*(g-s)+(v-o)*(v-o),b=(f-s)*(f-s)+(m-o)*(m-o);return y<b?(l[0]=g,l[1]=v,Math.sqrt(y)):(l[0]=f,l[1]=m,Math.sqrt(b))}function qG(e,t,n,i,a,r,s,o){var l=a-e,c=r-t,d=n-e,u=i-t,h=Math.sqrt(d*d+u*u),p=(l*(d/=h)+c*(u/=h))/h;o&&(p=Math.min(Math.max(p,0),1)),p*=h;var g=s[0]=e+p*d,v=s[1]=t+p*u;return Math.sqrt((g-a)*(g-a)+(v-r)*(v-r))}function HG(e,t,n,i,a,r,s){n<0&&(e+=n,n=-n),i<0&&(t+=i,i=-i);var o=e+n,l=t+i,c=s[0]=Math.min(Math.max(a,e),o),d=s[1]=Math.min(Math.max(r,t),l);return Math.sqrt((c-a)*(c-a)+(d-r)*(d-r))}var WG=[];function GG(e,t,n){var i=HG(t.x,t.y,t.width,t.height,e.x,e.y,WG);return n.set(WG[0],WG[1]),i}function QG(e,t,n){for(var i,a,r=0,s=0,o=0,l=0,c=1/0,d=t.data,u=e.x,h=e.y,p=0;p<d.length;){var g=d[p++];1===p&&(o=r=d[p],l=s=d[p+1]);var v=c;switch(g){case BG.M:r=o=d[p++],s=l=d[p++];break;case BG.L:v=qG(r,s,d[p],d[p+1],u,h,WG,!0),r=d[p++],s=d[p++];break;case BG.C:v=OT(r,s,d[p++],d[p++],d[p++],d[p++],d[p],d[p+1],u,h,WG),r=d[p++],s=d[p++];break;case BG.Q:v=UT(r,s,d[p++],d[p++],d[p],d[p+1],u,h,WG),r=d[p++],s=d[p++];break;case BG.A:var f=d[p++],m=d[p++],y=d[p++],b=d[p++],w=d[p++],k=d[p++];p+=1;var S=!!(1-d[p++]);i=Math.cos(w)*y+f,a=Math.sin(w)*b+m,p<=1&&(o=i,l=a),v=VG(f,m,b,w,w+k,S,(u-f)*b/y+f,h,WG),r=Math.cos(w+k)*y+f,s=Math.sin(w+k)*b+m;break;case BG.R:v=HG(o=r=d[p++],l=s=d[p++],d[p++],d[p++],u,h,WG);break;case BG.Z:v=qG(r,s,o,l,u,h,WG,!0),r=o,s=l}v<c&&(c=v,n.set(WG[0],WG[1]))}return c}var KG=new PD,ZG=new PD,YG=new PD,XG=new PD,JG=new PD;function eQ(e,t){if(e){var n=e.getTextGuideLine(),i=e.getTextContent();if(i&&n){var a=e.textGuideLineConfig||{},r=[[0,0],[0,0],[0,0]],s=a.candidates||jG,o=i.getBoundingRect().clone();o.applyTransform(i.getComputedTransform());var l=1/0,c=a.anchor,d=e.getComputedTransform(),u=d&&ED([],d),h=t.get("length2")||0;c&&YG.copy(c);for(var p=0;p<s.length;p++){UG(s[p],0,o,KG,XG),PD.scaleAndAdd(ZG,KG,XG,h),ZG.transform(u);var g=e.getBoundingRect(),v=c?c.distance(ZG):e instanceof LP?QG(ZG,e.path,YG):GG(ZG,g,YG);v<l&&(l=v,ZG.transform(d),YG.transform(d),YG.toArray(r[0]),ZG.toArray(r[1]),KG.toArray(r[2]))}iQ(r,t.get("minTurnAngle")),n.setShape({points:r})}}}var tQ=[],nQ=new PD;function iQ(e,t){if(t<=180&&t>0){t=t/180*Math.PI,KG.fromArray(e[0]),ZG.fromArray(e[1]),YG.fromArray(e[2]),PD.sub(XG,KG,ZG),PD.sub(JG,YG,ZG);var n=XG.len(),i=JG.len();if(!(n<.001||i<.001)){XG.scale(1/n),JG.scale(1/i);var a=XG.dot(JG);if(Math.cos(t)<a){var r=qG(ZG.x,ZG.y,YG.x,YG.y,KG.x,KG.y,tQ,!1);nQ.fromArray(tQ),nQ.scaleAndAdd(JG,r/Math.tan(Math.PI-t));var s=YG.x!==ZG.x?(nQ.x-ZG.x)/(YG.x-ZG.x):(nQ.y-ZG.y)/(YG.y-ZG.y);if(isNaN(s))return;s<0?PD.copy(nQ,ZG):s>1&&PD.copy(nQ,YG),nQ.toArray(e[1])}}}}function aQ(e,t,n){if(n<=180&&n>0){n=n/180*Math.PI,KG.fromArray(e[0]),ZG.fromArray(e[1]),YG.fromArray(e[2]),PD.sub(XG,ZG,KG),PD.sub(JG,YG,ZG);var i=XG.len(),a=JG.len();if(!(i<.001||a<.001))if(XG.scale(1/i),JG.scale(1/a),XG.dot(t)<Math.cos(n)){var r=qG(ZG.x,ZG.y,YG.x,YG.y,KG.x,KG.y,tQ,!1);nQ.fromArray(tQ);var s=Math.PI/2,o=s+Math.acos(JG.dot(t))-n;if(o>=s)PD.copy(nQ,YG);else{nQ.scaleAndAdd(JG,r/Math.tan(Math.PI/2-o));var l=YG.x!==ZG.x?(nQ.x-ZG.x)/(YG.x-ZG.x):(nQ.y-ZG.y)/(YG.y-ZG.y);if(isNaN(l))return;l<0?PD.copy(nQ,ZG):l>1&&PD.copy(nQ,YG)}nQ.toArray(e[1])}}}function rQ(e,t,n,i){var a="normal"===n,r=a?e:e.ensureState(n);r.ignore=t;var s=i.get("smooth");s&&!0===s&&(s=.3),r.shape=r.shape||{},s>0&&(r.shape.smooth=s);var o=i.getModel("lineStyle").getLineStyle();a?e.useStyle(o):r.style=o}function sQ(e,t){var n=t.smooth,i=t.points;if(i)if(e.moveTo(i[0][0],i[0][1]),n>0&&i.length>=3){var a=VI(i[0],i[1]),r=VI(i[1],i[2]);if(!a||!r)return e.lineTo(i[1][0],i[1][1]),void e.lineTo(i[2][0],i[2][1]);var s=Math.min(a,r)*n,o=WI([],i[1],i[0],s/a),l=WI([],i[1],i[2],s/r),c=WI([],o,l,.5);e.bezierCurveTo(o[0],o[1],o[0],o[1],c[0],c[1]),e.bezierCurveTo(l[0],l[1],l[0],l[1],i[2][0],i[2][1])}else for(var d=1;d<i.length;d++)e.lineTo(i[d][0],i[d][1])}function oQ(e,t,n){var i=e.getTextGuideLine(),a=e.getTextContent();if(a){for(var r=t.normal,s=r.get("show"),o=a.ignore,l=0;l<mR.length;l++){var c=mR[l],d=t[c],u="normal"===c;if(d){var h=d.get("show");if((u?o:cI(a.states[c]&&a.states[c].ignore,o))||!cI(h,s)){var p=u?i:i&&i.states[c];p&&(p.ignore=!0),i&&rQ(i,!0,c,d);continue}i||(i=new K$,e.setTextGuideLine(i),u||!o&&s||rQ(i,!0,"normal",t.normal),e.stateProxy&&(i.stateProxy=e.stateProxy)),rQ(i,!1,c,d)}}if(i){$C(i.style,n),i.style.fill=null;var g=r.get("showAbove");(e.textGuideLineConfig=e.textGuideLineConfig||{}).showAbove=g||!1,i.buildPath=sQ}}else i&&e.removeTextGuideLine()}function lQ(e,t){t=t||"labelLine";for(var n={normal:e.getModel(t)},i=0;i<fR.length;i++){var a=fR[i];n[a]=e.getModel([a,t])}return n}var cQ=["label","labelLine","layoutOption","priority","defaultAttr","marginForce","minMarginForce","marginDefault","suggestIgnore"];function dQ(e,t,n){n=n||3,t?e.dirty|=n:e.dirty&=~n}function uQ(e,t){return t=t||3,null==e.dirty||!!(e.dirty&t)}function hQ(e){if(e)return uQ(e)&&pQ(e,e.label,e),e}function pQ(e,t,n){var i=t.getComputedTransform();e.transform=cL(e.transform,i);var a=e.localRect=lL(e.localRect,t.getBoundingRect()),r=t.style,s=r.margin,o=n&&n.marginForce,l=n&&n.minMarginForce,c=n&&n.marginDefault,d=r.__marginType;null==d&&c&&(s=c,d=ML.textMargin);for(var u=0;u<4;u++)gQ[u]=d===ML.minMargin&&l&&null!=l[u]?l[u]:o&&null!=o[u]?o[u]:s?s[u]:0;d===ML.textMargin&&eL(a,gQ,!1,!1);var h=e.rect=lL(e.rect,a);return i&&h.applyTransform(i),d===ML.minMargin&&eL(h,gQ,!1,!1),e.axisAligned=sL(i),(e.label=e.label||{}).ignore=t.ignore,dQ(e,!1),dQ(e,!0,2),e}var gQ=[0,0,0,0];function vQ(e,t){for(var n=0;n<cQ.length;n++){var i=cQ[n];null==e[i]&&(e[i]=t[i])}return hQ(e)}function fQ(e){var t=e.obb;return t&&!uQ(e,2)||(e.obb=t=t||new mO,t.fromBoundingRect(e.localRect,e.transform),dQ(e,!1,2)),t}function mQ(e,t,n,i,a){var r=e.length,s=AO[t],o=EO[t];if(r<2)return!1;e.sort(function(e,t){return e.rect[s]-t.rect[s]});for(var l,c=0,d=!1,u=0;u<r;u++){var h=e[u],p=h.rect;(l=p[s]-c)<0&&(p[s]-=l,h.label[s]-=l,d=!0),c=p[s]+p[o]}var g,v,f=e[0],m=e[r-1];function y(){g=f.rect[s]-n,v=i-m.rect[s]-m.rect[o]}function b(e,t,n){if(e<0){var i=Math.min(t,-e);if(i>0){w(i*n,0,r);var a=i+e;a<0&&k(-a*n,1)}else k(-e*n,1)}}function w(t,n,i){0!==t&&(d=!0);for(var a=n;a<i;a++){var r=e[a];r.rect[s]+=t,r.label[s]+=t}}function k(t,n){for(var i=[],a=0,l=1;l<r;l++){var c=e[l-1].rect,d=Math.max(e[l].rect[s]-c[s]-c[o],0);i.push(d),a+=d}if(a){var u=Math.min(Math.abs(t)/a,n);if(t>0)for(l=0;l<r-1;l++){w(i[l]*u,0,l+1)}else for(l=r-1;l>0;l--){w(-(i[l-1]*u),l,r)}}}function S(e){var t=e<0?-1:1;e=Math.abs(e);for(var n=Math.ceil(e/(r-1)),i=0;i<r-1;i++)if(t>0?w(n,0,i+1):w(-n,r-i-1,r),(e-=n)<=0)return}return y(),g<0&&k(-g,.8),v<0&&k(v,.8),y(),b(g,v,1),b(v,g,-1),y(),g<0&&S(-g),v<0&&S(v),d}function yQ(e){var t=[];function n(e){if(!e.ignore){var t=e.ensureState("emphasis");null==t.ignore&&(t.ignore=!1)}e.ignore=!0}e.sort(function(e,t){return(t.suggestIgnore?1:0)-(e.suggestIgnore?1:0)||t.priority-e.priority});for(var i=0;i<e.length;i++){var a=hQ(e[i]);if(!a.label.ignore){for(var r=a.label,s=a.labelLine,o=!1,l=0;l<t.length;l++)if(bQ(a,t[l],null,{touchThreshold:.05})){o=!0;break}o?(n(r),s&&n(s)):t.push(a)}}}function bQ(e,t,n,i){return!(!e||!t)&&(!(e.label&&e.label.ignore||t.label&&t.label.ignore)&&(!!e.rect.intersect(t.rect,n,i)&&(!(!e.axisAligned||!t.axisAligned)||fQ(e).intersect(fQ(t),n,i))))}function wQ(e){if(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].slice());return t}}function kQ(e,t){var n=e.label,i=t&&t.getTextGuideLine();return{dataIndex:e.dataIndex,dataType:e.dataType,seriesIndex:e.seriesModel.seriesIndex,text:e.label.style.text,rect:e.hostRect,labelRect:e.rect,align:n.style.align,verticalAlign:n.style.verticalAlign,labelLinePoints:wQ(i&&i.shape.points)}}var SQ=["align","verticalAlign","width","height","fontSize"],xQ=new vA,_Q=BE(),CQ=BE();function IQ(e,t,n){for(var i=0;i<n.length;i++){var a=n[i];null!=t[a]&&(e[a]=t[a])}}var DQ=["x","y","rotation"],TQ=function(){function e(){this._labelList=[],this._chartViewList=[]}return e.prototype.clearLabels=function(){this._labelList=[],this._chartViewList=[]},e.prototype._addLabel=function(e,t,n,i,a){var r=i.style,s=i.__hostTarget.textConfig||{},o=i.getComputedTransform(),l=i.getBoundingRect().plain();GD.applyTransform(l,l,o),o?xQ.setLocalTransform(o):(xQ.x=xQ.y=xQ.rotation=xQ.originX=xQ.originY=0,xQ.scaleX=xQ.scaleY=1),xQ.rotation=kP(xQ.rotation);var c,d=i.__hostTarget;if(d){c=d.getBoundingRect().plain();var u=d.getComputedTransform();GD.applyTransform(c,c,u)}var h=c&&d.getTextGuideLine();this._labelList.push({label:i,labelLine:h,seriesModel:n,dataIndex:e,dataType:t,layoutOptionOrCb:a,layoutOption:null,rect:l,hostRect:c,priority:c?c.width*c.height:0,defaultAttr:{ignore:i.ignore,labelGuideIgnore:h&&h.ignore,x:xQ.x,y:xQ.y,scaleX:xQ.scaleX,scaleY:xQ.scaleY,rotation:xQ.rotation,style:{x:r.x,y:r.y,align:r.align,verticalAlign:r.verticalAlign,width:r.width,height:r.height,fontSize:r.fontSize},cursor:i.cursor,attachedPos:s.position,attachedRot:s.rotation}})},e.prototype.addLabelsOfSeries=function(e){var t=this;this._chartViewList.push(e);var n=e.__model,i=n.get("labelLayout");(ZC(i)||WC(i).length)&&e.group.traverse(function(e){if(e.ignore)return!0;var a=e.getTextContent(),r=uR(e);a&&!a.disableLabelLayout&&t._addLabel(r.dataIndex,r.dataType,n,a,i)})},e.prototype.updateLayoutConfig=function(e){var t=e.getWidth(),n=e.getHeight();function i(e,t){return function(){eQ(e,t)}}for(var a=0;a<this._labelList.length;a++){var r=this._labelList[a],s=r.label,o=s.__hostTarget,l=r.defaultAttr,c=void 0;c=(c=ZC(r.layoutOptionOrCb)?r.layoutOptionOrCb(kQ(r,o)):r.layoutOptionOrCb)||{},r.layoutOption=c;var d=Math.PI/180;o&&o.setTextConfig({local:!1,position:null!=c.x||null!=c.y?null:l.attachedPos,rotation:null!=c.rotate?c.rotate*d:l.attachedRot,offset:[c.dx||0,c.dy||0]});var u=!1;if(null!=c.x?(s.x=tE(c.x,t),s.setStyle("x",0),u=!0):(s.x=l.x,s.setStyle("x",l.style.x)),null!=c.y?(s.y=tE(c.y,n),s.setStyle("y",0),u=!0):(s.y=l.y,s.setStyle("y",l.style.y)),c.labelLinePoints){var h=o.getTextGuideLine();h&&(h.setShape({points:c.labelLinePoints}),u=!1)}_Q(s).needsUpdateLabelLine=u,s.rotation=null!=c.rotate?c.rotate*d:l.rotation,s.scaleX=l.scaleX,s.scaleY=l.scaleY;for(var p=0;p<SQ.length;p++){var g=SQ[p];s.setStyle(g,null!=c[g]?c[g]:l.style[g])}if(c.draggable){if(s.draggable=!0,s.cursor="move",o){var v=r.seriesModel;if(null!=r.dataIndex)v=r.seriesModel.getData(r.dataType).getItemModel(r.dataIndex);s.on("drag",i(o,v.getModel("labelLine")))}}else s.off("drag"),s.cursor=l.cursor}},e.prototype.layout=function(e){var t=e.getWidth(),n=e.getHeight(),i=[];jC(this._labelList,function(e){e.defaultAttr.ignore||i.push(vQ({},e))});var a=qC(i,function(e){return"shiftX"===e.layoutOption.moveOverlap}),r=qC(i,function(e){return"shiftY"===e.layoutOption.moveOverlap});mQ(a,0,0,t),mQ(r,1,0,n);var s=qC(i,function(e){return e.layoutOption.hideOverlap});!function(e){for(var t=0;t<e.length;t++){var n=e[t],i=n.defaultAttr,a=n.labelLine;n.label.attr("ignore",i.ignore),a&&a.attr("ignore",i.labelGuideIgnore)}}(s),yQ(s)},e.prototype.processLabelsOverall=function(){var e=this;jC(this._chartViewList,function(t){var n=t.__model,i=t.ignoreLabelLineUpdate,a=n.isAnimationEnabled();t.group.traverse(function(t){if(t.ignore&&!t.forceLabelAnimation)return!0;var r=!i,s=t.getTextContent();!r&&s&&(r=_Q(s).needsUpdateLabelLine),r&&e._updateLabelLine(t,n),a&&e._animateLabels(t,n)})})},e.prototype._updateLabelLine=function(e,t){var n=e.getTextContent(),i=uR(e),a=i.dataIndex;if(n&&null!=a){var r=t.getData(i.dataType),s=r.getItemModel(a),o={},l=r.getItemVisual(a,"style");if(l){var c=r.getVisual("drawType");o.stroke=l[c]}var d=s.getModel("labelLine");oQ(e,lQ(s),o),eQ(e,d)}},e.prototype._animateLabels=function(e,t){var n=e.getTextContent(),i=e.getTextGuideLine();if(n&&(e.forceLabelAnimation||!n.ignore&&!n.invisible&&!e.disableLabelAnimation&&!_O(e))){var a=(p=_Q(n)).oldLayout,r=uR(e),s=r.dataIndex,o={x:n.x,y:n.y,rotation:n.rotation},l=t.getData(r.dataType);if(a){n.attr(a);var c=e.prevStates;c&&(LC(c,"select")>=0&&n.attr(p.oldLayoutSelect),LC(c,"emphasis")>=0&&n.attr(p.oldLayoutEmphasis)),SO(n,o,t,s)}else if(n.attr(o),!IL(n).valueAnimation){var d=cI(n.style.opacity,1);n.style.opacity=0,xO(n,{style:{opacity:d}},t,s)}if(p.oldLayout=o,n.states.select){var u=p.oldLayoutSelect={};IQ(u,o,DQ),IQ(u,n.states.select,DQ)}if(n.states.emphasis){var h=p.oldLayoutEmphasis={};IQ(h,o,DQ),IQ(h,n.states.emphasis,DQ)}!function(e,t,n,i,a){var r=IL(e);if(r.valueAnimation&&r.prevValue!==r.value){var s=r.defaultInterpolatedText,o=cI(r.interpolatedValue,r.prevValue),l=r.value;e.percent=0,(null==r.prevValue?xO:SO)(e,{percent:1},i,t,null,function(i){var c=QE(n,r.precision,o,l,i);r.interpolatedValue=1===i?null:c;var d=fL({labelDataIndex:t,labelFetcher:a,defaultText:s?s(c):c+""},r.statesModels,c);vL(e,d)})}}(n,s,l,t,t)}if(i&&!i.ignore&&!i.invisible){a=(p=CQ(i)).oldLayout;var p,g={points:i.shape.points};a?(i.attr({shape:a}),SO(i,{shape:g},t)):(i.setShape(g),i.style.strokePercent=0,xO(i,{style:{strokePercent:1}},t)),p.oldLayout=g}},e}(),MQ=BE();function AQ(e){e.registerUpdateLifecycle("series:beforeupdate",function(e,t,n){var i=MQ(t).labelManager;i||(i=MQ(t).labelManager=new TQ),i.clearLabels()}),e.registerUpdateLifecycle("series:layoutlabels",function(e,t,n){var i=MQ(t).labelManager;n.updatedSeries.forEach(function(e){i.addLabelsOfSeries(t.getViewOfSeriesModel(e))}),i.updateLayoutConfig(t),i.layout(t),i.processLabelsOverall()})}const EQ=Object.freeze(Object.defineProperty({__proto__:null,Axis:LG,ChartView:sU,ComponentModel:dF,ComponentView:nU,List:$H,Model:BL,PRIORITY:YV,SeriesModel:Qj,color:kM,connect:function(e){if(KC(e)){var t=e;e=null,jC(t,function(t){null!=t.group&&(e=t.group)}),e=e||"g_"+Uq++,jC(t,function(t){t.group=e})}return Bq[e]=!0,e},dataTool:{},dependencies:{zrender:"6.0.0"},disConnect:Wq,disconnect:Hq,dispose:function(e){YC(e)?e=Fq[e]:e instanceof Tq||(e=Gq(e)),e instanceof Tq&&!e.isDisposed()&&e.dispose()},env:pC,extendChartView:function(e){var t=sU.extend(e);return sU.registerClass(t),t},extendComponentModel:function(e){var t=dF.extend(e);return dF.registerClass(t),t},extendComponentView:function(e){var t=nU.extend(e);return nU.registerClass(t),t},extendSeriesModel:function(e){var t=Qj.extend(e);return Qj.registerClass(t),t},format:fG,getCoordinateSystemDimensions:function(e){var t=UN.get(e);if(t)return t.getDimensionsInfo?t.getDimensionsInfo():t.dimensions.slice()},getInstanceByDom:Gq,getInstanceById:function(e){return Fq[e]},getMap:function(e){var t=QV("getMap");return t&&t(e)},graphic:vG,helper:YW,init:qq,innerDrawElementOnCanvas:LV,matrix:zD,number:pG,parseGeoJSON:hG,parseGeoJson:hG,registerAction:eH,registerCoordinateSystem:tH,registerCustomSeries:function(e,t){},registerLayout:nH,registerLoading:sH,registerLocale:ZL,registerMap:oH,registerPostInit:Yq,registerPostUpdate:Xq,registerPreprocessor:Kq,registerProcessor:Zq,registerTheme:Qq,registerTransform:lH,registerUpdateLifecycle:Jq,registerVisual:iH,setCanvasCreator:function(e){mC({createCanvas:e})},setPlatformAPI:mC,throttle:vU,time:gG,use:eG,util:mG,vector:ZI,version:"6.0.0",zrUtil:MI,zrender:KA},Symbol.toStringTag,{value:"Module"}));var zQ=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.hasSymbolVisual=!0,n}return uC(t,e),t.prototype.getInitialData=function(e){return qH(0,this,{useEncodeDefaulter:!0})},t.prototype.getLegendIcon=function(e){var t=new jA,n=vV("line",0,e.itemHeight/2,e.itemWidth,0,e.lineStyle.stroke,!1);t.add(n),n.setStyle(e.lineStyle);var i=this.getData().getVisual("symbol"),a=this.getData().getVisual("symbolRotate"),r="none"===i?"circle":i,s=.8*e.itemHeight,o=vV(r,(e.itemWidth-s)/2,(e.itemHeight-s)/2,s,s,e.itemStyle.fill);t.add(o),o.setStyle(e.itemStyle);var l="inherit"===e.iconRotate?a:e.iconRotate||0;return o.rotation=l*Math.PI/180,o.setOrigin([e.itemWidth/2,e.itemHeight/2]),r.indexOf("empty")>-1&&(o.style.stroke=o.style.fill,o.style.fill=uF.color.neutral00,o.style.lineWidth=2),t},t.type="series.line",t.dependencies=["grid","polar"],t.defaultOption={z:3,coordinateSystem:"cartesian2d",legendHoverLink:!0,clip:!0,label:{position:"top"},endLabel:{show:!1,valueAnimation:!0,distance:8},lineStyle:{width:2,type:"solid"},emphasis:{scale:!0},step:!1,smooth:!1,smoothMonotone:null,symbol:"emptyCircle",symbolSize:6,symbolRotate:null,showSymbol:!0,showAllSymbol:"auto",connectNulls:!1,sampling:"none",animationEasing:"linear",progressive:0,hoverLayerThreshold:1/0,universalTransition:{divideShape:"clone"},triggerLineEvent:!1},t}(Qj);function PQ(e,t){var n=e.mapDimensionsAll("defaultedLabel"),i=n.length;if(1===i){var a=WB(e,t,n[0]);return null!=a?a+"":null}if(i){for(var r=[],s=0;s<n.length;s++)r.push(WB(e,t,n[s]));return r.join(" ")}}function RQ(e,t){var n=e.mapDimensionsAll("defaultedLabel");if(!KC(t))return t+"";for(var i=[],a=0;a<n.length;a++){var r=e.getDimensionIndex(n[a]);r>=0&&i.push(t[r])}return i.join(" ")}var $Q=function(e){function t(t,n,i,a){var r=e.call(this)||this;return r.updateData(t,n,i,a),r}return uC(t,e),t.prototype._createSymbol=function(e,t,n,i,a,r){this.removeAll();var s=vV(e,-1,-1,2,2,null,r);s.attr({z2:cI(a,100),culling:!0,scaleX:i[0]/2,scaleY:i[1]/2}),s.drift=OQ,this._symbolType=e,this.add(s)},t.prototype.stopSymbolAnimation=function(e){this.childAt(0).stopAnimation(null,e)},t.prototype.getSymbolType=function(){return this._symbolType},t.prototype.getSymbolPath=function(){return this.childAt(0)},t.prototype.highlight=function(){FR(this.childAt(0))},t.prototype.downplay=function(){BR(this.childAt(0))},t.prototype.setZ=function(e,t){var n=this.childAt(0);n.zlevel=e,n.z=t},t.prototype.setDraggable=function(e,t){var n=this.childAt(0);n.draggable=e,n.cursor=!t&&e?"move":n.cursor},t.prototype.updateData=function(e,n,i,a){this.silent=!1;var r=e.getItemVisual(n,"symbol")||"circle",s=e.hostModel,o=t.getSymbolSize(e,n),l=t.getSymbolZ2(e,n),c=r!==this._symbolType,d=a&&a.disableAnimation;if(c){var u=e.getItemVisual(n,"symbolKeepAspect");this._createSymbol(r,e,n,o,l,u)}else{(p=this.childAt(0)).silent=!1;var h={scaleX:o[0]/2,scaleY:o[1]/2};d?p.attr(h):SO(p,h,s,n),TO(p)}if(this._updateCommon(e,n,o,i,a),c){var p=this.childAt(0);if(!d){h={scaleX:this._sizeX,scaleY:this._sizeY,style:{opacity:p.style.opacity}};p.scaleX=p.scaleY=0,p.style.opacity=0,xO(p,h,s,n)}}d&&this.childAt(0).stopAnimation("leave")},t.prototype._updateCommon=function(e,t,n,i,a){var r,s,o,l,c,d,u,h,p,g=this.childAt(0),v=e.hostModel;if(i&&(r=i.emphasisItemStyle,s=i.blurItemStyle,o=i.selectItemStyle,l=i.focus,c=i.blurScope,u=i.labelStatesModels,h=i.hoverScale,p=i.cursorStyle,d=i.emphasisDisabled),!i||e.hasItemOption){var f=i&&i.itemModel?i.itemModel:e.getItemModel(t),m=f.getModel("emphasis");r=m.getModel("itemStyle").getItemStyle(),o=f.getModel(["select","itemStyle"]).getItemStyle(),s=f.getModel(["blur","itemStyle"]).getItemStyle(),l=m.get("focus"),c=m.get("blurScope"),d=m.get("disabled"),u=yL(f),h=m.getShallow("scale"),p=f.getShallow("cursor")}var y=e.getItemVisual(t,"symbolRotate");g.attr("rotation",(y||0)*Math.PI/180||0);var b=mV(e.getItemVisual(t,"symbolOffset"),n);b&&(g.x=b[0],g.y=b[1]),p&&g.attr("cursor",p);var w=e.getItemVisual(t,"style"),k=w.fill;if(g instanceof UP){var S=g.style;g.useStyle(RC({image:S.image,x:S.x,y:S.y,width:S.width,height:S.height},w))}else g.__isEmptyBrush?g.useStyle(RC({},w)):g.useStyle(w),g.style.decal=null,g.setColor(k,a&&a.symbolInnerColor),g.style.strokeNoScale=!0;var x=e.getItemVisual(t,"liftZ"),_=this._z2;null!=x?null==_&&(this._z2=g.z2,g.z2+=x):null!=_&&(g.z2=_,this._z2=null);var C=a&&a.useNameLabel;mL(g,u,{labelFetcher:v,labelDataIndex:t,defaultText:function(t){return C?e.getName(t):PQ(e,t)},inheritColor:k,defaultOpacity:w.opacity}),this._sizeX=n[0]/2,this._sizeY=n[1]/2;var I=g.ensureState("emphasis");I.style=r,g.ensureState("select").style=o,g.ensureState("blur").style=s;var D=null==h||!0===h?Math.max(1.1,3/this._sizeY):isFinite(h)&&h>0?+h:1;I.scaleX=this._sizeX*D,I.scaleY=this._sizeY*D,this.setSymbolScale(1),JR(this,l,c,d)},t.prototype.setSymbolScale=function(e){this.scaleX=this.scaleY=e},t.prototype.fadeOut=function(e,t,n){var i=this.childAt(0),a=uR(this).dataIndex,r=n&&n.animation;if(this.silent=i.silent=!0,n&&n.fadeLabel){var s=i.getTextContent();s&&CO(s,{style:{opacity:0}},t,{dataIndex:a,removeOpt:r,cb:function(){i.removeTextContent()}})}else i.removeTextContent();CO(i,{style:{opacity:0},scaleX:0,scaleY:0},t,{dataIndex:a,cb:e,removeOpt:r})},t.getSymbolSize=function(e,t){return fV(e.getItemVisual(t,"symbolSize"))},t.getSymbolZ2=function(e,t){return e.getItemVisual(t,"z2")},t}(jA);function OQ(e,t){this.parent.drift(e,t)}function LQ(e,t,n,i){return t&&!isNaN(t[0])&&!isNaN(t[1])&&!(i.isIgnore&&i.isIgnore(n))&&!(i.clipShape&&!i.clipShape.contain(t[0],t[1]))&&"none"!==e.getItemVisual(n,"symbol")}function NQ(e){return null==e||eI(e)||(e={isIgnore:e}),e||{}}function FQ(e){var t=e.hostModel,n=t.getModel("emphasis");return{emphasisItemStyle:n.getModel("itemStyle").getItemStyle(),blurItemStyle:t.getModel(["blur","itemStyle"]).getItemStyle(),selectItemStyle:t.getModel(["select","itemStyle"]).getItemStyle(),focus:n.get("focus"),blurScope:n.get("blurScope"),emphasisDisabled:n.get("disabled"),hoverScale:n.get("scale"),labelStatesModels:yL(t),cursorStyle:t.get("cursor")}}var BQ=function(){function e(e){this.group=new jA,this._SymbolCtor=e||$Q}return e.prototype.updateData=function(e,t){this._progressiveEls=null,t=NQ(t);var n=this.group,i=e.hostModel,a=this._data,r=this._SymbolCtor,s=t.disableAnimation,o=FQ(e),l={disableAnimation:s},c=t.getSymbolPoint||function(t){return e.getItemLayout(t)};a||n.removeAll(),e.diff(a).add(function(i){var a=c(i);if(LQ(e,a,i,t)){var s=new r(e,i,o,l);s.setPosition(a),e.setItemGraphicEl(i,s),n.add(s)}}).update(function(d,u){var h=a.getItemGraphicEl(u),p=c(d);if(LQ(e,p,d,t)){var g=e.getItemVisual(d,"symbol")||"circle",v=h&&h.getSymbolType&&h.getSymbolType();if(!h||v&&v!==g)n.remove(h),(h=new r(e,d,o,l)).setPosition(p);else{h.updateData(e,d,o,l);var f={x:p[0],y:p[1]};s?h.attr(f):SO(h,f,i)}n.add(h),e.setItemGraphicEl(d,h)}else n.remove(h)}).remove(function(e){var t=a.getItemGraphicEl(e);t&&t.fadeOut(function(){n.remove(t)},i)}).execute(),this._getSymbolPoint=c,this._data=e},e.prototype.updateLayout=function(){var e=this,t=this._data;t&&t.eachItemGraphicEl(function(t,n){var i=e._getSymbolPoint(n);t.setPosition(i),t.markRedraw()})},e.prototype.incrementalPrepareUpdate=function(e){this._seriesScope=FQ(e),this._data=null,this.group.removeAll()},e.prototype.incrementalUpdate=function(e,t,n){function i(e){e.isGroup||(e.incremental=!0,e.ensureState("emphasis").hoverLayer=!0)}this._progressiveEls=[],n=NQ(n);for(var a=e.start;a<e.end;a++){var r=t.getItemLayout(a);if(LQ(t,r,a,n)){var s=new this._SymbolCtor(t,a,this._seriesScope);s.traverse(i),s.setPosition(r),this.group.add(s),t.setItemGraphicEl(a,s),this._progressiveEls.push(s)}}},e.prototype.eachRendered=function(e){rL(this._progressiveEls||this.group,e)},e.prototype.remove=function(e){var t=this.group,n=this._data;n&&e?n.eachItemGraphicEl(function(e){e.fadeOut(function(){t.remove(e)},n.hostModel)}):t.removeAll()},e}();function jQ(e,t,n){var i=e.getBaseAxis(),a=e.getOtherAxis(i),r=function(e,t){var n=0,i=e.scale.getExtent();"start"===t?n=i[0]:"end"===t?n=i[1]:JC(t)&&!isNaN(t)?n=t:i[0]>0?n=i[0]:i[1]<0&&(n=i[1]);return n}(a,n),s=i.dim,o=a.dim,l=t.mapDimension(o),c=t.mapDimension(s),d="x"===o||"radius"===o?1:0,u=UC(e.dimensions,function(e){return t.mapDimension(e)}),h=!1,p=t.getCalculationInfo("stackResultDimension");return UH(t,u[0])&&(h=!0,u[0]=p),UH(t,u[1])&&(h=!0,u[1]=p),{dataDimsForPoint:u,valueStart:r,valueAxisDim:o,baseAxisDim:s,stacked:!!h,valueDim:l,baseDim:c,baseDataOffset:d,stackedOverDimension:t.getCalculationInfo("stackedOverDimension")}}function UQ(e,t,n,i){var a=NaN;e.stacked&&(a=n.get(n.getCalculationInfo("stackedOverDimension"),i)),isNaN(a)&&(a=e.valueStart);var r=e.baseDataOffset,s=[];return s[r]=n.get(e.baseDim,i),s[1-r]=a,t.dataToPoint(s)}var VQ=Math.min,qQ=Math.max;function HQ(e,t){return isNaN(e)||isNaN(t)}function WQ(e,t,n,i,a,r,s,o,l){for(var c,d,u,h,p,g,v=n,f=0;f<i;f++){var m=t[2*v],y=t[2*v+1];if(v>=a||v<0)break;if(HQ(m,y)){if(l){v+=r;continue}break}if(v===n)e[r>0?"moveTo":"lineTo"](m,y),u=m,h=y;else{var b=m-c,w=y-d;if(b*b+w*w<.5){v+=r;continue}if(s>0){for(var k=v+r,S=t[2*k],x=t[2*k+1];S===m&&x===y&&f<i;)f++,v+=r,S=t[2*(k+=r)],x=t[2*k+1],b=(m=t[2*v])-c,w=(y=t[2*v+1])-d;var _=f+1;if(l)for(;HQ(S,x)&&_<i;)_++,S=t[2*(k+=r)],x=t[2*k+1];var C=.5,I=0,D=0,T=void 0,M=void 0;if(_>=i||HQ(S,x))p=m,g=y;else{I=S-c,D=x-d;var A=m-c,E=S-m,z=y-d,P=x-y,R=void 0,$=void 0;if("x"===o){var O=I>0?1:-1;p=m-O*(R=Math.abs(A))*s,g=y,T=m+O*($=Math.abs(E))*s,M=y}else if("y"===o){var L=D>0?1:-1;p=m,g=y-L*(R=Math.abs(z))*s,T=m,M=y+L*($=Math.abs(P))*s}else R=Math.sqrt(A*A+z*z),p=m-I*s*(1-(C=($=Math.sqrt(E*E+P*P))/($+R))),g=y-D*s*(1-C),M=y+D*s*C,T=VQ(T=m+I*s*C,qQ(S,m)),M=VQ(M,qQ(x,y)),T=qQ(T,VQ(S,m)),g=y-(D=(M=qQ(M,VQ(x,y)))-y)*R/$,p=VQ(p=m-(I=T-m)*R/$,qQ(c,m)),g=VQ(g,qQ(d,y)),T=m+(I=m-(p=qQ(p,VQ(c,m))))*$/R,M=y+(D=y-(g=qQ(g,VQ(d,y))))*$/R}e.bezierCurveTo(u,h,p,g,m,y),u=T,h=M}else e.lineTo(m,y)}c=m,d=y,v+=r}return f}var GQ=function(){return function(){this.smooth=0,this.smoothConstraint=!0}}(),QQ=function(e){function t(t){var n=e.call(this,t)||this;return n.type="ec-polyline",n}return uC(t,e),t.prototype.getDefaultStyle=function(){return{stroke:uF.color.neutral99,fill:null}},t.prototype.getDefaultShape=function(){return new GQ},t.prototype.buildPath=function(e,t){var n=t.points,i=0,a=n.length/2;if(t.connectNulls){for(;a>0&&HQ(n[2*a-2],n[2*a-1]);a--);for(;i<a&&HQ(n[2*i],n[2*i+1]);i++);}for(;i<a;)i+=WQ(e,n,i,a,a,1,t.smooth,t.smoothMonotone,t.connectNulls)+1},t.prototype.getPointOn=function(e,t){this.path||(this.createPathProxy(),this.buildPath(this.path,this.shape));for(var n,i,a=this.path.data,r=fP.CMD,s="x"===t,o=[],l=0;l<a.length;){var c=void 0,d=void 0,u=void 0,h=void 0,p=void 0,g=void 0,v=void 0;switch(a[l++]){case r.M:n=a[l++],i=a[l++];break;case r.L:if(c=a[l++],d=a[l++],(v=s?(e-n)/(c-n):(e-i)/(d-i))<=1&&v>=0){var f=s?(d-i)*v+i:(c-n)*v+n;return s?[e,f]:[f,e]}n=c,i=d;break;case r.C:c=a[l++],d=a[l++],u=a[l++],h=a[l++],p=a[l++],g=a[l++];var m=s?PT(n,c,u,p,e,o):PT(i,d,h,g,e,o);if(m>0)for(var y=0;y<m;y++){var b=o[y];if(b<=1&&b>=0){f=s?ET(i,d,h,g,b):ET(n,c,u,p,b);return s?[e,f]:[f,e]}}n=p,i=g}}},t}(LP),KQ=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t}(GQ),ZQ=function(e){function t(t){var n=e.call(this,t)||this;return n.type="ec-polygon",n}return uC(t,e),t.prototype.getDefaultShape=function(){return new KQ},t.prototype.buildPath=function(e,t){var n=t.points,i=t.stackedOnPoints,a=0,r=n.length/2,s=t.smoothMonotone;if(t.connectNulls){for(;r>0&&HQ(n[2*r-2],n[2*r-1]);r--);for(;a<r&&HQ(n[2*a],n[2*a+1]);a++);}for(;a<r;){var o=WQ(e,n,a,r,r,1,t.smooth,s,t.connectNulls);WQ(e,i,a+o-1,o,r,-1,t.stackedOnSmooth,s,t.connectNulls),a+=o+1,e.closePath()}},t}(LP);function YQ(e,t,n,i,a){var r=e.getArea(),s=r.x,o=r.y,l=r.width,c=r.height,d=n.get(["lineStyle","width"])||0;s-=d/2,o-=d/2,l+=d,c+=d,l=Math.ceil(l),s!==Math.floor(s)&&(s=Math.floor(s),l++);var u=new KP({shape:{x:s,y:o,width:l,height:c}});if(t){var h=e.getBaseAxis(),p=h.isHorizontal(),g=h.inverse;p?(g&&(u.shape.x+=l),u.shape.width=0):(g||(u.shape.y+=c),u.shape.height=0);var v=ZC(a)?function(e){a(e,u)}:null;xO(u,{shape:{width:l,height:c,x:s,y:o}},n,null,i,v)}return u}function XQ(e,t,n){var i=e.getArea(),a=iE(i.r0,1),r=iE(i.r,1),s=new U$({shape:{cx:iE(e.cx,1),cy:iE(e.cy,1),r0:a,r:r,startAngle:i.startAngle,endAngle:i.endAngle,clockwise:i.clockwise}});t&&("angle"===e.getBaseAxis().dim?s.shape.endAngle=i.startAngle:s.shape.r=a,xO(s,{shape:{endAngle:i.endAngle,r:r}},n));return s}function JQ(e,t){return e.type===t}function eK(e,t){if(e.length===t.length){for(var n=0;n<e.length;n++)if(e[n]!==t[n])return;return!0}}function tK(e){for(var t=1/0,n=1/0,i=-1/0,a=-1/0,r=0;r<e.length;){var s=e[r++],o=e[r++];isNaN(s)||(t=Math.min(s,t),i=Math.max(s,i)),isNaN(o)||(n=Math.min(o,n),a=Math.max(o,a))}return[[t,n],[i,a]]}function nK(e,t){var n=tK(e),i=n[0],a=n[1],r=tK(t),s=r[0],o=r[1];return Math.max(Math.abs(i[0]-s[0]),Math.abs(i[1]-s[1]),Math.abs(a[0]-o[0]),Math.abs(a[1]-o[1]))}function iK(e){return JC(e)?e:e?.5:0}function aK(e,t,n,i,a){var r=n.getBaseAxis(),s="x"===r.dim||"radius"===r.dim?0:1,o=[],l=0,c=[],d=[],u=[],h=[];if(a){for(l=0;l<e.length;l+=2){var p=t||e;isNaN(p[l])||isNaN(p[l+1])||h.push(e[l],e[l+1])}e=h}for(l=0;l<e.length-2;l+=2)switch(u[0]=e[l+2],u[1]=e[l+3],d[0]=e[l],d[1]=e[l+1],o.push(d[0],d[1]),i){case"end":c[s]=u[s],c[1-s]=d[1-s],o.push(c[0],c[1]);break;case"middle":var g=(d[s]+u[s])/2,v=[];c[s]=v[s]=g,c[1-s]=d[1-s],v[1-s]=u[1-s],o.push(c[0],c[1]),o.push(v[0],v[1]);break;default:c[s]=d[s],c[1-s]=u[1-s],o.push(c[0],c[1])}return o.push(e[l++],e[l++]),o}function rK(e,t,n){var i=e.getVisual("visualMeta");if(i&&i.length&&e.count()&&"cartesian2d"===t.type){for(var a,r,s=i.length-1;s>=0;s--){var o=e.getDimensionInfo(i[s].dimension);if("x"===(a=o&&o.coordDim)||"y"===a){r=i[s];break}}if(r){var l=t.getAxis(a),c=UC(r.stops,function(e){return{coord:l.toGlobalCoord(l.dataToCoord(e.value)),color:e.color}}),d=c.length,u=r.outerColors.slice();d&&c[0].coord>c[d-1].coord&&(c.reverse(),u.reverse());var h=function(e,t){var n,i,a=[],r=e.length;function s(e,t,n){var i=e.coord;return{coord:n,color:pM((n-i)/(t.coord-i),[e.color,t.color])}}for(var o=0;o<r;o++){var l=e[o],c=l.coord;if(c<0)n=l;else{if(c>t){i?a.push(s(i,l,t)):n&&a.push(s(n,l,0),s(n,l,t));break}n&&(a.push(s(n,l,0)),n=null),a.push(l),i=l}}return a}(c,"x"===a?n.getWidth():n.getHeight()),p=h.length;if(!p&&d)return c[0].coord<0?u[1]?u[1]:c[d-1].color:u[0]?u[0]:c[0].color;var g=h[0].coord-10,v=h[p-1].coord+10,f=v-g;if(f<.001)return"transparent";jC(h,function(e){e.offset=(e.coord-g)/f}),h.push({offset:p?h[p-1].offset:.5,color:u[1]||"transparent"}),h.unshift({offset:p?h[0].offset:.5,color:u[0]||"transparent"});var m=new oO(0,0,0,0,h,!0);return m[a]=g,m[a+"2"]=v,m}}}function sK(e,t,n){var i=e.get("showAllSymbol"),a="auto"===i;if(!i||a){var r=n.getAxesByScale("ordinal")[0];if(r&&(!a||!function(e,t){var n=e.getExtent(),i=Math.abs(n[1]-n[0])/e.scale.count();isNaN(i)&&(i=0);for(var a=t.count(),r=Math.max(1,Math.round(a/5)),s=0;s<a;s+=r)if(1.5*$Q.getSymbolSize(t,s)[e.isHorizontal()?1:0]>i)return!1;return!0}(r,t))){var s=t.mapDimension(r.dim),o={};return jC(r.getViewLabels(),function(e){var t=r.scale.getRawOrdinalNumber(e.tickValue);o[t]=1}),function(e){return!o.hasOwnProperty(t.get(s,e))}}}}function oK(e,t){return isNaN(e)||isNaN(t)}function lK(e,t){return[e[2*t],e[2*t+1]]}function cK(e){if(e.get(["endLabel","show"]))return!0;for(var t=0;t<fR.length;t++)if(e.get([fR[t],"endLabel","show"]))return!0;return!1}function dK(e,t,n,i){if(JQ(t,"cartesian2d")){var a=i.getModel("endLabel"),r=a.get("valueAnimation"),s=i.getData(),o={lastFrameIndex:0},l=cK(i)?function(n,i){e._endLabelOnDuring(n,i,s,o,r,a,t)}:null,c=t.getBaseAxis().isHorizontal(),d=YQ(t,n,i,function(){var t=e._endLabel;t&&n&&null!=o.originalX&&t.attr({x:o.originalX,y:o.originalY})},l);if(!i.get("clip",!0)){var u=d.shape,h=Math.max(u.width,u.height);c?(u.y-=h,u.height+=2*h):(u.x-=h,u.width+=2*h)}return l&&l(1,d),d}return XQ(t,n,i)}var uK=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.init=function(){var e=new jA,t=new BQ;this.group.add(t.group),this._symbolDraw=t,this._lineGroup=e,this._changePolyState=GC(this._changePolyState,this)},t.prototype.render=function(e,t,n){var i=e.coordinateSystem,a=this.group,r=e.getData(),s=e.getModel("lineStyle"),o=e.getModel("areaStyle"),l=r.getLayout("points")||[],c="polar"===i.type,d=this._coordSys,u=this._symbolDraw,h=this._polyline,p=this._polygon,g=this._lineGroup,v=!t.ssr&&e.get("animation"),f=!o.isEmpty(),m=o.get("origin"),y=jQ(i,r,m),b=f&&function(e,t,n){if(!n.valueDim)return[];for(var i=t.count(),a=dW(2*i),r=0;r<i;r++){var s=UQ(n,e,t,r);a[2*r]=s[0],a[2*r+1]=s[1]}return a}(i,r,y),w=e.get("showSymbol"),k=e.get("connectNulls"),S=w&&!c&&sK(e,r,i),x=this._data;x&&x.eachItemGraphicEl(function(e,t){e.__temp&&(a.remove(e),x.setItemGraphicEl(t,null))}),w||u.remove(),a.add(g);var _,C=!c&&e.get("step");i&&i.getArea&&e.get("clip",!0)&&(null!=(_=i.getArea()).width?(_.x-=.1,_.y-=.1,_.width+=.2,_.height+=.2):_.r0&&(_.r0-=.5,_.r+=.5)),this._clipShapeForSymbol=_;var I=rK(r,i,n)||r.getVisual("style")[r.getVisual("drawType")];if(h&&d.type===i.type&&C===this._step){f&&!p?p=this._newPolygon(l,b):p&&!f&&(g.remove(p),p=this._polygon=null),c||this._initOrUpdateEndLabel(e,i,NN(I));var D=g.getClipPath();if(D)xO(D,{shape:dK(this,i,!1,e).shape},e);else g.setClipPath(dK(this,i,!0,e));w&&u.updateData(r,{isIgnore:S,clipShape:_,disableAnimation:!0,getSymbolPoint:function(e){return[l[2*e],l[2*e+1]]}}),eK(this._stackedOnPoints,b)&&eK(this._points,l)||(v?this._doUpdateAnimation(r,b,i,n,C,m,k):(C&&(b&&(b=aK(b,l,i,C,k)),l=aK(l,null,i,C,k)),h.setShape({points:l}),p&&p.setShape({points:l,stackedOnPoints:b})))}else w&&u.updateData(r,{isIgnore:S,clipShape:_,disableAnimation:!0,getSymbolPoint:function(e){return[l[2*e],l[2*e+1]]}}),v&&this._initSymbolLabelAnimation(r,i,_),C&&(b&&(b=aK(b,l,i,C,k)),l=aK(l,null,i,C,k)),h=this._newPolyline(l),f?p=this._newPolygon(l,b):p&&(g.remove(p),p=this._polygon=null),c||this._initOrUpdateEndLabel(e,i,NN(I)),g.setClipPath(dK(this,i,!0,e));var T=e.getModel("emphasis"),M=T.get("focus"),A=T.get("blurScope"),E=T.get("disabled");(h.useStyle($C(s.getLineStyle(),{fill:"none",stroke:I,lineJoin:"bevel"})),n$(h,e,"lineStyle"),h.style.lineWidth>0&&"bolder"===e.get(["emphasis","lineStyle","width"]))&&(h.getState("emphasis").style.lineWidth=+h.style.lineWidth+1);uR(h).seriesIndex=e.seriesIndex,JR(h,M,A,E);var z=iK(e.get("smooth")),P=e.get("smoothMonotone");if(h.setShape({smooth:z,smoothMonotone:P,connectNulls:k}),p){var R=r.getCalculationInfo("stackedOnSeries"),$=0;p.useStyle($C(o.getAreaStyle(),{fill:I,opacity:.7,lineJoin:"bevel",decal:r.getVisual("style").decal})),R&&($=iK(R.get("smooth"))),p.setShape({smooth:z,stackedOnSmooth:$,smoothMonotone:P,connectNulls:k}),n$(p,e,"areaStyle"),uR(p).seriesIndex=e.seriesIndex,JR(p,M,A,E)}var O=this._changePolyState;r.eachItemGraphicEl(function(e){e&&(e.onHoverStateChange=O)}),this._polyline.onHoverStateChange=O,this._data=r,this._coordSys=i,this._stackedOnPoints=b,this._points=l,this._step=C,this._valueOrigin=m,e.get("triggerLineEvent")&&(this.packEventData(e,h),p&&this.packEventData(e,p))},t.prototype.packEventData=function(e,t){uR(t).eventData={componentType:"series",componentSubType:"line",componentIndex:e.componentIndex,seriesIndex:e.seriesIndex,seriesName:e.name,seriesType:"line"}},t.prototype.highlight=function(e,t,n,i){var a=e.getData(),r=FE(a,i);if(this._changePolyState("emphasis"),!(r instanceof Array)&&null!=r&&r>=0){var s=a.getLayout("points"),o=a.getItemGraphicEl(r);if(!o){var l=s[2*r],c=s[2*r+1];if(isNaN(l)||isNaN(c))return;if(this._clipShapeForSymbol&&!this._clipShapeForSymbol.contain(l,c))return;var d=e.get("zlevel")||0,u=e.get("z")||0;(o=new $Q(a,r)).x=l,o.y=c,o.setZ(d,u);var h=o.getSymbolPath().getTextContent();h&&(h.zlevel=d,h.z=u,h.z2=this._polyline.z2+1),o.__temp=!0,a.setItemGraphicEl(r,o),o.stopSymbolAnimation(!0),this.group.add(o)}o.highlight()}else sU.prototype.highlight.call(this,e,t,n,i)},t.prototype.downplay=function(e,t,n,i){var a=e.getData(),r=FE(a,i);if(this._changePolyState("normal"),null!=r&&r>=0){var s=a.getItemGraphicEl(r);s&&(s.__temp?(a.setItemGraphicEl(r,null),this.group.remove(s)):s.downplay())}else sU.prototype.downplay.call(this,e,t,n,i)},t.prototype._changePolyState=function(e){var t=this._polygon;RR(this._polyline,e),t&&RR(t,e)},t.prototype._newPolyline=function(e){var t=this._polyline;return t&&this._lineGroup.remove(t),t=new QQ({shape:{points:e},segmentIgnoreThreshold:2,z2:10}),this._lineGroup.add(t),this._polyline=t,t},t.prototype._newPolygon=function(e,t){var n=this._polygon;return n&&this._lineGroup.remove(n),n=new ZQ({shape:{points:e,stackedOnPoints:t},segmentIgnoreThreshold:2}),this._lineGroup.add(n),this._polygon=n,n},t.prototype._initSymbolLabelAnimation=function(e,t,n){var i,a,r=t.getBaseAxis(),s=r.inverse;"cartesian2d"===t.type?(i=r.isHorizontal(),a=!1):"polar"===t.type&&(i="angle"===r.dim,a=!0);var o=e.hostModel,l=o.get("animationDuration");ZC(l)&&(l=l(null));var c=o.get("animationDelay")||0,d=ZC(c)?c(null):c;e.eachItemGraphicEl(function(e,r){var o=e;if(o){var u=[e.x,e.y],h=void 0,p=void 0,g=void 0;if(n)if(a){var v=n,f=t.pointToCoord(u);i?(h=v.startAngle,p=v.endAngle,g=-f[1]/180*Math.PI):(h=v.r0,p=v.r,g=f[0])}else{var m=n;i?(h=m.x,p=m.x+m.width,g=e.x):(h=m.y+m.height,p=m.y,g=e.y)}var y=p===h?0:(g-h)/(p-h);s&&(y=1-y);var b=ZC(c)?c(r):l*y+d,w=o.getSymbolPath(),k=w.getTextContent();o.attr({scaleX:0,scaleY:0}),o.animateTo({scaleX:1,scaleY:1},{duration:200,setToFinal:!0,delay:b}),k&&k.animateFrom({style:{opacity:0}},{duration:300,delay:b}),w.disableLabelAnimation=!0}})},t.prototype._initOrUpdateEndLabel=function(e,t,n){var i=e.getModel("endLabel");if(cK(e)){var a=e.getData(),r=this._polyline,s=a.getLayout("points");if(!s)return r.removeTextContent(),void(this._endLabel=null);var o=this._endLabel;o||((o=this._endLabel=new JP({z2:200})).ignoreClip=!0,r.setTextContent(this._endLabel),r.disableLabelAnimation=!0);var l=function(e){for(var t=e.length/2;t>0&&oK(e[2*t-2],e[2*t-1]);t--);return t-1}(s);l>=0&&(mL(r,yL(e,"endLabel"),{inheritColor:n,labelFetcher:e,labelDataIndex:l,defaultText:function(e,t,n){return null!=n?RQ(a,n):PQ(a,e)},enableTextSetter:!0},function(e,t){var n=t.getBaseAxis(),i=n.isHorizontal(),a=n.inverse,r=i?a?"right":"left":"center",s=i?"middle":a?"top":"bottom";return{normal:{align:e.get("align")||r,verticalAlign:e.get("verticalAlign")||s}}}(i,t)),r.textConfig.position=null)}else this._endLabel&&(this._polyline.removeTextContent(),this._endLabel=null)},t.prototype._endLabelOnDuring=function(e,t,n,i,a,r,s){var o=this._endLabel,l=this._polyline;if(o){e<1&&null==i.originalX&&(i.originalX=o.x,i.originalY=o.y);var c=n.getLayout("points"),d=n.hostModel,u=d.get("connectNulls"),h=r.get("precision"),p=r.get("distance")||0,g=s.getBaseAxis(),v=g.isHorizontal(),f=g.inverse,m=t.shape,y=f?v?m.x:m.y+m.height:v?m.x+m.width:m.y,b=(v?p:0)*(f?-1:1),w=(v?0:-p)*(f?-1:1),k=v?"x":"y",S=function(e,t,n){for(var i,a,r=e.length/2,s="x"===n?0:1,o=0,l=-1,c=0;c<r;c++)if(a=e[2*c+s],!isNaN(a)&&!isNaN(e[2*c+1-s]))if(0!==c){if(i<=t&&a>=t||i>=t&&a<=t){l=c;break}o=c,i=a}else i=a;return{range:[o,l],t:(t-i)/(a-i)}}(c,y,k),x=S.range,_=x[1]-x[0],C=void 0;if(_>=1){if(_>1&&!u){var I=lK(c,x[0]);o.attr({x:I[0]+b,y:I[1]+w}),a&&(C=d.getRawValue(x[0]))}else{(I=l.getPointOn(y,k))&&o.attr({x:I[0]+b,y:I[1]+w});var D=d.getRawValue(x[0]),T=d.getRawValue(x[1]);a&&(C=QE(n,h,D,T,S.t))}i.lastFrameIndex=x[0]}else{var M=1===e||i.lastFrameIndex>0?x[0]:0;I=lK(c,M);a&&(C=d.getRawValue(M)),o.attr({x:I[0]+b,y:I[1]+w})}if(a){var A=IL(o);"function"==typeof A.setLabelText&&A.setLabelText(C)}}},t.prototype._doUpdateAnimation=function(e,t,n,i,a,r,s){var o=this._polyline,l=this._polygon,c=e.hostModel,d=function(e,t,n,i,a,r,s){for(var o=function(e,t){var n=[];return t.diff(e).add(function(e){n.push({cmd:"+",idx:e})}).update(function(e,t){n.push({cmd:"=",idx:t,idx1:e})}).remove(function(e){n.push({cmd:"-",idx:e})}).execute(),n}(e,t),l=[],c=[],d=[],u=[],h=[],p=[],g=[],v=jQ(a,t,s),f=e.getLayout("points")||[],m=t.getLayout("points")||[],y=0;y<o.length;y++){var b=o[y],w=!0,k=void 0,S=void 0;switch(b.cmd){case"=":k=2*b.idx,S=2*b.idx1;var x=f[k],_=f[k+1],C=m[S],I=m[S+1];(isNaN(x)||isNaN(_))&&(x=C,_=I),l.push(x,_),c.push(C,I),d.push(n[k],n[k+1]),u.push(i[S],i[S+1]),g.push(t.getRawIndex(b.idx1));break;case"+":var D=b.idx,T=v.dataDimsForPoint,M=a.dataToPoint([t.get(T[0],D),t.get(T[1],D)]);S=2*D,l.push(M[0],M[1]),c.push(m[S],m[S+1]);var A=UQ(v,a,t,D);d.push(A[0],A[1]),u.push(i[S],i[S+1]),g.push(t.getRawIndex(D));break;case"-":w=!1}w&&(h.push(b),p.push(p.length))}p.sort(function(e,t){return g[e]-g[t]});var E=l.length,z=dW(E),P=dW(E),R=dW(E),$=dW(E),O=[];for(y=0;y<p.length;y++){var L=p[y],N=2*y,F=2*L;z[N]=l[F],z[N+1]=l[F+1],P[N]=c[F],P[N+1]=c[F+1],R[N]=d[F],R[N+1]=d[F+1],$[N]=u[F],$[N+1]=u[F+1],O[y]=h[L]}return{current:z,next:P,stackedOnCurrent:R,stackedOnNext:$,status:O}}(this._data,e,this._stackedOnPoints,t,this._coordSys,0,this._valueOrigin),u=d.current,h=d.stackedOnCurrent,p=d.next,g=d.stackedOnNext;if(a&&(h=aK(d.stackedOnCurrent,d.current,n,a,s),u=aK(d.current,null,n,a,s),g=aK(d.stackedOnNext,d.next,n,a,s),p=aK(d.next,null,n,a,s)),nK(u,p)>3e3||l&&nK(h,g)>3e3)return o.stopAnimation(),o.setShape({points:p}),void(l&&(l.stopAnimation(),l.setShape({points:p,stackedOnPoints:g})));o.shape.__points=d.current,o.shape.points=u;var v={shape:{points:p}};d.current!==u&&(v.shape.__points=d.next),o.stopAnimation(),SO(o,v,c),l&&(l.setShape({points:u,stackedOnPoints:h}),l.stopAnimation(),SO(l,{shape:{stackedOnPoints:g}},c),o.shape.points!==l.shape.points&&(l.shape.points=o.shape.points));for(var f=[],m=d.status,y=0;y<m.length;y++){if("="===m[y].cmd){var b=e.getItemGraphicEl(m[y].idx1);b&&f.push({el:b,ptIdx:y})}}o.animators&&o.animators.length&&o.animators[0].during(function(){l&&l.dirtyShape();for(var e=o.shape.__points,t=0;t<f.length;t++){var n=f[t].el,i=2*f[t].ptIdx;n.x=e[i],n.y=e[i+1],n.markRedraw()}})},t.prototype.remove=function(e){var t=this.group,n=this._data;this._lineGroup.removeAll(),this._symbolDraw.remove(!0),n&&n.eachItemGraphicEl(function(e,i){e.__temp&&(t.remove(e),n.setItemGraphicEl(i,null))}),this._polyline=this._polygon=this._coordSys=this._points=this._stackedOnPoints=this._endLabel=this._data=null},t.type="line",t}(sU);function hK(e,t){return{seriesType:e,plan:iU(),reset:function(e){var n=e.getData(),i=e.coordinateSystem,a=e.pipelineContext,r=t||a.large;if(i){var s=UC(i.dimensions,function(e){return n.mapDimension(e)}).slice(0,2),o=s.length,l=n.getCalculationInfo("stackResultDimension");UH(n,s[0])&&(s[0]=l),UH(n,s[1])&&(s[1]=l);var c=n.getStore(),d=n.getDimensionIndex(s[0]),u=n.getDimensionIndex(s[1]);return o&&{progress:function(e,t){for(var n=e.end-e.start,a=r&&dW(n*o),s=[],l=[],h=e.start,p=0;h<e.end;h++){var g=void 0;if(1===o){var v=c.get(d,h);g=i.dataToPoint(v,null,l)}else s[0]=c.get(d,h),s[1]=c.get(u,h),g=i.dataToPoint(s,null,l);r?(a[p++]=g[0],a[p++]=g[1]):t.setItemLayout(h,g.slice())}r&&t.setLayout("points",a)}}}}}}var pK={average:function(e){for(var t=0,n=0,i=0;i<e.length;i++)isNaN(e[i])||(t+=e[i],n++);return 0===n?NaN:t/n},sum:function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n]||0;return t},max:function(e){for(var t=-1/0,n=0;n<e.length;n++)e[n]>t&&(t=e[n]);return isFinite(t)?t:NaN},min:function(e){for(var t=1/0,n=0;n<e.length;n++)e[n]<t&&(t=e[n]);return isFinite(t)?t:NaN},nearest:function(e){return e[0]}},gK=function(e){return Math.round(e.length/2)};function vK(e){return{seriesType:e,reset:function(e,t,n){var i=e.getData(),a=e.get("sampling"),r=e.coordinateSystem,s=i.count();if(s>10&&"cartesian2d"===r.type&&a){var o=r.getBaseAxis(),l=r.getOtherAxis(o),c=o.getExtent(),d=n.getDevicePixelRatio(),u=Math.abs(c[1]-c[0])*(d||1),h=Math.round(s/u);if(isFinite(h)&&h>1){"lttb"===a?e.setData(i.lttbDownSample(i.mapDimension(l.dim),1/h)):"minmax"===a&&e.setData(i.minmaxDownSample(i.mapDimension(l.dim),1/h));var p=void 0;YC(a)?p=pK[a]:ZC(a)&&(p=a),p&&e.setData(i.downSample(i.mapDimension(l.dim),1/h,p,gK))}}}}}function fK(e){e.registerChartView(uK),e.registerSeriesModel(zQ),e.registerLayout(hK("line",!0)),e.registerVisual({seriesType:"line",reset:function(e){var t=e.getData(),n=e.getModel("lineStyle").getLineStyle();n&&!n.stroke&&(n.stroke=t.getVisual("style").fill),t.setVisual("legendLineStyle",n)}}),e.registerProcessor(e.PRIORITY.PROCESSOR.STATISTIC,vK("line"))}var mK=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.getInitialData=function(e,t){return qH(0,this,{useEncodeDefaulter:!0})},t.prototype.getMarkerPosition=function(e,t,n){var i=this.coordinateSystem;if(i&&i.clampData){var a=i.clampData(e),r=i.dataToPoint(a);if(n)jC(i.getAxes(),function(e,n){if("category"===e.type&&null!=t){var i=e.getTicksCoords(),s=e.getTickModel().get("alignWithLabel"),o=a[n],l="x1"===t[n]||"y1"===t[n];if(l&&!s&&(o+=1),i.length<2)return;if(2===i.length)return void(r[n]=e.toGlobalCoord(e.getExtent()[l?1:0]));for(var c=void 0,d=void 0,u=1,h=0;h<i.length;h++){var p=i[h].coord,g=h===i.length-1?i[h-1].tickValue+u:i[h].tickValue;if(g===o){d=p;break}if(g<o)c=p;else if(null!=c&&g>o){d=(p+c)/2;break}1===h&&(u=g-i[0].tickValue)}null==d&&(c?c&&(d=i[i.length-1].coord):d=i[0].coord),r[n]=e.toGlobalCoord(d)}});else{var s=this.getData(),o=s.getLayout("offset"),l=s.getLayout("size"),c=i.getBaseAxis().isHorizontal()?0:1;r[c]+=o+l/2}return r}return[NaN,NaN]},t.type="series.__base_bar__",t.defaultOption={z:2,coordinateSystem:"cartesian2d",legendHoverLink:!0,barMinHeight:0,barMinAngle:0,large:!1,largeThreshold:400,progressive:3e3,progressiveChunkMode:"mod",defaultBarGap:"10%"},t}(Qj);Qj.registerClass(mK);var yK=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.getInitialData=function(){return qH(0,this,{useEncodeDefaulter:!0,createInvertedIndices:!!this.get("realtimeSort",!0)||null})},t.prototype.getProgressive=function(){return!!this.get("large")&&this.get("progressive")},t.prototype.getProgressiveThreshold=function(){var e=this.get("progressiveThreshold"),t=this.get("largeThreshold");return t>e&&(e=t),e},t.prototype.brushSelector=function(e,t,n){return n.rect(t.getItemLayout(e))},t.type="series.bar",t.dependencies=["grid","polar"],t.defaultOption=VL(mK.defaultOption,{clip:!0,roundCap:!1,showBackground:!1,backgroundStyle:{color:"rgba(180, 180, 180, 0.2)",borderColor:null,borderWidth:0,borderType:"solid",borderRadius:0,shadowBlur:0,shadowColor:null,shadowOffsetX:0,shadowOffsetY:0,opacity:1},select:{itemStyle:{borderColor:uF.color.primary,borderWidth:2}},realtimeSort:!1}),t}(mK),bK=function(){return function(){this.cx=0,this.cy=0,this.r0=0,this.r=0,this.startAngle=0,this.endAngle=2*Math.PI,this.clockwise=!0}}(),wK=function(e){function t(t){var n=e.call(this,t)||this;return n.type="sausage",n}return uC(t,e),t.prototype.getDefaultShape=function(){return new bK},t.prototype.buildPath=function(e,t){var n=t.cx,i=t.cy,a=Math.max(t.r0||0,0),r=Math.max(t.r,0),s=.5*(r-a),o=a+s,l=t.startAngle,c=t.endAngle,d=t.clockwise,u=2*Math.PI,h=d?c-l<u:l-c<u;h||(l=c-(d?u:-u));var p=Math.cos(l),g=Math.sin(l),v=Math.cos(c),f=Math.sin(c);h?(e.moveTo(p*a+n,g*a+i),e.arc(p*o+n,g*o+i,s,-Math.PI+l,l,!d)):e.moveTo(p*r+n,g*r+i),e.arc(n,i,r,l,c,!d),e.arc(v*o+n,f*o+i,s,c-2*Math.PI,c-Math.PI,!d),0!==a&&e.arc(n,i,a,c,l,d)},t}(LP);function kK(e,t,n){return t*Math.sin(e)*(n?-1:1)}function SK(e,t,n){return t*Math.cos(e)*(n?1:-1)}function xK(e,t,n){var i=e.get("borderRadius");if(null==i)return n?{cornerRadius:0}:null;KC(i)||(i=[i,i,i,i]);var a=Math.abs(t.r||0-t.r0||0);return{cornerRadius:UC(i,function(e){return TA(e,a)})}}var _K=Math.max,CK=Math.min;var IK=function(e){function t(){var n=e.call(this)||this;return n.type=t.type,n._isFirstFrame=!0,n}return uC(t,e),t.prototype.render=function(e,t,n,i){this._model=e,this._removeOnRenderedListener(n),this._updateDrawMode(e);var a=e.get("coordinateSystem");"cartesian2d"!==a&&"polar"!==a||(this._progressiveEls=null,this._isLargeDraw?this._renderLarge(e,t,n):this._renderNormal(e,t,n,i))},t.prototype.incrementalPrepareRender=function(e){this._clear(),this._updateDrawMode(e),this._updateLargeClip(e)},t.prototype.incrementalRender=function(e,t){this._progressiveEls=[],this._incrementalRenderLarge(e,t)},t.prototype.eachRendered=function(e){rL(this._progressiveEls||this.group,e)},t.prototype._updateDrawMode=function(e){var t=e.pipelineContext.large;null!=this._isLargeDraw&&t===this._isLargeDraw||(this._isLargeDraw=t,this._clear())},t.prototype._renderNormal=function(e,t,n,i){var a,r=this.group,s=e.getData(),o=this._data,l=e.coordinateSystem,c=l.getBaseAxis();"cartesian2d"===l.type?a=c.isHorizontal():"polar"===l.type&&(a="angle"===c.dim);var d=e.isAnimationEnabled()?e:null,u=function(e,t){var n=e.get("realtimeSort",!0),i=t.getBaseAxis();if(n&&"category"===i.type&&"cartesian2d"===t.type)return{baseAxis:i,otherAxis:t.getOtherAxis(i)}}(e,l);u&&this._enableRealtimeSort(u,s,n);var h=e.get("clip",!0)||u,p=function(e,t){var n=e.getArea&&e.getArea();if(JQ(e,"cartesian2d")){var i=e.getBaseAxis();if("category"!==i.type||!i.onBand){var a=t.getLayout("bandWidth");i.isHorizontal()?(n.x-=a,n.width+=2*a):(n.y-=a,n.height+=2*a)}}return n}(l,s);r.removeClipPath();var g=e.get("roundCap",!0),v=e.get("showBackground",!0),f=e.getModel("backgroundStyle"),m=f.get("borderRadius")||0,y=[],b=this._backgroundEls,w=i&&i.isInitSort,k=i&&"changeAxisOrder"===i.type;function S(e){var t=RK[l.type](s,e);if(!t)return null;var n=function(e,t,n){var i="polar"===e.type?U$:KP;return new i({shape:jK(t,n,e),silent:!0,z2:0})}(l,a,t);return n.useStyle(f.getItemStyle()),"cartesian2d"===l.type?n.setShape("r",m):n.setShape("cornerRadius",m),y[e]=n,n}s.diff(o).add(function(t){var n=s.getItemModel(t),i=RK[l.type](s,t,n);if(i&&(v&&S(t),s.hasValue(t)&&PK[l.type](i))){var o=!1;h&&(o=DK[l.type](p,i));var f=TK[l.type](e,s,t,i,a,d,c.model,!1,g);u&&(f.forceLabelAnimation=!0),OK(f,s,t,n,i,e,a,"polar"===l.type),w?f.attr({shape:i}):u?MK(u,d,f,i,t,a,!1,!1):xO(f,{shape:i},e,t),s.setItemGraphicEl(t,f),r.add(f),f.ignore=o}}).update(function(t,n){var i=s.getItemModel(t),x=RK[l.type](s,t,i);if(x){if(v){var _=void 0;0===b.length?_=S(n):((_=b[n]).useStyle(f.getItemStyle()),"cartesian2d"===l.type?_.setShape("r",m):_.setShape("cornerRadius",m),y[t]=_);var C=RK[l.type](s,t);SO(_,{shape:jK(a,C,l)},d,t)}var I=o.getItemGraphicEl(n);if(s.hasValue(t)&&PK[l.type](x)){var D=!1;if(h&&(D=DK[l.type](p,x))&&r.remove(I),I&&("sector"===I.type&&g||"sausage"===I.type&&!g)&&(I&&DO(I,e,n),I=null),I?TO(I):I=TK[l.type](e,s,t,x,a,d,c.model,!0,g),u&&(I.forceLabelAnimation=!0),k){var T=I.getTextContent();if(T){var M=IL(T);null!=M.prevValue&&(M.prevValue=M.value)}}else OK(I,s,t,i,x,e,a,"polar"===l.type);w?I.attr({shape:x}):u?MK(u,d,I,x,t,a,!0,k):SO(I,{shape:x},e,t,null),s.setItemGraphicEl(t,I),I.ignore=D,r.add(I)}else r.remove(I)}}).remove(function(t){var n=o.getItemGraphicEl(t);n&&DO(n,e,t)}).execute();var x=this._backgroundGroup||(this._backgroundGroup=new jA);x.removeAll();for(var _=0;_<y.length;++_)x.add(y[_]);r.add(x),this._backgroundEls=y,this._data=s},t.prototype._renderLarge=function(e,t,n){this._clear(),FK(e,this.group),this._updateLargeClip(e)},t.prototype._incrementalRenderLarge=function(e,t){this._removeBackground(),FK(t,this.group,this._progressiveEls,!0)},t.prototype._updateLargeClip=function(e){var t=e.get("clip",!0)&&function(e,t,n,i,a){return e?"polar"===e.type?XQ(e,t,n):"cartesian2d"===e.type?YQ(e,t,n,i,a):null:null}(e.coordinateSystem,!1,e),n=this.group;t?n.setClipPath(t):n.removeClipPath()},t.prototype._enableRealtimeSort=function(e,t,n){var i=this;if(t.count()){var a=e.baseAxis;if(this._isFirstFrame)this._dispatchInitSort(t,e,n),this._isFirstFrame=!1;else{var r=function(e){var n=t.getItemGraphicEl(e),i=n&&n.shape;return i&&Math.abs(a.isHorizontal()?i.height:i.width)||0};this._onRendered=function(){i._updateSortWithinSameData(t,r,a,n)},n.getZr().on("rendered",this._onRendered)}}},t.prototype._dataSort=function(e,t,n){var i=[];return e.each(e.mapDimension(t.dim),function(e,t){var a=n(t);a=null==a?NaN:a,i.push({dataIndex:t,mappedValue:a,ordinalNumber:e})}),i.sort(function(e,t){return t.mappedValue-e.mappedValue}),{ordinalNumbers:UC(i,function(e){return e.ordinalNumber})}},t.prototype._isOrderChangedWithinSameData=function(e,t,n){for(var i=n.scale,a=e.mapDimension(n.dim),r=Number.MAX_VALUE,s=0,o=i.getOrdinalMeta().categories.length;s<o;++s){var l=e.rawIndexOf(a,i.getRawOrdinalNumber(s)),c=l<0?Number.MIN_VALUE:t(e.indexOfRawIndex(l));if(c>r)return!0;r=c}return!1},t.prototype._isOrderDifferentInView=function(e,t){for(var n=t.scale,i=n.getExtent(),a=Math.max(0,i[0]),r=Math.min(i[1],n.getOrdinalMeta().categories.length-1);a<=r;++a)if(e.ordinalNumbers[a]!==n.getRawOrdinalNumber(a))return!0},t.prototype._updateSortWithinSameData=function(e,t,n,i){if(this._isOrderChangedWithinSameData(e,t,n)){var a=this._dataSort(e,n,t);this._isOrderDifferentInView(a,n)&&(this._removeOnRenderedListener(i),i.dispatchAction({type:"changeAxisOrder",componentType:n.dim+"Axis",axisId:n.index,sortInfo:a}))}},t.prototype._dispatchInitSort=function(e,t,n){var i=t.baseAxis,a=this._dataSort(e,i,function(n){return e.get(e.mapDimension(t.otherAxis.dim),n)});n.dispatchAction({type:"changeAxisOrder",componentType:i.dim+"Axis",isInitSort:!0,axisId:i.index,sortInfo:a})},t.prototype.remove=function(e,t){this._clear(this._model),this._removeOnRenderedListener(t)},t.prototype.dispose=function(e,t){this._removeOnRenderedListener(t)},t.prototype._removeOnRenderedListener=function(e){this._onRendered&&(e.getZr().off("rendered",this._onRendered),this._onRendered=null)},t.prototype._clear=function(e){var t=this.group,n=this._data;e&&e.isAnimationEnabled()&&n&&!this._isLargeDraw?(this._removeBackground(),this._backgroundEls=[],n.eachItemGraphicEl(function(t){DO(t,e,uR(t).dataIndex)})):t.removeAll(),this._data=null,this._isFirstFrame=!0},t.prototype._removeBackground=function(){this.group.remove(this._backgroundGroup),this._backgroundGroup=null},t.type="bar",t}(sU),DK={cartesian2d:function(e,t){var n=t.width<0?-1:1,i=t.height<0?-1:1;n<0&&(t.x+=t.width,t.width=-t.width),i<0&&(t.y+=t.height,t.height=-t.height);var a=e.x+e.width,r=e.y+e.height,s=_K(t.x,e.x),o=CK(t.x+t.width,a),l=_K(t.y,e.y),c=CK(t.y+t.height,r),d=o<s,u=c<l;return t.x=d&&s>a?o:s,t.y=u&&l>r?c:l,t.width=d?0:o-s,t.height=u?0:c-l,n<0&&(t.x+=t.width,t.width=-t.width),i<0&&(t.y+=t.height,t.height=-t.height),d||u},polar:function(e,t){var n=t.r0<=t.r?1:-1;if(n<0){var i=t.r;t.r=t.r0,t.r0=i}var a=CK(t.r,e.r),r=_K(t.r0,e.r0);t.r=a,t.r0=r;var s=a-r<0;if(n<0){i=t.r;t.r=t.r0,t.r0=i}return s}},TK={cartesian2d:function(e,t,n,i,a,r,s,o,l){var c=new KP({shape:RC({},i),z2:1});(c.__dataIndex=n,c.name="item",r)&&(c.shape[a?"height":"width"]=0);return c},polar:function(e,t,n,i,a,r,s,o,l){var c=!a&&l?wK:U$,d=new c({shape:i,z2:1});d.name="item";var u,h,p=$K(a);if(d.calculateTextPosition=(u=p,h=({isRoundCap:c===wK}||{}).isRoundCap,function(e,t,n){var i=t.position;if(!i||i instanceof Array)return MA(e,t,n);var a=u(i),r=null!=t.distance?t.distance:5,s=this.shape,o=s.cx,l=s.cy,c=s.r,d=s.r0,p=(c+d)/2,g=s.startAngle,v=s.endAngle,f=(g+v)/2,m=h?Math.abs(c-d)/2:0,y=Math.cos,b=Math.sin,w=o+c*y(g),k=l+c*b(g),S="left",x="top";switch(a){case"startArc":w=o+(d-r)*y(f),k=l+(d-r)*b(f),S="center",x="top";break;case"insideStartArc":w=o+(d+r)*y(f),k=l+(d+r)*b(f),S="center",x="bottom";break;case"startAngle":w=o+p*y(g)+kK(g,r+m,!1),k=l+p*b(g)+SK(g,r+m,!1),S="right",x="middle";break;case"insideStartAngle":w=o+p*y(g)+kK(g,-r+m,!1),k=l+p*b(g)+SK(g,-r+m,!1),S="left",x="middle";break;case"middle":w=o+p*y(f),k=l+p*b(f),S="center",x="middle";break;case"endArc":w=o+(c+r)*y(f),k=l+(c+r)*b(f),S="center",x="bottom";break;case"insideEndArc":w=o+(c-r)*y(f),k=l+(c-r)*b(f),S="center",x="top";break;case"endAngle":w=o+p*y(v)+kK(v,r+m,!0),k=l+p*b(v)+SK(v,r+m,!0),S="left",x="middle";break;case"insideEndAngle":w=o+p*y(v)+kK(v,-r+m,!0),k=l+p*b(v)+SK(v,-r+m,!0),S="right",x="middle";break;default:return MA(e,t,n)}return(e=e||{}).x=w,e.y=k,e.align=S,e.verticalAlign=x,e}),r){var g=a?"r":"endAngle",v={};d.shape[g]=a?i.r0:i.startAngle,v[g]=i[g],(o?SO:xO)(d,{shape:v},r)}return d}};function MK(e,t,n,i,a,r,s,o){var l,c;r?(c={x:i.x,width:i.width},l={y:i.y,height:i.height}):(c={y:i.y,height:i.height},l={x:i.x,width:i.width}),o||(s?SO:xO)(n,{shape:l},t,a,null),(s?SO:xO)(n,{shape:c},t?e.baseAxis.model:null,a)}function AK(e,t){for(var n=0;n<t.length;n++)if(!isFinite(e[t[n]]))return!0;return!1}var EK=["x","y","width","height"],zK=["cx","cy","r","startAngle","endAngle"],PK={cartesian2d:function(e){return!AK(e,EK)},polar:function(e){return!AK(e,zK)}},RK={cartesian2d:function(e,t,n){var i=e.getItemLayout(t);if(!i)return null;var a=n?function(e,t){var n=e.get(["itemStyle","borderColor"]);if(!n||"none"===n)return 0;var i=e.get(["itemStyle","borderWidth"])||0,a=isNaN(t.width)?Number.MAX_VALUE:Math.abs(t.width),r=isNaN(t.height)?Number.MAX_VALUE:Math.abs(t.height);return Math.min(i,a,r)}(n,i):0,r=i.width>0?1:-1,s=i.height>0?1:-1;return{x:i.x+r*a/2,y:i.y+s*a/2,width:i.width-r*a,height:i.height-s*a}},polar:function(e,t,n){var i=e.getItemLayout(t);return{cx:i.cx,cy:i.cy,r0:i.r0,r:i.r,startAngle:i.startAngle,endAngle:i.endAngle,clockwise:i.clockwise}}};function $K(e){return function(e){var t=e?"Arc":"Angle";return function(e){switch(e){case"start":case"insideStart":case"end":case"insideEnd":return e+t;default:return e}}}(e)}function OK(e,t,n,i,a,r,s,o){var l=t.getItemVisual(n,"style");if(o){if(!r.get("roundCap")){var c=e.shape;RC(c,xK(i.getModel("itemStyle"),c,!0)),e.setShape(c)}}else{var d=i.get(["itemStyle","borderRadius"])||0;e.setShape("r",d)}e.useStyle(l);var u=i.getShallow("cursor");u&&e.attr("cursor",u);var h=o?s?a.r>=a.r0?"endArc":"startArc":a.endAngle>=a.startAngle?"endAngle":"startAngle":s?a.height>=0?"bottom":"top":a.width>=0?"right":"left",p=yL(i);mL(e,p,{labelFetcher:r,labelDataIndex:n,defaultText:PQ(r.getData(),n),inheritColor:l.fill,defaultOpacity:l.opacity,defaultOutsidePosition:h});var g=e.getTextContent();if(o&&g){var v=i.get(["label","position"]);e.textConfig.inside="middle"===v||null,function(e,t,n,i){if(JC(i))e.setTextConfig({rotation:i});else if(KC(t))e.setTextConfig({rotation:0});else{var a,r=e.shape,s=r.clockwise?r.startAngle:r.endAngle,o=r.clockwise?r.endAngle:r.startAngle,l=(s+o)/2,c=n(t);switch(c){case"startArc":case"insideStartArc":case"middle":case"insideEndArc":case"endArc":a=l;break;case"startAngle":case"insideStartAngle":a=s;break;case"endAngle":case"insideEndAngle":a=o;break;default:return void e.setTextConfig({rotation:0})}var d=1.5*Math.PI-a;"middle"===c&&d>Math.PI/2&&d<1.5*Math.PI&&(d-=Math.PI),e.setTextConfig({rotation:d})}}(e,"outside"===v?h:v,$K(s),i.get(["label","rotate"]))}!function(e,t,n,i){if(e){var a=IL(e);a.prevValue=a.value,a.value=n;var r=t.normal;a.valueAnimation=r.get("valueAnimation"),a.valueAnimation&&(a.precision=r.get("precision"),a.defaultInterpolatedText=i,a.statesModels=t)}}(g,p,r.getRawValue(n),function(e){return RQ(t,e)});var f=i.getModel(["emphasis"]);JR(e,f.get("focus"),f.get("blurScope"),f.get("disabled")),n$(e,i),function(e){return null!=e.startAngle&&null!=e.endAngle&&e.startAngle===e.endAngle}(a)&&(e.style.fill="none",e.style.stroke="none",jC(e.states,function(e){e.style&&(e.style.fill=e.style.stroke="none")}))}var LK=function(){return function(){}}(),NK=function(e){function t(t){var n=e.call(this,t)||this;return n.type="largeBar",n}return uC(t,e),t.prototype.getDefaultShape=function(){return new LK},t.prototype.buildPath=function(e,t){for(var n=t.points,i=this.baseDimIdx,a=1-this.baseDimIdx,r=[],s=[],o=this.barWidth,l=0;l<n.length;l+=3)s[i]=o,s[a]=n[l+2],r[i]=n[l+i],r[a]=n[l+a],e.rect(r[0],r[1],s[0],s[1])},t}(LP);function FK(e,t,n,i){var a=e.getData(),r=a.getLayout("valueAxisHorizontal")?1:0,s=a.getLayout("largeDataIndices"),o=a.getLayout("size"),l=e.getModel("backgroundStyle"),c=a.getLayout("largeBackgroundPoints");if(c){var d=new NK({shape:{points:c},incremental:!!i,silent:!0,z2:0});d.baseDimIdx=r,d.largeDataIndices=s,d.barWidth=o,d.useStyle(l.getItemStyle()),t.add(d),n&&n.push(d)}var u=new NK({shape:{points:a.getLayout("largePoints")},incremental:!!i,ignoreCoarsePointer:!0,z2:1});u.baseDimIdx=r,u.largeDataIndices=s,u.barWidth=o,t.add(u),u.useStyle(a.getVisual("style")),u.style.stroke=null,uR(u).seriesIndex=e.seriesIndex,e.get("silent")||(u.on("mousedown",BK),u.on("mousemove",BK)),n&&n.push(u)}var BK=vU(function(e){var t=function(e,t,n){for(var i=e.baseDimIdx,a=1-i,r=e.shape.points,s=e.largeDataIndices,o=[],l=[],c=e.barWidth,d=0,u=r.length/3;d<u;d++){var h=3*d;if(l[i]=c,l[a]=r[h+2],o[i]=r[h+i],o[a]=r[h+a],l[a]<0&&(o[a]+=l[a],l[a]=-l[a]),t>=o[0]&&t<=o[0]+l[0]&&n>=o[1]&&n<=o[1]+l[1])return s[d]}return-1}(this,e.offsetX,e.offsetY);uR(this).dataIndex=t>=0?t:null},30,!1);function jK(e,t,n){if(JQ(n,"cartesian2d")){var i=t,a=n.getArea();return{x:e?i.x:a.x,y:e?a.y:i.y,width:e?i.width:a.width,height:e?a.height:i.height}}var r=t;return{cx:(a=n.getArea()).cx,cy:a.cy,r0:e?a.r0:r.r0,r:e?a.r:r.r,startAngle:e?r.startAngle:0,endAngle:e?r.endAngle:2*Math.PI}}function UK(e){e.registerChartView(IK),e.registerSeriesModel(yK),e.registerLayout(e.PRIORITY.VISUAL.LAYOUT,QC(vW,"bar")),e.registerLayout(e.PRIORITY.VISUAL.PROGRESSIVE_LAYOUT,{seriesType:"bar",plan:iU(),reset:function(e){if(fW(e)){var t=e.getData(),n=e.coordinateSystem,i=n.getBaseAxis(),a=n.getOtherAxis(i),r=t.getDimensionIndex(t.mapDimension(a.dim)),s=t.getDimensionIndex(t.mapDimension(i.dim)),o=e.get("showBackground",!0),l=t.mapDimension(a.dim),c=t.getCalculationInfo("stackResultDimension"),d=UH(t,l)&&!!t.getCalculationInfo("stackedOnSeries"),u=a.isHorizontal(),h=function(e,t){var n=t.model.get("startValue");return n||(n=0),t.toGlobalCoord(t.dataToCoord("log"===t.type?n>0?n:1:n))}(0,a),p=mW(e),g=e.get("barMinHeight")||0,v=c&&t.getDimensionIndex(c),f=t.getLayout("size"),m=t.getLayout("offset");return{progress:function(e,t){for(var i,a=e.count,l=p&&dW(3*a),c=p&&o&&dW(3*a),y=p&&dW(a),b=n.master.getRect(),w=u?b.width:b.height,k=t.getStore(),S=0;null!=(i=e.next());){var x=k.get(d?v:r,i),_=k.get(s,i),C=h,I=void 0;d&&(I=+x-k.get(r,i));var D=void 0,T=void 0,M=void 0,A=void 0;if(u){var E=n.dataToPoint([x,_]);d&&(C=n.dataToPoint([I,_])[0]),D=C,T=E[1]+m,M=E[0]-C,A=f,Math.abs(M)<g&&(M=(M<0?-1:1)*g)}else E=n.dataToPoint([_,x]),d&&(C=n.dataToPoint([_,I])[1]),D=E[0]+m,T=C,M=f,A=E[1]-C,Math.abs(A)<g&&(A=(A<=0?-1:1)*g);p?(l[S]=D,l[S+1]=T,l[S+2]=u?M:A,c&&(c[S]=u?b.x:D,c[S+1]=u?T:b.y,c[S+2]=w),y[i]=i):t.setItemLayout(i,{x:D,y:T,width:M,height:A}),S+=3}p&&t.setLayout({largePoints:l,largeDataIndices:y,largeBackgroundPoints:c,valueAxisHorizontal:u})}}}}}),e.registerProcessor(e.PRIORITY.PROCESSOR.STATISTIC,vK("bar")),e.registerAction({type:"changeAxisOrder",event:"changeAxisOrder",update:"update"},function(e,t){var n=e.componentType||"series";t.eachComponent({mainType:n,query:e},function(t){e.sortInfo&&t.axis.setCategorySortInfo(e.sortInfo)})})}var VK=2*Math.PI,qK=Math.PI/180;function HK(e,t,n){t.eachSeriesByType(e,function(e){var t=e.getData(),i=t.mapDimension("value"),a=tF(e,n),r=a.cx,s=a.cy,o=a.r,l=a.r0,c=a.viewRect,d=-e.get("startAngle")*qK,u=e.get("endAngle"),h=e.get("padAngle")*qK;u="auto"===u?d-VK:-u*qK;var p=e.get("minAngle")*qK+h,g=0;t.each(i,function(e){!isNaN(e)&&g++});var v=t.getSum(i),f=Math.PI/(v||g)*2,m=e.get("clockwise"),y=e.get("roseType"),b=e.get("stillShowZeroSum"),w=t.getDataExtent(i);w[0]=0;var k=m?1:-1,S=[d,u],x=k*h/2;vP(S,!m),d=S[0],u=S[1];var _=WK(e);_.startAngle=d,_.endAngle=u,_.clockwise=m,_.cx=r,_.cy=s,_.r=o,_.r0=l;var C=Math.abs(u-d),I=C,D=0,T=d;if(t.setLayout({viewRect:c,r:o}),t.each(i,function(e,n){var i;if(isNaN(e))t.setItemLayout(n,{angle:NaN,startAngle:NaN,endAngle:NaN,clockwise:m,cx:r,cy:s,r0:l,r:y?NaN:o});else{(i="area"!==y?0===v&&b?f:e*f:C/g)<p?(i=p,I-=p):D+=e;var a=T+k*i,c=0,d=0;h>i?d=c=T+k*i/2:(c=T+x,d=a-x),t.setItemLayout(n,{angle:i,startAngle:c,endAngle:d,clockwise:m,cx:r,cy:s,r0:l,r:y?eE(e,w,[l,o]):o}),T=a}}),I<VK&&g)if(I<=.001){var M=C/g;t.each(i,function(e,n){if(!isNaN(e)){var i=t.getItemLayout(n);i.angle=M;var a=0,r=0;M<h?r=a=d+k*(n+.5)*M:(a=d+k*n*M+x,r=d+k*(n+1)*M-x),i.startAngle=a,i.endAngle=r}})}else f=I/D,T=d,t.each(i,function(e,n){if(!isNaN(e)){var i=t.getItemLayout(n),a=i.angle===p?p:e*f,r=0,s=0;a<h?s=r=T+k*a/2:(r=T+x,s=T+k*a-x),i.startAngle=r,i.endAngle=s,T+=k*a}})})}var WK=BE();var GK=Math.PI/180;function QK(e,t,n,i,a,r,s,o,l,c){if(!(e.length<2)){for(var d=e.length,u=0;u<d;u++)if("outer"===e[u].position&&"labelLine"===e[u].labelAlignTo){var h=e[u].label.x-c;e[u].linePoints[1][0]+=h,e[u].label.x=c}mQ(e,1,l,l+s)&&function(e){for(var r={list:[],maxY:0},s={list:[],maxY:0},o=0;o<e.length;o++)if("none"===e[o].labelAlignTo){var l=e[o],c=l.label.y>n?s:r,d=Math.abs(l.label.y-n);if(d>=c.maxY){var u=l.label.x-t-l.len2*a,h=i+l.len,g=Math.abs(u)<h?Math.sqrt(d*d/(1-u*u/h/h)):h;c.rB=g,c.maxY=d}c.list.push(l)}p(r),p(s)}(e)}function p(e){for(var r=e.rB,s=r*r,o=0;o<e.list.length;o++){var l=e.list[o],c=Math.abs(l.label.y-n),d=i+l.len,u=d*d,h=Math.sqrt(Math.abs((1-c*c/s)*u)),p=t+(h+l.len2)*a,g=p-l.label.x;KK(l,l.targetTextWidth-g*a,!0),l.label.x=p}}}function KK(e,t,n){if(null==e.labelStyleWidth){var i=e.label,a=i.style,r=e.rect,s=a.backgroundColor,o=a.padding,l=o?o[1]+o[3]:0,c=a.overflow,d=r.width+(s?0:l);if(t<d||n){if(c&&c.match("break")){i.setStyle("backgroundColor",null),i.setStyle("width",t-l);var u=i.getBoundingRect();i.setStyle("width",Math.ceil(u.width)),i.setStyle("backgroundColor",s)}else{var h=t-l,p=t<d?h:n?h>e.unconstrainedWidth?null:h:null;i.setStyle("width",p)}ZK(r,i)}}}function ZK(e,t){XK.rect=e,pQ(XK,t,YK)}var YK={minMarginForce:[null,0,null,0],marginDefault:[1,0,1,0]},XK={};function JK(e){return"center"===e.position}function eZ(e){var t,n,i=e.getData(),a=[],r=!1,s=(e.get("minShowLabelAngle")||0)*GK,o=i.getLayout("viewRect"),l=i.getLayout("r"),c=o.width,d=o.x,u=o.y,h=o.height;function p(e){e.ignore=!0}i.each(function(e){var o=i.getItemGraphicEl(e),u=o.shape,g=o.getTextContent(),v=o.getTextGuideLine(),f=i.getItemModel(e),m=f.getModel("label"),y=m.get("position")||f.get(["emphasis","label","position"]),b=m.get("distanceToLabelLine"),w=m.get("alignTo"),k=tE(m.get("edgeDistance"),c),S=m.get("bleedMargin");null==S&&(S=Math.min(c,h)>200?10:2);var x=f.getModel("labelLine"),_=x.get("length");_=tE(_,c);var C=x.get("length2");if(C=tE(C,c),Math.abs(u.endAngle-u.startAngle)<s)return jC(g.states,p),g.ignore=!0,void(v&&(jC(v.states,p),v.ignore=!0));if(function(e){if(!e.ignore)return!0;for(var t in e.states)if(!1===e.states[t].ignore)return!0;return!1}(g)){var I,D,T,M,A=(u.startAngle+u.endAngle)/2,E=Math.cos(A),z=Math.sin(A);t=u.cx,n=u.cy;var P="inside"===y||"inner"===y;if("center"===y)I=u.cx,D=u.cy,M="center";else{var R=(P?(u.r+u.r0)/2*E:u.r*E)+t,$=(P?(u.r+u.r0)/2*z:u.r*z)+n;if(I=R+3*E,D=$+3*z,!P){var O=R+E*(_+l-u.r),L=$+z*(_+l-u.r),N=O+(E<0?-1:1)*C;I="edge"===w?E<0?d+k:d+c-k:N+(E<0?-b:b),D=L,T=[[R,$],[O,L],[N,L]]}M=P?"center":"edge"===w?E>0?"right":"left":E>0?"left":"right"}var F=Math.PI,B=0,j=m.get("rotate");if(JC(j))B=j*(F/180);else if("center"===y)B=0;else if("radial"===j||!0===j){B=E<0?-A+F:-A}else if("tangential"===j&&"outside"!==y&&"outer"!==y){var U=Math.atan2(E,z);U<0&&(U=2*F+U),z>0&&(U=F+U),B=U-F}if(r=!!B,g.x=I,g.y=D,g.rotation=B,g.setStyle({verticalAlign:"middle"}),P){g.setStyle({align:M});var V=g.states.select;V&&(V.x+=g.x,V.y+=g.y)}else{var q=new GD(0,0,0,0);ZK(q,g),a.push({label:g,labelLine:v,position:y,len:_,len2:C,minTurnAngle:x.get("minTurnAngle"),maxSurfaceAngle:x.get("maxSurfaceAngle"),surfaceNormal:new PD(E,z),linePoints:T,textAlign:M,labelDistance:b,labelAlignTo:w,edgeDistance:k,bleedMargin:S,rect:q,unconstrainedWidth:q.width,labelStyleWidth:g.style.width})}o.setTextConfig({inside:P})}}),!r&&e.get("avoidLabelOverlap")&&function(e,t,n,i,a,r,s,o){for(var l=[],c=[],d=Number.MAX_VALUE,u=-Number.MAX_VALUE,h=0;h<e.length;h++){var p=e[h].label;JK(e[h])||(p.x<t?(d=Math.min(d,p.x),l.push(e[h])):(u=Math.max(u,p.x),c.push(e[h])))}for(h=0;h<e.length;h++)if(!JK(f=e[h])&&f.linePoints){if(null!=f.labelStyleWidth)continue;p=f.label;var g=f.linePoints,v=void 0;v="edge"===f.labelAlignTo?p.x<t?g[2][0]-f.labelDistance-s-f.edgeDistance:s+a-f.edgeDistance-g[2][0]-f.labelDistance:"labelLine"===f.labelAlignTo?p.x<t?d-s-f.bleedMargin:s+a-u-f.bleedMargin:p.x<t?p.x-s-f.bleedMargin:s+a-p.x-f.bleedMargin,f.targetTextWidth=v,KK(f,v,!1)}for(QK(c,t,n,i,1,0,r,0,o,u),QK(l,t,n,i,-1,0,r,0,o,d),h=0;h<e.length;h++){var f;if(!JK(f=e[h])&&f.linePoints){p=f.label,g=f.linePoints;var m="edge"===f.labelAlignTo,y=p.style.padding,b=y?y[1]+y[3]:0,w=p.style.backgroundColor?0:b,k=f.rect.width+w,S=g[1][0]-g[2][0];m?p.x<t?g[2][0]=s+f.edgeDistance+k+f.labelDistance:g[2][0]=s+a-f.edgeDistance-k-f.labelDistance:(p.x<t?g[2][0]=p.x+f.labelDistance:g[2][0]=p.x-f.labelDistance,g[1][0]=g[2][0]+S),g[1][1]=g[2][1]=p.y}}}(a,t,n,l,c,h,d,u);for(var g=0;g<a.length;g++){var v=a[g],f=v.label,m=v.labelLine,y=isNaN(f.x)||isNaN(f.y);if(f){f.setStyle({align:v.textAlign}),y&&(jC(f.states,p),f.ignore=!0);var b=f.states.select;b&&(b.x+=f.x,b.y+=f.y)}if(m){var w=v.linePoints;y||!w?(jC(m.states,p),m.ignore=!0):(iQ(w,v.minTurnAngle),aQ(w,v.surfaceNormal,v.maxSurfaceAngle),m.setShape({points:w}),f.__hostTarget.textGuideLineConfig={anchor:new PD(w[0][0],w[0][1])})}}}var tZ=function(e){function t(t,n,i){var a=e.call(this)||this;a.z2=2;var r=new JP;return a.setTextContent(r),a.updateData(t,n,i,!0),a}return uC(t,e),t.prototype.updateData=function(e,t,n,i){var a=this,r=e.hostModel,s=e.getItemModel(t),o=s.getModel("emphasis"),l=e.getItemLayout(t),c=RC(xK(s.getModel("itemStyle"),l,!0),l);if(isNaN(c.startAngle))a.setShape(c);else{if(i){a.setShape(c);var d=r.getShallow("animationType");r.ecModel.ssr?(xO(a,{scaleX:0,scaleY:0},r,{dataIndex:t,isFrom:!0}),a.originX=c.cx,a.originY=c.cy):"scale"===d?(a.shape.r=l.r0,xO(a,{shape:{r:l.r}},r,t)):null!=n?(a.setShape({startAngle:n,endAngle:n}),xO(a,{shape:{startAngle:l.startAngle,endAngle:l.endAngle}},r,t)):(a.shape.endAngle=l.startAngle,SO(a,{shape:{endAngle:l.endAngle}},r,t))}else TO(a),SO(a,{shape:c},r,t);a.useStyle(e.getItemVisual(t,"style")),n$(a,s);var u=(l.startAngle+l.endAngle)/2,h=r.get("selectedOffset"),p=Math.cos(u)*h,g=Math.sin(u)*h,v=s.getShallow("cursor");v&&a.attr("cursor",v),this._updateLabel(r,e,t),a.ensureState("emphasis").shape=RC({r:l.r+(o.get("scale")&&o.get("scaleSize")||0)},xK(o.getModel("itemStyle"),l)),RC(a.ensureState("select"),{x:p,y:g,shape:xK(s.getModel(["select","itemStyle"]),l)}),RC(a.ensureState("blur"),{shape:xK(s.getModel(["blur","itemStyle"]),l)});var f=a.getTextGuideLine(),m=a.getTextContent();f&&RC(f.ensureState("select"),{x:p,y:g}),RC(m.ensureState("select"),{x:p,y:g}),JR(this,o.get("focus"),o.get("blurScope"),o.get("disabled"))}},t.prototype._updateLabel=function(e,t,n){var i=this,a=t.getItemModel(n),r=a.getModel("labelLine"),s=t.getItemVisual(n,"style"),o=s&&s.fill,l=s&&s.opacity;mL(i,yL(a),{labelFetcher:t.hostModel,labelDataIndex:n,inheritColor:o,defaultOpacity:l,defaultText:e.getFormattedLabel(n,"normal")||t.getName(n)});var c=i.getTextContent();i.setTextConfig({position:null,rotation:null}),c.attr({z2:10});var d=a.get(["label","position"]);if("outside"!==d&&"outer"!==d)i.removeTextGuideLine();else{var u=this.getTextGuideLine();u||(u=new K$,this.setTextGuideLine(u)),oQ(this,lQ(a),{stroke:o,opacity:dI(r.get(["lineStyle","opacity"]),l,1)})}},t}(U$),nZ=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.ignoreLabelLineUpdate=!0,t}return uC(t,e),t.prototype.render=function(e,t,n,i){var a,r=e.getData(),s=this._data,o=this.group;if(!s&&r.count()>0){for(var l=r.getItemLayout(0),c=1;isNaN(l&&l.startAngle)&&c<r.count();++c)l=r.getItemLayout(c);l&&(a=l.startAngle)}if(this._emptyCircleSector&&o.remove(this._emptyCircleSector),0===r.count()&&e.get("showEmptyCircle")){var d=WK(e),u=new U$({shape:zC(d)});u.useStyle(e.getModel("emptyCircleStyle").getItemStyle()),this._emptyCircleSector=u,o.add(u)}r.diff(s).add(function(e){var t=new tZ(r,e,a);r.setItemGraphicEl(e,t),o.add(t)}).update(function(e,t){var n=s.getItemGraphicEl(t);n.updateData(r,e,a),n.off("click"),o.add(n),r.setItemGraphicEl(e,n)}).remove(function(t){DO(s.getItemGraphicEl(t),e,t)}).execute(),eZ(e),"expansion"!==e.get("animationTypeUpdate")&&(this._data=r)},t.prototype.dispose=function(){},t.prototype.containPoint=function(e,t){var n=t.getData().getItemLayout(0);if(n){var i=e[0]-n.cx,a=e[1]-n.cy,r=Math.sqrt(i*i+a*a);return r<=n.r&&r>=n.r0}},t.type="pie",t}(sU);var iZ,aZ=function(){function e(e,t){this._getDataWithEncodedVisual=e,this._getRawData=t}return e.prototype.getAllNames=function(){var e=this._getRawData();return e.mapArray(e.getName)},e.prototype.containName=function(e){return this._getRawData().indexOfName(e)>=0},e.prototype.indexOfName=function(e){return this._getDataWithEncodedVisual().indexOfName(e)},e.prototype.getItemVisual=function(e,t){return this._getDataWithEncodedVisual().getItemVisual(e,t)},e}(),rZ=BE(),sZ=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.init=function(t){e.prototype.init.apply(this,arguments),this.legendVisualProvider=new aZ(GC(this.getData,this),GC(this.getRawData,this)),this._defaultLabelLine(t)},t.prototype.mergeOption=function(){e.prototype.mergeOption.apply(this,arguments)},t.prototype.getInitialData=function(){return function(e,t,n){t=KC(t)&&{coordDimensions:t}||RC({encodeDefine:e.getEncode()},t);var i=e.getSource(),a=OH(i,t).dimensions,r=new $H(a,e);return r.initData(i,n),r}(this,{coordDimensions:["value"],encodeDefaulter:QC(RF,this)})},t.prototype.getDataParams=function(t){var n=this.getData(),i=rZ(n),a=i.seats;if(!a){var r=[];n.each(n.mapDimension("value"),function(e){r.push(e)}),a=i.seats=lE(r,n.hostModel.get("percentPrecision"))}var s=e.prototype.getDataParams.call(this,t);return s.percent=a[t]||0,s.$vars.push("percent"),s},t.prototype._defaultLabelLine=function(e){ME(e,"labelLine",["show"]);var t=e.labelLine,n=e.emphasis.labelLine;t.show=t.show&&e.label.show,n.show=n.show&&e.emphasis.label.show},t.type="series.pie",t.defaultOption={z:2,legendHoverLink:!0,colorBy:"data",center:["50%","50%"],radius:[0,"50%"],clockwise:!0,startAngle:90,endAngle:"auto",padAngle:0,minAngle:0,minShowLabelAngle:0,selectedOffset:10,percentPrecision:2,stillShowZeroSum:!0,coordinateSystemUsage:"box",left:0,top:0,right:0,bottom:0,width:null,height:null,label:{rotate:0,show:!0,overflow:"truncate",position:"outer",alignTo:"none",edgeDistance:"25%",distanceToLabelLine:5},labelLine:{show:!0,length:15,length2:30,smooth:!1,minTurnAngle:90,maxSurfaceAngle:90,lineStyle:{width:1,type:"solid"}},itemStyle:{borderWidth:1,borderJoin:"round"},showEmptyCircle:!0,emptyCircleStyle:{color:"lightgray",opacity:1},labelLayout:{hideOverlap:!0},emphasis:{scale:!0,scaleSize:5},avoidLabelOverlap:!0,animationType:"expansion",animationDuration:1e3,animationTypeUpdate:"transition",animationEasingUpdate:"cubicInOut",animationDurationUpdate:500,animationEasing:"cubicInOut"},t}(Qj);iZ={fullType:sZ.type,getCoord2:function(e){return e.getShallow("center")}},HN.set(iZ.fullType,{getCoord2:void 0}).getCoord2=iZ.getCoord2;var oZ=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.hasSymbolVisual=!0,n}return uC(t,e),t.prototype.getInitialData=function(e,t){return qH(0,this,{useEncodeDefaulter:!0})},t.prototype.getProgressive=function(){var e=this.option.progressive;return null==e?this.option.large?5e3:this.get("progressive"):e},t.prototype.getProgressiveThreshold=function(){var e=this.option.progressiveThreshold;return null==e?this.option.large?1e4:this.get("progressiveThreshold"):e},t.prototype.brushSelector=function(e,t,n){return n.point(t.getItemLayout(e))},t.prototype.getZLevelKey=function(){return this.getData().count()>this.getProgressiveThreshold()?this.id:""},t.type="series.scatter",t.dependencies=["grid","polar","geo","singleAxis","calendar","matrix"],t.defaultOption={coordinateSystem:"cartesian2d",z:2,legendHoverLink:!0,symbolSize:10,large:!1,largeThreshold:2e3,itemStyle:{opacity:.8},emphasis:{scale:!0},clip:!0,select:{itemStyle:{borderColor:uF.color.primary}},universalTransition:{divideShape:"clone"}},t}(Qj),lZ=function(){return function(){}}(),cZ=function(e){function t(t){var n=e.call(this,t)||this;return n._off=0,n.hoverDataIdx=-1,n}return uC(t,e),t.prototype.getDefaultShape=function(){return new lZ},t.prototype.reset=function(){this.notClear=!1,this._off=0},t.prototype.buildPath=function(e,t){var n,i=t.points,a=t.size,r=this.symbolProxy,s=r.shape,o=e.getContext?e.getContext():e,l=o&&a[0]<4,c=this.softClipShape;if(l)this._ctx=o;else{for(this._ctx=null,n=this._off;n<i.length;){var d=i[n++],u=i[n++];isNaN(d)||isNaN(u)||(c&&!c.contain(d,u)||(s.x=d-a[0]/2,s.y=u-a[1]/2,s.width=a[0],s.height=a[1],r.buildPath(e,s,!0)))}this.incremental&&(this._off=n,this.notClear=!0)}},t.prototype.afterBrush=function(){var e,t=this.shape,n=t.points,i=t.size,a=this._ctx,r=this.softClipShape;if(a){for(e=this._off;e<n.length;){var s=n[e++],o=n[e++];isNaN(s)||isNaN(o)||(r&&!r.contain(s,o)||a.fillRect(s-i[0]/2,o-i[1]/2,i[0],i[1]))}this.incremental&&(this._off=e,this.notClear=!0)}},t.prototype.findDataIndex=function(e,t){for(var n=this.shape,i=n.points,a=n.size,r=Math.max(a[0],4),s=Math.max(a[1],4),o=i.length/2-1;o>=0;o--){var l=2*o,c=i[l]-r/2,d=i[l+1]-s/2;if(e>=c&&t>=d&&e<=c+r&&t<=d+s)return o}return-1},t.prototype.contain=function(e,t){var n=this.transformCoordToLocal(e,t),i=this.getBoundingRect();return e=n[0],t=n[1],i.contain(e,t)?(this.hoverDataIdx=this.findDataIndex(e,t))>=0:(this.hoverDataIdx=-1,!1)},t.prototype.getBoundingRect=function(){var e=this._rect;if(!e){for(var t=this.shape,n=t.points,i=t.size,a=i[0],r=i[1],s=1/0,o=1/0,l=-1/0,c=-1/0,d=0;d<n.length;){var u=n[d++],h=n[d++];s=Math.min(u,s),l=Math.max(u,l),o=Math.min(h,o),c=Math.max(h,c)}e=this._rect=new GD(s-a/2,o-r/2,l-s+a,c-o+r)}return e},t}(LP),dZ=function(){function e(){this.group=new jA}return e.prototype.updateData=function(e,t){this._clear();var n=this._create();n.setShape({points:e.getLayout("points")}),this._setCommon(n,e,t)},e.prototype.updateLayout=function(e){var t=e.getLayout("points");this.group.eachChild(function(e){if(null!=e.startIndex){var n=2*(e.endIndex-e.startIndex),i=4*e.startIndex*2;t=new Float32Array(t.buffer,i,n)}e.setShape("points",t),e.reset()})},e.prototype.incrementalPrepareUpdate=function(e){this._clear()},e.prototype.incrementalUpdate=function(e,t,n){var i=this._newAdded[0],a=t.getLayout("points"),r=i&&i.shape.points;if(r&&r.length<2e4){var s=r.length,o=new Float32Array(s+a.length);o.set(r),o.set(a,s),i.endIndex=e.end,i.setShape({points:o})}else{this._newAdded=[];var l=this._create();l.startIndex=e.start,l.endIndex=e.end,l.incremental=!0,l.setShape({points:a}),this._setCommon(l,t,n)}},e.prototype.eachRendered=function(e){this._newAdded[0]&&e(this._newAdded[0])},e.prototype._create=function(){var e=new cZ({cursor:"default"});return e.ignoreCoarsePointer=!0,this.group.add(e),this._newAdded.push(e),e},e.prototype._setCommon=function(e,t,n){var i=t.hostModel;n=n||{};var a=t.getVisual("symbolSize");e.setShape("size",a instanceof Array?a:[a,a]),e.softClipShape=n.clipShape||null,e.symbolProxy=vV(t.getVisual("symbol"),0,0,0,0),e.setColor=e.symbolProxy.setColor;var r=e.shape.size[0]<4;e.useStyle(i.getModel("itemStyle").getItemStyle(r?["color","shadowBlur","shadowColor"]:["color"]));var s=t.getVisual("style"),o=s&&s.fill;o&&e.setColor(o);var l=uR(e);l.seriesIndex=i.seriesIndex,e.on("mousemove",function(t){l.dataIndex=null;var n=e.hoverDataIdx;n>=0&&(l.dataIndex=n+(e.startIndex||0))})},e.prototype.remove=function(){this._clear()},e.prototype._clear=function(){this._newAdded=[],this.group.removeAll()},e}(),uZ=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.render=function(e,t,n){var i=e.getData();this._updateSymbolDraw(i,e).updateData(i,{clipShape:this._getClipShape(e)}),this._finished=!0},t.prototype.incrementalPrepareRender=function(e,t,n){var i=e.getData();this._updateSymbolDraw(i,e).incrementalPrepareUpdate(i),this._finished=!1},t.prototype.incrementalRender=function(e,t,n){this._symbolDraw.incrementalUpdate(e,t.getData(),{clipShape:this._getClipShape(t)}),this._finished=e.end===t.getData().count()},t.prototype.updateTransform=function(e,t,n){var i=e.getData();if(this.group.dirty(),!this._finished||i.count()>1e4)return{update:!0};var a=hK("").reset(e,t,n);a.progress&&a.progress({start:0,end:i.count(),count:i.count()},i),this._symbolDraw.updateLayout(i)},t.prototype.eachRendered=function(e){this._symbolDraw&&this._symbolDraw.eachRendered(e)},t.prototype._getClipShape=function(e){if(e.get("clip",!0)){var t=e.coordinateSystem;return t&&t.getArea&&t.getArea(.1)}},t.prototype._updateSymbolDraw=function(e,t){var n=this._symbolDraw,i=t.pipelineContext.large;return n&&i===this._isLargeDraw||(n&&n.remove(),n=this._symbolDraw=i?new dZ:new BQ,this._isLargeDraw=i,this.group.removeAll()),this.group.add(n.group),n},t.prototype.remove=function(e,t){this._symbolDraw&&this._symbolDraw.remove(!0),this._symbolDraw=null},t.prototype.dispose=function(){},t.type="scatter",t}(sU),hZ={left:0,right:0,top:0,bottom:0},pZ=["25%","25%"],gZ=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.mergeDefaultAndTheme=function(t,n){var i=lF(t.outerBounds);e.prototype.mergeDefaultAndTheme.apply(this,arguments),i&&t.outerBounds&&oF(t.outerBounds,i)},t.prototype.mergeOption=function(t,n){e.prototype.mergeOption.apply(this,arguments),this.option.outerBounds&&t.outerBounds&&oF(this.option.outerBounds,t.outerBounds)},t.type="grid",t.dependencies=["xAxis","yAxis"],t.layoutMode="box",t.defaultOption={show:!1,z:0,left:"15%",top:65,right:"10%",bottom:80,containLabel:!1,outerBoundsMode:"auto",outerBounds:hZ,outerBoundsContain:"all",outerBoundsClampWidth:pZ[0],outerBoundsClampHeight:pZ[1],backgroundColor:uF.color.transparent,borderWidth:1,borderColor:uF.color.neutral30},t}(dF),vZ=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.getCoordSysModel=function(){return this.getReferringComponents("grid",qE).models[0]},t.type="cartesian2dAxis",t}(dF);FC(vZ,KW);var fZ={show:!0,z:0,inverse:!1,name:"",nameLocation:"end",nameRotate:null,nameTruncate:{maxWidth:null,ellipsis:"...",placeholder:"."},nameTextStyle:{},nameGap:15,silent:!1,triggerEvent:!1,tooltip:{show:!1},axisPointer:{},axisLine:{show:!0,onZero:!0,onZeroAxisIndex:null,lineStyle:{color:uF.color.axisLine,width:1,type:"solid"},symbol:["none","none"],symbolSize:[10,15],breakLine:!0},axisTick:{show:!0,inside:!1,length:5,lineStyle:{width:1}},axisLabel:{show:!0,inside:!1,rotate:0,showMinLabel:null,showMaxLabel:null,margin:8,fontSize:12,color:uF.color.axisLabel,textMargin:[0,3]},splitLine:{show:!0,showMinLine:!0,showMaxLine:!0,lineStyle:{color:uF.color.axisSplitLine,width:1,type:"solid"}},splitArea:{show:!1,areaStyle:{color:[uF.color.backgroundTint,uF.color.backgroundTransparent]}},breakArea:{show:!0,itemStyle:{color:uF.color.neutral00,borderColor:uF.color.border,borderWidth:1,borderType:[3,3],opacity:.6},zigzagAmplitude:4,zigzagMinSpan:4,zigzagMaxSpan:20,zigzagZ:100,expandOnClick:!0},breakLabelLayout:{moveOverlap:"auto"}},mZ=PC({boundaryGap:!0,deduplication:null,jitter:0,jitterOverlap:!0,jitterMargin:2,splitLine:{show:!1},axisTick:{alignWithLabel:!1,interval:"auto",show:"auto"},axisLabel:{interval:"auto"}},fZ),yZ=PC({boundaryGap:[0,0],axisLine:{show:"auto"},axisTick:{show:"auto"},splitNumber:5,minorTick:{show:!1,splitNumber:5,length:3,lineStyle:{}},minorSplitLine:{show:!1,lineStyle:{color:uF.color.axisMinorSplitLine,width:1}}},fZ);const bZ={category:mZ,value:yZ,time:PC({splitNumber:6,axisLabel:{showMinLabel:!1,showMaxLabel:!1,rich:{primary:{fontWeight:"bold"}}},splitLine:{show:!1}},yZ),log:$C({logBase:10},yZ)};var wZ={value:1,category:1,time:1,log:1};function kZ(e,t,n,i){jC(wZ,function(a,r){var s=PC(PC({},bZ[r],!0),i,!0),o=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t+"Axis."+r,n}return uC(n,e),n.prototype.mergeDefaultAndTheme=function(e,t){var n=sF(this),i=n?lF(e):{};PC(e,t.getTheme().get(r+"Axis")),PC(e,this.getDefaultOption()),e.type=SZ(e),n&&oF(e,i,n)},n.prototype.optionUpdated=function(){"category"===this.option.type&&(this.__ordinalMeta=iW.createByAxisModel(this))},n.prototype.getCategories=function(e){var t=this.option;if("category"===t.type)return e?t.data:this.__ordinalMeta.categories},n.prototype.getOrdinalMeta=function(){return this.__ordinalMeta},n.prototype.updateAxisBreaks=function(e){return{breaks:[]}},n.type=t+"Axis."+r,n.defaultOption=s,n}(n);e.registerComponentModel(o)}),e.registerSubTypeDefaulter(t+"Axis",SZ)}function SZ(e){return e.type||(e.data?"category":"value")}var xZ=function(){function e(e){this.type="cartesian",this._dimList=[],this._axes={},this.name=e||""}return e.prototype.getAxis=function(e){return this._axes[e]},e.prototype.getAxes=function(){return UC(this._dimList,function(e){return this._axes[e]},this)},e.prototype.getAxesByScale=function(e){return e=e.toLowerCase(),qC(this.getAxes(),function(t){return t.scale.type===e})},e.prototype.addAxis=function(e){var t=e.dim;this._axes[t]=e,this._dimList.push(t)},e}(),_Z=["x","y"];function CZ(e){return("interval"===e.type||"time"===e.type)&&!e.hasBreaks()}var IZ=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="cartesian2d",t.dimensions=_Z,t}return uC(t,e),t.prototype.calcAffineTransform=function(){this._transform=this._invTransform=null;var e=this.getAxis("x").scale,t=this.getAxis("y").scale;if(CZ(e)&&CZ(t)){var n=e.getExtent(),i=t.getExtent(),a=this.dataToPoint([n[0],i[0]]),r=this.dataToPoint([n[1],i[1]]),s=n[1]-n[0],o=i[1]-i[0];if(s&&o){var l=(r[0]-a[0])/s,c=(r[1]-a[1])/o,d=a[0]-n[0]*l,u=a[1]-i[0]*c,h=this._transform=[l,0,0,c,d,u];this._invTransform=ED([],h)}}},t.prototype.getBaseAxis=function(){return this.getAxesByScale("ordinal")[0]||this.getAxesByScale("time")[0]||this.getAxis("x")},t.prototype.containPoint=function(e){var t=this.getAxis("x"),n=this.getAxis("y");return t.contain(t.toLocalCoord(e[0]))&&n.contain(n.toLocalCoord(e[1]))},t.prototype.containData=function(e){return this.getAxis("x").containData(e[0])&&this.getAxis("y").containData(e[1])},t.prototype.containZone=function(e,t){var n=this.dataToPoint(e),i=this.dataToPoint(t),a=this.getArea(),r=new GD(n[0],n[1],i[0]-n[0],i[1]-n[1]);return a.intersect(r)},t.prototype.dataToPoint=function(e,t,n){n=n||[];var i=e[0],a=e[1];if(this._transform&&null!=i&&isFinite(i)&&null!=a&&isFinite(a))return GI(n,e,this._transform);var r=this.getAxis("x"),s=this.getAxis("y");return n[0]=r.toGlobalCoord(r.dataToCoord(i,t)),n[1]=s.toGlobalCoord(s.dataToCoord(a,t)),n},t.prototype.clampData=function(e,t){var n=this.getAxis("x").scale,i=this.getAxis("y").scale,a=n.getExtent(),r=i.getExtent(),s=n.parse(e[0]),o=i.parse(e[1]);return(t=t||[])[0]=Math.min(Math.max(Math.min(a[0],a[1]),s),Math.max(a[0],a[1])),t[1]=Math.min(Math.max(Math.min(r[0],r[1]),o),Math.max(r[0],r[1])),t},t.prototype.pointToData=function(e,t,n){if(n=n||[],this._invTransform)return GI(n,e,this._invTransform);var i=this.getAxis("x"),a=this.getAxis("y");return n[0]=i.coordToData(i.toLocalCoord(e[0]),t),n[1]=a.coordToData(a.toLocalCoord(e[1]),t),n},t.prototype.getOtherAxis=function(e){return this.getAxis("x"===e.dim?"y":"x")},t.prototype.getArea=function(e){e=e||0;var t=this.getAxis("x").getGlobalExtent(),n=this.getAxis("y").getGlobalExtent(),i=Math.min(t[0],t[1])-e,a=Math.min(n[0],n[1])-e,r=Math.max(t[0],t[1])-i+e,s=Math.max(n[0],n[1])-a+e;return new GD(i,a,r,s)},t}(xZ),DZ=function(e){function t(t,n,i,a,r){var s=e.call(this,t,n,i)||this;return s.index=0,s.type=a||"value",s.position=r||"bottom",s}return uC(t,e),t.prototype.isHorizontal=function(){var e=this.position;return"top"===e||"bottom"===e},t.prototype.getGlobalExtent=function(e){var t=this.getExtent();return t[0]=this.toGlobalCoord(t[0]),t[1]=this.toGlobalCoord(t[1]),e&&t[0]>t[1]&&t.reverse(),t},t.prototype.pointToData=function(e,t){return this.coordToData(this.toLocalCoord(e["x"===this.dim?0:1]),t)},t.prototype.setCategorySortInfo=function(e){if("category"!==this.type)return!1;this.model.option.categorySortInfo=e,this.scale.setSortInfo(e)},t}(LG),TZ="expandAxisBreak",MZ=Math.PI,AZ=[[1,2,1,2],[5,3,5,3],[8,3,8,3]],EZ=[[0,1,0,1],[0,3,0,3],[0,3,0,3]],zZ=BE(),PZ=BE(),RZ=function(){function e(e){this.recordMap={},this.resolveAxisNameOverlap=e}return e.prototype.ensureRecord=function(e){var t=e.axis.dim,n=e.componentIndex,i=this.recordMap,a=i[t]||(i[t]=[]);return a[n]||(a[n]={ready:{}})},e}();var $Z=[1,0,0,1,0,0],OZ=new GD(0,0,0,0),LZ=function(e,t,n,i,a,r){if(WW(e.nameLocation)){var s=r.stOccupiedRect;s&&NZ((o={},l=s,c=r.transGroup.transform,o.transform=cL(o.transform,c),o.localRect=lL(o.localRect,l),o.rect=lL(o.rect,l),c&&o.rect.applyTransform(c),o.axisAligned=sL(c),o.obb=void 0,(o.label=o.label||{}).ignore=!1,o),i,a)}else FZ(r.labelInfoList,r.dirVec,i,a);var o,l,c};function NZ(e,t,n){var i=new PD;bQ(e,t,i,{direction:Math.atan2(n.y,n.x),bidirectional:!1,touchThreshold:.05})&&function(e,t){if(e){e.label.x+=t.x,e.label.y+=t.y,e.label.markRedraw();var n=e.transform;n&&(n[4]+=t.x,n[5]+=t.y);var i=e.rect;i&&(i.x+=t.x,i.y+=t.y);var a=e.obb;a&&a.fromBoundingRect(e.localRect,n)}}(t,i)}function FZ(e,t,n,i){for(var a=PD.dot(i,t)>=0,r=0,s=e.length;r<s;r++){var o=e[a?r:s-1-r];o.label.ignore||NZ(o,n,i)}}var BZ=function(){function e(e,t,n,i){this.group=new jA,this._axisModel=e,this._api=t,this._local={},this._shared=i||new RZ(LZ),this._resetCfgDetermined(n)}return e.prototype.updateCfg=function(e){var t=this._cfg.raw;t.position=e.position,t.labelOffset=e.labelOffset,this._resetCfgDetermined(t)},e.prototype.__getRawCfg=function(){return this._cfg.raw},e.prototype._resetCfgDetermined=function(e){var t=this._axisModel,n=t.getDefaultOption?t.getDefaultOption():{},i=cI(e.axisName,t.get("name")),a=t.get("nameMoveOverlap");null!=a&&"auto"!==a||(a=cI(e.defaultNameMoveOverlap,!0));var r={raw:e,position:e.position,rotation:e.rotation,nameDirection:cI(e.nameDirection,1),tickDirection:cI(e.tickDirection,1),labelDirection:cI(e.labelDirection,1),labelOffset:cI(e.labelOffset,0),silent:cI(e.silent,!0),axisName:i,nameLocation:dI(t.get("nameLocation"),n.nameLocation,"end"),shouldNameMoveOverlap:YZ(i)&&a,optionHideOverlap:t.get(["axisLabel","hideOverlap"]),showMinorTicks:t.get(["minorTick","show"])};this._cfg=r;var s=new jA({x:r.position[0],y:r.position[1],rotation:r.rotation});s.updateTransform(),this._transformGroup=s;var o=this._shared.ensureRecord(t);o.transGroup=this._transformGroup,o.dirVec=new PD(Math.cos(-r.rotation),Math.sin(-r.rotation))},e.prototype.build=function(e,t){var n=this;return e||(e={axisLine:!0,axisTickLabelEstimate:!1,axisTickLabelDetermine:!0,axisName:!0}),jC(jZ,function(i){e[i]&&UZ[i](n._cfg,n._local,n._shared,n._axisModel,n.group,n._transformGroup,n._api,t||{})}),this},e.innerTextLayout=function(e,t,n){var i,a,r=dE(t-e);return uE(r)?(a=n>0?"top":"bottom",i="center"):uE(r-MZ)?(a=n>0?"bottom":"top",i="center"):(a="middle",i=r>0&&r<MZ?n>0?"right":"left":n>0?"left":"right"),{rotation:r,textAlign:i,textVerticalAlign:a}},e.makeAxisEventDataBase=function(e){var t={componentType:e.mainType,componentIndex:e.componentIndex};return t[e.mainType+"Index"]=e.componentIndex,t},e.isLabelSilent=function(e){var t=e.get("tooltip");return e.get("silent")||!(e.get("triggerEvent")||t&&t.show)},e}(),jZ=["axisLine","axisTickLabelEstimate","axisTickLabelDetermine","axisName"],UZ={axisLine:function(e,t,n,i,a,r,s){var o=i.get(["axisLine","show"]);if("auto"===o&&(o=!0,null!=e.raw.axisLineAutoShow&&(o=!!e.raw.axisLineAutoShow)),o){var l=i.axis.getExtent(),c=r.transform,d=[l[0],0],u=[l[1],0],h=d[0]>u[0];c&&(GI(d,d,c),GI(u,u,c));var p=RC({lineCap:"round"},i.getModel(["axisLine","lineStyle"]).getLineStyle()),g={strokeContainThreshold:e.raw.strokeContainThreshold||5,silent:!0,z2:1,style:p};if(i.get(["axisLine","breakLine"])&&i.axis.scale.hasBreaks())null.buildAxisBreakLine(i,a,r,g);else{var v=new X$(RC({shape:{x1:d[0],y1:d[1],x2:u[0],y2:u[1]}},g));UO(v.shape,v.style.lineWidth),v.anid="line",a.add(v)}var f=i.get(["axisLine","symbol"]);if(null!=f){var m=i.get(["axisLine","symbolSize"]);YC(f)&&(f=[f,f]),(YC(m)||JC(m))&&(m=[m,m]);var y=mV(i.get(["axisLine","symbolOffset"])||0,m),b=m[0],w=m[1];jC([{rotate:e.rotation+Math.PI/2,offset:y[0],r:0},{rotate:e.rotation-Math.PI/2,offset:y[1],r:Math.sqrt((d[0]-u[0])*(d[0]-u[0])+(d[1]-u[1])*(d[1]-u[1]))}],function(t,n){if("none"!==f[n]&&null!=f[n]){var i=vV(f[n],-b/2,-w/2,b,w,p.stroke,!0),r=t.r+t.offset,s=h?u:d;i.attr({rotation:t.rotate,x:s[0]+r*Math.cos(e.rotation),y:s[1]-r*Math.sin(e.rotation),silent:!0,z2:11}),a.add(i)}})}}},axisTickLabelEstimate:function(e,t,n,i,a,r,s,o){WZ(t,a,o)&&VZ(e,t,n,i,a,r,s,wG)},axisTickLabelDetermine:function(e,t,n,i,a,r,s,o){WZ(t,a,o)&&VZ(e,t,n,i,a,r,s,kG);var l=function(e,t,n,i){var a=i.axis,r=i.getModel("axisTick"),s=r.get("show");"auto"===s&&(s=!0,null!=e.raw.axisTickAutoShow&&(s=!!e.raw.axisTickAutoShow));if(!s||a.scale.isBlank())return[];for(var o=r.getModel("lineStyle"),l=e.tickDirection*r.get("length"),c=HZ(a.getTicksCoords(),n.transform,l,$C(o.getLineStyle(),{stroke:i.get(["axisLine","lineStyle","color"])}),"ticks"),d=0;d<c.length;d++)t.add(c[d]);return c}(e,a,r,i);!function(e,t,n){if(e.showMinorTicks)return;jC(t,function(e){if(e&&e.label.ignore)for(var t=0;t<n.length;t++){var i=n[t],a=PZ(i),r=zZ(e.label);if(null!=a.tickValue&&!a.onBand&&a.tickValue===r.tickValue)return void qZ(i)}})}(e,t.labelLayoutList,l),function(e,t,n,i,a){var r=i.axis,s=i.getModel("minorTick");if(!e.showMinorTicks||r.scale.isBlank())return;var o=r.getMinorTicksCoords();if(!o.length)return;for(var l=s.getModel("lineStyle"),c=a*s.get("length"),d=$C(l.getLineStyle(),$C(i.getModel("axisTick").getLineStyle(),{stroke:i.get(["axisLine","lineStyle","color"])})),u=0;u<o.length;u++)for(var h=HZ(o[u],n.transform,c,d,"minorticks_"+u),p=0;p<h.length;p++)t.add(h[p])}(e,a,r,i,e.tickDirection)},axisName:function(e,t,n,i,a,r,s,o){var l=n.ensureRecord(i);t.nameEl&&(a.remove(t.nameEl),t.nameEl=l.nameLayout=l.nameLocation=null);var c=e.axisName;if(YZ(c)){var d=e.nameLocation,u=e.nameDirection,h=i.getModel("nameTextStyle"),p=i.get("nameGap")||0,g=i.axis.getExtent(),v=i.axis.inverse?-1:1,f=new PD(0,0),m=new PD(0,0);"start"===d?(f.x=g[0]-v*p,m.x=-v):"end"===d?(f.x=g[1]+v*p,m.x=v):(f.x=(g[0]+g[1])/2,f.y=e.labelOffset+u*p,m.y=u);var y=[1,0,0,1,0,0];m.transform(MD(y,y,e.rotation));var b,w,k=i.get("nameRotate");null!=k&&(k=k*MZ/180),WW(d)?b=BZ.innerTextLayout(e.rotation,null!=k?k:e.rotation,u):(b=function(e,t,n,i){var a,r,s=dE(n-e),o=i[0]>i[1],l="start"===t&&!o||"start"!==t&&o;uE(s-MZ/2)?(r=l?"bottom":"top",a="center"):uE(s-1.5*MZ)?(r=l?"top":"bottom",a="center"):(r="middle",a=s<1.5*MZ&&s>MZ/2?l?"left":"right":l?"right":"left");return{rotation:s,textAlign:a,textVerticalAlign:r}}(e.rotation,d,k||0,g),null!=(w=e.raw.axisNameAvailableWidth)&&(w=Math.abs(w/Math.sin(b.rotation)),!isFinite(w)&&(w=null)));var S=h.getFont(),x=i.get("nameTruncate",!0)||{},_=x.ellipsis,C=lI(e.raw.nameTruncateMaxWidth,x.maxWidth,w),I=o.nameMarginLevel||0,D=new JP({x:f.x,y:f.y,rotation:b.rotation,silent:BZ.isLabelSilent(i),style:bL(h,{text:c,font:S,overflow:"truncate",width:C,ellipsis:_,fill:h.getTextColor()||i.get(["axisLine","lineStyle","color"]),align:h.get("align")||b.textAlign,verticalAlign:h.get("verticalAlign")||b.textVerticalAlign}),z2:1});if(iL({el:D,componentModel:i,itemName:c}),D.__fullText=c,D.anid="name",i.get("triggerEvent")){var T=BZ.makeAxisEventDataBase(i);T.targetType="axisName",T.name=c,uR(D).eventData=T}r.add(D),D.updateTransform(),t.nameEl=D;var M=l.nameLayout=hQ({label:D,priority:D.z2,defaultAttr:{ignore:D.ignore},marginDefault:WW(d)?AZ[I]:EZ[I]});if(l.nameLocation=d,a.add(D),D.decomposeTransform(),e.shouldNameMoveOverlap&&M){var A=n.ensureRecord(i);n.resolveAxisNameOverlap(e,n,i,M,m,A)}}}};function VZ(e,t,n,i,a,r,s,o){GZ(t)||function(e,t,n,i,a,r){var s=a.axis,o=lI(e.raw.axisLabelShow,a.get(["axisLabel","show"])),l=new jA;n.add(l);var c=SG(i);if(!o||s.scale.isBlank())return void QZ(t,[],l,c);var d=a.getModel("axisLabel"),u=s.getViewLabels(c),h=(lI(e.raw.labelRotate,d.get("rotate"))||0)*MZ/180,p=BZ.innerTextLayout(e.rotation,h,e.labelDirection),g=a.getCategories&&a.getCategories(!0),v=[],f=a.get("triggerEvent"),m=1/0,y=-1/0;jC(u,function(e,t){var n,i="ordinal"===s.scale.type?s.scale.getRawOrdinalNumber(e.tickValue):e.tickValue,o=e.formattedLabel,c=e.rawLabel,h=d;if(g&&g[i]){var b=g[i];eI(b)&&b.textStyle&&(h=new BL(b.textStyle,d,a.ecModel))}var w=h.getTextColor()||a.get(["axisLine","lineStyle","color"]),k=h.getShallow("align",!0)||p.textAlign,S=cI(h.getShallow("alignMinLabel",!0),k),x=cI(h.getShallow("alignMaxLabel",!0),k),_=h.getShallow("verticalAlign",!0)||h.getShallow("baseline",!0)||p.textVerticalAlign,C=cI(h.getShallow("verticalAlignMinLabel",!0),_),I=cI(h.getShallow("verticalAlignMaxLabel",!0),_),D=10+((null===(n=e.time)||void 0===n?void 0:n.level)||0);m=Math.min(m,D),y=Math.max(y,D);var T=new JP({x:0,y:0,rotation:0,silent:BZ.isLabelSilent(a),z2:D,style:bL(h,{text:o,align:0===t?S:t===u.length-1?x:k,verticalAlign:0===t?C:t===u.length-1?I:_,fill:ZC(w)?w("category"===s.type?c:"value"===s.type?i+"":i,t):w})});T.anid="label_"+i;var M=zZ(T);if(M.break=e.break,M.tickValue=i,M.layoutRotation=p.rotation,iL({el:T,componentModel:a,itemName:o,formatterParamsExtra:{isTruncated:function(){return T.isTruncated},value:c,tickIndex:t}}),f){var A=BZ.makeAxisEventDataBase(a);A.targetType="axisLabel",A.value=c,A.tickIndex=t,e.break&&(A.break={start:e.break.parsedBreak.vmin,end:e.break.parsedBreak.vmax}),"category"===s.type&&(A.dataIndex=i),uR(T).eventData=A,e.break&&function(e,t,n,i){n.on("click",function(n){var a={type:TZ,breaks:[{start:i.parsedBreak.breakOption.start,end:i.parsedBreak.breakOption.end}]};a[e.axis.dim+"AxisIndex"]=e.componentIndex,t.dispatchAction(a)})}(a,r,T,e.break)}v.push(T),l.add(T)});var b=UC(v,function(e){return{label:e,priority:zZ(e).break?e.z2+(y-m+1):e.z2,defaultAttr:{ignore:e.ignore}}});QZ(t,b,l,c)}(e,t,a,o,i,s);var l=t.labelLayoutList;!function(e,t,n,i){var a=t.get(["axisLabel","margin"]);jC(n,function(n,r){var s=hQ(n);if(s){var o=s.label,l=zZ(o);s.suggestIgnore=o.ignore,o.ignore=!1,mA(KZ,ZZ),KZ.x=t.axis.dataToCoord(l.tickValue),KZ.y=e.labelOffset+e.labelDirection*a,KZ.rotation=l.layoutRotation,i.add(KZ),KZ.updateTransform(),i.remove(KZ),KZ.decomposeTransform(),mA(o,KZ),o.markRedraw(),dQ(s,!0),hQ(s)}})}(e,i,l,r),e.rotation;var c=e.optionHideOverlap;!function(e,t,n){if(qW(e.axis))return;function i(e,i,a){var r=hQ(t[i]),s=hQ(t[a]);if(r&&s)if(!1===e||r.suggestIgnore)qZ(r.label);else if(s.suggestIgnore)qZ(s.label);else{var o=.1;if(!n){var l=[0,0,0,0];r=vQ({marginForce:l},r),s=vQ({marginForce:l},s)}bQ(r,s,null,{touchThreshold:o})&&qZ(e?s.label:r.label)}}var a=e.get(["axisLabel","showMinLabel"]),r=e.get(["axisLabel","showMaxLabel"]),s=t.length;i(a,0,1),i(r,s-1,s-2)}(i,l,c),c&&yQ(qC(l,function(e){return e&&!e.label.ignore})),function(e,t,n,i){var a,r=n.axis,s=t.ensureRecord(n),o=[],l=YZ(e.axisName)&&WW(e.nameLocation);jC(i,function(e){var t=hQ(e);if(t&&!t.label.ignore){o.push(t);var n=s.transGroup;l&&(n.transform?ED($Z,n.transform):CD($Z),t.transform&&DD($Z,$Z,t.transform),GD.copy(OZ,t.localRect),OZ.applyTransform($Z),a?a.union(OZ):GD.copy(a=new GD(0,0,0,0),OZ))}});var c=Math.abs(s.dirVec.x)>.1?"x":"y",d=s.transGroup[c];if(o.sort(function(e,t){return Math.abs(e.label[c]-d)-Math.abs(t.label[c]-d)}),l&&a){var u=r.getExtent(),h=Math.min(u[0],u[1]),p=Math.max(u[0],u[1])-h;a.union(new GD(h,0,p,1))}s.stOccupiedRect=a,s.labelInfoList=o}(e,n,i,l)}function qZ(e){e&&(e.ignore=!0)}function HZ(e,t,n,i,a){for(var r=[],s=[],o=[],l=0;l<e.length;l++){var c=e[l].coord;s[0]=c,s[1]=0,o[0]=c,o[1]=n,t&&(GI(s,s,t),GI(o,o,t));var d=new X$({shape:{x1:s[0],y1:s[1],x2:o[0],y2:o[1]},style:i,z2:2,autoBatch:!0,silent:!0});UO(d.shape,d.style.lineWidth),d.anid=a+"_"+e[l].tickValue,r.push(d);var u=PZ(d);u.onBand=!!e[l].onBand,u.tickValue=e[l].tickValue}return r}function WZ(e,t,n){if(GZ(e)){var i=e.axisLabelsCreationContext.out.noPxChangeTryDetermine;if(n.noPxChange){for(var a=!0,r=0;r<i.length;r++)a=a&&i[r]();if(a)return!1}i.length&&(t.remove(e.labelGroup),QZ(e,null,null,null))}return!0}function GZ(e){return!!e.labelLayoutList}function QZ(e,t,n,i){e.labelLayoutList=t,e.labelGroup=n,e.axisLabelsCreationContext=i}var KZ=new KP,ZZ=new KP;function YZ(e){return!!e}function XZ(e,t,n){n=n||{};var i=t.axis,a={},r=i.getAxesOnZeroOf()[0],s=i.position,o=r?"onZero":s,l=i.dim,c=[e.x,e.x+e.width,e.y,e.y+e.height],d={left:0,right:1,top:0,bottom:1,onZero:2},u=t.get("offset")||0,h="x"===l?[c[2]-u,c[3]+u]:[c[0]-u,c[1]+u];if(r){var p=r.toGlobalCoord(r.dataToCoord(0));h[d.onZero]=Math.max(Math.min(p,h[1]),h[0])}a.position=["y"===l?h[d[o]]:c[0],"x"===l?h[d[o]]:c[3]],a.rotation=Math.PI/2*("x"===l?0:1);a.labelDirection=a.tickDirection=a.nameDirection={top:-1,bottom:1,left:-1,right:1}[s],a.labelOffset=r?h[d[s]]-h[d.onZero]:0,t.get(["axisTick","inside"])&&(a.tickDirection=-a.tickDirection),lI(n.labelInside,t.get(["axisLabel","inside"]))&&(a.labelDirection=-a.labelDirection);var g=t.get(["axisLabel","rotate"]);return a.labelRotate="top"===o?-g:g,a.z2=1,a}function JZ(e){var t={xAxisModel:null,yAxisModel:null};return jC(t,function(n,i){var a=i.replace(/Model$/,""),r=e.getReferringComponents(a,qE).models[0];t[i]=r}),t}var eY=[[3,1],[0,2]],tY=function(){function e(e,t,n){this.type="grid",this._coordsMap={},this._coordsList=[],this._axesMap={},this._axesList=[],this.axisPointerEnabled=!0,this.dimensions=_Z,this._initCartesian(e,t,n),this.model=e}return e.prototype.getRect=function(){return this._rect},e.prototype.update=function(e,t){var n=this._axesMap;function i(e){var t,n=WC(e),i=n.length;if(i){for(var a=[],r=i-1;r>=0;r--){var s=e[+n[r]],o=s.model,l=s.scale;HH(l)&&o.get("alignTicks")&&null==o.get("interval")?a.push(s):(FW(l,o),HH(l)&&(t=s))}a.length&&(t||FW((t=a.pop()).scale,t.model),jC(a,function(e){!function(e,t,n){var i=oW.prototype,a=i.getTicks.call(n),r=i.getTicks.call(n,{expandToNicedExtent:!0}),s=a.length-1,o=i.getInterval.call(n),l=NW(e,t),c=l.extent,d=l.fixMin,u=l.fixMax;"log"===e.type&&(c=eW(e.base,c,!0)),e.setBreaksFromOption(QW(t)),e.setExtent(c[0],c[1]),e.calcNiceExtent({splitNumber:s,fixMin:d,fixMax:u});var h=i.getExtent.call(e);d&&(c[0]=h[0]),u&&(c[1]=h[1]);var p=i.getInterval.call(e),g=c[0],v=c[1];if(d&&u)p=(v-g)/s;else if(d)for(v=c[0]+p*s;v<c[1]&&isFinite(v)&&isFinite(c[1]);)p=GH(p),v=c[0]+p*s;else if(u)for(g=c[1]-p*s;g>c[0]&&isFinite(g)&&isFinite(c[0]);)p=GH(p),g=c[1]-p*s;else{e.getTicks().length-1>s&&(p=GH(p));var f=p*s;(g=iE((v=Math.ceil(c[1]/p)*p)-f))<0&&c[0]>=0?(g=0,v=iE(f)):v>0&&c[1]<=0&&(v=0,g=-iE(f))}var m=(a[0].value-r[0].value)/o,y=(a[s].value-r[s].value)/o;i.setExtent.call(e,g+p*m,v+p*y),i.setInterval.call(e,p),(m||y)&&i.setNiceExtent.call(e,g+p,v-p)}(e.scale,e.model,t.scale)}))}}this._updateScale(e,this.model),i(n.x),i(n.y);var a={};jC(n.x,function(e){iY(n,"y",e,a)}),jC(n.y,function(e){iY(n,"x",e,a)}),this.resize(this.model,t)},e.prototype.resize=function(e,t,n){var i=aF(e,t),a=this._rect=nF(e.getBoxLayoutParams(),i.refContainer),r=this._axesMap,s=this._coordsList,o=e.get("containLabel");if(rY(r,a),!n){var l=function(e,t,n,i,a){var r=new RZ(cY);return jC(n,function(n){return jC(n,function(n){if(GW(n.model)){var s=!i;n.axisBuilder=function(e,t,n,i,a,r){for(var s=XZ(e,n),o=!1,l=!1,c=0;c<t.length;c++)HH(t[c].getOtherAxis(n.axis).scale)&&(o=l=!0,"category"===n.axis.type&&n.axis.onBand&&(l=!1));return s.axisLineAutoShow=o,s.axisTickAutoShow=l,s.defaultNameMoveOverlap=r,new BZ(n,i,s,a)}(e,t,n.model,a,r,s)}})}),r}(a,s,r,o,t),c=void 0;if(o)c=oY(a.clone(),"axisLabel",null,a,r,l,i);else{var d=function(e,t,n){var i,a=e.get("outerBoundsMode",!0);"same"===a?i=t.clone():null!=a&&"auto"!==a||(i=nF(e.get("outerBounds",!0)||hZ,n.refContainer));var r,s=e.get("outerBoundsContain",!0);r=null==s||"auto"===s||LC(["all","axisLabel"],s)<0?"all":s;var o=[nE(cI(e.get("outerBoundsClampWidth",!0),pZ[0]),t.width),nE(cI(e.get("outerBoundsClampHeight",!0),pZ[1]),t.height)];return{outerBoundsRect:i,parsedOuterBoundsContain:r,outerBoundsClamp:o}}(e,a,i),u=d.outerBoundsRect,h=d.parsedOuterBoundsContain,p=d.outerBoundsClamp;u&&(c=oY(u,h,p,a,r,l,i))}lY(a,r,kG,null,c,i)}jC(this._coordsList,function(e){e.calcAffineTransform()})},e.prototype.getAxis=function(e,t){var n=this._axesMap[e];if(null!=n)return n[t||0]},e.prototype.getAxes=function(){return this._axesList.slice()},e.prototype.getCartesian=function(e,t){if(null!=e&&null!=t){var n="x"+e+"y"+t;return this._coordsMap[n]}eI(e)&&(t=e.yAxisIndex,e=e.xAxisIndex);for(var i=0,a=this._coordsList;i<a.length;i++)if(a[i].getAxis("x").index===e||a[i].getAxis("y").index===t)return a[i]},e.prototype.getCartesians=function(){return this._coordsList.slice()},e.prototype.convertToPixel=function(e,t,n){var i=this._findConvertTarget(t);return i.cartesian?i.cartesian.dataToPoint(n):i.axis?i.axis.toGlobalCoord(i.axis.dataToCoord(n)):null},e.prototype.convertFromPixel=function(e,t,n){var i=this._findConvertTarget(t);return i.cartesian?i.cartesian.pointToData(n):i.axis?i.axis.coordToData(i.axis.toLocalCoord(n)):null},e.prototype._findConvertTarget=function(e){var t,n,i=e.seriesModel,a=e.xAxisModel||i&&i.getReferringComponents("xAxis",qE).models[0],r=e.yAxisModel||i&&i.getReferringComponents("yAxis",qE).models[0],s=e.gridModel,o=this._coordsList;if(i)LC(o,t=i.coordinateSystem)<0&&(t=null);else if(a&&r)t=this.getCartesian(a.componentIndex,r.componentIndex);else if(a)n=this.getAxis("x",a.componentIndex);else if(r)n=this.getAxis("y",r.componentIndex);else if(s){s.coordinateSystem===this&&(t=this._coordsList[0])}return{cartesian:t,axis:n}},e.prototype.containPoint=function(e){var t=this._coordsList[0];if(t)return t.containPoint(e)},e.prototype._initCartesian=function(e,t,n){var i=this,a=this,r={left:!1,right:!1,top:!1,bottom:!1},s={x:{},y:{}},o={x:0,y:0};if(t.eachComponent("xAxis",l("x"),this),t.eachComponent("yAxis",l("y"),this),!o.x||!o.y)return this._axesMap={},void(this._axesList=[]);function l(t){return function(n,i){if(nY(n,e)){var l=n.get("position");"x"===t?"top"!==l&&"bottom"!==l&&(l=r.bottom?"top":"bottom"):"left"!==l&&"right"!==l&&(l=r.left?"right":"left"),r[l]=!0;var c=new DZ(t,BW(n),[0,0],n.get("type"),l),d="category"===c.type;c.onBand=d&&n.get("boundaryGap"),c.inverse=n.get("inverse"),n.axis=c,c.model=n,c.grid=a,c.index=i,a._axesList.push(c),s[t][i]=c,o[t]++}}}this._axesMap=s,jC(s.x,function(t,n){jC(s.y,function(a,r){var s="x"+n+"y"+r,o=new IZ(s);o.master=i,o.model=e,i._coordsMap[s]=o,i._coordsList.push(o),o.addAxis(t),o.addAxis(a)})})},e.prototype._updateScale=function(e,t){function n(e,t){jC(HW(e,t.dim),function(n){t.scale.unionExtentFromData(e,n)})}jC(this._axesList,function(e){if(e.scale.setExtent(1/0,-1/0),"category"===e.type){var t=e.model.get("categorySortInfo");e.scale.setSortInfo(t)}}),e.eachSeries(function(e){if(function(e){return e.coordinateSystem&&"cartesian2d"===e.coordinateSystem.type}(e)){var i=JZ(e),a=i.xAxisModel,r=i.yAxisModel;if(!nY(a,t)||!nY(r,t))return;var s=this.getCartesian(a.componentIndex,r.componentIndex),o=e.getData(),l=s.getAxis("x"),c=s.getAxis("y");n(o,l),n(o,c)}},this)},e.prototype.getTooltipAxes=function(e){var t=[],n=[];return jC(this.getCartesians(),function(i){var a=null!=e&&"auto"!==e?i.getAxis(e):i.getBaseAxis(),r=i.getOtherAxis(a);LC(t,a)<0&&t.push(a),LC(n,r)<0&&n.push(r)}),{baseAxes:t,otherAxes:n}},e.create=function(t,n){var i=[];return t.eachComponent("grid",function(a,r){var s=new e(a,t,n);s.name="grid_"+r,s.resize(a,n,!0),a.coordinateSystem=s,i.push(s)}),t.eachSeries(function(e){!function(e){var t=e.targetModel,n=e.coordSysType,i=e.coordSysProvider,a=e.isDefaultDataCoordSys,r=KN(t),s=r.kind,o=r.coordSysType;if(a&&s!==GN&&(s=GN,o=n),s===WN||o!==n)return!1;var l=i(n,t);!!l&&(s===GN?t.coordinateSystem=l:t.boxCoordinateSystem=l)}({targetModel:e,coordSysType:"cartesian2d",coordSysProvider:function(){var t=JZ(e),n=t.xAxisModel,i=t.yAxisModel;return n.getCoordSysModel().coordinateSystem.getCartesian(n.componentIndex,i.componentIndex)}})}),i},e.dimensions=_Z,e}();function nY(e,t){return e.getCoordSysModel()===t}function iY(e,t,n,i){n.getAxesOnZeroOf=function(){return a?[a]:[]};var a,r=e[t],s=n.model,o=s.get(["axisLine","onZero"]),l=s.get(["axisLine","onZeroAxisIndex"]);if(o){if(null!=l)aY(r[l])&&(a=r[l]);else for(var c in r)if(r.hasOwnProperty(c)&&aY(r[c])&&!i[d(r[c])]){a=r[c];break}a&&(i[d(a)]=!0)}function d(e){return e.dim+"_"+e.index}}function aY(e){return e&&"category"!==e.type&&"time"!==e.type&&function(e){var t=e.scale.getExtent(),n=t[0],i=t[1];return!(n>0&&i>0||n<0&&i<0)}(e)}function rY(e,t){jC(e.x,function(e){return sY(e,t.x,t.width)}),jC(e.y,function(e){return sY(e,t.y,t.height)})}function sY(e,t,n){var i=[0,n],a=e.inverse?1:0;e.setExtent(i[a],i[1-a]),function(e,t){var n=e.getExtent(),i=n[0]+n[1];e.toGlobalCoord="x"===e.dim?function(e){return e+t}:function(e){return i-e+t},e.toLocalCoord="x"===e.dim?function(e){return e-t}:function(e){return i-e+t}}(e,t)}function oY(e,t,n,i,a,r,s){lY(i,a,wG,t,!1,s);var o=[0,0,0,0];c(0),c(1),d(i,0,NaN),d(i,1,NaN);var l=null==HC(o,function(e){return e>0});return eL(i,o,!0,!0,n),rY(a,i),l;function c(e){jC(a[AO[e]],function(t){if(GW(t.model)){var n=r.ensureRecord(t.model),i=n.labelInfoList;if(i)for(var a=0;a<i.length;a++){var s=i[a],o=t.scale.normalize(zZ(s.label).tickValue);o=1===e?1-o:o,d(s.rect,e,o),d(s.rect,1-e,NaN)}var l=n.nameLayout;if(l){o=WW(n.nameLocation)?.5:NaN;d(l.rect,e,o),d(l.rect,1-e,NaN)}}})}function d(t,n,i){var a=e[AO[n]]-t[AO[n]],r=t[EO[n]]+t[AO[n]]-(e[EO[n]]+e[AO[n]]);a=u(a,1-i),r=u(r,i);var s=eY[n][0],l=eY[n][1];o[s]=XA(o[s],a),o[l]=XA(o[l],r)}function u(e,t){return e>0&&!oI(t)&&t>1e-4&&(e/=t),e}}function lY(e,t,n,i,a,r){var s=n===kG;jC(t,function(t){return jC(t,function(t){GW(t.model)&&(!function(e,t,n){var i=XZ(t,n);e.updateCfg(i)}(t.axisBuilder,e,t.model),t.axisBuilder.build(s?{axisTickLabelDetermine:!0}:{axisTickLabelEstimate:!0},{noPxChange:a}))})});var o={x:0,y:0};function l(t){o[AO[1-t]]=e[EO[t]]<=.5*r.refContainer[EO[t]]?0:1-t==1?2:1}l(0),l(1),jC(t,function(e,t){return jC(e,function(e){GW(e.model)&&(("all"===i||s)&&e.axisBuilder.build({axisName:!0},{nameMarginLevel:o[t]}),s&&e.axisBuilder.build({axisLine:!0}))})})}var cY=function(e,t,n,i,a,r){var s="x"===n.axis.dim?"y":"x";LZ(e,0,0,i,a,r),WW(e.nameLocation)||jC(t.recordMap[s],function(e){e&&e.labelInfoList&&e.dirVec&&FZ(e.labelInfoList,e.dirVec,i,a)})};function dY(e,t){var n={axesInfo:{},seriesInvolved:!1,coordSysAxesInfo:{},coordSysMap:{}};return function(e,t,n){var i=t.getComponent("tooltip"),a=t.getComponent("axisPointer"),r=a.get("link",!0)||[],s=[];jC(n.getCoordinateSystems(),function(n){if(n.axisPointerEnabled){var o=gY(n.model),l=e.coordSysAxesInfo[o]={};e.coordSysMap[o]=n;var c=n.model.getModel("tooltip",i);if(jC(n.getAxes(),QC(p,!1,null)),n.getTooltipAxes&&i&&c.get("show")){var d="axis"===c.get("trigger"),u="cross"===c.get(["axisPointer","type"]),h=n.getTooltipAxes(c.get(["axisPointer","axis"]));(d||u)&&jC(h.baseAxes,QC(p,!u||"cross",d)),u&&jC(h.otherAxes,QC(p,"cross",!1))}}function p(i,o,d){var u=d.model.getModel("axisPointer",a),h=u.get("show");if(h&&("auto"!==h||i||pY(u))){null==o&&(o=u.get("triggerTooltip")),u=i?function(e,t,n,i,a,r){var s=t.getModel("axisPointer"),o={};jC(["type","snap","lineStyle","shadowStyle","label","animation","animationDurationUpdate","animationEasingUpdate","z"],function(e){o[e]=zC(s.get(e))}),o.snap="category"!==e.type&&!!r,"cross"===s.get("type")&&(o.type="line");var l=o.label||(o.label={});if(null==l.show&&(l.show=!1),"cross"===a){var c=s.get(["label","show"]);if(l.show=null==c||c,!r){var d=o.lineStyle=s.get("crossStyle");d&&$C(l,d.textStyle)}}return e.model.getModel("axisPointer",new BL(o,n,i))}(d,c,a,t,i,o):u;var p=u.get("snap"),g=u.get("triggerEmphasis"),v=gY(d.model),f=o||p||"category"===d.type,m=e.axesInfo[v]={key:v,axis:d,coordSys:n,axisPointerModel:u,triggerTooltip:o,triggerEmphasis:g,involveSeries:f,snap:p,useHandle:pY(u),seriesModels:[],linkGroup:null};l[v]=m,e.seriesInvolved=e.seriesInvolved||f;var y=function(e,t){for(var n=t.model,i=t.dim,a=0;a<e.length;a++){var r=e[a]||{};if(uY(r[i+"AxisId"],n.id)||uY(r[i+"AxisIndex"],n.componentIndex)||uY(r[i+"AxisName"],n.name))return a}}(r,d);if(null!=y){var b=s[y]||(s[y]={axesInfo:{}});b.axesInfo[v]=m,b.mapper=r[y].mapper,m.linkGroup=b}}}})}(n,e,t),n.seriesInvolved&&function(e,t){t.eachSeries(function(t){var n=t.coordinateSystem,i=t.get(["tooltip","trigger"],!0),a=t.get(["tooltip","show"],!0);n&&n.model&&"none"!==i&&!1!==i&&"item"!==i&&!1!==a&&!1!==t.get(["axisPointer","show"],!0)&&jC(e.coordSysAxesInfo[gY(n.model)],function(e){var i=e.axis;n.getAxis(i.dim)===i&&(e.seriesModels.push(t),null==e.seriesDataCount&&(e.seriesDataCount=0),e.seriesDataCount+=t.getData().count())})})}(n,e),n}function uY(e,t){return"all"===e||KC(e)&&LC(e,t)>=0||e===t}function hY(e){var t=(e.ecModel.getComponent("axisPointer")||{}).coordSysAxesInfo;return t&&t.axesInfo[gY(e)]}function pY(e){return!!e.get(["handle","show"])}function gY(e){return e.type+"||"+e.id}var vY={},fY=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.render=function(t,n,i,a){this.axisPointerClass&&function(e){var t=hY(e);if(t){var n=t.axisPointerModel,i=t.axis.scale,a=n.option,r=n.get("status"),s=n.get("value");null!=s&&(s=i.parse(s));var o=pY(n);null==r&&(a.status=o?"show":"hide");var l=i.getExtent().slice();l[0]>l[1]&&l.reverse(),(null==s||s>l[1])&&(s=l[1]),s<l[0]&&(s=l[0]),a.value=s,o&&(a.status=t.axis.scale.isBlank()?"hide":"show")}}(t),e.prototype.render.apply(this,arguments),this._doUpdateAxisPointerClass(t,i,!0)},t.prototype.updateAxisPointer=function(e,t,n,i){this._doUpdateAxisPointerClass(e,n,!1)},t.prototype.remove=function(e,t){var n=this._axisPointer;n&&n.remove(t)},t.prototype.dispose=function(t,n){this._disposeAxisPointer(n),e.prototype.dispose.apply(this,arguments)},t.prototype._doUpdateAxisPointerClass=function(e,n,i){var a=t.getAxisPointerClass(this.axisPointerClass);if(a){var r=function(e){var t=hY(e);return t&&t.axisPointerModel}(e);r?(this._axisPointer||(this._axisPointer=new a)).render(e,r,n,i):this._disposeAxisPointer(n)}},t.prototype._disposeAxisPointer=function(e){this._axisPointer&&this._axisPointer.dispose(e),this._axisPointer=null},t.registerAxisPointerClass=function(e,t){vY[e]=t},t.getAxisPointerClass=function(e){return e&&vY[e]},t.type="axis",t}(nU),mY=BE();var yY=["splitArea","splitLine","minorSplitLine","breakArea"],bY=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.axisPointerClass="CartesianAxisPointer",n}return uC(t,e),t.prototype.render=function(t,n,i,a){this.group.removeAll();var r=this._axisGroup;(this._axisGroup=new jA,this.group.add(this._axisGroup),GW(t))&&(this._axisGroup.add(t.axis.axisBuilder.group),jC(yY,function(e){t.get([e,"show"])&&wY[e](this,this._axisGroup,t,t.getCoordSysModel(),i)},this),a&&"changeAxisOrder"===a.type&&a.isInitSort||QO(r,this._axisGroup,t),e.prototype.render.call(this,t,n,i,a))},t.prototype.remove=function(){mY(this).splitAreaColors=null},t.type="cartesianAxis",t}(fY),wY={splitLine:function(e,t,n,i,a){var r=n.axis;if(!r.scale.isBlank()){var s=n.getModel("splitLine"),o=s.getModel("lineStyle"),l=o.get("color"),c=!1!==s.get("showMinLine"),d=!1!==s.get("showMaxLine");l=KC(l)?l:[l];for(var u=i.coordinateSystem.getRect(),h=r.isHorizontal(),p=0,g=r.getTicksCoords({tickModel:s,breakTicks:"none",pruneByBreak:"preserve_extent_bound"}),v=[],f=[],m=o.getLineStyle(),y=0;y<g.length;y++){var b=r.toGlobalCoord(g[y].coord);if((0!==y||c)&&(y!==g.length-1||d)){var w=g[y].tickValue;h?(v[0]=b,v[1]=u.y,f[0]=b,f[1]=u.y+u.height):(v[0]=u.x,v[1]=b,f[0]=u.x+u.width,f[1]=b);var k=p++%l.length,S=new X$({anid:null!=w?"line_"+w:null,autoBatch:!0,shape:{x1:v[0],y1:v[1],x2:f[0],y2:f[1]},style:$C({stroke:l[k]},m),silent:!0});UO(S.shape,m.lineWidth),t.add(S)}}}},minorSplitLine:function(e,t,n,i,a){var r=n.axis,s=n.getModel("minorSplitLine").getModel("lineStyle"),o=i.coordinateSystem.getRect(),l=r.isHorizontal(),c=r.getMinorTicksCoords();if(c.length)for(var d=[],u=[],h=s.getLineStyle(),p=0;p<c.length;p++)for(var g=0;g<c[p].length;g++){var v=r.toGlobalCoord(c[p][g].coord);l?(d[0]=v,d[1]=o.y,u[0]=v,u[1]=o.y+o.height):(d[0]=o.x,d[1]=v,u[0]=o.x+o.width,u[1]=v);var f=new X$({anid:"minor_line_"+c[p][g].tickValue,autoBatch:!0,shape:{x1:d[0],y1:d[1],x2:u[0],y2:u[1]},style:h,silent:!0});UO(f.shape,h.lineWidth),t.add(f)}},splitArea:function(e,t,n,i,a){!function(e,t,n,i){var a=n.axis;if(!a.scale.isBlank()){var r=n.getModel("splitArea"),s=r.getModel("areaStyle"),o=s.get("color"),l=i.coordinateSystem.getRect(),c=a.getTicksCoords({tickModel:r,clamp:!0,breakTicks:"none",pruneByBreak:"preserve_extent_bound"});if(c.length){var d=o.length,u=mY(e).splitAreaColors,h=kI(),p=0;if(u)for(var g=0;g<c.length;g++){var v=u.get(c[g].tickValue);if(null!=v){p=(v+(d-1)*g)%d;break}}var f=a.toGlobalCoord(c[0].coord),m=s.getAreaStyle();for(o=KC(o)?o:[o],g=1;g<c.length;g++){var y=a.toGlobalCoord(c[g].coord),b=void 0,w=void 0,k=void 0,S=void 0;a.isHorizontal()?(b=f,w=l.y,k=y-b,S=l.height,f=b+k):(b=l.x,w=f,k=l.width,f=w+(S=y-w));var x=c[g-1].tickValue;null!=x&&h.set(x,p),t.add(new KP({anid:null!=x?"area_"+x:null,shape:{x:b,y:w,width:k,height:S},style:$C({fill:o[p]},m),autoBatch:!0,silent:!0})),p=(p+1)%d}mY(e).splitAreaColors=h}}}(e,t,n,i)},breakArea:function(e,t,n,i,a){n.axis.scale}},kY=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.type="xAxis",t}(bY),SY=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=kY.type,t}return uC(t,e),t.type="yAxis",t}(bY),xY=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="grid",t}return uC(t,e),t.prototype.render=function(e,t){this.group.removeAll(),e.get("show")&&this.group.add(new KP({shape:e.coordinateSystem.getRect(),style:$C({fill:e.get("backgroundColor")},e.getItemStyle()),silent:!0,z2:-1}))},t.type="grid",t}(nU),_Y={offset:0};function CY(e){e.registerComponentView(xY),e.registerComponentModel(gZ),e.registerCoordinateSystem("cartesian2d",tY),kZ(e,"x",vZ,_Y),kZ(e,"y",vZ,_Y),e.registerComponentView(kY),e.registerComponentView(SY),e.registerPreprocessor(function(e){e.xAxis&&e.yAxis&&!e.grid&&(e.grid={})})}function IY(e){eG(CY),e.registerSeriesModel(oZ),e.registerChartView(uZ),e.registerLayout(hK("scatter"))}var DY=BE();function TY(e,t){return!!DY(e)[t]}eH({type:"takeGlobalCursor",event:"globalCursorTaken",update:"update"},II);var MY={axisPointer:1,tooltip:1,brush:1};function AY(e,t,n){var i=t.getComponentByElement(e.topTarget);if(!i||i===n||MY.hasOwnProperty(i.mainType))return!1;var a=i.coordinateSystem;if(!a||a.model===n)return!1;var r=dL(i),s=dL(n);return!((r.zlevel-s.zlevel||r.z-s.z)<=0)}var EY=function(e){function t(t){var n=e.call(this)||this;n._zr=t;var i=GC(n._mousedownHandler,n),a=GC(n._mousemoveHandler,n),r=GC(n._mouseupHandler,n),s=GC(n._mousewheelHandler,n),o=GC(n._pinchHandler,n);return n.enable=function(e,n){var l=n.zInfo,c=dL(l.component),d=c.z,u=c.zlevel,h={component:l.component,z:d,zlevel:u,z2:cI(l.z2,-1/0)},p=RC({},n.triggerInfo);this._opt=$C(RC({},n),{zoomOnMouseWheel:!0,moveOnMouseMove:!0,moveOnMouseWheel:!1,preventDefaultMouseMove:!0,zInfoParsed:h,triggerInfo:p}),null==e&&(e=!0),this._enabled&&this._controlType===e||(this._enabled=!0,this.disable(),!0!==e&&"move"!==e&&"pan"!==e||($Y(t,"mousedown",i,h),$Y(t,"mousemove",a,h),$Y(t,"mouseup",r,h)),!0!==e&&"scale"!==e&&"zoom"!==e||($Y(t,"mousewheel",s,h),$Y(t,"pinch",o,h)))},n.disable=function(){this._enabled=!1,OY(t,"mousedown",i),OY(t,"mousemove",a),OY(t,"mouseup",r),OY(t,"mousewheel",s),OY(t,"pinch",o)},n}return uC(t,e),t.prototype.isDragging=function(){return this._dragging},t.prototype.isPinching=function(){return this._pinching},t.prototype._checkPointer=function(e,t,n){var i=this._opt,a=i.zInfoParsed;if(AY(e,i.api,a.component))return!1;var r=i.triggerInfo,s=!1;return"global"===r.roamTrigger&&(s=!0),s||(s=r.isInSelf(e,t,n)),s&&r.isInClip&&!r.isInClip(e,t,n)&&(s=!1),s},t.prototype._decideCursorStyle=function(e,t,n,i){var a=e.target;return!a&&this._checkPointer(e,t,n)?"grab":i?a&&a.cursor||"default":void 0},t.prototype.dispose=function(){this.disable()},t.prototype._mousedownHandler=function(e){if(!wD(e)&&!zY(e)){for(var t=e.target;t;){if(t.draggable)return;t=t.__hostTarget||t.parent}var n=e.offsetX,i=e.offsetY;this._checkPointer(e,n,i)&&(this._x=n,this._y=i,this._dragging=!0)}},t.prototype._mousemoveHandler=function(e){var t=this._zr;if("pinch"!==e.gestureEvent&&!TY(t,"globalPan")&&!zY(e)){var n=e.offsetX,i=e.offsetY;if(this._dragging&&FY("moveOnMouseMove",e,this._opt)){t.setCursorStyle("grabbing");var a=this._x,r=this._y,s=n-a,o=i-r;this._x=n,this._y=i,this._opt.preventDefaultMouseMove&&bD(e.event),e.__ecRoamConsumed=!0,NY(this,"pan","moveOnMouseMove",e,{dx:s,dy:o,oldX:a,oldY:r,newX:n,newY:i,isAvailableBehavior:null})}else{var l=this._decideCursorStyle(e,n,i,!1);l&&t.setCursorStyle(l)}}},t.prototype._mouseupHandler=function(e){if(!zY(e)){var t=this._zr;if(!wD(e)){this._dragging=!1;var n=this._decideCursorStyle(e,e.offsetX,e.offsetY,!0);n&&t.setCursorStyle(n)}}},t.prototype._mousewheelHandler=function(e){if(!zY(e)){var t=FY("zoomOnMouseWheel",e,this._opt),n=FY("moveOnMouseWheel",e,this._opt),i=e.wheelDelta,a=Math.abs(i),r=e.offsetX,s=e.offsetY;if(0!==i&&(t||n)){if(t){var o=a>3?1.4:a>1?1.2:1.1,l=i>0?o:1/o;this._checkTriggerMoveZoom(this,"zoom","zoomOnMouseWheel",e,{scale:l,originX:r,originY:s,isAvailableBehavior:null})}if(n){var c=Math.abs(i),d=(i>0?1:-1)*(c>3?.4:c>1?.15:.05);this._checkTriggerMoveZoom(this,"scrollMove","moveOnMouseWheel",e,{scrollDelta:d,originX:r,originY:s,isAvailableBehavior:null})}}}},t.prototype._pinchHandler=function(e){if(!TY(this._zr,"globalPan")&&!zY(e)){var t=e.pinchScale>1?1.1:1/1.1;this._checkTriggerMoveZoom(this,"zoom",null,e,{scale:t,originX:e.pinchX,originY:e.pinchY,isAvailableBehavior:null})}},t.prototype._checkTriggerMoveZoom=function(e,t,n,i,a){e._checkPointer(i,a.originX,a.originY)&&(bD(i.event),i.__ecRoamConsumed=!0,NY(e,t,n,i,a))},t}(JI);function zY(e){return e.__ecRoamConsumed}var PY=BE();function RY(e){var t=PY(e);return t.roam=t.roam||{},t.uniform=t.uniform||{},t}function $Y(e,t,n,i){for(var a=RY(e).roam,r=a[t]=a[t]||[],s=0;s<r.length;s++){var o=r[s].zInfoParsed;if((o.zlevel-i.zlevel||o.z-i.z||o.z2-i.z2)<=0)break}r.splice(s,0,{listener:n,zInfoParsed:i}),function(e,t){var n=RY(e);n.uniform[t]||e.on(t,n.uniform[t]=function(e){var i=n.roam[t];if(i)for(var a=0;a<i.length;a++)i[a].listener(e)})}(e,t)}function OY(e,t,n){for(var i=RY(e).roam[t]||[],a=0;a<i.length;a++)if(i[a].listener===n)return i.splice(a,1),void(i.length||LY(e,t))}function LY(e,t){var n=RY(e).uniform;n[t]&&(e.off(t,n[t]),n[t]=null)}function NY(e,t,n,i,a){a.isAvailableBehavior=GC(FY,null,n,i),e.trigger(t,a)}function FY(e,t,n){var i=n[e];return!e||i&&(!YC(i)||t.event[i+"Key"])}var BY=jC,jY=eI,UY=-1,VY=function(){function e(t){var n=t.mappingMethod,i=t.type,a=this.option=zC(t);this.type=i,this.mappingMethod=n,this._normalizeData=JY[n];var r=e.visualHandlers[i];this.applyVisual=r.applyVisual,this.getColorMapper=r.getColorMapper,this._normalizedToVisual=r._normalizedToVisual[n],"piecewise"===n?(qY(a),function(e){var t=e.pieceList;e.hasSpecialVisual=!1,jC(t,function(t,n){t.originIndex=n,null!=t.visual&&(e.hasSpecialVisual=!0)})}(a)):"category"===n?a.categories?function(e){var t=e.categories,n=e.categoryMap={},i=e.visual;if(BY(t,function(e,t){n[e]=t}),!KC(i)){var a=[];eI(i)?BY(i,function(e,t){var i=n[t];a[null!=i?i:UY]=e}):a[-1]=i,i=XY(e,a)}for(var r=t.length-1;r>=0;r--)null==i[r]&&(delete n[t[r]],t.pop())}(a):qY(a,!0):(pI("linear"!==n||a.dataExtent),qY(a))}return e.prototype.mapValueToVisual=function(e){var t=this._normalizeData(e);return this._normalizedToVisual(t,e)},e.prototype.getNormalizer=function(){return GC(this._normalizeData,this)},e.listVisualTypes=function(){return WC(e.visualHandlers)},e.isValidType=function(t){return e.visualHandlers.hasOwnProperty(t)},e.eachVisual=function(e,t,n){eI(e)?jC(e,t,n):t.call(n,e)},e.mapVisual=function(t,n,i){var a,r=KC(t)?[]:eI(t)?{}:(a=!0,null);return e.eachVisual(t,function(e,t){var s=n.call(i,e,t);a?r=s:r[t]=s}),r},e.retrieveVisuals=function(t){var n,i={};return t&&BY(e.visualHandlers,function(e,a){t.hasOwnProperty(a)&&(i[a]=t[a],n=!0)}),n?i:null},e.prepareVisualTypes=function(e){if(KC(e))e=e.slice();else{if(!jY(e))return[];var t=[];BY(e,function(e,n){t.push(n)}),e=t}return e.sort(function(e,t){return"color"===t&&"color"!==e&&0===e.indexOf("color")?1:-1}),e},e.dependsOn=function(e,t){return"color"===t?!(!e||0!==e.indexOf(t)):e===t},e.findPieceIndex=function(e,t,n){for(var i,a=1/0,r=0,s=t.length;r<s;r++){var o=t[r].value;if(null!=o){if(o===e||YC(o)&&o===e+"")return r;n&&u(o,r)}}for(r=0,s=t.length;r<s;r++){var l=t[r],c=l.interval,d=l.close;if(c){if(c[0]===-1/0){if(eX(d[1],e,c[1]))return r}else if(c[1]===1/0){if(eX(d[0],c[0],e))return r}else if(eX(d[0],c[0],e)&&eX(d[1],e,c[1]))return r;n&&u(c[0],r),n&&u(c[1],r)}}if(n)return e===1/0?t.length-1:e===-1/0?0:i;function u(t,n){var r=Math.abs(t-e);r<a&&(a=r,i=n)}},e.visualHandlers={color:{applyVisual:GY("color"),getColorMapper:function(){var e=this.option;return GC("category"===e.mappingMethod?function(e,t){return!t&&(e=this._normalizeData(e)),QY.call(this,e)}:function(t,n,i){var a=!!i;return!n&&(t=this._normalizeData(t)),i=uM(t,e.parsedVisual,i),a?i:mM(i,"rgba")},this)},_normalizedToVisual:{linear:function(e){return mM(uM(e,this.option.parsedVisual),"rgba")},category:QY,piecewise:function(e,t){var n=YY.call(this,t);return null==n&&(n=mM(uM(e,this.option.parsedVisual),"rgba")),n},fixed:KY}},colorHue:HY(function(e,t){return vM(e,t)}),colorSaturation:HY(function(e,t){return vM(e,null,t)}),colorLightness:HY(function(e,t){return vM(e,null,null,t)}),colorAlpha:HY(function(e,t){return fM(e,t)}),decal:{applyVisual:GY("decal"),_normalizedToVisual:{linear:null,category:QY,piecewise:null,fixed:null}},opacity:{applyVisual:GY("opacity"),_normalizedToVisual:ZY([0,1])},liftZ:{applyVisual:GY("liftZ"),_normalizedToVisual:{linear:KY,category:KY,piecewise:KY,fixed:KY}},symbol:{applyVisual:function(e,t,n){n("symbol",this.mapValueToVisual(e))},_normalizedToVisual:{linear:WY,category:QY,piecewise:function(e,t){var n=YY.call(this,t);return null==n&&(n=WY.call(this,e)),n},fixed:KY}},symbolSize:{applyVisual:GY("symbolSize"),_normalizedToVisual:ZY([0,1])}},e}();function qY(e,t){var n=e.visual,i=[];eI(n)?BY(n,function(e){i.push(e)}):null!=n&&i.push(n);t||1!==i.length||{color:1,symbol:1}.hasOwnProperty(e.type)||(i[1]=i[0]),XY(e,i)}function HY(e){return{applyVisual:function(t,n,i){var a=this.mapValueToVisual(t);i("color",e(n("color"),a))},_normalizedToVisual:ZY([0,1])}}function WY(e){var t=this.option.visual;return t[Math.round(eE(e,[0,1],[0,t.length-1],!0))]||{}}function GY(e){return function(t,n,i){i(e,this.mapValueToVisual(t))}}function QY(e){var t=this.option.visual;return t[this.option.loop&&e!==UY?e%t.length:e]}function KY(){return this.option.visual[0]}function ZY(e){return{linear:function(t){return eE(t,e,this.option.visual,!0)},category:QY,piecewise:function(t,n){var i=YY.call(this,n);return null==i&&(i=eE(t,e,this.option.visual,!0)),i},fixed:KY}}function YY(e){var t=this.option,n=t.pieceList;if(t.hasSpecialVisual){var i=n[VY.findPieceIndex(e,n)];if(i&&i.visual)return i.visual[this.type]}}function XY(e,t){return e.visual=t,"color"===e.type&&(e.parsedVisual=UC(t,function(e){return lM(e)||[0,0,0,1]})),t}var JY={linear:function(e){return eE(e,this.option.dataExtent,[0,1],!0)},piecewise:function(e){var t=this.option.pieceList,n=VY.findPieceIndex(e,t,!0);if(null!=n)return eE(n,[0,t.length-1],[0,1],!0)},category:function(e){var t=this.option.categories?this.option.categoryMap[e]:e;return null==t?UY:t},fixed:II};function eX(e,t,n){return e?t<=n:t<n}var tX=X$.prototype,nX=nO.prototype,iX=function(){return function(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.percent=1}}();function aX(e){return isNaN(+e.cpx1)||isNaN(+e.cpy1)}!function(e){function t(){return null!==e&&e.apply(this,arguments)||this}uC(t,e)}(iX);var rX=function(e){function t(t){var n=e.call(this,t)||this;return n.type="ec-line",n}return uC(t,e),t.prototype.getDefaultStyle=function(){return{stroke:uF.color.neutral99,fill:null}},t.prototype.getDefaultShape=function(){return new iX},t.prototype.buildPath=function(e,t){aX(t)?tX.buildPath.call(this,e,t):nX.buildPath.call(this,e,t)},t.prototype.pointAt=function(e){return aX(this.shape)?tX.pointAt.call(this,e):nX.pointAt.call(this,e)},t.prototype.tangentAt=function(e){var t=this.shape,n=aX(t)?[t.x2-t.x1,t.y2-t.y1]:nX.tangentAt.call(this,e);return jI(n,n)},t}(LP),sX=["fromSymbol","toSymbol"];function oX(e){return"_"+e+"Type"}function lX(e,t,n){var i=t.getItemVisual(n,e);if(!i||"none"===i)return i;var a=t.getItemVisual(n,e+"Size"),r=t.getItemVisual(n,e+"Rotate"),s=t.getItemVisual(n,e+"Offset"),o=t.getItemVisual(n,e+"KeepAspect"),l=fV(a);return i+l+mV(s||0,l)+(r||"")+(o||"")}function cX(e,t,n){var i=t.getItemVisual(n,e);if(i&&"none"!==i){var a=t.getItemVisual(n,e+"Size"),r=t.getItemVisual(n,e+"Rotate"),s=t.getItemVisual(n,e+"Offset"),o=t.getItemVisual(n,e+"KeepAspect"),l=fV(a),c=mV(s||0,l),d=vV(i,-l[0]/2+c[0],-l[1]/2+c[1],l[0],l[1],null,o);return d.__specifiedRotation=null==r||isNaN(r)?void 0:+r*Math.PI/180||0,d.name=e,d}}function dX(e,t){e.x1=t[0][0],e.y1=t[0][1],e.x2=t[1][0],e.y2=t[1][1],e.percent=1;var n=t[2];n?(e.cpx1=n[0],e.cpy1=n[1]):(e.cpx1=NaN,e.cpy1=NaN)}var uX=function(e){function t(t,n,i){var a=e.call(this)||this;return a._createLine(t,n,i),a}return uC(t,e),t.prototype._createLine=function(e,t,n){var i=e.hostModel,a=e.getItemLayout(t),r=e.getItemVisual(t,"z2"),s=function(e){var t=new rX({name:"line",subPixelOptimize:!0});return dX(t.shape,e),t}(a);s.shape.percent=0,xO(s,{z2:cI(r,0),shape:{percent:1}},i,t),this.add(s),jC(sX,function(n){var i=cX(n,e,t);this.add(i),this[oX(n)]=lX(n,e,t)},this),this._updateCommonStl(e,t,n)},t.prototype.updateData=function(e,t,n){var i=e.hostModel,a=this.childOfName("line"),r=e.getItemLayout(t),s={shape:{}};dX(s.shape,r),SO(a,s,i,t),jC(sX,function(n){var i=lX(n,e,t),a=oX(n);if(this[a]!==i){this.remove(this.childOfName(n));var r=cX(n,e,t);this.add(r)}this[a]=i},this),this._updateCommonStl(e,t,n)},t.prototype.getLinePath=function(){return this.childAt(0)},t.prototype._updateCommonStl=function(e,t,n){var i=e.hostModel,a=this.childOfName("line"),r=n&&n.emphasisLineStyle,s=n&&n.blurLineStyle,o=n&&n.selectLineStyle,l=n&&n.labelStatesModels,c=n&&n.emphasisDisabled,d=n&&n.focus,u=n&&n.blurScope;if(!n||e.hasItemOption){var h=e.getItemModel(t),p=h.getModel("emphasis");r=p.getModel("lineStyle").getLineStyle(),s=h.getModel(["blur","lineStyle"]).getLineStyle(),o=h.getModel(["select","lineStyle"]).getLineStyle(),c=p.get("disabled"),d=p.get("focus"),u=p.get("blurScope"),l=yL(h)}var g=e.getItemVisual(t,"style"),v=g.stroke;a.useStyle(g),a.style.fill=null,a.style.strokeNoScale=!0,a.ensureState("emphasis").style=r,a.ensureState("blur").style=s,a.ensureState("select").style=o,jC(sX,function(e){var t=this.childOfName(e);if(t){t.setColor(v),t.style.opacity=g.opacity;for(var n=0;n<fR.length;n++){var i=fR[n],r=a.getState(i);if(r){var s=r.style||{},o=t.ensureState(i),l=o.style||(o.style={});null!=s.stroke&&(l[t.__isEmptyBrush?"stroke":"fill"]=s.stroke),null!=s.opacity&&(l.opacity=s.opacity)}}t.markRedraw()}},this);var f=i.getRawValue(t);mL(this,l,{labelDataIndex:t,labelFetcher:{getFormattedLabel:function(t,n){return i.getFormattedLabel(t,n,e.dataType)}},inheritColor:v||uF.color.neutral99,defaultOpacity:g.opacity,defaultText:(null==f?e.getName(t):isFinite(f)?iE(f):f)+""});var m=this.getTextContent();if(m){var y=l.normal;m.__align=m.style.align,m.__verticalAlign=m.style.verticalAlign,m.__position=y.get("position")||"middle";var b=y.get("distance");KC(b)||(b=[b,b]),m.__labelDistance=b}this.setTextConfig({position:null,local:!0,inside:!1}),JR(this,d,u,c)},t.prototype.highlight=function(){FR(this)},t.prototype.downplay=function(){BR(this)},t.prototype.updateLayout=function(e,t){this.setLinePoints(e.getItemLayout(t))},t.prototype.setLinePoints=function(e){var t=this.childOfName("line");dX(t.shape,e),t.dirty()},t.prototype.beforeUpdate=function(){var e=this,t=e.childOfName("fromSymbol"),n=e.childOfName("toSymbol"),i=e.getTextContent();if(t||n||i&&!i.ignore){for(var a=1,r=this.parent;r;)r.scaleX&&(a/=r.scaleX),r=r.parent;var s=e.childOfName("line");if(this.__dirty||s.__dirty){var o=s.shape.percent,l=s.pointAt(0),c=s.pointAt(o),d=$I([],c,l);if(jI(d,d),t&&(t.setPosition(l),x(t,0),t.scaleX=t.scaleY=a*o,t.markRedraw()),n&&(n.setPosition(c),x(n,1),n.scaleX=n.scaleY=a*o,n.markRedraw()),i&&!i.ignore){i.x=i.y=0,i.originX=i.originY=0;var u=void 0,h=void 0,p=i.__labelDistance,g=p[0]*a,v=p[1]*a,f=o/2,m=s.tangentAt(f),y=[m[1],-m[0]],b=s.pointAt(f);y[1]>0&&(y[0]=-y[0],y[1]=-y[1]);var w=m[0]<0?-1:1;if("start"!==i.__position&&"end"!==i.__position){var k=-Math.atan2(m[1],m[0]);c[0]<l[0]&&(k=Math.PI+k),i.rotation=k}var S=void 0;switch(i.__position){case"insideStartTop":case"insideMiddleTop":case"insideEndTop":case"middle":S=-v,h="bottom";break;case"insideStartBottom":case"insideMiddleBottom":case"insideEndBottom":S=v,h="top";break;default:S=0,h="middle"}switch(i.__position){case"end":i.x=d[0]*g+c[0],i.y=d[1]*v+c[1],u=d[0]>.8?"left":d[0]<-.8?"right":"center",h=d[1]>.8?"top":d[1]<-.8?"bottom":"middle";break;case"start":i.x=-d[0]*g+l[0],i.y=-d[1]*v+l[1],u=d[0]>.8?"right":d[0]<-.8?"left":"center",h=d[1]>.8?"bottom":d[1]<-.8?"top":"middle";break;case"insideStartTop":case"insideStart":case"insideStartBottom":i.x=g*w+l[0],i.y=l[1]+S,u=m[0]<0?"right":"left",i.originX=-g*w,i.originY=-S;break;case"insideMiddleTop":case"insideMiddle":case"insideMiddleBottom":case"middle":i.x=b[0],i.y=b[1]+S,u="center",i.originY=-S;break;case"insideEndTop":case"insideEnd":case"insideEndBottom":i.x=-g*w+c[0],i.y=c[1]+S,u=m[0]>=0?"right":"left",i.originX=g*w,i.originY=-S}i.scaleX=i.scaleY=a,i.setStyle({verticalAlign:i.__verticalAlign||h,align:i.__align||u})}}}function x(e,t){var n=e.__specifiedRotation;if(null==n){var i=s.tangentAt(t);e.attr("rotation",(1===t?-1:1)*Math.PI/2-Math.atan2(i[1],i[0]))}else e.attr("rotation",n)}},t}(jA),hX=function(){function e(e){this.group=new jA,this._LineCtor=e||uX}return e.prototype.updateData=function(e){var t=this;this._progressiveEls=null;var n=this,i=n.group,a=n._lineData;n._lineData=e,a||i.removeAll();var r=pX(e);e.diff(a).add(function(n){t._doAdd(e,n,r)}).update(function(n,i){t._doUpdate(a,e,i,n,r)}).remove(function(e){i.remove(a.getItemGraphicEl(e))}).execute()},e.prototype.updateLayout=function(){var e=this._lineData;e&&e.eachItemGraphicEl(function(t,n){t.updateLayout(e,n)},this)},e.prototype.incrementalPrepareUpdate=function(e){this._seriesScope=pX(e),this._lineData=null,this.group.removeAll()},e.prototype.incrementalUpdate=function(e,t){function n(e){e.isGroup||function(e){return e.animators&&e.animators.length>0}(e)||(e.incremental=!0,e.ensureState("emphasis").hoverLayer=!0)}this._progressiveEls=[];for(var i=e.start;i<e.end;i++){if(vX(t.getItemLayout(i))){var a=new this._LineCtor(t,i,this._seriesScope);a.traverse(n),this.group.add(a),t.setItemGraphicEl(i,a),this._progressiveEls.push(a)}}},e.prototype.remove=function(){this.group.removeAll()},e.prototype.eachRendered=function(e){rL(this._progressiveEls||this.group,e)},e.prototype._doAdd=function(e,t,n){if(vX(e.getItemLayout(t))){var i=new this._LineCtor(e,t,n);e.setItemGraphicEl(t,i),this.group.add(i)}},e.prototype._doUpdate=function(e,t,n,i,a){var r=e.getItemGraphicEl(n);vX(t.getItemLayout(i))?(r?r.updateData(t,i,a):r=new this._LineCtor(t,i,a),t.setItemGraphicEl(i,r),this.group.add(r)):this.group.remove(r)},e}();function pX(e){var t=e.hostModel,n=t.getModel("emphasis");return{lineStyle:t.getModel("lineStyle").getLineStyle(),emphasisLineStyle:n.getModel(["lineStyle"]).getLineStyle(),blurLineStyle:t.getModel(["blur","lineStyle"]).getLineStyle(),selectLineStyle:t.getModel(["select","lineStyle"]).getLineStyle(),emphasisDisabled:n.get("disabled"),blurScope:n.get("blurScope"),focus:n.get("focus"),labelStatesModels:yL(t)}}function gX(e){return isNaN(e[0])||isNaN(e[1])}function vX(e){return e&&!gX(e[0])&&!gX(e[1])}function fX(e,t,n,i,a,r){e=e||0;var s=n[1]-n[0];if(null!=a&&(a=yX(a,[0,s])),null!=r&&(r=Math.max(r,null!=a?a:0)),"all"===i){var o=Math.abs(t[1]-t[0]);o=yX(o,[0,s]),a=r=yX(o,[a,r]),i=0}t[0]=yX(t[0],n),t[1]=yX(t[1],n);var l=mX(t,i);t[i]+=e;var c,d=a||0,u=n.slice();return l.sign<0?u[0]+=d:u[1]-=d,t[i]=yX(t[i],u),c=mX(t,i),null!=a&&(c.sign!==l.sign||c.span<a)&&(t[1-i]=t[i]+l.sign*a),c=mX(t,i),null!=r&&c.span>r&&(t[1-i]=t[i]+c.sign*r),t}function mX(e,t){var n=e[t]-e[1-t];return{span:Math.abs(n),sign:n>0?-1:n<0?1:t?-1:1}}function yX(e,t){return Math.min(null!=t[1]?t[1]:1/0,Math.max(null!=t[0]?t[0]:-1/0,e))}var bX=!0,wX=Math.min,kX=Math.max,SX=Math.pow,xX="globalPan",_X={w:[0,0],e:[0,1],n:[1,0],s:[1,1]},CX={w:"ew",e:"ew",n:"ns",s:"ns",ne:"nesw",sw:"nesw",nw:"nwse",se:"nwse"},IX={brushStyle:{lineWidth:2,stroke:uF.color.backgroundTint,fill:uF.color.borderTint},transformable:!0,brushMode:"single",removeOnClick:!1},DX=0,TX=function(e){function t(t){var n=e.call(this)||this;return n._track=[],n._covers=[],n._handlers={},n._zr=t,n.group=new jA,n._uid="brushController_"+DX++,jC(tJ,function(e,t){this._handlers[t]=GC(e,this)},n),n}return uC(t,e),t.prototype.enableBrush=function(e){return this._brushType&&this._doDisableBrush(),e.brushType&&this._doEnableBrush(e),this},t.prototype._doEnableBrush=function(e){var t=this._zr;this._enableGlobalPan||function(e,t,n){DY(e)[t]=n}(t,xX,this._uid),jC(this._handlers,function(e,n){t.on(n,e)}),this._brushType=e.brushType,this._brushOption=PC(zC(IX),e,!0)},t.prototype._doDisableBrush=function(){var e=this._zr;!function(e,t,n){var i=DY(e);i[t]===n&&(i[t]=null)}(e,xX,this._uid),jC(this._handlers,function(t,n){e.off(n,t)}),this._brushType=this._brushOption=null},t.prototype.setPanels=function(e){if(e&&e.length){var t=this._panels={};jC(e,function(e){t[e.panelId]=zC(e)})}else this._panels=null;return this},t.prototype.mount=function(e){e=e||{},this._enableGlobalPan=e.enableGlobalPan;var t=this.group;return this._zr.add(t),t.attr({x:e.x||0,y:e.y||0,rotation:e.rotation||0,scaleX:e.scaleX||1,scaleY:e.scaleY||1}),this._transform=t.getLocalTransform(),this},t.prototype.updateCovers=function(e){e=UC(e,function(e){return PC(zC(IX),e,!0)});var t=this._covers,n=this._covers=[],i=this,a=this._creatingCover;return new hH(t,e,function(e,t){return r(e.__brushOption,t)},r).add(s).update(s).remove(function(e){t[e]!==a&&i.group.remove(t[e])}).execute(),this;function r(e,t){return(null!=e.id?e.id:"\0-brush-index-"+t)+"-"+e.brushType}function s(r,s){var o=e[r];if(null!=s&&t[s]===a)n[r]=t[s];else{var l=n[r]=null!=s?(t[s].__brushOption=o,t[s]):AX(i,MX(i,o));PX(i,l)}}},t.prototype.unmount=function(){return this.enableBrush(!1),LX(this),this._zr.remove(this.group),this},t.prototype.dispose=function(){this.unmount(),this.off()},t}(JI);function MX(e,t){var n=iJ[t.brushType].createCover(e,t);return n.__brushOption=t,zX(n,t),e.group.add(n),n}function AX(e,t){var n=RX(t);return n.endCreating&&(n.endCreating(e,t),zX(t,t.__brushOption)),t}function EX(e,t){var n=t.__brushOption;RX(t).updateCoverShape(e,t,n.range,n)}function zX(e,t){var n=t.z;null==n&&(n=1e4),e.traverse(function(e){e.z=n,e.z2=n})}function PX(e,t){RX(t).updateCommon(e,t),EX(e,t)}function RX(e){return iJ[e.__brushOption.brushType]}function $X(e,t,n){var i,a=e._panels;if(!a)return bX;var r=e._transform;return jC(a,function(e){e.isTargetByCursor(t,n,r)&&(i=e)}),i}function OX(e,t){var n=e._panels;if(!n)return bX;var i=t.__brushOption.panelId;return null!=i?n[i]:bX}function LX(e){var t=e._covers,n=t.length;return jC(t,function(t){e.group.remove(t)},e),t.length=0,!!n}function NX(e,t){var n=UC(e._covers,function(e){var t=e.__brushOption,n=zC(t.range);return{brushType:t.brushType,panelId:t.panelId,range:n}});e.trigger("brush",{areas:n,isEnd:!!t.isEnd,removeOnClick:!!t.removeOnClick})}function FX(e){var t=e.length-1;return t<0&&(t=0),[e[0],e[t]]}function BX(e,t,n,i){var a=new jA;return a.add(new KP({name:"main",style:qX(n),silent:!0,draggable:!0,cursor:"move",drift:QC(GX,e,t,a,["n","s","w","e"]),ondragend:QC(NX,t,{isEnd:!0})})),jC(i,function(n){a.add(new KP({name:n.join(""),style:{opacity:0},draggable:!0,silent:!0,invisible:!0,drift:QC(GX,e,t,a,n),ondragend:QC(NX,t,{isEnd:!0})}))}),a}function jX(e,t,n,i){var a=i.brushStyle.lineWidth||0,r=kX(a,6),s=n[0][0],o=n[1][0],l=s-a/2,c=o-a/2,d=n[0][1],u=n[1][1],h=d-r+a/2,p=u-r+a/2,g=d-s,v=u-o,f=g+a,m=v+a;VX(e,t,"main",s,o,g,v),i.transformable&&(VX(e,t,"w",l,c,r,m),VX(e,t,"e",h,c,r,m),VX(e,t,"n",l,c,f,r),VX(e,t,"s",l,p,f,r),VX(e,t,"nw",l,c,r,r),VX(e,t,"ne",h,c,r,r),VX(e,t,"sw",l,p,r,r),VX(e,t,"se",h,p,r,r))}function UX(e,t){var n=t.__brushOption,i=n.transformable,a=t.childAt(0);a.useStyle(qX(n)),a.attr({silent:!i,cursor:i?"move":"default"}),jC([["w"],["e"],["n"],["s"],["s","e"],["s","w"],["n","e"],["n","w"]],function(n){var a=t.childOfName(n.join("")),r=1===n.length?WX(e,n[0]):function(e,t){var n=[WX(e,t[0]),WX(e,t[1])];return("e"===n[0]||"w"===n[0])&&n.reverse(),n.join("")}(e,n);a&&a.attr({silent:!i,invisible:!i,cursor:i?CX[r]+"-resize":null})})}function VX(e,t,n,i,a,r,s){var o,l,c,d,u,h=t.childOfName(n);h&&h.setShape((o=ZX(e,t,[[i,a],[i+r,a+s]]),l=wX(o[0][0],o[1][0]),c=wX(o[0][1],o[1][1]),d=kX(o[0][0],o[1][0]),u=kX(o[0][1],o[1][1]),{x:l,y:c,width:d-l,height:u-c}))}function qX(e){return $C({strokeNoScale:!0},e.brushStyle)}function HX(e,t,n,i){var a=[wX(e,n),wX(t,i)],r=[kX(e,n),kX(t,i)];return[[a[0],r[0]],[a[1],r[1]]]}function WX(e,t){var n=WO({w:"left",e:"right",n:"top",s:"bottom"}[t],function(e){return qO(e.group)}(e));return{left:"w",right:"e",top:"n",bottom:"s"}[n]}function GX(e,t,n,i,a,r){var s=n.__brushOption,o=e.toRectRange(s.range),l=KX(t,a,r);jC(i,function(e){var t=_X[e];o[t[0]][t[1]]+=l[t[0]]}),s.range=e.fromRectRange(HX(o[0][0],o[1][0],o[0][1],o[1][1])),PX(t,n),NX(t,{isEnd:!1})}function QX(e,t,n,i){var a=t.__brushOption.range,r=KX(e,n,i);jC(a,function(e){e[0]+=r[0],e[1]+=r[1]}),PX(e,t),NX(e,{isEnd:!1})}function KX(e,t,n){var i=e.group,a=i.transformCoordToLocal(t,n),r=i.transformCoordToLocal(0,0);return[a[0]-r[0],a[1]-r[1]]}function ZX(e,t,n){var i=OX(e,t);return i&&i!==bX?i.clipPath(n,e._transform):zC(n)}function YX(e){var t=e.event;t.preventDefault&&t.preventDefault()}function XX(e,t,n){return e.childOfName("main").contain(t,n)}function JX(e,t,n,i){var a,r=e._creatingCover,s=e._creatingPanel,o=e._brushOption;if(e._track.push(n.slice()),function(e){var t=e._track;if(!t.length)return!1;var n=t[t.length-1],i=t[0],a=n[0]-i[0],r=n[1]-i[1];return SX(a*a+r*r,.5)>6}(e)||r){if(s&&!r){"single"===o.brushMode&&LX(e);var l=zC(o);l.brushType=eJ(l.brushType,s),l.panelId=s===bX?null:s.panelId,r=e._creatingCover=MX(e,l),e._covers.push(r)}if(r){var c=iJ[eJ(e._brushType,s)];r.__brushOption.range=c.getCreatingRange(ZX(e,r,e._track)),i&&(AX(e,r),c.updateCommon(e,r)),EX(e,r),a={isEnd:i}}}else i&&"single"===o.brushMode&&o.removeOnClick&&$X(e,t,n)&&LX(e)&&(a={isEnd:i,removeOnClick:!0});return a}function eJ(e,t){return"auto"===e?t.defaultBrushType:e}var tJ={mousedown:function(e){if(this._dragging)nJ(this,e);else if(!e.target||!e.target.draggable){YX(e);var t=this.group.transformCoordToLocal(e.offsetX,e.offsetY);this._creatingCover=null,(this._creatingPanel=$X(this,e,t))&&(this._dragging=!0,this._track=[t.slice()])}},mousemove:function(e){var t=e.offsetX,n=e.offsetY,i=this.group.transformCoordToLocal(t,n);if(function(e,t,n){if(e._brushType&&!function(e,t,n){var i=e._zr;return t<0||t>i.getWidth()||n<0||n>i.getHeight()}(e,t.offsetX,t.offsetY)){var i=e._zr,a=e._covers,r=$X(e,t,n);if(!e._dragging)for(var s=0;s<a.length;s++){var o=a[s].__brushOption;if(r&&(r===bX||o.panelId===r.panelId)&&iJ[o.brushType].contain(a[s],n[0],n[1]))return}r&&i.setCursorStyle("crosshair")}}(this,e,i),this._dragging){YX(e);var a=JX(this,e,i,!1);a&&NX(this,a)}},mouseup:function(e){nJ(this,e)}};function nJ(e,t){if(e._dragging){YX(t);var n=t.offsetX,i=t.offsetY,a=e.group.transformCoordToLocal(n,i),r=JX(e,t,a,!0);e._dragging=!1,e._track=[],e._creatingCover=null,r&&NX(e,r)}}var iJ={lineX:aJ(0),lineY:aJ(1),rect:{createCover:function(e,t){function n(e){return e}return BX({toRectRange:n,fromRectRange:n},e,t,[["w"],["e"],["n"],["s"],["s","e"],["s","w"],["n","e"],["n","w"]])},getCreatingRange:function(e){var t=FX(e);return HX(t[1][0],t[1][1],t[0][0],t[0][1])},updateCoverShape:function(e,t,n,i){jX(e,t,n,i)},updateCommon:UX,contain:XX},polygon:{createCover:function(e,t){var n=new jA;return n.add(new K$({name:"main",style:qX(t),silent:!0})),n},getCreatingRange:function(e){return e},endCreating:function(e,t){t.remove(t.childAt(0)),t.add(new G$({name:"main",draggable:!0,drift:QC(QX,e,t),ondragend:QC(NX,e,{isEnd:!0})}))},updateCoverShape:function(e,t,n,i){t.childAt(0).setShape({points:ZX(e,t,n)})},updateCommon:UX,contain:XX}};function aJ(e){return{createCover:function(t,n){return BX({toRectRange:function(t){var n=[t,[0,100]];return e&&n.reverse(),n},fromRectRange:function(t){return t[e]}},t,n,[[["w"],["e"]],[["n"],["s"]]][e])},getCreatingRange:function(t){var n=FX(t);return[wX(n[0][e],n[1][e]),kX(n[0][e],n[1][e])]},updateCoverShape:function(t,n,i,a){var r,s=OX(t,n);if(s!==bX&&s.getLinearBrushOtherExtent)r=s.getLinearBrushOtherExtent(e);else{var o=t._zr;r=[0,[o.getWidth(),o.getHeight()][1-e]]}var l=[i,r];e&&l.reverse(),jX(t,n,l,a)},updateCommon:UX,contain:XX}}function rJ(e){return e=lJ(e),function(t){return KO(t,e)}}function sJ(e,t){return e=lJ(e),function(n){var i=null!=t?t:n,a=i?e.width:e.height,r=i?e.x:e.y;return[r,r+(a||0)]}}function oJ(e,t,n){var i=lJ(e);return function(e,a){return i.contain(a[0],a[1])&&!AY(e,t,n)}}function lJ(e){return GD.create(e)}var cJ=function(){function e(){this.blurSize=30,this.pointSize=20,this.maxOpacity=1,this.minOpacity=0,this._gradientPixels={inRange:null,outOfRange:null};var e=fC.createCanvas();this.canvas=e}return e.prototype.update=function(e,t,n,i,a,r){var s=this._getBrush(),o=this._getGradient(a,"inRange"),l=this._getGradient(a,"outOfRange"),c=this.pointSize+this.blurSize,d=this.canvas,u=d.getContext("2d"),h=e.length;d.width=t,d.height=n;for(var p=0;p<h;++p){var g=e[p],v=g[0],f=g[1],m=i(g[2]);u.globalAlpha=m,u.drawImage(s,v-c,f-c)}if(!d.width||!d.height)return d;for(var y=u.getImageData(0,0,d.width,d.height),b=y.data,w=0,k=b.length,S=this.minOpacity,x=this.maxOpacity-S;w<k;){m=b[w+3]/256;var _=4*Math.floor(255*m);if(m>0){var C=r(m)?o:l;m>0&&(m=m*x+S),b[w++]=C[_],b[w++]=C[_+1],b[w++]=C[_+2],b[w++]=C[_+3]*m*256}else w+=4}return u.putImageData(y,0,0),d},e.prototype._getBrush=function(){var e=this._brushCanvas||(this._brushCanvas=fC.createCanvas()),t=this.pointSize+this.blurSize,n=2*t;e.width=n,e.height=n;var i=e.getContext("2d");return i.clearRect(0,0,n,n),i.shadowOffsetX=n,i.shadowBlur=this.blurSize,i.shadowColor=uF.color.neutral99,i.beginPath(),i.arc(-t,t,this.pointSize,0,2*Math.PI,!0),i.closePath(),i.fill(),e},e.prototype._getGradient=function(e,t){for(var n=this._gradientPixels,i=n[t]||(n[t]=new Uint8ClampedArray(1024)),a=[0,0,0,0],r=0,s=0;s<256;s++)e[t](s/255,!0,a),i[r++]=a[0],i[r++]=a[1],i[r++]=a[2],i[r++]=a[3];return i},e}();function dJ(e){var t=e.dimensions;return"lng"===t[0]&&"lat"===t[1]}var uJ=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.render=function(e,t,n){var i;t.eachComponent("visualMap",function(t){t.eachTargetSeries(function(n){n===e&&(i=t)})}),this._progressiveEls=null,this.group.removeAll();var a=e.coordinateSystem;"cartesian2d"===a.type||"calendar"===a.type||"matrix"===a.type?this._renderOnGridLike(e,n,0,e.getData().count()):dJ(a)&&this._renderOnGeo(a,e,i,n)},t.prototype.incrementalPrepareRender=function(e,t,n){this.group.removeAll()},t.prototype.incrementalRender=function(e,t,n,i){var a=t.coordinateSystem;a&&(dJ(a)?this.render(t,n,i):(this._progressiveEls=[],this._renderOnGridLike(t,i,e.start,e.end,!0)))},t.prototype.eachRendered=function(e){rL(this._progressiveEls||this.group,e)},t.prototype._renderOnGridLike=function(e,t,n,i,a){var r,s,o,l,c=e.coordinateSystem,d=JQ(c,"cartesian2d"),u=JQ(c,"matrix");if(d){var h=c.getAxis("x"),p=c.getAxis("y");r=h.getBandWidth()+.5,s=p.getBandWidth()+.5,o=h.scale.getExtent(),l=p.scale.getExtent()}for(var g=this.group,v=e.getData(),f=e.getModel(["emphasis","itemStyle"]).getItemStyle(),m=e.getModel(["blur","itemStyle"]).getItemStyle(),y=e.getModel(["select","itemStyle"]).getItemStyle(),b=e.get(["itemStyle","borderRadius"]),w=yL(e),k=e.getModel("emphasis"),S=k.get("focus"),x=k.get("blurScope"),_=k.get("disabled"),C=d||u?[v.mapDimension("x"),v.mapDimension("y"),v.mapDimension("value")]:[v.mapDimension("time"),v.mapDimension("value")],I=n;I<i;I++){var D=void 0,T=v.getItemVisual(I,"style");if(d){var M=v.get(C[0],I),A=v.get(C[1],I);if(isNaN(v.get(C[2],I))||isNaN(M)||isNaN(A)||M<o[0]||M>o[1]||A<l[0]||A>l[1])continue;var E=c.dataToPoint([M,A]);D=new KP({shape:{x:E[0]-r/2,y:E[1]-s/2,width:r,height:s},style:T})}else if(u){if(oI((z=c.dataToLayout([v.get(C[0],I),v.get(C[1],I)]).rect).x))continue;D=new KP({z2:1,shape:z,style:T})}else{if(isNaN(v.get(C[1],I)))continue;var z,P=c.dataToLayout([v.get(C[0],I)]);if(oI((z=P.contentRect||P.rect).x)||oI(z.y))continue;D=new KP({z2:1,shape:z,style:T})}if(v.hasItemOption){var R=v.getItemModel(I),$=R.getModel("emphasis");f=$.getModel("itemStyle").getItemStyle(),m=R.getModel(["blur","itemStyle"]).getItemStyle(),y=R.getModel(["select","itemStyle"]).getItemStyle(),b=R.get(["itemStyle","borderRadius"]),S=$.get("focus"),x=$.get("blurScope"),_=$.get("disabled"),w=yL(R)}D.shape.r=b;var O=e.getRawValue(I),L="-";O&&null!=O[2]&&(L=O[2]+""),mL(D,w,{labelFetcher:e,labelDataIndex:I,defaultOpacity:T.opacity,defaultText:L}),D.ensureState("emphasis").style=f,D.ensureState("blur").style=m,D.ensureState("select").style=y,JR(D,S,x,_),D.incremental=a,a&&(D.states.emphasis.hoverLayer=!0),g.add(D),v.setItemGraphicEl(I,D),this._progressiveEls&&this._progressiveEls.push(D)}},t.prototype._renderOnGeo=function(e,t,n,i){var a=n.targetVisuals.inRange,r=n.targetVisuals.outOfRange,s=t.getData(),o=this._hmLayer||this._hmLayer||new cJ;o.blurSize=t.get("blurSize"),o.pointSize=t.get("pointSize"),o.minOpacity=t.get("minOpacity"),o.maxOpacity=t.get("maxOpacity");var l=e.getViewRect().clone(),c=e.getRoamTransform();l.applyTransform(c);var d=Math.max(l.x,0),u=Math.max(l.y,0),h=Math.min(l.width+l.x,i.getWidth()),p=Math.min(l.height+l.y,i.getHeight()),g=h-d,v=p-u,f=[s.mapDimension("lng"),s.mapDimension("lat"),s.mapDimension("value")],m=s.mapArray(f,function(t,n,i){var a=e.dataToPoint([t,n]);return a[0]-=d,a[1]-=u,a.push(i),a}),y=n.getExtent(),b="visualMap.continuous"===n.type?function(e,t){var n=e[1]-e[0];return t=[(t[0]-e[0])/n,(t[1]-e[0])/n],function(e){return e>=t[0]&&e<=t[1]}}(y,n.option.range):function(e,t,n){var i=e[1]-e[0],a=(t=UC(t,function(t){return{interval:[(t.interval[0]-e[0])/i,(t.interval[1]-e[0])/i]}})).length,r=0;return function(e){var i;for(i=r;i<a;i++)if((s=t[i].interval)[0]<=e&&e<=s[1]){r=i;break}if(i===a)for(i=r-1;i>=0;i--){var s;if((s=t[i].interval)[0]<=e&&e<=s[1]){r=i;break}}return i>=0&&i<a&&n[i]}}(y,n.getPieceList(),n.option.selected);o.update(m,g,v,a.color.getNormalizer(),{inRange:a.color.getColorMapper(),outOfRange:r.color.getColorMapper()},b);var w=new UP({style:{width:g,height:v,x:d,y:u,image:o.canvas},silent:!0});this.group.add(w)},t.type="heatmap",t}(sU),hJ=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.getInitialData=function(e,t){return qH(0,this,{generateCoord:"value"})},t.prototype.preventIncremental=function(){var e=UN.get(this.get("coordinateSystem"));if(e&&e.dimensions)return"lng"===e.dimensions[0]&&"lat"===e.dimensions[1]},t.type="series.heatmap",t.dependencies=["grid","geo","calendar","matrix"],t.defaultOption={coordinateSystem:"cartesian2d",z:2,geoIndex:0,blurSize:30,pointSize:20,maxOpacity:1,minOpacity:0,select:{itemStyle:{borderColor:uF.color.primary}}},t}(Qj);var pJ=BE(),gJ=zC,vJ=GC;function fJ(e,t,n,i){mJ(pJ(n).lastProp,i)||(pJ(n).lastProp=i,t?SO(n,i,e):(n.stopAnimation(),n.attr(i)))}function mJ(e,t){if(eI(e)&&eI(t)){var n=!0;return jC(t,function(t,i){n=n&&mJ(e[i],t)}),!!n}return e===t}function yJ(e,t){e[t.get(["label","show"])?"show":"hide"]()}function bJ(e){return{x:e.x||0,y:e.y||0,rotation:e.rotation||0}}function wJ(e,t,n){var i=t.get("z"),a=t.get("zlevel");e&&e.traverse(function(e){"group"!==e.type&&(null!=i&&(e.z=i),null!=a&&(e.zlevel=a),e.silent=n)})}function kJ(e,t,n,i,a){var r=SJ(n.get("value"),t.axis,t.ecModel,n.get("seriesDataIndices"),{precision:n.get(["label","precision"]),formatter:n.get(["label","formatter"])}),s=n.getModel("label"),o=zN(s.get("padding")||0),l=s.getFont(),c=_A(r,l),d=a.position,u=c.width+o[1]+o[3],h=c.height+o[0]+o[2],p=a.align;"right"===p&&(d[0]-=u),"center"===p&&(d[0]-=u/2);var g=a.verticalAlign;"bottom"===g&&(d[1]-=h),"middle"===g&&(d[1]-=h/2),function(e,t,n,i){var a=i.getWidth(),r=i.getHeight();e[0]=Math.min(e[0]+t,a)-t,e[1]=Math.min(e[1]+n,r)-n,e[0]=Math.max(e[0],0),e[1]=Math.max(e[1],0)}(d,u,h,i);var v=s.get("backgroundColor");v&&"auto"!==v||(v=t.get(["axisLine","lineStyle","color"])),e.label={x:d[0],y:d[1],style:bL(s,{text:r,font:l,fill:s.getTextColor(),padding:o,backgroundColor:v}),z2:10}}function SJ(e,t,n,i,a){e=t.scale.parse(e);var r=t.scale.getLabel({value:e},{precision:a.precision}),s=a.formatter;if(s){var o={value:UW(t,{value:e}),axisDimension:t.dim,axisIndex:t.index,seriesData:[]};jC(i,function(e){var t=n.getSeriesByIndex(e.seriesIndex),i=e.dataIndexInside,a=t&&t.getDataParams(i);a&&o.seriesData.push(a)}),YC(s)?r=s.replace("{value}",r):ZC(s)&&(r=s(o))}return r}function xJ(e,t,n){var i=[1,0,0,1,0,0];return MD(i,i,n.rotation),TD(i,i,n.position),HO([e.dataToCoord(t),(n.labelOffset||0)+(n.labelDirection||1)*(n.labelMargin||0)],i)}var _J=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.makeElOption=function(e,t,n,i,a){var r=n.axis,s=r.grid,o=i.get("type"),l=CJ(s,r).getOtherAxis(r).getGlobalExtent(),c=r.toGlobalCoord(r.dataToCoord(t,!0));if(o&&"none"!==o){var d=function(e){var t,n=e.get("type"),i=e.getModel(n+"Style");return"line"===n?(t=i.getLineStyle()).fill=null:"shadow"===n&&((t=i.getAreaStyle()).stroke=null),t}(i),u=IJ[o](r,c,l);u.style=d,e.graphicKey=u.type,e.pointer=u}!function(e,t,n,i,a,r){var s=BZ.innerTextLayout(n.rotation,0,n.labelDirection);n.labelMargin=a.get(["label","margin"]),kJ(t,i,a,r,{position:xJ(i.axis,e,n),align:s.textAlign,verticalAlign:s.textVerticalAlign})}(t,e,XZ(s.getRect(),n),n,i,a)},t.prototype.getHandleTransform=function(e,t,n){var i=XZ(t.axis.grid.getRect(),t,{labelInside:!1});i.labelMargin=n.get(["handle","margin"]);var a=xJ(t.axis,e,i);return{x:a[0],y:a[1],rotation:i.rotation+(i.labelDirection<0?Math.PI:0)}},t.prototype.updateHandleTransform=function(e,t,n,i){var a=n.axis,r=a.grid,s=a.getGlobalExtent(!0),o=CJ(r,a).getOtherAxis(a).getGlobalExtent(),l="x"===a.dim?0:1,c=[e.x,e.y];c[l]+=t[l],c[l]=Math.min(s[1],c[l]),c[l]=Math.max(s[0],c[l]);var d=(o[1]+o[0])/2,u=[d,d];u[l]=c[l];return{x:c[0],y:c[1],rotation:e.rotation,cursorPoint:u,tooltipOption:[{verticalAlign:"middle"},{align:"center"}][l]}},t}(function(){function e(){this._dragging=!1,this.animationThreshold=15}return e.prototype.render=function(e,t,n,i){var a=t.get("value"),r=t.get("status");if(this._axisModel=e,this._axisPointerModel=t,this._api=n,i||this._lastValue!==a||this._lastStatus!==r){this._lastValue=a,this._lastStatus=r;var s=this._group,o=this._handle;if(!r||"hide"===r)return s&&s.hide(),void(o&&o.hide());s&&s.show(),o&&o.show();var l={};this.makeElOption(l,a,e,t,n);var c=l.graphicKey;c!==this._lastGraphicKey&&this.clear(n),this._lastGraphicKey=c;var d=this._moveAnimation=this.determineAnimation(e,t);if(s){var u=QC(fJ,t,d);this.updatePointerEl(s,l,u),this.updateLabelEl(s,l,u,t)}else s=this._group=new jA,this.createPointerEl(s,l,e,t),this.createLabelEl(s,l,e,t),n.getZr().add(s);wJ(s,t,!0),this._renderHandle(a)}},e.prototype.remove=function(e){this.clear(e)},e.prototype.dispose=function(e){this.clear(e)},e.prototype.determineAnimation=function(e,t){var n=t.get("animation"),i=e.axis,a="category"===i.type,r=t.get("snap");if(!r&&!a)return!1;if("auto"===n||null==n){var s=this.animationThreshold;if(a&&i.getBandWidth()>s)return!0;if(r){var o=hY(e).seriesDataCount,l=i.getExtent();return Math.abs(l[0]-l[1])/o>s}return!1}return!0===n},e.prototype.makeElOption=function(e,t,n,i,a){},e.prototype.createPointerEl=function(e,t,n,i){var a=t.pointer;if(a){var r=pJ(e).pointerEl=new pL[a.type](gJ(t.pointer));e.add(r)}},e.prototype.createLabelEl=function(e,t,n,i){if(t.label){var a=pJ(e).labelEl=new JP(gJ(t.label));e.add(a),yJ(a,i)}},e.prototype.updatePointerEl=function(e,t,n){var i=pJ(e).pointerEl;i&&t.pointer&&(i.setStyle(t.pointer.style),n(i,{shape:t.pointer.shape}))},e.prototype.updateLabelEl=function(e,t,n,i){var a=pJ(e).labelEl;a&&(a.setStyle(t.label.style),n(a,{x:t.label.x,y:t.label.y}),yJ(a,i))},e.prototype._renderHandle=function(e){if(!this._dragging&&this.updateHandleTransform){var t,n=this._axisPointerModel,i=this._api.getZr(),a=this._handle,r=n.getModel("handle"),s=n.get("status");if(!r.get("show")||!s||"hide"===s)return a&&i.remove(a),void(this._handle=null);this._handle||(t=!0,a=this._handle=YO(r.get("icon"),{cursor:"move",draggable:!0,onmousemove:function(e){bD(e.event)},onmousedown:vJ(this._onHandleDragMove,this,0,0),drift:vJ(this._onHandleDragMove,this),ondragend:vJ(this._onHandleDragEnd,this)}),i.add(a)),wJ(a,n,!1),a.setStyle(r.getItemStyle(null,["color","borderColor","borderWidth","opacity","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY"]));var o=r.get("size");KC(o)||(o=[o,o]),a.scaleX=o[0]/2,a.scaleY=o[1]/2,fU(this,"_doDispatchAxisPointer",r.get("throttle")||0,"fixRate"),this._moveHandleToValue(e,t)}},e.prototype._moveHandleToValue=function(e,t){fJ(this._axisPointerModel,!t&&this._moveAnimation,this._handle,bJ(this.getHandleTransform(e,this._axisModel,this._axisPointerModel)))},e.prototype._onHandleDragMove=function(e,t){var n=this._handle;if(n){this._dragging=!0;var i=this.updateHandleTransform(bJ(n),[e,t],this._axisModel,this._axisPointerModel);this._payloadInfo=i,n.stopAnimation(),n.attr(bJ(i)),pJ(n).lastProp=null,this._doDispatchAxisPointer()}},e.prototype._doDispatchAxisPointer=function(){if(this._handle){var e=this._payloadInfo,t=this._axisModel;this._api.dispatchAction({type:"updateAxisPointer",x:e.cursorPoint[0],y:e.cursorPoint[1],tooltipOption:e.tooltipOption,axesInfo:[{axisDim:t.axis.dim,axisIndex:t.componentIndex}]})}},e.prototype._onHandleDragEnd=function(){if(this._dragging=!1,this._handle){var e=this._axisPointerModel.get("value");this._moveHandleToValue(e),this._api.dispatchAction({type:"hideTip"})}},e.prototype.clear=function(e){this._lastValue=null,this._lastStatus=null;var t=e.getZr(),n=this._group,i=this._handle;t&&n&&(this._lastGraphicKey=null,n&&t.remove(n),i&&t.remove(i),this._group=null,this._handle=null,this._payloadInfo=null),mU(this,"_doDispatchAxisPointer")},e.prototype.doClear=function(){},e.prototype.buildLabel=function(e,t,n){return{x:e[n=n||0],y:e[1-n],width:t[n],height:t[1-n]}},e}());function CJ(e,t){var n={};return n[t.dim+"AxisIndex"]=t.index,e.getCartesian(n)}var IJ={line:function(e,t,n){var i,a,r;return{type:"Line",subPixelOptimize:!0,shape:(i=[t,n[0]],a=[t,n[1]],r=DJ(e),{x1:i[r=r||0],y1:i[1-r],x2:a[r],y2:a[1-r]})}},shadow:function(e,t,n){var i,a,r,s=Math.max(1,e.getBandWidth()),o=n[1]-n[0];return{type:"Rect",shape:(i=[t-s/2,n[0]],a=[s,o],r=DJ(e),{x:i[r=r||0],y:i[1-r],width:a[r],height:a[1-r]})}}};function DJ(e){return"x"===e.dim?0:1}var TJ=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.type="axisPointer",t.defaultOption={show:"auto",z:50,type:"line",snap:!1,triggerTooltip:!0,triggerEmphasis:!0,value:null,status:null,link:[],animation:null,animationDurationUpdate:200,lineStyle:{color:uF.color.border,width:1,type:"dashed"},shadowStyle:{color:uF.color.shadowTint},label:{show:!0,formatter:null,precision:"auto",margin:3,color:uF.color.neutral00,padding:[5,7,5,7],backgroundColor:uF.color.accent60,borderColor:null,borderWidth:0,borderRadius:3},handle:{show:!1,icon:"M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4h1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7v-1.2h6.6z M13.3,22H6.7v-1.2h6.6z M13.3,19.6H6.7v-1.2h6.6z",size:45,margin:50,color:uF.color.accent40,throttle:40}},t}(dF),MJ=BE(),AJ=jC;function EJ(e,t,n){if(!pC.node){var i=t.getZr();MJ(i).records||(MJ(i).records={}),function(e,t){if(MJ(e).initialized)return;function n(n,i){e.on(n,function(n){var a=function(e){var t={showTip:[],hideTip:[]},n=function(i){var a=t[i.type];a?a.push(i):(i.dispatchAction=n,e.dispatchAction(i))};return{dispatchAction:n,pendings:t}}(t);AJ(MJ(e).records,function(e){e&&i(e,n,a.dispatchAction)}),function(e,t){var n,i=e.showTip.length,a=e.hideTip.length;i?n=e.showTip[i-1]:a&&(n=e.hideTip[a-1]);n&&(n.dispatchAction=null,t.dispatchAction(n))}(a.pendings,t)})}MJ(e).initialized=!0,n("click",QC(PJ,"click")),n("mousemove",QC(PJ,"mousemove")),n("globalout",zJ)}(i,t),(MJ(i).records[e]||(MJ(i).records[e]={})).handler=n}}function zJ(e,t,n){e.handler("leave",null,n)}function PJ(e,t,n,i){t.handler(e,n,i)}function RJ(e,t){if(!pC.node){var n=t.getZr();(MJ(n).records||{})[e]&&(MJ(n).records[e]=null)}}var $J=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.render=function(e,t,n){var i=t.getComponent("tooltip"),a=e.get("triggerOn")||i&&i.get("triggerOn")||"mousemove|click";EJ("axisPointer",n,function(e,t,n){"none"!==a&&("leave"===e||a.indexOf(e)>=0)&&n({type:"updateAxisPointer",currTrigger:e,x:t&&t.offsetX,y:t&&t.offsetY})})},t.prototype.remove=function(e,t){RJ("axisPointer",t)},t.prototype.dispose=function(e,t){RJ("axisPointer",t)},t.type="axisPointer",t}(nU);function OJ(e,t){var n,i=[],a=e.seriesIndex;if(null==a||!(n=t.getSeriesByIndex(a)))return{point:[]};var r=n.getData(),s=FE(r,e);if(null==s||s<0||KC(s))return{point:[]};var o=r.getItemGraphicEl(s),l=n.coordinateSystem;if(n.getTooltipPosition)i=n.getTooltipPosition(s)||[];else if(l&&l.dataToPoint)if(e.isStacked){var c=l.getBaseAxis(),d=l.getOtherAxis(c).dim,u=c.dim,h="x"===d||"radius"===d?1:0,p=r.mapDimension(u),g=[];g[h]=r.get(p,s),g[1-h]=r.get(r.getCalculationInfo("stackResultDimension"),s),i=l.dataToPoint(g)||[]}else i=l.dataToPoint(r.getValues(UC(l.dimensions,function(e){return r.mapDimension(e)}),s))||[];else if(o){var v=o.getBoundingRect().clone();v.applyTransform(o.transform),i=[v.x+v.width/2,v.y+v.height/2]}return{point:i,el:o}}var LJ=BE();function NJ(e,t,n){var i=e.currTrigger,a=[e.x,e.y],r=e,s=e.dispatchAction||GC(n.dispatchAction,n),o=t.getComponent("axisPointer").coordSysAxesInfo;if(o){VJ(a)&&(a=OJ({seriesIndex:r.seriesIndex,dataIndex:r.dataIndex},t).point);var l=VJ(a),c=r.axesInfo,d=o.axesInfo,u="leave"===i||VJ(a),h={},p={},g={list:[],map:{}},v={showPointer:QC(BJ,p),showTooltip:QC(jJ,g)};jC(o.coordSysMap,function(e,t){var n=l||e.containPoint(a);jC(o.coordSysAxesInfo[t],function(e,t){var i=e.axis,r=function(e,t){for(var n=0;n<(e||[]).length;n++){var i=e[n];if(t.axis.dim===i.axisDim&&t.axis.model.componentIndex===i.axisIndex)return i}}(c,e);if(!u&&n&&(!c||r)){var s=r&&r.value;null!=s||l||(s=i.pointToData(a)),null!=s&&FJ(e,s,v,!1,h)}})});var f={};return jC(d,function(e,t){var n=e.linkGroup;n&&!p[t]&&jC(n.axesInfo,function(t,i){var a=p[i];if(t!==e&&a){var r=a.value;n.mapper&&(r=e.axis.scale.parse(n.mapper(r,UJ(t),UJ(e)))),f[e.key]=r}})}),jC(f,function(e,t){FJ(d[t],e,v,!0,h)}),function(e,t,n){var i=n.axesInfo=[];jC(t,function(t,n){var a=t.axisPointerModel.option,r=e[n];r?(!t.useHandle&&(a.status="show"),a.value=r.value,a.seriesDataIndices=(r.payloadBatch||[]).slice()):!t.useHandle&&(a.status="hide"),"show"===a.status&&i.push({axisDim:t.axis.dim,axisIndex:t.axis.model.componentIndex,value:a.value})})}(p,d,h),function(e,t,n,i){if(VJ(t)||!e.list.length)return void i({type:"hideTip"});var a=((e.list[0].dataByAxis[0]||{}).seriesDataIndices||[])[0]||{};i({type:"showTip",escapeConnect:!0,x:t[0],y:t[1],tooltipOption:n.tooltipOption,position:n.position,dataIndexInside:a.dataIndexInside,dataIndex:a.dataIndex,seriesIndex:a.seriesIndex,dataByCoordSys:e.list})}(g,a,e,s),function(e,t,n){var i=n.getZr(),a="axisPointerLastHighlights",r=LJ(i)[a]||{},s=LJ(i)[a]={};jC(e,function(e,t){var n=e.axisPointerModel.option;"show"===n.status&&e.triggerEmphasis&&jC(n.seriesDataIndices,function(e){var t=e.seriesIndex+" | "+e.dataIndex;s[t]=e})});var o=[],l=[];jC(r,function(e,t){!s[t]&&l.push(e)}),jC(s,function(e,t){!r[t]&&o.push(e)}),l.length&&n.dispatchAction({type:"downplay",escapeConnect:!0,notBlur:!0,batch:l}),o.length&&n.dispatchAction({type:"highlight",escapeConnect:!0,notBlur:!0,batch:o})}(d,0,n),h}}function FJ(e,t,n,i,a){var r=e.axis;if(!r.scale.isBlank()&&r.containData(t))if(e.involveSeries){var s=function(e,t){var n=t.axis,i=n.dim,a=e,r=[],s=Number.MAX_VALUE,o=-1;return jC(t.seriesModels,function(t,l){var c,d,u=t.getData().mapDimensionsAll(i);if(t.getAxisTooltipData){var h=t.getAxisTooltipData(u,e,n);d=h.dataIndices,c=h.nestestValue}else{if(!(d=t.indicesOfNearest(i,u[0],e,"category"===n.type?.5:null)).length)return;c=t.getData().get(u[0],d[0])}if(null!=c&&isFinite(c)){var p=e-c,g=Math.abs(p);g<=s&&((g<s||p>=0&&o<0)&&(s=g,o=p,a=c,r.length=0),jC(d,function(e){r.push({seriesIndex:t.seriesIndex,dataIndexInside:e,dataIndex:t.getData().getRawIndex(e)})}))}}),{payloadBatch:r,snapToValue:a}}(t,e),o=s.payloadBatch,l=s.snapToValue;o[0]&&null==a.seriesIndex&&RC(a,o[0]),!i&&e.snap&&r.containData(l)&&null!=l&&(t=l),n.showPointer(e,t,o),n.showTooltip(e,s,l)}else n.showPointer(e,t)}function BJ(e,t,n,i){e[t.key]={value:n,payloadBatch:i}}function jJ(e,t,n,i){var a=n.payloadBatch,r=t.axis,s=r.model,o=t.axisPointerModel;if(t.triggerTooltip&&a.length){var l=t.coordSys.model,c=gY(l),d=e.map[c];d||(d=e.map[c]={coordSysId:l.id,coordSysIndex:l.componentIndex,coordSysType:l.type,coordSysMainType:l.mainType,dataByAxis:[]},e.list.push(d)),d.dataByAxis.push({axisDim:r.dim,axisIndex:s.componentIndex,axisType:s.type,axisId:s.id,value:i,valueLabelOpt:{precision:o.get(["label","precision"]),formatter:o.get(["label","formatter"])},seriesDataIndices:a.slice()})}}function UJ(e){var t=e.axis.model,n={},i=n.axisDim=e.axis.dim;return n.axisIndex=n[i+"AxisIndex"]=t.componentIndex,n.axisName=n[i+"AxisName"]=t.name,n.axisId=n[i+"AxisId"]=t.id,n}function VJ(e){return!e||null==e[0]||isNaN(e[0])||null==e[1]||isNaN(e[1])}function qJ(e){fY.registerAxisPointerClass("CartesianAxisPointer",_J),e.registerComponentModel(TJ),e.registerComponentView($J),e.registerPreprocessor(function(e){if(e){(!e.axisPointer||0===e.axisPointer.length)&&(e.axisPointer={});var t=e.axisPointer.link;t&&!KC(t)&&(e.axisPointer.link=[t])}}),e.registerProcessor(e.PRIORITY.PROCESSOR.STATISTIC,function(e,t){e.getComponent("axisPointer").coordSysAxesInfo=dY(e,t)}),e.registerAction({type:"updateAxisPointer",event:"updateAxisPointer",update:":updateAxisPointer"},NJ)}function HJ(e){eG(CY),eG(qJ)}var WJ=["x","y","radius","angle","single"],GJ=["cartesian2d","polar","singleAxis"];function QJ(e){return e+"Axis"}function KJ(e,t){var n,i=kI(),a=[],r=kI();e.eachComponent({mainType:"dataZoom",query:t},function(e){r.get(e.uid)||o(e)});do{n=!1,e.eachComponent("dataZoom",s)}while(n);function s(e){!r.get(e.uid)&&function(e){var t=!1;return e.eachTargetAxis(function(e,n){var a=i.get(e);a&&a[n]&&(t=!0)}),t}(e)&&(o(e),n=!0)}function o(e){r.set(e.uid,!0),a.push(e),e.eachTargetAxis(function(e,t){(i.get(e)||i.set(e,[]))[t]=!0})}return a}function ZJ(e){var t=e.ecModel,n={infoList:[],infoMap:kI()};return e.eachTargetAxis(function(e,i){var a=t.getComponent(QJ(e),i);if(a){var r=a.getCoordSysModel();if(r){var s=r.uid,o=n.infoMap.get(s);o||(o={model:r,axisModels:[]},n.infoList.push(o),n.infoMap.set(s,o)),o.axisModels.push(a)}}}),n}var YJ=function(){function e(){this.indexList=[],this.indexMap=[]}return e.prototype.add=function(e){this.indexMap[e]||(this.indexList.push(e),this.indexMap[e]=!0)},e}(),XJ=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n._autoThrottle=!0,n._noTarget=!0,n._rangePropMode=["percent","percent"],n}return uC(t,e),t.prototype.init=function(e,t,n){var i=JJ(e);this.settledOption=i,this.mergeDefaultAndTheme(e,n),this._doInit(i)},t.prototype.mergeOption=function(e){var t=JJ(e);PC(this.option,e,!0),PC(this.settledOption,t,!0),this._doInit(t)},t.prototype._doInit=function(e){var t=this.option;this._setDefaultThrottle(e),this._updateRangeUse(e);var n=this.settledOption;jC([["start","startValue"],["end","endValue"]],function(e,i){"value"===this._rangePropMode[i]&&(t[e[0]]=n[e[0]]=null)},this),this._resetTarget()},t.prototype._resetTarget=function(){var e=this.get("orient",!0),t=this._targetAxisInfoMap=kI();this._fillSpecifiedTargetAxis(t)?this._orient=e||this._makeAutoOrientByTargetAxis():(this._orient=e||"horizontal",this._fillAutoTargetAxisByOrient(t,this._orient)),this._noTarget=!0,t.each(function(e){e.indexList.length&&(this._noTarget=!1)},this)},t.prototype._fillSpecifiedTargetAxis=function(e){var t=!1;return jC(WJ,function(n){var i=this.getReferringComponents(QJ(n),HE);if(i.specified){t=!0;var a=new YJ;jC(i.models,function(e){a.add(e.componentIndex)}),e.set(n,a)}},this),t},t.prototype._fillAutoTargetAxisByOrient=function(e,t){var n=this.ecModel,i=!0;if(i){var a="vertical"===t?"y":"x";r(n.findComponents({mainType:a+"Axis"}),a)}i&&r(n.findComponents({mainType:"singleAxis",filter:function(e){return e.get("orient",!0)===t}}),"single");function r(t,n){var a=t[0];if(a){var r=new YJ;if(r.add(a.componentIndex),e.set(n,r),i=!1,"x"===n||"y"===n){var s=a.getReferringComponents("grid",qE).models[0];s&&jC(t,function(e){a.componentIndex!==e.componentIndex&&s===e.getReferringComponents("grid",qE).models[0]&&r.add(e.componentIndex)})}}}i&&jC(WJ,function(t){if(i){var a=n.findComponents({mainType:QJ(t),filter:function(e){return"category"===e.get("type",!0)}});if(a[0]){var r=new YJ;r.add(a[0].componentIndex),e.set(t,r),i=!1}}},this)},t.prototype._makeAutoOrientByTargetAxis=function(){var e;return this.eachTargetAxis(function(t){!e&&(e=t)},this),"y"===e?"vertical":"horizontal"},t.prototype._setDefaultThrottle=function(e){if(e.hasOwnProperty("throttle")&&(this._autoThrottle=!1),this._autoThrottle){var t=this.ecModel.option;this.option.throttle=t.animation&&t.animationDurationUpdate>0?100:20}},t.prototype._updateRangeUse=function(e){var t=this._rangePropMode,n=this.get("rangeMode");jC([["start","startValue"],["end","endValue"]],function(i,a){var r=null!=e[i[0]],s=null!=e[i[1]];r&&!s?t[a]="percent":!r&&s?t[a]="value":n?t[a]=n[a]:r&&(t[a]="percent")})},t.prototype.noTarget=function(){return this._noTarget},t.prototype.getFirstTargetAxisModel=function(){var e;return this.eachTargetAxis(function(t,n){null==e&&(e=this.ecModel.getComponent(QJ(t),n))},this),e},t.prototype.eachTargetAxis=function(e,t){this._targetAxisInfoMap.each(function(n,i){jC(n.indexList,function(n){e.call(t,i,n)})})},t.prototype.getAxisProxy=function(e,t){var n=this.getAxisModel(e,t);if(n)return n.__dzAxisProxy},t.prototype.getAxisModel=function(e,t){var n=this._targetAxisInfoMap.get(e);if(n&&n.indexMap[t])return this.ecModel.getComponent(QJ(e),t)},t.prototype.setRawRange=function(e){var t=this.option,n=this.settledOption;jC([["start","startValue"],["end","endValue"]],function(i){null==e[i[0]]&&null==e[i[1]]||(t[i[0]]=n[i[0]]=e[i[0]],t[i[1]]=n[i[1]]=e[i[1]])},this),this._updateRangeUse(e)},t.prototype.setCalculatedRange=function(e){var t=this.option;jC(["start","startValue","end","endValue"],function(n){t[n]=e[n]})},t.prototype.getPercentRange=function(){var e=this.findRepresentativeAxisProxy();if(e)return e.getDataPercentWindow()},t.prototype.getValueRange=function(e,t){if(null!=e||null!=t)return this.getAxisProxy(e,t).getDataValueWindow();var n=this.findRepresentativeAxisProxy();return n?n.getDataValueWindow():void 0},t.prototype.findRepresentativeAxisProxy=function(e){if(e)return e.__dzAxisProxy;for(var t,n=this._targetAxisInfoMap.keys(),i=0;i<n.length;i++)for(var a=n[i],r=this._targetAxisInfoMap.get(a),s=0;s<r.indexList.length;s++){var o=this.getAxisProxy(a,r.indexList[s]);if(o.hostedBy(this))return o;t||(t=o)}return t},t.prototype.getRangePropMode=function(){return this._rangePropMode.slice()},t.prototype.getOrient=function(){return this._orient},t.type="dataZoom",t.dependencies=["xAxis","yAxis","radiusAxis","angleAxis","singleAxis","series","toolbox"],t.defaultOption={z:4,filterMode:"filter",start:0,end:100},t}(dF);function JJ(e){var t={};return jC(["start","end","startValue","endValue","throttle"],function(n){e.hasOwnProperty(n)&&(t[n]=e[n])}),t}var e0=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.type="dataZoom.select",t}(XJ),t0=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.render=function(e,t,n,i){this.dataZoomModel=e,this.ecModel=t,this.api=n},t.type="dataZoom",t}(nU),n0=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.type="dataZoom.select",t}(t0),i0=jC,a0=aE,r0=function(){function e(e,t,n,i){this._dimName=e,this._axisIndex=t,this.ecModel=i,this._dataZoomModel=n}return e.prototype.hostedBy=function(e){return this._dataZoomModel===e},e.prototype.getDataValueWindow=function(){return this._valueWindow.slice()},e.prototype.getDataPercentWindow=function(){return this._percentWindow.slice()},e.prototype.getTargetSeriesModels=function(){var e=[];return this.ecModel.eachSeries(function(t){if(function(e){var t=e.get("coordinateSystem");return LC(GJ,t)>=0}(t)){var n=QJ(this._dimName),i=t.getReferringComponents(n,qE).models[0];i&&this._axisIndex===i.componentIndex&&e.push(t)}},this),e},e.prototype.getAxisModel=function(){return this.ecModel.getComponent(this._dimName+"Axis",this._axisIndex)},e.prototype.getMinMaxSpan=function(){return zC(this._minMaxSpan)},e.prototype.calculateDataWindow=function(e){var t,n=this._dataExtent,i=this.getAxisModel().axis.scale,a=this._dataZoomModel.getRangePropMode(),r=[0,100],s=[],o=[];i0(["start","end"],function(l,c){var d=e[l],u=e[l+"Value"];"percent"===a[c]?(null==d&&(d=r[c]),u=i.parse(eE(d,r,n))):(t=!0,d=eE(u=null==u?n[c]:i.parse(u),n,r)),o[c]=null==u||isNaN(u)?n[c]:u,s[c]=null==d||isNaN(d)?r[c]:d}),a0(o),a0(s);var l=this._minMaxSpan;function c(e,t,n,a,r){var s=r?"Span":"ValueSpan";fX(0,e,n,"all",l["min"+s],l["max"+s]);for(var o=0;o<2;o++)t[o]=eE(e[o],n,a,!0),r&&(t[o]=i.parse(t[o]))}return t?c(o,s,n,r,!1):c(s,o,r,n,!0),{valueWindow:o,percentWindow:s}},e.prototype.reset=function(e){if(e===this._dataZoomModel){var t=this.getTargetSeriesModels();this._dataExtent=function(e,t,n){var i=[1/0,-1/0];i0(n,function(e){!function(e,t,n){t&&jC(HW(t,n),function(n){var i=t.getApproximateExtent(n);i[0]<e[0]&&(e[0]=i[0]),i[1]>e[1]&&(e[1]=i[1])})}(i,e.getData(),t)});var a=e.getAxisModel(),r=OW(a.axis.scale,a,i).calculate();return[r.min,r.max]}(this,this._dimName,t),this._updateMinMaxSpan();var n=this.calculateDataWindow(e.settledOption);this._valueWindow=n.valueWindow,this._percentWindow=n.percentWindow,this._setAxisModel()}},e.prototype.filterData=function(e,t){if(e===this._dataZoomModel){var n=this._dimName,i=this.getTargetSeriesModels(),a=e.get("filterMode"),r=this._valueWindow;"none"!==a&&i0(i,function(e){var t=e.getData(),i=t.mapDimensionsAll(n);if(i.length){if("weakFilter"===a){var s=t.getStore(),o=UC(i,function(e){return t.getDimensionIndex(e)},t);t.filterSelf(function(e){for(var t,n,a,l=0;l<i.length;l++){var c=s.get(o[l],e),d=!isNaN(c),u=c<r[0],h=c>r[1];if(d&&!u&&!h)return!0;d&&(a=!0),u&&(t=!0),h&&(n=!0)}return a&&t&&n})}else i0(i,function(n){if("empty"===a)e.setData(t=t.map(n,function(e){return function(e){return e>=r[0]&&e<=r[1]}(e)?e:NaN}));else{var i={};i[n]=r,t.selectRange(i)}});i0(i,function(e){t.setApproximateExtent(r,e)})}})}},e.prototype._updateMinMaxSpan=function(){var e=this._minMaxSpan={},t=this._dataZoomModel,n=this._dataExtent;i0(["min","max"],function(i){var a=t.get(i+"Span"),r=t.get(i+"ValueSpan");null!=r&&(r=this.getAxisModel().axis.scale.parse(r)),null!=r?a=eE(n[0]+r,n,[0,100],!0):null!=a&&(r=eE(a,[0,100],n,!0)-n[0]),e[i+"Span"]=a,e[i+"ValueSpan"]=r},this)},e.prototype._setAxisModel=function(){var e=this.getAxisModel(),t=this._percentWindow,n=this._valueWindow;if(t){var i=oE(n,[0,500]);i=Math.min(i,20);var a=e.axis.scale.rawExtentInfo;0!==t[0]&&a.setDeterminedMinMax("min",+n[0].toFixed(i)),100!==t[1]&&a.setDeterminedMinMax("max",+n[1].toFixed(i)),a.freeze()}},e}();var s0={getTargetSeries:function(e){function t(t){e.eachComponent("dataZoom",function(n){n.eachTargetAxis(function(i,a){var r=e.getComponent(QJ(i),a);t(i,a,r,n)})})}t(function(e,t,n,i){n.__dzAxisProxy=null});var n=[];t(function(t,i,a,r){a.__dzAxisProxy||(a.__dzAxisProxy=new r0(t,i,r,e),n.push(a.__dzAxisProxy))});var i=kI();return jC(n,function(e){jC(e.getTargetSeriesModels(),function(e){i.set(e.uid,e)})}),i},overallReset:function(e,t){e.eachComponent("dataZoom",function(e){e.eachTargetAxis(function(t,n){e.getAxisProxy(t,n).reset(e)}),e.eachTargetAxis(function(n,i){e.getAxisProxy(n,i).filterData(e,t)})}),e.eachComponent("dataZoom",function(e){var t=e.findRepresentativeAxisProxy();if(t){var n=t.getDataPercentWindow(),i=t.getDataValueWindow();e.setCalculatedRange({start:n[0],end:n[1],startValue:i[0],endValue:i[1]})}})}};var o0=!1;function l0(e){o0||(o0=!0,e.registerProcessor(e.PRIORITY.PROCESSOR.FILTER,s0),function(e){e.registerAction("dataZoom",function(e,t){jC(KJ(t,e),function(t){t.setRawRange({start:e.start,end:e.end,startValue:e.startValue,endValue:e.endValue})})})}(e),e.registerSubTypeDefaulter("dataZoom",function(){return"slider"}))}function c0(e){e.registerComponentModel(e0),e.registerComponentView(n0),l0(e)}var d0=function(){return function(){}}(),u0={};function h0(e,t){u0[e]=t}function p0(e){return u0[e]}var g0=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.optionUpdated=function(){e.prototype.optionUpdated.apply(this,arguments);var t=this.ecModel;jC(this.option.feature,function(e,n){var i=p0(n);i&&(i.getDefaultOption&&(i.defaultOption=i.getDefaultOption(t)),PC(e,i.defaultOption))})},t.type="toolbox",t.layoutMode={type:"box",ignoreSize:!0},t.defaultOption={show:!0,z:6,orient:"horizontal",left:"right",top:"top",backgroundColor:"transparent",borderColor:uF.color.border,borderRadius:0,borderWidth:0,padding:uF.size.m,itemSize:15,itemGap:uF.size.s,showTitle:!0,iconStyle:{borderColor:uF.color.accent50,color:"none"},emphasis:{iconStyle:{borderColor:uF.color.accent50}},tooltip:{show:!1,position:"bottom"}},t}(dF);function v0(e,t){var n=zN(t.get("padding")),i=t.getItemStyle(["color","opacity"]);return i.fill=t.get("backgroundColor"),new KP({shape:{x:e.x-n[3],y:e.y-n[0],width:e.width+n[1]+n[3],height:e.height+n[0]+n[2],r:t.get("borderRadius")},style:i,silent:!0,z2:-1})}var f0=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.render=function(e,t,n,i){var a=this.group;if(a.removeAll(),e.get("show")){var r=+e.get("itemSize"),s="vertical"===e.get("orient"),o=e.get("feature")||{},l=this._features||(this._features={}),c=[];jC(o,function(e,t){c.push(t)}),new hH(this._featureNames||[],c).add(g).update(g).remove(QC(g,null)).execute(),this._featureNames=c;var d=aF(e,n).refContainer,u=e.getBoxLayoutParams(),h=e.get("padding"),p=nF(u,d,h);eF(e.get("orient"),a,e.get("itemGap"),p.width,p.height),rF(a,u,d,h),a.add(v0(a.getBoundingRect(),e)),s||a.eachChild(function(e){var t=e.__title,i=e.ensureState("emphasis"),s=i.textConfig||(i.textConfig={}),o=e.getTextContent(),l=o&&o.ensureState("emphasis");if(l&&!ZC(l)&&t){var c=l.style||(l.style={}),d=_A(t,JP.makeFont(c)),u=e.x+a.x,h=!1;e.y+a.y+r+d.height>n.getHeight()&&(s.position="top",h=!0);var p=h?-5-d.height:r+10;u+d.width/2>n.getWidth()?(s.position=["100%",p],c.align="right"):u-d.width/2<0&&(s.position=[0,p],c.align="left")}})}function g(d,u){var h,p=c[d],g=c[u],v=o[p],f=new BL(v,e,e.ecModel);if(i&&null!=i.newTitle&&i.featureName===p&&(v.title=i.newTitle),p&&!g){if(function(e){return 0===e.indexOf("my")}(p))h={onclick:f.option.onclick,featureName:p};else{var m=p0(p);if(!m)return;h=new m}l[p]=h}else if(!(h=l[g]))return;h.uid=UL("toolbox-feature"),h.model=f,h.ecModel=t,h.api=n;var y=h instanceof d0;p||!g?!f.get("show")||y&&h.unusable?y&&h.remove&&h.remove(t,n):(!function(i,o,l){var c,d,u=i.getModel("iconStyle"),h=i.getModel(["emphasis","iconStyle"]),p=o instanceof d0&&o.getIcons?o.getIcons():i.get("icon"),g=i.get("title")||{};YC(p)?(c={})[l]=p:c=p;YC(g)?(d={})[l]=g:d=g;var v=i.iconPaths={};jC(c,function(l,c){var p=YO(l,{},{x:-r/2,y:-r/2,width:r,height:r});p.setStyle(u.getItemStyle()),p.ensureState("emphasis").style=h.getItemStyle();var g=new JP({style:{text:d[c],align:h.get("textAlign"),borderRadius:h.get("textBorderRadius"),padding:h.get("textPadding"),fill:null,font:CL({fontStyle:h.get("textFontStyle"),fontFamily:h.get("textFontFamily"),fontSize:h.get("textFontSize"),fontWeight:h.get("textFontWeight")},t)},ignore:!0});p.setTextContent(g),iL({el:p,componentModel:e,itemName:c,formatterParamsExtra:{title:d[c]}}),p.__title=d[c],p.on("mouseover",function(){var t=h.getItemStyle(),i=s?null==e.get("right")&&"right"!==e.get("left")?"right":"left":null==e.get("bottom")&&"bottom"!==e.get("top")?"bottom":"top";g.setStyle({fill:h.get("textFill")||t.fill||t.stroke||uF.color.neutral99,backgroundColor:h.get("textBackgroundColor")}),p.setTextConfig({position:h.get("textPosition")||i}),g.ignore=!e.get("showTitle"),n.enterEmphasis(this)}).on("mouseout",function(){"emphasis"!==i.get(["iconStatus",c])&&n.leaveEmphasis(this),g.hide()}),("emphasis"===i.get(["iconStatus",c])?FR:BR)(p),a.add(p),p.on("click",GC(o.onclick,o,t,n,c)),v[c]=p})}(f,h,p),f.setIconStatus=function(e,t){var n=this.option,i=this.iconPaths;n.iconStatus=n.iconStatus||{},n.iconStatus[e]=t,i[e]&&("emphasis"===t?FR:BR)(i[e])},h instanceof d0&&h.render&&h.render(f,t,n,i)):y&&h.dispose&&h.dispose(t,n)}},t.prototype.updateView=function(e,t,n,i){jC(this._features,function(e){e instanceof d0&&e.updateView&&e.updateView(e.model,t,n,i)})},t.prototype.remove=function(e,t){jC(this._features,function(n){n instanceof d0&&n.remove&&n.remove(e,t)}),this.group.removeAll()},t.prototype.dispose=function(e,t){jC(this._features,function(n){n instanceof d0&&n.dispose&&n.dispose(e,t)})},t.type="toolbox",t}(nU);var m0=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.onclick=function(e,t){var n=this.model,i=n.get("name")||e.get("title.0.text")||"echarts",a="svg"===t.getZr().painter.getType(),r=a?"svg":n.get("type",!0)||"png",s=t.getConnectedDataURL({type:r,backgroundColor:n.get("backgroundColor",!0)||e.get("backgroundColor")||uF.color.neutral00,connectedBackgroundColor:n.get("connectedBackgroundColor"),excludeComponents:n.get("excludeComponents"),pixelRatio:n.get("pixelRatio")}),o=pC.browser;if("function"!=typeof MouseEvent||!o.newEdge&&(o.ie||o.edge))if(window.navigator.msSaveOrOpenBlob||a){var l=s.split(","),c=l[0].indexOf("base64")>-1,d=a?decodeURIComponent(l[1]):l[1];c&&(d=window.atob(d));var u=i+"."+r;if(window.navigator.msSaveOrOpenBlob){for(var h=d.length,p=new Uint8Array(h);h--;)p[h]=d.charCodeAt(h);var g=new Blob([p]);window.navigator.msSaveOrOpenBlob(g,u)}else{var v=document.createElement("iframe");document.body.appendChild(v);var f=v.contentWindow,m=f.document;m.open("image/svg+xml","replace"),m.write(d),m.close(),f.focus(),m.execCommand("SaveAs",!0,u),document.body.removeChild(v)}}else{var y=n.get("lang"),b='<body style="margin:0;"><img src="'+s+'" style="max-width:100%;" title="'+(y&&y[0]||"")+'" /></body>',w=window.open();w.document.write(b),w.document.title=i}else{var k=document.createElement("a");k.download=i+"."+r,k.target="_blank",k.href=s;var S=new MouseEvent("click",{view:document.defaultView,bubbles:!0,cancelable:!1});k.dispatchEvent(S)}},t.getDefaultOption=function(e){return{show:!0,icon:"M4.7,22.9L29.3,45.5L54.7,23.4M4.6,43.6L4.6,58L53.8,58L53.8,43.6M29.2,45.1L29.2,0",title:e.getLocaleModel().get(["toolbox","saveAsImage","title"]),type:"png",connectedBackgroundColor:uF.color.neutral00,name:"",excludeComponents:["toolbox"],lang:e.getLocaleModel().get(["toolbox","saveAsImage","lang"])}},t}(d0),y0="__ec_magicType_stack__",b0=[["line","bar"],["stack"]],w0=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.getIcons=function(){var e=this.model,t=e.get("icon"),n={};return jC(e.get("type"),function(e){t[e]&&(n[e]=t[e])}),n},t.getDefaultOption=function(e){return{show:!0,type:[],icon:{line:"M4.1,28.9h7.1l9.3-22l7.4,38l9.7-19.7l3,12.8h14.9M4.1,58h51.4",bar:"M6.7,22.9h10V48h-10V22.9zM24.9,13h10v35h-10V13zM43.2,2h10v46h-10V2zM3.1,58h53.7",stack:"M8.2,38.4l-8.4,4.1l30.6,15.3L60,42.5l-8.1-4.1l-21.5,11L8.2,38.4z M51.9,30l-8.1,4.2l-13.4,6.9l-13.9-6.9L8.2,30l-8.4,4.2l8.4,4.2l22.2,11l21.5-11l8.1-4.2L51.9,30z M51.9,21.7l-8.1,4.2L35.7,30l-5.3,2.8L24.9,30l-8.4-4.1l-8.3-4.2l-8.4,4.2L8.2,30l8.3,4.2l13.9,6.9l13.4-6.9l8.1-4.2l8.1-4.1L51.9,21.7zM30.4,2.2L-0.2,17.5l8.4,4.1l8.3,4.2l8.4,4.2l5.5,2.7l5.3-2.7l8.1-4.2l8.1-4.2l8.1-4.1L30.4,2.2z"},title:e.getLocaleModel().get(["toolbox","magicType","title"]),option:{},seriesIndex:{}}},t.prototype.onclick=function(e,t,n){var i=this.model,a=i.get(["seriesIndex",n]);if(k0[n]){var r,s={series:[]};jC(b0,function(e){LC(e,n)>=0&&jC(e,function(e){i.setIconStatus(e,"normal")})}),i.setIconStatus(n,"emphasis"),e.eachComponent({mainType:"series",query:null==a?null:{seriesIndex:a}},function(e){var t=e.subType,a=e.id,r=k0[n](t,a,e,i);r&&($C(r,e.option),s.series.push(r));var o=e.coordinateSystem;if(o&&"cartesian2d"===o.type&&("line"===n||"bar"===n)){var l=o.getAxesByScale("ordinal")[0];if(l){var c=l.dim+"Axis",d=e.getReferringComponents(c,qE).models[0].componentIndex;s[c]=s[c]||[];for(var u=0;u<=d;u++)s[c][d]=s[c][d]||{};s[c][d].boundaryGap="bar"===n}}});var o=n;"stack"===n&&(r=PC({stack:i.option.title.tiled,tiled:i.option.title.stack},i.option.title),"emphasis"!==i.get(["iconStatus",n])&&(o="tiled")),t.dispatchAction({type:"changeMagicType",currentType:o,newOption:s,newTitle:r,featureName:"magicType"})}},t}(d0),k0={line:function(e,t,n,i){if("bar"===e)return PC({id:t,type:"line",data:n.get("data"),stack:n.get("stack"),markPoint:n.get("markPoint"),markLine:n.get("markLine")},i.get(["option","line"])||{},!0)},bar:function(e,t,n,i){if("line"===e)return PC({id:t,type:"bar",data:n.get("data"),stack:n.get("stack"),markPoint:n.get("markPoint"),markLine:n.get("markLine")},i.get(["option","bar"])||{},!0)},stack:function(e,t,n,i){var a=n.get("stack")===y0;if("line"===e||"bar"===e)return i.setIconStatus("stack",a?"normal":"emphasis"),PC({id:t,stack:a?"":y0},i.get(["option","stack"])||{},!0)}};eH({type:"changeMagicType",event:"magicTypeChanged",update:"prepareAndUpdate"},function(e,t){t.mergeOption(e.newOption)});var S0=new Array(60).join("-"),x0="\t";function _0(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}var C0=new RegExp("[\t]+","g");function I0(e,t){var n=e.split(new RegExp("\n*"+S0+"\n*","g")),i={series:[]};return jC(n,function(e,n){if(function(e){if(e.slice(0,e.indexOf("\n")).indexOf(x0)>=0)return!0}(e)){var a=function(e){for(var t=e.split(/\n+/g),n=[],i=UC(_0(t.shift()).split(C0),function(e){return{name:e,data:[]}}),a=0;a<t.length;a++){var r=_0(t[a]).split(C0);n.push(r.shift());for(var s=0;s<r.length;s++)i[s]&&(i[s].data[a]=r[s])}return{series:i,categories:n}}(e),r=t[n],s=r.axisDim+"Axis";r&&(i[s]=i[s]||[],i[s][r.axisIndex]={data:a.categories},i.series=i.series.concat(a.series))}else{a=function(e){for(var t=e.split(/\n+/g),n=_0(t.shift()),i=[],a=0;a<t.length;a++){var r=_0(t[a]);if(r){var s=r.split(C0),o="",l=void 0,c=!1;isNaN(s[0])?(c=!0,o=s[0],s=s.slice(1),i[a]={name:o,value:[]},l=i[a].value):l=i[a]=[];for(var d=0;d<s.length;d++)l.push(+s[d]);1===l.length&&(c?i[a].value=l[0]:i[a]=l[0])}}return{name:n,data:i}}(e);i.series.push(a)}}),i}var D0=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.onclick=function(e,t){setTimeout(function(){t.dispatchAction({type:"hideTip"})});var n=t.getDom(),i=this.model;this._dom&&n.removeChild(this._dom);var a=document.createElement("div");a.style.cssText="position:absolute;top:0;bottom:0;left:0;right:0;padding:5px",a.style.backgroundColor=i.get("backgroundColor")||uF.color.neutral00;var r=document.createElement("h4"),s=i.get("lang")||[];r.innerHTML=s[0]||i.get("title"),r.style.cssText="margin:10px 20px",r.style.color=i.get("textColor");var o=document.createElement("div"),l=document.createElement("textarea");o.style.cssText="overflow:auto";var c=i.get("optionToContent"),d=i.get("contentToOption"),u=function(e){var t,n,i,a=function(e){var t={},n=[],i=[];return e.eachRawSeries(function(e){var a=e.coordinateSystem;if(!a||"cartesian2d"!==a.type&&"polar"!==a.type)n.push(e);else{var r=a.getBaseAxis();if("category"===r.type){var s=r.dim+"_"+r.index;t[s]||(t[s]={categoryAxis:r,valueAxis:a.getOtherAxis(r),series:[]},i.push({axisDim:r.dim,axisIndex:r.index})),t[s].series.push(e)}else n.push(e)}}),{seriesGroupByCategoryAxis:t,other:n,meta:i}}(e);return{value:qC([(n=a.seriesGroupByCategoryAxis,i=[],jC(n,function(e,t){var n=e.categoryAxis,a=e.valueAxis.dim,r=[" "].concat(UC(e.series,function(e){return e.name})),s=[n.model.getCategories()];jC(e.series,function(e){var t=e.getRawData();s.push(e.getRawData().mapArray(t.mapDimension(a),function(e){return e}))});for(var o=[r.join(x0)],l=0;l<s[0].length;l++){for(var c=[],d=0;d<s.length;d++)c.push(s[d][l]);o.push(c.join(x0))}i.push(o.join("\n"))}),i.join("\n\n"+S0+"\n\n")),(t=a.other,UC(t,function(e){var t=e.getRawData(),n=[e.name],i=[];return t.each(t.dimensions,function(){for(var e=arguments.length,a=arguments[e-1],r=t.getName(a),s=0;s<e-1;s++)i[s]=arguments[s];n.push((r?r+x0:"")+i.join(x0))}),n.join("\n")}).join("\n\n"+S0+"\n\n"))],function(e){return!!e.replace(/[\n\t\s]/g,"")}).join("\n\n"+S0+"\n\n"),meta:a.meta}}(e);if(ZC(c)){var h=c(t.getOption());YC(h)?o.innerHTML=h:iI(h)&&o.appendChild(h)}else{l.readOnly=i.get("readOnly");var p=l.style;p.cssText="display:block;width:100%;height:100%;font-family:monospace;font-size:14px;line-height:1.6rem;resize:none;box-sizing:border-box;outline:none",p.color=i.get("textColor"),p.borderColor=i.get("textareaBorderColor"),p.backgroundColor=i.get("textareaColor"),l.value=u.value,o.appendChild(l)}var g=u.meta,v=document.createElement("div");v.style.cssText="position:absolute;bottom:5px;left:0;right:0";var f="float:right;margin-right:20px;border:none;cursor:pointer;padding:2px 5px;font-size:12px;border-radius:3px",m=document.createElement("div"),y=document.createElement("div");f+=";background-color:"+i.get("buttonColor"),f+=";color:"+i.get("buttonTextColor");var b=this;function w(){n.removeChild(a),b._dom=null}mD(m,"click",w),mD(y,"click",function(){if(null==d&&null!=c||null!=d&&null==c)w();else{var e;try{e=ZC(d)?d(o,t.getOption()):I0(l.value,g)}catch(n){throw w(),new Error("Data view format error "+n)}e&&t.dispatchAction({type:"changeDataView",newOption:e}),w()}}),m.innerHTML=s[1],y.innerHTML=s[2],y.style.cssText=m.style.cssText=f,!i.get("readOnly")&&v.appendChild(y),v.appendChild(m),a.appendChild(r),a.appendChild(o),a.appendChild(v),o.style.height=n.clientHeight-80+"px",n.appendChild(a),this._dom=a},t.prototype.remove=function(e,t){this._dom&&t.getDom().removeChild(this._dom)},t.prototype.dispose=function(e,t){this.remove(e,t)},t.getDefaultOption=function(e){return{show:!0,readOnly:!1,optionToContent:null,contentToOption:null,icon:"M17.5,17.3H33 M17.5,17.3H33 M45.4,29.5h-28 M11.5,2v56H51V14.8L38.4,2H11.5z M38.4,2.2v12.7H51 M45.4,41.7h-28",title:e.getLocaleModel().get(["toolbox","dataView","title"]),lang:e.getLocaleModel().get(["toolbox","dataView","lang"]),backgroundColor:uF.color.background,textColor:uF.color.primary,textareaColor:uF.color.background,textareaBorderColor:uF.color.border,buttonColor:uF.color.accent50,buttonTextColor:uF.color.neutral00}},t}(d0);function T0(e,t){return UC(e,function(e,n){var i=t&&t[n];if(eI(i)&&!KC(i)){eI(e)&&!KC(e)||(e={value:e});var a=null!=i.name&&null==e.name;return e=$C(e,i),a&&delete e.name,e}return e})}eH({type:"changeDataView",event:"dataViewChanged",update:"prepareAndUpdate"},function(e,t){var n=[];jC(e.newOption.series,function(e){var i=t.getSeriesByName(e.name)[0];if(i){var a=i.get("data");n.push({name:e.name,data:T0(e.data,a)})}else n.push(RC({type:"scatter"},e))}),t.mergeOption($C({series:n},e.newOption))});var M0=jC,A0=BE();function E0(e){var t=A0(e);return t.snapshots||(t.snapshots=[{}]),t.snapshots}var z0=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.onclick=function(e,t){!function(e){A0(e).snapshots=null}(e),t.dispatchAction({type:"restore",from:this.uid})},t.getDefaultOption=function(e){return{show:!0,icon:"M3.8,33.4 M47,18.9h9.8V8.7 M56.3,20.1 C52.1,9,40.5,0.6,26.8,2.1C12.6,3.7,1.6,16.2,2.1,30.6 M13,41.1H3.1v10.2 M3.7,39.9c4.2,11.1,15.8,19.5,29.5,18 c14.2-1.6,25.2-14.1,24.7-28.5",title:e.getLocaleModel().get(["toolbox","restore","title"])}},t}(d0);eH({type:"restore",event:"restore",update:"prepareAndUpdate"},function(e,t){t.resetOption("recreate")});var P0=["grid","xAxis","yAxis","geo","graph","polar","radiusAxis","angleAxis","bmap"],R0=function(){function e(e,t,n){var i=this;this._targetInfoList=[];var a=O0(t,e);jC(L0,function(e,t){(!n||!n.include||LC(n.include,t)>=0)&&e(a,i._targetInfoList)})}return e.prototype.setOutputRanges=function(e,t){return this.matchOutputRanges(e,t,function(e,t,n){if((e.coordRanges||(e.coordRanges=[])).push(t),!e.coordRange){e.coordRange=t;var i=B0[e.brushType](0,n,t);e.__rangeOffset={offset:U0[e.brushType](i.values,e.range,[1,1]),xyMinMax:i.xyMinMax}}}),e},e.prototype.matchOutputRanges=function(e,t,n){jC(e,function(e){var i=this.findTargetInfo(e,t);i&&!0!==i&&jC(i.coordSyses,function(i){var a=B0[e.brushType](1,i,e.range,!0);n(e,a.values,i,t)})},this)},e.prototype.setInputRanges=function(e,t){jC(e,function(e){var n,i,a,r,s,o=this.findTargetInfo(e,t);if(e.range=e.range||[],o&&!0!==o){e.panelId=o.panelId;var l=B0[e.brushType](0,o.coordSys,e.coordRange),c=e.__rangeOffset;e.range=c?U0[e.brushType](l.values,c.offset,(n=l.xyMinMax,i=c.xyMinMax,a=q0(n),r=q0(i),s=[a[0]/r[0],a[1]/r[1]],isNaN(s[0])&&(s[0]=1),isNaN(s[1])&&(s[1]=1),s)):l.values}},this)},e.prototype.makePanelOpts=function(e,t){return UC(this._targetInfoList,function(n){var i=n.getPanelRect();return{panelId:n.panelId,defaultBrushType:t?t(n):null,clipPath:rJ(i),isTargetByCursor:oJ(i,e,n.coordSysModel),getLinearBrushOtherExtent:sJ(i)}})},e.prototype.controlSeries=function(e,t,n){var i=this.findTargetInfo(e,n);return!0===i||i&&LC(i.coordSyses,t.coordinateSystem)>=0},e.prototype.findTargetInfo=function(e,t){for(var n=this._targetInfoList,i=O0(t,e),a=0;a<n.length;a++){var r=n[a],s=e.panelId;if(s){if(r.panelId===s)return r}else for(var o=0;o<N0.length;o++)if(N0[o](i,r))return r}return!0},e}();function $0(e){return e[0]>e[1]&&e.reverse(),e}function O0(e,t){return UE(e,t,{includeMainTypes:P0})}var L0={grid:function(e,t){var n=e.xAxisModels,i=e.yAxisModels,a=e.gridModels,r=kI(),s={},o={};(n||i||a)&&(jC(n,function(e){var t=e.axis.grid.model;r.set(t.id,t),s[t.id]=!0}),jC(i,function(e){var t=e.axis.grid.model;r.set(t.id,t),o[t.id]=!0}),jC(a,function(e){r.set(e.id,e),s[e.id]=!0,o[e.id]=!0}),r.each(function(e){var a=e.coordinateSystem,r=[];jC(a.getCartesians(),function(e,t){(LC(n,e.getAxis("x").model)>=0||LC(i,e.getAxis("y").model)>=0)&&r.push(e)}),t.push({panelId:"grid--"+e.id,gridModel:e,coordSysModel:e,coordSys:r[0],coordSyses:r,getPanelRect:F0.grid,xAxisDeclared:s[e.id],yAxisDeclared:o[e.id]})}))},geo:function(e,t){jC(e.geoModels,function(e){var n=e.coordinateSystem;t.push({panelId:"geo--"+e.id,geoModel:e,coordSysModel:e,coordSys:n,coordSyses:[n],getPanelRect:F0.geo})})}},N0=[function(e,t){var n=e.xAxisModel,i=e.yAxisModel,a=e.gridModel;return!a&&n&&(a=n.axis.grid.model),!a&&i&&(a=i.axis.grid.model),a&&a===t.gridModel},function(e,t){var n=e.geoModel;return n&&n===t.geoModel}],F0={grid:function(){return this.coordSys.master.getRect().clone()},geo:function(){var e=this.coordSys,t=e.getBoundingRect().clone();return t.applyTransform(qO(e)),t}},B0={lineX:QC(j0,0),lineY:QC(j0,1),rect:function(e,t,n,i){var a=e?t.pointToData([n[0][0],n[1][0]],i):t.dataToPoint([n[0][0],n[1][0]],i),r=e?t.pointToData([n[0][1],n[1][1]],i):t.dataToPoint([n[0][1],n[1][1]],i),s=[$0([a[0],r[0]]),$0([a[1],r[1]])];return{values:s,xyMinMax:s}},polygon:function(e,t,n,i){var a=[[1/0,-1/0],[1/0,-1/0]];return{values:UC(n,function(n){var r=e?t.pointToData(n,i):t.dataToPoint(n,i);return a[0][0]=Math.min(a[0][0],r[0]),a[1][0]=Math.min(a[1][0],r[1]),a[0][1]=Math.max(a[0][1],r[0]),a[1][1]=Math.max(a[1][1],r[1]),r}),xyMinMax:a}}};function j0(e,t,n,i){var a=n.getAxis(["x","y"][e]),r=$0(UC([0,1],function(e){return t?a.coordToData(a.toLocalCoord(i[e]),!0):a.toGlobalCoord(a.dataToCoord(i[e]))})),s=[];return s[e]=r,s[1-e]=[NaN,NaN],{values:r,xyMinMax:s}}var U0={lineX:QC(V0,0),lineY:QC(V0,1),rect:function(e,t,n){return[[e[0][0]-n[0]*t[0][0],e[0][1]-n[0]*t[0][1]],[e[1][0]-n[1]*t[1][0],e[1][1]-n[1]*t[1][1]]]},polygon:function(e,t,n){return UC(e,function(e,i){return[e[0]-n[0]*t[i][0],e[1]-n[1]*t[i][1]]})}};function V0(e,t,n,i){return[t[0]-i[e]*n[0],t[1]-i[e]*n[1]]}function q0(e){return e?[e[0][1]-e[0][0],e[1][1]-e[1][0]]:[NaN,NaN]}var H0,W0,G0=jC,Q0=DE+"toolbox-dataZoom_",K0=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uC(t,e),t.prototype.render=function(e,t,n,i){this._brushController||(this._brushController=new TX(n.getZr()),this._brushController.on("brush",GC(this._onBrush,this)).mount()),function(e,t,n,i,a){var r=n._isZoomActive;i&&"takeGlobalCursor"===i.type&&(r="dataZoomSelect"===i.key&&i.dataZoomSelectActive);n._isZoomActive=r,e.setIconStatus("zoom",r?"emphasis":"normal");var s=new R0(Y0(e),t,{include:["grid"]}),o=s.makePanelOpts(a,function(e){return e.xAxisDeclared&&!e.yAxisDeclared?"lineX":!e.xAxisDeclared&&e.yAxisDeclared?"lineY":"rect"});n._brushController.setPanels(o).enableBrush(!(!r||!o.length)&&{brushType:"auto",brushStyle:e.getModel("brushStyle").getItemStyle()})}(e,t,this,i,n),function(e,t){e.setIconStatus("back",function(e){return E0(e).length}(t)>1?"emphasis":"normal")}(e,t)},t.prototype.onclick=function(e,t,n){Z0[n].call(this)},t.prototype.remove=function(e,t){this._brushController&&this._brushController.unmount()},t.prototype.dispose=function(e,t){this._brushController&&this._brushController.dispose()},t.prototype._onBrush=function(e){var t=e.areas;if(e.isEnd&&t.length){var n={},i=this.ecModel;this._brushController.updateCovers([]),new R0(Y0(this.model),i,{include:["grid"]}).matchOutputRanges(t,i,function(e,t,n){if("cartesian2d"===n.type){var i=e.brushType;"rect"===i?(a("x",n,t[0]),a("y",n,t[1])):a({lineX:"x",lineY:"y"}[i],n,t)}}),function(e,t){var n=E0(e);M0(t,function(t,i){for(var a=n.length-1;a>=0&&!n[a][i];a--);if(a<0){var r=e.queryComponents({mainType:"dataZoom",subType:"select",id:i})[0];if(r){var s=r.getPercentRange();n[0][i]={dataZoomId:i,start:s[0],end:s[1]}}}}),n.push(t)}(i,n),this._dispatchZoomAction(n)}function a(e,t,a){var r=t.getAxis(e),s=r.model,o=function(e,t,n){var i;return n.eachComponent({mainType:"dataZoom",subType:"select"},function(n){n.getAxisModel(e,t.componentIndex)&&(i=n)}),i}(e,s,i),l=o.findRepresentativeAxisProxy(s).getMinMaxSpan();null==l.minValueSpan&&null==l.maxValueSpan||(a=fX(0,a.slice(),r.scale.getExtent(),0,l.minValueSpan,l.maxValueSpan)),o&&(n[o.id]={dataZoomId:o.id,startValue:a[0],endValue:a[1]})}},t.prototype._dispatchZoomAction=function(e){var t=[];G0(e,function(e,n){t.push(zC(e))}),t.length&&this.api.dispatchAction({type:"dataZoom",from:this.uid,batch:t})},t.getDefaultOption=function(e){return{show:!0,filterMode:"filter",icon:{zoom:"M0,13.5h26.9 M13.5,26.9V0 M32.1,13.5H58V58H13.5 V32.1",back:"M22,1.4L9.9,13.5l12.3,12.3 M10.3,13.5H54.9v44.6 H10.3v-26"},title:e.getLocaleModel().get(["toolbox","dataZoom","title"]),brushStyle:{borderWidth:0,color:uF.color.backgroundTint}}},t}(d0),Z0={zoom:function(){var e=!this._isZoomActive;this.api.dispatchAction({type:"takeGlobalCursor",key:"dataZoomSelect",dataZoomSelectActive:e})},back:function(){this._dispatchZoomAction(function(e){var t=E0(e),n=t[t.length-1];t.length>1&&t.pop();var i={};return M0(n,function(e,n){for(var a=t.length-1;a>=0;a--)if(e=t[a][n]){i[n]=e;break}}),i}(this.ecModel))}};function Y0(e){var t={xAxisIndex:e.get("xAxisIndex",!0),yAxisIndex:e.get("yAxisIndex",!0),xAxisId:e.get("xAxisId",!0),yAxisId:e.get("yAxisId",!0)};return null==t.xAxisIndex&&null==t.xAxisId&&(t.xAxisIndex="all"),null==t.yAxisIndex&&null==t.yAxisId&&(t.yAxisIndex="all"),t}H0="dataZoom",W0=function(e){var t=e.getComponent("toolbox",0),n=["feature","dataZoom"];if(t&&null!=t.get(n)){var i=t.getModel(n),a=[],r=UE(e,Y0(i));return G0(r.xAxisModels,function(e){return s(e,"xAxis","xAxisIndex")}),G0(r.yAxisModels,function(e){return s(e,"yAxis","yAxisIndex")}),a}function s(e,t,n){var r=e.componentIndex,s={type:"select",$fromToolbox:!0,filterMode:i.get("filterMode",!0)||"filter",id:Q0+t+r};s[n]=r,a.push(s)}},pI(null==NF.get(H0)&&W0),NF.set(H0,W0);var X0=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.type="tooltip",t.dependencies=["axisPointer"],t.defaultOption={z:60,show:!0,showContent:!0,trigger:"item",triggerOn:"mousemove|click",alwaysShowContent:!1,renderMode:"auto",confine:null,showDelay:0,hideDelay:100,transitionDuration:.4,displayTransition:!0,enterable:!1,backgroundColor:uF.color.neutral00,shadowBlur:10,shadowColor:"rgba(0, 0, 0, .2)",shadowOffsetX:1,shadowOffsetY:2,borderRadius:4,borderWidth:1,defaultBorderColor:uF.color.border,padding:null,extraCssText:"",axisPointer:{type:"line",axis:"auto",animation:"auto",animationDurationUpdate:200,animationEasingUpdate:"exponentialOut",crossStyle:{color:uF.color.borderShade,width:1,type:"dashed",textStyle:{}}},textStyle:{color:uF.color.tertiary,fontSize:14}},t}(dF);function J0(e){var t=e.get("confine");return null!=t?!!t:"richText"===e.get("renderMode")}function e1(e){if(pC.domSupported)for(var t=document.documentElement.style,n=0,i=e.length;n<i;n++)if(e[n]in t)return e[n]}var t1=e1(["transform","webkitTransform","OTransform","MozTransform","msTransform"]);function n1(e,t){if(!e)return t;t=EN(t,!0);var n=e.indexOf(t);return(e=-1===n?t:"-"+e.slice(0,n)+"-"+t).toLowerCase()}var i1=n1(e1(["webkitTransition","transition","OTransition","MozTransition","msTransition"]),"transition"),a1=n1(t1,"transform"),r1="position:absolute;display:block;border-style:solid;white-space:nowrap;z-index:9999999;"+(pC.transform3dSupported?"will-change:transform;":"");function s1(e,t,n){var i=e.toFixed(0)+"px",a=t.toFixed(0)+"px";if(!pC.transformSupported)return n?"top:"+a+";left:"+i+";":[["top",a],["left",i]];var r=pC.transform3dSupported,s="translate"+(r?"3d":"")+"("+i+","+a+(r?",0":"")+")";return n?"top:0;left:0;"+a1+":"+s+";":[["top",0],["left",0],[t1,s]]}function o1(e,t,n,i){var a=[],r=e.get("transitionDuration"),s=e.get("backgroundColor"),o=e.get("shadowBlur"),l=e.get("shadowColor"),c=e.get("shadowOffsetX"),d=e.get("shadowOffsetY"),u=e.getModel("textStyle"),h=Vj(e,"html"),p=c+"px "+d+"px "+o+"px "+l;return a.push("box-shadow:"+p),t&&r>0&&a.push(function(e,t,n){var i="cubic-bezier(0.23,1,0.32,1)",a="",r="";return n&&(r="opacity"+(a=" "+e/2+"s "+i)+",visibility"+a),t||(a=" "+e+"s "+i,r+=(r.length?",":"")+(pC.transformSupported?""+a1+a:",left"+a+",top"+a)),i1+":"+r}(r,n,i)),s&&a.push("background-color:"+s),jC(["width","color","radius"],function(t){var n="border-"+t,i=EN(n),r=e.get(i);null!=r&&a.push(n+":"+r+("color"===t?"":"px"))}),a.push(function(e){var t=[],n=e.get("fontSize"),i=e.getTextColor();i&&t.push("color:"+i),t.push("font:"+e.getFont());var a=cI(e.get("lineHeight"),Math.round(3*n/2));n&&t.push("line-height:"+a+"px");var r=e.get("textShadowColor"),s=e.get("textShadowBlur")||0,o=e.get("textShadowOffsetX")||0,l=e.get("textShadowOffsetY")||0;return r&&s&&t.push("text-shadow:"+o+"px "+l+"px "+s+"px "+r),jC(["decoration","align"],function(n){var i=e.get(n);i&&t.push("text-"+n+":"+i)}),t.join(";")}(u)),null!=h&&a.push("padding:"+zN(h).join("px ")+"px"),a.join(";")+";"}function l1(e,t,n,i,a){var r=t&&t.painter;if(n){var s=r&&r.getViewportRoot();s&&function(e,t,n,i,a){rD(aD,t,i,a,!0)&&rD(e,n,aD[0],aD[1])}(e,s,n,i,a)}else{e[0]=i,e[1]=a;var o=r&&r.getViewportRootOffset();o&&(e[0]+=o.offsetLeft,e[1]+=o.offsetTop)}e[2]=e[0]/t.getWidth(),e[3]=e[1]/t.getHeight()}var c1=function(){function e(e,t){if(this._show=!1,this._styleCoord=[0,0,0,0],this._enterable=!0,this._alwaysShowContent=!1,this._firstShow=!0,this._longHide=!0,pC.wxa)return null;var n=document.createElement("div");n.domBelongToZr=!0,this.el=n;var i=this._zr=e.getZr(),a=t.appendTo,r=a&&(YC(a)?document.querySelector(a):iI(a)?a:ZC(a)&&a(e.getDom()));l1(this._styleCoord,i,r,e.getWidth()/2,e.getHeight()/2),(r||e.getDom()).appendChild(n),this._api=e,this._container=r;var s=this;n.onmouseenter=function(){s._enterable&&(clearTimeout(s._hideTimeout),s._show=!0),s._inContent=!0},n.onmousemove=function(e){if(e=e||window.event,!s._enterable){var t=i.handler;fD(i.painter.getViewportRoot(),e,!0),t.dispatch("mousemove",e)}},n.onmouseleave=function(){s._inContent=!1,s._enterable&&s._show&&s.hideLater(s._hideDelay)}}return e.prototype.update=function(e){if(!this._container){var t=this._api.getDom(),n=(r="position",(s=(a=t).currentStyle||document.defaultView&&document.defaultView.getComputedStyle(a))?s[r]:null),i=t.style;"absolute"!==i.position&&"absolute"!==n&&(i.position="relative")}var a,r,s,o=e.get("alwaysShowContent");o&&this._moveIfResized(),this._alwaysShowContent=o,this._enableDisplayTransition=e.get("displayTransition")&&e.get("transitionDuration")>0,this.el.className=e.get("className")||""},e.prototype.show=function(e,t){clearTimeout(this._hideTimeout),clearTimeout(this._longHideTimeout);var n=this.el,i=n.style,a=this._styleCoord;n.innerHTML?i.cssText=r1+o1(e,!this._firstShow,this._longHide,this._enableDisplayTransition)+s1(a[0],a[1],!0)+"border-color:"+NN(t)+";"+(e.get("extraCssText")||"")+";pointer-events:"+(this._enterable?"auto":"none"):i.display="none",this._show=!0,this._firstShow=!1,this._longHide=!1},e.prototype.setContent=function(e,t,n,i,a){var r=this.el;if(null!=e){var s="";if(YC(a)&&"item"===n.get("trigger")&&!J0(n)&&(s=function(e,t,n){if(!YC(n)||"inside"===n)return"";var i=e.get("backgroundColor"),a=e.get("borderWidth");t=NN(t);var r,s,o="left"===(r=n)?"right":"right"===r?"left":"top"===r?"bottom":"top",l=Math.max(1.5*Math.round(a),6),c="",d=a1+":";LC(["left","right"],o)>-1?(c+="top:50%",d+="translateY(-50%) rotate("+(s="left"===o?-225:-45)+"deg)"):(c+="left:50%",d+="translateX(-50%) rotate("+(s="top"===o?225:45)+"deg)");var u=s*Math.PI/180,h=l+a,p=h*Math.abs(Math.cos(u))+h*Math.abs(Math.sin(u)),g=t+" solid "+a+"px;";return'<div style="'+["position:absolute;width:"+l+"px;height:"+l+"px;z-index:-1;",(c+=";"+o+":-"+Math.round(100*((p-Math.SQRT2*a)/2+Math.SQRT2*a-(p-h)/2))/100+"px")+";"+d+";","border-bottom:"+g,"border-right:"+g,"background-color:"+i+";"].join("")+'"></div>'}(n,i,a)),YC(e))r.innerHTML=e+s;else if(e){r.innerHTML="",KC(e)||(e=[e]);for(var o=0;o<e.length;o++)iI(e[o])&&e[o].parentNode!==r&&r.appendChild(e[o]);if(s&&r.childNodes.length){var l=document.createElement("div");l.innerHTML=s,r.appendChild(l)}}}else r.innerHTML=""},e.prototype.setEnterable=function(e){this._enterable=e},e.prototype.getSize=function(){var e=this.el;return e?[e.offsetWidth,e.offsetHeight]:[0,0]},e.prototype.moveTo=function(e,t){if(this.el){var n=this._styleCoord;if(l1(n,this._zr,this._container,e,t),null!=n[0]&&null!=n[1]){var i=this.el.style;jC(s1(n[0],n[1]),function(e){i[e[0]]=e[1]})}}},e.prototype._moveIfResized=function(){var e=this._styleCoord[2],t=this._styleCoord[3];this.moveTo(e*this._zr.getWidth(),t*this._zr.getHeight())},e.prototype.hide=function(){var e=this,t=this.el.style;this._enableDisplayTransition?(t.visibility="hidden",t.opacity="0"):t.display="none",pC.transform3dSupported&&(t.willChange=""),this._show=!1,this._longHideTimeout=setTimeout(function(){return e._longHide=!0},500)},e.prototype.hideLater=function(e){!this._show||this._inContent&&this._enterable||this._alwaysShowContent||(e?(this._hideDelay=e,this._show=!1,this._hideTimeout=setTimeout(GC(this.hide,this),e)):this.hide())},e.prototype.isShow=function(){return this._show},e.prototype.dispose=function(){clearTimeout(this._hideTimeout),clearTimeout(this._longHideTimeout);var e=this._zr;!function(e,t){function n(e){var t=e[iD];t&&(t.clearMarkers&&t.clearMarkers(),delete e[iD])}e&&n(e),t&&n(t)}(e&&e.painter&&e.painter.getViewportRoot(),this._container);var t=this.el;if(t){t.onmouseenter=t.onmousemove=t.onmouseleave=null;var n=t.parentNode;n&&n.removeChild(t)}this.el=this._container=null},e}(),d1=function(){function e(e){this._show=!1,this._styleCoord=[0,0,0,0],this._alwaysShowContent=!1,this._enterable=!0,this._zr=e.getZr(),p1(this._styleCoord,this._zr,e.getWidth()/2,e.getHeight()/2)}return e.prototype.update=function(e){var t=e.get("alwaysShowContent");t&&this._moveIfResized(),this._alwaysShowContent=t},e.prototype.show=function(){this._hideTimeout&&clearTimeout(this._hideTimeout),this.el.show(),this._show=!0},e.prototype.setContent=function(e,t,n,i,a){var r=this;eI(e)&&_E(""),this.el&&this._zr.remove(this.el);var s=n.getModel("textStyle");this.el=new JP({style:{rich:t.richTextStyles,text:e,lineHeight:22,borderWidth:1,borderColor:i,textShadowColor:s.get("textShadowColor"),fill:n.get(["textStyle","color"]),padding:Vj(n,"richText"),verticalAlign:"top",align:"left"},z:n.get("z")}),jC(["backgroundColor","borderRadius","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY"],function(e){r.el.style[e]=n.get(e)}),jC(["textShadowBlur","textShadowOffsetX","textShadowOffsetY"],function(e){r.el.style[e]=s.get(e)||0}),this._zr.add(this.el);var o=this;this.el.on("mouseover",function(){o._enterable&&(clearTimeout(o._hideTimeout),o._show=!0),o._inContent=!0}),this.el.on("mouseout",function(){o._enterable&&o._show&&o.hideLater(o._hideDelay),o._inContent=!1})},e.prototype.setEnterable=function(e){this._enterable=e},e.prototype.getSize=function(){var e=this.el,t=this.el.getBoundingRect(),n=h1(e.style);return[t.width+n.left+n.right,t.height+n.top+n.bottom]},e.prototype.moveTo=function(e,t){var n=this.el;if(n){var i=this._styleCoord;p1(i,this._zr,e,t),e=i[0],t=i[1];var a=n.style,r=u1(a.borderWidth||0),s=h1(a);n.x=e+r+s.left,n.y=t+r+s.top,n.markRedraw()}},e.prototype._moveIfResized=function(){var e=this._styleCoord[2],t=this._styleCoord[3];this.moveTo(e*this._zr.getWidth(),t*this._zr.getHeight())},e.prototype.hide=function(){this.el&&this.el.hide(),this._show=!1},e.prototype.hideLater=function(e){!this._show||this._inContent&&this._enterable||this._alwaysShowContent||(e?(this._hideDelay=e,this._show=!1,this._hideTimeout=setTimeout(GC(this.hide,this),e)):this.hide())},e.prototype.isShow=function(){return this._show},e.prototype.dispose=function(){this._zr.remove(this.el)},e}();function u1(e){return Math.max(0,e)}function h1(e){var t=u1(e.shadowBlur||0),n=u1(e.shadowOffsetX||0),i=u1(e.shadowOffsetY||0);return{left:u1(t-n),right:u1(t+n),top:u1(t-i),bottom:u1(t+i)}}function p1(e,t,n,i){e[0]=n,e[1]=i,e[2]=e[0]/t.getWidth(),e[3]=e[1]/t.getHeight()}var g1=new KP({shape:{x:-1,y:-1,width:2,height:2}}),v1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.init=function(e,t){if(!pC.node&&t.getDom()){var n,i=e.getComponent("tooltip"),a=this._renderMode="auto"===(n=i.get("renderMode"))?pC.domSupported?"html":"richText":n||"html";this._tooltipContent="richText"===a?new d1(t):new c1(t,{appendTo:i.get("appendToBody",!0)?"body":i.get("appendTo",!0)})}},t.prototype.render=function(e,t,n){if(!pC.node&&n.getDom()){this.group.removeAll(),this._tooltipModel=e,this._ecModel=t,this._api=n;var i=this._tooltipContent;i.update(e),i.setEnterable(e.get("enterable")),this._initGlobalListener(),this._keepShow(),"richText"!==this._renderMode&&e.get("transitionDuration")?fU(this,"_updatePosition",50,"fixRate"):mU(this,"_updatePosition")}},t.prototype._initGlobalListener=function(){var e=this._tooltipModel.get("triggerOn");EJ("itemTooltip",this._api,GC(function(t,n,i){"none"!==e&&(e.indexOf(t)>=0?this._tryShow(n,i):"leave"===t&&this._hide(i))},this))},t.prototype._keepShow=function(){var e=this._tooltipModel,t=this._ecModel,n=this._api,i=e.get("triggerOn");if(null!=this._lastX&&null!=this._lastY&&"none"!==i&&"click"!==i){var a=this;clearTimeout(this._refreshUpdateTimeout),this._refreshUpdateTimeout=setTimeout(function(){!n.isDisposed()&&a.manuallyShowTip(e,t,n,{x:a._lastX,y:a._lastY,dataByCoordSys:a._lastDataByCoordSys})})}},t.prototype.manuallyShowTip=function(e,t,n,i){if(i.from!==this.uid&&!pC.node&&n.getDom()){var a=m1(i,n);this._ticket="";var r=i.dataByCoordSys,s=function(e,t,n){var i=VE(e).queryOptionMap,a=i.keys()[0];if(!a||"series"===a)return;var r=WE(t,a,i.get(a),{useDefault:!1,enableAll:!1,enableNone:!1}),s=r.models[0];if(!s)return;var o,l=n.getViewOfComponentModel(s);if(l.group.traverse(function(t){var n=uR(t).tooltipConfig;if(n&&n.name===e.name)return o=t,!0}),o)return{componentMainType:a,componentIndex:s.componentIndex,el:o}}(i,t,n);if(s){var o=s.el.getBoundingRect().clone();o.applyTransform(s.el.transform),this._tryShow({offsetX:o.x+o.width/2,offsetY:o.y+o.height/2,target:s.el,position:i.position,positionDefault:"bottom"},a)}else if(i.tooltip&&null!=i.x&&null!=i.y){var l=g1;l.x=i.x,l.y=i.y,l.update(),uR(l).tooltipConfig={name:null,option:i.tooltip},this._tryShow({offsetX:i.x,offsetY:i.y,target:l},a)}else if(r)this._tryShow({offsetX:i.x,offsetY:i.y,position:i.position,dataByCoordSys:r,tooltipOption:i.tooltipOption},a);else if(null!=i.seriesIndex){if(this._manuallyAxisShowTip(e,t,n,i))return;var c=OJ(i,t),d=c.point[0],u=c.point[1];null!=d&&null!=u&&this._tryShow({offsetX:d,offsetY:u,target:c.el,position:i.position,positionDefault:"bottom"},a)}else null!=i.x&&null!=i.y&&(n.dispatchAction({type:"updateAxisPointer",x:i.x,y:i.y}),this._tryShow({offsetX:i.x,offsetY:i.y,position:i.position,target:n.getZr().findHover(i.x,i.y).target},a))}},t.prototype.manuallyHideTip=function(e,t,n,i){var a=this._tooltipContent;this._tooltipModel&&a.hideLater(this._tooltipModel.get("hideDelay")),this._lastX=this._lastY=this._lastDataByCoordSys=null,i.from!==this.uid&&this._hide(m1(i,n))},t.prototype._manuallyAxisShowTip=function(e,t,n,i){var a=i.seriesIndex,r=i.dataIndex,s=t.getComponent("axisPointer").coordSysAxesInfo;if(null!=a&&null!=r&&null!=s){var o=t.getSeriesByIndex(a);if(o)if("axis"===f1([o.getData().getItemModel(r),o,(o.coordinateSystem||{}).model],this._tooltipModel).get("trigger"))return n.dispatchAction({type:"updateAxisPointer",seriesIndex:a,dataIndex:r,position:i.position}),!0}},t.prototype._tryShow=function(e,t){var n=e.target;if(this._tooltipModel){this._lastX=e.offsetX,this._lastY=e.offsetY;var i=e.dataByCoordSys;if(i&&i.length)this._showAxisTooltip(i,e);else if(n){var a,r;if("legend"===uR(n).ssrType)return;this._lastDataByCoordSys=null,iV(n,function(e){if(e.tooltipDisabled)return a=r=null,!0;a||r||(null!=uR(e).dataIndex?a=e:null!=uR(e).tooltipConfig&&(r=e))},!0),a?this._showSeriesItemTooltip(e,a,t):r?this._showComponentItemTooltip(e,r,t):this._hide(t)}else this._lastDataByCoordSys=null,this._hide(t)}},t.prototype._showOrMove=function(e,t){var n=e.get("showDelay");t=GC(t,this),clearTimeout(this._showTimout),n>0?this._showTimout=setTimeout(t,n):t()},t.prototype._showAxisTooltip=function(e,t){var n=this._ecModel,i=this._tooltipModel,a=[t.offsetX,t.offsetY],r=f1([t.tooltipOption],i),s=this._renderMode,o=[],l=Rj("section",{blocks:[],noHeader:!0}),c=[],d=new qj;jC(e,function(e){jC(e.dataByAxis,function(e){var t=n.getComponent(e.axisDim+"Axis",e.axisIndex),a=e.value;if(t&&null!=a){var r=SJ(a,t.axis,n,e.seriesDataIndices,e.valueLabelOpt),u=Rj("section",{header:r,noHeader:!gI(r),sortBlocks:!0,blocks:[]});l.blocks.push(u),jC(e.seriesDataIndices,function(l){var h=n.getSeriesByIndex(l.seriesIndex),p=l.dataIndexInside,g=h.getDataParams(p);if(!(g.dataIndex<0)){g.axisDim=e.axisDim,g.axisIndex=e.axisIndex,g.axisType=e.axisType,g.axisId=e.axisId,g.axisValue=UW(t.axis,{value:a}),g.axisValueLabel=r,g.marker=d.makeTooltipMarker("item",NN(g.color),s);var v=KB(h.formatTooltip(p,!0,null)),f=v.frag;if(f){var m=f1([h],i).get("valueFormatter");u.blocks.push(m?RC({valueFormatter:m},f):f)}v.text&&c.push(v.text),o.push(g)}})}})}),l.blocks.reverse(),c.reverse();var u=t.position,h=r.get("order"),p=Bj(l,d,s,h,n.get("useUTC"),r.get("textStyle"));p&&c.unshift(p);var g="richText"===s?"\n\n":"<br/>",v=c.join(g);this._showOrMove(r,function(){this._updateContentNotChangedOnAxis(e,o)?this._updatePosition(r,u,a[0],a[1],this._tooltipContent,o):this._showTooltipContent(r,v,o,Math.random()+"",a[0],a[1],u,null,d)})},t.prototype._showSeriesItemTooltip=function(e,t,n){var i=this._ecModel,a=uR(t),r=a.seriesIndex,s=i.getSeriesByIndex(r),o=a.dataModel||s,l=a.dataIndex,c=a.dataType,d=o.getData(c),u=this._renderMode,h=e.positionDefault,p=f1([d.getItemModel(l),o,s&&(s.coordinateSystem||{}).model],this._tooltipModel,h?{position:h}:null),g=p.get("trigger");if(null==g||"item"===g){var v=o.getDataParams(l,c),f=new qj;v.marker=f.makeTooltipMarker("item",NN(v.color),u);var m=KB(o.formatTooltip(l,!1,c)),y=p.get("order"),b=p.get("valueFormatter"),w=m.frag,k=w?Bj(b?RC({valueFormatter:b},w):w,f,u,y,i.get("useUTC"),p.get("textStyle")):m.text,S="item_"+o.name+"_"+l;this._showOrMove(p,function(){this._showTooltipContent(p,k,v,S,e.offsetX,e.offsetY,e.position,e.target,f)}),n({type:"showTip",dataIndexInside:l,dataIndex:d.getRawIndex(l),seriesIndex:r,from:this.uid})}},t.prototype._showComponentItemTooltip=function(e,t,n){var i="html"===this._renderMode,a=uR(t),r=a.tooltipConfig.option||{},s=r.encodeHTMLContent;if(YC(r)){r={content:r,formatter:r},s=!0}s&&i&&r.content&&((r=zC(r)).content=cD(r.content));var o=[r],l=this._ecModel.getComponent(a.componentMainType,a.componentIndex);l&&o.push(l),o.push({formatter:r.content});var c=e.positionDefault,d=f1(o,this._tooltipModel,c?{position:c}:null),u=d.get("content"),h=Math.random()+"",p=new qj;this._showOrMove(d,function(){var n=zC(d.get("formatterParams")||{});this._showTooltipContent(d,u,n,h,e.offsetX,e.offsetY,e.position,t,p)}),n({type:"showTip",from:this.uid})},t.prototype._showTooltipContent=function(e,t,n,i,a,r,s,o,l){if(this._ticket="",e.get("showContent")&&e.get("show")){var c=this._tooltipContent;c.setEnterable(e.get("enterable"));var d=e.get("formatter");s=s||e.get("position");var u=t,h=this._getNearestPoint([a,r],n,e.get("trigger"),e.get("borderColor"),e.get("defaultBorderColor",!0)).color;if(d)if(YC(d)){var p=e.ecModel.get("useUTC"),g=KC(n)?n[0]:n;u=d,g&&g.axisType&&g.axisType.indexOf("time")>=0&&(u=pN(g.axisValue,u,p)),u=ON(u,n,!0)}else if(ZC(d)){var v=GC(function(t,i){t===this._ticket&&(c.setContent(i,l,e,h,s),this._updatePosition(e,s,a,r,c,n,o))},this);this._ticket=i,u=d(n,i,v)}else u=d;c.setContent(u,l,e,h,s),c.show(e,h),this._updatePosition(e,s,a,r,c,n,o)}},t.prototype._getNearestPoint=function(e,t,n,i,a){return"axis"===n||KC(t)?{color:i||a}:KC(t)?void 0:{color:i||t.color||t.borderColor}},t.prototype._updatePosition=function(e,t,n,i,a,r,s){var o=this._api.getWidth(),l=this._api.getHeight();t=t||e.get("position");var c=a.getSize(),d=e.get("align"),u=e.get("verticalAlign"),h=s&&s.getBoundingRect().clone();if(s&&h.applyTransform(s.transform),ZC(t)&&(t=t([n,i],r,a.el,h,{viewSize:[o,l],contentSize:c.slice()})),KC(t))n=tE(t[0],o),i=tE(t[1],l);else if(eI(t)){var p=t;p.width=c[0],p.height=c[1];var g=nF(p,{width:o,height:l});n=g.x,i=g.y,d=null,u=null}else if(YC(t)&&s){var v=function(e,t,n,i){var a=n[0],r=n[1],s=Math.ceil(Math.SQRT2*i)+8,o=0,l=0,c=t.width,d=t.height;switch(e){case"inside":o=t.x+c/2-a/2,l=t.y+d/2-r/2;break;case"top":o=t.x+c/2-a/2,l=t.y-r-s;break;case"bottom":o=t.x+c/2-a/2,l=t.y+d+s;break;case"left":o=t.x-a-s,l=t.y+d/2-r/2;break;case"right":o=t.x+c+s,l=t.y+d/2-r/2}return[o,l]}(t,h,c,e.get("borderWidth"));n=v[0],i=v[1]}else{v=function(e,t,n,i,a,r,s){var o=n.getSize(),l=o[0],c=o[1];null!=r&&(e+l+r+2>i?e-=l+r:e+=r);null!=s&&(t+c+s>a?t-=c+s:t+=s);return[e,t]}(n,i,a,o,l,d?null:20,u?null:20);n=v[0],i=v[1]}if(d&&(n-=y1(d)?c[0]/2:"right"===d?c[0]:0),u&&(i-=y1(u)?c[1]/2:"bottom"===u?c[1]:0),J0(e)){v=function(e,t,n,i,a){var r=n.getSize(),s=r[0],o=r[1];return e=Math.min(e+s,i)-s,t=Math.min(t+o,a)-o,e=Math.max(e,0),t=Math.max(t,0),[e,t]}(n,i,a,o,l);n=v[0],i=v[1]}a.moveTo(n,i)},t.prototype._updateContentNotChangedOnAxis=function(e,t){var n=this._lastDataByCoordSys,i=this._cbParamsList,a=!!n&&n.length===e.length;return a&&jC(n,function(n,r){var s=n.dataByAxis||[],o=(e[r]||{}).dataByAxis||[];(a=a&&s.length===o.length)&&jC(s,function(e,n){var r=o[n]||{},s=e.seriesDataIndices||[],l=r.seriesDataIndices||[];(a=a&&e.value===r.value&&e.axisType===r.axisType&&e.axisId===r.axisId&&s.length===l.length)&&jC(s,function(e,t){var n=l[t];a=a&&e.seriesIndex===n.seriesIndex&&e.dataIndex===n.dataIndex}),i&&jC(e.seriesDataIndices,function(e){var n=e.seriesIndex,r=t[n],s=i[n];r&&s&&s.data!==r.data&&(a=!1)})})}),this._lastDataByCoordSys=e,this._cbParamsList=t,!!a},t.prototype._hide=function(e){this._lastDataByCoordSys=null,e({type:"hideTip",from:this.uid})},t.prototype.dispose=function(e,t){!pC.node&&t.getDom()&&(mU(this,"_updatePosition"),this._tooltipContent.dispose(),RJ("itemTooltip",t))},t.type="tooltip",t}(nU);function f1(e,t,n){var i,a=t.ecModel;n?(i=new BL(n,a,a),i=new BL(t.option,i,a)):i=t;for(var r=e.length-1;r>=0;r--){var s=e[r];s&&(s instanceof BL&&(s=s.get("tooltip",!0)),YC(s)&&(s={formatter:s}),s&&(i=new BL(s,i,a)))}return i}function m1(e,t){return e.dispatchAction||GC(t.dispatchAction,t)}function y1(e){return"center"===e||"middle"===e}function b1(e){eG(qJ),e.registerComponentModel(X0),e.registerComponentView(v1),e.registerAction({type:"showTip",event:"showTip",update:"tooltip:manuallyShowTip"},II),e.registerAction({type:"hideTip",event:"hideTip",update:"tooltip:manuallyHideTip"},II)}var w1=jC;function k1(e){if(e)for(var t in e)if(e.hasOwnProperty(t))return!0}function S1(e,t,n){var i={};return w1(t,function(t){var a,r=i[t]=((a=function(){}).prototype.__hidden=a.prototype,new a);w1(e[t],function(e,i){if(VY.isValidType(i)){var a={type:i,visual:e};n&&n(a,t),r[i]=new VY(a),"opacity"===i&&((a=zC(a)).type="colorAlpha",r.__hidden.__alphaForOpacity=new VY(a))}})}),i}var x1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.layoutMode={type:"box",ignoreSize:!0},n}return uC(t,e),t.type="title",t.defaultOption={z:6,show:!0,text:"",target:"blank",subtext:"",subtarget:"blank",left:"center",top:uF.size.m,backgroundColor:uF.color.transparent,borderColor:uF.color.primary,borderWidth:0,padding:5,itemGap:10,textStyle:{fontSize:18,fontWeight:"bold",color:uF.color.primary},subtextStyle:{fontSize:12,color:uF.color.quaternary}},t}(dF),_1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.render=function(e,t,n){if(this.group.removeAll(),e.get("show")){var i=this.group,a=e.getModel("textStyle"),r=e.getModel("subtextStyle"),s=e.get("textAlign"),o=cI(e.get("textBaseline"),e.get("textVerticalAlign")),l=new JP({style:bL(a,{text:e.get("text"),fill:a.getTextColor()},{disableBox:!0}),z2:10}),c=l.getBoundingRect(),d=e.get("subtext"),u=new JP({style:bL(r,{text:d,fill:r.getTextColor(),y:c.height+e.get("itemGap"),verticalAlign:"top"},{disableBox:!0}),z2:10}),h=e.get("link"),p=e.get("sublink"),g=e.get("triggerEvent",!0);l.silent=!h&&!g,u.silent=!p&&!g,h&&l.on("click",function(){FN(h,"_"+e.get("target"))}),p&&u.on("click",function(){FN(p,"_"+e.get("subtarget"))}),uR(l).eventData=uR(u).eventData=g?{componentType:"title",componentIndex:e.componentIndex}:null,i.add(l),d&&i.add(u);var v=i.getBoundingRect(),f=e.getBoxLayoutParams();f.width=v.width,f.height=v.height;var m=nF(f,aF(e,n).refContainer,e.get("padding"));s||("middle"===(s=e.get("left")||e.get("right"))&&(s="center"),"right"===s?m.x+=m.width:"center"===s&&(m.x+=m.width/2)),o||("center"===(o=e.get("top")||e.get("bottom"))&&(o="middle"),"bottom"===o?m.y+=m.height:"middle"===o&&(m.y+=m.height/2),o=o||"top"),i.x=m.x,i.y=m.y,i.markRedraw();var y={align:s,verticalAlign:o};l.setStyle(y),u.setStyle(y),v=i.getBoundingRect();var b=m.margin,w=e.getItemStyle(["color","opacity"]);w.fill=e.get("backgroundColor");var k=new KP({shape:{x:v.x-b[3],y:v.y-b[0],width:v.width+b[1]+b[3],height:v.height+b[0]+b[2],r:e.get("borderRadius")},style:w,subPixelOptimize:!0,silent:!0});i.add(k)}},t.type="title",t}(nU);function C1(e){e.registerComponentModel(x1),e.registerComponentView(_1)}function I1(e,t){if(!e)return!1;for(var n=KC(e)?e:[e],i=0;i<n.length;i++)if(n[i]&&n[i][t])return!0;return!1}function D1(e){ME(e,"label",["show"])}var T1=BE(),M1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.createdBySelf=!1,n.preventAutoZ=!0,n}return uC(t,e),t.prototype.init=function(e,t,n){this.mergeDefaultAndTheme(e,n),this._mergeOption(e,n,!1,!0)},t.prototype.isAnimationEnabled=function(){if(pC.node)return!1;var e=this.__hostSeries;return this.getShallow("animation")&&e&&e.isAnimationEnabled()},t.prototype.mergeOption=function(e,t){this._mergeOption(e,t,!1,!1)},t.prototype._mergeOption=function(e,t,n,i){var a=this.mainType;n||t.eachSeries(function(e){var n=e.get(this.mainType,!0),r=T1(e)[a];n&&n.data?(r?r._mergeOption(n,t,!0):(i&&D1(n),jC(n.data,function(e){e instanceof Array?(D1(e[0]),D1(e[1])):D1(e)}),RC(r=this.createMarkerModelFromSeries(n,this,t),{mainType:this.mainType,seriesIndex:e.seriesIndex,name:e.name,createdBySelf:!0}),r.__hostSeries=e),T1(e)[a]=r):T1(e)[a]=null},this)},t.prototype.formatTooltip=function(e,t,n){var i=this.getData(),a=this.getRawValue(e),r=i.getName(e);return Rj("section",{header:this.name,blocks:[Rj("nameValue",{name:r,value:a,noName:!r,noValue:null==a})]})},t.prototype.getData=function(){return this._data},t.prototype.setData=function(e){this._data=e},t.prototype.getDataParams=function(e,t){var n=QB.prototype.getDataParams.call(this,e,t),i=this.__hostSeries;return i&&(n.seriesId=i.id,n.seriesName=i.name,n.seriesType=i.subType),n},t.getMarkerModelFromSeries=function(e,t){return T1(e)[t]},t.type="marker",t.dependencies=["series","grid","polar","geo"],t}(dF);FC(M1,QB.prototype);var A1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.createMarkerModelFromSeries=function(e,n,i){return new t(e,n,i)},t.type="markPoint",t.defaultOption={z:5,symbol:"pin",symbolSize:50,tooltip:{trigger:"item"},label:{show:!0,position:"inside"},itemStyle:{borderWidth:2},emphasis:{label:{show:!0}}},t}(M1);function E1(e,t,n,i,a,r,s){var o=[],l=UH(t,a)?t.getCalculationInfo("stackResultDimension"):a,c=L1(t,l,e),d=t.hostModel.indicesOfNearest(n,l,c)[0];o[r]=t.get(i,d),o[s]=t.get(l,d);var u=t.get(a,d),h=rE(t.get(a,d));return(h=Math.min(h,20))>=0&&(o[s]=+o[s].toFixed(h)),[o,u]}var z1={min:QC(E1,"min"),max:QC(E1,"max"),average:QC(E1,"average"),median:QC(E1,"median")};function P1(e,t){if(t){var n=e.getData(),i=e.coordinateSystem,a=i&&i.dimensions;if(!function(e){return!isNaN(parseFloat(e.x))&&!isNaN(parseFloat(e.y))}(t)&&!KC(t.coord)&&KC(a)){var r=R1(t,n,i,e);if((t=zC(t)).type&&z1[t.type]&&r.baseAxis&&r.valueAxis){var s=LC(a,r.baseAxis.dim),o=LC(a,r.valueAxis.dim),l=z1[t.type](n,r.valueAxis.dim,r.baseDataDim,r.valueDataDim,s,o);t.coord=l[0],t.value=l[1]}else t.coord=[null!=t.xAxis?t.xAxis:t.radiusAxis,null!=t.yAxis?t.yAxis:t.angleAxis]}if(null!=t.coord&&KC(a))for(var c=t.coord,d=0;d<2;d++)z1[c[d]]&&(c[d]=L1(n,n.mapDimension(a[d]),c[d]));else{t.coord=[];var u=e.getBaseAxis();if(u&&t.type&&z1[t.type]){var h=i.getOtherAxis(u);h&&(t.value=L1(n,n.mapDimension(h.dim),t.type))}}return t}}function R1(e,t,n,i){var a={};return null!=e.valueIndex||null!=e.valueDim?(a.valueDataDim=null!=e.valueIndex?t.getDimension(e.valueIndex):e.valueDim,a.valueAxis=n.getAxis(function(e,t){var n=e.getData().getDimensionInfo(t);return n&&n.coordDim}(i,a.valueDataDim)),a.baseAxis=n.getOtherAxis(a.valueAxis),a.baseDataDim=t.mapDimension(a.baseAxis.dim)):(a.baseAxis=i.getBaseAxis(),a.valueAxis=n.getOtherAxis(a.baseAxis),a.baseDataDim=t.mapDimension(a.baseAxis.dim),a.valueDataDim=t.mapDimension(a.valueAxis.dim)),a}function $1(e,t){return!(e&&e.containData&&t.coord&&!function(e){return!(isNaN(parseFloat(e.x))&&isNaN(parseFloat(e.y)))}(t))||e.containData(t.coord)}function O1(e,t){return e?function(e,n,i,a){return JB(a<2?e.coord&&e.coord[a]:e.value,t[a])}:function(e,n,i,a){return JB(e.value,t[a])}}function L1(e,t,n){if("average"===n){var i=0,a=0;return e.each(t,function(e,t){isNaN(e)||(i+=e,a++)}),i/a}return"median"===n?e.getMedian(t):e.getDataExtent(t)["max"===n?1:0]}var N1=BE(),F1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.init=function(){this.markerGroupMap=kI()},t.prototype.render=function(e,t,n){var i=this,a=this.markerGroupMap;a.each(function(e){N1(e).keep=!1}),t.eachSeries(function(e){var a=M1.getMarkerModelFromSeries(e,i.type);a&&i.renderSeries(e,a,t,n)}),a.each(function(e){!N1(e).keep&&i.group.remove(e.group)}),function(e,t,n){e.eachSeries(function(e){var i=M1.getMarkerModelFromSeries(e,n),a=t.get(e.id);if(i&&a&&a.group){var r=dL(i),s=r.z,o=r.zlevel;uL(a.group,s,o)}})}(t,a,this.type)},t.prototype.markKeep=function(e){N1(e).keep=!0},t.prototype.toggleBlurSeries=function(e,t){var n=this;jC(e,function(e){var i=M1.getMarkerModelFromSeries(e,n.type);i&&i.getData().eachItemGraphicEl(function(e){e&&(t?jR(e):UR(e))})})},t.type="marker",t}(nU);function B1(e,t,n){var i=t.coordinateSystem,a=n.getWidth(),r=n.getHeight(),s=i&&i.getArea&&i.getArea();e.each(function(n){var o,l=e.getItemModel(n),c="coordinate"===l.get("relativeTo"),d=c?s?s.width:0:a,u=c?s?s.height:0:r,h=c&&s?s.x:0,p=c&&s?s.y:0,g=tE(l.get("x"),d)+h,v=tE(l.get("y"),u)+p;if(isNaN(g)||isNaN(v)){if(t.getMarkerPosition)o=t.getMarkerPosition(e.getValues(e.dimensions,n));else if(i){var f=e.get(i.dimensions[0],n),m=e.get(i.dimensions[1],n);o=i.dataToPoint([f,m])}}else o=[g,v];isNaN(g)||(o[0]=g),isNaN(v)||(o[1]=v),e.setItemLayout(n,o)})}var j1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.updateTransform=function(e,t,n){t.eachSeries(function(e){var t=M1.getMarkerModelFromSeries(e,"markPoint");t&&(B1(t.getData(),e,n),this.markerGroupMap.get(e.id).updateLayout())},this)},t.prototype.renderSeries=function(e,t,n,i){var a=e.coordinateSystem,r=e.id,s=e.getData(),o=this.markerGroupMap,l=o.get(r)||o.set(r,new BQ),c=function(e,t,n){var i;i=e?UC(e&&e.dimensions,function(e){return RC(RC({},t.getData().getDimensionInfo(t.getData().mapDimension(e))||{}),{name:e,ordinalMeta:null})}):[{name:"value",type:"float"}];var a=new $H(i,n),r=UC(n.get("data"),QC(P1,t));e&&(r=qC(r,QC($1,e)));var s=O1(!!e,i);return a.initData(r,null,s),a}(a,e,t);t.setData(c),B1(t.getData(),e,i),c.each(function(e){var n=c.getItemModel(e),i=n.getShallow("symbol"),a=n.getShallow("symbolSize"),r=n.getShallow("symbolRotate"),o=n.getShallow("symbolOffset"),l=n.getShallow("symbolKeepAspect");if(ZC(i)||ZC(a)||ZC(r)||ZC(o)){var d=t.getRawValue(e),u=t.getDataParams(e);ZC(i)&&(i=i(d,u)),ZC(a)&&(a=a(d,u)),ZC(r)&&(r=r(d,u)),ZC(o)&&(o=o(d,u))}var h=n.getModel("itemStyle").getItemStyle(),p=n.get("z2"),g=tV(s,"color");h.fill||(h.fill=g),c.setItemVisual(e,{z2:cI(p,0),symbol:i,symbolSize:a,symbolRotate:r,symbolOffset:o,symbolKeepAspect:l,style:h})}),l.updateData(c),this.group.add(l.group),c.eachItemGraphicEl(function(e){e.traverse(function(e){uR(e).dataModel=t})}),this.markKeep(l),l.group.silent=t.get("silent")||e.get("silent")},t.type="markPoint",t}(F1);var U1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.createMarkerModelFromSeries=function(e,n,i){return new t(e,n,i)},t.type="markLine",t.defaultOption={z:5,symbol:["circle","arrow"],symbolSize:[8,16],symbolOffset:0,precision:2,tooltip:{trigger:"item"},label:{show:!0,position:"end",distance:5},lineStyle:{type:"dashed"},emphasis:{label:{show:!0},lineStyle:{width:3}},animationEasing:"linear"},t}(M1),V1=BE(),q1=function(e,t,n,i){var a,r=e.getData();if(KC(i))a=i;else{var s=i.type;if("min"===s||"max"===s||"average"===s||"median"===s||null!=i.xAxis||null!=i.yAxis){var o=void 0,l=void 0;if(null!=i.yAxis||null!=i.xAxis)o=t.getAxis(null!=i.yAxis?"y":"x"),l=lI(i.yAxis,i.xAxis);else{var c=R1(i,r,t,e);o=c.valueAxis,l=L1(r,VH(r,c.valueDataDim),s)}var d="x"===o.dim?0:1,u=1-d,h=zC(i),p={coord:[]};h.type=null,h.coord=[],h.coord[u]=-1/0,p.coord[u]=1/0;var g=n.get("precision");g>=0&&JC(l)&&(l=+l.toFixed(Math.min(g,20))),h.coord[d]=p.coord[d]=l,a=[h,p,{type:s,valueIndex:i.valueIndex,value:l}]}else a=[]}var v=[P1(e,a[0]),P1(e,a[1]),RC({},a[2])];return v[2].type=v[2].type||null,PC(v[2],v[0]),PC(v[2],v[1]),v};function H1(e){return!isNaN(e)&&!isFinite(e)}function W1(e,t,n,i){var a=1-e,r=i.dimensions[e];return H1(t[a])&&H1(n[a])&&t[e]===n[e]&&i.getAxis(r).containData(t[e])}function G1(e,t){if("cartesian2d"===e.type){var n=t[0].coord,i=t[1].coord;if(n&&i&&(W1(1,n,i,e)||W1(0,n,i,e)))return!0}return $1(e,t[0])&&$1(e,t[1])}function Q1(e,t,n,i,a){var r,s=i.coordinateSystem,o=e.getItemModel(t),l=tE(o.get("x"),a.getWidth()),c=tE(o.get("y"),a.getHeight());if(isNaN(l)||isNaN(c)){if(i.getMarkerPosition)r=i.getMarkerPosition(e.getValues(e.dimensions,t));else{var d=s.dimensions,u=e.get(d[0],t),h=e.get(d[1],t);r=s.dataToPoint([u,h])}if(JQ(s,"cartesian2d")){var p=s.getAxis("x"),g=s.getAxis("y");d=s.dimensions;H1(e.get(d[0],t))?r[0]=p.toGlobalCoord(p.getExtent()[n?0:1]):H1(e.get(d[1],t))&&(r[1]=g.toGlobalCoord(g.getExtent()[n?0:1]))}isNaN(l)||(r[0]=l),isNaN(c)||(r[1]=c)}else r=[l,c];e.setItemLayout(t,r)}var K1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.updateTransform=function(e,t,n){t.eachSeries(function(e){var t=M1.getMarkerModelFromSeries(e,"markLine");if(t){var i=t.getData(),a=V1(t).from,r=V1(t).to;a.each(function(t){Q1(a,t,!0,e,n),Q1(r,t,!1,e,n)}),i.each(function(e){i.setItemLayout(e,[a.getItemLayout(e),r.getItemLayout(e)])}),this.markerGroupMap.get(e.id).updateLayout()}},this)},t.prototype.renderSeries=function(e,t,n,i){var a=e.coordinateSystem,r=e.id,s=e.getData(),o=this.markerGroupMap,l=o.get(r)||o.set(r,new hX);this.group.add(l.group);var c=function(e,t,n){var i;i=e?UC(e&&e.dimensions,function(e){return RC(RC({},t.getData().getDimensionInfo(t.getData().mapDimension(e))||{}),{name:e,ordinalMeta:null})}):[{name:"value",type:"float"}];var a=new $H(i,n),r=new $H(i,n),s=new $H([],n),o=UC(n.get("data"),QC(q1,t,e,n));e&&(o=qC(o,QC(G1,e)));var l=O1(!!e,i);return a.initData(UC(o,function(e){return e[0]}),null,l),r.initData(UC(o,function(e){return e[1]}),null,l),s.initData(UC(o,function(e){return e[2]})),s.hasItemOption=!0,{from:a,to:r,line:s}}(a,e,t),d=c.from,u=c.to,h=c.line;V1(t).from=d,V1(t).to=u,t.setData(h);var p=t.get("symbol"),g=t.get("symbolSize"),v=t.get("symbolRotate"),f=t.get("symbolOffset");function m(t,n,a){var r=t.getItemModel(n);Q1(t,n,a,e,i);var o=r.getModel("itemStyle").getItemStyle();null==o.fill&&(o.fill=tV(s,"color")),t.setItemVisual(n,{symbolKeepAspect:r.get("symbolKeepAspect"),symbolOffset:cI(r.get("symbolOffset",!0),f[a?0:1]),symbolRotate:cI(r.get("symbolRotate",!0),v[a?0:1]),symbolSize:cI(r.get("symbolSize"),g[a?0:1]),symbol:cI(r.get("symbol",!0),p[a?0:1]),style:o})}KC(p)||(p=[p,p]),KC(g)||(g=[g,g]),KC(v)||(v=[v,v]),KC(f)||(f=[f,f]),c.from.each(function(e){m(d,e,!0),m(u,e,!1)}),h.each(function(e){var t=h.getItemModel(e),n=t.getModel("lineStyle").getLineStyle();h.setItemLayout(e,[d.getItemLayout(e),u.getItemLayout(e)]);var i=t.get("z2");null==n.stroke&&(n.stroke=d.getItemVisual(e,"style").fill),h.setItemVisual(e,{z2:cI(i,0),fromSymbolKeepAspect:d.getItemVisual(e,"symbolKeepAspect"),fromSymbolOffset:d.getItemVisual(e,"symbolOffset"),fromSymbolRotate:d.getItemVisual(e,"symbolRotate"),fromSymbolSize:d.getItemVisual(e,"symbolSize"),fromSymbol:d.getItemVisual(e,"symbol"),toSymbolKeepAspect:u.getItemVisual(e,"symbolKeepAspect"),toSymbolOffset:u.getItemVisual(e,"symbolOffset"),toSymbolRotate:u.getItemVisual(e,"symbolRotate"),toSymbolSize:u.getItemVisual(e,"symbolSize"),toSymbol:u.getItemVisual(e,"symbol"),style:n})}),l.updateData(h),c.line.eachItemGraphicEl(function(e){uR(e).dataModel=t,e.traverse(function(e){uR(e).dataModel=t})}),this.markKeep(l),l.group.silent=t.get("silent")||e.get("silent")},t.type="markLine",t}(F1);var Z1=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.layoutMode={type:"box",ignoreSize:!0},n}return uC(t,e),t.prototype.init=function(e,t,n){this.mergeDefaultAndTheme(e,n),e.selected=e.selected||{},this._updateSelector(e)},t.prototype.mergeOption=function(t,n){e.prototype.mergeOption.call(this,t,n),this._updateSelector(t)},t.prototype._updateSelector=function(e){var t=e.selector,n=this.ecModel;!0===t&&(t=e.selector=["all","inverse"]),KC(t)&&jC(t,function(e,i){YC(e)&&(e={type:e}),t[i]=PC(e,function(e,t){return"all"===t?{type:"all",title:e.getLocaleModel().get(["legend","selector","all"])}:"inverse"===t?{type:"inverse",title:e.getLocaleModel().get(["legend","selector","inverse"])}:void 0}(n,e.type))})},t.prototype.optionUpdated=function(){this._updateData(this.ecModel);var e=this._data;if(e[0]&&"single"===this.get("selectedMode")){for(var t=!1,n=0;n<e.length;n++){var i=e[n].get("name");if(this.isSelected(i)){this.select(i),t=!0;break}}!t&&this.select(e[0].get("name"))}},t.prototype._updateData=function(e){var t=[],n=[];e.eachRawSeries(function(i){var a,r=i.name;if(n.push(r),i.legendVisualProvider){var s=i.legendVisualProvider.getAllNames();e.isSeriesFiltered(i)||(n=n.concat(s)),s.length?t=t.concat(s):a=!0}else a=!0;a&&LE(i)&&t.push(i.name)}),this._availableNames=n;var i=this.get("data")||t,a=kI(),r=UC(i,function(e){return(YC(e)||JC(e))&&(e={name:e}),a.get(e.name)?null:(a.set(e.name,!0),new BL(e,this,this.ecModel))},this);this._data=qC(r,function(e){return!!e})},t.prototype.getData=function(){return this._data},t.prototype.select=function(e){var t=this.option.selected;"single"===this.get("selectedMode")&&jC(this._data,function(e){t[e.get("name")]=!1});t[e]=!0},t.prototype.unSelect=function(e){"single"!==this.get("selectedMode")&&(this.option.selected[e]=!1)},t.prototype.toggleSelected=function(e){var t=this.option.selected;t.hasOwnProperty(e)||(t[e]=!0),this[t[e]?"unSelect":"select"](e)},t.prototype.allSelect=function(){var e=this._data,t=this.option.selected;jC(e,function(e){t[e.get("name",!0)]=!0})},t.prototype.inverseSelect=function(){var e=this._data,t=this.option.selected;jC(e,function(e){var n=e.get("name",!0);t.hasOwnProperty(n)||(t[n]=!0),t[n]=!t[n]})},t.prototype.isSelected=function(e){var t=this.option.selected;return!(t.hasOwnProperty(e)&&!t[e])&&LC(this._availableNames,e)>=0},t.prototype.getOrient=function(){return"vertical"===this.get("orient")?{index:1,name:"vertical"}:{index:0,name:"horizontal"}},t.type="legend.plain",t.dependencies=["series"],t.defaultOption={z:4,show:!0,orient:"horizontal",left:"center",bottom:uF.size.m,align:"auto",backgroundColor:uF.color.transparent,borderColor:uF.color.border,borderRadius:0,borderWidth:0,padding:5,itemGap:8,itemWidth:25,itemHeight:14,symbolRotate:"inherit",symbolKeepAspect:!0,inactiveColor:uF.color.disabled,inactiveBorderColor:uF.color.disabled,inactiveBorderWidth:"auto",itemStyle:{color:"inherit",opacity:"inherit",borderColor:"inherit",borderWidth:"auto",borderCap:"inherit",borderJoin:"inherit",borderDashOffset:"inherit",borderMiterLimit:"inherit"},lineStyle:{width:"auto",color:"inherit",inactiveColor:uF.color.disabled,inactiveWidth:2,opacity:"inherit",type:"inherit",cap:"inherit",join:"inherit",dashOffset:"inherit",miterLimit:"inherit"},textStyle:{color:uF.color.secondary},selectedMode:!0,selector:!1,selectorLabel:{show:!0,borderRadius:10,padding:[3,5,3,5],fontSize:12,fontFamily:"sans-serif",color:uF.color.tertiary,borderWidth:1,borderColor:uF.color.border},emphasis:{selectorLabel:{show:!0,color:uF.color.quaternary}},selectorPosition:"auto",selectorItemGap:7,selectorButtonGap:10,tooltip:{show:!1},triggerEvent:!1},t}(dF),Y1=QC,X1=jC,J1=jA,e2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.newlineDisabled=!1,n}return uC(t,e),t.prototype.init=function(){this.group.add(this._contentGroup=new J1),this.group.add(this._selectorGroup=new J1),this._isFirstRender=!0},t.prototype.getContentGroup=function(){return this._contentGroup},t.prototype.getSelectorGroup=function(){return this._selectorGroup},t.prototype.render=function(e,t,n){var i=this._isFirstRender;if(this._isFirstRender=!1,this.resetInner(),e.get("show",!0)){var a=e.get("align"),r=e.get("orient");a&&"auto"!==a||(a="right"===e.get("left")&&"vertical"===r?"right":"left");var s=e.get("selector",!0),o=e.get("selectorPosition",!0);!s||o&&"auto"!==o||(o="horizontal"===r?"end":"start"),this.renderInner(a,e,t,n,s,r,o);var l=aF(e,n).refContainer,c=e.getBoxLayoutParams(),d=e.get("padding"),u=nF(c,l,d),h=this.layoutInner(e,a,u,i,s,o),p=nF($C({width:h.width,height:h.height},c),l,d);this.group.x=p.x-h.x,this.group.y=p.y-h.y,this.group.markRedraw(),this.group.add(this._backgroundEl=v0(h,e))}},t.prototype.resetInner=function(){this.getContentGroup().removeAll(),this._backgroundEl&&this.group.remove(this._backgroundEl),this.getSelectorGroup().removeAll()},t.prototype.renderInner=function(e,t,n,i,a,r,s){var o=this.getContentGroup(),l=kI(),c=t.get("selectedMode"),d=t.get("triggerEvent"),u=[];n.eachRawSeries(function(e){!e.get("legendHoverLink")&&u.push(e.id)}),X1(t.getData(),function(a,r){var s=this,h=a.get("name");if(!this.newlineDisabled&&(""===h||"\n"===h)){var p=new J1;return p.newline=!0,void o.add(p)}var g=n.getSeriesByName(h)[0];if(!l.get(h))if(g){var v=g.getData(),f=v.getVisual("legendLineStyle")||{},m=v.getVisual("legendIcon"),y=v.getVisual("style"),b=this._createItem(g,h,r,a,t,e,f,y,m,c,i);b.on("click",Y1(t2,h,null,i,u)).on("mouseover",Y1(i2,g.name,null,i,u)).on("mouseout",Y1(a2,g.name,null,i,u)),n.ssr&&b.eachChild(function(e){var t=uR(e);t.seriesIndex=g.seriesIndex,t.dataIndex=r,t.ssrType="legend"}),d&&b.eachChild(function(e){s.packEventData(e,t,g,r,h)}),l.set(h,!0)}else n.eachRawSeries(function(s){var o=this;if(!l.get(h)&&s.legendVisualProvider){var p=s.legendVisualProvider;if(!p.containName(h))return;var g=p.indexOfName(h),v=p.getItemVisual(g,"style"),f=p.getItemVisual(g,"legendIcon"),m=lM(v.fill);m&&0===m[3]&&(m[3]=.2,v=RC(RC({},v),{fill:mM(m,"rgba")}));var y=this._createItem(s,h,r,a,t,e,{},v,f,c,i);y.on("click",Y1(t2,null,h,i,u)).on("mouseover",Y1(i2,null,h,i,u)).on("mouseout",Y1(a2,null,h,i,u)),n.ssr&&y.eachChild(function(e){var t=uR(e);t.seriesIndex=s.seriesIndex,t.dataIndex=r,t.ssrType="legend"}),d&&y.eachChild(function(e){o.packEventData(e,t,s,r,h)}),l.set(h,!0)}},this)},this),a&&this._createSelector(a,t,i,r,s)},t.prototype.packEventData=function(e,t,n,i,a){var r={componentType:"legend",componentIndex:t.componentIndex,dataIndex:i,value:a,seriesIndex:n.seriesIndex};uR(e).eventData=r},t.prototype._createSelector=function(e,t,n,i,a){var r=this.getSelectorGroup();X1(e,function(e){var i=e.type,a=new JP({style:{x:0,y:0,align:"center",verticalAlign:"middle"},onclick:function(){n.dispatchAction({type:"all"===i?"legendAllSelect":"legendInverseSelect",legendId:t.id})}});r.add(a),mL(a,{normal:t.getModel("selectorLabel"),emphasis:t.getModel(["emphasis","selectorLabel"])},{defaultText:e.title}),XR(a)})},t.prototype._createItem=function(e,t,n,i,a,r,s,o,l,c,d){var u=e.visualDrawType,h=a.get("itemWidth"),p=a.get("itemHeight"),g=a.isSelected(t),v=i.get("symbolRotate"),f=i.get("symbolKeepAspect"),m=i.get("icon"),y=function(e,t,n,i,a,r,s){function o(e,t){"auto"===e.lineWidth&&(e.lineWidth=t.lineWidth>0?2:0),X1(e,function(n,i){"inherit"===e[i]&&(e[i]=t[i])})}var l=t.getModel("itemStyle"),c=l.getItemStyle(),d=0===e.lastIndexOf("empty",0)?"fill":"stroke",u=l.getShallow("decal");c.decal=u&&"inherit"!==u?UV(u,s):i.decal,"inherit"===c.fill&&(c.fill=i[a]);"inherit"===c.stroke&&(c.stroke=i[d]);"inherit"===c.opacity&&(c.opacity=("fill"===a?i:n).opacity);o(c,i);var h=t.getModel("lineStyle"),p=h.getLineStyle();if(o(p,n),"auto"===c.fill&&(c.fill=i.fill),"auto"===c.stroke&&(c.stroke=i.fill),"auto"===p.stroke&&(p.stroke=i.fill),!r){var g=t.get("inactiveBorderWidth"),v=c[d];c.lineWidth="auto"===g?i.lineWidth>0&&v?2:0:c.lineWidth,c.fill=t.get("inactiveColor"),c.stroke=t.get("inactiveBorderColor"),p.stroke=h.get("inactiveColor"),p.lineWidth=h.get("inactiveWidth")}return{itemStyle:c,lineStyle:p}}(l=m||l||"roundRect",i,s,o,u,g,d),b=new J1,w=i.getModel("textStyle");if(!ZC(e.getLegendIcon)||m&&"inherit"!==m){var k="inherit"===m&&e.getData().getVisual("symbol")?"inherit"===v?e.getData().getVisual("symbolRotate"):v:0;b.add(function(e){var t=e.icon||"roundRect",n=vV(t,0,0,e.itemWidth,e.itemHeight,e.itemStyle.fill,e.symbolKeepAspect);n.setStyle(e.itemStyle),n.rotation=(e.iconRotate||0)*Math.PI/180,n.setOrigin([e.itemWidth/2,e.itemHeight/2]),t.indexOf("empty")>-1&&(n.style.stroke=n.style.fill,n.style.fill=uF.color.neutral00,n.style.lineWidth=2);return n}({itemWidth:h,itemHeight:p,icon:l,iconRotate:k,itemStyle:y.itemStyle,symbolKeepAspect:f}))}else b.add(e.getLegendIcon({itemWidth:h,itemHeight:p,icon:l,iconRotate:v,itemStyle:y.itemStyle,lineStyle:y.lineStyle,symbolKeepAspect:f}));var S="left"===r?h+5:-5,x=r,_=a.get("formatter"),C=t;YC(_)&&_?C=_.replace("{name}",null!=t?t:""):ZC(_)&&(C=_(t));var I=g?w.getTextColor():i.get("inactiveColor");b.add(new JP({style:bL(w,{text:C,x:S,y:p/2,fill:I,align:x,verticalAlign:"middle"},{inheritColor:I})}));var D=new KP({shape:b.getBoundingRect(),style:{fill:"transparent"}}),T=i.getModel("tooltip");return T.get("show")&&iL({el:D,componentModel:a,itemName:t,itemTooltipOption:T.option}),b.add(D),b.eachChild(function(e){e.silent=!0}),D.silent=!c,this.getContentGroup().add(b),XR(b),b.__legendDataIndex=n,b},t.prototype.layoutInner=function(e,t,n,i,a,r){var s=this.getContentGroup(),o=this.getSelectorGroup();eF(e.get("orient"),s,e.get("itemGap"),n.width,n.height);var l=s.getBoundingRect(),c=[-l.x,-l.y];if(o.markRedraw(),s.markRedraw(),a){eF("horizontal",o,e.get("selectorItemGap",!0));var d=o.getBoundingRect(),u=[-d.x,-d.y],h=e.get("selectorButtonGap",!0),p=e.getOrient().index,g=0===p?"width":"height",v=0===p?"height":"width",f=0===p?"y":"x";"end"===r?u[p]+=l[g]+h:c[p]+=d[g]+h,u[1-p]+=l[v]/2-d[v]/2,o.x=u[0],o.y=u[1],s.x=c[0],s.y=c[1];var m={x:0,y:0};return m[g]=l[g]+h+d[g],m[v]=Math.max(l[v],d[v]),m[f]=Math.min(0,d[f]+u[1-p]),m}return s.x=c[0],s.y=c[1],this.group.getBoundingRect()},t.prototype.remove=function(){this.getContentGroup().removeAll(),this._isFirstRender=!0},t.type="legend.plain",t}(nU);function t2(e,t,n,i){a2(e,t,n,i),n.dispatchAction({type:"legendToggleSelect",name:null!=e?e:t}),i2(e,t,n,i)}function n2(e){for(var t,n=e.getZr().storage.getDisplayList(),i=0,a=n.length;i<a&&!(t=n[i].states.emphasis);)i++;return t&&t.hoverLayer}function i2(e,t,n,i){n2(n)||n.dispatchAction({type:"highlight",seriesName:e,name:t,excludeSeriesId:i})}function a2(e,t,n,i){n2(n)||n.dispatchAction({type:"downplay",seriesName:e,name:t,excludeSeriesId:i})}function r2(e){var t=e.findComponents({mainType:"legend"});t&&t.length&&e.filterSeries(function(e){for(var n=0;n<t.length;n++)if(!t[n].isSelected(e.name))return!1;return!0})}function s2(e,t,n){var i="allSelect"===e||"inverseSelect"===e,a={},r=[];n.eachComponent({mainType:"legend",query:t},function(n){i?n[e]():n[e](t.name),o2(n,a),r.push(n.componentIndex)});var s={};return n.eachComponent("legend",function(e){jC(a,function(t,n){e[t?"select":"unSelect"](n)}),o2(e,s)}),i?{selected:s,legendIndex:r}:{name:t.name,selected:s}}function o2(e,t){var n=t||{};return jC(e.getData(),function(t){var i=t.get("name");if("\n"!==i&&""!==i){var a=e.isSelected(i);CI(n,i)?n[i]=n[i]&&a:n[i]=a}}),n}function l2(e){e.registerComponentModel(Z1),e.registerComponentView(e2),e.registerProcessor(e.PRIORITY.PROCESSOR.SERIES_FILTER,r2),e.registerSubTypeDefaulter("legend",function(){return"plain"}),function(e){e.registerAction("legendToggleSelect","legendselectchanged",QC(s2,"toggleSelected")),e.registerAction("legendAllSelect","legendselectall",QC(s2,"allSelect")),e.registerAction("legendInverseSelect","legendinverseselect",QC(s2,"inverseSelect")),e.registerAction("legendSelect","legendselected",QC(s2,"select")),e.registerAction("legendUnSelect","legendunselected",QC(s2,"unSelect"))}(e)}var c2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.setScrollDataIndex=function(e){this.option.scrollDataIndex=e},t.prototype.init=function(t,n,i){var a=lF(t);e.prototype.init.call(this,t,n,i),d2(this,t,a)},t.prototype.mergeOption=function(t,n){e.prototype.mergeOption.call(this,t,n),d2(this,this.option,t)},t.type="legend.scroll",t.defaultOption=VL(Z1.defaultOption,{scrollDataIndex:0,pageButtonItemGap:5,pageButtonGap:null,pageButtonPosition:"end",pageFormatter:"{current}/{total}",pageIcons:{horizontal:["M0,0L12,-10L12,10z","M0,0L-12,-10L-12,10z"],vertical:["M0,0L20,0L10,-20z","M0,0L20,0L10,20z"]},pageIconColor:uF.color.accent50,pageIconInactiveColor:uF.color.accent10,pageIconSize:15,pageTextStyle:{color:uF.color.tertiary},animationDurationUpdate:800}),t}(Z1);function d2(e,t,n){var i=[1,1];i[e.getOrient().index]=0,oF(t,n,{type:"box",ignoreSize:!!i})}var u2=jA,h2=["width","height"],p2=["x","y"],g2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.newlineDisabled=!0,n._currentIndex=0,n}return uC(t,e),t.prototype.init=function(){e.prototype.init.call(this),this.group.add(this._containerGroup=new u2),this._containerGroup.add(this.getContentGroup()),this.group.add(this._controllerGroup=new u2)},t.prototype.resetInner=function(){e.prototype.resetInner.call(this),this._controllerGroup.removeAll(),this._containerGroup.removeClipPath(),this._containerGroup.__rectSize=null},t.prototype.renderInner=function(t,n,i,a,r,s,o){var l=this;e.prototype.renderInner.call(this,t,n,i,a,r,s,o);var c=this._controllerGroup,d=n.get("pageIconSize",!0),u=KC(d)?d:[d,d];p("pagePrev",0);var h=n.getModel("pageTextStyle");function p(e,t){var i=e+"DataIndex",r=YO(n.get("pageIcons",!0)[n.getOrient().name][t],{onclick:GC(l._pageGo,l,i,n,a)},{x:-u[0]/2,y:-u[1]/2,width:u[0],height:u[1]});r.name=e,c.add(r)}c.add(new JP({name:"pageText",style:{text:"xx/xx",fill:h.getTextColor(),font:h.getFont(),verticalAlign:"middle",align:"center"},silent:!0})),p("pageNext",1)},t.prototype.layoutInner=function(e,t,n,i,a,r){var s=this.getSelectorGroup(),o=e.getOrient().index,l=h2[o],c=p2[o],d=h2[1-o],u=p2[1-o];a&&eF("horizontal",s,e.get("selectorItemGap",!0));var h=e.get("selectorButtonGap",!0),p=s.getBoundingRect(),g=[-p.x,-p.y],v=zC(n);a&&(v[l]=n[l]-p[l]-h);var f=this._layoutContentAndController(e,i,v,o,l,d,u,c);if(a){if("end"===r)g[o]+=f[l]+h;else{var m=p[l]+h;g[o]-=m,f[c]-=m}f[l]+=p[l]+h,g[1-o]+=f[u]+f[d]/2-p[d]/2,f[d]=Math.max(f[d],p[d]),f[u]=Math.min(f[u],p[u]+g[1-o]),s.x=g[0],s.y=g[1],s.markRedraw()}return f},t.prototype._layoutContentAndController=function(e,t,n,i,a,r,s,o){var l=this.getContentGroup(),c=this._containerGroup,d=this._controllerGroup;eF(e.get("orient"),l,e.get("itemGap"),i?n.width:null,i?null:n.height),eF("horizontal",d,e.get("pageButtonItemGap",!0));var u=l.getBoundingRect(),h=d.getBoundingRect(),p=this._showController=u[a]>n[a],g=[-u.x,-u.y];t||(g[i]=l[o]);var v=[0,0],f=[-h.x,-h.y],m=cI(e.get("pageButtonGap",!0),e.get("itemGap",!0));p&&("end"===e.get("pageButtonPosition",!0)?f[i]+=n[a]-h[a]:v[i]+=h[a]+m);f[1-i]+=u[r]/2-h[r]/2,l.setPosition(g),c.setPosition(v),d.setPosition(f);var y={x:0,y:0};if(y[a]=p?n[a]:u[a],y[r]=Math.max(u[r],h[r]),y[s]=Math.min(0,h[s]+f[1-i]),c.__rectSize=n[a],p){var b={x:0,y:0};b[a]=Math.max(n[a]-h[a]-m,0),b[r]=y[r],c.setClipPath(new KP({shape:b})),c.__rectSize=b[a]}else d.eachChild(function(e){e.attr({invisible:!0,silent:!0})});var w=this._getPageInfo(e);return null!=w.pageIndex&&SO(l,{x:w.contentPosition[0],y:w.contentPosition[1]},p?e:null),this._updatePageInfoView(e,w),y},t.prototype._pageGo=function(e,t,n){var i=this._getPageInfo(t)[e];null!=i&&n.dispatchAction({type:"legendScroll",scrollDataIndex:i,legendId:t.id})},t.prototype._updatePageInfoView=function(e,t){var n=this._controllerGroup;jC(["pagePrev","pageNext"],function(i){var a=null!=t[i+"DataIndex"],r=n.childOfName(i);r&&(r.setStyle("fill",a?e.get("pageIconColor",!0):e.get("pageIconInactiveColor",!0)),r.cursor=a?"pointer":"default")});var i=n.childOfName("pageText"),a=e.get("pageFormatter"),r=t.pageIndex,s=null!=r?r+1:0,o=t.pageCount;i&&a&&i.setStyle("text",YC(a)?a.replace("{current}",null==s?"":s+"").replace("{total}",null==o?"":o+""):a({current:s,total:o}))},t.prototype._getPageInfo=function(e){var t=e.get("scrollDataIndex",!0),n=this.getContentGroup(),i=this._containerGroup.__rectSize,a=e.getOrient().index,r=h2[a],s=p2[a],o=this._findTargetItemIndex(t),l=n.children(),c=l[o],d=l.length,u=d?1:0,h={contentPosition:[n.x,n.y],pageCount:u,pageIndex:u-1,pagePrevDataIndex:null,pageNextDataIndex:null};if(!c)return h;var p=y(c);h.contentPosition[a]=-p.s;for(var g=o+1,v=p,f=p,m=null;g<=d;++g)(!(m=y(l[g]))&&f.e>v.s+i||m&&!b(m,v.s))&&(v=f.i>v.i?f:m)&&(null==h.pageNextDataIndex&&(h.pageNextDataIndex=v.i),++h.pageCount),f=m;for(g=o-1,v=p,f=p,m=null;g>=-1;--g)(m=y(l[g]))&&b(f,m.s)||!(v.i<f.i)||(f=v,null==h.pagePrevDataIndex&&(h.pagePrevDataIndex=v.i),++h.pageCount,++h.pageIndex),v=m;return h;function y(e){if(e){var t=e.getBoundingRect(),n=t[s]+e[s];return{s:n,e:n+t[r],i:e.__legendDataIndex}}}function b(e,t){return e.e>=t&&e.s<=t+i}},t.prototype._findTargetItemIndex=function(e){return this._showController?(this.getContentGroup().eachChild(function(i,a){var r=i.__legendDataIndex;null==n&&null!=r&&(n=a),r===e&&(t=a)}),null!=t?t:n):0;var t,n},t.type="legend.scroll",t}(e2);function v2(e){eG(l2),e.registerComponentModel(c2),e.registerComponentView(g2),function(e){e.registerAction("legendScroll","legendscroll",function(e,t){var n=e.scrollDataIndex;null!=n&&t.eachComponent({mainType:"legend",subType:"scroll",query:e},function(e){e.setScrollDataIndex(n)})})}(e)}function f2(e){eG(l2),eG(v2)}var m2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.type="dataZoom.inside",t.defaultOption=VL(XJ.defaultOption,{disabled:!1,zoomLock:!1,zoomOnMouseWheel:!0,moveOnMouseMove:!0,moveOnMouseWheel:!1,preventDefaultMouseMove:!0}),t}(XJ),y2=BE();function b2(e,t){if(t){e.removeKey(t.model.uid);var n=t.controller;n&&n.dispose()}}function w2(e,t){e.isDisposed()||e.dispatchAction({type:"dataZoom",animation:{easing:"cubicOut",duration:100},batch:t})}function k2(e,t,n,i){return e.coordinateSystem.containPoint([n,i])}function S2(e){e.registerProcessor(e.PRIORITY.PROCESSOR.FILTER,function(e,t){var n=y2(t),i=n.coordSysRecordMap||(n.coordSysRecordMap=kI());i.each(function(e){e.dataZoomInfoMap=null}),e.eachComponent({mainType:"dataZoom",subType:"inside"},function(e){jC(ZJ(e).infoList,function(n){var a=n.model.uid,r=i.get(a)||i.set(a,function(e,t){var n={model:t,containsPoint:QC(k2,t),dispatchAction:QC(w2,e),dataZoomInfoMap:null,controller:null},i=n.controller=new EY(e.getZr());return jC(["pan","zoom","scrollMove"],function(e){i.on(e,function(t){var i=[];n.dataZoomInfoMap.each(function(a){if(t.isAvailableBehavior(a.model.option)){var r=(a.getRange||{})[e],s=r&&r(a.dzReferCoordSysInfo,n.model.mainType,n.controller,t);!a.model.get("disabled",!0)&&s&&i.push({dataZoomId:a.model.id,start:s[0],end:s[1]})}}),i.length&&n.dispatchAction(i)})}),n}(t,n.model));(r.dataZoomInfoMap||(r.dataZoomInfoMap=kI())).set(e.uid,{dzReferCoordSysInfo:n,model:e,getRange:null})})}),i.each(function(e){var n,a=e.controller,r=e.dataZoomInfoMap;if(r){var s=r.keys()[0];null!=s&&(n=r.get(s))}if(n){var o=function(e,t,n){var i,a="type_",r={type_true:2,type_move:1,type_false:0,type_undefined:-1},s=!0;return e.each(function(e){var t=e.model,n=!t.get("disabled",!0)&&(!t.get("zoomLock",!0)||"move");r[a+n]>r[a+i]&&(i=n),s=s&&t.get("preventDefaultMouseMove",!0)}),{controlType:i,opt:{zoomOnMouseWheel:!0,moveOnMouseMove:!0,moveOnMouseWheel:!0,preventDefaultMouseMove:!!s,api:n,zInfo:{component:t.model},triggerInfo:{roamTrigger:null,isInSelf:t.containsPoint}}}}(r,e,t);a.enable(o.controlType,o.opt),fU(e,"dispatchAction",n.model.get("throttle",!0),"fixRate")}else b2(i,e)})})}var x2=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="dataZoom.inside",t}return uC(t,e),t.prototype.render=function(t,n,i){e.prototype.render.apply(this,arguments),t.noTarget()?this._clear():(this.range=t.getPercentRange(),function(e,t,n){y2(e).coordSysRecordMap.each(function(e){var i=e.dataZoomInfoMap.get(t.uid);i&&(i.getRange=n)})}(i,t,{pan:GC(_2.pan,this),zoom:GC(_2.zoom,this),scrollMove:GC(_2.scrollMove,this)}))},t.prototype.dispose=function(){this._clear(),e.prototype.dispose.apply(this,arguments)},t.prototype._clear=function(){!function(e,t){for(var n=y2(e).coordSysRecordMap,i=n.keys(),a=0;a<i.length;a++){var r=i[a],s=n.get(r),o=s.dataZoomInfoMap;if(o){var l=t.uid;o.get(l)&&(o.removeKey(l),o.keys().length||b2(n,s))}}}(this.api,this.dataZoomModel),this.range=null},t.type="dataZoom.inside",t}(t0),_2={zoom:function(e,t,n,i){var a=this.range,r=a.slice(),s=e.axisModels[0];if(s){var o=I2[t](null,[i.originX,i.originY],s,n,e),l=(o.signal>0?o.pixelStart+o.pixelLength-o.pixel:o.pixel-o.pixelStart)/o.pixelLength*(r[1]-r[0])+r[0],c=Math.max(1/i.scale,0);r[0]=(r[0]-l)*c+l,r[1]=(r[1]-l)*c+l;var d=this.dataZoomModel.findRepresentativeAxisProxy().getMinMaxSpan();return fX(0,r,[0,100],0,d.minSpan,d.maxSpan),this.range=r,a[0]!==r[0]||a[1]!==r[1]?r:void 0}},pan:C2(function(e,t,n,i,a,r){var s=I2[i]([r.oldX,r.oldY],[r.newX,r.newY],t,a,n);return s.signal*(e[1]-e[0])*s.pixel/s.pixelLength}),scrollMove:C2(function(e,t,n,i,a,r){return I2[i]([0,0],[r.scrollDelta,r.scrollDelta],t,a,n).signal*(e[1]-e[0])*r.scrollDelta})};function C2(e){return function(t,n,i,a){var r=this.range,s=r.slice(),o=t.axisModels[0];if(o)return fX(e(s,o,t,n,i,a),s,[0,100],"all"),this.range=s,r[0]!==s[0]||r[1]!==s[1]?s:void 0}}var I2={grid:function(e,t,n,i,a){var r=n.axis,s={},o=a.model.coordinateSystem.getRect();return e=e||[0,0],"x"===r.dim?(s.pixel=t[0]-e[0],s.pixelLength=o.width,s.pixelStart=o.x,s.signal=r.inverse?1:-1):(s.pixel=t[1]-e[1],s.pixelLength=o.height,s.pixelStart=o.y,s.signal=r.inverse?-1:1),s},polar:function(e,t,n,i,a){var r=n.axis,s={},o=a.model.coordinateSystem,l=o.getRadiusAxis().getExtent(),c=o.getAngleAxis().getExtent();return e=e?o.pointToCoord(e):[0,0],t=o.pointToCoord(t),"radiusAxis"===n.mainType?(s.pixel=t[0]-e[0],s.pixelLength=l[1]-l[0],s.pixelStart=l[0],s.signal=r.inverse?1:-1):(s.pixel=t[1]-e[1],s.pixelLength=c[1]-c[0],s.pixelStart=c[0],s.signal=r.inverse?-1:1),s},singleAxis:function(e,t,n,i,a){var r=n.axis,s=a.model.coordinateSystem.getRect(),o={};return e=e||[0,0],"horizontal"===r.orient?(o.pixel=t[0]-e[0],o.pixelLength=s.width,o.pixelStart=s.x,o.signal=r.inverse?1:-1):(o.pixel=t[1]-e[1],o.pixelLength=s.height,o.pixelStart=s.y,o.signal=r.inverse?-1:1),o}};function D2(e){l0(e),e.registerComponentModel(m2),e.registerComponentView(x2),S2(e)}var T2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.type="dataZoom.slider",t.layoutMode="box",t.defaultOption=VL(XJ.defaultOption,{show:!0,right:"ph",top:"ph",width:"ph",height:"ph",left:null,bottom:null,borderColor:uF.color.accent10,borderRadius:0,backgroundColor:uF.color.transparent,dataBackground:{lineStyle:{color:uF.color.accent30,width:.5},areaStyle:{color:uF.color.accent20,opacity:.2}},selectedDataBackground:{lineStyle:{color:uF.color.accent40,width:.5},areaStyle:{color:uF.color.accent20,opacity:.3}},fillerColor:"rgba(135,175,274,0.2)",handleIcon:"path://M-9.35,34.56V42m0-40V9.5m-2,0h4a2,2,0,0,1,2,2v21a2,2,0,0,1-2,2h-4a2,2,0,0,1-2-2v-21A2,2,0,0,1-11.35,9.5Z",handleSize:"100%",handleStyle:{color:uF.color.neutral00,borderColor:uF.color.accent20},moveHandleSize:7,moveHandleIcon:"path://M-320.9-50L-320.9-50c18.1,0,27.1,9,27.1,27.1V85.7c0,18.1-9,27.1-27.1,27.1l0,0c-18.1,0-27.1-9-27.1-27.1V-22.9C-348-41-339-50-320.9-50z M-212.3-50L-212.3-50c18.1,0,27.1,9,27.1,27.1V85.7c0,18.1-9,27.1-27.1,27.1l0,0c-18.1,0-27.1-9-27.1-27.1V-22.9C-239.4-41-230.4-50-212.3-50z M-103.7-50L-103.7-50c18.1,0,27.1,9,27.1,27.1V85.7c0,18.1-9,27.1-27.1,27.1l0,0c-18.1,0-27.1-9-27.1-27.1V-22.9C-130.9-41-121.8-50-103.7-50z",moveHandleStyle:{color:uF.color.accent40,opacity:.5},showDetail:!0,showDataShadow:"auto",realtime:!0,zoomLock:!1,textStyle:{color:uF.color.tertiary},brushSelect:!0,brushStyle:{color:uF.color.accent30,opacity:.3},emphasis:{handleLabel:{show:!0},handleStyle:{borderColor:uF.color.accent40},moveHandleStyle:{opacity:.8}},defaultLocationEdgeGap:15}),t}(XJ),M2=KP,A2="horizontal",E2="vertical",z2=["line","bar","candlestick","scatter"],P2={easing:"cubicOut",duration:100,delay:0},R2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n._displayables={},n}return uC(t,e),t.prototype.init=function(e,t){this.api=t,this._onBrush=GC(this._onBrush,this),this._onBrushEnd=GC(this._onBrushEnd,this)},t.prototype.render=function(t,n,i,a){if(e.prototype.render.apply(this,arguments),fU(this,"_dispatchZoomAction",t.get("throttle"),"fixRate"),this._orient=t.getOrient(),!1!==t.get("show")){if(t.noTarget())return this._clear(),void this.group.removeAll();a&&"dataZoom"===a.type&&a.from===this.uid||this._buildView(),this._updateView()}else this.group.removeAll()},t.prototype.dispose=function(){this._clear(),e.prototype.dispose.apply(this,arguments)},t.prototype._clear=function(){mU(this,"_dispatchZoomAction");var e=this.api.getZr();e.off("mousemove",this._onBrush),e.off("mouseup",this._onBrushEnd)},t.prototype._buildView=function(){var e=this.group;e.removeAll(),this._brushing=!1,this._displayables.brushRect=null,this._resetLocation(),this._resetInterval();var t=this._displayables.sliderGroup=new jA;this._renderBackground(),this._renderHandle(),this._renderDataShadow(),e.add(t),this._positionGroup()},t.prototype._resetLocation=function(){var e=this.dataZoomModel,t=this.api,n=e.get("brushSelect")?7:0,i=aF(e,t).refContainer,a=this._findCoordRect(),r=e.get("defaultLocationEdgeGap",!0)||0,s=this._orient===A2?{right:i.width-a.x-a.width,top:i.height-30-r-n,width:a.width,height:30}:{right:r,top:a.y,width:30,height:a.height},o=lF(e.option);jC(["right","top","width","height"],function(e){"ph"===o[e]&&(o[e]=s[e])});var l=nF(o,i);this._location={x:l.x,y:l.y},this._size=[l.width,l.height],this._orient===E2&&this._size.reverse()},t.prototype._positionGroup=function(){var e=this.group,t=this._location,n=this._orient,i=this.dataZoomModel.getFirstTargetAxisModel(),a=i&&i.get("inverse"),r=this._displayables.sliderGroup,s=(this._dataShadowInfo||{}).otherAxisInverse;r.attr(n!==A2||a?n===A2&&a?{scaleY:s?1:-1,scaleX:-1}:n!==E2||a?{scaleY:s?-1:1,scaleX:-1,rotation:Math.PI/2}:{scaleY:s?-1:1,scaleX:1,rotation:Math.PI/2}:{scaleY:s?1:-1,scaleX:1});var o=e.getBoundingRect([r]);e.x=t.x-o.x,e.y=t.y-o.y,e.markRedraw()},t.prototype._getViewExtent=function(){return[0,this._size[0]]},t.prototype._renderBackground=function(){var e=this.dataZoomModel,t=this._size,n=this._displayables.sliderGroup,i=e.get("brushSelect");n.add(new M2({silent:!0,shape:{x:0,y:0,width:t[0],height:t[1]},style:{fill:e.get("backgroundColor")},z2:-40}));var a=new M2({shape:{x:0,y:0,width:t[0],height:t[1]},style:{fill:"transparent"},z2:0,onclick:GC(this._onClickPanel,this)}),r=this.api.getZr();i?(a.on("mousedown",this._onBrushStart,this),a.cursor="crosshair",r.on("mousemove",this._onBrush),r.on("mouseup",this._onBrushEnd)):(r.off("mousemove",this._onBrush),r.off("mouseup",this._onBrushEnd)),n.add(a)},t.prototype._renderDataShadow=function(){var e=this._dataShadowInfo=this._prepareDataShadowInfo();if(this._displayables.dataShadowSegs=[],e){var t=this._size,n=this._shadowSize||[],i=e.series,a=i.getRawData(),r=i.getShadowDim&&i.getShadowDim(),s=r&&a.getDimensionInfo(r)?i.getShadowDim():e.otherDim;if(null!=s){var o=this._shadowPolygonPts,l=this._shadowPolylinePts;if(a!==this._shadowData||s!==this._shadowDim||t[0]!==n[0]||t[1]!==n[1]){var c=a.getDataExtent(e.thisDim),d=a.getDataExtent(s),u=.3*(d[1]-d[0]);d=[d[0]-u,d[1]+u];var h,p=[0,t[1]],g=[0,t[0]],v=[[t[0],0],[0,0]],f=[],m=g[1]/Math.max(1,a.count()-1),y=t[0]/(c[1]-c[0]),b="time"===e.thisAxis.type,w=-m,k=Math.round(a.count()/t[0]);a.each([e.thisDim,s],function(e,t,n){if(k>0&&n%k)b||(w+=m);else{w=b?(+e-c[0])*y:w+m;var i=null==t||isNaN(t)||""===t,a=i?0:eE(t,d,p,!0);i&&!h&&n?(v.push([v[v.length-1][0],0]),f.push([f[f.length-1][0],0])):!i&&h&&(v.push([w,0]),f.push([w,0])),i||(v.push([w,a]),f.push([w,a])),h=i}}),o=this._shadowPolygonPts=v,l=this._shadowPolylinePts=f}this._shadowData=a,this._shadowDim=s,this._shadowSize=[t[0],t[1]];for(var S=this.dataZoomModel,x=0;x<3;x++){var _=C(1===x);this._displayables.sliderGroup.add(_),this._displayables.dataShadowSegs.push(_)}}}function C(e){var t=S.getModel(e?"selectedDataBackground":"dataBackground"),n=new jA,i=new G$({shape:{points:o},segmentIgnoreThreshold:1,style:t.getModel("areaStyle").getAreaStyle(),silent:!0,z2:-20}),a=new K$({shape:{points:l},segmentIgnoreThreshold:1,style:t.getModel("lineStyle").getLineStyle(),silent:!0,z2:-19});return n.add(i),n.add(a),n}},t.prototype._prepareDataShadowInfo=function(){var e=this.dataZoomModel,t=e.get("showDataShadow");if(!1!==t){var n,i=this.ecModel;return e.eachTargetAxis(function(a,r){jC(e.getAxisProxy(a,r).getTargetSeriesModels(),function(e){if(!(n||!0!==t&&LC(z2,e.get("type"))<0)){var s,o=i.getComponent(QJ(a),r).axis,l=function(e){return{x:"y",y:"x",radius:"angle",angle:"radius"}[e]}(a),c=e.coordinateSystem;null!=l&&c.getOtherAxis&&(s=c.getOtherAxis(o).inverse),l=e.getData().mapDimension(l);var d=e.getData().mapDimension(a);n={thisAxis:o,series:e,thisDim:d,otherDim:l,otherAxisInverse:s}}},this)},this),n}},t.prototype._renderHandle=function(){var e=this.group,t=this._displayables,n=t.handles=[null,null],i=t.handleLabels=[null,null],a=this._displayables.sliderGroup,r=this._size,s=this.dataZoomModel,o=this.api,l=s.get("borderRadius")||0,c=s.get("brushSelect"),d=t.filler=new M2({silent:c,style:{fill:s.get("fillerColor")},textConfig:{position:"inside"}});a.add(d),a.add(new M2({silent:!0,subPixelOptimize:!0,shape:{x:0,y:0,width:r[0],height:r[1],r:l},style:{stroke:s.get("dataBackgroundColor")||s.get("borderColor"),lineWidth:1,fill:uF.color.transparent}})),jC([0,1],function(t){var r=s.get("handleIcon");!hV[r]&&r.indexOf("path://")<0&&r.indexOf("image://")<0&&(r="path://"+r);var o,l=vV(r,-1,0,2,2,null,!0);l.attr({cursor:(o=this._orient,"vertical"===o?"ns-resize":"ew-resize"),draggable:!0,drift:GC(this._onDragMove,this,t),ondragend:GC(this._onDragEnd,this),onmouseover:GC(this._showDataInfo,this,!0),onmouseout:GC(this._showDataInfo,this,!1),z2:5});var c=l.getBoundingRect(),d=s.get("handleSize");this._handleHeight=tE(d,this._size[1]),this._handleWidth=c.width/c.height*this._handleHeight,l.setStyle(s.getModel("handleStyle").getItemStyle()),l.style.strokeNoScale=!0,l.rectHover=!0,l.ensureState("emphasis").style=s.getModel(["emphasis","handleStyle"]).getItemStyle(),XR(l);var u=s.get("handleColor");null!=u&&(l.style.fill=u),a.add(n[t]=l);var h=s.getModel("textStyle"),p=(s.get("handleLabel")||{}).show||!1;e.add(i[t]=new JP({silent:!0,invisible:!p,style:bL(h,{x:0,y:0,text:"",verticalAlign:"middle",align:"center",fill:h.getTextColor(),font:h.getFont()}),z2:10}))},this);var u=d;if(c){var h=tE(s.get("moveHandleSize"),r[1]),p=t.moveHandle=new KP({style:s.getModel("moveHandleStyle").getItemStyle(),silent:!0,shape:{r:[0,0,2,2],y:r[1]-.5,height:h}}),g=.8*h,v=t.moveHandleIcon=vV(s.get("moveHandleIcon"),-g/2,-g/2,g,g,uF.color.neutral00,!0);v.silent=!0,v.y=r[1]+h/2-.5,p.ensureState("emphasis").style=s.getModel(["emphasis","moveHandleStyle"]).getItemStyle();var f=Math.min(r[1]/2,Math.max(h,10));(u=t.moveZone=new KP({invisible:!0,shape:{y:r[1]-f,height:h+f}})).on("mouseover",function(){o.enterEmphasis(p)}).on("mouseout",function(){o.leaveEmphasis(p)}),a.add(p),a.add(v),a.add(u)}u.attr({draggable:!0,cursor:"default",drift:GC(this._onDragMove,this,"all"),ondragstart:GC(this._showDataInfo,this,!0),ondragend:GC(this._onDragEnd,this),onmouseover:GC(this._showDataInfo,this,!0),onmouseout:GC(this._showDataInfo,this,!1)})},t.prototype._resetInterval=function(){var e=this._range=this.dataZoomModel.getPercentRange(),t=this._getViewExtent();this._handleEnds=[eE(e[0],[0,100],t,!0),eE(e[1],[0,100],t,!0)]},t.prototype._updateInterval=function(e,t){var n=this.dataZoomModel,i=this._handleEnds,a=this._getViewExtent(),r=n.findRepresentativeAxisProxy().getMinMaxSpan(),s=[0,100];fX(t,i,a,n.get("zoomLock")?"all":e,null!=r.minSpan?eE(r.minSpan,s,a,!0):null,null!=r.maxSpan?eE(r.maxSpan,s,a,!0):null);var o=this._range,l=this._range=aE([eE(i[0],a,s,!0),eE(i[1],a,s,!0)]);return!o||o[0]!==l[0]||o[1]!==l[1]},t.prototype._updateView=function(e){var t=this._displayables,n=this._handleEnds,i=aE(n.slice()),a=this._size;jC([0,1],function(e){var i=t.handles[e],r=this._handleHeight;i.attr({scaleX:r/2,scaleY:r/2,x:n[e]+(e?-1:1),y:a[1]/2-r/2})},this),t.filler.setShape({x:i[0],y:0,width:i[1]-i[0],height:a[1]});var r={x:i[0],width:i[1]-i[0]};t.moveHandle&&(t.moveHandle.setShape(r),t.moveZone.setShape(r),t.moveZone.getBoundingRect(),t.moveHandleIcon&&t.moveHandleIcon.attr("x",r.x+r.width/2));for(var s=t.dataShadowSegs,o=[0,i[0],i[1],a[0]],l=0;l<s.length;l++){var c=s[l],d=c.getClipPath();d||(d=new KP,c.setClipPath(d)),d.setShape({x:o[l],y:0,width:o[l+1]-o[l],height:a[1]})}this._updateDataInfo(e)},t.prototype._updateDataInfo=function(e){var t=this.dataZoomModel,n=this._displayables,i=n.handleLabels,a=this._orient,r=["",""];if(t.get("showDetail")){var s=t.findRepresentativeAxisProxy();if(s){var o=s.getAxisModel().axis,l=this._range,c=e?s.calculateDataWindow({start:l[0],end:l[1]}).valueWindow:s.getDataValueWindow();r=[this._formatLabel(c[0],o),this._formatLabel(c[1],o)]}}var d=aE(this._handleEnds.slice());function u(e){var t=qO(n.handles[e].parent,this.group),s=WO(0===e?"right":"left",t),o=this._handleWidth/2+5,l=HO([d[e]+(0===e?-o:o),this._size[1]/2],t);i[e].setStyle({x:l[0],y:l[1],verticalAlign:a===A2?"middle":s,align:a===A2?s:"center",text:r[e]})}u.call(this,0),u.call(this,1)},t.prototype._formatLabel=function(e,t){var n=this.dataZoomModel,i=n.get("labelFormatter"),a=n.get("labelPrecision");null!=a&&"auto"!==a||(a=t.getPixelPrecision());var r=null==e||isNaN(e)?"":"category"===t.type||"time"===t.type?t.scale.getLabel({value:Math.round(e)}):e.toFixed(Math.min(a,20));return ZC(i)?i(e,r):YC(i)?i.replace("{value}",r):r},t.prototype._showDataInfo=function(e){var t=(this.dataZoomModel.get("handleLabel")||{}).show||!1,n=this.dataZoomModel.getModel(["emphasis","handleLabel"]).get("show")||!1,i=e||this._dragging?n:t,a=this._displayables,r=a.handleLabels;r[0].attr("invisible",!i),r[1].attr("invisible",!i),a.moveHandle&&this.api[i?"enterEmphasis":"leaveEmphasis"](a.moveHandle,1)},t.prototype._onDragMove=function(e,t,n,i){this._dragging=!0,bD(i.event);var a=HO([t,n],this._displayables.sliderGroup.getLocalTransform(),!0),r=this._updateInterval(e,a[0]),s=this.dataZoomModel.get("realtime");this._updateView(!s),r&&s&&this._dispatchZoomAction(!0)},t.prototype._onDragEnd=function(){this._dragging=!1,this._showDataInfo(!1),!this.dataZoomModel.get("realtime")&&this._dispatchZoomAction(!1)},t.prototype._onClickPanel=function(e){var t=this._size,n=this._displayables.sliderGroup.transformCoordToLocal(e.offsetX,e.offsetY);if(!(n[0]<0||n[0]>t[0]||n[1]<0||n[1]>t[1])){var i=this._handleEnds,a=(i[0]+i[1])/2,r=this._updateInterval("all",n[0]-a);this._updateView(),r&&this._dispatchZoomAction(!1)}},t.prototype._onBrushStart=function(e){var t=e.offsetX,n=e.offsetY;this._brushStart=new PD(t,n),this._brushing=!0,this._brushStartTime=+new Date},t.prototype._onBrushEnd=function(e){if(this._brushing){var t=this._displayables.brushRect;if(this._brushing=!1,t){t.attr("ignore",!0);var n=t.shape;if(!(+new Date-this._brushStartTime<200&&Math.abs(n.width)<5)){var i=this._getViewExtent(),a=[0,100],r=this._handleEnds=[n.x,n.x+n.width],s=this.dataZoomModel.findRepresentativeAxisProxy().getMinMaxSpan();fX(0,r,i,0,null!=s.minSpan?eE(s.minSpan,a,i,!0):null,null!=s.maxSpan?eE(s.maxSpan,a,i,!0):null),this._range=aE([eE(r[0],i,a,!0),eE(r[1],i,a,!0)]),this._updateView(),this._dispatchZoomAction(!1)}}}},t.prototype._onBrush=function(e){this._brushing&&(bD(e.event),this._updateBrushRect(e.offsetX,e.offsetY))},t.prototype._updateBrushRect=function(e,t){var n=this._displayables,i=this.dataZoomModel,a=n.brushRect;a||(a=n.brushRect=new M2({silent:!0,style:i.getModel("brushStyle").getItemStyle()}),n.sliderGroup.add(a)),a.attr("ignore",!1);var r=this._brushStart,s=this._displayables.sliderGroup,o=s.transformCoordToLocal(e,t),l=s.transformCoordToLocal(r.x,r.y),c=this._size;o[0]=Math.max(Math.min(c[0],o[0]),0),a.setShape({x:l[0],y:0,width:o[0]-l[0],height:c[1]})},t.prototype._dispatchZoomAction=function(e){var t=this._range;this.api.dispatchAction({type:"dataZoom",from:this.uid,dataZoomId:this.dataZoomModel.id,animation:e?P2:null,start:t[0],end:t[1]})},t.prototype._findCoordRect=function(){var e,t=ZJ(this.dataZoomModel).infoList;if(!e&&t.length){var n=t[0].model.coordinateSystem;e=n.getRect&&n.getRect()}if(!e){var i=this.api.getWidth(),a=this.api.getHeight();e={x:.2*i,y:.2*a,width:.6*i,height:.6*a}}return e},t.type="dataZoom.slider",t}(t0);function $2(e){e.registerComponentModel(T2),e.registerComponentView(R2),l0(e)}var O2=function(e,t,n){var i=zC((L2[e]||{})[t]);return n&&KC(i)?i[i.length-1]:i},L2={color:{active:["#006edd","#e0ffff"],inactive:[uF.color.transparent]},colorHue:{active:[0,360],inactive:[0,0]},colorSaturation:{active:[.3,1],inactive:[0,0]},colorLightness:{active:[.9,.5],inactive:[0,0]},colorAlpha:{active:[.3,1],inactive:[0,0]},opacity:{active:[.3,1],inactive:[0,0]},symbol:{active:["circle","roundRect","diamond"],inactive:["none"]},symbolSize:{active:[10,50],inactive:[0,0]}},N2=VY.mapVisual,F2=VY.eachVisual,B2=KC,j2=jC,U2=aE,V2=eE,q2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.stateList=["inRange","outOfRange"],n.replacableOptionKeys=["inRange","outOfRange","target","controller","color"],n.layoutMode={type:"box",ignoreSize:!0},n.dataBound=[-1/0,1/0],n.targetVisuals={},n.controllerVisuals={},n}return uC(t,e),t.prototype.init=function(e,t,n){this.mergeDefaultAndTheme(e,n)},t.prototype.optionUpdated=function(e,t){var n=this.option;!t&&function(e,t,n){var i;jC(n,function(e){t.hasOwnProperty(e)&&k1(t[e])&&(i=!0)}),i&&jC(n,function(n){t.hasOwnProperty(n)&&k1(t[n])?e[n]=zC(t[n]):delete e[n]})}(n,e,this.replacableOptionKeys),this.textStyleModel=this.getModel("textStyle"),this.resetItemSize(),this.completeVisualOption()},t.prototype.resetVisual=function(e){var t=this.stateList;e=GC(e,this),this.controllerVisuals=S1(this.option.controller,t,e),this.targetVisuals=S1(this.option.target,t,e)},t.prototype.getItemSymbol=function(){return null},t.prototype.getTargetSeriesIndices=function(){var e=this.option.seriesId,t=this.option.seriesIndex;return null==t&&null==e&&(t="all"),UC(WE(this.ecModel,"series",{index:t,id:e},{useDefault:!1,enableAll:!0,enableNone:!1}).models,function(e){return e.componentIndex})},t.prototype.eachTargetSeries=function(e,t){jC(this.getTargetSeriesIndices(),function(n){var i=this.ecModel.getSeriesByIndex(n);i&&e.call(t,i)},this)},t.prototype.isTargetSeries=function(e){var t=!1;return this.eachTargetSeries(function(n){n===e&&(t=!0)}),t},t.prototype.formatValueText=function(e,t,n){var i,a=this.option,r=a.precision,s=this.dataBound,o=a.formatter;n=n||["<",">"],KC(e)&&(e=e.slice(),i=!0);var l=t?e:i?[c(e[0]),c(e[1])]:c(e);return YC(o)?o.replace("{value}",i?l[0]:l).replace("{value2}",i?l[1]:l):ZC(o)?i?o(e[0],e[1]):o(e):i?e[0]===s[0]?n[0]+" "+l[1]:e[1]===s[1]?n[1]+" "+l[0]:l[0]+" - "+l[1]:l;function c(e){return e===s[0]?"min":e===s[1]?"max":(+e).toFixed(Math.min(r,20))}},t.prototype.resetExtent=function(){var e=this.option,t=U2([e.min,e.max]);this._dataExtent=t},t.prototype.getDataDimensionIndex=function(e){var t=this.option.dimension;if(null!=t)return e.getDimensionIndex(t);for(var n=e.dimensions,i=n.length-1;i>=0;i--){var a=n[i],r=e.getDimensionInfo(a);if(!r.isCalculationCoord)return r.storeDimIndex}},t.prototype.getExtent=function(){return this._dataExtent.slice()},t.prototype.completeVisualOption=function(){var e=this.ecModel,t=this.option,n={inRange:t.inRange,outOfRange:t.outOfRange},i=t.target||(t.target={}),a=t.controller||(t.controller={});PC(i,n),PC(a,n);var r=this.isCategory();function s(n){B2(t.color)&&!n.inRange&&(n.inRange={color:t.color.slice().reverse()}),n.inRange=n.inRange||{color:e.get("gradientColor")}}s.call(this,i),s.call(this,a),function(e,t,n){var i=e[t],a=e[n];i&&!a&&(a=e[n]={},j2(i,function(e,t){if(VY.isValidType(t)){var n=O2(t,"inactive",r);null!=n&&(a[t]=n,"color"!==t||a.hasOwnProperty("opacity")||a.hasOwnProperty("colorAlpha")||(a.opacity=[0,0]))}}))}.call(this,i,"inRange","outOfRange"),function(e){var t=(e.inRange||{}).symbol||(e.outOfRange||{}).symbol,n=(e.inRange||{}).symbolSize||(e.outOfRange||{}).symbolSize,i=this.get("inactiveColor"),a=this.getItemSymbol()||"roundRect";j2(this.stateList,function(s){var o=this.itemSize,l=e[s];l||(l=e[s]={color:r?i:[i]}),null==l.symbol&&(l.symbol=t&&zC(t)||(r?a:[a])),null==l.symbolSize&&(l.symbolSize=n&&zC(n)||(r?o[0]:[o[0],o[0]])),l.symbol=N2(l.symbol,function(e){return"none"===e?a:e});var c=l.symbolSize;if(null!=c){var d=-1/0;F2(c,function(e){e>d&&(d=e)}),l.symbolSize=N2(c,function(e){return V2(e,[0,d],[0,o[0]],!0)})}},this)}.call(this,a)},t.prototype.resetItemSize=function(){this.itemSize=[parseFloat(this.get("itemWidth")),parseFloat(this.get("itemHeight"))]},t.prototype.isCategory=function(){return!!this.option.categories},t.prototype.setSelected=function(e){},t.prototype.getSelected=function(){return null},t.prototype.getValueState=function(e){return null},t.prototype.getVisualMeta=function(e){return null},t.type="visualMap",t.dependencies=["series"],t.defaultOption={show:!0,z:4,min:0,max:200,left:0,right:null,top:null,bottom:0,itemWidth:null,itemHeight:null,inverse:!1,orient:"vertical",backgroundColor:uF.color.transparent,borderColor:uF.color.borderTint,contentColor:uF.color.theme[0],inactiveColor:uF.color.disabled,borderWidth:0,padding:uF.size.m,textGap:10,precision:0,textStyle:{color:uF.color.secondary}},t}(dF),H2=[20,140],W2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.optionUpdated=function(t,n){e.prototype.optionUpdated.apply(this,arguments),this.resetExtent(),this.resetVisual(function(e){e.mappingMethod="linear",e.dataExtent=this.getExtent()}),this._resetRange()},t.prototype.resetItemSize=function(){e.prototype.resetItemSize.apply(this,arguments);var t=this.itemSize;(null==t[0]||isNaN(t[0]))&&(t[0]=H2[0]),(null==t[1]||isNaN(t[1]))&&(t[1]=H2[1])},t.prototype._resetRange=function(){var e=this.getExtent(),t=this.option.range;!t||t.auto?(e.auto=1,this.option.range=e):KC(t)&&(t[0]>t[1]&&t.reverse(),t[0]=Math.max(t[0],e[0]),t[1]=Math.min(t[1],e[1]))},t.prototype.completeVisualOption=function(){e.prototype.completeVisualOption.apply(this,arguments),jC(this.stateList,function(e){var t=this.option.controller[e].symbolSize;t&&t[0]!==t[1]&&(t[0]=t[1]/3)},this)},t.prototype.setSelected=function(e){this.option.range=e.slice(),this._resetRange()},t.prototype.getSelected=function(){var e=this.getExtent(),t=aE((this.get("range")||[]).slice());return t[0]>e[1]&&(t[0]=e[1]),t[1]>e[1]&&(t[1]=e[1]),t[0]<e[0]&&(t[0]=e[0]),t[1]<e[0]&&(t[1]=e[0]),t},t.prototype.getValueState=function(e){var t=this.option.range,n=this.getExtent(),i=cI(this.option.unboundedRange,!0);return(i&&t[0]<=n[0]||t[0]<=e)&&(i&&t[1]>=n[1]||e<=t[1])?"inRange":"outOfRange"},t.prototype.findTargetDataIndices=function(e){var t=[];return this.eachTargetSeries(function(n){var i=[],a=n.getData();a.each(this.getDataDimensionIndex(a),function(t,n){e[0]<=t&&t<=e[1]&&i.push(n)},this),t.push({seriesId:n.id,dataIndex:i})},this),t},t.prototype.getVisualMeta=function(e){var t=G2(this,"outOfRange",this.getExtent()),n=G2(this,"inRange",this.option.range.slice()),i=[];function a(t,n){i.push({value:t,color:e(t,n)})}for(var r=0,s=0,o=n.length,l=t.length;s<l&&(!n.length||t[s]<=n[0]);s++)t[s]<n[r]&&a(t[s],"outOfRange");for(var c=1;r<o;r++,c=0)c&&i.length&&a(n[r],"outOfRange"),a(n[r],"inRange");for(c=1;s<l;s++)(!n.length||n[n.length-1]<t[s])&&(c&&(i.length&&a(i[i.length-1].value,"outOfRange"),c=0),a(t[s],"outOfRange"));var d=i.length;return{stops:i,outerColors:[d?i[0].color:"transparent",d?i[d-1].color:"transparent"]}},t.type="visualMap.continuous",t.defaultOption=VL(q2.defaultOption,{align:"auto",calculable:!1,hoverLink:!0,realtime:!0,handleIcon:"path://M-11.39,9.77h0a3.5,3.5,0,0,1-3.5,3.5h-22a3.5,3.5,0,0,1-3.5-3.5h0a3.5,3.5,0,0,1,3.5-3.5h22A3.5,3.5,0,0,1-11.39,9.77Z",handleSize:"120%",handleStyle:{borderColor:uF.color.neutral00,borderWidth:1},indicatorIcon:"circle",indicatorSize:"50%",indicatorStyle:{borderColor:uF.color.neutral00,borderWidth:2,shadowBlur:2,shadowOffsetX:1,shadowOffsetY:1,shadowColor:uF.color.shadow}}),t}(q2);function G2(e,t,n){if(n[0]===n[1])return n.slice();for(var i=(n[1]-n[0])/200,a=n[0],r=[],s=0;s<=200&&a<n[1];s++)r.push(a),a+=i;return r.push(n[1]),r}var Q2=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n.autoPositionValues={left:1,right:1,top:1,bottom:1},n}return uC(t,e),t.prototype.init=function(e,t){this.ecModel=e,this.api=t},t.prototype.render=function(e,t,n,i){this.visualMapModel=e,!1!==e.get("show")?this.doRender(e,t,n,i):this.group.removeAll()},t.prototype.renderBackground=function(e){var t=this.visualMapModel,n=zN(t.get("padding")||0),i=e.getBoundingRect();e.add(new KP({z2:-1,silent:!0,shape:{x:i.x-n[3],y:i.y-n[0],width:i.width+n[3]+n[1],height:i.height+n[0]+n[2]},style:{fill:t.get("backgroundColor"),stroke:t.get("borderColor"),lineWidth:t.get("borderWidth")}}))},t.prototype.getControllerVisual=function(e,t,n){var i=(n=n||{}).forceState,a=this.visualMapModel,r={};if("color"===t){var s=a.get("contentColor");r.color=s}function o(e){return r[e]}function l(e,t){r[e]=t}var c=a.controllerVisuals[i||a.getValueState(e)];return jC(VY.prepareVisualTypes(c),function(i){var a=c[i];n.convertOpacityToAlpha&&"opacity"===i&&(i="colorAlpha",a=c.__alphaForOpacity),VY.dependsOn(i,t)&&a&&a.applyVisual(e,o,l)}),r[t]},t.prototype.positionGroup=function(e){var t=this.visualMapModel,n=aF(t,this.api).refContainer;rF(e,t.getBoxLayoutParams(),n)},t.prototype.doRender=function(e,t,n,i){},t.type="visualMap",t}(nU),K2=[["left","right","width"],["top","bottom","height"]];function Z2(e,t,n){var i=e.option,a=i.align;if(null!=a&&"auto"!==a)return a;for(var r={width:t.getWidth(),height:t.getHeight()},s="horizontal"===i.orient?1:0,o=K2[s],l=[0,null,10],c={},d=0;d<3;d++)c[K2[1-s][d]]=l[d],c[o[d]]=2===d?n[0]:i[o[d]];var u=[["x","width",3],["y","height",0]][s],h=nF(c,r,i.padding);return o[(h.margin[u[2]]||0)+h[u[0]]+.5*h[u[1]]<.5*r[u[1]]?0:1]}function Y2(e,t){return jC(e||[],function(e){null!=e.dataIndex&&(e.dataIndexInside=e.dataIndex,e.dataIndex=null),e.highlightKey="visualMap"+(t?t.componentIndex:"")}),e}var X2=eE,J2=jC,e4=Math.min,t4=Math.max,n4=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n._shapes={},n._dataInterval=[],n._handleEnds=[],n._hoverLinkDataIndices=[],n}return uC(t,e),t.prototype.init=function(t,n){e.prototype.init.call(this,t,n),this._hoverLinkFromSeriesMouseOver=GC(this._hoverLinkFromSeriesMouseOver,this),this._hideIndicator=GC(this._hideIndicator,this)},t.prototype.doRender=function(e,t,n,i){i&&"selectDataRange"===i.type&&i.from===this.uid||this._buildView()},t.prototype._buildView=function(){this.group.removeAll();var e=this.visualMapModel,t=this.group;this._orient=e.get("orient"),this._useHandle=e.get("calculable"),this._resetInterval(),this._renderBar(t);var n=e.get("text");this._renderEndsText(t,n,0),this._renderEndsText(t,n,1),this._updateView(!0),this.renderBackground(t),this._updateView(),this._enableHoverLinkToSeries(),this._enableHoverLinkFromSeries(),this.positionGroup(t)},t.prototype._renderEndsText=function(e,t,n){if(t){var i=t[1-n];i=null!=i?i+"":"";var a=this.visualMapModel,r=a.get("textGap"),s=a.itemSize,o=this._shapes.mainGroup,l=this._applyTransform([s[0]/2,0===n?-r:s[1]+r],o),c=this._applyTransform(0===n?"bottom":"top",o),d=this._orient,u=this.visualMapModel.textStyleModel;this.group.add(new JP({style:bL(u,{x:l[0],y:l[1],verticalAlign:u.get("verticalAlign")||("horizontal"===d?"middle":c),align:u.get("align")||("horizontal"===d?c:"center"),text:i})}))}},t.prototype._renderBar=function(e){var t=this.visualMapModel,n=this._shapes,i=t.itemSize,a=this._orient,r=this._useHandle,s=Z2(t,this.api,i),o=n.mainGroup=this._createBarGroup(s),l=new jA;o.add(l),l.add(n.outOfRange=i4()),l.add(n.inRange=i4(null,r?r4(this._orient):null,GC(this._dragHandle,this,"all",!1),GC(this._dragHandle,this,"all",!0))),l.setClipPath(new KP({shape:{x:0,y:0,width:i[0],height:i[1],r:3}}));var c=t.textStyleModel.getTextRect("国"),d=t4(c.width,c.height);r&&(n.handleThumbs=[],n.handleLabels=[],n.handleLabelPoints=[],this._createHandle(t,o,0,i,d,a),this._createHandle(t,o,1,i,d,a)),this._createIndicator(t,o,i,d,a),e.add(o)},t.prototype._createHandle=function(e,t,n,i,a,r){var s=GC(this._dragHandle,this,n,!1),o=GC(this._dragHandle,this,n,!0),l=TA(e.get("handleSize"),i[0]),c=vV(e.get("handleIcon"),-l/2,-l/2,l,l,null,!0),d=r4(this._orient);c.attr({cursor:d,draggable:!0,drift:s,ondragend:o,onmousemove:function(e){bD(e.event)}}),c.x=i[0]/2,c.useStyle(e.getModel("handleStyle").getItemStyle()),c.setStyle({strokeNoScale:!0,strokeFirst:!0}),c.style.lineWidth*=2,c.ensureState("emphasis").style=e.getModel(["emphasis","handleStyle"]).getItemStyle(),i$(c,!0),t.add(c);var u=this.visualMapModel.textStyleModel,h=new JP({cursor:d,draggable:!0,drift:s,onmousemove:function(e){bD(e.event)},ondragend:o,style:bL(u,{x:0,y:0,text:""})});h.ensureState("blur").style={opacity:.1},h.stateTransition={duration:200},this.group.add(h);var p=[l,0],g=this._shapes;g.handleThumbs[n]=c,g.handleLabelPoints[n]=p,g.handleLabels[n]=h},t.prototype._createIndicator=function(e,t,n,i,a){var r=TA(e.get("indicatorSize"),n[0]),s=vV(e.get("indicatorIcon"),-r/2,-r/2,r,r,null,!0);s.attr({cursor:"move",invisible:!0,silent:!0,x:n[0]/2});var o=e.getModel("indicatorStyle").getItemStyle();if(s instanceof UP){var l=s.style;s.useStyle(RC({image:l.image,x:l.x,y:l.y,width:l.width,height:l.height},o))}else s.useStyle(o);t.add(s);var c=this.visualMapModel.textStyleModel,d=new JP({silent:!0,invisible:!0,style:bL(c,{x:0,y:0,text:""})});this.group.add(d);var u=[("horizontal"===a?i/2:6)+n[0]/2,0],h=this._shapes;h.indicator=s,h.indicatorLabel=d,h.indicatorLabelPoint=u,this._firstShowIndicator=!0},t.prototype._dragHandle=function(e,t,n,i){if(this._useHandle){if(this._dragging=!t,!t){var a=this._applyTransform([n,i],this._shapes.mainGroup,!0);this._updateInterval(e,a[1]),this._hideIndicator(),this._updateView()}t===!this.visualMapModel.get("realtime")&&this.api.dispatchAction({type:"selectDataRange",from:this.uid,visualMapId:this.visualMapModel.id,selected:this._dataInterval.slice()}),t?!this._hovering&&this._clearHoverLinkToSeries():a4(this.visualMapModel)&&this._doHoverLinkToSeries(this._handleEnds[e],!1)}},t.prototype._resetInterval=function(){var e=this.visualMapModel,t=this._dataInterval=e.getSelected(),n=e.getExtent(),i=[0,e.itemSize[1]];this._handleEnds=[X2(t[0],n,i,!0),X2(t[1],n,i,!0)]},t.prototype._updateInterval=function(e,t){t=t||0;var n=this.visualMapModel,i=this._handleEnds,a=[0,n.itemSize[1]];fX(t,i,a,e,0);var r=n.getExtent();this._dataInterval=[X2(i[0],a,r,!0),X2(i[1],a,r,!0)]},t.prototype._updateView=function(e){var t=this.visualMapModel,n=t.getExtent(),i=this._shapes,a=[0,t.itemSize[1]],r=e?a:this._handleEnds,s=this._createBarVisual(this._dataInterval,n,r,"inRange"),o=this._createBarVisual(n,n,a,"outOfRange");i.inRange.setStyle({fill:s.barColor}).setShape("points",s.barPoints),i.outOfRange.setStyle({fill:o.barColor}).setShape("points",o.barPoints),this._updateHandle(r,s)},t.prototype._createBarVisual=function(e,t,n,i){var a={forceState:i,convertOpacityToAlpha:!0},r=this._makeColorGradient(e,a),s=[this.getControllerVisual(e[0],"symbolSize",a),this.getControllerVisual(e[1],"symbolSize",a)],o=this._createBarPoints(n,s);return{barColor:new oO(0,0,0,1,r),barPoints:o,handlesColor:[r[0].color,r[r.length-1].color]}},t.prototype._makeColorGradient=function(e,t){var n=[],i=(e[1]-e[0])/100;n.push({color:this.getControllerVisual(e[0],"color",t),offset:0});for(var a=1;a<100;a++){var r=e[0]+i*a;if(r>e[1])break;n.push({color:this.getControllerVisual(r,"color",t),offset:a/100})}return n.push({color:this.getControllerVisual(e[1],"color",t),offset:1}),n},t.prototype._createBarPoints=function(e,t){var n=this.visualMapModel.itemSize;return[[n[0]-t[0],e[0]],[n[0],e[0]],[n[0],e[1]],[n[0]-t[1],e[1]]]},t.prototype._createBarGroup=function(e){var t=this._orient,n=this.visualMapModel.get("inverse");return new jA("horizontal"!==t||n?"horizontal"===t&&n?{scaleX:"bottom"===e?-1:1,rotation:-Math.PI/2}:"vertical"!==t||n?{scaleX:"left"===e?1:-1}:{scaleX:"left"===e?1:-1,scaleY:-1}:{scaleX:"bottom"===e?1:-1,rotation:Math.PI/2})},t.prototype._updateHandle=function(e,t){if(this._useHandle){var n=this._shapes,i=this.visualMapModel,a=n.handleThumbs,r=n.handleLabels,s=i.itemSize,o=i.getExtent(),l=this._applyTransform("left",n.mainGroup);J2([0,1],function(c){var d=a[c];d.setStyle("fill",t.handlesColor[c]),d.y=e[c];var u=X2(e[c],[0,s[1]],o,!0),h=this.getControllerVisual(u,"symbolSize");d.scaleX=d.scaleY=h/s[0],d.x=s[0]-h/2;var p=HO(n.handleLabelPoints[c],qO(d,this.group));if("horizontal"===this._orient){var g="left"===l||"top"===l?(s[0]-h)/2:(s[0]-h)/-2;p[1]+=g}r[c].setStyle({x:p[0],y:p[1],text:i.formatValueText(this._dataInterval[c]),verticalAlign:"middle",align:"vertical"===this._orient?this._applyTransform("left",n.mainGroup):"center"})},this)}},t.prototype._showIndicator=function(e,t,n,i){var a=this.visualMapModel,r=a.getExtent(),s=a.itemSize,o=[0,s[1]],l=this._shapes,c=l.indicator;if(c){c.attr("invisible",!1);var d=this.getControllerVisual(e,"color",{convertOpacityToAlpha:!0}),u=this.getControllerVisual(e,"symbolSize"),h=X2(e,r,o,!0),p=s[0]-u/2,g={x:c.x,y:c.y};c.y=h,c.x=p;var v=HO(l.indicatorLabelPoint,qO(c,this.group)),f=l.indicatorLabel;f.attr("invisible",!1);var m=this._applyTransform("left",l.mainGroup),y="horizontal"===this._orient;f.setStyle({text:(n||"")+a.formatValueText(t),verticalAlign:y?m:"middle",align:y?"center":m});var b={x:p,y:h,style:{fill:d}},w={style:{x:v[0],y:v[1]}};if(a.ecModel.isAnimationEnabled()&&!this._firstShowIndicator){var k={duration:100,easing:"cubicInOut",additive:!0};c.x=g.x,c.y=g.y,c.animateTo(b,k),f.animateTo(w,k)}else c.attr(b),f.attr(w);this._firstShowIndicator=!1;var S=this._shapes.handleLabels;if(S)for(var x=0;x<S.length;x++)this.api.enterBlur(S[x])}},t.prototype._enableHoverLinkToSeries=function(){var e=this;this._shapes.mainGroup.on("mousemove",function(t){if(e._hovering=!0,!e._dragging){var n=e.visualMapModel.itemSize,i=e._applyTransform([t.offsetX,t.offsetY],e._shapes.mainGroup,!0,!0);i[1]=e4(t4(0,i[1]),n[1]),e._doHoverLinkToSeries(i[1],0<=i[0]&&i[0]<=n[0])}}).on("mouseout",function(){e._hovering=!1,!e._dragging&&e._clearHoverLinkToSeries()})},t.prototype._enableHoverLinkFromSeries=function(){var e=this.api.getZr();this.visualMapModel.option.hoverLink?(e.on("mouseover",this._hoverLinkFromSeriesMouseOver,this),e.on("mouseout",this._hideIndicator,this)):this._clearHoverLinkFromSeries()},t.prototype._doHoverLinkToSeries=function(e,t){var n=this.visualMapModel,i=n.itemSize;if(n.option.hoverLink){var a=[0,i[1]],r=n.getExtent();e=e4(t4(a[0],e),a[1]);var s=function(e,t,n){var i=6,a=e.get("hoverLinkDataSize");a&&(i=X2(a,t,n,!0)/2);return i}(n,r,a),o=[e-s,e+s],l=X2(e,a,r,!0),c=[X2(o[0],a,r,!0),X2(o[1],a,r,!0)];o[0]<a[0]&&(c[0]=-1/0),o[1]>a[1]&&(c[1]=1/0),t&&(c[0]===-1/0?this._showIndicator(l,c[1],"< ",s):c[1]===1/0?this._showIndicator(l,c[0],"> ",s):this._showIndicator(l,l,"≈ ",s));var d=this._hoverLinkDataIndices,u=[];(t||a4(n))&&(u=this._hoverLinkDataIndices=n.findTargetDataIndices(c));var h=function(e,t){var n={},i={};return a(e||[],n),a(t||[],i,n),[r(n),r(i)];function a(e,t,n){for(var i=0,a=e.length;i<a;i++){var r=OE(e[i].seriesId,null);if(null==r)return;for(var s=TE(e[i].dataIndex),o=n&&n[r],l=0,c=s.length;l<c;l++){var d=s[l];o&&o[d]?o[d]=null:(t[r]||(t[r]={}))[d]=1}}}function r(e,t){var n=[];for(var i in e)if(e.hasOwnProperty(i)&&null!=e[i])if(t)n.push(+i);else{var a=r(e[i],!0);a.length&&n.push({seriesId:i,dataIndex:a})}return n}}(d,u);this._dispatchHighDown("downplay",Y2(h[0],n)),this._dispatchHighDown("highlight",Y2(h[1],n))}},t.prototype._hoverLinkFromSeriesMouseOver=function(e){var t;if(iV(e.target,function(e){var n=uR(e);if(null!=n.dataIndex)return t=n,!0},!0),t){var n=this.ecModel.getSeriesByIndex(t.seriesIndex),i=this.visualMapModel;if(i.isTargetSeries(n)){var a=n.getData(t.dataType),r=a.getStore().get(i.getDataDimensionIndex(a),t.dataIndex);isNaN(r)||this._showIndicator(r,r)}}},t.prototype._hideIndicator=function(){var e=this._shapes;e.indicator&&e.indicator.attr("invisible",!0),e.indicatorLabel&&e.indicatorLabel.attr("invisible",!0);var t=this._shapes.handleLabels;if(t)for(var n=0;n<t.length;n++)this.api.leaveBlur(t[n])},t.prototype._clearHoverLinkToSeries=function(){this._hideIndicator();var e=this._hoverLinkDataIndices;this._dispatchHighDown("downplay",Y2(e,this.visualMapModel)),e.length=0},t.prototype._clearHoverLinkFromSeries=function(){this._hideIndicator();var e=this.api.getZr();e.off("mouseover",this._hoverLinkFromSeriesMouseOver),e.off("mouseout",this._hideIndicator)},t.prototype._applyTransform=function(e,t,n,i){var a=qO(t,i?null:this.group);return KC(e)?HO(e,a,n):WO(e,a,n)},t.prototype._dispatchHighDown=function(e,t){t&&t.length&&this.api.dispatchAction({type:e,batch:t})},t.prototype.dispose=function(){this._clearHoverLinkFromSeries(),this._clearHoverLinkToSeries()},t.type="visualMap.continuous",t}(Q2);function i4(e,t,n,i){return new G$({shape:{points:e},draggable:!!n,cursor:t,drift:n,onmousemove:function(e){bD(e.event)},ondragend:i})}function a4(e){var t=e.get("hoverLinkOnHandle");return!!(null==t?e.get("realtime"):t)}function r4(e){return"vertical"===e?"ns-resize":"ew-resize"}var s4={type:"selectDataRange",event:"dataRangeSelected",update:"update"},o4=function(e,t){t.eachComponent({mainType:"visualMap",query:e},function(t){t.setSelected(e.selected)})},l4=[{createOnAllSeries:!0,reset:function(e,t){var n=[];return t.eachComponent("visualMap",function(t){var i,a,r,s,o,l=e.pipelineContext;!t.isTargetSeries(e)||l&&l.large||n.push((i=t.stateList,a=t.targetVisuals,r=GC(t.getValueState,t),s=t.getDataDimensionIndex(e.getData()),o={},jC(i,function(e){var t=VY.prepareVisualTypes(a[e]);o[e]=t}),{progress:function(e,t){var n,i;function l(e){return eV(t,i,e)}function c(e,n){!function(e,t,n,i){switch(n){case"color":e.ensureUniqueItemVisual(t,"style")[e.getVisual("drawType")]=i,e.setItemVisual(t,"colorFromPalette",!1);break;case"opacity":e.ensureUniqueItemVisual(t,"style").opacity=i;break;case"symbol":case"symbolSize":case"liftZ":e.setItemVisual(t,n,i)}}(t,i,e,n)}null!=s&&(n=t.getDimensionIndex(s));for(var d=t.getStore();null!=(i=e.next());){var u=t.getRawDataItem(i);if(!u||!1!==u.visualMap)for(var h=null!=s?d.get(n,i):i,p=r(h),g=a[p],v=o[p],f=0,m=v.length;f<m;f++){var y=v[f];g[y]&&g[y].applyVisual(h,l,c)}}}}))}),n}},{createOnAllSeries:!0,reset:function(e,t){var n=e.getData(),i=[];t.eachComponent("visualMap",function(t){if(t.isTargetSeries(e)){var a=t.getVisualMeta(GC(c4,null,e,t))||{stops:[],outerColors:[]},r=t.getDataDimensionIndex(n);r>=0&&(a.dimension=r,i.push(a))}}),e.getData().setVisual("visualMeta",i)}}];function c4(e,t,n,i){for(var a=t.targetVisuals[i],r=VY.prepareVisualTypes(a),s={color:tV(e.getData(),"color")},o=0,l=r.length;o<l;o++){var c=r[o],d=a["opacity"===c?"__alphaForOpacity":c];d&&d.applyVisual(n,u,h)}return s.color;function u(e){return s[e]}function h(e,t){s[e]=t}}var d4=jC;function u4(e){var t=e&&e.visualMap;KC(t)||(t=t?[t]:[]),d4(t,function(e){if(e){h4(e,"splitList")&&!h4(e,"pieces")&&(e.pieces=e.splitList,delete e.splitList);var t=e.pieces;t&&KC(t)&&d4(t,function(e){eI(e)&&(h4(e,"start")&&!h4(e,"min")&&(e.min=e.start),h4(e,"end")&&!h4(e,"max")&&(e.max=e.end))})}})}function h4(e,t){return e&&e.hasOwnProperty&&e.hasOwnProperty(t)}var p4=!1;function g4(e){p4||(p4=!0,e.registerSubTypeDefaulter("visualMap",function(e){return e.categories||(e.pieces?e.pieces.length>0:e.splitNumber>0)&&!e.calculable?"piecewise":"continuous"}),e.registerAction(s4,o4),jC(l4,function(t){e.registerVisual(e.PRIORITY.VISUAL.COMPONENT,t)}),e.registerPreprocessor(u4))}function v4(e){e.registerComponentModel(W2),e.registerComponentView(n4),g4(e)}var f4=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n._pieceList=[],n}return uC(t,e),t.prototype.optionUpdated=function(t,n){e.prototype.optionUpdated.apply(this,arguments),this.resetExtent();var i=this._mode=this._determineMode();this._pieceList=[],m4[this._mode].call(this,this._pieceList),this._resetSelected(t,n);var a=this.option.categories;this.resetVisual(function(e,t){"categories"===i?(e.mappingMethod="category",e.categories=zC(a)):(e.dataExtent=this.getExtent(),e.mappingMethod="piecewise",e.pieceList=UC(this._pieceList,function(e){return e=zC(e),"inRange"!==t&&(e.visual=null),e}))})},t.prototype.completeVisualOption=function(){var t=this.option,n={},i=VY.listVisualTypes(),a=this.isCategory();function r(e,t,n){return e&&e[t]&&e[t].hasOwnProperty(n)}jC(t.pieces,function(e){jC(i,function(t){e.hasOwnProperty(t)&&(n[t]=1)})}),jC(n,function(e,n){var i=!1;jC(this.stateList,function(e){i=i||r(t,e,n)||r(t.target,e,n)},this),!i&&jC(this.stateList,function(e){(t[e]||(t[e]={}))[n]=O2(n,"inRange"===e?"active":"inactive",a)})},this),e.prototype.completeVisualOption.apply(this,arguments)},t.prototype._resetSelected=function(e,t){var n=this.option,i=this._pieceList,a=(t?n:e).selected||{};if(n.selected=a,jC(i,function(e,t){var n=this.getSelectedMapKey(e);a.hasOwnProperty(n)||(a[n]=!0)},this),"single"===n.selectedMode){var r=!1;jC(i,function(e,t){var n=this.getSelectedMapKey(e);a[n]&&(r?a[n]=!1:r=!0)},this)}},t.prototype.getItemSymbol=function(){return this.get("itemSymbol")},t.prototype.getSelectedMapKey=function(e){return"categories"===this._mode?e.value+"":e.index+""},t.prototype.getPieceList=function(){return this._pieceList},t.prototype._determineMode=function(){var e=this.option;return e.pieces&&e.pieces.length>0?"pieces":this.option.categories?"categories":"splitNumber"},t.prototype.setSelected=function(e){this.option.selected=zC(e)},t.prototype.getValueState=function(e){var t=VY.findPieceIndex(e,this._pieceList);return null!=t&&this.option.selected[this.getSelectedMapKey(this._pieceList[t])]?"inRange":"outOfRange"},t.prototype.findTargetDataIndices=function(e){var t=[],n=this._pieceList;return this.eachTargetSeries(function(i){var a=[],r=i.getData();r.each(this.getDataDimensionIndex(r),function(t,i){VY.findPieceIndex(t,n)===e&&a.push(i)},this),t.push({seriesId:i.id,dataIndex:a})},this),t},t.prototype.getRepresentValue=function(e){var t;if(this.isCategory())t=e.value;else if(null!=e.value)t=e.value;else{var n=e.interval||[];t=n[0]===-1/0&&n[1]===1/0?0:(n[0]+n[1])/2}return t},t.prototype.getVisualMeta=function(e){if(!this.isCategory()){var t=[],n=["",""],i=this,a=this._pieceList.slice();if(a.length){var r=a[0].interval[0];r!==-1/0&&a.unshift({interval:[-1/0,r]}),(r=a[a.length-1].interval[1])!==1/0&&a.push({interval:[r,1/0]})}else a.push({interval:[-1/0,1/0]});var s=-1/0;return jC(a,function(e){var t=e.interval;t&&(t[0]>s&&o([s,t[0]],"outOfRange"),o(t.slice()),s=t[1])},this),{stops:t,outerColors:n}}function o(a,r){var s=i.getRepresentValue({interval:a});r||(r=i.getValueState(s));var o=e(s,r);a[0]===-1/0?n[0]=o:a[1]===1/0?n[1]=o:t.push({value:a[0],color:o},{value:a[1],color:o})}},t.type="visualMap.piecewise",t.defaultOption=VL(q2.defaultOption,{selected:null,minOpen:!1,maxOpen:!1,align:"auto",itemWidth:20,itemHeight:14,itemSymbol:"roundRect",pieces:null,categories:null,splitNumber:5,selectedMode:"multiple",itemGap:10,hoverLink:!0}),t}(q2),m4={splitNumber:function(e){var t=this.option,n=Math.min(t.precision,20),i=this.getExtent(),a=t.splitNumber;a=Math.max(parseInt(a,10),1),t.splitNumber=a;for(var r=(i[1]-i[0])/a;+r.toFixed(n)!==r&&n<5;)n++;t.precision=n,r=+r.toFixed(n),t.minOpen&&e.push({interval:[-1/0,i[0]],close:[0,0]});for(var s=0,o=i[0];s<a;o+=r,s++){var l=s===a-1?i[1]:o+r;e.push({interval:[o,l],close:[1,1]})}t.maxOpen&&e.push({interval:[i[1],1/0],close:[0,0]}),mE(e),jC(e,function(e,t){e.index=t,e.text=this.formatValueText(e.interval)},this)},categories:function(e){var t=this.option;jC(t.categories,function(t){e.push({text:this.formatValueText(t,!0),value:t})},this),y4(t,e)},pieces:function(e){var t=this.option;jC(t.pieces,function(t,n){eI(t)||(t={value:t});var i={text:"",index:n};if(null!=t.label&&(i.text=t.label),t.hasOwnProperty("value")){var a=i.value=t.value;i.interval=[a,a],i.close=[1,1]}else{for(var r=i.interval=[],s=i.close=[0,0],o=[1,0,1],l=[-1/0,1/0],c=[],d=0;d<2;d++){for(var u=[["gte","gt","min"],["lte","lt","max"]][d],h=0;h<3&&null==r[d];h++)r[d]=t[u[h]],s[d]=o[h],c[d]=2===h;null==r[d]&&(r[d]=l[d])}c[0]&&r[1]===1/0&&(s[0]=0),c[1]&&r[0]===-1/0&&(s[1]=0),r[0]===r[1]&&s[0]&&s[1]&&(i.value=r[0])}i.visual=VY.retrieveVisuals(t),e.push(i)},this),y4(t,e),mE(e),jC(e,function(e){var t=e.close,n=[["<","≤"][t[1]],[">","≥"][t[0]]];e.text=e.text||this.formatValueText(null!=e.value?e.value:e.interval,!1,n)},this)}};function y4(e,t){var n=e.inverse;("vertical"===e.orient?!n:n)&&t.reverse()}var b4=function(e){function t(){var n=null!==e&&e.apply(this,arguments)||this;return n.type=t.type,n}return uC(t,e),t.prototype.doRender=function(){var e=this.group;e.removeAll();var t=this.visualMapModel,n=t.get("textGap"),i=t.textStyleModel,a=this._getItemAlign(),r=t.itemSize,s=this._getViewData(),o=s.endsText,l=lI(t.get("showLabel",!0),!o),c=!t.get("selectedMode");o&&this._renderEndsText(e,o[0],r,l,a),jC(s.viewPieceList,function(s){var o=s.piece,d=new jA;d.onclick=GC(this._onItemClick,this,o),this._enableHoverLink(d,s.indexInModelPieceList);var u=t.getRepresentValue(o);if(this._createItemSymbol(d,u,[0,0,r[0],r[1]],c),l){var h=this.visualMapModel.getValueState(u),p=i.get("align")||a;d.add(new JP({style:bL(i,{x:"right"===p?-n:r[0]+n,y:r[1]/2,text:o.text,verticalAlign:i.get("verticalAlign")||"middle",align:p,opacity:cI(i.get("opacity"),"outOfRange"===h?.5:1)}),silent:c}))}e.add(d)},this),o&&this._renderEndsText(e,o[1],r,l,a),eF(t.get("orient"),e,t.get("itemGap")),this.renderBackground(e),this.positionGroup(e)},t.prototype._enableHoverLink=function(e,t){var n=this;e.on("mouseover",function(){return i("highlight")}).on("mouseout",function(){return i("downplay")});var i=function(e){var i=n.visualMapModel;i.option.hoverLink&&n.api.dispatchAction({type:e,batch:Y2(i.findTargetDataIndices(t),i)})}},t.prototype._getItemAlign=function(){var e=this.visualMapModel,t=e.option;if("vertical"===t.orient)return Z2(e,this.api,e.itemSize);var n=t.align;return n&&"auto"!==n||(n="left"),n},t.prototype._renderEndsText=function(e,t,n,i,a){if(t){var r=new jA,s=this.visualMapModel.textStyleModel;r.add(new JP({style:bL(s,{x:i?"right"===a?n[0]:0:n[0]/2,y:n[1]/2,verticalAlign:"middle",align:i?a:"center",text:t})})),e.add(r)}},t.prototype._getViewData=function(){var e=this.visualMapModel,t=UC(e.getPieceList(),function(e,t){return{piece:e,indexInModelPieceList:t}}),n=e.get("text"),i=e.get("orient"),a=e.get("inverse");return("horizontal"===i?a:!a)?t.reverse():n&&(n=n.slice().reverse()),{viewPieceList:t,endsText:n}},t.prototype._createItemSymbol=function(e,t,n,i){var a=vV(this.getControllerVisual(t,"symbol"),n[0],n[1],n[2],n[3],this.getControllerVisual(t,"color"));a.silent=i,e.add(a)},t.prototype._onItemClick=function(e){var t=this.visualMapModel,n=t.option,i=n.selectedMode;if(i){var a=zC(n.selected),r=t.getSelectedMapKey(e);"single"===i||!0===i?(a[r]=!0,jC(a,function(e,t){a[t]=t===r})):a[r]=!a[r],this.api.dispatchAction({type:"selectDataRange",from:this.uid,visualMapId:this.visualMapModel.id,selected:a})}},t.type="visualMap.piecewise",t}(Q2);function w4(e){e.registerComponentModel(f4),e.registerComponentView(b4),g4(e)}var k4={value:"eq","<":"lt","<=":"lte",">":"gt",">=":"gte","=":"eq","!=":"ne","<>":"ne"},S4=function(){function e(e){if(null==(this._condVal=YC(e)?new RegExp(e):sI(e)?e:null)){_E("")}}return e.prototype.evaluate=function(e){var t=typeof e;return YC(t)?this._condVal.test(e):!!JC(t)&&this._condVal.test(e+"")},e}(),x4=function(){function e(){}return e.prototype.evaluate=function(){return this.value},e}(),_4=function(){function e(){}return e.prototype.evaluate=function(){for(var e=this.children,t=0;t<e.length;t++)if(!e[t].evaluate())return!1;return!0},e}(),C4=function(){function e(){}return e.prototype.evaluate=function(){for(var e=this.children,t=0;t<e.length;t++)if(e[t].evaluate())return!0;return!1},e}(),I4=function(){function e(){}return e.prototype.evaluate=function(){return!this.child.evaluate()},e}(),D4=function(){function e(){}return e.prototype.evaluate=function(){for(var e=!!this.valueParser,t=(0,this.getValue)(this.valueGetterParam),n=e?this.valueParser(t):null,i=0;i<this.subCondList.length;i++)if(!this.subCondList[i].evaluate(e?n:t))return!1;return!0},e}();function T4(e,t){if(!0===e||!1===e){var n=new x4;return n.value=e,n}return A4(e)||_E(""),e.and?M4("and",e,t):e.or?M4("or",e,t):e.not?function(e,t){var n=e.not,i="";A4(n)||_E(i);var a=new I4;a.child=T4(n,t),a.child||_E(i);return a}(e,t):function(e,t){for(var n="",i=t.prepareGetValue(e),a=[],r=WC(e),s=e.parser,o=s?tj(s):null,l=0;l<r.length;l++){var c=r[l];if("parser"!==c&&!t.valueGetterAttrMap.get(c)){var d=CI(k4,c)?k4[c]:c,u=e[c],h=o?o(u):u,p=sj(d,h)||"reg"===d&&new S4(h);p||_E(n),a.push(p)}}a.length||_E(n);var g=new D4;return g.valueGetterParam=i,g.valueParser=o,g.getValue=t.getValue,g.subCondList=a,g}(e,t)}function M4(e,t,n){var i=t[e];KC(i)||_E(""),i.length||_E("");var a="and"===e?new _4:new C4;return a.children=UC(i,function(e){return T4(e,n)}),a.children.length||_E(""),a}function A4(e){return eI(e)&&!BC(e)}var E4=function(){function e(e,t){this._cond=T4(e,t)}return e.prototype.evaluate=function(){return this._cond.evaluate()},e}();var z4={type:"echarts:filter",transform:function(e){for(var t,n,i,a=e.upstream,r=(n=e.config,i={valueGetterAttrMap:kI({dimension:!0}),prepareGetValue:function(e){var t=e.dimension;CI(e,"dimension")||_E("");var n=a.getDimensionInfo(t);return n||_E(""),{dimIdx:n.index}},getValue:function(e){return a.retrieveValueFromItem(t,e.dimIdx)}},new E4(n,i)),s=[],o=0,l=a.count();o<l;o++)t=a.getRawDataItem(o),r.evaluate()&&s.push(t);return{data:s}}},P4={type:"echarts:sort",transform:function(e){var t=e.upstream,n=e.config,i="",a=TE(n);a.length||_E(i);var r=[];jC(a,function(e){var n=e.dimension,a=e.order,s=e.parser,o=e.incomparable;if(null==n&&_E(i),"asc"!==a&&"desc"!==a&&_E(i),o&&"min"!==o&&"max"!==o){_E("")}if("asc"!==a&&"desc"!==a){_E("")}var l=t.getDimensionInfo(n);l||_E(i);var c=s?tj(s):null;s&&!c&&_E(i),r.push({dimIdx:l.index,parser:c,comparator:new aj(a,o)})});var s=t.sourceFormat;s!==SF&&s!==xF&&_E(i);for(var o=[],l=0,c=t.count();l<c;l++)o.push(t.getRawDataItem(l));return o.sort(function(e,n){for(var i=0;i<r.length;i++){var a=r[i],s=t.retrieveValueFromItem(e,a.dimIdx),o=t.retrieveValueFromItem(n,a.dimIdx);a.parser&&(s=a.parser(s),o=a.parser(o));var l=a.comparator.evaluate(s,o);if(0!==l)return l}return 0}),{data:o}}};function R4(e){e.registerTransform(z4),e.registerTransform(P4)}function $4(e,t,n){var i=fC.createCanvas(),a=t.getWidth(),r=t.getHeight(),s=i.style;return s&&(s.position="absolute",s.left="0",s.top="0",s.width=a+"px",s.height=r+"px",i.setAttribute("data-zr-dom-id",e)),i.width=a*n,i.height=r*n,i}var O4=function(e){function t(t,n,i){var a,r=e.call(this)||this;r.motionBlur=!1,r.lastFrameAlpha=.7,r.dpr=1,r.virtual=!1,r.config={},r.incremental=!1,r.zlevel=0,r.maxRepaintRectCount=5,r.__dirty=!0,r.__firstTimePaint=!0,r.__used=!1,r.__drawIndex=0,r.__startIndex=0,r.__endIndex=0,r.__prevStartIndex=null,r.__prevEndIndex=null,i=i||aA,"string"==typeof t?a=$4(t,n,i):eI(t)&&(t=(a=t).id),r.id=t,r.dom=a;var s=a.style;return s&&(_I(a),a.onselectstart=function(){return!1},s.padding="0",s.margin="0",s.borderWidth="0"),r.painter=n,r.dpr=i,r}return EI(t,e),t.prototype.getElementCount=function(){return this.__endIndex-this.__startIndex},t.prototype.afterBrush=function(){this.__prevStartIndex=this.__startIndex,this.__prevEndIndex=this.__endIndex},t.prototype.initContext=function(){this.ctx=this.dom.getContext("2d"),this.ctx.dpr=this.dpr},t.prototype.setUnpainted=function(){this.__firstTimePaint=!0},t.prototype.createBackBuffer=function(){var e=this.dpr;this.domBack=$4("back-"+this.id,this.painter,e),this.ctxBack=this.domBack.getContext("2d"),1!==e&&this.ctxBack.scale(e,e)},t.prototype.createRepaintRects=function(e,t,n,i){if(this.__firstTimePaint)return this.__firstTimePaint=!1,null;var a,r=[],s=this.maxRepaintRectCount,o=!1,l=new GD(0,0,0,0);function c(e){if(e.isFinite()&&!e.isZero())if(0===r.length){(t=new GD(0,0,0,0)).copy(e),r.push(t)}else{for(var t,n=!1,i=1/0,a=0,c=0;c<r.length;++c){var d=r[c];if(d.intersect(e)){var u=new GD(0,0,0,0);u.copy(d),u.union(e),r[c]=u,n=!0;break}if(o){l.copy(e),l.union(d);var h=e.width*e.height,p=d.width*d.height,g=l.width*l.height-h-p;g<i&&(i=g,a=c)}}if(o&&(r[a].union(e),n=!0),!n)(t=new GD(0,0,0,0)).copy(e),r.push(t);o||(o=r.length>=s)}}for(var d=this.__startIndex;d<this.__endIndex;++d){if(p=e[d]){var u=p.shouldBePainted(n,i,!0,!0);(g=p.__isRendered&&(1&p.__dirty||!u)?p.getPrevPaintRect():null)&&c(g);var h=u&&(1&p.__dirty||!p.__isRendered)?p.getPaintRect():null;h&&c(h)}}for(d=this.__prevStartIndex;d<this.__prevEndIndex;++d){var p,g;u=(p=t[d])&&p.shouldBePainted(n,i,!0,!0);if(p&&(!u||!p.__zr)&&p.__isRendered)(g=p.getPrevPaintRect())&&c(g)}do{a=!1;for(d=0;d<r.length;)if(r[d].isZero())r.splice(d,1);else{for(var v=d+1;v<r.length;)r[d].intersect(r[v])?(a=!0,r[d].union(r[v]),r.splice(v,1)):v++;d++}}while(a);return this._paintRects=r,r},t.prototype.debugGetPaintRects=function(){return(this._paintRects||[]).slice()},t.prototype.resize=function(e,t){var n=this.dpr,i=this.dom,a=i.style,r=this.domBack;a&&(a.width=e+"px",a.height=t+"px"),i.width=e*n,i.height=t*n,r&&(r.width=e*n,r.height=t*n,1!==n&&this.ctxBack.scale(n,n))},t.prototype.clear=function(e,t,n){var i=this.dom,a=this.ctx,r=i.width,s=i.height;t=t||this.clearColor;var o=this.motionBlur&&!e,l=this.lastFrameAlpha,c=this.dpr,d=this;o&&(this.domBack||this.createBackBuffer(),this.ctxBack.globalCompositeOperation="copy",this.ctxBack.drawImage(i,0,0,r/c,s/c));var u=this.domBack;function h(e,n,i,r){if(a.clearRect(e,n,i,r),t&&"transparent"!==t){var s=void 0;if(aI(t))s=(t.global||t.__width===i&&t.__height===r)&&t.__canvasGradient||bV(a,t,{x:0,y:0,width:i,height:r}),t.__canvasGradient=s,t.__width=i,t.__height=r;else rI(t)&&(t.scaleX=t.scaleX||c,t.scaleY=t.scaleY||c,s=MV(a,t,{dirty:function(){d.setUnpainted(),d.painter.refresh()}}));a.save(),a.fillStyle=s||t,a.fillRect(e,n,i,r),a.restore()}o&&(a.save(),a.globalAlpha=l,a.drawImage(u,e,n,i,r),a.restore())}!n||o?h(0,0,r,s):n.length&&jC(n,function(e){h(e.x*c,e.y*c,e.width*c,e.height*c)})},t}(JI),L4=1e5,N4=314159,F4=.01;var B4=function(){function e(e,t,n,i){this.type="canvas",this._zlevelList=[],this._prevDisplayList=[],this._layers={},this._layerConfig={},this._needsManuallyCompositing=!1,this.type="canvas";var a=!e.nodeName||"CANVAS"===e.nodeName.toUpperCase();this._opts=n=RC({},n||{}),this.dpr=n.devicePixelRatio||aA,this._singleCanvas=a,this.root=e,e.style&&(_I(e),e.innerHTML=""),this.storage=t;var r=this._zlevelList;this._prevDisplayList=[];var s=this._layers;if(a){var o=e,l=o.width,c=o.height;null!=n.width&&(l=n.width),null!=n.height&&(c=n.height),this.dpr=n.devicePixelRatio||1,o.width=l*this.dpr,o.height=c*this.dpr,this._width=l,this._height=c;var d=new O4(o,this,this.dpr);d.__builtin__=!0,d.initContext(),s[314159]=d,d.zlevel=N4,r.push(N4),this._domRoot=e}else{this._width=kV(e,0,n),this._height=kV(e,1,n);var u=this._domRoot=function(e,t){var n=document.createElement("div");return n.style.cssText=["position:relative","width:"+e+"px","height:"+t+"px","padding:0","margin:0","border-width:0"].join(";")+";",n}(this._width,this._height);e.appendChild(u)}}return e.prototype.getType=function(){return"canvas"},e.prototype.isSingleCanvas=function(){return this._singleCanvas},e.prototype.getViewportRoot=function(){return this._domRoot},e.prototype.getViewportRootOffset=function(){var e=this.getViewportRoot();if(e)return{offsetLeft:e.offsetLeft||0,offsetTop:e.offsetTop||0}},e.prototype.refresh=function(e){var t=this.storage.getDisplayList(!0),n=this._prevDisplayList,i=this._zlevelList;this._redrawId=Math.random(),this._paintList(t,n,e,this._redrawId);for(var a=0;a<i.length;a++){var r=i[a],s=this._layers[r];if(!s.__builtin__&&s.refresh){var o=0===a?this._backgroundColor:null;s.refresh(o)}}return this._opts.useDirtyRect&&(this._prevDisplayList=t.slice()),this},e.prototype.refreshHover=function(){this._paintHoverList(this.storage.getDisplayList(!1))},e.prototype._paintHoverList=function(e){var t=e.length,n=this._hoverlayer;if(n&&n.clear(),t){for(var i,a={inHover:!0,viewWidth:this._width,viewHeight:this._height},r=0;r<t;r++){var s=e[r];s.__inHover&&(n||(n=this._hoverlayer=this.getLayer(L4)),i||(i=n.ctx).save(),NV(i,s,a,r===t-1))}i&&i.restore()}},e.prototype.getHoverLayer=function(){return this.getLayer(L4)},e.prototype.paintOne=function(e,t){LV(e,t)},e.prototype._paintList=function(e,t,n,i){if(this._redrawId===i){n=n||!1,this._updateLayerStatus(e);var a=this._doPaintList(e,t,n),r=a.finished,s=a.needsRefreshHover;if(this._needsManuallyCompositing&&this._compositeManually(),s&&this._paintHoverList(e),r)this.eachLayer(function(e){e.afterBrush&&e.afterBrush()});else{var o=this;mT(function(){o._paintList(e,t,n,i)})}}},e.prototype._compositeManually=function(){var e=this.getLayer(N4).ctx,t=this._domRoot.width,n=this._domRoot.height;e.clearRect(0,0,t,n),this.eachBuiltinLayer(function(i){i.virtual&&e.drawImage(i.dom,0,0,t,n)})},e.prototype._doPaintList=function(e,t,n){for(var i=this,a=[],r=this._opts.useDirtyRect,s=0;s<this._zlevelList.length;s++){var o=this._zlevelList[s],l=this._layers[o];l.__builtin__&&l!==this._hoverlayer&&(l.__dirty||n)&&a.push(l)}for(var c=!0,d=!1,u=function(s){var o,l=a[s],u=l.ctx,p=r&&l.createRepaintRects(e,t,h._width,h._height),g=n?l.__startIndex:l.__drawIndex,v=!n&&l.incremental&&Date.now,f=v&&Date.now(),m=l.zlevel===h._zlevelList[0]?h._backgroundColor:null;if(l.__startIndex===l.__endIndex)l.clear(!1,m,p);else if(g===l.__startIndex){var y=e[g];y.incremental&&y.notClear&&!n||l.clear(!1,m,p)}-1===g&&(g=l.__startIndex);var b=function(t){var n={inHover:!1,allClipped:!1,prevEl:null,viewWidth:i._width,viewHeight:i._height};for(o=g;o<l.__endIndex;o++){var a=e[o];if(a.__inHover&&(d=!0),i._doPaintEl(a,l,r,t,n,o===l.__endIndex-1),v)if(Date.now()-f>15)break}n.prevElClipPaths&&u.restore()};if(p)if(0===p.length)o=l.__endIndex;else for(var w=h.dpr,k=0;k<p.length;++k){var S=p[k];u.save(),u.beginPath(),u.rect(S.x*w,S.y*w,S.width*w,S.height*w),u.clip(),b(S),u.restore()}else u.save(),b(),u.restore();l.__drawIndex=o,l.__drawIndex<l.__endIndex&&(c=!1)},h=this,p=0;p<a.length;p++)u(p);return pC.wxa&&jC(this._layers,function(e){e&&e.ctx&&e.ctx.draw&&e.ctx.draw()}),{finished:c,needsRefreshHover:d}},e.prototype._doPaintEl=function(e,t,n,i,a,r){var s=t.ctx;if(n){var o=e.getPaintRect();(!i||o&&o.intersect(i))&&(NV(s,e,a,r),e.setPrevPaintRect(o))}else NV(s,e,a,r)},e.prototype.getLayer=function(e,t){this._singleCanvas&&!this._needsManuallyCompositing&&(e=N4);var n=this._layers[e];return n||((n=new O4("zr_"+e,this,this.dpr)).zlevel=e,n.__builtin__=!0,this._layerConfig[e]?PC(n,this._layerConfig[e],!0):this._layerConfig[e-F4]&&PC(n,this._layerConfig[e-F4],!0),t&&(n.virtual=t),this.insertLayer(e,n),n.initContext()),n},e.prototype.insertLayer=function(e,t){var n=this._layers,i=this._zlevelList,a=i.length,r=this._domRoot,s=null,o=-1;if(!n[e]&&function(e){return!!e&&(!!e.__builtin__||"function"==typeof e.resize&&"function"==typeof e.refresh)}(t)){if(a>0&&e>i[0]){for(o=0;o<a-1&&!(i[o]<e&&i[o+1]>e);o++);s=n[i[o]]}if(i.splice(o+1,0,e),n[e]=t,!t.virtual)if(s){var l=s.dom;l.nextSibling?r.insertBefore(t.dom,l.nextSibling):r.appendChild(t.dom)}else r.firstChild?r.insertBefore(t.dom,r.firstChild):r.appendChild(t.dom);t.painter||(t.painter=this)}},e.prototype.eachLayer=function(e,t){for(var n=this._zlevelList,i=0;i<n.length;i++){var a=n[i];e.call(t,this._layers[a],a)}},e.prototype.eachBuiltinLayer=function(e,t){for(var n=this._zlevelList,i=0;i<n.length;i++){var a=n[i],r=this._layers[a];r.__builtin__&&e.call(t,r,a)}},e.prototype.eachOtherLayer=function(e,t){for(var n=this._zlevelList,i=0;i<n.length;i++){var a=n[i],r=this._layers[a];r.__builtin__||e.call(t,r,a)}},e.prototype.getLayers=function(){return this._layers},e.prototype._updateLayerStatus=function(e){function t(e){r&&(r.__endIndex!==e&&(r.__dirty=!0),r.__endIndex=e)}if(this.eachBuiltinLayer(function(e,t){e.__dirty=e.__used=!1}),this._singleCanvas)for(var n=1;n<e.length;n++){if((o=e[n]).zlevel!==e[n-1].zlevel||o.incremental){this._needsManuallyCompositing=!0;break}}var i,a,r=null,s=0;for(a=0;a<e.length;a++){var o,l=(o=e[a]).zlevel,c=void 0;i!==l&&(i=l,s=0),o.incremental?((c=this.getLayer(l+.001,this._needsManuallyCompositing)).incremental=!0,s=1):c=this.getLayer(l+(s>0?F4:0),this._needsManuallyCompositing),c.__builtin__||EC("ZLevel "+l+" has been used by unkown layer "+c.id),c!==r&&(c.__used=!0,c.__startIndex!==a&&(c.__dirty=!0),c.__startIndex=a,c.incremental?c.__drawIndex=-1:c.__drawIndex=a,t(a),r=c),1&o.__dirty&&!o.__inHover&&(c.__dirty=!0,c.incremental&&c.__drawIndex<0&&(c.__drawIndex=a))}t(a),this.eachBuiltinLayer(function(e,t){!e.__used&&e.getElementCount()>0&&(e.__dirty=!0,e.__startIndex=e.__endIndex=e.__drawIndex=0),e.__dirty&&e.__drawIndex<0&&(e.__drawIndex=e.__startIndex)})},e.prototype.clear=function(){return this.eachBuiltinLayer(this._clearLayer),this},e.prototype._clearLayer=function(e){e.clear()},e.prototype.setBackgroundColor=function(e){this._backgroundColor=e,jC(this._layers,function(e){e.setUnpainted()})},e.prototype.configLayer=function(e,t){if(t){var n=this._layerConfig;n[e]?PC(n[e],t,!0):n[e]=t;for(var i=0;i<this._zlevelList.length;i++){var a=this._zlevelList[i];if(a===e||a===e+F4)PC(this._layers[a],n[e],!0)}}},e.prototype.delLayer=function(e){var t=this._layers,n=this._zlevelList,i=t[e];i&&(i.dom.parentNode.removeChild(i.dom),delete t[e],n.splice(LC(n,e),1))},e.prototype.resize=function(e,t){if(this._domRoot.style){var n=this._domRoot;n.style.display="none";var i=this._opts,a=this.root;if(null!=e&&(i.width=e),null!=t&&(i.height=t),e=kV(a,0,i),t=kV(a,1,i),n.style.display="",this._width!==e||t!==this._height){for(var r in n.style.width=e+"px",n.style.height=t+"px",this._layers)this._layers.hasOwnProperty(r)&&this._layers[r].resize(e,t);this.refresh(!0)}this._width=e,this._height=t}else{if(null==e||null==t)return;this._width=e,this._height=t,this.getLayer(N4).resize(e,t)}return this},e.prototype.clearLayer=function(e){var t=this._layers[e];t&&t.clear()},e.prototype.dispose=function(){this.root.innerHTML="",this.root=this.storage=this._domRoot=this._layers=null},e.prototype.getRenderedCanvas=function(e){if(e=e||{},this._singleCanvas&&!this._compositeManually)return this._layers[314159].dom;var t=new O4("image",this,e.pixelRatio||this.dpr);t.initContext(),t.clear(!1,e.backgroundColor||this._backgroundColor);var n=t.ctx;if(e.pixelRatio<=this.dpr){this.refresh();var i=t.dom.width,a=t.dom.height;this.eachLayer(function(e){e.__builtin__?n.drawImage(e.dom,0,0,i,a):e.renderToCanvas&&(n.save(),e.renderToCanvas(n),n.restore())})}else for(var r={inHover:!1,viewWidth:this._width,viewHeight:this._height},s=this.storage.getDisplayList(!0),o=0,l=s.length;o<l;o++){var c=s[o];NV(n,c,r,o===l-1)}return t.dom},e.prototype.getWidth=function(){return this._width},e.prototype.getHeight=function(){return this._height},e}();function j4(e){e.registerPainter("canvas",B4)}eG([fK,UK,function(e){e.registerChartView(uJ),e.registerSeriesModel(hJ)},function(e){e.registerChartView(nZ),e.registerSeriesModel(sZ),function(e,t){function n(t,n){var i=[];return t.eachComponent({mainType:"series",subType:e,query:n},function(e){i.push(e.seriesIndex)}),i}jC([[e+"ToggleSelect","toggleSelect"],[e+"Select","select"],[e+"UnSelect","unselect"]],function(e){t(e[0],function(t,i,a){t=RC({},t),a.dispatchAction(RC(t,{type:e[1],seriesIndex:n(i,t)}))})})}("pie",e.registerAction),e.registerLayout(QC(HK,"pie")),e.registerProcessor({seriesType:"pie",reset:function(e,t){var n=t.findComponents({mainType:"legend"});if(n&&n.length){var i=e.getData();i.filterSelf(function(e){for(var t=i.getName(e),a=0;a<n.length;a++)if(!n[a].isSelected(t))return!1;return!0})}}}),e.registerProcessor(function(e){return{seriesType:e,reset:function(e,t){var n=e.getData();n.filterSelf(function(e){var t=n.mapDimension("value"),i=n.get(t,e);return!(JC(i)&&!isNaN(i)&&i<0)})}}}("pie"))},C1,b1,HJ,f2,function(e){eG(D2),eG($2)},function(e){e.registerComponentModel(g0),e.registerComponentView(f0),h0("saveAsImage",m0),h0("magicType",w0),h0("dataView",D0),h0("dataZoom",K0),h0("restore",z0),eG(c0)},function(e){eG(v4),eG(w4)},function(e){e.registerComponentModel(U1),e.registerComponentView(K1),e.registerPreprocessor(function(e){I1(e.series,"markLine")&&(e.markLine=e.markLine||{})})},function(e){e.registerComponentModel(A1),e.registerComponentView(j1),e.registerPreprocessor(function(e){I1(e.series,"markPoint")&&(e.markPoint=e.markPoint||{})})},j4]);var U4=la('<div class="memory-curve-chart svelte-etgg0u"></div>');function V4(e,t){if(new.target)return Er({component:V4,...e});kt(t,!0);let n=Ar(t,"data",7),i=Ar(t,"timeRange",7,"30d"),a=Ar(t,"height",7,400),r=Pn(void 0),s=Pn(null);function o(){if(!bi(s))return;const e=function(){const e=getComputedStyle(document.body);return{textColor:e.getPropertyValue("--text-normal")||"#000",mutedColor:e.getPropertyValue("--text-muted")||"#666",accentColor:e.getPropertyValue("--interactive-accent")||"#3b82f6",bgColor:e.getPropertyValue("--background-primary")||"#fff",borderColor:e.getPropertyValue("--background-modifier-border")||"#ddd"}}(),t=n().predicted.map(e=>[e.day,e.retrievability]),i=n().actual.map(e=>[e.day,e.retrievability]),a=n().reviewMarkers.map(e=>({name:1===e.rating?"遗忘":"复习",coord:[e.day,e.retrievability],value:e.rating,itemStyle:{color:X_(e.rating)}})),r={tooltip:{trigger:"axis",backgroundColor:e.bgColor,borderColor:e.borderColor,borderWidth:1,textStyle:{color:e.textColor,fontSize:14},shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.2)",extraCssText:"border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);",formatter:e=>{if(!Array.isArray(e))return"";let t='<div style="padding: 12px; font-family: var(--font-interface);">';return t+=`<div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: var(--text-normal);">第 ${e[0].data[0].toFixed(1)} 天</div>`,e.forEach(e=>{if(null!==e.value&&void 0!==e.value&&Array.isArray(e.value)){const n={"预测保持率":"#667eea","实际保持率":"#4facfe","风险阈值":"#f5576c"}[e.seriesName]||e.color;t+='<div style="display: flex; align-items: center; margin: 8px 0; line-height: 1.4;">',t+=`<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${n}; margin-right: 10px;"></span>`,t+=`<span style="color: var(--text-normal); font-size: 14px;">${e.seriesName}:</span>`,t+=`<strong style="margin-left: 8px; color: var(--text-accent); font-size: 15px;">${e.value[1].toFixed(1)}%</strong>`,t+="</div>"}}),t+="</div>",t}},legend:{data:["预测保持率","实际保持率","风险阈值"],bottom:20,textStyle:{color:e.textColor,fontSize:13},itemGap:20,icon:"circle"},grid:{left:"3%",right:"4%",bottom:"15%",top:"10%",containLabel:!0},xAxis:{type:"category",data:Array.from({length:Math.max(...n().predicted.map(e=>Math.ceil(e.day)),...n().actual.map(e=>Math.ceil(e.day)))},(e,t)=>t),name:"天数",nameLocation:"middle",nameGap:30,axisLine:{lineStyle:{color:e.borderColor}},axisLabel:{color:e.mutedColor,fontSize:12},nameTextStyle:{color:e.textColor,fontSize:13}},yAxis:{type:"value",name:"记忆保持率 (%)",min:0,max:100,nameTextStyle:{color:e.textColor,fontSize:13},axisLine:{lineStyle:{color:e.borderColor}},axisLabel:{color:e.mutedColor,formatter:"{value}%",fontSize:12},splitLine:{lineStyle:{color:e.borderColor,type:"dashed"}}},series:[{name:"预测保持率",type:"line",data:t.map(e=>[Math.floor(e[0]),e[1]]),smooth:!0,lineStyle:{color:"#667eea",width:3},itemStyle:{color:"#667eea"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(102, 126, 234, 0.3)"},{offset:1,color:"rgba(102, 126, 234, 0.05)"}]}},symbol:"circle",symbolSize:6,showSymbol:!1,emphasis:{focus:"series",scale:!0,showSymbol:!0}},{name:"实际保持率",type:"line",data:i.map(e=>[Math.floor(e[0]),e[1]]),smooth:!0,lineStyle:{color:"#4facfe",width:2,type:"solid"},itemStyle:{color:"#4facfe"},symbol:"circle",symbolSize:6,emphasis:{focus:"series",scale:!0},markPoint:a.length>0?{data:a.map(e=>({...e,coord:[Math.floor(e.coord[0]),e.coord[1]]})),symbolSize:10,label:{show:!1}}:void 0},{name:"风险阈值",type:"line",data:Array.from({length:Math.max(...n().predicted.map(e=>Math.ceil(e.day)))},(e,t)=>[t,80]),lineStyle:{color:"#f5576c",width:2,type:"dashed"},itemStyle:{color:"#f5576c"},symbol:"none",silent:!0}],dataZoom:[{type:"inside",xAxisIndex:0,start:0,end:100},{type:"slider",xAxisIndex:0,start:0,end:100,height:20,bottom:10,borderColor:e.borderColor,fillerColor:"rgba(59, 130, 246, 0.1)",handleStyle:{color:e.accentColor},textStyle:{color:e.mutedColor}}]};bi(s).setOption(r)}function l(){bi(s)&&bi(s).resize()}Pr(()=>{bi(r)&&($n(s,EQ.init(bi(r)),!0),o()),window.addEventListener("resize",l);const e=new MutationObserver(()=>{o()});return e.observe(document.body,{attributes:!0,attributeFilter:["class"]}),()=>{e.disconnect()}}),Ti(()=>{n()&&bi(s)&&o()}),Rr(()=>{window.removeEventListener("resize",l),bi(s)&&(bi(s).dispose(),$n(s,null))});var c={get data(){return n()},set data(e){n(e),hn()},get timeRange(){return i()},set timeRange(e="30d"){i(e),hn()},get height(){return a()},set height(e=400){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},d=U4();let u;return kr(d,e=>$n(r,e),()=>bi(r)),zi(e=>u=ja(d,"",u,e),[()=>{var e;return{height:`${null!=(e=a())?e:""}px`}}]),pa(e,d),St(c)}var q4=(e,t,n,i)=>{$n(t,bi(n).value,!0),$n(i,!1)},H4=la("<button> </button>"),W4=la('<div class="chart-empty svelte-j7ezoz"><div class="empty-icon svelte-j7ezoz">📊</div> <h4 class="svelte-j7ezoz"> </h4> <p class="svelte-j7ezoz"> </p> <p class="empty-hint svelte-j7ezoz"> </p></div>'),G4=la('<section class="curve-insights svelte-j7ezoz"><h3 class="insights-title with-accent-bar accent-purple svelte-j7ezoz"> </h3> <div class="insights-grid svelte-j7ezoz"><div class="insight-card svelte-j7ezoz"><div class="insight-indicator svelte-j7ezoz" style="color: #3b82f6;">📉</div> <div class="insight-content svelte-j7ezoz"><h4 class="svelte-j7ezoz"> </h4> <p class="svelte-j7ezoz"> </p></div></div> <div class="insight-card svelte-j7ezoz"><div class="insight-indicator svelte-j7ezoz" style="color: #22c55e;">🎯</div> <div class="insight-content svelte-j7ezoz"><h4 class="svelte-j7ezoz"> </h4> <p class="svelte-j7ezoz"> </p></div></div> <div class="insight-card svelte-j7ezoz"><div class="insight-indicator svelte-j7ezoz" style="color: #f59e0b;">⚡</div> <div class="insight-content svelte-j7ezoz"><h4 class="svelte-j7ezoz"> </h4> <p class="svelte-j7ezoz"> </p></div></div> <div class="insight-card svelte-j7ezoz"><div class="insight-indicator svelte-j7ezoz" style="color: #ef4444;">⚠</div> <div class="insight-content svelte-j7ezoz"><h4 class="svelte-j7ezoz"> </h4> <p class="svelte-j7ezoz"> </p></div></div></div></section>'),Q4=la('<section class="curve-summary svelte-j7ezoz"><div class="summary-item svelte-j7ezoz"><span class="summary-label svelte-j7ezoz"> </span> <span class="summary-value svelte-j7ezoz"> </span></div> <div class="summary-item svelte-j7ezoz"><span class="summary-label svelte-j7ezoz"> </span> <span class="summary-value svelte-j7ezoz"> </span></div> <div class="summary-item svelte-j7ezoz"><span class="summary-label svelte-j7ezoz"> </span> <span class="summary-value svelte-j7ezoz"> </span></div> <div class="summary-item svelte-j7ezoz"><span class="summary-label svelte-j7ezoz"> </span> <span class="summary-value svelte-j7ezoz"> </span></div></section>'),K4=la('<div class="memory-curve-tab svelte-j7ezoz" role="tabpanel" id="curve-panel"><section class="curve-controls svelte-j7ezoz"><div class="range-selector svelte-j7ezoz"><span class="range-label svelte-j7ezoz">快捷范围：</span> <div class="range-buttons svelte-j7ezoz"></div></div> <div class="custom-date-selector svelte-j7ezoz"><span class="range-label svelte-j7ezoz">自定义范围：</span> <div class="date-inputs svelte-j7ezoz"><input type="date" class="date-input svelte-j7ezoz"/> <span class="date-separator svelte-j7ezoz">至</span> <input type="date" class="date-input svelte-j7ezoz"/> <span class="date-hint svelte-j7ezoz">(30天)</span></div></div> <div class="hint-text svelte-j7ezoz"><span class="hint-indicator svelte-j7ezoz">ⓘ</span> <span>滑动鼠标滚轮或拖拽可快速切换查看范围</span></div></section> <section class="curve-chart-section svelte-j7ezoz"><!></section> <!> <!></div>');function Z4(e,t){if(new.target)return Er({component:Z4,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"card",7),s=In(n);const o=In(()=>[{value:"7d",label:"最近7天",days:7},{value:"14d",label:"最近14天",days:14},{value:"30d",label:"最近30天",days:30},{value:"60d",label:"最近60天",days:60},{value:"90d",label:"最近90天",days:90}]);let l=Pn("30d"),c=Pn(""),d=Pn(""),u=Pn(!1);const h=In(()=>Y_(r(),bi(l))),p=In(()=>(r().reviewHistory||[]).length>=2);var g={get card(){return r()},set card(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},v=K4(),f=Gt(v),m=Gt(f),y=Kt(Gt(m),2);Ca(y,21,()=>bi(o),_a,(e,t)=>{var n=H4();let i;n.__click=[q4,l,t,u];var a=Gt(n,!0);zt(n),zi(e=>{i=Fa(n,1,"range-button svelte-j7ezoz",null,i,e),va(a,bi(t).label)},[()=>({active:bi(l)===bi(t).value&&!bi(u)})]),pa(e,n)}),zt(y),zt(m);var b=Kt(m,2),w=Kt(Gt(b),2),k=Gt(w);Za(k);var S=Kt(k,4);Za(S),Pt(2),zt(w),zt(b),Pt(2),zt(f);var x=Kt(f,2),_=Gt(x),C=e=>{var t=W4(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n);var a=Kt(n,2),o=Gt(a,!0);zt(a);var l=Kt(a,2),c=Gt(l,!0);zt(l),zt(t),zi((e,t,n)=>{va(i,e),va(o,t),va(c,n)},[()=>bi(s)("modals.memoryCurveTab.emptyState.title"),()=>bi(s)("modals.memoryCurveTab.emptyState.description"),()=>bi(s)("modals.memoryCurveTab.emptyState.reviewCount").replace("{count}",String((r().reviewHistory||[]).length))]),pa(e,t)},I=e=>{V4(e,{get data(){return bi(h)},get timeRange(){return bi(l)},height:450})};xa(_,e=>{bi(p)?e(I,!1):e(C)}),zt(x);var D=Kt(x,2),T=e=>{var t=G4(),n=Gt(t),i=Gt(n,!0);zt(n);var a=Kt(n,2),r=Gt(a),o=Kt(Gt(r),2),l=Gt(o),c=Gt(l,!0);zt(l);var d=Kt(l,2),u=Gt(d,!0);zt(d),zt(o),zt(r);var h=Kt(r,2),p=Kt(Gt(h),2),g=Gt(p),v=Gt(g,!0);zt(g);var f=Kt(g,2),m=Gt(f,!0);zt(f),zt(p),zt(h);var y=Kt(h,2),b=Kt(Gt(y),2),w=Gt(b),k=Gt(w,!0);zt(w);var S=Kt(w,2),x=Gt(S,!0);zt(S),zt(b),zt(y);var _=Kt(y,2),C=Kt(Gt(_),2),I=Gt(C),D=Gt(I,!0);zt(I);var T=Kt(I,2),M=Gt(T,!0);zt(T),zt(C),zt(_),zt(a),zt(t),zi((e,t,n,a,r,s,o,l,d)=>{va(i,e),va(c,t),va(u,n),va(v,a),va(m,r),va(k,s),va(x,o),va(D,l),va(M,d)},[()=>bi(s)("modals.memoryCurveTab.insights.title"),()=>bi(s)("modals.memoryCurveTab.insights.forgetting.title"),()=>bi(s)("modals.memoryCurveTab.insights.forgetting.description"),()=>bi(s)("modals.memoryCurveTab.insights.optimalTiming.title"),()=>bi(s)("modals.memoryCurveTab.insights.optimalTiming.description"),()=>bi(s)("modals.memoryCurveTab.insights.stabilityGrowth.title"),()=>bi(s)("modals.memoryCurveTab.insights.stabilityGrowth.description"),()=>bi(s)("modals.memoryCurveTab.insights.lapsesImpact.title"),()=>bi(s)("modals.memoryCurveTab.insights.lapsesImpact.description")]),pa(e,t)};xa(D,e=>{bi(p)&&e(T)});var M=Kt(D,2),A=e=>{var t=Q4(),n=Gt(t),i=Gt(n),a=Gt(i,!0);zt(i);var o=Kt(i,2),l=Gt(o);zt(o),zt(n);var c=Kt(n,2),d=Gt(c),u=Gt(d,!0);zt(d);var p=Kt(d,2),g=Gt(p);zt(p),zt(c);var v=Kt(c,2),f=Gt(v),m=Gt(f,!0);zt(f);var y=Kt(f,2),b=Gt(y);zt(y),zt(v);var w=Kt(v,2),k=Gt(w),S=Gt(k,!0);zt(k);var x=Kt(k,2),_=Gt(x);zt(x),zt(w),zt(t),zi((e,t,n,i,r,s,o,c,d)=>{var p,v;va(a,e),va(l,`${null!=(p=bi(h).actual.length)?p:""} ${null!=t?t:""}`),va(u,n),va(g,`${null!=(v=bi(h).reviewMarkers.length)?v:""} ${null!=i?i:""}`),va(m,r),va(b,`${null!=s?s:""} ${null!=o?o:""}`),va(S,c),va(_,`${null!=d?d:""}%`)},[()=>bi(s)("modals.memoryCurveTab.summary.dataPoints"),()=>bi(s)("modals.memoryCurveTab.summary.pointsUnit"),()=>bi(s)("modals.memoryCurveTab.summary.reviewMarkers"),()=>bi(s)("modals.memoryCurveTab.summary.pointsUnit"),()=>bi(s)("modals.memoryCurveTab.summary.currentStability"),()=>{var e;return((null==(e=r().fsrs)?void 0:e.stability)||0).toFixed(1)},()=>bi(s)("modals.memoryCurveTab.summary.daysUnit"),()=>bi(s)("modals.memoryCurveTab.summary.currentRetrievability"),()=>{var e;return(100*((null==(e=r().fsrs)?void 0:e.retrievability)||0)).toFixed(1)}]),pa(e,t)};xa(M,e=>{bi(p)&&e(A)}),zt(v),na("focus",k,()=>$n(u,!0)),pr(k,()=>bi(c),e=>$n(c,e)),na("focus",S,()=>$n(u,!0)),pr(S,()=>bi(d),e=>$n(d,e)),pa(e,v);var E=St(g);return a(),E}ia(["click"]);var Y4=la('<div class="view-card-modal-v2 svelte-1dh81iz"><div class="modal-tabs svelte-1dh81iz"><!></div> <div class="modal-tab-content svelte-1dh81iz"><!></div></div>');function X4(e,t){if(new.target)return Er({component:X4,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=In(n),s=Ar(t,"open",15),o=Ar(t,"onClose",7),l=Ar(t,"card",7),c=Ar(t,"plugin",7),d=Ar(t,"allDecks",7),u=Pn(Ot(l())),h=Pn("info"),p=In(()=>[{id:"info",label:bi(r)("modals.viewCard.tabInfo"),icon:"info"},{id:"stats",label:bi(r)("modals.viewCard.tabStats"),icon:"bar-chart-2"},{id:"curve",label:bi(r)("modals.viewCard.tabCurve"),icon:"activity"}]),g=Pn(""),v=Pn("");function f(e){$n(h,e,!0)}function m(){"function"==typeof o()&&o()()}Ti(()=>{bi(g)||$n(g,bi(r)("modals.viewCard.loading"),!0),bi(v)||$n(v,bi(r)("modals.viewCard.unknownTemplate"),!0)}),Ti(()=>{s()&&l().uuid&&(async()=>{try{const e=await c().directFileReader.getCardByUUID(l().uuid);e&&($n(u,e,!0),_e.debug("[ViewCardModal] ✅ 刷新卡片数据:",{uuid:e.uuid,type:e.type,hasProgressiveCloze:!!e.progressiveCloze}))}catch(e){_e.error("[ViewCardModal] 刷新卡片数据失败:",e),$n(u,l(),!0)}})()}),Ti(()=>{bi(u)&&(async()=>{var e;try{if(bi(u).deckId)if(d()){const e=d().find(e=>e.id===bi(u).deckId);$n(g,(null==e?void 0:e.name)||bi(u).deckId,!0)}else{const e=(await c().dataStorage.getAllDecks()).find(e=>e.id===bi(u).deckId);$n(g,(null==e?void 0:e.name)||bi(u).deckId,!0)}else $n(g,bi(r)("modals.viewCard.noDeck"),!0);bi(u).templateId&&$n(v,(null==(e=bi(u).fields)?void 0:e.templateName)||bi(u).templateId,!0)}catch(t){_e.error("[ViewCardModal] 加载关联数据失败:",t)}})()});var y={get open(){return s()},set open(e){s(e),hn()},get onClose(){return o()},set onClose(e){o(e),hn()},get card(){return l()},set card(e){l(e),hn()},get plugin(){return c()},set plugin(e){c(e),hn()},get allDecks(){return d()},set allDecks(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},b=ha(),w=Qt(b),k=e=>{{let t=In(()=>bi(r)("modals.viewCard.title"));zx(e,{get plugin(){return c()},get title(){return bi(t)},onClose:m,enableTransparentMask:!1,enableWindowDrag:!1,accentColor:"blue",get open(){return s()},set open(e){s(e)},children:(e,t)=>{var n=Y4(),i=Gt(n);Ox(Gt(i),{get tabs(){return bi(p)},get activeTab(){return bi(h)},onTabChange:f}),zt(i);var a=Kt(i,2),r=Gt(a),s=e=>{q_(e,{get card(){return bi(u)},get plugin(){return c()},get deckName(){return bi(g)},get templateName(){return bi(v)}})},o=e=>{var t=ha(),n=Qt(t),i=e=>{cC(e,{get card(){return bi(u)}})},a=e=>{var t=ha(),n=Qt(t),i=e=>{Z4(e,{get card(){return bi(u)}})};xa(n,e=>{"curve"===bi(h)&&e(i)},!0),pa(e,t)};xa(n,e=>{"stats"===bi(h)?e(i):e(a,!1)},!0),pa(e,t)};xa(r,e=>{"info"===bi(h)?e(s):e(o,!1)}),zt(a),zt(n),pa(e,n)},$$slots:{default:!0}})}};xa(w,e=>{s()&&e(k)}),pa(e,b);var S=St(y);return a(),S}function J4(e){return e<=2?"light":e<=5?"medium":"severe"}function e3(e){if(!e.stats)return _e.warn("[数据迁移] 卡片缺少 stats 对象，跳过迁移:",e.uuid),e;if(e.stats.errorTracking)return e;if(e.stats.choiceStats){const{isInErrorBook:t,errorCount:n,totalAttempts:i,correctAttempts:a,accuracy:r,lastErrorDate:s}=e.stats.choiceStats,o={isInErrorBook:t,errorCount:n,correctCount:a,accuracy:r,lastErrorDate:s,errorLevel:J4(n)};return{...e,stats:{...e.stats,errorTracking:o}}}return e}function t3(e,t){e.target===e.currentTarget&&t()()}var n3=(e,t)=>"Escape"===e.key&&t()(),i3=e=>e.stopPropagation(),a3=e=>e.stopPropagation(),r3=la('<div class="activation-prompt-overlay svelte-5ijk8s" role="dialog" aria-modal="true" tabindex="-1"><div class="activation-prompt svelte-5ijk8s" role="document" tabindex="0"><div class="prompt-header svelte-5ijk8s"><div class="header-content svelte-5ijk8s"><span class="feature-icon svelte-5ijk8s"> </span> <h3 class="feature-name svelte-5ijk8s"> </h3></div> <button class="close-button svelte-5ijk8s" aria-label="关闭">✕</button></div> <div class="prompt-content svelte-5ijk8s"><p class="feature-description svelte-5ijk8s"> </p> <div class="info-box svelte-5ijk8s"><div class="info-icon svelte-5ijk8s">🔒</div> <div class="info-text svelte-5ijk8s"><p class="info-title svelte-5ijk8s">此功能需要激活许可证</p> <p class="info-subtitle svelte-5ijk8s">激活后即可解锁所有高级功能</p></div></div> <div class="benefits-list svelte-5ijk8s"><p class="benefits-title svelte-5ijk8s">激活高级版后，您将解锁：</p> <ul class="svelte-5ijk8s"><li class="svelte-5ijk8s">🎨 网格视图</li> <li class="svelte-5ijk8s">📋 看板视图</li> <li class="svelte-5ijk8s">📊 统计分析</li> <li class="svelte-5ijk8s">✍️ 标注块同步</li> <li class="svelte-5ijk8s">🔄 批量解析</li> <li class="svelte-5ijk8s">🤖 AI制卡</li> <li class="svelte-5ijk8s">📚 刷题牌组（开发中）</li> <li class="svelte-5ijk8s">📖 渐进式阅读（敬请期待）</li></ul></div> <div class="purchase-section svelte-5ijk8s"><p class="purchase-hint svelte-5ijk8s">还没有激活码？</p> <a href="https://pay.ldxp.cn/item/ned9pw" class="purchase-link svelte-5ijk8s" target="_blank" rel="noopener noreferrer">💎 获取激活码</a></div></div></div></div>');function s3(e,t){if(new.target)return Er({component:s3,...e});kt(t,!0);let n=Ar(t,"featureId",7),i=Ar(t,"visible",7,!1),a=Ar(t,"onClose",7);const r=In(()=>Wh[n()]||{name:"高级功能",description:"此功能需要激活许可证",icon:"💎"});var s={get featureId(){return n()},set featureId(e){n(e),hn()},get visible(){return i()},set visible(e=!1){i(e),hn()},get onClose(){return a()},set onClose(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=ha(),l=Qt(o),c=e=>{var t=r3();t.__click=[t3,a],t.__keydown=[n3,a];var n=Gt(t);n.__click=[i3],n.__keydown=[a3];var i=Gt(n),s=Gt(i),o=Gt(s),l=Gt(o,!0);zt(o);var c=Kt(o,2),d=Gt(c,!0);zt(c),zt(s),Kt(s,2).__click=function(...e){var t;null==(t=a())||t.apply(this,e)},zt(i);var u=Kt(i,2),h=Gt(u),p=Gt(h,!0);zt(h),Pt(6),zt(u),zt(n),zt(t),zi(()=>{va(l,bi(r).icon),va(d,bi(r).name),va(p,bi(r).description)}),pa(e,t)};return xa(l,e=>{i()&&e(c)}),pa(e,o),St(s)}ia(["click","keydown"]);var o3=la('<span class="badge-icon svelte-1z8p0m">💎</span> <span class="badge-text svelte-1z8p0m">PRO</span>',1),l3=la('<span class="badge-icon svelte-1z8p0m">🔒</span>'),c3=la("<span><!></span>");function d3(e,t){if(new.target)return Er({component:d3,...e});kt(t,!0);let n=Ar(t,"variant",7,"lock"),i=Ar(t,"size",7,"small");var a={get variant(){return n()},set variant(e="lock"){n(e),hn()},get size(){return i()},set size(e="small"){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},r=c3();let s;var o=Gt(r),l=e=>{var t=o3();Pt(2),pa(e,t)},c=e=>{pa(e,l3())};return xa(o,e=>{"pro"===n()?e(l):e(c,!1)}),zt(r),zi(e=>s=Fa(r,1,"premium-badge svelte-1z8p0m",null,s,e),[()=>({pro:"pro"===n(),lock:"lock"===n(),small:"small"===i(),medium:"medium"===i()})]),pa(e,r),St(a)}class u3{constructor(e){if(oe(this,"app"),oe(this,"basePath"),!e||!e.vault)throw new Error("QuestionBankStorage requires a valid App instance with vault");this.app=e,this.basePath=this.getQuestionBankPath(),_e.debug("[QuestionBankStorage] Initialized with basePath:",this.basePath)}getQuestionBankPath(){return us.questionBank}async initialize(){const e=this.app.vault.adapter;await e.exists(this.basePath)||await e.mkdir(this.basePath);const t=["test-sessions","error-book"];for(const n of t){const t=`${this.basePath}/${n}`;await e.exists(t)||await e.mkdir(t)}}getFilePath(e){return`${this.basePath}/${e}`}async saveBanks(e){const t=this.getFilePath("banks.json"),n=JSON.stringify(e,null,2);try{await this.app.vault.adapter.write(t,n)}catch(i){throw _e.error("[QuestionBankStorage] 保存题库牌组失败:",i),new Error(`保存题库牌组失败: ${i instanceof Error?i.message:String(i)}`)}}async loadBanks(){const e=this.getFilePath("banks.json");try{if(!(await this.app.vault.adapter.exists(e)))return[];const t=await this.app.vault.adapter.read(e),n=JSON.parse(t);return Array.isArray(n)?n:(_e.error("[QuestionBankStorage] banks.json 格式错误，期望数组但得到:",typeof n),[])}catch(t){return _e.error("[QuestionBankStorage] 加载题库牌组失败:",t),[]}}async saveBankQuestions(e,t){if(!Array.isArray(t)){const e="saveBankQuestions 期望数组参数，但得到: "+typeof t;throw _e.error(`[QuestionBankStorage] ${e}`),new Error(e)}const n=`${this.basePath}/banks/${e}`;await this.app.vault.adapter.exists(n)||await this.app.vault.adapter.mkdir(n);const i=`${n}/questions.json`,a={_schemaVersion:"1.0.0",bankId:e,questions:t},r=JSON.stringify(a,null,2);try{await this.app.vault.adapter.write(i,r),_e.debug(`[QuestionBankStorage] ✅ 已保存题库题目: ${e}, 题目数: ${t.length}`)}catch(s){throw _e.error("[QuestionBankStorage] 保存题库题目失败:",s),new Error(`保存题库题目失败: ${s instanceof Error?s.message:String(s)}`)}}async loadBankQuestions(e){const t=`${this.basePath}/banks/${e}/questions.json`;try{if(!(await this.app.vault.adapter.exists(t)))return[];const n=await this.app.vault.adapter.read(t);if(!n||0===n.trim().length)return _e.warn(`[QuestionBankStorage] 题库题目文件为空: ${e}`),[];const i=JSON.parse(n);return Array.isArray(i.questions)?i.questions:(_e.error("[QuestionBankStorage] 题目数据格式错误，期望数组但得到: "+typeof i.questions),[])}catch(n){return _e.error(`[QuestionBankStorage] 加载题库题目失败: ${e}`,n),[]}}async saveSession(e){const t=`${this.basePath}/test-sessions/${e.id}.json`,n=JSON.stringify(e,null,2);try{await this.app.vault.adapter.write(t,n)}catch(i){throw _e.error("[QuestionBankStorage] 保存测试会话失败:",i),new Error(`保存测试会话失败: ${i instanceof Error?i.message:String(i)}`)}}async loadSession(e){const t=`${this.basePath}/test-sessions/${e}.json`;try{if(!(await this.app.vault.adapter.exists(t)))return null;const e=await this.app.vault.adapter.read(t);return JSON.parse(e)}catch(n){return _e.error("[QuestionBankStorage] 加载测试会话失败:",n),null}}async loadAllSessions(){const e=`${this.basePath}/test-sessions`;try{if(!(await this.app.vault.adapter.exists(e)))return[];const n=await this.app.vault.adapter.list(e),i=[];for(const e of n.files)if(e.endsWith(".json"))try{const t=await this.app.vault.adapter.read(e),n=JSON.parse(t);i.push(n)}catch(t){_e.error(`[QuestionBankStorage] 加载会话文件失败: ${e}`,t)}return i}catch(t){return _e.error("[QuestionBankStorage] 加载所有测试会话失败:",t),[]}}async deleteSession(e){const t=`${this.basePath}/test-sessions/${e}.json`;try{await this.app.vault.adapter.exists(t)&&await this.app.vault.adapter.remove(t)}catch(n){throw _e.error("[QuestionBankStorage] 删除测试会话失败:",n),new Error(`删除测试会话失败: ${n instanceof Error?n.message:String(n)}`)}}async saveErrorBook(e,t){const n=`${this.basePath}/error-book/${e}.json`,i=JSON.stringify(t,null,2);try{await this.app.vault.adapter.write(n,i)}catch(a){throw _e.error("[QuestionBankStorage] 保存错题本失败:",a),new Error(`保存错题本失败: ${a instanceof Error?a.message:String(a)}`)}}async loadErrorBook(e){const t=`${this.basePath}/error-book/${e}.json`;try{if(!(await this.app.vault.adapter.exists(t)))return[];const e=await this.app.vault.adapter.read(t);return JSON.parse(e)}catch(n){return _e.error("[QuestionBankStorage] 加载错题本失败:",n),[]}}async deleteErrorBook(e){const t=`${this.basePath}/error-book/${e}.json`;try{await this.app.vault.adapter.exists(t)&&await this.app.vault.adapter.remove(t)}catch(n){_e.error("[QuestionBankStorage] 删除错题本失败:",n)}}async deleteBankQuestions(e){const t=`${this.basePath}/banks/${e}/questions.json`;try{await this.app.vault.adapter.exists(t)&&await this.app.vault.adapter.remove(t);const i=`${this.basePath}/banks/${e}`;if(await this.app.vault.adapter.exists(i))try{await this.app.vault.adapter.rmdir(i,!1)}catch(n){}}catch(i){_e.error("[QuestionBankStorage] 删除题库题目失败:",i)}}async cleanupOldSessions(e=30){const t=await this.loadAllSessions(),n=new Date;n.setDate(n.getDate()-e);let i=0;for(const r of t){if(new Date(r.startTime)<n)try{await this.deleteSession(r.id),i++}catch(a){_e.error(`[QuestionBankStorage] 清理会话失败: ${r.id}`,a)}}return _e.debug(`[QuestionBankStorage] 清理了 ${i} 个过期测试会话`),i}async getStorageStats(){const e=await this.loadBanks(),t=await this.loadAllSessions();let n=0;for(const s of e)try{n+=(await this.loadBankQuestions(s.id)).length}catch(r){_e.error(`[QuestionBankStorage] 加载题库${s.id}题目失败:`,r)}const i=`${this.basePath}/error-book`;let a=0;try{if(await this.app.vault.adapter.exists(i)){a=(await this.app.vault.adapter.list(i)).files.filter(e=>e.endsWith(".json")).length}}catch(r){_e.error("[QuestionBankStorage] 统计错题本失败:",r)}return{banks:e.length,questions:n,sessions:t.length,errorBooks:a}}}function h3(e,t){$n(t,"all"===bi(t)?"current":"all",!0)}function p3(e,t){$n(t,!bi(t))}function g3(e,t,n,i){var a;null==(a=t().filterStateService)||a.clearAll(),$n(n,null),$n(i,""),new ge.Notice("已清除所有筛选")}var v3=la('<div class="initial-loading-overlay svelte-1f3uhkd"><!></div>'),f3=(e,t)=>t(e.target.value),m3=la('<div class="more-menu-container svelte-1f3uhkd"><button class="more-menu-button svelte-1f3uhkd" aria-label="更多"><!></button></div> <button aria-label="文档筛选"><!></button> <button aria-label="卡片定位跳转"><!></button> <button aria-label="牌组题库"><!></button> <button class="toolbar-button search-button-right svelte-1f3uhkd" aria-label="搜索"><!></button> <input type="search" class="toolbar-search-input-hidden svelte-1f3uhkd" placeholder="搜索卡片..."/>',1),y3=la("<!> <!>",1),b3=la("<!> <!>",1),w3=la("<!> <!>",1),k3=la('<div class="current-mode-indicator svelte-1f3uhkd"><!> <span class="svelte-1f3uhkd">刷题数据模式</span></div>'),S3=la('<div class="btn-group layout-mode-toggle svelte-1f3uhkd"><!></div>'),x3=la('<div class="btn-group layout-mode-toggle svelte-1f3uhkd"><!> <!></div>'),_3=la('<div class="btn-group layout-mode-toggle svelte-1f3uhkd"><!> <!> <!></div>'),C3=la("<div><!></div>"),I3=la('<span class="data-source-badge svelte-1f3uhkd"> </span>'),D3=la("<!> 牌组题库 <!>",1),T3=(e,t)=>t(e.target.value),M3=la("<!> 新增卡片",1),A3=la('<div class="btn-group view-toggle svelte-1f3uhkd"><!> <!> <!></div> <!> <div class="btn-group utility-actions svelte-1f3uhkd"><!> <!> <!></div> <!>  <input type="search" class="toolbar-search-input search-input-right svelte-1f3uhkd" placeholder="搜索卡片内容、标签..."/> <!>',1),E3=(e,t)=>t("none"),z3=(e,t)=>t("uuid"),P3=(e,t)=>t("source"),R3=(e,t)=>t("priority"),$3=(e,t)=>t("retention"),O3=(e,t)=>t("modified"),L3=la('<div class="grid-attribute-menu"><div class="menu-section-title svelte-1f3uhkd"> </div> <button><!> <span class="svelte-1f3uhkd"> </span></button> <button><!> <span class="svelte-1f3uhkd"> </span></button> <button><!> <span class="svelte-1f3uhkd"> </span></button> <button><!> <span class="svelte-1f3uhkd"> </span></button> <button><!> <span class="svelte-1f3uhkd"> </span></button> <button><!> <span class="svelte-1f3uhkd"> </span></button></div>'),N3=(e,t,n)=>{t("table"),n()},F3=(e,t,n,i)=>{bi(t)&&(n("grid"),i())},B3=(e,t,n,i)=>{bi(t)&&(n("kanban"),i())},j3=(e,t,n)=>{t("fixed"),n()},U3=(e,t,n)=>{t("masonry"),n()},V3=la('<div class="menu-divider svelte-1f3uhkd"></div> <div class="menu-section svelte-1f3uhkd"><div class="menu-section-title svelte-1f3uhkd"> </div> <button><!> <span class="svelte-1f3uhkd"> </span> <!></button> <button><!> <span class="svelte-1f3uhkd"> </span> <!></button></div>',1),q3=(e,t,n)=>{t("compact"),n()},H3=(e,t,n)=>{t("comfortable"),n()},W3=(e,t,n)=>{t("spacious"),n()},G3=la('<div class="menu-divider svelte-1f3uhkd"></div> <div class="menu-section svelte-1f3uhkd"><div class="menu-section-title svelte-1f3uhkd">密度</div> <button><!> <span class="svelte-1f3uhkd">紧凑</span></button> <button><!> <span class="svelte-1f3uhkd">舒适</span></button> <button><!> <span class="svelte-1f3uhkd">宽敞</span></button></div>',1),Q3=(e,t,n)=>{t(),n()},K3=(e,t,n)=>{_e.debug("[字段管理] 按钮点击，当前状态:",bi(t)),$n(t,!bi(t)),_e.debug("[字段管理] 新状态:",bi(t)),n()},Z3=la('<div class="more-menu svelte-1f3uhkd"><div class="menu-section svelte-1f3uhkd"><div class="menu-section-title svelte-1f3uhkd"> </div> <button><!> <span class="svelte-1f3uhkd"> </span></button> <button><!> <span class="svelte-1f3uhkd"> </span> <!></button> <button><!> <span class="svelte-1f3uhkd"> </span> <!></button></div> <!> <!> <div class="menu-divider svelte-1f3uhkd"></div> <div class="menu-section svelte-1f3uhkd"><div class="menu-section-title svelte-1f3uhkd">工具</div> <button class="menu-item svelte-1f3uhkd"><!> <span class="svelte-1f3uhkd">扫描孤儿卡片</span></button> <button class="menu-item svelte-1f3uhkd"><!> <span class="svelte-1f3uhkd">字段管理</span></button></div></div>'),Y3=(e,t)=>$n(t,"all"),X3=la('<div class="filter-status-bar svelte-1f3uhkd"><div class="status-content svelte-1f3uhkd"><span>来源：<strong class="doc-name svelte-1f3uhkd"> </strong></span></div> <button class="clear-filter-btn svelte-1f3uhkd" title="显示全部"><!> 显示全部</button></div>'),J3=la('<span class="filter-title svelte-1f3uhkd"> </span>'),e5=la("<span>已应用筛选条件</span>"),t5=la('<span class="filter-badge svelte-1f3uhkd">牌组</span>'),n5=la('<span class="filter-badge svelte-1f3uhkd"> </span>'),i5=la('<span class="filter-badge svelte-1f3uhkd">优先级</span>'),a5=la('<span class="filter-badge svelte-1f3uhkd"> </span>'),r5=la('<span class="filter-badge svelte-1f3uhkd">时间</span>'),s5=la('<span class="filter-badge custom-id-filter svelte-1f3uhkd"><!> </span>'),o5=la('<div class="filter-status-bar global-filters svelte-1f3uhkd"><div class="status-content svelte-1f3uhkd"><!> <!> <!> <!> <!> <!> <!></div> <button class="clear-filter-btn svelte-1f3uhkd" title="清除所有筛选"><!> 清除筛选</button></div>'),l5=la('<div class="table-view-wrapper svelte-1f3uhkd"><!> <!></div> <!>',1),c5=la('<header class="page-header svelte-1f3uhkd"><div><!></div></header> <!> <!> <!> <div class="content-container svelte-1f3uhkd"><main class="main-content svelte-1f3uhkd"><!> <!> <!></main></div>',1),d5=(e,t)=>{e.target===e.currentTarget&&(_e.debug("[字段管理] 点击遮罩层关闭"),$n(t,!1))},u5=(e,t)=>{"Escape"===e.key&&(_e.debug("[字段管理] 按ESC关闭"),$n(t,!1))},h5=(e,t)=>{_e.debug("[字段管理] 点击关闭按钮"),$n(t,!1)},p5=la('<div class="column-manager-overlay svelte-1f3uhkd" role="dialog" aria-label="字段管理器" tabindex="-1"><div class="column-manager-wrapper svelte-1f3uhkd"><!> <button class="column-manager-close svelte-1f3uhkd" aria-label="关闭"><!></button></div></div>'),g5=la('<div class="tuanki-card-management-page svelte-1f3uhkd"><!></div>   <!> <!> <!> <!> <!> <!>',1);function v5(e,t){if(new.target)return Er({component:v5,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"dataStorage",7),s=Ar(t,"plugin",7),o=In(n),l=Pn(!1),c=Pn(!0),d=Pn(!0),u=Pn(!1),h=Pn(Ot([])),p=Pn(Ot(new Set)),g=Pn("");const v=s().settings.cardManagementViewPreferences||{currentView:"table",gridLayout:"fixed",gridCardAttribute:"uuid",kanbanLayoutMode:"comfortable",tableViewMode:"basic",enableCardLocationJump:!1},f=Qh.getInstance();let m=Pn(Ot(function(){const e=v.currentView;return("grid"!==e||f.canUseFeature(Hh.GRID_VIEW))&&("kanban"!==e||f.canUseFeature(Hh.KANBAN_VIEW))&&("table"===e||"grid"===e||"kanban"===e)?e:"table"}())),y=Pn(Ot(v.gridLayout)),b=Pn("status"),w=Pn(Ot(v.kanbanLayoutMode)),k=Pn(Ot(v.tableViewMode)),S=Pn(Ot(v.enableCardLocationJump)),x=Pn(Ot(v.gridCardAttribute)),_=Pn(!1),C=Pn(null),I=Pn(Ot(new Set)),D=Pn(null),T=Pn(Ot(new Set)),M=Pn(null),A=Pn(null),E=Pn(null),z=Pn(null),P=Pn(null),R=Pn(Ot(new Map)),$=Pn("memory"),O=Pn(Ot([])),L=Pn(!1),N=Pn(!1),F=Pn(void 0),B=Pn(!1);async function j(){try{s().settings.cardManagementViewPreferences||(s().settings.cardManagementViewPreferences={currentView:"table",gridLayout:"fixed",gridCardAttribute:"uuid",kanbanLayoutMode:"comfortable",tableViewMode:"basic",enableCardLocationJump:!1}),s().settings.cardManagementViewPreferences.currentView=bi(m),s().settings.cardManagementViewPreferences.gridLayout=bi(y),s().settings.cardManagementViewPreferences.gridCardAttribute=bi(x),s().settings.cardManagementViewPreferences.kanbanLayoutMode=bi(w),s().settings.cardManagementViewPreferences.tableViewMode=bi(k),s().settings.cardManagementViewPreferences.enableCardLocationJump=bi(S),await s().saveSettings()}catch(e){_e.error("保存视图偏好失败:",e)}}let U=Pn(!1),V=Pn(!1),q=Pn(!1),H=Pn(null),W=Pn(Ot([])),G=Pn("all"),Q=Pn(null),K=Pn(!1),Z=Pn("full"),Y=Pn(null),X=Pn(!1),J=Pn(null),ee=Pn(null),te=Pn(Ot([])),ne=Pn(!1),ie=Pn(!1),ae=Pn("");Ti(()=>{if(!bi(l))return;return f.isPremiumActive.subscribe(e=>{bi(l)&&$n(ne,e,!0)})});let re=Pn(1),se=Pn(25),oe=Pn(0),le=Pn(Ot([])),ce=Pn(0),de=Pn(Ot([])),ue=In(()=>null!==bi(C)||bi(I).size>0||null!==bi(D)||bi(T).size>0||null!==bi(M)||null!==bi(A)&&bi(A).size>0);Ti(()=>{if(bi(oe),!bi(l)||!bi(c))return void $n(le,[],!0);const e=bi(ye).field,t=bi(ye).direction,n="questionBank"===bi($)?bi(O):bi(h);if(!Array.isArray(n))return void $n(le,[],!0);let i=[...n];if(bi(A)&&bi(A).size>0&&(i=i.filter(e=>{const t=e.uuid;return bi(A).has(t)})),"current"===bi(G)&&bi(Q)&&(i=SS(i,bi(Q))),bi(C)&&(i=i.filter(e=>e.deckId===bi(C))),bi(I).size>0&&(i=i.filter(e=>{const t=TS(e);return bi(I).has(t)})),null!==bi(D)&&(i=i.filter(e=>(e.priority||0)===bi(D))),bi(T).size>0&&(i=i.filter(e=>Array.from(bi(T)).every(t=>_S(e.tags||[],t)))),bi(M)&&(i=function(e,t){if(!t)return e;switch(t){case"today":return e.filter(e=>{var t;if(!(null==(t=e.fsrs)?void 0:t.due))return!1;const{start:n}=zS();return("number"==typeof e.fsrs.due?e.fsrs.due:Number(e.fsrs.due))<=n+864e5});case"due-today":return e.filter(RS);case"added-today":return e.filter($S);case"edited-today":return e.filter(OS);case"reviewed-today":return e.filter(LS);case"first-review":return e.filter(NS);case"retry-today":return e.filter(FS);case"never-reviewed":return e.filter(BS);default:return e}}(i,bi(M))),bi(g).trim()){const e=bi(g).toLowerCase();i=i.filter(t=>{var n;const i=Yu(t,"front",[]).toLowerCase(),a=Yu(t,"back",[]).toLowerCase();return i.includes(e)||a.includes(e)||(null==(n=t.tags)?void 0:n.some(t=>t.toLowerCase().includes(e)))})}bi(me).status.size>0&&(i=i.filter(e=>{if(!e.fsrs)return!1;const t=Ze(e.fsrs.state);return bi(me).status.has(t)})),bi(me).decks.size>0&&(i=i.filter(e=>bi(me).decks.has(e.deckId))),bi(me).tags.size>0&&(i=i.filter(e=>Array.from(bi(me).tags).every(t=>_S(e.tags||[],t)))),bi(me).questionTypes.size>0&&(i=i.filter(e=>{const t=TS(e);return bi(me).questionTypes.has(t)})),bi(me).errorBooks.size>0&&(i=i.filter(e=>{const t=ES(e);return t&&bi(me).errorBooks.has(t)})),i.sort((n,i)=>{var a,r,s,o,l,c,d,u;let h,p;switch(e){case"front":h=Yu(n,"front",[]),p=Yu(i,"front",[]);break;case"back":h=Yu(n,"back",[]),p=Yu(i,"back",[]);break;case"status":h=Ze(null!=(r=null==(a=n.fsrs)?void 0:a.state)?r:0),p=Ze(null!=(o=null==(s=i.fsrs)?void 0:s.state)?o:0);break;case"created":h=new Date(n.created||0),p=new Date(i.created||0);break;case"modified":h=new Date(n.modified||0),p=new Date(i.modified||0);break;case"tags":h=(n.tags||[]).join(" "),p=(i.tags||[]).join(" ");break;case"obsidian_block_link":h=(null==(l=n.fields)?void 0:l.obsidian_block_link)||"",p=(null==(c=i.fields)?void 0:c.obsidian_block_link)||"";break;case"source_document":h=(null==(d=n.fields)?void 0:d.source_document)||"",p=(null==(u=i.fields)?void 0:u.source_document)||"";break;case"uuid":h=n.uuid||"",p=i.uuid||"";break;case"deck":h=Fe(n.deckId),p=Fe(i.deckId);break;default:h="",p=""}return"string"==typeof h&&"string"==typeof p&&(h=h.toLowerCase(),p=p.toLowerCase()),h<p?"asc"===t?-1:1:h>p?"asc"===t?1:-1:0}),$n(le,[...i],!0),ki(()=>{if(we&&bi(be)){null!==xe&&(clearTimeout(xe),xe=null);const e=Se;queueMicrotask(()=>{const t=Date.now()-ke,n=Math.max(0,200-t);xe=window.setTimeout(()=>{e===Se&&($n(be,!1),we=!1,xe=null)},n)})}})}),Ti(()=>{var e,t;if(!bi(l)||!bi(c))return;const n=bi(le),i=bi(re),a=bi(se);$n(ce,n.length,!0);const r=(i-1)*a,s=Math.min(n.length,r+a),o=n.slice(r,s);bi(de).length===o.length&&(null==(e=bi(de)[0])?void 0:e.uuid)===(null==(t=o[0])?void 0:t.uuid)||$n(de,o,!0)});let he=Pn(Ot({front:!0,back:!0,status:!0,deck:!0,tags:!0,priority:!0,created:!0,modified:!1,next_review:!1,retention:!1,interval:!1,difficulty:!1,review_count:!1,actions:!0,uuid:!1,obsidian_block_link:!0,source_document:!0,field_template:!0,source_document_status:!0,question_type:!1,accuracy:!1,test_attempts:!1,last_test:!1,error_level:!1,source_card:!1})),pe=Pn(Ot([...Jk]));function ve(e,t){bi(he)[e]=t;try{localStorage.setItem("tuanki-column-visibility",JSON.stringify(bi(he)))}catch(n){_e.error("保存列设置失败:",n)}}function fe(e){$n(pe,e,!0);try{localStorage.setItem("tuanki-column-order",JSON.stringify(e))}catch(t){_e.error("保存列顺序失败:",t)}}let me=Pn(Ot({status:new Set,decks:new Set,tags:new Set,questionTypes:new Set,errorBooks:new Set,searchQuery:""})),ye=Pn(Ot({field:"created",direction:"desc"})),be=Pn(!1),we=!1,ke=0,Se=0,xe=null,Ce=Pn(Ot({})),Ie=Pn(Ot([])),De=Pn(Ot([])),Te=Pn(Ot({})),Ae=Pn(Ot({})),Ee=null;Ti(()=>{if(!bi(l)||!bi(c))return void(null!==Ee&&(clearTimeout(Ee),Ee=null));if(!Array.isArray(bi(h)))return $n(Ce,{},!0),$n(Ie,[],!0),$n(De,[],!0),$n(Te,{},!0),void $n(Ae,{},!0);const e=bi(h).length>100,t=()=>{const e=bi(h).reduce((e,t)=>{if(!t.fsrs)return e;const n=Ze(t.fsrs.state);return e[n]=(e[n]||0)+1,e},{});$n(Ce,e,!0);const t=new Map;bi(h).forEach(e=>{e.deckId&&t.set(e.deckId,(t.get(e.deckId)||0)+1)}),$n(Ie,Array.from(t.entries()).map(([e,t])=>({id:e,name:Fe(e),count:t})),!0);const n=new Map;bi(h).forEach(e=>{e.tags&&e.tags.forEach(e=>{n.set(e,(n.get(e)||0)+1)})}),$n(De,Array.from(n.entries()).map(([e,t])=>({name:e,count:t})).sort((e,t)=>t.count-e.count),!0),$n(Te,function(e){const t={};for(const n of e){const e=TS(n);t[e]=(t[e]||0)+1}return t}(bi(h)),!0),$n(Ae,function(e){const t={light:0,medium:0,severe:0};for(const n of e){const e=ES(n);e&&t[e]++}return t}(bi(h)),!0)};e?(null!==Ee&&clearTimeout(Ee),Ee=window.setTimeout(()=>{t(),Ee=null},150)):t()});let ze=null;async function Pe(){var e,t;if(null==(t=null==(e=s())?void 0:e.app)?void 0:t.workspace)try{if(!ze){const e=await Promise.resolve().then(()=>Me);ze=e.VIEW_TYPE_WEAVE}const e=s().app.workspace.getLeavesOfType(ze);if(0===e.length)return void $n(K,!1);const t=e[0].getRoot(),n=s().app.workspace,i=!(t===n.rootSplit);bi(K)!==i&&$n(K,i)}catch(n){_e.error("侧边栏检测失败:",n),!1!==bi(K)&&$n(K,!1)}else $n(K,!1)}function Re(e){const t=e.split("/");return t[t.length-1].replace(/\.md$/i,"")}function $e(){if(!bi(Y))return;const e=bi(Y).clientWidth;bi(K)||e<600?$n(Z,"sidebar"):$n(Z,"full")}function Oe(){$n(X,!1)}async function Le(){try{_e.debug("🔄 [卡片管理] 开始加载卡片数据...");let e=[];const t=await r().getDecks();_e.debug(`📂 [卡片管理] 找到 ${t.length} 个牌组`);for(const i of t){const t=await r().getDeckCards(i.id);e.push(...t),_e.debug(`📁 [卡片管理] 牌组 "${i.name}": ${t.length} 张卡片`)}_e.debug(`✅ [卡片管理] 总计加载 ${e.length} 张卡片`);const n=function(e){let t=0,n=0,i=0;for(const a of e)a.stats?a.stats.errorTracking?n++:a.stats.choiceStats?t++:i++:i++;return{total:e.length,needsMigration:t,alreadyMigrated:n,noErrorData:i}}(e);n.needsMigration>0&&(_e.debug(`🔄 检测到 ${n.needsMigration} 张卡片需要迁移错题集数据`),e=function(e){return e.map(e3)}(e),_e.debug("✅ 错题集数据迁移完成"));bi(h).length;$n(h,[...e],!0)}catch(e){_e.error("❌ 加载卡片失败:",e),$n(h,[],!0),new ge.Notice(`加载卡片数据失败: ${e instanceof Error?e.message:"未知错误"}`,5e3)}}function Ne(e){if(!e)return null;try{const t=new Date(e);return isNaN(t.getTime())?null:t}catch(t){return null}}function Fe(e){const t=bi(te).find(t=>t.id===e);return(null==t?void 0:t.name)||e}Pr(()=>{var e;$n(l,!0);const t=null==(e=s().filterStateService)?void 0:e.subscribe(e=>{$n(C,e.selectedDeckId,!0),$n(I,new Set(e.selectedCardTypes),!0),$n(D,e.selectedPriority,!0),$n(T,new Set(e.selectedTags),!0),$n(M,e.selectedTimeFilter,!0)});let n;s().dataSyncService&&(n=s().dataSyncService.subscribe("cards",async e=>{await Le()},{debounce:300})),$n(H,new nk,!0),$n(W,bi(H).getAllFilters(),!0),setTimeout(async()=>{await Pe(),$e()},200);const i=async()=>{await Pe(),$e()};window.addEventListener("resize",i);let a=null;bi(Y)&&(a=new ResizeObserver(()=>{$e()}),a.observe(bi(Y)));const o=()=>{setTimeout(async()=>{await Pe(),$e()},150)};s().app.workspace.on("layout-change",o);const c=e=>{const{cardIds:t,filterName:n,parentCardPreview:i}=e.detail;$n(A,new Set(t),!0),$n(E,n,!0),f.canUseFeature(Hh.GRID_VIEW)?$n(m,"grid"):$n(m,"table"),new window.Notice(`已筛选 ${t.length} 张卡片${i?` (来自: ${i})`:""}`)};window.addEventListener("tuanki:filter-by-cards",c);(async()=>{$n(te,await r().getDecks(),!0),await Le(),$n(z,new Yk(s().app),!0),$n(P,new u3(s().app),!0),await bi(P).initialize();const e=localStorage.getItem("tuanki-column-visibility");if(e)try{const t=JSON.parse(e);$n(he,{...bi(he),...t},!0)}catch(n){_e.error("解析列设置失败:",n)}const t=localStorage.getItem("tuanki-column-order");if(t)try{const e=JSON.parse(t),n=[...Jk],i=[...e.filter(e=>n.includes(e)),...n.filter(t=>!e.includes(t))];$n(pe,i,!0)}catch(n){_e.error("解析列设置失败:",n)}$n(d,!1)})();const u=function(){var e,t;if(null==(t=null==(e=s())?void 0:e.app)?void 0:t.workspace)return n(),s().app.workspace.on("active-leaf-change",n),s().app.workspace.on("file-open",n),()=>{s().app.workspace.off("active-leaf-change",n),s().app.workspace.off("file-open",n)};function n(){const e=s().app.workspace.getActiveFile();$n(Q,e?e.path:null,!0)}}();return()=>{t&&t(),n&&n(),null!==xe&&(clearTimeout(xe),xe=null),null!==Ge&&(clearTimeout(Ge),Ge=null),null!==Ee&&(clearTimeout(Ee),Ee=null),$n(be,!1),we=!1,Be.clear(),He=[],$n(l,!1),window.removeEventListener("resize",i),window.removeEventListener("tuanki:filter-by-cards",c),s().app.workspace.off("layout-change",o),a&&a.disconnect(),u&&u(),function(){var e,t;if(bi(z))try{null==(t=(e=bi(z)).destroyAll)||t.call(e)}catch(n){_e.debug("[cleanupResources] 清理编辑器失败:",n)}Ve&&(clearInterval(Ve),Ve=null),null!==Ue&&(clearTimeout(Ue),Ue=null),bi(je)||Be.clear()}()}}),Rr(()=>{_e.debug("[卡片管理] 🗑️ 组件销毁，清理资源"),$n(c,!1)});const Be=new Map;let je=Pn(!1),Ue=null,Ve=null,qe="",He=[];let We=Pn(!1),Ge=null,Qe=0;Ti(()=>{if("table"===bi(m)){const e=Date.now(),t=e-Qe<500?300:100;Qe=e,Ge&&clearTimeout(Ge),Ge=window.setTimeout(()=>{$n(We,!0),Ge=null},t)}else Qe=Date.now(),Ge&&(clearTimeout(Ge),Ge=null)});let Ke=In(()=>{if(bi(oe),!bi(l)||!bi(c)||"table"!==bi(m))return[];if(!bi(We))return He.length>0?He:[];const e=function(e){var t,n;if(!e||0===e.length)return"empty";const i=e.slice(0,10).map(e=>e.uuid).join(",");return`${e.length}:${i}:${(null==(t=e[0])?void 0:t.modified)||""}:${(null==(n=e[e.length-1])?void 0:n.modified)||""}`}(bi(de))+`-v${bi(oe)}`;if(e===qe&&He.length>0)return He;const t=performance.now(),n=(i=bi(de)).map(e=>{var t,n,a,r,s,o,l,c,d,u,h,p,g,v,f,y,b,w,k;const S=Ne(e.modified||e.created),x=(null==(t=e.fsrs)?void 0:t.due)?Ne(e.fsrs.due):null,_=null!=(a=null==(n=e.fsrs)?void 0:n.retrievability)?a:0,C=null!=(s=null==(r=e.fsrs)?void 0:r.scheduledDays)?s:0,I=null!=(l=null==(o=e.fsrs)?void 0:o.difficulty)?l:5,D=I<4?"easy":I<7?"medium":"hard",T=null!=(d=null==(c=e.reviewHistory)?void 0:c.length)?d:0,M=bi(R).get(e.uuid),A=null==(u=e.metadata)?void 0:u.sourceCardId;let E="-";if(A&&"string"==typeof A){const e=i.find(e=>e.uuid===A);if(e){const t=Yu(e,"front",[]," / ");E=t.length>30?t.substring(0,30)+"...":t}else E=`[已删除] ${A.substring(0,8)}...`}const z=`${e.uuid}_${e.modified||""}`;let P=Be.get(z);if(!P&&(P="table"!==bi(m)?{front:"",back:""}:{front:(null==(h=e.fields)?void 0:h.front)||(null==(p=e.fields)?void 0:p.question)||(null==(g=e.content)?void 0:g.substring(0,100))||"",back:(null==(v=e.fields)?void 0:v.back)||(null==(f=e.fields)?void 0:f.answer)||""},Be.set(z,P),Be.size>1e3)){const e=[];let t=0;for(const n of Be.keys())if(e.push(n),++t>=100)break;e.forEach(e=>Be.delete(e))}return{...e,tags:e.tags?[...e.tags]:[],front:P.front,back:P.back,status:Ze(null!=(b=null==(y=e.fsrs)?void 0:y.state)?b:0),deck:Fe(e.deckId),nextReview:null==(w=e.fsrs)?void 0:w.due,sourceDocumentStatus:Ye(e),obsidian_block_link:e.sourceBlock||"-",source_document:e.sourceFile||"-",modified:S?S.toISOString():(new Date).toISOString(),next_review:x,retention:_,interval:C,difficulty:D,review_count:T,question_type:ht(e),accuracy:pt(e),accuracy_class:gt(e),test_attempts:null!=(k=null==M?void 0:M.totalAttempts)?k:0,last_test:(null==M?void 0:M.lastTestDate)?ft(M.lastTestDate):"-",error_level:vt(e),source_card:E}});var i;const a=performance.now()-t;return _e.debug(`[性能优化] 卡片转换耗时: ${a.toFixed(2)}ms, 卡片数量: ${bi(de).length}, 每页: ${bi(se)}`),qe=e,He=n,n});function Ze(e){switch(e){case 0:return"new";case 1:return"learning";case 2:return"review";case 3:return"relearning";default:return"unknown"}}function Ye(e){var t;if(e.sourceFile){return s().app.vault.getAbstractFileByPath(e.sourceFile)?"存在":"已删除"}if(null==(t=e.customFields)?void 0:t.obsidianFilePath){const t=e.customFields.obsidianFilePath;return t&&"string"==typeof t&&s().app.vault.getAbstractFileByPath(t)?"存在":"已删除"}return"无源文档"}async function Xe(e){var t,n;try{let i,a;if($n(je,!0),null!==Ue&&clearTimeout(Ue),Ue=window.setTimeout(()=>{$n(je,!1),Ue=null},3e3),e.sourceFile?(i=e.sourceFile,a=null==(t=e.sourceBlock)?void 0:t.replace(/^\^/,"")):(null==(n=e.customFields)?void 0:n.obsidianFilePath)&&(i=e.customFields.obsidianFilePath,a=e.customFields.blockId),!i)return new ge.Notice("此卡片没有关联的源文档"),void $n(je,!1);const r=s().app.vault.getAbstractFileByPath(i);if(!r)return new ge.Notice("源文档已被删除"),void $n(je,!1);if(a){const e=`${i}#^${a}`;await s().app.workspace.openLinkText(e,"",!1),await new Promise(e=>requestAnimationFrame(()=>e(void 0)));const t=s().app.workspace.getActiveViewOfType(ge.MarkdownView);if(t&&t.editor){const e=t.editor,n=e.getValue(),i=new RegExp(`\\^${a}(?![A-Za-z0-9_-])`,"gm").exec(n);if(i){const a=n.substring(0,i.index).split("\n").length-1;e.setCursor({line:a,ch:0}),e.scrollIntoView({from:{line:a,ch:0},to:{line:a,ch:0}},!0);const r=e.getLine(a),s=r.match(/\s*\^\w+$/),o=s?r.length-s[0].length:r.length;e.setSelection({line:a,ch:0},{line:a,ch:o}),setTimeout(()=>{t&&t.editor&&(t.editor.setCursor({line:a,ch:0}),t.editor.scrollIntoView({from:{line:a,ch:0},to:{line:a,ch:0}},!0))},800),new ge.Notice("✅ 已定位到源文档块")}else new ge.Notice("无法找到源文本块")}}else{const e=s().app.workspace.getLeaf(!1);await e.openFile(r),new ge.Notice("已打开源文档")}}catch(i){_e.error("跳转到源文档失败:",i),new ge.Notice("跳转失败")}}async function Je(){const e=s().app.vault.getMarkdownFiles();function t(t){return e.find(e=>e.basename===t||e.name===t||e.name===`${t}.md`)}async function n(e){var n;try{const i=e.fields||{},a=i.obsidian_block_link;let r,o;if("string"==typeof a&&a.includes("#^")){const e=a.match(/\[\[([^#\]]+)#\^([^\]]+)\]\]/);if(e){const n=e[1];o=e[2];const i=t(n);r=null==i?void 0:i.path}}else if("string"==typeof a&&a.startsWith("^")){o=a.replace(/^\^/,"");const e="string"==typeof i.source_document?i.source_document:void 0;e&&(r=null==(n=t(e))?void 0:n.path),r||"string"!=typeof i.source_file||(r=i.source_file)}if(!r)return"无源文档";if(!o)return"缺失";const l=s().app.vault.getAbstractFileByPath(r);if(!l)return"缺失";const c=await s().app.vault.read(l);return new RegExp(`\\^${o}(?![A-Za-z0-9_-])`).test(c)?"存在":"缺失"}catch(i){return _e.warn("[Scan] 检查卡片失败",i),"缺失"}}let i=0,a=0,r=0;for(let s=0;s<bi(h).length;s++){const e=await n(bi(h)[s]);bi(h)[s].sourceDocumentStatus=e,"存在"===e?i++:"缺失"===e?a++:r++}$n(h,[...bi(h)],!0);try{new window.Notice(`扫描完成：存在 ${i}，缺失 ${a}，无源文档 ${r}`)}catch(o){_e.debug(`扫描完成：存在 ${i}，缺失 ${a}，无源文档 ${r}`)}}function et(e){$n(g,e,!0)}function tt(e){if(e){const e=[...bi(de)].map(e=>e.uuid);$n(p,new Set(e),!0)}else $n(p,new Set,!0)}function nt(){$n(p,new Set,!0)}function it(e){$n(re,e,!0)}function at(e){$n(se,e,!0),$n(re,1)}function rt(){const e=Array.from(bi(p));_e.debug("更换牌组:",e),0!==e.length?$n(U,!0):new ge.Notice("请先选择要更换牌组的卡片")}function st(){const e=Array.from(bi(p));if(_e.debug("批量复制:",e),0===e.length)return void new ge.Notice("请先选择要复制的卡片");const t=bi(de).filter(t=>e.includes(t.uuid)).map(e=>{var t,n,i,a,r;const s=bi(te).find(t=>t.id===e.deckId);return`正面: ${(null==(t=e.fields)?void 0:t.front)||(null==(n=e.fields)?void 0:n.question)||""}\n背面: ${(null==(i=e.fields)?void 0:i.back)||(null==(a=e.fields)?void 0:a.answer)||""}\n标签: ${(null==(r=e.tags)?void 0:r.join(", "))||"无"}\n牌组: ${(null==s?void 0:s.name)||"默认"}\n---`}).join("\n");navigator.clipboard.writeText(t).then(()=>{new ge.Notice(`已复制 ${e.length} 张卡片到剪贴板`)}).catch(()=>{new ge.Notice("复制失败，请重试")})}function ot(){const e=Array.from(bi(p));_e.debug("添加标签:",e),0!==e.length?$n(V,!0):new ge.Notice("请先选择要添加标签的卡片")}function lt(){const e=Array.from(bi(p));_e.debug("删除标签:",e),0!==e.length?$n(q,!0):new ge.Notice("请先选择要删除标签的卡片")}async function ct(){const e=Array.from(bi(p));if(_e.debug("批量删除:",e,"数据源:",bi($)),0===e.length)return void new ge.Notice("请先选择要删除的卡片");if(confirm(`确定要删除选中的 ${e.length} 张卡片吗？\n\n此操作不可撤销！`)){let n=0,i=0;if("questionBank"===bi($)){if(_e.debug("使用题库存储删除卡片"),!bi(P))return void new ge.Notice("题库存储服务未初始化");const a=new Map;for(const t of e){const e=bi(O).find(e=>e.uuid===t);if(!e){_e.warn(`未找到题库卡片: ${t}`),i++;continue}const n=e.deckId;a.has(n)||a.set(n,[]),a.get(n).push(e)}for(const[e,r]of a)try{const t=(await bi(P).loadBankQuestions(e)).filter(e=>!r.find(t=>t.uuid===e.uuid));await bi(P).saveBankQuestions(e,t),_e.debug(`成功从题库 ${e} 删除 ${r.length} 张卡片`),n+=r.length}catch(t){_e.error(`删除题库 ${e} 中的卡片失败:`,t),i+=r.length}await dt()}else{_e.debug("使用记忆存储删除卡片");for(const a of e){if(bi(h).find(e=>e.uuid===a))try{await r().deleteCard(a),_e.debug(`成功删除记忆卡片: ${a}`),n++}catch(t){_e.error(`删除记忆卡片失败: ${a}`,t),i++}else _e.warn(`未找到记忆卡片: ${a}`),i++}await Le()}new ge.Notice(`已删除 ${n} 张卡片${i?`，失败 ${i}`:""}`),nt()}}async function dt(){var e,t,n;if(bi(P)){$n(L,!0);try{const i=await bi(P).loadBanks();_e.debug(`[QuestionBank] 加载了${i.length}个题库`);const a=new Map;for(const e of i){const t=await bi(P).loadBankQuestions(e.id);for(const e of t)a.set(e.uuid,e)}_e.debug(`[QuestionBank] 加载了${a.size}张实际存在的题目`);const r=await bi(P).loadAllSessions(),s=new Map;for(const o of r)for(const i of o.questions){const r=i.questionId||(null==(e=i.question)?void 0:e.uuid);r&&(a.has(r)&&(null==(n=null==(t=i.question)?void 0:t.stats)?void 0:n.testStats)&&s.set(r,i.question.stats.testStats))}$n(O,Array.from(a.values()),!0),$n(R,s,!0),_e.debug(`[QuestionBank] 最终加载了${bi(O).length}张题目卡片`),ih(`已加载 ${bi(O).length} 张题目卡片`,"success")}catch(i){_e.error("[QuestionBank] 加载失败:",i),ih("加载刷题数据失败","error")}finally{$n(L,!1)}}else _e.error("[QuestionBank] Storage未初始化")}async function ut(){const e="memory"===bi($)?"questionBank":"memory";"questionBank"===e&&0===bi(O).length&&await dt(),$n($,e,!0),s().filterStateService.updateFilter({dataSource:e}),"questionBank"===bi($)?($n(k,"questionBank"),bi(he).question_type=!0,bi(he).accuracy=!0,bi(he).test_attempts=!0,bi(he).last_test=!0,bi(he).error_level=!0,bi(he).source_card=!0,bi(he).next_review=!1,bi(he).retention=!1,bi(he).interval=!1,bi(he).difficulty=!1,bi(he).review_count=!1):($n(k,"basic"),bi(he).question_type=!1,bi(he).accuracy=!1,bi(he).test_attempts=!1,bi(he).last_test=!1,bi(he).error_level=!1,bi(he).source_card=!1),bi(p).clear(),ih("questionBank"===bi($)?"切换到刷题牌组数据":"切换到记忆学习数据","success")}function ht(e){var t,n;return{single_choice:"📝 单选",multiple_choice:"☑️ 多选",cloze:"📋 填空",short_answer:"✍️ 问答"}[null==(n=null==(t=e.metadata)?void 0:t.questionMetadata)?void 0:n.type]||"❓ 未知"}function pt(e){const t=bi(R).get(e.uuid);if(!t)return"-";return`${Math.round(100*t.accuracy)}%`}function gt(e){const t=bi(R).get(e.uuid);if(!t)return"";const n=Math.round(100*t.accuracy);return n>=80?"accuracy-high":n>=60?"accuracy-medium":"accuracy-low"}function vt(e){const t=bi(R).get(e.uuid);if(!t||!t.isInErrorBook)return"-";const n=t.incorrectAttempts;return n>=5?"🔴 高频":n>=3?"🟡 常见":"🟢 轻度"}function ft(e){const t=new Date(e),n=(new Date).getTime()-t.getTime(),i=Math.floor(n/1e3),a=Math.floor(i/60),r=Math.floor(a/60),s=Math.floor(r/24);return s>0?`${s}天前`:r>0?`${r}小时前`:a>0?`${a}分钟前`:"刚刚"}function mt(){s().openCreateCardModal()}function yt(e){wt(e)}async function bt(e){_e.debug("[TuankiCardManagement] 删除单个卡片:",e,"数据源:",bi($));const t=("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e);if(!t)return void _e.error("[TuankiCardManagement] 未找到要删除的卡片:",e,"数据源:",bi($));const n=Yu(t,"front",[]," / ");if(confirm(`确定要删除卡片 "${n}" 吗？`))try{if("questionBank"===bi($)){if(!bi(P))return void ih("题库存储服务未初始化","error");const n=t.deckId,i=(await bi(P).loadBankQuestions(n)).filter(t=>t.uuid!==e);await bi(P).saveBankQuestions(n,i),await dt(),_e.debug(`成功从题库 ${n} 删除卡片 ${e}`)}else $n(h,bi(h).filter(t=>t.uuid!==e),!0),await r().deleteCard(e),Le().catch(e=>{_e.error("重新加载卡片失败:",e)});ih("卡片已删除","success")}catch(i){_e.error("删除卡片失败:",i),"questionBank"===bi($)?await dt():await Le(),ih("删除失败，请重试","error")}}function wt(e){_e.debug("[TuankiCardManagementPage] 开始全局编辑:",e,"数据源:",bi($));for(const[n]of Be)n.startsWith(e)&&Be.delete(n);const t=("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e);t?s().openEditCardModal(t,{onSave:xt,onCancel:()=>{_e.debug("[TuankiCardManagementPage] 编辑取消")}}):_e.error("[TuankiCardManagementPage] 未找到要编辑的卡片:",e,"数据源:",bi($))}async function xt(e){try{ih("卡片保存成功","success"),"questionBank"===bi($)&&dt().catch(e=>{_e.error("后台加载题库卡片失败:",e),ih("数据同步失败，请手动刷新","error")})}catch(t){_e.error("临时文件编辑保存失败:",t),ih("保存失败","error")}}function _t(e){_e.debug("[TuankiCardManagement] 查看卡片:",e,"数据源:",bi($));const t=("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e);t?($n(F,t,!0),$n(N,!0)):_e.error("[TuankiCardManagement] 未找到要查看的卡片:",e,"数据源:",bi($))}function Ct(){$n(N,!1),$n(F,void 0)}async function It(e,t){_e.debug("[TuankiCardManagement] 更新卡片标签:",e,t,"数据源:",bi($));const n=("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e);if(!n)return _e.error("[TuankiCardManagement] 未找到要更新标签的卡片:",e,"数据源:",bi($)),void ih("卡片数据不存在","error");try{if("questionBank"===bi($)){if(!bi(P))return void ih("题库存储服务未初始化","error");const i=n.deckId,a=(await bi(P).loadBankQuestions(i)).map(n=>n.uuid===e?{...n,tags:t,modified:(new Date).toISOString()}:n);await bi(P).saveBankQuestions(i,a),await dt(),Ln(oe),_e.debug("[TuankiCardManagement] 数据版本更新(题库):",bi(oe))}else{const i={...n,tags:t,modified:(new Date).toISOString()},a=await r().updateCard(i);if(_e.debug("[TuankiCardManagement] 数据库保存结果:",a.success),!a.success)throw new Error(a.error||"保存失败");for(const[t]of Be)t.startsWith(e)&&Be.delete(t);qe="",He=[],await Le(),Ln(oe),_e.debug("[TuankiCardManagement] 数据版本更新:",bi(oe))}ih("标签更新成功","success")}catch(i){_e.error("[TuankiCardManagement] 标签更新失败:",i),ih("标签更新失败","error")}}async function Dt(e,t){_e.debug("[TuankiCardManagement] 更新卡片优先级:",e,t,"数据源:",bi($));const n=("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e);if(!n)return _e.error("[TuankiCardManagement] 未找到要更新优先级的卡片:",e,"数据源:",bi($)),void ih("卡片数据不存在","error");try{if("questionBank"===bi($)){if(!bi(P))return void ih("题库存储服务未初始化","error");const i=n.deckId,a=(await bi(P).loadBankQuestions(i)).map(n=>n.uuid===e?{...n,priority:t,modified:(new Date).toISOString()}:n);await bi(P).saveBankQuestions(i,a),await dt()}else{const e={...n,priority:t,modified:(new Date).toISOString()};await r().updateCard(e),await Le()}ih("优先级更新成功","success")}catch(i){_e.error("[TuankiCardManagement] 优先级更新失败:",i),ih("优先级更新失败","error")}}async function Tt(e,t="move"){var n;const i=Array.from(bi(p));try{_e.debug("🔄 开始批量更换牌组:",{targetDeckId:e,operationType:t,cardCount:i.length});const s=bi(h).filter(e=>i.includes(e.uuid));let o;if("copy"===t){_e.debug("📋 执行复制操作");const{generateUUID:t}=require("../../utils/helpers"),n=s.map(n=>({...n,uuid:t(),deckId:e,created:(new Date).toISOString(),modified:(new Date).toISOString()}));let i=0,l=0;const c=[];for(const e of n)try{await r().saveCard(e),i++}catch(a){l++,c.push({card:e,error:a})}o={success:i,failed:l,errors:c}}else{_e.debug("➡️ 执行移动操作");let t=0,i=0;const l=[],c=new Map;for(const e of s){const t=e.deckId;c.has(t)||c.set(t,[]),c.get(t).push(e)}for(const[s,o]of c)try{const i=await r().getDeckCards(s),a=await r().getDeckCards(e),l=new Set(o.map(e=>e.uuid)),c=i.filter(e=>!l.has(e.uuid)),d=(new Date).toISOString(),u=o.map(t=>({...t,deckId:e,modified:d})),h=[...a,...u];await r().saveDeckCards(s,c),await r().saveDeckCards(e,h);const p=null==(n=r().plugin)?void 0:n.dataSyncService;p&&await p.notifyChange({type:"cards",action:"update",ids:o.map(e=>e.uuid),metadata:{sourceDeckId:s,targetDeckId:e}}),t+=o.length,_e.debug(`✅ 已从牌组 ${s} 移动 ${o.length} 张卡片到 ${e}`)}catch(a){i+=o.length,o.forEach(e=>{l.push({card:e,error:a instanceof Error?a.message:"移动失败"})}),_e.error("[BatchMove] 移动失败:",a)}o={success:t,failed:i,errors:l}}$n(U,!1),nt();const l="copy"===t?"复制":"移动";0===o.failed?ih(`✅ 成功将 ${o.success} 张卡片${l}到新牌组`,"success"):(ih(`⚠️ ${l}完成：成功 ${o.success} 张，失败 ${o.failed} 张`,"warning"),_e.error(`[Batch${"copy"===t?"Copy":"Move"}] 失败详情:`,o.errors)),await Le()}catch(a){_e.error("批量更换牌组失败:",a),ih("❌ 批量更换牌组失败","error")}}function Mt(){$n(U,!1)}async function At(e){const t=Array.from(bi(p));try{_e.debug("开始批量添加标签:",{tags:e,cardCount:t.length,dataSource:bi($)});const i=("questionBank"===bi($)?bi(O):bi(h)).filter(e=>t.includes(e.uuid));if("questionBank"===bi($)){if(!bi(P))return void ih("题库存储服务未初始化","error");let t=0,a=0;const r=new Map;for(const e of i){const t=e.deckId;r.has(t)||r.set(t,[]),r.get(t).push(e)}for(const[i,s]of r)try{const n=(await bi(P).loadBankQuestions(i)).map(t=>{if(s.some(e=>e.uuid===t.uuid)){const n=t.tags||[],i=[...new Set([...n,...e])];return{...t,tags:i,modified:(new Date).toISOString()}}return t});await bi(P).saveBankQuestions(i,n),t+=s.length}catch(n){_e.error(`更新题库 ${i} 失败:`,n),a+=s.length}await dt(),0===a?ih(`✅ 成功为 ${t} 张卡片添加标签`,"success"):ih(`⚠️ 添加完成：成功 ${t} 张，失败 ${a} 张`,"warning")}else{const t=await jS(i,t=>{const n=t.tags||[],i=[...new Set([...n,...e])];return{...t,tags:i,modified:(new Date).toISOString()}},r());await Le(),0===t.failed?ih(`✅ 成功为 ${t.success} 张卡片添加标签`,"success"):(ih(`⚠️ 添加完成：成功 ${t.success} 张，失败 ${t.failed} 张`,"warning"),_e.error("[BatchAddTags] 失败详情:",t.errors))}$n(V,!1),nt()}catch(n){_e.error("批量添加标签失败:",n),ih("❌ 批量添加标签失败","error")}}function Et(){$n(V,!1)}async function Rt(e){const t=Array.from(bi(p));try{_e.debug("🔄 开始批量删除标签:",{tags:e,cardCount:t.length,dataSource:bi($)});const i=("questionBank"===bi($)?bi(O):bi(h)).filter(e=>t.includes(e.uuid));if("questionBank"===bi($)){if(!bi(P))return void ih("题库存储服务未初始化","error");let t=0,a=0;const r=new Map;for(const e of i){const t=e.deckId;r.has(t)||r.set(t,[]),r.get(t).push(e)}for(const[i,s]of r)try{const n=(await bi(P).loadBankQuestions(i)).map(t=>{if(s.some(e=>e.uuid===t.uuid)){const n=(t.tags||[]).filter(t=>!e.includes(t));return{...t,tags:n,modified:(new Date).toISOString()}}return t});await bi(P).saveBankQuestions(i,n),t+=s.length}catch(n){_e.error(`更新题库 ${i} 失败:`,n),a+=s.length}await dt(),0===a?ih(`✅ 成功从 ${t} 张卡片中删除标签`,"success"):ih(`⚠️ 删除完成：成功 ${t} 张，失败 ${a} 张`,"warning")}else{const t=await jS(i,t=>{const n=(t.tags||[]).filter(t=>!e.includes(t));return{...t,tags:n,modified:(new Date).toISOString()}},r());await Le(),0===t.failed?ih(`✅ 成功从 ${t.success} 张卡片中删除标签`,"success"):(ih(`⚠️ 删除完成：成功 ${t.success} 张，失败 ${t.failed} 张`,"warning"),_e.error("[BatchRemoveTags] 失败详情:",t.errors))}$n(q,!1),nt()}catch(n){_e.error("批量删除标签失败:",n),ih("❌ 批量删除标签失败","error")}}function $t(){$n(q,!1)}async function Lt(e){if("grid"===e&&!f.canUseFeature(Hh.GRID_VIEW))return $n(ae,Hh.GRID_VIEW,!0),void $n(ie,!0);if("kanban"===e&&!f.canUseFeature(Hh.KANBAN_VIEW))return $n(ae,Hh.KANBAN_VIEW,!0),void $n(ie,!0);$n(u,!0);const t=Date.now();$n(m,e,!0),await j(),await new Promise(e=>requestAnimationFrame(e));const n=Date.now()-t;n<800&&await new Promise(e=>setTimeout(e,800-n)),$n(u,!1)}async function Nt(e){$n(y,e,!0),await j()}async function Ft(e){$n(k,e,!0),_e.debug("[TableViewMode] 模式已切换为:",e),await j()}async function Bt(e){$n(w,e,!0),await j()}function jt(e){if(bi(S))return void Xe(e);const t=new Set(bi(p));t.has(e.uuid)?t.delete(e.uuid):t.add(e.uuid),$n(p,t,!0)}async function Ut(){$n(S,!bi(S)),await j(),bi(S)&&bi(p).size>0?($n(p,new Set,!0),ih("✅ 已启用定位跳转模式\n点击卡片将跳转到源文档","success")):bi(S)?ih("✅ 已启用定位跳转模式\n点击卡片将跳转到源文档","success"):ih("❌ 已禁用定位跳转模式\n恢复单击选中、双击编辑功能","info")}function Vt(){$n(_,!bi(_))}async function qt(e){$n(x,e,!0),$n(_,!1),await j()}function Ht(e){wt(e.uuid)}function Wt(e){bt(e.uuid)}function Zt(e){_t(e.uuid)}function Yt(e){yt(e.uuid)}function Xt(e){ih(`开始学习 ${e.length} 张卡片`,"info")}async function Jt(e){try{const t=await r().saveCard(e);if(!t.success)throw new Error(t.error||"保存失败");const n=bi(h).findIndex(t=>t.uuid===e.uuid);-1!==n?(bi(h)[n]=e,$n(h,[...bi(h)],!0),ih("卡片已更新","success")):($n(h,[...bi(h),e],!0),ih("卡片已创建","success"))}catch(t){_e.error("保存卡片失败:",t),ih("保存卡片失败","error"),await Le()}}async function en(e){try{const t=bi(h).find(t=>t.uuid===e);if(!t)return;const n=Yu(t,"front",[]," / ");if(!confirm(`确定要删除卡片 "${n}" 吗？`))return;await r().deleteCard(e),$n(h,bi(h).filter(t=>t.uuid!==e),!0),setTimeout(()=>{ih("卡片已删除","success")},1e3)}catch(t){_e.error("删除卡片失败:",t),ih("删除卡片失败","error"),await Le()}}var tn={get dataStorage(){return r()},set dataStorage(e){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},nn=g5(),an=Qt(nn),rn=Gt(an),sn=e=>{var t=v3(),n=Gt(t);{let e=In(()=>bi(d)?"正在加载卡片数据...":"grid"===bi(m)?"正在加载网格视图...":"kanban"===bi(m)?"正在加载看板视图...":"正在加载表格视图...");Qg(n,{get message(){return bi(e)}})}zt(t),pa(e,t)},on=e=>{var t=c5(),n=Qt(t),i=Gt(n);let a;var l=Gt(i),u=e=>{var t=m3(),n=Qt(t),i=Gt(n);i.__click=[p3,X],Ng(Gt(i),{name:"ellipsis-h",size:16}),zt(i),kr(i,e=>$n(J,e),()=>bi(J)),zt(n);var a=Kt(n,2);let r;a.__click=[h3,G];var s=Gt(a);{let e=In(()=>"current"===bi(G)?"file-text":"file");Ng(s,{get name(){return bi(e)},size:16})}zt(a);var l=Kt(a,2);let c;l.__click=Ut,Ng(Gt(l),{name:"bullseye",size:16}),zt(l);var d=Kt(l,2);let u;d.__click=ut;var h=Gt(d),p=e=>{Ng(e,{name:"loader",size:16})},v=e=>{Ng(e,{name:"book-open",size:16})};xa(h,e=>{bi(L)?e(p):e(v,!1)}),zt(d);var f=Kt(d,2);f.__click=()=>{_e.debug("[搜索] 搜索按钮点击");const e=document.querySelector(".toolbar-search-input-hidden");e?(e.style.display="block",e.style.position="absolute",e.style.right="50px",e.style.top="50%",e.style.transform="translateY(-50%)",e.style.width="220px",e.style.zIndex="1000",e.focus(),_e.debug("[搜索] 显示并聚焦搜索框")):_e.error("[搜索] 未找到搜索输入框")},Ng(Gt(f),{name:"search",size:16}),zt(f);var m=Kt(f,2);Za(m),m.__input=[f3,et],zi((e,t,n,s,o,h)=>{er(i,"title",e),r=Fa(a,1,"toolbar-button svelte-1f3uhkd",null,r,t),a.disabled=!bi(Q),er(a,"title",n),c=Fa(l,1,"toolbar-button svelte-1f3uhkd",null,c,s),er(l,"title",bi(S)?"点击关闭定位跳转（恢复卡片选中功能）":"点击启用定位跳转（点击卡片将跳转到源文档）"),u=Fa(d,1,"toolbar-button svelte-1f3uhkd",null,u,o),d.disabled=bi(L),er(d,"title","questionBank"===bi($)?`刷题数据 (${bi(O).length}张)`:"切换到刷题数据"),er(f,"title",h)},[()=>bi(o)("cardManagement.more"),()=>({active:"current"===bi(G)}),()=>bi(Q)?"current"===bi(G)?`仅显示: ${Re(bi(Q))}`:"显示全部文档":"请先打开一个文档",()=>({active:bi(S)}),()=>({active:"questionBank"===bi($)}),()=>bi(o)("cardManagement.search")]),na("blur",m,e=>{setTimeout(()=>{e.target.style.display="none"},200)}),pr(m,()=>bi(g),e=>$n(g,e)),pa(e,t)},h=e=>{var t=A3(),n=Qt(t),i=Gt(n);{let e=In(()=>"table"===bi(m)?"primary":"secondary");Hg(i,{get variant(){return bi(e)},size:"sm",onclick:()=>Lt("table"),tooltip:"表格视图",children:(e,t)=>{Ng(e,{name:"list",size:16})},$$slots:{default:!0}})}var a=Kt(i,2);{let e=In(()=>"grid"===bi(m)?"primary":"secondary");Hg(a,{get variant(){return bi(e)},size:"sm",onclick:()=>Lt("grid"),tooltip:"网格视图",children:(e,t)=>{var n=y3(),i=Qt(n);Ng(i,{name:"th",size:16});var a=Kt(i,2),r=e=>{d3(e,{variant:"lock",size:"small"})};xa(a,e=>{bi(ne)||e(r)}),pa(e,n)},$$slots:{default:!0}})}var r=Kt(a,2);{let e=In(()=>"kanban"===bi(m)?"primary":"secondary");Hg(r,{get variant(){return bi(e)},size:"sm",onclick:()=>Lt("kanban"),tooltip:"看板视图",children:(e,t)=>{var n=b3(),i=Qt(n);Ng(i,{name:"columns",size:16});var a=Kt(i,2),r=e=>{d3(e,{variant:"lock",size:"small"})};xa(a,e=>{bi(ne)||e(r)}),pa(e,n)},$$slots:{default:!0}})}zt(n);var s=Kt(n,2),l=e=>{var t=S3(),n=Gt(t),i=e=>{var t=w3(),n=Qt(t);{let e=In(()=>"basic"===bi(k)?"primary":"secondary");Hg(n,{get variant(){return bi(e)},size:"sm",onclick:()=>Ft("basic"),tooltip:"基础信息模式",children:(e,t)=>{Ng(e,{name:"table",size:16})},$$slots:{default:!0}})}var i=Kt(n,2);{let e=In(()=>"review"===bi(k)?"primary":"secondary");Hg(i,{get variant(){return bi(e)},size:"sm",onclick:()=>Ft("review"),tooltip:"复习历史模式",children:(e,t)=>{Ng(e,{name:"bar-chart-2",size:16})},$$slots:{default:!0}})}pa(e,t)},a=e=>{var t=k3();Ng(Gt(t),{name:"book-open",size:16}),Pt(2),zt(t),pa(e,t)};xa(n,e=>{"memory"===bi($)?e(i):e(a,!1)}),zt(t),pa(e,t)},c=e=>{var t=ha(),n=Qt(t),i=e=>{var t=x3(),n=Gt(t);{let e=In(()=>"fixed"===bi(y)?"primary":"secondary");Hg(n,{get variant(){return bi(e)},size:"sm",onclick:()=>Nt("fixed"),tooltip:"固定高度",children:(e,t)=>{Ng(e,{name:"th",size:16})},$$slots:{default:!0}})}var i=Kt(n,2);{let e=In(()=>"masonry"===bi(y)?"primary":"secondary");Hg(i,{get variant(){return bi(e)},size:"sm",onclick:()=>Nt("masonry"),tooltip:"瀑布流",children:(e,t)=>{Ng(e,{name:"th-large",size:16})},$$slots:{default:!0}})}zt(t),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=_3(),n=Gt(t);{let e=In(()=>"compact"===bi(w)?"primary":"secondary");Hg(n,{get variant(){return bi(e)},size:"sm",onclick:()=>Bt("compact"),tooltip:"紧凑布局",children:(e,t)=>{Ng(e,{name:"compress",size:16})},$$slots:{default:!0}})}var i=Kt(n,2);{let e=In(()=>"comfortable"===bi(w)?"primary":"secondary");Hg(i,{get variant(){return bi(e)},size:"sm",onclick:()=>Bt("comfortable"),tooltip:"舒适布局",children:(e,t)=>{Ng(e,{name:"square",size:16})},$$slots:{default:!0}})}var a=Kt(i,2);{let e=In(()=>"spacious"===bi(w)?"primary":"secondary");Hg(a,{get variant(){return bi(e)},size:"sm",onclick:()=>Bt("spacious"),tooltip:"宽敞布局",children:(e,t)=>{Ng(e,{name:"expand",size:16})},$$slots:{default:!0}})}zt(t),pa(e,t)};xa(n,e=>{"kanban"===bi(m)&&e(i)},!0),pa(e,t)};xa(n,e=>{"grid"===bi(m)?e(i):e(a,!1)},!0),pa(e,t)};xa(s,e=>{"table"===bi(m)?e(l):e(c,!1)});var d=Kt(s,2),u=Gt(d);Hg(u,{variant:"secondary",size:"sm",onclick:Je,tooltip:"扫描孤儿卡片",children:(e,t)=>{Ng(e,{name:"refresh",size:16})},$$slots:{default:!0}});var h=Kt(u,2),p=e=>{Hg(e,{variant:"secondary",size:"sm",onclick:()=>{_e.debug("[字段管理] 完整模式按钮点击，当前状态:",bi(B)),$n(B,!bi(B)),_e.debug("[字段管理] 新状态:",bi(B))},tooltip:"字段管理",children:(e,t)=>{Ng(e,{name:"columns",size:16})},$$slots:{default:!0}})},v=e=>{var t=ha(),n=Qt(t),i=e=>{Hg(e,{variant:"secondary",size:"sm",onclick:()=>{const e=document.querySelector(".tuanki-kanban-view");if(e){const t=e.querySelector('[title="列设置"]');t&&t.click()}},tooltip:"看板列设置",children:(e,t)=>{Ng(e,{name:"sliders",size:16})},$$slots:{default:!0}})},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=C3(),n=Gt(t);{let e=In(()=>bi(o)("cardManagement.gridAttributeSelector.tooltip"));Hg(n,{variant:"secondary",size:"sm",onclick:Vt,get tooltip(){return bi(e)},children:(e,t)=>{Ng(e,{name:"tag",size:16})},$$slots:{default:!0}})}zt(t),kr(t,e=>$n(ee,e),()=>bi(ee)),pa(e,t)};xa(n,e=>{"grid"===bi(m)&&e(i)},!0),pa(e,t)};xa(n,e=>{"kanban"===bi(m)?e(i):e(a,!1)},!0),pa(e,t)};xa(h,e=>{"table"===bi(m)?e(p):e(v,!1)});var f=Kt(h,2);{let e=In(()=>bi(S)?"primary":"secondary"),t=In(()=>bi(S)?"关闭定位跳转（恢复卡片选中功能）":"启用定位跳转（点击卡片将跳转到源文档）");Hg(f,{get variant(){return bi(e)},size:"sm",onclick:Ut,get tooltip(){return bi(t)},children:(e,t)=>{Ng(e,{name:"bullseye",size:16})},$$slots:{default:!0}})}zt(d);var b=Kt(d,2);{let e=In(()=>"questionBank"===bi($)?"primary":"secondary"),t=In(()=>"questionBank"===bi($)?"切换到记忆学习数据":"切换到刷题牌组数据");Hg(b,{get variant(){return bi(e)},size:"md",onclick:ut,get disabled(){return bi(L)},get tooltip(){return bi(t)},children:(e,t)=>{var n=D3(),i=Qt(n),a=e=>{Ng(e,{name:"loader",size:16})},r=e=>{Ng(e,{name:"book-open",size:16})};xa(i,e=>{bi(L)?e(a):e(r,!1)});var s=Kt(i,2),o=e=>{var t=I3(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(O).length)),pa(e,t)};xa(s,e=>{"questionBank"===bi($)&&bi(O).length>0&&e(o)}),pa(e,n)},$$slots:{default:!0}})}var x=Kt(b,2);Za(x),x.__input=[T3,et],Hg(Kt(x,2),{variant:"primary",size:"md",onclick:mt,children:(e,t)=>{var n=M3();Ng(Qt(n),{name:"plus",size:16}),Pt(),pa(e,n)},$$slots:{default:!0}}),pr(x,()=>bi(g),e=>$n(g,e)),pa(e,t)};xa(l,e=>{"sidebar"===bi(Z)?e(u):e(h,!1)}),zt(i),zt(n),kr(n,e=>$n(Y,e),()=>bi(Y));var v=Kt(n,2),f=e=>{ff(e,{get anchor(){return bi(ee)},placement:"bottom-start",offset:4,onClose:()=>$n(_,!1),get show(){return bi(_)},set show(e){$n(_,e,!0)},children:(e,t)=>{var n=L3(),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2);let s;r.__click=[E3,qt];var l=Gt(r);{let e=In(()=>"none"===bi(x)?"check-circle":"circle");Ng(l,{get name(){return bi(e)},size:14})}var c=Kt(l,2),d=Gt(c,!0);zt(c),zt(r);var u=Kt(r,2);let h;u.__click=[z3,qt];var p=Gt(u);{let e=In(()=>"uuid"===bi(x)?"check-circle":"circle");Ng(p,{get name(){return bi(e)},size:14})}var g=Kt(p,2),v=Gt(g,!0);zt(g),zt(u);var f=Kt(u,2);let m;f.__click=[P3,qt];var y=Gt(f);{let e=In(()=>"source"===bi(x)?"check-circle":"circle");Ng(y,{get name(){return bi(e)},size:14})}var b=Kt(y,2),w=Gt(b,!0);zt(b),zt(f);var k=Kt(f,2);let S;k.__click=[R3,qt];var _=Gt(k);{let e=In(()=>"priority"===bi(x)?"check-circle":"circle");Ng(_,{get name(){return bi(e)},size:14})}var C=Kt(_,2),I=Gt(C,!0);zt(C),zt(k);var D=Kt(k,2);let T;D.__click=[$3,qt];var M=Gt(D);{let e=In(()=>"retention"===bi(x)?"check-circle":"circle");Ng(M,{get name(){return bi(e)},size:14})}var A=Kt(M,2),E=Gt(A,!0);zt(A),zt(D);var z=Kt(D,2);let P;z.__click=[O3,qt];var R=Gt(z);{let e=In(()=>"modified"===bi(x)?"check-circle":"circle");Ng(R,{get name(){return bi(e)},size:14})}var $=Kt(R,2),O=Gt($,!0);zt($),zt(z),zt(n),zi((e,t,n,i,o,l,c,p,g,y,b,x,_)=>{va(a,e),s=Fa(r,1,"menu-item svelte-1f3uhkd",null,s,t),va(d,n),h=Fa(u,1,"menu-item svelte-1f3uhkd",null,h,i),va(v,o),m=Fa(f,1,"menu-item svelte-1f3uhkd",null,m,l),va(w,c),S=Fa(k,1,"menu-item svelte-1f3uhkd",null,S,p),va(I,g),T=Fa(D,1,"menu-item svelte-1f3uhkd",null,T,y),va(E,b),P=Fa(z,1,"menu-item svelte-1f3uhkd",null,P,x),va(O,_)},[()=>bi(o)("cardManagement.gridAttributeSelector.title"),()=>({active:"none"===bi(x)}),()=>bi(o)("cardManagement.gridAttributeSelector.none"),()=>({active:"uuid"===bi(x)}),()=>bi(o)("cardManagement.gridAttributeSelector.uuid"),()=>({active:"source"===bi(x)}),()=>bi(o)("cardManagement.gridAttributeSelector.source"),()=>({active:"priority"===bi(x)}),()=>bi(o)("cardManagement.gridAttributeSelector.priority"),()=>({active:"retention"===bi(x)}),()=>bi(o)("cardManagement.gridAttributeSelector.retention"),()=>({active:"modified"===bi(x)}),()=>bi(o)("cardManagement.gridAttributeSelector.modified")]),pa(e,n)},$$slots:{default:!0}})};xa(v,e=>{bi(_)&&e(f)});var z=Kt(v,2);ff(z,{get anchor(){return bi(J)},placement:"bottom-end",offset:4,onClose:Oe,get show(){return bi(X)},set show(e){$n(X,e,!0)},children:(e,t)=>{var n=Z3(),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var s=Kt(a,2);let l;s.__click=[N3,Lt,Oe];var c=Gt(s);{let e=In(()=>"table"===bi(m)?"check-circle":"circle");Ng(c,{get name(){return bi(e)},size:14})}var d=Kt(c,2),u=Gt(d,!0);zt(d),zt(s);var h=Kt(s,2);let p;h.__click=[F3,ne,Lt,Oe];var g=Gt(h);{let e=In(()=>"grid"===bi(m)?"check-circle":"circle");Ng(g,{get name(){return bi(e)},size:14})}var v=Kt(g,2),f=Gt(v,!0);zt(v);var b=Kt(v,2),k=e=>{d3(e,{variant:"lock",size:"small"})};xa(b,e=>{bi(ne)||e(k)}),zt(h);var S=Kt(h,2);let x;S.__click=[B3,ne,Lt,Oe];var _=Gt(S);{let e=In(()=>"kanban"===bi(m)?"check-circle":"circle");Ng(_,{get name(){return bi(e)},size:14})}var C=Kt(_,2),I=Gt(C,!0);zt(C);var D=Kt(C,2),T=e=>{d3(e,{variant:"lock",size:"small"})};xa(D,e=>{bi(ne)||e(T)}),zt(S),zt(i);var M=Kt(i,2),A=e=>{var t=V3(),n=Kt(Qt(t),2),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2);let s;r.__click=[j3,Nt,Oe];var l=Gt(r);Ng(l,{name:"th",size:14});var c=Kt(l,2),d=Gt(c,!0);zt(c);var u=Kt(c,2),h=e=>{Ng(e,{name:"check",size:12})};xa(u,e=>{"fixed"===bi(y)&&e(h)}),zt(r);var p=Kt(r,2);let g;p.__click=[U3,Nt,Oe];var v=Gt(p);Ng(v,{name:"th-large",size:14});var f=Kt(v,2),m=Gt(f,!0);zt(f);var b=Kt(f,2),w=e=>{Ng(e,{name:"check",size:12})};xa(b,e=>{"masonry"===bi(y)&&e(w)}),zt(p),zt(n),zi((e,t,n,i,o)=>{va(a,e),s=Fa(r,1,"menu-item svelte-1f3uhkd",null,s,t),va(d,n),g=Fa(p,1,"menu-item svelte-1f3uhkd",null,g,i),va(m,o)},[()=>bi(o)("cardManagement.layout.title"),()=>({active:"fixed"===bi(y)}),()=>bi(o)("cardManagement.layout.fixed"),()=>({active:"masonry"===bi(y)}),()=>bi(o)("cardManagement.layout.waterfall")]),pa(e,t)};xa(M,e=>{"grid"===bi(m)&&e(A)});var E=Kt(M,2),z=e=>{var t=G3(),n=Kt(Qt(t),2),i=Kt(Gt(n),2);let a;i.__click=[q3,Bt,Oe];var r=Gt(i);{let e=In(()=>"compact"===bi(w)?"check-circle":"circle");Ng(r,{get name(){return bi(e)},size:14})}Pt(2),zt(i);var s=Kt(i,2);let o;s.__click=[H3,Bt,Oe];var l=Gt(s);{let e=In(()=>"comfortable"===bi(w)?"check-circle":"circle");Ng(l,{get name(){return bi(e)},size:14})}Pt(2),zt(s);var c=Kt(s,2);let d;c.__click=[W3,Bt,Oe];var u=Gt(c);{let e=In(()=>"spacious"===bi(w)?"check-circle":"circle");Ng(u,{get name(){return bi(e)},size:14})}Pt(2),zt(c),zt(n),zi((e,t,n)=>{a=Fa(i,1,"menu-item svelte-1f3uhkd",null,a,e),o=Fa(s,1,"menu-item svelte-1f3uhkd",null,o,t),d=Fa(c,1,"menu-item svelte-1f3uhkd",null,d,n)},[()=>({active:"compact"===bi(w)}),()=>({active:"comfortable"===bi(w)}),()=>({active:"spacious"===bi(w)})]),pa(e,t)};xa(E,e=>{"kanban"===bi(m)&&e(z)});var P=Kt(E,4),R=Kt(Gt(P),2);R.__click=[Q3,Je,Oe],Ng(Gt(R),{name:"refresh",size:14}),Pt(2),zt(R);var $=Kt(R,2);$.__click=[K3,B,Oe],Ng(Gt($),{name:"columns",size:14}),Pt(2),zt($),zt(P),zt(n),zi((e,t,n,i,a,o,c)=>{va(r,e),l=Fa(s,1,"menu-item svelte-1f3uhkd",null,l,t),va(u,n),p=Fa(h,1,"menu-item svelte-1f3uhkd",null,p,i),va(f,a),x=Fa(S,1,"menu-item svelte-1f3uhkd",null,x,o),va(I,c)},[()=>bi(o)("cardManagement.viewModes.title"),()=>({active:"table"===bi(m)}),()=>bi(o)("cardManagement.viewModes.table"),()=>({active:"grid"===bi(m),disabled:!bi(ne)}),()=>bi(o)("cardManagement.viewModes.grid"),()=>({active:"kanban"===bi(m),disabled:!bi(ne)}),()=>bi(o)("cardManagement.viewModes.kanban")]),pa(e,n)},$$slots:{default:!0}});var P=Kt(z,2);{let e=In(()=>bi(p).size>0),t=In(()=>"memory"===bi($)?rt:void 0);uk(P,{get selectedCount(){return bi(p).size},get visible(){return bi(e)},onBatchCopy:st,get onBatchChangeDeck(){return bi(t)},onBatchAddTags:ot,onBatchRemoveTags:lt,onBatchDelete:ct,onClearSelection:nt})}var R=Kt(P,2),N=Gt(R),F=Gt(N),j=e=>{var t=X3(),n=Gt(t),i=Gt(n),a=Kt(Gt(i)),r=Gt(a,!0);zt(a),zt(i),zt(n);var s=Kt(n,2);s.__click=[Y3,G],Ng(Gt(s),{name:"x",size:14}),Pt(),zt(s),zt(t),zi(e=>va(r,e),[()=>Re(bi(Q))]),pa(e,t)};xa(F,e=>{"current"===bi(G)&&bi(Q)&&e(j)});var U=Kt(F,2),V=e=>{var t=o5(),n=Gt(t),i=Gt(n),a=e=>{var t=J3(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`📋 ${null!=(e=bi(E))?e:""}`)}),pa(e,t)},r=e=>{pa(e,e5())};xa(i,e=>{bi(A)&&bi(A).size>0?e(a):e(r,!1)});var o=Kt(i,2),l=e=>{pa(e,t5())};xa(o,e=>{bi(C)&&e(l)});var c=Kt(o,2),d=e=>{var t=n5(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`题型 (${null!=(e=bi(I).size)?e:""})`)}),pa(e,t)};xa(c,e=>{bi(I).size>0&&e(d)});var u=Kt(c,2),h=e=>{pa(e,i5())};xa(u,e=>{null!==bi(D)&&e(h)});var p=Kt(u,2),g=e=>{var t=a5(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`标签 (${null!=(e=bi(T).size)?e:""})`)}),pa(e,t)};xa(p,e=>{bi(T).size>0&&e(g)});var v=Kt(p,2),f=e=>{pa(e,r5())};xa(v,e=>{bi(M)&&e(f)});var m=Kt(v,2),y=e=>{var t=s5(),n=Gt(t);Ng(n,{name:"grid",size:12});var i=Kt(n);zt(t),zi(()=>{var e;return va(i,` ${null!=(e=bi(A).size)?e:""} 张卡片`)}),pa(e,t)};xa(m,e=>{bi(A)&&bi(A).size>0&&e(y)}),zt(n);var b=Kt(n,2);b.__click=[g3,s,A,E],Ng(Gt(b),{name:"x",size:14}),Pt(),zt(b),zt(t),pa(e,t)};xa(U,e=>{bi(ue)&&e(V)});var q=Kt(U,2),H=e=>{var t=l5(),n=Qt(t),i=Gt(n);{let e=In(()=>bi(De).map(e=>e.name));ty(i,{get cards(){return bi(Ke)},get selectedCards(){return bi(p)},get columnVisibility(){return bi(he)},get columnOrder(){return bi(pe)},get tableViewMode(){return bi(k)},onCardSelect:(e,t)=>function(e,t){const n=new Set(bi(p));t?n.add(e):n.delete(e),$n(p,n,!0)}(e,t),onSelectAll:tt,onSort:e=>function(e){we||bi(be)||(null!==xe&&(clearTimeout(xe),xe=null),we=!0,$n(be,!0),ke=Date.now(),Se++,bi(ye).field===e?bi(ye).direction="asc"===bi(ye).direction?"desc":"asc":(bi(ye).field=e,bi(ye).direction="desc"))}(e),onEdit:yt,onDelete:bt,onTagsUpdate:It,onPriorityUpdate:Dt,onTempFileEdit:wt,onView:_t,onJumpToSource:Xe,get sortConfig(){return bi(ye)},get isSorting(){return bi(be)},get loading(){return bi(d)},fieldTemplates:[],get availableTags(){return bi(e)},get plugin(){return s()},get decks(){return bi(te)},get isVisible(){return bi(c)}})}iy(Kt(i,2),{get show(){return bi(be)}}),zt(n),bS(Kt(n,2),{get currentPage(){return bi(re)},get totalItems(){return bi(ce)},get itemsPerPage(){return bi(se)},onPageChange:it,onItemsPerPageChange:at}),pa(e,t)},W=e=>{var t=ha(),n=Qt(t),i=e=>{var t=ha(),n=Qt(t),i=e=>{tk(e,{get cards(){return bi(le)},get selectedCards(){return bi(p)},get plugin(){return s()},get attributeType(){return bi(x)},onCardClick:jt,onCardEdit:Ht,onCardDelete:Wt,onCardView:Zt,get loading(){return bi(d)}})},a=e=>{qw(e,{get cards(){return bi(le)},get selectedCards(){return bi(p)},get plugin(){return s()},get layoutMode(){return bi(y)},get attributeType(){return bi(x)},onCardClick:jt,onCardEdit:Ht,onCardDelete:Wt,onCardView:Zt,get loading(){return bi(d)}})};xa(n,e=>{"masonry"===bi(y)?e(i):e(a,!1)}),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{yw(e,{get cards(){return bi(le)},get dataStorage(){return r()},get plugin(){return s()},get decks(){return bi(te)},onCardSelect:Yt,onCardUpdate:Jt,onCardDelete:en,onStartStudy:Xt,groupBy:bi(b),showStats:!0,get layoutMode(){return bi(w)}})};xa(n,e=>{"kanban"===bi(m)&&e(i)},!0),pa(e,t)};xa(n,e=>{"grid"===bi(m)?e(i):e(a,!1)},!0),pa(e,t)};xa(q,e=>{"table"===bi(m)?e(H):e(W,!1)}),zt(N),zt(R),zi(e=>a=Fa(i,1,"header-actions svelte-1f3uhkd",null,a,e),[()=>({"sidebar-mode":"sidebar"===bi(Z)})]),pa(e,t)};xa(rn,e=>{bi(d)||bi(u)?e(sn):e(on,!1)}),zt(an);var ln=Kt(an,2),cn=e=>{{let t=In(()=>Array.from(bi(p)).map(e=>("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e)).filter(Boolean));Sk(e,{get open(){return bi(U)},get selectedCards(){return bi(t)},get decks(){return bi(te)},onconfirm:Tt,oncancel:Mt})}};xa(ln,e=>{bi(U)&&e(cn)});var dn=Kt(ln,2),un=e=>{{let t=In(()=>Array.from(bi(p)).map(e=>("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e)).filter(Boolean)),n=In(()=>bi(De).map(e=>e.name));Nk(e,{get open(){return bi(V)},get selectedCards(){return bi(t)},get existingTags(){return bi(n)},onconfirm:At,oncancel:Et})}};xa(dn,e=>{bi(V)&&e(un)});var pn=Kt(dn,2),gn=e=>{{let t=In(()=>Array.from(bi(p)).map(e=>("questionBank"===bi($)?bi(O):bi(h)).find(t=>t.uuid===e)).filter(Boolean));Kk(e,{get open(){return bi(q)},get selectedCards(){return bi(t)},onconfirm:Rt,oncancel:$t})}};xa(pn,e=>{bi(q)&&e(gn)});var vn=Kt(pn,2),fn=e=>{X4(e,{get card(){return bi(F)},get plugin(){return s()},get allDecks(){return bi(te)},onClose:Ct,get open(){return bi(N)},set open(e){$n(N,e,!0)}})};xa(vn,e=>{bi(N)&&bi(F)&&e(fn)});var mn=Kt(vn,2),yn=e=>{var t=p5();t.__click=[d5,B],t.__keydown=[u5,B];var n=Gt(t),i=Gt(n);uS(i,{get visibility(){return bi(he)},get columnOrder(){return bi(pe)},onVisibilityChange:ve,onOrderChange:fe});var a=Kt(i,2);a.__click=[h5,B],Ng(Gt(a),{name:"x",size:20}),zt(a),zt(n),zt(t),pa(e,t)};xa(mn,e=>{bi(B)&&e(yn)}),s3(Kt(mn,2),{get featureId(){return bi(ae)},get visible(){return bi(ie)},onClose:function(){$n(ie,!1)}}),pa(e,nn);var bn=St(tn);return a(),bn}ia(["click","input","keydown"]);var f5=la('<span role="img"></span>');function m5(e,t){if(new.target)return Er({component:m5,...e});kt(t,!0);let n,i=Ar(t,"name",7),a=Ar(t,"size",7,16),r=Ar(t,"class",7,"");Pr(()=>{n&&ge.setIcon(n,i())}),Ti(()=>{n&&i()&&ge.setIcon(n,i())});var s={get name(){return i()},set name(e){i(e),hn()},get size(){return a()},set size(e=16){a(e),hn()},get class(){return r()},set class(e=""){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=f5();return kr(o,e=>n=e,()=>n),zi(()=>{var e,t,n;Fa(o,1,`obsidian-icon ${null!=(e=r())?e:""}`,"svelte-m1xvxf"),ja(o,`width: ${null!=(t=a())?t:""}px; height: ${null!=(n=a())?n:""}px; display: inline-block;`),er(o,"aria-label",i())}),pa(e,o),St(s)}var y5=la(' <span class="stat-unit svelte-pyrn1g">天后</span>',1),b5=la('<div class="stats-cards svelte-pyrn1g"><div class="stat-card retention-card svelte-pyrn1g"><div class="stat-header svelte-pyrn1g"><span class="stat-title svelte-pyrn1g">记忆保留率</span> <span> </span></div> <div class="stat-content svelte-pyrn1g"><span class="stat-value svelte-pyrn1g"> </span></div></div> <div class="stat-card stability-card svelte-pyrn1g"><div class="stat-header svelte-pyrn1g"><span class="stat-title svelte-pyrn1g">记忆稳定性</span> <span class="stat-status svelte-pyrn1g"> </span></div> <div class="stat-content svelte-pyrn1g"><span class="stat-value svelte-pyrn1g"> <span class="stat-unit svelte-pyrn1g">天</span></span></div></div> <div class="stat-card difficulty-card svelte-pyrn1g"><div class="stat-header svelte-pyrn1g"><span class="stat-title svelte-pyrn1g">卡片难度</span> <span class="stat-status svelte-pyrn1g"> </span></div> <div class="stat-content svelte-pyrn1g"><span class="stat-value svelte-pyrn1g"><span> </span> <span class="stat-unit svelte-pyrn1g">/10</span></span></div></div> <div class="stat-card review-card svelte-pyrn1g"><div class="stat-header svelte-pyrn1g"><span class="stat-title svelte-pyrn1g">下次复习</span> <span class="stat-status svelte-pyrn1g"> </span></div> <div class="stat-content svelte-pyrn1g"><span class="stat-value svelte-pyrn1g"><!></span></div></div></div>');function w5(e,t){if(new.target)return Er({component:w5,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"fsrs",7),a=Ar(t,"sessionStats",7),r=In(()=>()=>{var e,t,i,r,s,o,l,c,d;if(a())return a();if(!n().fsrs)return{retention:0,retentionChange:0,memoryRetention:0,stability:0,stabilityState:"未知",difficulty:0,difficultyLevel:"未知",nextReview:"今日",nextReviewDays:0,nextReviewDate:"今日",memoryRate:0,predictionAccuracy:0};const u=100*(null!=(e=n().fsrs.retrievability)?e:1),h=5*Math.random()-2.5,p=null!=(t=n().fsrs.stability)?t:0,g=null!=(i=n().fsrs.difficulty)?i:5;let v="中等";v=g<5?"简单":g<7?"中等":g<8.5?"困难":"极难";let f="稳定";f=p<1?"不稳定":p<7?"较稳定":"稳定";const m=new Date,y=null!=(s=null==(r=n().fsrs)?void 0:r.due)?s:m.toISOString(),b=new Date(y);let w=0;if(isNaN(b.getTime()))_e.warn("Invalid due date:",y),w=0;else{const e=b.getTime()-m.getTime();w=e>0?Math.ceil(e/864e5):0}const k=(e=>{if(!e||isNaN(e.getTime()))return"今日";return`${e.getFullYear()}.${String(e.getMonth()+1).padStart(2,"0")}.${String(e.getDate()).padStart(2,"0")}  ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`})(b);return{retention:u,retentionChange:h,memoryRetention:u,stability:p,stabilityState:f,difficulty:g,difficultyLevel:v,nextReview:w>0&&!isNaN(w)?`${w}天后`:"今日",nextReviewDays:w,nextReviewDate:k,memoryRate:null!=(l=null==(o=n().stats)?void 0:o.memoryRate)?l:0,predictionAccuracy:null!=(d=null==(c=n().stats)?void 0:c.predictionAccuracy)?d:0}});function s(e){switch(e){case"简单":return"var(--tuanki-success)";case"中等":default:return"var(--tuanki-warning)";case"困难":case"极难":return"var(--tuanki-error)"}}var o={get card(){return n()},set card(e){n(e),hn()},get fsrs(){return i()},set fsrs(e){i(e),hn()},get sessionStats(){return a()},set sessionStats(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=b5(),c=Gt(l),d=Gt(c),u=Kt(Gt(d),2);let h;var p=Gt(u);zt(u),zt(d);var g=Kt(d,2),v=Gt(g),f=Gt(v);zt(v),zt(g),zt(c);var m=Kt(c,2),y=Gt(m),b=Kt(Gt(y),2),w=Gt(b,!0);zt(b),zt(y);var k=Kt(y,2),S=Gt(k),x=Gt(S,!0);Pt(),zt(S),zt(k),zt(m);var _=Kt(m,2),C=Gt(_),I=Kt(Gt(C),2),D=Gt(I,!0);zt(I),zt(C);var T=Kt(C,2),M=Gt(T),A=Gt(M),E=Gt(A,!0);zt(A),Pt(2),zt(M),zt(T),zt(_);var z=Kt(_,2),P=Gt(z),R=Kt(Gt(P),2),$=Gt(R,!0);zt(R),zt(P);var O=Kt(P,2),L=Gt(O),N=Gt(L),F=e=>{pa(e,ua("今日"))},B=e=>{var t=y5(),n=Qt(t);Pt(),zi(e=>va(n,`${null!=e?e:""} `),[()=>(bi(r)().nextReview||"").replace("天后","")]),pa(e,t)};return xa(N,e=>{"今日"===bi(r)().nextReview?e(F):e(B,!1)}),zt(L),zt(O),zt(z),zt(l),zi((e,t,n,i,a,r,s,o,l,c,d,g)=>{h=Fa(u,1,"stat-change svelte-pyrn1g",null,h,e),va(p,`${null!=t?t:""}${null!=n?n:""}%`),ja(v,`color: ${null!=i?i:""}`),va(f,`${null!=a?a:""}%`),va(w,r),va(x,s),ja(I,`color: ${null!=o?o:""}`),va(D,l),ja(A,`color: ${null!=c?c:""}`),va(E,d),va($,g)},[()=>({positive:bi(r)().retentionChange>0,negative:bi(r)().retentionChange<0}),()=>bi(r)().retentionChange>0?"+":"",()=>bi(r)().retentionChange.toFixed(1),()=>{return(e=bi(r)().memoryRetention)>=90?"var(--tuanki-success)":e>=70?"var(--tuanki-warning)":"var(--tuanki-error)";var e},()=>bi(r)().memoryRetention.toFixed(1),()=>bi(r)().stabilityState,()=>bi(r)().stability.toFixed(1),()=>s(bi(r)().difficultyLevel),()=>bi(r)().difficultyLevel,()=>s(bi(r)().difficultyLevel),()=>bi(r)().difficulty.toFixed(1),()=>bi(r)().nextReviewDate]),pa(e,l),St(o)}class k5{constructor(e,t,n,i,a,r){this.plugin=e,this.card=t,this.onAIFormatCustom=n,this.onTestGenerate=i,this.onSplitCard=a,this.onManageActions=r}isChildCard(e){var t;if(e.parentCardId)return!0;if(e.relationMetadata){if(!1===e.relationMetadata.isParent)return!0;if((null==(t=e.relationMetadata.derivationMetadata)?void 0:t.method)===Nx.AI_SPLIT)return!0}return!1}showMainMenu(e){const t=new ge.Menu;t.addItem(e=>{e.setTitle("AI格式化").onClick(e=>{this.showFormatSubmenu(e)})}),t.addItem(e=>{e.setTitle("AI生成测试题").onClick(e=>{this.showTestGenSubmenu(e)})}),this.isChildCard(this.card)||t.addItem(e=>{e.setTitle("AI拆分").onClick(e=>{this.showSplitSubmenu(e)})}),t.showAtMouseEvent(e)}showFormatSubmenu(e){const t=new ge.Menu;this.getFormatActions().forEach(e=>{t.addItem(t=>{t.setTitle(e.name).onClick(()=>{this.onAIFormatCustom(e.id)})})}),t.addSeparator(),t.addItem(e=>{e.setTitle("管理功能...").onClick(()=>{this.onManageActions()})}),t.showAtMouseEvent(e)}showTestGenSubmenu(e){const t=new ge.Menu;this.getTestGenActions().forEach(e=>{t.addItem(t=>{t.setTitle(e.name).onClick(()=>{this.onTestGenerate(e.id)})})}),t.addSeparator(),t.addItem(e=>{e.setTitle("管理功能...").onClick(()=>{this.onManageActions()})}),t.showAtMouseEvent(e)}showSplitSubmenu(e){const t=new ge.Menu,n=this.getSplitActions();_e.debug("[AIAssistantMenuBuilder] 显示AI拆分子菜单"),_e.debug("[AIAssistantMenuBuilder] 可用的拆分功能数量:",n.length),_e.debug("[AIAssistantMenuBuilder] 拆分功能列表:",n.map(e=>({id:e.id,name:e.name,category:e.category}))),0===n.length?(_e.warn("[AIAssistantMenuBuilder] ⚠️ 警告: 没有可用的AI拆分功能"),t.addItem(e=>{e.setTitle("暂无可用功能").setDisabled(!0)})):n.forEach(e=>{t.addItem(t=>{t.setTitle(e.name).onClick(()=>{_e.debug("[AIAssistantMenuBuilder] 用户点击拆分功能:",{id:e.id,name:e.name}),this.onSplitCard(e.id)})})}),t.addSeparator(),t.addItem(e=>{e.setTitle("管理功能...").onClick(()=>{this.onManageActions()})}),t.showAtMouseEvent(e)}getFormatActions(){return jr(vp).format}getTestGenActions(){return jr(vp).testGen}getSplitActions(){return jr(vp).split}}function S5(e,t){$n(t,!bi(t))}function x5(e,t){$n(t,!bi(t))}function _5(e,t){$n(t,!bi(t))}function C5(e,t){bi(t)&&bi(t).showMainMenu(e)}function I5(e,t){$n(t,!bi(t))}function D5(e,t,n){t()&&t()(n())}async function T5(e,t,n,i,a,r,s){var o,l,c,d;if(!t()){await n()&&(null==(o=i())||o(!0),null==(l=a())||l(bi(r)),new window.Notice(bi(s)("toolbar.graphLinkSuccess"),8e3))}else{if(bi(r))try{bi(r).detach(),_e.debug("[图谱联动] 已分离图谱leaf")}catch(u){_e.warn("[图谱联动] 分离图谱leaf失败:",u)}$n(r,null),null==(c=i())||c(!1),null==(d=a())||d(null),new window.Notice(bi(s)("toolbar.graphLinkClosed"))}}var M5=la('<button class="toolbar-btn plain-editor-btn svelte-1dltfgj" title="普通文本编辑器"><!> <span class="btn-label svelte-1dltfgj">文本编辑</span></button>'),A5=(e,t)=>$n(t,!1),E5=(e,t,n)=>t(bi(n).id),z5=la('<span class="hierarchy-indicator svelte-1dltfgj">└</span>'),P5=la('<button class="deck-item svelte-1dltfgj" role="menuitem"><div class="deck-info svelte-1dltfgj"><div class="deck-name svelte-1dltfgj"><!> <span class="deck-name-text svelte-1dltfgj"> </span></div></div> <div class="deck-indicator svelte-1dltfgj"><!></div></button>'),R5=la('<div class="available-decks-section svelte-1dltfgj"><div class="section-title svelte-1dltfgj">可用牌组</div> <div class="deck-list svelte-1dltfgj"></div></div>'),$5=la('<div class="deck-menu-header svelte-1dltfgj"><span class="svelte-1dltfgj">牌组列表</span> <button class="close-btn svelte-1dltfgj"><!></button></div> <div class="deck-menu-content svelte-1dltfgj"><div class="current-deck-section svelte-1dltfgj"><div class="section-title svelte-1dltfgj">当前牌组</div> <div class="deck-item current svelte-1dltfgj"><div class="deck-info svelte-1dltfgj"><div class="deck-name svelte-1dltfgj"><span class="svelte-1dltfgj"> </span></div></div> <div class="deck-indicator svelte-1dltfgj"><!></div></div></div> <!></div>',1),O5=(e,t)=>$n(t,!1),L5=la('<span class="relation-note svelte-1dltfgj"> </span>'),N5=la('<span class="relation-badge-compact child svelte-1dltfgj">📄 子卡片</span> <!>',1),F5=la('<span class="relation-note svelte-1dltfgj"> </span>'),B5=la('<span class="relation-badge-compact parent svelte-1dltfgj">📁 父卡片</span> <!>',1),j5=la('<span class="relation-badge-compact normal svelte-1dltfgj">📄 独立卡片</span>'),U5=la('<div class="info-item no-source svelte-1dltfgj"><span class="info-label svelte-1dltfgj"><!> 无来源</span> <span class="info-value text-muted svelte-1dltfgj"> </span></div>'),V5=(e,t)=>"Enter"===e.key&&t(),q5=la('<div class="info-item clickable svelte-1dltfgj" role="button" tabindex="0"><span class="info-label svelte-1dltfgj"><!> </span> <span class="info-value link-value svelte-1dltfgj"> </span></div>'),H5=(e,t)=>"Enter"===e.key&&t(),W5=la('<div class="info-item clickable svelte-1dltfgj" role="button" tabindex="0"><span class="info-label svelte-1dltfgj"><!> 块引用</span> <span class="info-value link-value svelte-1dltfgj"> </span></div>'),G5=la("<!> <!>",1),Q5=la('<div class="info-section svelte-1dltfgj"><div class="info-section-title svelte-1dltfgj">来源信息</div> <!></div>'),K5=(e,t,n)=>{var i;$n(t,!1),null==(i=n())||i()},Z5=la('<div class="info-section detailed-view-section svelte-1dltfgj"><button class="detailed-view-btn svelte-1dltfgj" type="button"><!> <span class="svelte-1dltfgj">查看详细信息</span></button></div>'),Y5=(e,t,n)=>{var i;$n(t,!1),null==(i=n())||i()},X5=la('<div class="info-section card-debug-section svelte-1dltfgj"><button class="card-debug-btn svelte-1dltfgj" type="button" title="查看完整的卡片数据结构（JSON格式）"><!> <span class="svelte-1dltfgj">查看数据结构</span></button></div>'),J5=la('<div class="multi-info-menu-header svelte-1dltfgj"><span class="svelte-1dltfgj">卡片信息与来源</span> <button class="close-btn svelte-1dltfgj"><!></button></div> <div class="multi-info-menu-content svelte-1dltfgj"><div class="info-section svelte-1dltfgj"><div class="info-section-title svelte-1dltfgj">基础信息</div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">卡片ID</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">所属牌组</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">卡片状态</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">卡片关系</span> <span class="info-value svelte-1dltfgj"><!></span></div></div> <div class="info-section svelte-1dltfgj"><div class="info-section-title svelte-1dltfgj">学习数据</div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">稳定性</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">难度</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">间隔</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">总复习次数</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">平均用时</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">记忆成功率</span> <span class="info-value svelte-1dltfgj"> </span></div></div> <div class="info-section svelte-1dltfgj"><div class="info-section-title svelte-1dltfgj">时间信息</div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">创建时间</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">修改时间</span> <span class="info-value svelte-1dltfgj"> </span></div> <div class="info-item svelte-1dltfgj"><span class="info-label svelte-1dltfgj">下次复习</span> <span class="info-value svelte-1dltfgj"> </span></div></div> <!> <!> <!></div>',1),e6=(e,t)=>$n(t,!1),t6=(e,t)=>{var n;return null==(n=t())?void 0:n("auto")},n6=(e,t)=>{var n;return null==(n=t())?void 0:n("fixed")},i6=(e,t)=>{var n;return null==(n=t())?void 0:n("enabled",e.target.checked)},a6=(e,t)=>{var n;return null==(n=t())?void 0:n("mode",e.target.value)},r6=(e,t)=>{var n;return null==(n=t())?void 0:n("timing",e.target.value)},s6=(e,t)=>{var n;return null==(n=t())?void 0:n("interval",parseInt(e.target.value))},o6=la('<div class="setting-item interval-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj">播放间隔 <span class="interval-value svelte-1dltfgj"> </span></div> <input type="range" class="setting-slider svelte-1dltfgj" min="500" max="5000" step="500"/></div>'),l6=la('<div class="setting-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj">播放模式</div> <select class="setting-select svelte-1dltfgj"><option class="svelte-1dltfgj">仅第一个</option><option class="svelte-1dltfgj">播放全部</option></select></div> <div class="setting-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj">播放时机</div> <select class="setting-select svelte-1dltfgj"><option class="svelte-1dltfgj">切换卡片</option><option class="svelte-1dltfgj">显示答案</option></select></div> <!>',1),c6=(e,t)=>{var n;return null==(n=t())?void 0:n(e.target.value)},d6=(e,t)=>{var n;return null==(n=t())?void 0:n(e.target.checked)},u6=(e,t)=>{var n;return null==(n=t())?void 0:n(e.target.checked)},h6=(e,t)=>{var n;return null==(n=t())?void 0:n(e.target.checked)},p6=(e,t,n)=>{var i;$n(t,!1),null==(i=n())||i()},g6=la('<div class="setting-section svelte-1dltfgj"><div class="setting-item suspend-item svelte-1dltfgj"><div class="suspend-label svelte-1dltfgj"><span class="svelte-1dltfgj">回收卡片：#回收</span></div> <button class="suspend-apply-btn svelte-1dltfgj" title="回收当前卡片，暂时移出学习队列，等待改进">点击应用</button></div></div>'),v6=la('<div class="more-settings-menu-header svelte-1dltfgj"><span class="svelte-1dltfgj">更多设置</span> <button class="close-btn svelte-1dltfgj"><!></button></div> <div class="more-settings-menu-content svelte-1dltfgj"><div class="setting-section svelte-1dltfgj"><div class="compact-mode-options svelte-1dltfgj"><label><input type="radio" name="compactMode" value="auto" class="svelte-1dltfgj"/> <div class="option-content svelte-1dltfgj"><!> <span class="option-label svelte-1dltfgj">自动调整</span></div></label> <label><input type="radio" name="compactMode" value="fixed" class="svelte-1dltfgj"/> <div class="option-content svelte-1dltfgj"><!> <span class="option-label svelte-1dltfgj">仅显示图标</span></div></label></div></div> <div class="setting-section svelte-1dltfgj"><div class="setting-item toggle-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj"><span class="svelte-1dltfgj">自动播放媒体</span></div> <label class="toggle-switch svelte-1dltfgj"><input type="checkbox" class="svelte-1dltfgj"/> <span class="slider svelte-1dltfgj"></span></label></div> <!></div> <div class="setting-section svelte-1dltfgj"><div class="setting-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj">卡片顺序</div> <select class="setting-select svelte-1dltfgj"><option class="svelte-1dltfgj">正序学习</option><option class="svelte-1dltfgj">乱序学习</option></select></div></div> <div class="setting-section svelte-1dltfgj"><div class="setting-item toggle-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj"><span class="svelte-1dltfgj">启用键盘快捷键</span></div> <label class="toggle-switch svelte-1dltfgj"><input type="checkbox" class="svelte-1dltfgj"/> <span class="slider svelte-1dltfgj"></span></label></div></div> <div class="setting-section svelte-1dltfgj"><div class="setting-item toggle-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj"><span class="svelte-1dltfgj">渐进式挖空自动拆分</span></div> <label class="toggle-switch svelte-1dltfgj"><input type="checkbox" class="svelte-1dltfgj"/> <span class="slider svelte-1dltfgj"></span></label></div></div> <div class="setting-section svelte-1dltfgj"><div class="setting-item toggle-item svelte-1dltfgj"><div class="setting-label svelte-1dltfgj"><span class="svelte-1dltfgj">启用直接删除</span></div> <label class="toggle-switch svelte-1dltfgj"><input type="checkbox" class="svelte-1dltfgj"/> <span class="slider svelte-1dltfgj"></span></label></div></div> <!></div>',1),f6=(e,t)=>$n(t,!1),m6=(e,t,n)=>t(bi(n).id),y6=la("<button> </button>"),b6=(e,t)=>{e.stopPropagation(),t(e)},w6=la("<button>更多 ▾</button>"),k6=la('<div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">Markdown动态解析：插件核心特性</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">真正的Markdown卡片编辑</h4> <p class="svelte-1dltfgj">Tuanki插件与Anki等传统记忆软件的<strong class="svelte-1dltfgj">核心区别</strong>在于：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">原生Markdown编辑</strong>：在Obsidian中直接编写纯Markdown内容</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">智能动态解析</strong>：根据内容自动识别并渲染为不同题型</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">无需模板选择</strong>：系统自动判断卡片类型（问答、挖空、选择题等）</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">内容即结构</strong>：Markdown语法本身就定义了卡片的结构和类型</li></ul> <h4 class="svelte-1dltfgj">关于基础模板格式</h4> <p class="tutorial-note svelte-1dltfgj">本教程提到的问答题（Q:/---div---）、选择题（A. B. C.）、挖空题等格式，主要是为了<strong class="svelte-1dltfgj">与Anki进行数据同步</strong>而设计的兼容格式。</p> <p class="tutorial-note svelte-1dltfgj">对于Tuanki插件本身，这些固定模板的重要性并不高。你完全可以用自然的Markdown语法编写内容，插件会智能解析并正确渲染。</p> <h4 class="svelte-1dltfgj">真正的优势</h4> <pre class="svelte-1dltfgj">传统记忆软件（如Anki）:\n选择卡片模板 → 填入字段 → 固定格式显示\n\nTuanki插件:\n直接写Markdown → 智能解析 → 动态渲染题型</pre> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">这才是真正的知识管理与记忆学习的完美结合！</strong></p></div></div>'),S6=la('<div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">问答题格式</span></div> <div class="tutorial-text svelte-1dltfgj"><p class="tutorial-note svelte-1dltfgj">插件通过识别 <code class="svelte-1dltfgj">---div---</code> 分隔符，动态解析内容为问答题格式。卡片内容保存在 content 字段中，无需使用模板。</p> <h4 class="svelte-1dltfgj">标准格式</h4> <p class="svelte-1dltfgj">只需使用 <code class="svelte-1dltfgj">---div---</code> 分隔正面和反面：</p> <pre class="svelte-1dltfgj">问题内容\n\n---div---\n\n答案内容</pre> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">示例：</strong></p> <pre class="svelte-1dltfgj">什么是间隔重复？\n\n---div---\n\n间隔重复是一种学习技术，通过在逐渐增加的\n时间间隔中复习信息，从而提高长期记忆。\n这种方法基于遗忘曲线理论。</pre></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">挖空题格式</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">支持三种挖空语法</h4> <h5 class="svelte-1dltfgj">方式1：Obsidian高亮（原生Markdown）</h5> <p class="svelte-1dltfgj">使用 <code class="svelte-1dltfgj">==text==</code> 标记挖空内容，这是Obsidian原生语法</p> <pre class="svelte-1dltfgj">间隔重复的核心是在 ==遗忘临界点== 进行复习。</pre> <h5 class="svelte-1dltfgj">方式2：Anki风格（用于数据同步）</h5> <p class="svelte-1dltfgj">使用 <code class="svelte-1dltfgj"></code> 或 <code class="svelte-1dltfgj"></code>，主要用于与Anki同步</p> <pre class="svelte-1dltfgj"></pre> <h5 class="svelte-1dltfgj">方式3：自定义分隔符</h5> <p class="tutorial-note svelte-1dltfgj">在插件设置中可配置自定义挖空符号</p></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">选择题格式</span></div> <div class="tutorial-text svelte-1dltfgj"><p class="tutorial-note svelte-1dltfgj">插件通过识别选项格式 <code class="svelte-1dltfgj">A) B) C)</code> 和正确答案标记 <code class="svelte-1dltfgj"></code>，动态解析为选择题。</p> <h4 class="svelte-1dltfgj">单选题</h4> <p class="svelte-1dltfgj">使用 <code class="svelte-1dltfgj">A) B) C)</code> 格式，用 <code class="svelte-1dltfgj"></code> 标记正确答案：</p> <pre class="svelte-1dltfgj"></pre> <h4 class="svelte-1dltfgj">多选题</h4> <p class="svelte-1dltfgj">多个选项使用 <code class="svelte-1dltfgj"></code> 标记：</p> <pre class="svelte-1dltfgj"></pre></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">回收卡片功能</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">什么是回收？</h4> <p class="svelte-1dltfgj">回收功能将记忆效率不佳的卡片暂时移出学习队列，标记为待改进状态，而非永久放弃。</p> <h4 class="svelte-1dltfgj">如何回收卡片？</h4> <p class="svelte-1dltfgj">在卡片内容中添加 <code class="svelte-1dltfgj">#回收</code> 或 <code class="svelte-1dltfgj">#recycle</code> 标签，或通过更多设置菜单点击"回收卡片"按钮。</p> <h4 class="svelte-1dltfgj">标签插入位置</h4> <p class="svelte-1dltfgj">系统会智能插入回收标签：</p> <h5 class="svelte-1dltfgj">位置1：YAML后</h5> <pre class="svelte-1dltfgj">---\ntags: [学习]\n---\n\n#搁置\n\n卡片内容...</pre> <h5 class="svelte-1dltfgj">位置2：标题后</h5> <pre class="svelte-1dltfgj"># 卡片标题\n\n#搁置\n\n卡片内容...</pre> <h5 class="svelte-1dltfgj">位置3：内容开头</h5> <pre class="svelte-1dltfgj">#搁置\n\n卡片内容...</pre> <h4 class="svelte-1dltfgj">回收 vs 搁置</h4> <p class="svelte-1dltfgj">💡 <strong class="svelte-1dltfgj">回收</strong>强调"暂存待改进"，而非"永久放弃"。系统支持向后兼容旧版<code class="svelte-1dltfgj">#搁置</code>标签。</p> <h4 class="svelte-1dltfgj">重新激活</h4> <p class="svelte-1dltfgj">移除卡片中的 <code class="svelte-1dltfgj">#回收</code> 标签，卡片将重新加入复习队列。建议在改进后再激活。</p></div></div>',1),x6=la('<div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">功能定位与设计理念</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">AI助手是什么？</h4> <p class="svelte-1dltfgj">AI助手是Tuanki插件的智能辅助系统，旨在提升卡片学习效率和内容质量。它不是简单的内容生成工具，而是融入学习流程的智能助理。</p> <h4 class="svelte-1dltfgj">核心定位</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">学习辅助</strong>：基于间隔重复算法的学习流程优化工具</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">内容增强</strong>：智能优化已有卡片内容，而非完全替代人工创作</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">效率提升</strong>：减少重复性的格式化和整理工作</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">个性化</strong>：支持自定义功能，适应不同学习场景</li></ul> <h4 class="svelte-1dltfgj">为什么需要AI助手？</h4> <p class="svelte-1dltfgj">在间隔重复学习中，用户常遇到以下问题：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">卡片质量参差不齐</strong>：手动创建的卡片格式不统一，影响学习效率</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">复杂知识拆分困难</strong>：长篇内容难以拆分为适合记忆的小单元</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">练习题缺乏</strong>：仅有记忆卡片，缺少巩固性练习</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">重复性劳动</strong>：格式化、优化等机械工作耗时</li></ul> <h4 class="svelte-1dltfgj">核心价值</h4> <p class="svelte-1dltfgj">智能辅助 + 可扩展 + 多场景应用</p> <h4 class="svelte-1dltfgj">设计原则</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Content-First</strong>：尊重用户原有内容，AI仅作优化</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">最小信息原则</strong>：拆分和优化时遵循一卡一知识点</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">溯源透明</strong>：所有AI生成的内容都保留来源信息</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">用户可控</strong>：AI建议需用户确认，支持编辑和重新生成</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">AI格式化</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">功能介绍</h4> <p class="svelte-1dltfgj">AI格式化是在现有卡片基础上自动优化内容和格式的功能，包括：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">优化排版</strong>：调整段落结构，增强可读性</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">智能添加标签</strong>：根据内容自动提取关键词标签</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">增强表达</strong>：改进语言表达，使内容更清晰</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">统一风格</strong>：保持卡片格式的一致性</li></ul> <h4 class="svelte-1dltfgj">使用方法</h4> <pre class="svelte-1dltfgj">1. 在记忆学习界面，点击工具栏的"AI助手"按钮\n2. 选择"AI格式化"类别\n3. 从官方预设或自定义功能中选择一个功能\n4. 查看预览结果，确认后应用</pre> <h4 class="svelte-1dltfgj">官方预设功能</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">选择题优化</strong>：优化选择题的选项表述和干扰项设计</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">数学公式格式化</strong>：规范数学公式的LaTeX语法</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">代码片段优化</strong>：改进代码示例的注释和格式</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">概念定义优化</strong>：增强概念解释的准确性和条理性</li></ul> <p class="tutorial-note svelte-1dltfgj">格式化会修改卡片内容，建议先预览再应用</p></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">AI测试题生成</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">功能介绍</h4> <p class="svelte-1dltfgj">AI测试题生成是基于记忆卡片内容智能生成练习题的功能，用于巩固学习效果。</p> <h4 class="svelte-1dltfgj">记忆牌组与刷题牌组的关系</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">记忆牌组</strong>：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">用途：间隔重复学习</li> <li class="svelte-1dltfgj">使用FSRS算法调度复习</li> <li class="svelte-1dltfgj">卡片标识：cardPurpose=\'memory\'</li> <li class="svelte-1dltfgj">包含字段：fsrs、reviewHistory等</li></ul> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">刷题牌组</strong>：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">用途：测试和练习</li> <li class="svelte-1dltfgj">使用EWMA算法，科学评估掌握度</li> <li class="svelte-1dltfgj">卡片标识：cardPurpose=\'test\'</li> <li class="svelte-1dltfgj">包含字段：testStats（正确率、平均用时、掌握度等）</li></ul> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">一对一对应关系</strong>：</p> <p class="svelte-1dltfgj">每个记忆牌组可以有一个对应的刷题牌组，命名格式为"牌组名 - 刷题"。测试题生成时，会自动创建或关联到对应的刷题牌组。</p> <h4 class="svelte-1dltfgj">EWMA算法：科学评估掌握度</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">什么是EWMA？</strong></p> <p class="svelte-1dltfgj">EWMA = Exponentially Weighted Moving Average（指数加权移动平均）</p> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">核心思想</strong>：近期的测试结果比早期结果更能反映当前掌握程度</p> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">计算公式</strong>：</p> <pre class="svelte-1dltfgj"></pre> <h4 class="svelte-1dltfgj">测试题卡片的溯源</h4> <p class="svelte-1dltfgj">每张AI生成的测试题都保留完整的溯源信息：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">源卡片信息</strong>：sourceCardId、sourceCardContent</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">生成元数据</strong>：generationMethod、generationTimestamp、aiProvider、aiModel</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">继承的来源信息</strong>：sourceFile、sourceBlock、sourceRange</li></ul> <h4 class="svelte-1dltfgj">使用流程</h4> <pre class="svelte-1dltfgj">1. 选择源卡片（当前显示的卡片）\n2. 点击"AI助手" → "生成测试题"，选择生成功能\n3. 查看预览，选择要保存的题目\n4. 点击"收入到题库"\n5. 系统自动创建或关联对应的刷题牌组</pre></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">AI拆分</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">功能介绍</h4> <p class="svelte-1dltfgj">AI拆分是将复杂卡片拆分为多张简单子卡片的功能，遵循"最小信息原则"，每张子卡片聚焦一个核心知识点。</p> <h4 class="svelte-1dltfgj">父卡片与子卡片</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">父卡片</strong>：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">原始的复杂卡片，包含多个知识点</li> <li class="svelte-1dltfgj">relationMetadata.isParent = true</li> <li class="svelte-1dltfgj">可选择搁置，不参与学习</li></ul> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">子卡片</strong>：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">AI拆分生成的简单卡片，每张卡片一个知识点</li> <li class="svelte-1dltfgj">parentCardId：指向父卡片UUID</li> <li class="svelte-1dltfgj">relationMetadata.isParent = false</li> <li class="svelte-1dltfgj">derivationMetadata.method = \'AI_SPLIT\'</li></ul> <h4 class="svelte-1dltfgj">拆分与测试题的区别</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">目标牌组</strong>：AI拆分→记忆牌组，测试题→刷题牌组</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">卡片用途</strong>：AI拆分→记忆学习（cardPurpose=\'memory\'），测试题→测试练习（cardPurpose=\'test\'）</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">FSRS算法</strong>：AI拆分使用，测试题使用EWMA算法</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">父子关系</strong>：AI拆分建立父子关系，测试题仅记录源卡片</li></ul> <h4 class="svelte-1dltfgj">子卡片拆分防护</h4> <p class="svelte-1dltfgj">为保持卡片层次结构的清晰，<strong class="svelte-1dltfgj">子卡片无法再次拆分</strong>。</p> <p class="svelte-1dltfgj">系统会检测parentCardId、relationMetadata.isParent、derivationMetadata.method字段，并在UI和逻辑层双重防护。</p> <h4 class="svelte-1dltfgj">父卡片回收机制</h4> <p class="svelte-1dltfgj">保存子卡片后，系统会询问是否回收父卡片：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">回收</strong>：在父卡片内容添加 #回收 标签，标记为待处理</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">效果</strong>：父卡片暂时移出学习队列，等待改进或归档</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">重新激活</strong>：移除标签并改进后，卡片重新加入学习</li></ul> <h4 class="svelte-1dltfgj">信息继承机制</h4> <p class="svelte-1dltfgj">子卡片完整继承父卡片的信息：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">来源文档信息</strong>：sourceFile、sourceBlock、sourceRange、sourceExists</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">父子关系信息</strong>：parentCardId、relationMetadata、derivationMetadata</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">牌组信息</strong>：与父卡片在同一牌组</li></ul> <h4 class="svelte-1dltfgj">使用流程</h4> <pre class="svelte-1dltfgj">1. 选择源卡片（非子卡片）\n2. 点击"AI助手" → "AI拆分"，选择拆分功能\n3. 查看预览，选择要保存的子卡片\n4. 点击"保存到记忆牌组"\n5. 选择是否搁置父卡片</pre></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">操作步骤与管理</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">完整使用流程</h4> <pre class="svelte-1dltfgj">步骤1: 点击工具栏"AI助手"按钮\n     ↓\n步骤2: 选择功能类型\n     ├─ AI格式化\n     │   ├─ 选择预设功能或自定义功能\n     │   └─ 预览并应用\n     ├─ AI测试题生成\n     │   ├─ 选择生成类型\n     │   ├─ 预览生成的题目\n     │   └─ 选择保存到刷题牌组\n     └─ AI拆分\n         ├─ 选择拆分策略\n         ├─ 预览子卡片\n         ├─ 选择保存到记忆牌组\n         └─ 可选：搁置父卡片\n\n步骤3: 查看结果并应用\n     ↓\n步骤4: 如需调整，可重新执行或编辑</pre> <h4 class="svelte-1dltfgj">管理自定义功能</h4> <p class="svelte-1dltfgj">点击菜单底部的"管理功能..."可以：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">创建新的自定义功能（格式化、测试题生成、AI拆分）</li> <li class="svelte-1dltfgj">编辑现有功能（修改提示词、选择AI模型）</li> <li class="svelte-1dltfgj">启用/禁用功能</li> <li class="svelte-1dltfgj">删除不需要的功能</li></ul> <h4 class="svelte-1dltfgj">注意事项</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">首次使用</strong>：需要在设置中配置AI服务</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">AI是辅助</strong>：保持人工审核和创作的主导地位</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">记忆与测试分离</strong>：记忆牌组使用FSRS，刷题牌组使用EWMA</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">溯源透明</strong>：所有AI生成内容都可追溯来源</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">层级清晰</strong>：子卡片不可再拆，防止过度复杂化</li></ul> <p class="tutorial-note svelte-1dltfgj">提示：合理使用AI助手，让学习更高效，知识更牢固</p></div></div>',1),_6=la('<div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">渐进式挖空：独立学习每个挖空</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">核心特性</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">渐进式挖空</strong>将一张卡片的多个挖空独立学习，每个挖空都有自己的FSRS数据和复习历史。</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">独立学习进度</strong>：每个挖空有自己的FSRS数据，互不影响</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">单卡片存储</strong>：所有挖空共享一张卡片，避免内容重复</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">动态渲染</strong>：学习时只隐藏当前挖空，其他挖空显示答案</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">智能解析</strong>：自动检测并提示拆分为渐进式挖空</li></ul> <h4 class="svelte-1dltfgj">与普通挖空的区别</h4> <pre class="svelte-1dltfgj">普通挖空：一张卡片 → 一次学习\n渐进式挖空：一张卡片 → 多次独立学习</pre></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">Markdown自由编辑与动态解析</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">插件核心优势：动态题型解析</h4> <p class="svelte-1dltfgj">Tuanki插件的独特之处在于<strong class="svelte-1dltfgj">Markdown自由编辑，实时动态解析</strong>为不同题型。</p> <h4 class="svelte-1dltfgj">题型转换示例</h4> <pre class="svelte-1dltfgj"></pre> <pre class="svelte-1dltfgj"></pre> <h4 class="svelte-1dltfgj">实时动态预览</h4> <p class="svelte-1dltfgj">修改卡片内容后，插件会：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">自动识别</strong>：根据Markdown符号识别题型</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">动态渲染</strong>：实时预览最终学习效果</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">保留进度</strong>：题型转换不影响学习历史</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">无缝切换</strong>：在编辑和学习模式间自由切换</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">序列号格式化快捷键</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">Obsidian渐进式挖空序列格式化</h4> <p class="svelte-1dltfgj">插件提供专用快捷键，帮助快速格式化挖空序列号。</p> <h4 class="svelte-1dltfgj">序列号跳号处理</h4> <p class="svelte-1dltfgj">删除中间挖空后出现跳号（如c1, c3）是正常现象，与Anki行为一致。</p> <p class="svelte-1dltfgj">如需连续序列号，可手动修改：</p> <pre class="svelte-1dltfgj"></pre> <p class="svelte-1dltfgj">修改后，c3的学习进度会转移到c2。</p> <h4 class="svelte-1dltfgj">适用场景</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">英语单词学习</strong>：单词 + 多个词义</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">知识点学习</strong>：公式 + 变量定义</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">代码学习</strong>：语法结构的不同部分</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">概念理解</strong>：复杂概念的多个关键点</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">学习特性与数据管理</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">独立学习进度</h4> <p class="svelte-1dltfgj">每个挖空都有独立的：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">FSRS数据</strong>：稳定性、难度、复习次数等</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">复习历史</strong>：完整的学习轨迹记录</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">虚拟UUID</strong>：格式如 <code class="svelte-1dltfgj">card123_c1</code>，用于精确追踪</li></ul> <h4 class="svelte-1dltfgj">智能渲染</h4> <p class="svelte-1dltfgj">学习时的显示效果：</p> <pre class="svelte-1dltfgj"></pre> <h4 class="svelte-1dltfgj">学习进度保留</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">编辑内容</strong>：修改挖空文本不影响学习进度</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">添加挖空</strong>：新挖空从新卡片开始</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">删除挖空</strong>：序列号可能跳号，但进度保留</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">转换继承</strong>：普通挖空转换时，c1继承原有进度</li></ul></div></div>',1),C6=la('<div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">卡片优先级：控制学习顺序的核心工具</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">什么是卡片优先级</h4> <p class="svelte-1dltfgj">卡片优先级是一个<strong class="svelte-1dltfgj">队列管理工具</strong>，用于控制同一学习会话中卡片的出现顺序。通过设置不同的优先级，您可以确保重要内容优先复习。</p> <h4 class="svelte-1dltfgj">优先级等级</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">1 - 低优先级</strong>：不紧急的辅助内容</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">2 - 中优先级</strong>：默认优先级，常规学习内容</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">3 - 高优先级</strong>：重要知识点</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">4 - 紧急</strong>：考前重点、关键内容</li></ul> <h4 class="svelte-1dltfgj">核心理念</h4> <p class="tutorial-note svelte-1dltfgj">优先级<strong class="svelte-1dltfgj">只影响学习顺序</strong>，不影响记忆算法。这意味着FSRS系统仍然会根据您的记忆曲线计算最佳复习间隔，优先级只是决定在同一时间段内先学哪张卡片。</p></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">四层优先级计算系统</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">综合优先级公式</h4> <p class="svelte-1dltfgj">插件使用四层叠加的优先级计算系统：</p> <pre class="svelte-1dltfgj">最终优先级 = State优先级 + 用户优先级 + Difficulty微调 + Leech提升</pre> <h4 class="svelte-1dltfgj">各层级详解</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">第1层 - State优先级（100-400分）</strong>： <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">Learning（学习中）：100-199分 - 最高优先级</li> <li class="svelte-1dltfgj">Relearning（重学中）：200-299分</li> <li class="svelte-1dltfgj">Review（复习）：300-399分</li> <li class="svelte-1dltfgj">New（新卡片）：400+分 - 最低优先级</li></ul></li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">第2层 - 用户优先级（0-40分）</strong>： <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">优先级1：+10分</li> <li class="svelte-1dltfgj">优先级2：+20分（默认）</li> <li class="svelte-1dltfgj">优先级3：+30分</li> <li class="svelte-1dltfgj">优先级4：+40分</li></ul></li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">第3层 - Difficulty微调（0-5分）</strong>：根据卡片难度追踪数据自动调整</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">第4层 - Leech提升（-20~0分）</strong>：困难卡片获得额外提升（负数=提前）</li></ul> <h4 class="svelte-1dltfgj">计算示例</h4> <pre class="svelte-1dltfgj">卡片A：Review状态 + 优先级4（紧急）\n       = 300 + 40 + 微调 = 340左右\n\n卡片B：Review状态 + 优先级1（低）\n       = 300 + 10 + 微调 = 310左右\n\n结果：卡片A会优先于卡片B出现</pre></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">优先级如何影响学习队列</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">优先级分层机制</h4> <p class="svelte-1dltfgj">学习队列按每100分划分为不同层级：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Layer 1（100-199）</strong>：Learning卡片，始终最优先</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Layer 2（200-299）</strong>：Relearning卡片</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Layer 3（300-399）</strong>：Review卡片</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Layer 4（400+）</strong>：New卡片，最后学习</li></ul> <h4 class="svelte-1dltfgj">同层内排序</h4> <p class="svelte-1dltfgj">用户优先级主要影响<strong class="svelte-1dltfgj">同一层级内</strong>的相对顺序：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">在同一State（如都是Review卡片）中，优先级4的卡片排在前面</li> <li class="svelte-1dltfgj">优先级1的卡片排在后面</li> <li class="svelte-1dltfgj">即使设置为优先级4，New卡片仍然在所有Learning/Review卡片之后</li></ul> <h4 class="svelte-1dltfgj">Interleaving交错影响</h4> <p class="svelte-1dltfgj">在启用交错功能时：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">每层内先按优先级排序</li> <li class="svelte-1dltfgj">再按标签进行交错排列</li> <li class="svelte-1dltfgj">保持优先级的大致方向不变</li> <li class="svelte-1dltfgj">避免同一标签的卡片连续出现</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">优先级与复习间隔的关系</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">直接影响：无</h4> <p class="tutorial-note svelte-1dltfgj"><strong class="svelte-1dltfgj">重要</strong>：用户优先级<strong class="svelte-1dltfgj">不会改变FSRS算法计算的复习间隔</strong>。无论设置为优先级1还是4，卡片的下次复习时间完全由以下因素决定：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">您的评分（Again/Hard/Good/Easy）</li> <li class="svelte-1dltfgj">卡片的记忆难度（Difficulty）</li> <li class="svelte-1dltfgj">卡片的记忆稳定性（Stability）</li> <li class="svelte-1dltfgj">历史遗忘次数（Lapses）</li> <li class="svelte-1dltfgj">当前记忆状态（State）</li></ul> <h4 class="svelte-1dltfgj">间接影响：学习起始时间</h4> <p class="svelte-1dltfgj">优先级通过影响学习顺序，可能产生间接影响：</p> <pre class="svelte-1dltfgj">示例对比：\n\n优先级4（紧急）：\n  下午3:00学习 → 评分Good → 4天后复习（12月8日 3:00）\n\n优先级1（低）：\n  晚上9:00学习 → 评分Good → 4天后复习（12月8日 9:00）\n\n间隔时长相同，但起始时间不同</pre> <h4 class="svelte-1dltfgj">记忆效果影响</h4> <p class="svelte-1dltfgj">可能存在的心理效应：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">标记为"紧急"的卡片可能获得更多注意力</li> <li class="svelte-1dltfgj">更专注的学习可能带来更好的评分</li> <li class="svelte-1dltfgj">更好的评分会导致更长的复习间隔</li> <li class="svelte-1dltfgj">但这不是优先级本身的作用，而是学习态度的影响</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">优先级使用场景与最佳实践</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">场景1：考前冲刺</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">策略</strong>：将考试重点内容设为优先级4（紧急）</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">确保在有限时间内优先复习重点</li> <li class="svelte-1dltfgj">其他内容可暂时设为优先级1（低）</li> <li class="svelte-1dltfgj">考试后恢复正常优先级</li></ul> <h4 class="svelte-1dltfgj">场景2：主题式学习</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">策略</strong>：本周专注某个主题时，提高相关卡片优先级</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">本周学习主题A：A相关卡片→优先级4</li> <li class="svelte-1dltfgj">下周学习主题B：调整为B相关卡片→优先级4</li> <li class="svelte-1dltfgj">保持学习的连贯性和专注度</li></ul> <h4 class="svelte-1dltfgj">场景3：基础优先策略</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">策略</strong>：基础知识优先于高级知识</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">基础概念卡片：优先级3（高）</li> <li class="svelte-1dltfgj">应用和拓展：优先级2（中）</li> <li class="svelte-1dltfgj">高级话题：优先级1（低）</li> <li class="svelte-1dltfgj">符合学习规律，先打好基础</li></ul> <h4 class="svelte-1dltfgj">场景4：时间管理</h4> <p class="svelte-1dltfgj"><strong class="svelte-1dltfgj">策略</strong>：根据可用时间调整优先级</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">时间充足：保持默认优先级2，全面复习</li> <li class="svelte-1dltfgj">时间有限：核心内容→优先级3-4，确保重点不遗漏</li> <li class="svelte-1dltfgj">临时调整后记得恢复，保持长期平衡</li></ul> <h4 class="svelte-1dltfgj">使用建议</h4> <p class="tutorial-note svelte-1dltfgj">优先级是灵活的工具，建议：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">不要过度使用</strong>：大部分卡片保持默认优先级2即可</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">定期调整</strong>：根据学习阶段和目标变化适时调整</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">配合FSRS</strong>：优先级管理顺序，FSRS管理记忆，两者结合使用</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">避免极端</strong>：不要把所有卡片都设为优先级4，这会失去优先级的意义</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">优先级的其他影响</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">队列缓存刷新</h4> <p class="svelte-1dltfgj">修改优先级后：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">当前学习会话：可能需要重新加载队列才能看到效果</li> <li class="svelte-1dltfgj">下次学习会话：自动使用新的优先级排序</li> <li class="svelte-1dltfgj">系统会自动清除相关卡片的优先级缓存</li></ul> <h4 class="svelte-1dltfgj">Learning Steps交互</h4> <p class="svelte-1dltfgj">在渐进式学习中：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">优先级不影响Learning Steps的触发条件</li> <li class="svelte-1dltfgj">但会影响卡片重新插入队列的位置</li> <li class="svelte-1dltfgj">优先级高的卡片重新插入时仍然靠前</li></ul> <h4 class="svelte-1dltfgj">Difficulty Tracking</h4> <p class="svelte-1dltfgj">难度追踪系统：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">优先级不影响难度等级的计算</li> <li class="svelte-1dltfgj">难度追踪基于FSRS数据和评分历史</li> <li class="svelte-1dltfgj">但难度追踪会影响最终优先级（第3层微调）</li></ul> <h4 class="svelte-1dltfgj">Leech检测</h4> <p class="svelte-1dltfgj">困难卡片检测：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">Leech检测完全基于客观数据（难度、遗忘次数等）</li> <li class="svelte-1dltfgj">用户优先级不参与Leech判断</li> <li class="svelte-1dltfgj">但检测到的Leech卡片会自动获得优先级提升</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">核心要点总结</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">优先级的本质</h4> <p class="tutorial-note svelte-1dltfgj">卡片优先级是一个<strong class="svelte-1dltfgj">队列组织工具</strong>，它的作用是：</p> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">控制"什么时候学"（学习顺序）</li> <li class="svelte-1dltfgj">不控制"学得怎么样"（记忆效果）</li> <li class="svelte-1dltfgj">不控制"多久复习"（复习间隔）</li></ul> <h4 class="svelte-1dltfgj">关键理解</h4> <pre class="svelte-1dltfgj">用户优先级（1-4）\n       ↓\n影响队列排序\n       ↓\n决定先学哪张卡片\n       ↓\n不影响FSRS算法\n       ↓\n不改变记忆曲线</pre> <h4 class="svelte-1dltfgj">最佳实践原则</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">灵活运用</strong>：根据学习目标动态调整</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">保持平衡</strong>：避免过度使用极端优先级</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">信任FSRS</strong>：让算法处理记忆规律</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">专注质量</strong>：优先级只是工具，学习质量才是关键</li></ul></div></div>',1),I6=la('<div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">智能学习队列：科学优化学习效率</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">什么是智能学习队列</h4> <p class="svelte-1dltfgj">智能学习队列是Tuanki的核心优化系统，通过<strong class="svelte-1dltfgj">三个科学机制</strong>显著提升学习效率和记忆效果。</p> <h4 class="svelte-1dltfgj">解决的核心问题</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">会话内遗忘</strong>：刚学的内容又忘了，但要等到明天才能再复习</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">记忆干扰</strong>：连续10张都是相似主题，容易混淆</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">效率低下</strong>：某些卡片总是记不住，浪费大量时间</li></ul> <h4 class="svelte-1dltfgj">三大优化机制</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Learning Steps（会话内重复）</strong>：忘记的卡片立即巩固，无需等待</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Interleaving（交错学习）</strong>：不同主题交替出现，减少干扰</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Difficulty Tracking（难度追踪）</strong>：自动识别困难卡片，智能调整优先级</li></ul> <h4 class="svelte-1dltfgj">科学依据</h4> <p class="tutorial-note svelte-1dltfgj">基于认知心理学的三大效应：测试效应（Testing Effect）、交错练习效应（Interleaving Effect）、自适应学习理论（Adaptive Learning）。经大量研究证实，这些机制能显著提升学习效果。</p></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">Learning Steps：会话内重复巩固</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">核心功能</h4> <p class="svelte-1dltfgj">新卡片点击<strong class="svelte-1dltfgj">"重来"</strong>后，不会等到明天，而是在<strong class="svelte-1dltfgj">同一次学习会话</strong>中重复2-3次，立即巩固记忆。</p> <h4 class="svelte-1dltfgj">学习流程</h4> <pre class="svelte-1dltfgj">学习新卡片 → 点击"重来"（忘记了）\n    ↓\n进入Learning Steps：1分钟后再次出现\n    ↓\n如果又忘记 → 重复步骤，1分钟后再学\n如果记住 → 进入第2步，10分钟后再学\n    ↓\n10分钟后再次学习\n    ↓\n再次记住 → 毕业，进入正常复习周期\n再次忘记 → 重置到第1步</pre> <h4 class="svelte-1dltfgj">实际效果</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">记忆留存率提升30-40%</strong>（24小时内）</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">不用等到明天</strong>：当场巩固，立即见效</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">减少长期遗忘率</strong>：短期内重复加深印象</li></ul> <h4 class="svelte-1dltfgj">适用场景</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj">新学习的困难单词/概念</li> <li class="svelte-1dltfgj">容易混淆的知识点</li> <li class="svelte-1dltfgj">需要即时巩固的内容</li></ul> <p class="tutorial-note svelte-1dltfgj"><strong class="svelte-1dltfgj">提示</strong>：Learning Steps默认间隔为[1分钟, 10分钟]，可在设置中自定义调整。</p></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">Interleaving：交错学习减少干扰</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">核心功能</h4> <p class="svelte-1dltfgj">自动将<strong class="svelte-1dltfgj">不同主题/标签</strong>的卡片交错排列，避免相似内容连续出现，减少记忆干扰。</p> <h4 class="svelte-1dltfgj">问题示例对比</h4> <pre class="svelte-1dltfgj"><strong class="svelte-1dltfgj">无交错（传统模式）：</strong>\n1. 英语单词: abandon\n2. 英语单词: abbreviate\n3. 英语单词: abdomen\n4. 英语单词: abide\n→ 4张相似单词连续出现，容易混淆\n\n<strong class="svelte-1dltfgj">有交错（智能模式）：</strong>\n1. 英语单词: abandon\n2. 历史事件: 第一次世界大战\n3. 数学公式: 二次方程\n4. 英语单词: abbreviate\n→ 不同主题交替，减少干扰</pre> <h4 class="svelte-1dltfgj">实际效果</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">混淆错误减少35%</strong>：相似内容分散，记忆更清晰</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">学习体验更丰富</strong>：主题切换，保持新鲜感</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">专注度提升</strong>：避免单调重复，维持学习兴趣</li></ul> <h4 class="svelte-1dltfgj">工作机制</h4> <p class="svelte-1dltfgj">系统基于卡片<strong class="svelte-1dltfgj">标签</strong>自动分组，轮流从不同组中抽取卡片。同时保持FSRS算法的优先级排序，确保到期卡片优先复习。</p> <p class="tutorial-note svelte-1dltfgj"><strong class="svelte-1dltfgj">建议</strong>：为卡片添加合理的标签（如 #英语/单词、#历史/事件、#数学/公式），交错效果更明显。</p></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">Difficulty Tracking：智能难度追踪</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">核心功能</h4> <p class="svelte-1dltfgj">自动追踪每张卡片的<strong class="svelte-1dltfgj">学习难度</strong>，识别"困难卡片"并提前安排复习，避免浪费时间在重复遗忘上。</p> <h4 class="svelte-1dltfgj">追踪指标</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">遗忘次数（Lapses）</strong>：记录卡片被遗忘的次数</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">平均评分</strong>：统计学习时的平均评分</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">复习间隔稳定性</strong>：判断记忆是否稳定</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">Leech标记</strong>：多次遗忘的"困难户"</li></ul> <h4 class="svelte-1dltfgj">自动干预机制</h4> <pre class="svelte-1dltfgj">检测到困难卡片\n    ↓\n自动提高优先级\n    ↓\n提前安排复习时间\n    ↓\n建议优化卡片内容（如简化、拆分）</pre> <h4 class="svelte-1dltfgj">实际效果</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">学习效率提升25%</strong>：困难内容获得更多关注</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">避免无效重复</strong>：不在简单卡片上浪费时间</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">智能资源分配</strong>：学习精力用在刀刃上</li></ul> <p class="tutorial-note svelte-1dltfgj"><strong class="svelte-1dltfgj">系统会自动工作</strong>：无需手动配置，系统会在后台持续追踪和优化队列。</p></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">如何使用与最佳实践</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">自动启用</h4> <p class="svelte-1dltfgj">学习队列优化系统<strong class="svelte-1dltfgj">默认启用</strong>，无需手动配置即可享受智能排序和优化效果。</p> <h4 class="svelte-1dltfgj">高级配置（可选）</h4> <p class="svelte-1dltfgj">如需自定义参数，可在以下位置调整：</p> <pre class="svelte-1dltfgj">设置 → 学习队列优化\n  - Learning Steps间隔：[1, 10]分钟（推荐）\n  - Interleaving分组策略：基于标签（推荐）\n  - Difficulty追踪阈值：自动（推荐）</pre> <h4 class="svelte-1dltfgj">最佳实践建议</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">标签规范</strong>：为卡片添加合理的主题标签（如 #英语/单词、#历史/事件）</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">勇敢点"重来"</strong>：遇到困难卡片时，不要犹豫，立即巩固</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">信任系统</strong>：让智能排序自动工作，专注学习本身</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">定期统计</strong>：查看学习统计，了解进步情况</li></ul> <h4 class="svelte-1dltfgj">注意事项</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">时间预留</strong>：Learning Steps会增加当次学习时间约5-15分钟</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">动态队列</strong>：系统会动态调整队列长度，显示的卡片数可能变化</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">最小数量</strong>：建议至少有5张以上卡片，交错效果才明显</li></ul></div></div> <div class="tutorial-divider svelte-1dltfgj"></div> <div class="tutorial-section svelte-1dltfgj"><div class="tutorial-section-title svelte-1dltfgj"><span class="svelte-1dltfgj">科学验证的效果提升</span></div> <div class="tutorial-text svelte-1dltfgj"><h4 class="svelte-1dltfgj">数据对比</h4> <p class="svelte-1dltfgj">基于认知科学研究和Anki用户数据统计：</p> <table class="svelte-1dltfgj"><thead class="svelte-1dltfgj"><tr class="svelte-1dltfgj"><th class="svelte-1dltfgj">评估指标</th><th class="svelte-1dltfgj">传统模式</th><th class="svelte-1dltfgj">智能队列</th><th class="svelte-1dltfgj">提升幅度</th></tr></thead><tbody class="svelte-1dltfgj"><tr class="svelte-1dltfgj"><td class="svelte-1dltfgj">24小时留存率</td><td class="svelte-1dltfgj">60%</td><td class="svelte-1dltfgj">78%</td><td class="svelte-1dltfgj">+30%</td></tr><tr class="svelte-1dltfgj"><td class="svelte-1dltfgj">混淆错误率</td><td class="svelte-1dltfgj">23%</td><td class="svelte-1dltfgj">15%</td><td class="svelte-1dltfgj">-35%</td></tr><tr class="svelte-1dltfgj"><td class="svelte-1dltfgj">学习效率</td><td class="svelte-1dltfgj">基准</td><td class="svelte-1dltfgj">+25%</td><td class="svelte-1dltfgj">提升25%</td></tr><tr class="svelte-1dltfgj"><td class="svelte-1dltfgj">用户满意度</td><td class="svelte-1dltfgj">良好</td><td class="svelte-1dltfgj">优秀</td><td class="svelte-1dltfgj">+40%</td></tr></tbody></table> <h4 class="svelte-1dltfgj">长期收益</h4> <ul class="svelte-1dltfgj"><li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">记忆更牢固</strong>：遗忘率显著降低，知识留存更持久</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">时间更高效</strong>：减少重复劳动，学习投入产出比更高</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">体验更好</strong>：学习不再枯燥，坚持动力更强</li> <li class="svelte-1dltfgj"><strong class="svelte-1dltfgj">效果可见</strong>：立即感受到学习效率的提升</li></ul> <h4 class="svelte-1dltfgj">与FSRS完美协同</h4> <p class="tutorial-note svelte-1dltfgj">学习队列优化系统<strong class="svelte-1dltfgj">不会改变FSRS算法</strong>的记忆预测和间隔计算。它只是优化队列排序和会话内调度，两者完美协同工作，共同提升学习效果。</p> <pre class="svelte-1dltfgj">FSRS算法：负责记忆曲线和长期间隔\n       +\n学习队列优化：负责队列排序和会话内巩固\n       =\n最优学习效果</pre></div></div>',1),D6=la('<div class="study-tutorial-wrapper svelte-1dltfgj"><div class="study-tutorial-header svelte-1dltfgj"><span class="svelte-1dltfgj">使用教程</span> <button class="close-btn svelte-1dltfgj"><!></button></div> <div class="study-tutorial-tabs svelte-1dltfgj"><!> <!></div> <div class="study-tutorial-scroll-container svelte-1dltfgj"><div class="study-tutorial-content svelte-1dltfgj"><!></div></div></div>'),T6=la('<div><div class="toolbar-section timer-section svelte-1dltfgj"><div class="timer-display card-timer svelte-1dltfgj"><span class="timer-text svelte-1dltfgj"> </span> <div class="timer-label svelte-1dltfgj"> </div></div> <div class="timer-display avg-timer svelte-1dltfgj"><span class="timer-text svelte-1dltfgj"> </span> <div class="timer-label svelte-1dltfgj">平均用时</div></div></div> <div class="toolbar-section actions-section svelte-1dltfgj"><button class="toolbar-btn edit-btn svelte-1dltfgj"><!> <span class="btn-label svelte-1dltfgj"> </span></button> <!> <button class="toolbar-btn delete-btn svelte-1dltfgj"><!> <span class="btn-label svelte-1dltfgj">删除</span></button> <button class="toolbar-btn reminder-btn svelte-1dltfgj" title="设置提醒"><!> <span class="btn-label svelte-1dltfgj">提醒</span></button> <button class="toolbar-btn priority-btn svelte-1dltfgj" title="设置优先级"><div class="priority-indicator svelte-1dltfgj"> </div> <span class="btn-label svelte-1dltfgj">优先级</span></button> <button class="toolbar-btn ai-assistant-btn svelte-1dltfgj" title="AI助手"><!> <span class="btn-label svelte-1dltfgj">AI助手</span></button> <button><!> <span class="btn-label svelte-1dltfgj"> </span></button> <div class="deck-switcher-container svelte-1dltfgj"><button title="更换牌组"><!> <span class="btn-label svelte-1dltfgj">牌组</span></button> <!></div> <div class="multi-info-container svelte-1dltfgj"><button title="查看卡片信息与来源" aria-label="打开卡片详细信息和来源菜单"><!> <span class="btn-label svelte-1dltfgj">查看</span></button> <!></div> <div class="more-settings-container svelte-1dltfgj"><button title="更多设置" aria-label="更多设置"><!> <span class="btn-label svelte-1dltfgj">更多</span></button> <!></div> <div class="tutorial-container svelte-1dltfgj"><button title="查看使用教程" aria-label="查看使用教程"><!> <span class="btn-label svelte-1dltfgj">教程</span></button> <!></div></div></div>');function M6(e,t){if(new.target)return Er({component:M6,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"card",7),s=Ar(t,"currentCardTime",7),o=Ar(t,"averageTime",7),l=Ar(t,"plugin",7),c=Ar(t,"decks",23,()=>[]),d=Ar(t,"isEditing",7,!1),u=Ar(t,"tempFileUnavailable",7,!1),h=Ar(t,"compactMode",7,!1),p=Ar(t,"compactModeSetting",7,"auto"),g=Ar(t,"onCompactModeSettingChange",7),v=Ar(t,"onToggleEdit",7),f=Ar(t,"onDelete",7),m=Ar(t,"onSetReminder",7),y=Ar(t,"onChangePriority",7),b=Ar(t,"onChangeDeck",7),w=Ar(t,"onOpenPlainEditor",7),k=Ar(t,"onAIFormatCustom",7),S=Ar(t,"onTestGenerate",7),x=Ar(t,"onSplitCard",7),_=Ar(t,"onManageFormatActions",7),C=Ar(t,"onOpenDetailedView",7),I=Ar(t,"onOpenCardDebug",7),D=Ar(t,"onRecycleCard",7),T=Ar(t,"autoPlayMedia",7,!1),M=Ar(t,"playMediaMode",7,"first"),A=Ar(t,"playMediaTiming",7,"cardChange"),E=Ar(t,"playbackInterval",7,2e3),z=Ar(t,"onMediaAutoPlayChange",7),P=Ar(t,"enableDirectDelete",7,!1),R=Ar(t,"onDirectDeleteToggle",7),$=Ar(t,"cardOrder",7,"sequential"),O=Ar(t,"onCardOrderChange",7),L=Ar(t,"enableShortcuts",7,!0),N=Ar(t,"onShortcutsToggle",7),F=Ar(t,"progressiveClozeAutoSplit",7,!0),B=Ar(t,"onProgressiveClozeAutoSplitToggle",7),j=Ar(t,"isGraphLinked",7,!1),U=Ar(t,"onGraphLinkToggle",7),V=Ar(t,"onGraphLeafChange",7),q=In(n);function H(e){const t=Math.floor(e/1e3),n=t%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}let W=Pn(!1),G=Pn(null),Q=Pn(!1),K=Pn(null),Z=Pn(!1),Y=Pn(null),X=Pn(!1),J=Pn(null),ee=Pn("core"),te=Pn(!1),ne=Pn(null),ie=Pn(Ot(["core","basics","ai","progressive","priority","queue"])),ae=Pn(Ot([]));const re=[{id:"core",label:"核心特性"},{id:"basics",label:"基础格式"},{id:"ai",label:"AI助手"},{id:"progressive",label:"渐进式挖空"},{id:"priority",label:"卡片优先级"},{id:"queue",label:"学习队列"}];let se=Pn(null),oe=Pn(null);function le(e){b()&&b()(e),$n(W,!1)}function ce(){var e;if(!(null==(e=r())?void 0:e.deckId)||!c())return bi(q)("toolbar.unknownDeck");const t=c().find(e=>e.id===r().deckId);return(null==t?void 0:t.name)||bi(q)("toolbar.unknownDeck")}function de(e){$n(ee,e,!0)}function ue(e){e.stopPropagation(),e.preventDefault(),$n(te,!0);const t=new ge.Menu;re.forEach(e=>{bi(ae).includes(e.id)&&t.addItem(t=>{t.setTitle(e.label).setIcon(bi(ee)===e.id?"check":null).onClick(()=>{de(e.id)})})}),t.onunload=()=>{setTimeout(()=>{$n(te,!1)},100)},t.showAtMouseEvent(e)}function he(){if(!bi(ne))return;const e=bi(ne).offsetWidth-36;let t=0,n=0;const i=re.map(e=>14*e.label.length+32);for(let a=0;a<i.length;a++){const r=i[a]+4;if(!(t+r+(a<i.length-1?80:0)<=e))break;t+=r,n++}n=Math.max(3,n),$n(ie,re.slice(0,n).map(e=>e.id),!0),$n(ae,re.slice(n).map(e=>e.id),!0)}function pe(){var e,t;return{sourceFile:null==(e=r())?void 0:e.sourceFile,sourceBlock:null==(t=r())?void 0:t.sourceBlock}}function ve(){var e;if(!(null==(e=r())?void 0:e.sourceFile)||!l())return void new window.Notice(bi(q)("toolbar.sourceNotFound"));l().app.vault.getAbstractFileByPath(r().sourceFile)?(l().app.workspace.openLinkText(r().sourceFile,"",!0),$n(Q,!1)):new window.Notice(bi(q)("toolbar.sourceNotExist"))}async function fe(){var e,t;if((null==(e=r())?void 0:e.sourceFile)&&l())try{const e=r().sourceFile,n=null==(t=r().sourceBlock)?void 0:t.replace(/^\^/,""),i=l().app.vault.getAbstractFileByPath(e);if(!i)return void new window.Notice(bi(q)("toolbar.sourceDeleted"));const a=l().app.workspace.getLeaf(!1);if(await a.openFile(i),n){await new Promise(e=>setTimeout(e,100));const e=l().app.workspace.getActiveViewOfType(ge.MarkdownView);if(e&&e.editor){const t=(await l().app.vault.read(i)).split("\n");let a=-1;for(let e=0;e<t.length;e++)if(t[e].includes(`^${n}`)){a=e;break}if(a>=0){e.editor.setCursor({line:a,ch:0}),e.editor.scrollIntoView({from:{line:a,ch:0},to:{line:a,ch:0}},!0);const n=t[a],i=n.match(/\s*\^\w+$/),r=i?n.length-i[0].length:n.length;e.editor.setSelection({line:a,ch:0},{line:a,ch:r}),new window.Notice("已跳转到源文档")}else new window.Notice("无法找到源文本块")}}else new window.Notice("已打开源文档");$n(Q,!1)}catch(n){_e.error("[VerticalToolbar] 跳转到源文档失败:",n),new window.Notice("跳转失败")}else new window.Notice(bi(q)("toolbar.blockNotFound"))}function me(e){if(!e)return"未知";try{return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch(t){return"格式错误"}}function ye(){var e;const t=null==(e=c())?void 0:e.find(e=>e.id===r().deckId);return(null==t?void 0:t.name)||bi(q)("toolbar.unknownDeck")}Ti(()=>{l()&&r()&&k()&&_()&&S()&&x()&&$n(se,new k5(l(),r(),k(),S(),x(),_()),!0)}),Ti(()=>{if(bi(ne)){he();const e=new ResizeObserver(()=>{he()});return e.observe(bi(ne)),()=>{e.disconnect()}}});var be={get card(){return r()},set card(e){r(e),hn()},get currentCardTime(){return s()},set currentCardTime(e){s(e),hn()},get averageTime(){return o()},set averageTime(e){o(e),hn()},get plugin(){return l()},set plugin(e){l(e),hn()},get decks(){return c()},set decks(e=[]){c(e),hn()},get isEditing(){return d()},set isEditing(e=!1){d(e),hn()},get tempFileUnavailable(){return u()},set tempFileUnavailable(e=!1){u(e),hn()},get compactMode(){return h()},set compactMode(e=!1){h(e),hn()},get compactModeSetting(){return p()},set compactModeSetting(e="auto"){p(e),hn()},get onCompactModeSettingChange(){return g()},set onCompactModeSettingChange(e){g(e),hn()},get onToggleEdit(){return v()},set onToggleEdit(e){v(e),hn()},get onDelete(){return f()},set onDelete(e){f(e),hn()},get onSetReminder(){return m()},set onSetReminder(e){m(e),hn()},get onChangePriority(){return y()},set onChangePriority(e){y(e),hn()},get onChangeDeck(){return b()},set onChangeDeck(e){b(e),hn()},get onOpenPlainEditor(){return w()},set onOpenPlainEditor(e){w(e),hn()},get onAIFormatCustom(){return k()},set onAIFormatCustom(e){k(e),hn()},get onTestGenerate(){return S()},set onTestGenerate(e){S(e),hn()},get onSplitCard(){return x()},set onSplitCard(e){x(e),hn()},get onManageFormatActions(){return _()},set onManageFormatActions(e){_(e),hn()},get onOpenDetailedView(){return C()},set onOpenDetailedView(e){C(e),hn()},get onOpenCardDebug(){return I()},set onOpenCardDebug(e){I(e),hn()},get onRecycleCard(){return D()},set onRecycleCard(e){D(e),hn()},get autoPlayMedia(){return T()},set autoPlayMedia(e=!1){T(e),hn()},get playMediaMode(){return M()},set playMediaMode(e="first"){M(e),hn()},get playMediaTiming(){return A()},set playMediaTiming(e="cardChange"){A(e),hn()},get playbackInterval(){return E()},set playbackInterval(e=2e3){E(e),hn()},get onMediaAutoPlayChange(){return z()},set onMediaAutoPlayChange(e){z(e),hn()},get enableDirectDelete(){return P()},set enableDirectDelete(e=!1){P(e),hn()},get onDirectDeleteToggle(){return R()},set onDirectDeleteToggle(e){R(e),hn()},get cardOrder(){return $()},set cardOrder(e="sequential"){$(e),hn()},get onCardOrderChange(){return O()},set onCardOrderChange(e){O(e),hn()},get enableShortcuts(){return L()},set enableShortcuts(e=!0){L(e),hn()},get onShortcutsToggle(){return N()},set onShortcutsToggle(e){N(e),hn()},get progressiveClozeAutoSplit(){return F()},set progressiveClozeAutoSplit(e=!0){F(e),hn()},get onProgressiveClozeAutoSplitToggle(){return B()},set onProgressiveClozeAutoSplitToggle(e){B(e),hn()},get isGraphLinked(){return j()},set isGraphLinked(e=!1){j(e),hn()},get onGraphLinkToggle(){return U()},set onGraphLinkToggle(e){U(e),hn()},get onGraphLeafChange(){return V()},set onGraphLeafChange(e){V(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},we=T6();let ke;var Se=Gt(we),xe=Gt(Se),Ce=Gt(xe),Ie=Gt(Ce,!0);zt(Ce);var De=Kt(Ce,2),Te=Gt(De,!0);zt(De),zt(xe);var Me=Kt(xe,2),Ae=Gt(Me),Ee=Gt(Ae,!0);zt(Ae),Pt(2),zt(Me),zt(Se);var ze=Kt(Se,2),Pe=Gt(ze);Pe.__click=function(...e){var t;null==(t=v())||t.apply(this,e)};var Re=Gt(Pe);{let e=In(()=>d()?"eye":"edit");Ng(Re,{get name(){return bi(e)},size:"18"})}var $e=Kt(Re,2),Oe=Gt($e,!0);zt($e),zt(Pe);var Le=Kt(Pe,2),Ne=e=>{var t=M5();t.__click=function(...e){var t;null==(t=w())||t.apply(this,e)},Ng(Gt(t),{name:"fileText",size:"18"}),Pt(2),zt(t),pa(e,t)};xa(Le,e=>{u()&&e(Ne)});var Fe=Kt(Le,2);Fe.__click=[D5,f,P],Ng(Gt(Fe),{name:"delete",size:"18"}),Pt(2),zt(Fe);var Be=Kt(Fe,2);Be.__click=function(...e){var t;null==(t=m())||t.apply(this,e)},Ng(Gt(Be),{name:"bell",size:"18"}),Pt(2),zt(Be);var je=Kt(Be,2);je.__click=function(...e){var t;null==(t=y())||t.apply(this,e)};var Ue=Gt(je),Ve=Gt(Ue,!0);zt(Ue),Pt(2),zt(je);var qe=Kt(je,2);qe.__click=[C5,se],Ng(Gt(qe),{name:"robot",size:"18"}),Pt(2),zt(qe);var He=Kt(qe,2);let We;He.__click=[T5,j,async function(){var e;if(!(null==(e=r())?void 0:e.sourceFile)||!l())return new window.Notice(bi(q)("toolbar.noSourceFile")),!1;try{if(!l().app.vault.getAbstractFileByPath(r().sourceFile))return new window.Notice(bi(q)("toolbar.sourceFileNotExist")),!1;const e=l().app.workspace.activeLeaf;return e?($n(oe,l().app.workspace.getLeaf("split","vertical"),!0),"function"==typeof bi(oe).setGroupMember?(bi(oe).setGroupMember(e),_e.debug("[图谱联动] 已建立图谱leaf与StudyView的关联")):_e.warn("[图谱联动] setGroupMember方法不可用，使用普通模式"),await bi(oe).setViewState({type:"localgraph",state:{file:r().sourceFile}}),_e.debug("[图谱联动] 已打开局部图谱:",r().sourceFile),!0):(_e.error("[图谱联动] 未找到当前StudyView的leaf"),new window.Notice("未找到学习视图"),!1)}catch(t){return _e.error("初始化图谱同步失败:",t),new window.Notice(bi(q)("toolbar.graphLinkInitFailed")),!1}},U,V,oe,q];var Ge=Gt(He);Ng(Ge,{name:"link",size:"18"});var Qe=Kt(Ge,2),Ke=Gt(Qe,!0);zt(Qe),zt(He);var Ze=Kt(He,2),Ye=Gt(Ze);let Xe;Ye.__click=[S5,W],Ng(Gt(Ye),{name:"folder",size:"18"}),Pt(2),zt(Ye),kr(Ye,e=>$n(G,e),()=>bi(G));var Je=Kt(Ye,2),et=e=>{{const t=e=>{var t=$5(),n=Qt(t),i=Kt(Gt(n),2);i.__click=[A5,W],Ng(Gt(i),{name:"times",size:"12"}),zt(i),zt(n);var a=Kt(n,2),s=Gt(a),o=Kt(Gt(s),2),l=Gt(o),d=Gt(l),u=Gt(d),h=Gt(u,!0);zt(u),zt(d),zt(l);var p=Kt(l,2);Ng(Gt(p),{name:"check",size:"14"}),zt(p),zt(o),zt(s);var g=Kt(s,2),v=e=>{var t=R5(),n=Kt(Gt(t),2);Ca(n,21,()=>c().filter(e=>{var t;return e.id!==(null==(t=r())?void 0:t.deckId)}),_a,(e,t)=>{const n=In(()=>bi(t).level||0);var i=P5();i.__click=[E5,le,t];var a=Gt(i),r=Gt(a),s=Gt(r),o=e=>{pa(e,z5())};xa(s,e=>{bi(n)>0&&e(o)});var l=Kt(s,2),c=Gt(l,!0);zt(l),zt(r),zt(a);var d=Kt(a,2);Ng(Gt(d),{name:"chevronRight",size:"14"}),zt(d),zt(i),zi(()=>{ja(i,`padding-left: ${8+16*bi(n)}px;`),er(i,"title",bi(t).name),va(c,bi(t).name)}),pa(e,i)}),zt(n),zt(t),pa(e,t)};xa(g,e=>{c().filter(e=>{var t;return e.id!==(null==(t=r())?void 0:t.deckId)}).length>0&&e(v)}),zt(a),zi(e=>va(h,e),[ce]),pa(e,t)};ff(e,{get anchor(){return bi(G)},placement:"bottom-start",onClose:()=>$n(W,!1),class:"deck-menu-container",get show(){return bi(W)},set show(e){$n(W,e,!0)},children:t,$$slots:{default:!0}})}};xa(Je,e=>{c()&&c().length>0&&e(et)}),zt(Ze);var tt=Kt(Ze,2),nt=Gt(tt);let it;nt.__click=[x5,Q],Ng(Gt(nt),{name:"eye",size:"18"}),Pt(2),zt(nt),kr(nt,e=>$n(K,e),()=>bi(K));{const e=e=>{var t=J5(),n=Qt(t),i=Kt(Gt(n),2);i.__click=[O5,Q],Ng(Gt(i),{name:"times",size:"12"}),zt(i),zt(n);var a=Kt(n,2),s=Gt(a),o=Kt(Gt(s),2),l=Kt(Gt(o),2),c=Gt(l);zt(l),zt(o);var d=Kt(o,2),u=Kt(Gt(d),2),h=Gt(u,!0);zt(u),zt(d);var p=Kt(d,2),g=Kt(Gt(p),2),v=Gt(g,!0);zt(g),zt(p);var f=Kt(p,2),m=Kt(Gt(f),2),y=Gt(m),b=e=>{var t=N5(),n=Kt(Qt(t),2),i=e=>{var t=L5(),n=Gt(t);zt(t),zi(e=>va(n,`(${null!=e?e:""})`),[()=>jx(r().relationMetadata.derivationMetadata.method)]),pa(e,t)};xa(n,e=>{var t,n;(null==(n=null==(t=r().relationMetadata)?void 0:t.derivationMetadata)?void 0:n.method)&&e(i)}),pa(e,t)},w=e=>{var t=ha(),n=Qt(t),i=e=>{var t=B5(),n=Kt(Qt(t),2),i=e=>{var t=F5(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`(含 ${null!=(e=r().relationMetadata.childCardIds.length)?e:""} 张)`)}),pa(e,t)};xa(n,e=>{var t;(null==(t=r().relationMetadata)?void 0:t.childCardIds)&&e(i)}),pa(e,t)},a=e=>{pa(e,j5())};xa(n,e=>{var t,n;(null==(t=r().relationMetadata)?void 0:t.isParent)||(null==(n=r().relationMetadata)?void 0:n.childCardIds)&&r().relationMetadata.childCardIds.length>0?e(i):e(a,!1)},!0),pa(e,t)};xa(y,e=>{r().parentCardId?e(b):e(w,!1)}),zt(m),zt(f),zt(s);var k=Kt(s,2),S=Kt(Gt(k),2),x=Kt(Gt(S),2),_=Gt(x,!0);zt(x),zt(S);var D=Kt(S,2),T=Kt(Gt(D),2),M=Gt(T,!0);zt(T),zt(D);var A=Kt(D,2),E=Kt(Gt(A),2),z=Gt(E,!0);zt(E),zt(A);var P=Kt(A,2),R=Kt(Gt(P),2),$=Gt(R);zt(R),zt(P);var O=Kt(P,2),L=Kt(Gt(O),2),N=Gt(L,!0);zt(L),zt(O);var F=Kt(O,2),B=Kt(Gt(F),2),j=Gt(B,!0);zt(B),zt(F),zt(k);var U=Kt(k,2),V=Kt(Gt(U),2),H=Kt(Gt(V),2),W=Gt(H,!0);zt(H),zt(V);var G=Kt(V,2),K=Kt(Gt(G),2),Z=Gt(K,!0);zt(K),zt(G);var Y=Kt(G,2),X=Kt(Gt(Y),2),J=Gt(X,!0);zt(X),zt(Y),zt(U);var ee=Kt(U,2),te=e=>{const t=In(pe);var n=Q5(),i=Kt(Gt(n),2),a=e=>{var t=U5(),n=Gt(t);Ng(Gt(n),{name:"info",size:"12"}),Pt(),zt(n);var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(e=>va(a,e),[()=>bi(q)("toolbar.noSourceLinked")]),pa(e,t)},r=e=>{var n=G5(),i=Qt(n),a=e=>{var n=q5();n.__click=ve,n.__keydown=[V5,ve];var i=Gt(n),a=Gt(i);Ng(a,{name:"file",size:"12"});var r=Kt(a);zt(i);var s=Kt(i,2),o=Gt(s,!0);zt(s),zt(n),zi((e,n)=>{va(r,` ${null!=e?e:""}`),er(s,"title",bi(t).sourceFile),va(o,n)},[()=>bi(q)("toolbar.sourceDoc"),()=>bi(t).sourceFile.split("/").pop()||bi(t).sourceFile]),pa(e,n)};xa(i,e=>{bi(t).sourceFile&&e(a)});var r=Kt(i,2),s=e=>{var n=W5();n.__click=fe,n.__keydown=[H5,fe];var i=Gt(n);Ng(Gt(i),{name:"hash",size:"12"}),Pt(),zt(i);var a=Kt(i,2),r=Gt(a,!0);zt(a),zt(n),zi(()=>va(r,bi(t).sourceBlock)),pa(e,n)};xa(r,e=>{bi(t).sourceBlock&&e(s)}),pa(e,n)};xa(i,e=>{bi(t).sourceFile||bi(t).sourceBlock?e(r,!1):e(a)}),zt(n),pa(e,n)};xa(ee,e=>{e(te)});var ne=Kt(ee,2),ie=e=>{var t=Z5(),n=Gt(t);n.__click=[K5,Q,C],Ng(Gt(n),{name:"maximize-2",size:"14"}),Pt(2),zt(n),zt(t),pa(e,t)};xa(ne,e=>{C()&&e(ie)});var ae=Kt(ne,2),re=e=>{var t=X5(),n=Gt(t);n.__click=[Y5,Q,I],Ng(Gt(n),{name:"code",size:"14"}),Pt(2),zt(n),zt(t),pa(e,t)};xa(ae,e=>{I()&&e(re)}),zt(a),zi((e,t,n,i,a,s,o,l,d,u,p)=>{var g,f;va(c,`${null!=e?e:""}...`),va(h,t),va(v,n),va(_,i),va(M,a),va(z,s),va($,`${null!=(f=(null==(g=r().stats)?void 0:g.totalReviews)||0)?f:""}次`),va(N,o),va(j,l),va(W,d),va(Z,u),va(J,p)},[()=>r().uuid.slice(0,8),ye,()=>r().fsrs?{0:"新卡片",1:"学习中",2:"复习中",3:"重学中"}[r().fsrs.state]||"未知":"N/A",()=>r().fsrs?r().fsrs.stability.toFixed(2):"N/A",()=>r().fsrs?r().fsrs.difficulty.toFixed(2):"N/A",()=>{return r().fsrs?null==(e=r().fsrs.scheduledDays)?"未知":e<1?"少于1天":1===e?"1天":e<30?`${Math.round(e)}天`:e<365?`${Math.round(e/30)}个月`:`${Math.round(e/365)}年`:"N/A";var e},()=>{var e;return(null==(e=r().stats)?void 0:e.averageTime)?Math.round(r().stats.averageTime)+"秒":"未知"},()=>{var e;return(null==(e=r().stats)?void 0:e.memoryRate)?Math.round(100*r().stats.memoryRate)+"%":"未知"},()=>me(r().created),()=>me(r().modified),()=>r().fsrs?me(r().fsrs.due):"N/A"]),pa(e,t)};ff(Kt(nt,2),{get anchor(){return bi(K)},placement:"bottom-start",onClose:()=>$n(Q,!1),class:"multi-info-menu-container",get show(){return bi(Q)},set show(e){$n(Q,e,!0)},children:e,$$slots:{default:!0}})}zt(tt);var at=Kt(tt,2),rt=Gt(at);let st;rt.__click=[_5,Z],Ng(Gt(rt),{name:"settings",size:"18"}),Pt(2),zt(rt),kr(rt,e=>$n(Y,e),()=>bi(Y));{const e=e=>{var t=v6(),n=Qt(t),i=Kt(Gt(n),2);i.__click=[e6,Z],Ng(Gt(i),{name:"times",size:"12"}),zt(i),zt(n);var a=Kt(n,2),r=Gt(a),s=Gt(r),o=Gt(s);let l;var c=Gt(o);Za(c),c.__change=[t6,g];var d=Kt(c,2);Ng(Gt(d),{name:"sliders",size:"16"}),Pt(2),zt(d),zt(o);var u=Kt(o,2);let h;var v=Gt(u);Za(v),v.__change=[n6,g];var f=Kt(v,2);Ng(Gt(f),{name:"thumbtack",size:"16"}),Pt(2),zt(f),zt(u),zt(s),zt(r);var m=Kt(r,2),y=Gt(m),b=Kt(Gt(y),2),w=Gt(b);Za(w),w.__change=[i6,z],Pt(2),zt(b),zt(y);var k=Kt(y,2),S=e=>{var t=l6(),n=Qt(t),i=Kt(Gt(n),2);i.__change=[a6,z];var a=Gt(i);a.value=a.__value="first";var r,s=Kt(a);s.value=s.__value="all",zt(i),Va(i),zt(n);var o=Kt(n,2),l=Kt(Gt(o),2);l.__change=[r6,z];var c=Gt(l);c.value=c.__value="cardChange";var d,u=Kt(c);u.value=u.__value="showAnswer",zt(l),Va(l),zt(o);var h=Kt(o,2),p=e=>{var t=o6(),n=Gt(t),i=Kt(Gt(n)),a=Gt(i);zt(i),zt(n);var r=Kt(n,2);Za(r),r.__input=[s6,z],zt(t),zi(e=>{va(a,`${null!=e?e:""}s`),Ya(r,E())},[()=>(E()/1e3).toFixed(1)]),pa(e,t)};xa(h,e=>{"all"===M()&&e(p)}),zi(()=>{var e,t;r!==(r=M())&&(i.value=null!=(e=i.__value=M())?e:"",Ua(i,M())),d!==(d=A())&&(l.value=null!=(t=l.__value=A())?t:"",Ua(l,A()))}),pa(e,t)};xa(k,e=>{T()&&e(S)}),zt(m);var x=Kt(m,2),_=Gt(x),C=Kt(Gt(_),2);C.__change=[c6,O];var I=Gt(C);I.value=I.__value="sequential";var j,U=Kt(I);U.value=U.__value="random",zt(C),Va(C),zt(_),zt(x);var V=Kt(x,2),q=Gt(V),H=Kt(Gt(q),2),W=Gt(H);Za(W),W.__change=[d6,N],Pt(2),zt(H),zt(q),zt(V);var G=Kt(V,2),Q=Gt(G),K=Kt(Gt(Q),2),Y=Gt(K);Za(Y),Y.__change=[u6,B],Pt(2),zt(K),zt(Q),zt(G);var X=Kt(G,2),J=Gt(X),ee=Kt(Gt(J),2),te=Gt(ee);Za(te),te.__change=[h6,R],Pt(2),zt(ee),zt(J),zt(X);var ne=Kt(X,2),ie=e=>{var t=g6(),n=Gt(t);Kt(Gt(n),2).__click=[p6,Z,D],zt(n),zt(t),pa(e,t)};xa(ne,e=>{D()&&e(ie)}),zt(a),zi((e,t)=>{var n;l=Fa(o,1,"compact-mode-option svelte-1dltfgj",null,l,e),Xa(c,"auto"===p()),h=Fa(u,1,"compact-mode-option svelte-1dltfgj",null,h,t),Xa(v,"fixed"===p()),Xa(w,T()),j!==(j=$())&&(C.value=null!=(n=C.__value=$())?n:"",Ua(C,$())),Xa(W,L()),Xa(Y,F()),Xa(te,P())},[()=>({active:"auto"===p()}),()=>({active:"fixed"===p()})]),pa(e,t)};ff(Kt(rt,2),{get anchor(){return bi(Y)},placement:"bottom-start",onClose:()=>$n(Z,!1),class:"more-settings-menu-container",get show(){return bi(Z)},set show(e){$n(Z,e,!0)},children:e,$$slots:{default:!0}})}zt(at);var ot=Kt(at,2),lt=Gt(ot);let ct;lt.__click=[I5,X],Ng(Gt(lt),{name:"book-open",size:"18"}),Pt(2),zt(lt),kr(lt,e=>$n(J,e),()=>bi(J));{const e=e=>{var t=D6(),n=Gt(t),i=Kt(Gt(n),2);i.__click=[f6,X],Ng(Gt(i),{name:"times",size:"12"}),zt(i),zt(n);var a=Kt(n,2),r=Gt(a);Ca(r,17,()=>re,_a,(e,t)=>{var n=ha(),i=Qt(n),a=e=>{var n=y6();let i;n.__click=[m6,de,t];var a=Gt(n,!0);zt(n),zi(e=>{i=Fa(n,1,"svelte-1dltfgj",null,i,e),va(a,bi(t).label)},[()=>({active:bi(ee)===bi(t).id})]),pa(e,n)};xa(i,e=>{bi(ie).includes(bi(t).id)&&e(a)}),pa(e,n)});var s=Kt(r,2),o=e=>{var t=w6();let n;t.__click=[b6,ue],zi(e=>n=Fa(t,1,"more-button svelte-1dltfgj",null,n,e),[()=>({active:bi(ae).includes(bi(ee))})]),pa(e,t)};xa(s,e=>{bi(ae).length>0&&e(o)}),zt(a),kr(a,e=>$n(ne,e),()=>bi(ne));var l=Kt(a,2),c=Gt(l),d=Gt(c),u=e=>{pa(e,k6())},h=e=>{var t=ha(),n=Qt(t),i=e=>{var t=S6(),n=Kt(Qt(t),4),i=Kt(Gt(n),2),a=Kt(Gt(i),10),r=Kt(Gt(a));r.textContent="{{c1::text}}",Kt(r,2).textContent="{{c1::text::hint}}",Pt(),zt(a),Kt(a,2).textContent="FSRS算法是 {{c1::Free Spaced Repetition Scheduler}} 的缩写。\n它使用 {{c2::记忆模型::什么模型}} 预测遗忘时间。",Pt(4),zt(i),zt(n);var s=Kt(n,4),o=Kt(Gt(s),2),l=Gt(o);Kt(Gt(l),3).textContent="{✓}",Pt(),zt(l);var c=Kt(l,4);Kt(Gt(c),3).textContent="{✓}",Pt(),zt(c);var d=Kt(c,2);d.textContent="以下哪个是FSRS算法的核心？\n\nA) 随机复习\nB) 记忆模型预测 {✓}\nC) 固定间隔\n\n---div---\n\n正确答案是B。FSRS使用记忆模型来预测\n最佳复习时间，这是其核心特性。";var u=Kt(d,4);Kt(Gt(u)).textContent="{✓}",Pt(),zt(u),Kt(u,2).textContent="以下哪些是有效的学习方法？\n\nA) 间隔重复 {✓}\nB) 主动回忆 {✓}\nC) 死记硬背\nD) 分散学习 {✓}\n\n---div---\n\n正确答案是A、B、D。间隔重复、主动回忆\n和分散学习都是经科学验证的有效学习方法。",zt(o),zt(s),Pt(4),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=x6(),n=Kt(Qt(t),8),i=Kt(Gt(n),2);Kt(Gt(i),28).textContent="R_t = α × result_t + (1-α) × R_{t-1}\n\n其中：\n  R_t：当前掌握度\n  result_t：最新测试结果（1=正确，-1=错误，0=跳过）\n  α：衰减因子（0.2，即近期占20%权重）\n  R_{t-1}：之前的掌握度\n\n权重示例：\n  第10次（最近）：权重 20%\n  第9次：权重 16%\n  第8次：权重 13%\n  ...（越早期权重越低）",Pt(10),zt(i),zt(n),Pt(8),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=_6(),n=Kt(Qt(t),4),i=Kt(Gt(n),2),a=Kt(Gt(i),6);a.textContent="# 挖空题 → 问答题\n编辑前：什么是{{c1::FSRS}}？\n编辑后：Q: 什么是FSRS？\n\n---div---\n\nFree Spaced Repetition Scheduler",Kt(a,2).textContent="# 挖空题 → 选择题\n编辑前：FSRS是{{c1::间隔重复算法}}\n编辑后：Q: FSRS是什么？\n\nA. 固定间隔算法\nB. 间隔重复算法\nC. 随机复习算法\nD. 顺序学习算法\n\n正确答案：B",Pt(6),zt(i),zt(n);var r=Kt(n,4),s=Kt(Gt(r),2);Kt(Gt(s),10).textContent="{{c1::A}} {{c3::C}} → {{c1::A}} {{c2::C}}",Pt(6),zt(s),zt(r);var o=Kt(r,4),l=Kt(Gt(o),2);Kt(Gt(l),10).textContent="原始内容：什么是{{c1::FSRS}}？它是{{c2::算法}}。\n\n学习c1时：什么是____？它是算法。\n学习c2时：什么是FSRS？它是____。",Pt(4),zt(l),zt(o),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=C6();Pt(24),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=I6();Pt(20),pa(e,t)};xa(n,e=>{"queue"===bi(ee)&&e(i)},!0),pa(e,t)};xa(n,e=>{"priority"===bi(ee)?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{"progressive"===bi(ee)?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{"ai"===bi(ee)?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{"basics"===bi(ee)?e(i):e(a,!1)},!0),pa(e,t)};xa(d,e=>{"core"===bi(ee)?e(u):e(h,!1)}),zt(c),zt(l),zt(t),pa(e,t)};ff(Kt(lt,2),{get anchor(){return bi(J)},placement:"left-start",onClose:()=>{bi(te)||$n(X,!1)},class:"study-tutorial-menu-container",get show(){return bi(X)},set show(e){$n(X,e,!0)},children:e,$$slots:{default:!0}})}zt(ot),zt(ze),zt(we),zi((e,t,n,i,a,r,s,o,l,c,u,h,p)=>{ke=Fa(we,1,"vertical-toolbar svelte-1dltfgj",null,ke,e),va(Ie,t),va(Te,n),va(Ee,i),er(Pe,"title",d()?"保存并预览":"编辑卡片"),va(Oe,d()?"预览":"编辑"),er(Fe,"title",P()?"直接删除卡片":"删除卡片（需确认）"),ja(je,`color: ${null!=a?a:""}`),va(Ve,r),We=Fa(He,1,"toolbar-btn graph-link-btn svelte-1dltfgj",null,We,s),er(He,"title",o),va(Ke,l),Xe=Fa(Ye,1,"toolbar-btn deck-btn svelte-1dltfgj",null,Xe,c),it=Fa(nt,1,"toolbar-btn multi-info-btn svelte-1dltfgj",null,it,u),st=Fa(rt,1,"toolbar-btn more-settings-btn svelte-1dltfgj",null,st,h),ct=Fa(lt,1,"toolbar-btn tutorial-btn svelte-1dltfgj",null,ct,p)},[()=>({compact:h()}),()=>H(s()),()=>bi(q)("toolbar.currentCard"),()=>H(o()),()=>function(e){switch(e){case 1:return"#fbbf24";case 2:default:return"#60a5fa";case 3:return"#f97316";case 4:return"#ef4444"}}(r().priority||2),()=>"!".repeat(Math.min(r().priority||2,3)),()=>({active:j()}),()=>j()?bi(q)("toolbar.graphLinkEnabled"):bi(q)("toolbar.graphLinkDisabled"),()=>bi(q)("toolbar.graphLink"),()=>({active:bi(W)}),()=>({active:bi(Q)}),()=>({active:bi(Z)}),()=>({active:bi(X)})]),pa(e,we);var dt=St(be);return a(),dt}ia(["click","keydown","change","input"]);var A6=la('<div class="show-answer-area svelte-18mofu"><button class="show-answer-btn svelte-18mofu"><!> <span> </span> <kbd class="svelte-18mofu">空格</kbd></button></div>'),E6=(e,t,n,i)=>{t()&&n()(bi(i).rating)},z6=la('<button class="rate-card svelte-18mofu"><div class="rate-content svelte-18mofu"><span class="rate-label svelte-18mofu"> </span> <span class="rate-next svelte-18mofu"> </span></div> <div class="rate-accent svelte-18mofu" aria-hidden="true"></div></button>'),P6=la('<div class="rating-modern svelte-18mofu"><div class="rate-grid svelte-18mofu"></div></div>'),R6=la('<div class="rating-section svelte-18mofu"><!></div>');function $6(e,t){if(new.target)return Er({component:$6,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"card",7),s=Ar(t,"fsrs",7),o=Ar(t,"onRate",7),l=Ar(t,"showAnswer",7),c=Ar(t,"onShowAnswer",7),d=Ar(t,"cardType",7),u=Ar(t,"learningConfig",7),h=Ar(t,"learningStepIndex",7),p=In(n),g=In(()=>()=>d()===CS.MULTIPLE_CHOICE?bi(p)("studyInterface.confirmAnswer"):bi(p)("studyInterface.showAnswer"));function v(e){if(!r()||!r().fsrs)return bi(p)("studyInterface.intervals.unknown");try{const n={due:r().fsrs.due,stability:r().fsrs.stability,difficulty:r().fsrs.difficulty,elapsedDays:r().fsrs.elapsedDays,scheduledDays:r().fsrs.scheduledDays,reps:r().fsrs.reps,lapses:r().fsrs.lapses,state:r().fsrs.state,lastReview:r().fsrs.lastReview,retrievability:r().fsrs.retrievability};n.lastReview||(n.lastReview=(new Date).toISOString(),n.elapsedDays=0,n.state=0),("number"!=typeof n.elapsedDays||isNaN(n.elapsedDays))&&(n.elapsedDays=0);const{card:i}=s().review(n,e);try{const t=u()||{learningSteps:[1,10],relearningSteps:[10],graduatingInterval:1,easyInterval:4},n=e=>Math.max(0,(e||0)/1440),a=i.state,s=0===a||1===a,o=3===a;if(s||o){const a=o?t.relearningSteps||[10]:t.learningSteps||[1,10],l=e=>{var t;return n(null!=(t=a[Math.min(e,a.length-1)])?t:1)},c=Xr.calculate(r(),t.learningSteps||[1,10],t.relearningSteps||[10]),d=Xr.calculateNext(c,e,a),u=e=>{i.scheduledDays=Math.max(0,e);const t=Math.round(24*e*60*60*1e3);i.due=new Date(Date.now()+t).toISOString()};if(-1===d){const n=4===e?t.easyInterval||4:t.graduatingInterval||1;u(Math.max(1,n)),i.state=2}else u(l(d)),i.state=s?1:3}}catch(t){_e.error("Error applying learning steps in prediction:",t)}return function(e){if("number"!=typeof e||Number.isNaN(e)||null==e)return bi(p)("studyInterface.intervals.unknown");const t=1440*e;if(t<1)return bi(p)("studyInterface.intervals.lessThan1Min");if(t<60){const e=Math.round(t);return bi(p)("studyInterface.intervals.minutes").replace("{n}",String(e))}const n=t/60;if(n<24){const e=Math.round(n);return bi(p)("studyInterface.intervals.hours").replace("{n}",String(e))}if(e<30){const t=Math.round(e);return bi(p)("studyInterface.intervals.days").replace("{n}",String(t))}if(e<365){const t=Math.round(e/30);return bi(p)("studyInterface.intervals.months").replace("{n}",String(t))}const i=(e/365).toFixed(1);return bi(p)("studyInterface.intervals.years").replace("{n}",i)}(i.scheduledDays||0)}catch(t){return _e.error("Failed to predict interval for rating",e,t),bi(p)("studyInterface.intervals.unknown")}}const f=In(()=>[{rating:1,label:bi(p)("studyInterface.ratings.again"),color:"var(--tuanki-error)",key:"1"},{rating:2,label:bi(p)("studyInterface.ratings.hard"),color:"var(--tuanki-warning)",key:"2"},{rating:3,label:bi(p)("studyInterface.ratings.good"),color:"var(--tuanki-success)",key:"3"},{rating:4,label:bi(p)("studyInterface.ratings.easy"),color:"var(--tuanki-info)",key:"4"}]);var m={get card(){return r()},set card(e){r(e),hn()},get fsrs(){return s()},set fsrs(e){s(e),hn()},get onRate(){return o()},set onRate(e){o(e),hn()},get showAnswer(){return l()},set showAnswer(e){l(e),hn()},get onShowAnswer(){return c()},set onShowAnswer(e){c(e),hn()},get cardType(){return d()},set cardType(e){d(e),hn()},get learningConfig(){return u()},set learningConfig(e){u(e),hn()},get learningStepIndex(){return h()},set learningStepIndex(e){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=R6(),b=Gt(y),w=e=>{var t=A6(),n=Gt(t);n.__click=function(...e){var t;null==(t=c())||t.apply(this,e)};var i=Gt(n);Ng(i,{name:"eye",size:"20"});var a=Kt(i,2),r=Gt(a,!0);zt(a),Pt(2),zt(n),zt(t),zi(e=>va(r,e),[()=>bi(g)()]),pa(e,t)},k=e=>{var t=P6(),n=Gt(t);Ca(n,21,()=>bi(f),_a,(e,t)=>{var n=z6();n.__click=[E6,l,o,t];var i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var s=Kt(a,2),c=Gt(s,!0);zt(s),zt(i),Pt(2),zt(n),zi((e,i)=>{var a;ja(n,`--accent: ${null!=(a=bi(t).color)?a:""}`),er(n,"aria-label",e),er(n,"aria-keyshortcuts",bi(t).key),va(r,bi(t).label),va(c,i)},[()=>`评分：${bi(t).label}（下一次：${v(bi(t).rating)}）`,()=>v(bi(t).rating)]),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(b,e=>{l()?e(k,!1):e(w)}),zt(y),pa(e,y);var S=St(m);return a(),S}ia(["click"]);var O6=la('<div class="tuanki-render-loading svelte-oghqor"><div class="loading-spinner svelte-oghqor"></div> <span class="loading-text svelte-oghqor">正在渲染内容...</span></div>'),L6=la("<div><!></div>");function N6(e,t){if(new.target)return Er({component:N6,...e});kt(t,!0);let n=Ar(t,"plugin",7),i=Ar(t,"content",7),a=Ar(t,"sourcePath",7,""),r=Ar(t,"enableClozeProcessing",7,!1),s=Ar(t,"showClozeAnswers",7,!1),o=Ar(t,"card",7),l=Ar(t,"studyInstance",7),c=Ar(t,"activeClozeOrdinal",7),d=Ar(t,"onRenderComplete",7),u=Ar(t,"onRenderError",7);const h=In(()=>{var e;return a()||(null==(e=o())?void 0:e.sourceFile)||""});let p,g=null,v=Pn(!1),f=Pn(null),m=Pn(!1);async function y(){var e,t,a,o,y,b,w,k;if(bi(m)&&p&&(null==(e=n())?void 0:e.app))if(bi(v))_e.debug("[ObsidianRenderer]","⚠️ 跳过渲染：上一次渲染尚未完成");else{_e.debug("[ObsidianRenderer]","✅ 开始渲染内容:",{contentLength:null!=(b=null==(y=i())?void 0:y.length)?b:0,enableClozeProcessing:r(),showClozeAnswers:s()}),$n(v,!0),$n(f,null);try{if(g&&(g.unload(),g=null),!bi(m)||!p)return void _e.debug("[ObsidianRenderer]","渲染中止：组件已卸载");p.innerHTML="";const e=function(e){if(!e)return e;let t=e;if(void 0!==c()){const e=c()-1;t=t.replace(/\{\{c(\d+)::([^}:]+)(?:::([^}]+))?\}\}/g,(t,n,i,a)=>parseInt(n)-1===e?`==${i}==`:i),_e.debug("[ObsidianRenderer]",`✅ 渲染渐进式挖空（activeCloze: c${c()}）`)}else if(l()&&"object"==typeof l()&&"activeClozeOrd"in l()){const e=l().activeClozeOrd;t=t.replace(/\{\{c(\d+)::([^}:]+)(?:::([^}]+))?\}\}/g,(t,n,i,a)=>parseInt(n)-1===e?`==${i}==`:i),_e.debug("[ObsidianRenderer]",`✅ 渲染渐进式挖空学习实例（activeCloze: c${e+1}）`)}else{const n=/\{\{c(\d+)::([^:}]+)(?:::([^}]+))?\}\}/g,i=n.test(e);n.lastIndex=0,i&&(t=t.replace(n,(e,t,n,i)=>`==${n}==`),_e.debug("[ObsidianRenderer]","✅ 已转换Anki挖空格式为Obsidian高亮格式"))}return t}(i());if(g=new ge.Component,await ge.MarkdownRenderer.render(n().app,e||"*空内容*",p,bi(h),g),!bi(m)||!g)return _e.debug("[ObsidianRenderer]","渲染完成但组件已卸载，跳过加载"),void(g&&(g.unload(),g=null));g.load(),await new Promise(e=>setTimeout(e,50)),function(e){if(!r())return;const t=e.querySelectorAll("mark");t.forEach((e,t)=>{const n=e;n.classList.add("tuanki-cloze-mark"),s()?n.classList.add("tuanki-cloze-revealed"):n.classList.add("tuanki-cloze-hidden"),n.setAttribute("tabindex","0"),n.setAttribute("role","button"),n.setAttribute("aria-label",s()?"答案已显示":"点击或悬停显示答案"),n.setAttribute("data-cloze-index",String(t)),n.addEventListener("click",e=>{e.stopPropagation();const t=e.currentTarget;t.classList.contains("tuanki-cloze-hidden")&&(t.classList.remove("tuanki-cloze-hidden"),t.classList.add("tuanki-cloze-revealed"),t.setAttribute("aria-label","答案已显示"))})});const n=e.querySelectorAll("[data-cloze-hint]");let i=0;n.forEach(e=>{const t=e,n=t.getAttribute("data-cloze-hint"),a=t.querySelector("mark");if(a&&n){a.setAttribute("data-hint",n),a.setAttribute("title",`💡 提示: ${n}`);const e=a.getAttribute("aria-label")||"";a.setAttribute("aria-label",`${e}，提示: ${n}`),i++}}),_e.debug("[ObsidianRenderer]",`✅ 处理了 ${t.length} 个挖空标记 (其中 ${i} 个带提示)`)}(p),function(e){if(!e)return;e.querySelectorAll("a.internal-link").forEach(t=>{const i=t,a=i.getAttribute("data-href");if(!a)return;const r=i._tuankiClickHandler;r&&i.removeEventListener("click",r);const s=e=>{e.preventDefault(),e.stopPropagation(),_e.debug("[ObsidianRenderer]","内部链接点击:",a),n().app.workspace.openLinkText(a,bi(h),e.ctrlKey||e.metaKey)};i.addEventListener("click",s),i._tuankiClickHandler=s,i.setAttribute("data-href",a),i.setAttribute("data-tooltip-position","top"),i.setAttribute("rel","noopener"),i.setAttribute("target","_blank"),i.classList.add("internal-link"),i.addEventListener("mouseenter",t=>{const i=t.currentTarget;n().app.workspace.trigger("hover-link",{event:t,source:"preview",hoverParent:e,targetEl:i,linktext:a,sourcePath:bi(h)})})})}(p),function(e){if(!e)return;const t=e.querySelectorAll('a.footnote-ref, sup a[href^="#fn"]'),n=e.querySelector(".footnotes, section.footnotes");if(0===t.length&&!n)return;t.forEach(t=>{const n=t,i=n.getAttribute("href");if(!i||!i.startsWith("#"))return;const a=i.substring(1),r=n._tuankiFootnoteHandler;r&&n.removeEventListener("click",r);const s=t=>{t.preventDefault(),t.stopPropagation();let n=e.querySelector(`#${a}`)||e.querySelector(`li[id="${a}"]`)||e.querySelector(`[data-footnote-id="${a}"]`);if(!n&&a.startsWith("fn:")){const t=a.substring(3);n=e.querySelector(`#fnref\\:${t}`)}n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("footnote-highlighted"),setTimeout(()=>{n.classList.remove("footnote-highlighted")},2e3))};n.addEventListener("click",s,{capture:!0}),n._tuankiFootnoteHandler=s}),e.querySelectorAll('a.footnote-backref, .footnotes a[href^="#fnref"]').forEach(t=>{const n=t,i=n.getAttribute("href");if(!i||!i.startsWith("#"))return;const a=i.substring(1),r=n._tuankiBackrefHandler;r&&n.removeEventListener("click",r);const s=t=>{t.preventDefault(),t.stopPropagation();let n=e.querySelector(`#${a}`);if(!n&&a.startsWith("fnref:")){const t=a.substring(6);n=e.querySelector(`a[href="#fn:${t}"]`)||e.querySelector(`sup a[href="#fn:${t}"]`)||e.querySelector(`a.footnote-ref[href="#fn:${t}"]`)}n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("footnote-highlighted"),setTimeout(()=>{n.classList.remove("footnote-highlighted")},2e3))};n.addEventListener("click",s,{capture:!0}),n._tuankiBackrefHandler=s}),n&&(n.style.display="",n.style.visibility="visible")}(p),null==(w=d())||w(p),_e.debug("[ObsidianRenderer]","✅ 渲染成功",{contentLength:i().length,enableClozeProcessing:r(),showClozeAnswers:s(),timestamp:(new Date).toLocaleTimeString()})}catch(S){if(!bi(m)||!p)return void _e.debug("[ObsidianRenderer]","渲染错误但组件已卸载，忽略");_e.error("[ObsidianRenderer] 渲染失败:",S),$n(f,S instanceof Error?S.message:"未知渲染错误",!0),p.innerHTML=`\n        <div class="tuanki-render-error">\n          <div class="error-icon">⚠️</div>\n          <div class="error-message">内容渲染失败</div>\n          <div class="error-fallback">${i()}</div>\n        </div>\n      `,null==(k=u())||k(S instanceof Error?S:new Error("渲染失败"))}finally{$n(v,!1)}}else _e.debug("[ObsidianRenderer]","⚠️ 跳过渲染：组件未挂载或缺少依赖",{isMounted:bi(m),hasContainer:!!p,hasPlugin:!!(null==(t=n())?void 0:t.app),contentLength:null!=(o=null==(a=i())?void 0:a.length)?o:0})}let b=Pn(""),w=Pn(!1),k=Pn(void 0);Ti(()=>{const e=i(),t=c(),n=bi(m),a=e!==bi(b),r=t!==bi(k);n&&void 0!==e&&(a||r)&&(_e.debug("[ObsidianRenderer]","内容或挖空序号变化，延迟渲染",{contentChanged:a,activeClozeChanged:r,oldActiveCloze:bi(k),newActiveCloze:t}),$n(b,e,!0),$n(k,t,!0),setTimeout(()=>y(),0))}),Ti(()=>{const e=s(),t=bi(m),n=r();t&&e!==bi(w)&&n&&(_e.debug("[ObsidianRenderer]","挖空显示状态变化:",e),$n(w,e,!0),setTimeout(()=>function(e){if(!p)return;const t=p.querySelectorAll("mark.tuanki-cloze-mark");_e.debug("[ObsidianRenderer]",`更新 ${t.length} 个挖空的显示状态`),t.forEach(t=>{const n=t;e?(n.classList.remove("tuanki-cloze-hidden"),n.classList.add("tuanki-cloze-revealed"),n.setAttribute("aria-label","答案已显示"),n.style.cursor="default"):(n.classList.add("tuanki-cloze-hidden"),n.classList.remove("tuanki-cloze-revealed"),n.setAttribute("aria-label","点击或悬停显示答案"),n.style.cursor="pointer")})}(e),100))}),Pr(()=>{$n(m,!0),_e.debug("[ObsidianRenderer]","onMount - 组件已挂载"),setTimeout(()=>{p&&void 0!==i()&&($n(b,i(),!0),$n(w,s()),$n(k,c(),!0),y())},0)}),Rr(()=>{$n(m,!1),g&&(g.unload(),g=null)});var S={get plugin(){return n()},set plugin(e){n(e),hn()},get content(){return i()},set content(e){i(e),hn()},get sourcePath(){return a()},set sourcePath(e=""){a(e),hn()},get enableClozeProcessing(){return r()},set enableClozeProcessing(e=!1){r(e),hn()},get showClozeAnswers(){return s()},set showClozeAnswers(e=!1){s(e),hn()},get card(){return o()},set card(e){o(e),hn()},get studyInstance(){return l()},set studyInstance(e){l(e),hn()},get activeClozeOrdinal(){return c()},set activeClozeOrdinal(e){c(e),hn()},get onRenderComplete(){return d()},set onRenderComplete(e){d(e),hn()},get onRenderError(){return u()},set onRenderError(e){u(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},x=L6();let _;var C=Gt(x),I=e=>{pa(e,O6())};return xa(C,e=>{bi(v)&&e(I)}),zt(x),kr(x,e=>p=e,()=>p),zi(e=>_=Fa(x,1,"tuanki-obsidian-renderer markdown-reading-view svelte-oghqor",null,_,e),[()=>({rendering:bi(v),"has-error":!!bi(f)})]),pa(e,x),St(S)}var F6=la("<span><!></span>");function B6(e,t){if(new.target)return Er({component:B6,...e});kt(t,!0);let n=Ar(t,"name",7),i=Ar(t,"size",7,"16"),a=Ar(t,"color",7),r=Ar(t,"class",7,""),s=Ar(t,"title",7),o=Ar(t,"ariaLabel",7),l=Ar(t,"ariaHidden",7,!1),c=In(()=>n()&&dg(n())?cg(n()):(_e.warn(`[Icon] 图标 "${n()}" 不存在，使用默认图标`),cg("info"))),d=In(()=>"number"==typeof i()?`${i()}px`:"string"==typeof i()?/\d+(px|em|rem|%|vh|vw)$/.test(i())?i():/^\d+$/.test(i())?`${i()}px`:i():"16px"),u=In(()=>{let e=[];return e.push(`width: ${bi(d)}`),e.push(`height: ${bi(d)}`),e.push("display: inline-block"),e.push("vertical-align: middle"),e.push("flex-shrink: 0"),a()&&e.push(`color: ${a()}`),e.join("; ")}),h=In(()=>{let e=["tuanki-icon"];return r()&&e.push(r()),e.join(" ")}),p=In(()=>{let e={};return l()?e["aria-hidden"]="true":o()?e["aria-label"]=o():s()&&(e["aria-label"]=s()),s()&&(e.title=s()),e});var g={get name(){return n()},set name(e){n(e),hn()},get size(){return i()},set size(e="16"){i(e),hn()},get color(){return a()},set color(e){a(e),hn()},get class(){return r()},set class(e=""){r(e),hn()},get title(){return s()},set title(e){s(e),hn()},get ariaLabel(){return o()},set ariaLabel(e){o(e),hn()},get ariaHidden(){return l()},set ariaHidden(e=!1){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},v=F6();return tr(v,()=>({class:bi(h),style:bi(u),role:l()?"presentation":"img",...bi(p)}),void 0,void 0,"svelte-11grrqm"),Aa(Gt(v),()=>bi(c)),zt(v),pa(e,v),St(g)}ia(["keydown","click"]);const j6=new Map;function U6(e){if(e.content&&e.content.trim()){const n=function(e){if(!e)return"basic-qa";const t=e.toLowerCase();return t.includes("cloze")?"cloze-deletion":t.includes("choice")||t.includes("mcq")?t.includes("single")?"single-choice":"multiple-choice":"basic-qa"}(e.type),i=function(e){if(!j6.has(e))switch(e){case"basic-qa":default:j6.set(e,new mh);break;case"single-choice":case"multiple-choice":j6.set(e,new yh);break;case"cloze-deletion":j6.set(e,new wh)}return j6.get(e)}(n);try{const t=i.parseMarkdownToFields(e.content,n);if(t.success&&t.fields)return t.fields}catch(t){_e.warn("[CardFieldHelper] 解析 content 失败:",t)}}return e.fields?e.fields:{}}const V6=Object.freeze(Object.defineProperty({__proto__:null,getCardFields:U6},Symbol.toStringTag,{value:"Module"}));function q6(e){var t,n;if(!e||"string"!=typeof e)return null;try{let i=e.trim();const a=/^```(?:markdown|md|text|)?\s*\n?([\s\S]*?)\n?```$/,r=i.match(a);r&&(i=r[1].trim(),_e.debug("[ChoiceQuestionParser] 检测到代码块包裹，已自动清理")),i=i.replace(/\n{3,}/g,"\n\n");const s=/---div---/i,o=i.split(s),l=(null==(t=o[0])?void 0:t.trim())||"",c=(null==(n=o[1])?void 0:n.trim())||"",d=/^(?:Q:|问题：)\s*(.+?)$/m,u=l.match(d);if(!u)return null;const h=u[1].trim(),p=[],g=[],v=/^([A-Z])\)\s*/gm;let f;for(;null!==(f=v.exec(l));)g.push({label:f[1],lineStart:f.index,contentStart:f.index+f[0].length});for(let e=0;e<g.length;e++){const t=g[e],n=g[e+1],i=n?n.lineStart:l.length;let a=l.substring(t.contentStart,i);const r=/\{(?:✓|correct|\*)\}/.test(a);let s=a.replace(/\{✓\}/g,"").replace(/\{correct\}/gi,"").replace(/\{\*\}/g,"").trim();p.push({label:t.label,content:s,isCorrect:r})}if(p.length<2)return null;const m=p.filter(e=>e.isCorrect);if(0===m.length)return null;const y=c||void 0,b=m.length>1,w={type:"choice",question:h,options:p,correctAnswers:m.map(e=>e.label),explanation:y,isMultipleChoice:b};return w}catch(i){return _e.error("[ChoiceQuestionParser] 解析失败:",i),null}}function H6(e){if(!e||"string"!=typeof e)return!1;const t=/^(?:Q:|问题：)/m.test(e),n=/^[A-Z]\)/m.test(e),i=/\{(?:✓|correct|\*)\}/.test(e);return t&&n&&i}class W6{constructor(e){oe(this,"plugin"),oe(this,"cardTypes",new Map),oe(this,"detectors",new Map),oe(this,"generators",new Map),oe(this,"renderers",new Map),oe(this,"extensionConfigs",new Map),this.plugin=e,_e.debug("[ExtensiblePreviewManager] 可扩展预览管理器已初始化")}registerCardType(e){this.cardTypes.set(e.id,e),_e.debug(`[ExtensiblePreviewManager] 注册题型: ${e.name} (${e.id})`)}registerDetector(e){this.detectors.set(e.id,e),_e.debug(`[ExtensiblePreviewManager] 注册检测器: ${e.name} (${e.id})`)}registerGenerator(e){this.generators.set(e.id,e),_e.debug(`[ExtensiblePreviewManager] 注册生成器: ${e.name} (${e.id})`)}registerRenderer(e){this.renderers.set(e.id,e),_e.debug(`[ExtensiblePreviewManager] 注册渲染器: ${e.name} (${e.id})`)}async detectCardType(e){const t=Array.from(this.detectors.values()).sort((e,t)=>t.priority-e.priority);for(const i of t)try{const t=i.detect(e);if(t.matches&&t.confidence>.7)return _e.debug(`[ExtensiblePreviewManager] 检测到题型: ${t.cardTypeId} (置信度: ${t.confidence})`),t}catch(n){_e.error(`[ExtensiblePreviewManager] 检测器 ${i.id} 执行失败:`,n)}return null}async generateExtensiblePreview(e,t,n){const i=Array.from(this.generators.values()).find(e=>e.supportedTypes.includes(t));if(!i)return _e.warn(`[ExtensiblePreviewManager] 未找到支持题型 ${t} 的生成器`),null;try{const a=await i.generatePreview(e,n);return _e.debug(`[ExtensiblePreviewManager] 生成扩展预览: ${t}`),a}catch(a){return _e.error(`[ExtensiblePreviewManager] 生成器 ${i.id} 执行失败:`,a),null}}async renderExtensiblePreview(e,t){const n=e.cardType,i=Array.from(this.renderers.values()).find(e=>e.supportedTypes.includes(n));if(!i)return _e.warn(`[ExtensiblePreviewManager] 未找到支持题型 ${n} 的渲染器`),null;try{const a=await i.render(e,t);return _e.debug(`[ExtensiblePreviewManager] 渲染扩展预览: ${n}`),a}catch(a){return _e.error(`[ExtensiblePreviewManager] 渲染器 ${i.id} 执行失败:`,a),null}}getCardTypes(){return Array.from(this.cardTypes.values())}getDetectors(){return Array.from(this.detectors.values())}getGenerators(){return Array.from(this.generators.values())}getRenderers(){return Array.from(this.renderers.values())}unregisterExtension(e){this.cardTypes.delete(e),this.detectors.delete(e),this.generators.delete(e),this.renderers.delete(e),this.extensionConfigs.delete(e),_e.debug(`[ExtensiblePreviewManager] 卸载扩展: ${e}`)}loadExtensionConfig(e){this.extensionConfigs.set(e.id,e),_e.debug(`[ExtensiblePreviewManager] 加载扩展配置: ${e.name} (${e.id})`)}getExtensionConfig(e){return this.extensionConfigs.get(e)}getAllExtensionConfigs(){return Array.from(this.extensionConfigs.values())}cleanup(){this.cardTypes.clear(),this.detectors.clear(),this.generators.clear(),this.renderers.clear(),this.extensionConfigs.clear(),_e.debug("[ExtensiblePreviewManager] 资源已清理")}}const G6={"basic-qa":CS.BASIC_QA,"cloze-deletion":CS.CLOZE_DELETION,"multiple-choice":CS.MULTIPLE_CHOICE,extensible:CS.EXTENSIBLE};class Q6{constructor(e){oe(this,"plugin"),oe(this,"previewCache",new Map),oe(this,"extensibleManager"),oe(this,"contentExtractor"),this.plugin=e,this.extensibleManager=new W6(e),this.contentExtractor=wu.getInstance()}preprocessCardForRendering(e){return e}async parseCardContent(e,t){const n=performance.now(),i=this.preprocessCardForRendering(e),a=this.generateCacheKey(i);if(this.previewCache.has(a)){const e=this.previewCache.get(a);return _e.debug(`[ContentPreviewEngine] 使用缓存预览数据: ${i.uuid}`),e}_e.debug(`[ContentPreviewEngine] 开始解析卡片内容: ${i.uuid}`);const r=await this.detectCardType(i),s=t||this.getEffectiveTemplate(i),o=this.generatePreviewSections(i,r,s),l={cardId:i.uuid,templateId:(null==s?void 0:s.id)||"unknown",cardType:r,confidence:this.calculateConfidence(e,r),generatedAt:Date.now(),renderingHints:this.generateRenderingHints(o,r)};l.sourcePath=i.sourceFile||"";const c={cardType:r,sections:o,metadata:l,renderingHints:l.renderingHints};this.previewCache.set(a,c);const d=performance.now();return _e.debug(`[ContentPreviewEngine] 预览数据生成完成: ${e.uuid}, 耗时: ${d-n}ms`),c}async detectCardType(e){const t=await this.extensibleManager.detectCardType(e);if(null==t?void 0:t.matches){const e=t.cardTypeId;return this.convertLegacyType(e)}const n=this.getCardContent(e);if(H6(n)){const t=q6(n);if(t)return _e.debug("[ContentPreviewEngine] 检测到选择题格式:",e.uuid,"类型:",t.isMultipleChoice?"多选":"单选"),t.isMultipleChoice?CS.MULTIPLE_CHOICE:CS.SINGLE_CHOICE}return this.isClozeCard(e)?CS.CLOZE_DELETION:CS.BASIC_QA}getCardContent(e){var t;return(null==(t=e.content)?void 0:t.trim())||""}convertLegacyType(e){return G6[e]||CS.BASIC_QA}convertUnifiedToLegacy(e){const t=Object.entries(G6).find(([,t])=>t===e);return t?t[0]:"basic-qa"}async generatePreview(e,t){const n=performance.now();try{switch(e.cardType){case CS.BASIC_QA:await this.generateBasicQAPreview(e,t);break;case CS.CLOZE_DELETION:await this.generateClozePreview(e,t);break;case CS.MULTIPLE_CHOICE:break;default:await this.generateExtensiblePreview(e,t)}return{success:!0,previewData:e,renderTime:performance.now()-n}}catch(i){return _e.error("[ContentPreviewEngine] 预览生成失败:",i),{success:!1,error:i instanceof Error?i.message:"未知错误",renderTime:performance.now()-n}}}clearCache(){this.previewCache.clear(),this.extensibleManager.cleanup(),_e.debug("[ContentPreviewEngine] 预览缓存已清理")}getExtensibleManager(){return this.extensibleManager}getCacheStats(){return{size:this.previewCache.size,keys:Array.from(this.previewCache.keys())}}isClozeCard(e){var t;let n="";if((null==(t=e.content)?void 0:t.trim())&&(n=e.content),!n)return!1;if(/==(.*?)==/g.test(n))return!0;if(/\{\{c(\d+)::(.*?)::(.*?)\}\}/g.test(n))return!0;return!!/\{\{c(\d+)::(.*?)\}\}/g.test(n)}getEffectiveTemplate(e){return null}generatePreviewSections(e,t,n){var i,a;const r=[];switch(t){case CS.BASIC_QA:{const t=U6(e);r.push(this.createPreviewSection("front",t.front||"","markdown"),this.createPreviewSection("back",t.back||"","markdown"));break}case CS.CLOZE_DELETION:{const t=U6(e);let n=t.text||t.front||(null==(i=e.content)?void 0:i.trim())||"";const a=n.indexOf("\n---div---\n");let s="",o="";a>=0?(s=n.substring(0,a).trim(),o=n.substring(a+11).trim()):s=n,s&&r.push(this.createPreviewSection("front",s,"mixed")),o&&r.push(this.createPreviewSection("back",o,"markdown"));break}case CS.MULTIPLE_CHOICE:case CS.SINGLE_CHOICE:{const t=U6(e),n=t.front||(null==(a=e.content)?void 0:a.trim())||"";if(n&&H6(n)){const e=n.indexOf("\n---div---\n");let t="",i="";e>=0?(t=n.substring(0,e).trim(),i=n.substring(e+11).trim()):t=n,r.push(this.createPreviewSection("front",t,"markdown")),i&&r.push(this.createPreviewSection("back",i,"markdown"))}else r.push(this.createPreviewSection("front",t.front||"","markdown")),t.back&&r.push(this.createPreviewSection("back",t.back,"markdown"));break}}return r}createPreviewSection(e,t,n){return{id:`section-${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:e,content:t,renderMode:n,animations:this.getDefaultAnimations(e),interactivity:this.getDefaultInteractivity(e)}}getDefaultAnimations(e){const t={type:"fadeIn",duration:300,delay:0,easing:"cubic-bezier(0.4, 0, 0.2, 1)"};switch(e){case"front":return[{...t,delay:0}];case"back":return[{...t,delay:100}];case"options":return[{...t,type:"slideIn",delay:150}];case"explanation":return[{...t,delay:200}];default:return[t]}}getDefaultInteractivity(e){return{clickable:"options"===e,hoverable:!0,selectable:!1,customHandlers:{}}}generateCacheKey(e){const t=e.templateId||"default",n=this.hashContent(e.content||"");return`${e.uuid}-${t}-${n}`}hashContent(e){if(!e||"string"!=typeof e)return"0";let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t.toString(36)}hashFields(e){if(!e||"object"!=typeof e)return"0";const t=Object.keys(e).sort().map(t=>`${t}:${e[t]}`).join("|");return this.hashContent(t)}calculateConfidence(e,t){let n=.8;switch(e.content&&e.content.trim()&&(n+=.2),t){case CS.MULTIPLE_CHOICE:break;case CS.CLOZE_DELETION:this.isClozeCard(e)&&(n+=.1)}return Math.min(n,1)}generateRenderingHints(e,t){const n=e.reduce((e,t)=>e+t.content.length,0);return{preferredHeight:Math.max(200,Math.min(600,n/10)),hasInteractiveElements:e.some(e=>e.interactivity.clickable),requiresObsidianRenderer:e.some(e=>e.content.includes("[[")||e.content.includes("![[")||e.content.includes("#")),cacheKey:`render-${t}-${Date.now()}`}}async generateBasicQAPreview(e,t){_e.debug("[ContentPreviewEngine] 生成基础问答预览")}async generateClozePreview(e,t){_e.debug("[ContentPreviewEngine] 🎯 挖空题预览由 ObsidianRenderer 处理"),_e.debug("[ContentPreviewEngine] ✅ 挖空题预览生成完成（已委托给渲染器）")}async generateExtensiblePreview(e,t){_e.debug("[ContentPreviewEngine] 生成可扩展预览")}}class K6{constructor(e={enableAnimations:!0,reducedMotion:!1,performanceMode:"quality"}){oe(this,"animationQueue",[]),oe(this,"options"),this.options=e,this.detectReducedMotion()}detectReducedMotion(){if("undefined"!=typeof window&&window.matchMedia){const e=window.matchMedia("(prefers-reduced-motion: reduce)");this.options.reducedMotion=e.matches,e.addEventListener("change",e=>{this.options.reducedMotion=e.matches})}}animateContentReveal(e,t){if(!this.shouldAnimate()||!e)return Promise.resolve();const n={duration:300,easing:"cubic-bezier(0.4, 0, 0.2, 1)",delay:0,...t};return this.createAnimation(e,[{opacity:0,transform:"translateY(10px) scale(0.98)"},{opacity:1,transform:"translateY(0) scale(1)"}],n)}animateTypeTransition(e,t){if(!this.shouldAnimate()||!e)return Promise.resolve();const n={duration:400,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",delay:100,...t};return this.createAnimation(e,[{opacity:.7,transform:"scale(0.95)",filter:"blur(2px)"},{opacity:1,transform:"scale(1)",filter:"blur(0px)"}],n)}animateClozeReveal(e,t){if(!this.shouldAnimate()||!e)return Promise.resolve();if(Array.isArray(e)){const n=e.map(e=>this.animateClozeReveal(e,t));return Promise.all(n).then(()=>{})}const n={duration:250,easing:"ease-out",delay:50,...t};return this.createAnimation(e,[{opacity:0,transform:"scale(0.9)",backgroundColor:"var(--tuanki-warning-light, rgba(245, 158, 11, 0.2))"},{opacity:.5,transform:"scale(1.05)",backgroundColor:"var(--tuanki-warning-light, rgba(245, 158, 11, 0.2))"},{opacity:1,transform:"scale(1)",backgroundColor:"var(--tuanki-secondary-light, rgba(139, 92, 246, 0.15))"}],n)}animateOptionSelection(e,t){if(!this.shouldAnimate()||!e)return Promise.resolve();const n={duration:150,easing:"ease-out",delay:0,...t};return this.createAnimation(e,[{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}],n)}animateHover(e,t){if(!this.shouldAnimate()||!e)return Promise.resolve();const n=t?[{transform:"translateY(0) scale(1)"},{transform:"translateY(-2px) scale(1.01)"}]:[{transform:"translateY(-2px) scale(1.01)"},{transform:"translateY(0) scale(1)"}];return this.createAnimation(e,n,{duration:200,easing:"ease-out",delay:0})}animateError(e){return this.shouldAnimate()&&e?this.createAnimation(e,[{transform:"translateX(0)"},{transform:"translateX(-5px)"},{transform:"translateX(5px)"},{transform:"translateX(-3px)"},{transform:"translateX(3px)"},{transform:"translateX(0)"}],{duration:400,easing:"ease-in-out",delay:0}):Promise.resolve()}animateLoading(e){if(!this.shouldAnimate())return null;const t=e.animate([{opacity:.6},{opacity:1},{opacity:.6}],{duration:1500,easing:"ease-in-out",iterations:1/0});return this.animationQueue.push(t),t}createAnimation(e,t,n){return new Promise(i=>{if(!e||"function"!=typeof e.animate)return _e.warn("[AnimationController] Invalid element or animate not supported"),void i();try{const a=e.animate(t,{duration:n.duration,easing:n.easing,delay:n.delay,fill:"forwards"});this.animationQueue.push(a),a.addEventListener("finish",()=>{this.removeFromQueue(a),i()}),a.addEventListener("cancel",()=>{this.removeFromQueue(a),i()})}catch(a){_e.warn("[AnimationController] Animation failed:",a),i()}})}shouldAnimate(){return!!this.options.enableAnimations&&(!this.options.reducedMotion&&!("performance"===this.options.performanceMode&&this.animationQueue.length>5))}removeFromQueue(e){const t=this.animationQueue.indexOf(e);t>-1&&this.animationQueue.splice(t,1)}cancelAllAnimations(){this.animationQueue.forEach(e=>{e.cancel()}),this.animationQueue=[]}updateOptions(e){this.options={...this.options,...e}}getAnimationStats(){return{activeAnimations:this.animationQueue.length,totalAnimations:this.animationQueue.length,reducedMotion:this.options.reducedMotion,enableAnimations:this.options.enableAnimations}}cleanup(){this.cancelAllAnimations()}}var Z6=la('<div class="tuanki-qa-field-label svelte-jwyaph"> </div>'),Y6=la('<span class="tuanki-qa-keyword svelte-jwyaph"> </span>'),X6=la('<div class="tuanki-qa-keywords svelte-jwyaph"></div>'),J6=la('<div class="tuanki-qa-overflow-indicator svelte-jwyaph">内容已截断，完整内容请查看原文...</div>'),e7=la('<div role="region" aria-label="问题内容区域"><!> <div class="tuanki-qa-content svelte-jwyaph"><!></div> <!> <!></div>'),t7=la('<div class="tuanki-qa-question svelte-jwyaph"><div class="tuanki-qa-question-title svelte-jwyaph"><span class="tuanki-qa-label svelte-jwyaph">问题</span></div> <!></div>'),n7=la('<div class="tuanki-qa-field-label svelte-jwyaph"> </div>'),i7=la('<span class="tuanki-qa-keyword svelte-jwyaph"> </span>'),a7=la('<div class="tuanki-qa-keywords svelte-jwyaph"></div>'),r7=la('<div class="tuanki-qa-overflow-indicator svelte-jwyaph">内容已截断，完整内容请查看原文...</div>'),s7=la('<div role="region" aria-label="答案内容区域"><!> <div class="tuanki-qa-content svelte-jwyaph"><!></div> <!> <!></div>'),o7=la('<div class="tuanki-qa-answer-title svelte-jwyaph"><span class="tuanki-qa-label tuanki-qa-label--answer svelte-jwyaph">答案</span></div> <!>',1),l7=la('<div class="tuanki-qa-answer-placeholder svelte-jwyaph"><div class="tuanki-qa-placeholder-icon svelte-jwyaph">👁️</div> <div class="tuanki-qa-placeholder-text svelte-jwyaph">点击显示答案查看答案内容</div></div>'),c7=la("<div><!></div>"),d7=la('<div class="tuanki-qa-empty svelte-jwyaph"><div class="tuanki-qa-empty-icon svelte-jwyaph">📝</div> <div class="tuanki-qa-empty-title svelte-jwyaph">没有可显示的内容</div> <div class="tuanki-qa-empty-description svelte-jwyaph">卡片内容为空或解析失败</div></div>'),u7=la('<div class="tuanki-card-base tuanki-basic-qa-card tuanki-card-mount svelte-jwyaph"><!> <!> <!></div>');function h7(e,t){if(new.target)return Er({component:h7,...e});kt(t,!0);let n=Ar(t,"sections",7),i=Ar(t,"showAnswer",15),a=Ar(t,"plugin",7),r=Ar(t,"card",7),s=Ar(t,"sourcePath",7,""),o=Ar(t,"animationController",7),l=Ar(t,"enableAnimations",7,!0),c=In(()=>n().filter(e=>"front"===e.type)),d=In(()=>n().filter(e=>"back"===e.type));function u(e){o()&&l()&&o().animateContentReveal(e,{duration:400,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",delay:100})}var h={get sections(){return n()},set sections(e){n(e),hn()},get showAnswer(){return i()},set showAnswer(e){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get card(){return r()},set card(e){r(e),hn()},get sourcePath(){return s()},set sourcePath(e=""){s(e),hn()},get animationController(){return o()},set animationController(e){o(e),hn()},get enableAnimations(){return l()},set enableAnimations(e=!0){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=u7(),g=Gt(p),v=e=>{var t=t7();Ca(Kt(Gt(t),2),17,()=>bi(c),_a,(e,t,n)=>{var i=e7();let r;var o=Gt(i),l=e=>{var i=Z6(),a=Gt(i,!0);zt(i),zi(()=>{var e;return va(a,(null==(e=bi(t).metadata)?void 0:e.title)||`字段 ${n+1}`)}),pa(e,i)};xa(o,e=>{bi(c).length>1&&e(l)});var d=Kt(o,2);N6(Gt(d),{get plugin(){return a()},get content(){return bi(t).content},get sourcePath(){return s()}}),zt(d);var u=Kt(d,2),h=e=>{var n=X6();Ca(n,21,()=>bi(t).metadata.keywords,_a,(e,t)=>{var n=Y6(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(n),pa(e,n)};xa(u,e=>{var n;(null==(n=bi(t).metadata)?void 0:n.keywords)&&bi(t).metadata.keywords.length>0&&e(h)});var p=Kt(u,2),g=e=>{pa(e,J6())};xa(p,e=>{var n;(null==(n=bi(t).metadata)?void 0:n.truncated)&&e(g)}),zt(i),zi(e=>r=Fa(i,1,"tuanki-qa-question-content svelte-jwyaph",null,r,e),[()=>({"tuanki-qa-multiple":bi(c).length>1})]),pa(e,i)}),zt(t),pa(e,t)};xa(g,e=>{bi(c).length>0&&e(v)});var f=Kt(g,2),m=e=>{var t=c7();let n;var r=Gt(t),o=e=>{var t=o7();Ca(Kt(Qt(t),2),17,()=>bi(d),_a,(e,t,n)=>{var i=s7();let r;var o=Gt(i),l=e=>{var i=n7(),a=Gt(i,!0);zt(i),zi(()=>{var e;return va(a,(null==(e=bi(t).metadata)?void 0:e.title)||`字段 ${n+1}`)}),pa(e,i)};xa(o,e=>{bi(d).length>1&&e(l)});var c=Kt(o,2);N6(Gt(c),{get plugin(){return a()},get content(){return bi(t).content},get sourcePath(){return s()}}),zt(c);var h=Kt(c,2),p=e=>{var n=a7();Ca(n,21,()=>bi(t).metadata.keywords,_a,(e,t)=>{var n=i7(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(n),pa(e,n)};xa(h,e=>{var n;(null==(n=bi(t).metadata)?void 0:n.keywords)&&bi(t).metadata.keywords.length>0&&e(p)});var g=Kt(h,2),v=e=>{pa(e,r7())};xa(g,e=>{var n;(null==(n=bi(t).metadata)?void 0:n.truncated)&&e(v)}),zt(i),za(i,e=>null==u?void 0:u(e)),zi(e=>r=Fa(i,1,"tuanki-qa-answer-content svelte-jwyaph",null,r,e),[()=>({"tuanki-qa-multiple":bi(d).length>1})]),pa(e,i)}),pa(e,t)},l=e=>{pa(e,l7())};xa(r,e=>{i()?e(o):e(l,!1)}),zt(t),zi(e=>n=Fa(t,1,"tuanki-qa-answer svelte-jwyaph",null,n,e),[()=>({"tuanki-qa-answer--hidden":!i()})]),pa(e,t)};xa(f,e=>{bi(d).length>0&&e(m)});var y=Kt(f,2),b=e=>{pa(e,d7())};return xa(y,e=>{0===bi(c).length&&0===bi(d).length&&e(b)}),zt(p),pa(e,p),St(h)}var p7=la('<div class="tuanki-cloze-section-title svelte-lo3dwk"> </div>'),g7=la('<div class="tuanki-cloze-section svelte-lo3dwk"><!> <div class="tuanki-cloze-text svelte-lo3dwk"><!></div></div>'),v7=la('<div class="tuanki-cloze-back-section svelte-lo3dwk"><!></div>'),f7=la('<div class="tuanki-card-base tuanki-cloze-card tuanki-card-mount"><div class="tuanki-cloze-content svelte-lo3dwk"></div> <!></div>');function m7(e,t){if(new.target)return Er({component:m7,...e});kt(t,!0);let n=Ar(t,"sections",7),i=Ar(t,"showAnswer",15),a=Ar(t,"plugin",7),r=Ar(t,"sourcePath",7,""),s=Ar(t,"animationController",7),o=Ar(t,"enableAnimations",7,!0),l=Ar(t,"card",7),c=Ar(t,"activeClozeOrdinal",7);var d={get sections(){return n()},set sections(e){n(e),hn()},get showAnswer(){return i()},set showAnswer(e){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get sourcePath(){return r()},set sourcePath(e=""){r(e),hn()},get animationController(){return s()},set animationController(e){s(e),hn()},get enableAnimations(){return o()},set enableAnimations(e=!0){o(e),hn()},get card(){return l()},set card(e){l(e),hn()},get activeClozeOrdinal(){return c()},set activeClozeOrdinal(e){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},u=f7(),h=Gt(u);Ca(h,21,n,_a,(e,t)=>{var n=ha(),s=Qt(n),o=e=>{var n=g7(),s=Gt(n),o=e=>{var n=p7(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t).metadata.title)),pa(e,n)};xa(s,e=>{var n;(null==(n=bi(t).metadata)?void 0:n.title)&&e(o)});var d=Kt(s,2);N6(Gt(d),{get plugin(){return a()},get content(){return bi(t).content},get sourcePath(){return r()},enableClozeProcessing:!0,get showClozeAnswers(){return i()},get card(){return l()},get activeClozeOrdinal(){return c()}}),zt(d),zt(n),pa(e,n)};xa(s,e=>{"front"===bi(t).type&&e(o)}),pa(e,n)}),zt(h);var p=Kt(h,2),g=e=>{var t=ha();Ca(Qt(t),17,n,_a,(e,t)=>{var n=ha(),i=Qt(n),s=e=>{var n=v7();N6(Gt(n),{get plugin(){return a()},get content(){return bi(t).content},get sourcePath(){return r()},enableClozeProcessing:!1,showClozeAnswers:!0,get card(){return l()},get activeClozeOrdinal(){return c()}}),zt(n),pa(e,n)};xa(i,e=>{"back"===bi(t).type&&e(s)}),pa(e,n)}),pa(e,t)};return xa(p,e=>{i()&&e(g)}),zt(u),pa(e,u),St(d)}const y7=e=>e;function b7(e){const t=e-1;return t*t*t+1}function w7(e,{delay:t=0,duration:n=400,easing:i=y7}={}){const a=+getComputedStyle(e).opacity;return{delay:t,duration:n,easing:i,css:e=>"opacity: "+e*a}}function k7(e,{delay:t=0,duration:n=400,easing:i=b7,axis:a="y"}={}){const r=getComputedStyle(e),s=+r.opacity,o="y"===a?"height":"width",l=parseFloat(r[o]),c="y"===a?["top","bottom"]:["left","right"],d=c.map(e=>`${e[0].toUpperCase()}${e.slice(1)}`),u=parseFloat(r[`padding${d[0]}`]),h=parseFloat(r[`padding${d[1]}`]),p=parseFloat(r[`margin${d[0]}`]),g=parseFloat(r[`margin${d[1]}`]),v=parseFloat(r[`border${d[0]}Width`]),f=parseFloat(r[`border${d[1]}Width`]);return{delay:t,duration:n,easing:i,css:e=>`overflow: hidden;opacity: ${Math.min(20*e,1)*s};${o}: ${e*l}px;padding-${c[0]}: ${e*u}px;padding-${c[1]}: ${e*h}px;margin-${c[0]}: ${e*p}px;margin-${c[1]}: ${e*g}px;border-${c[0]}-width: ${e*v}px;border-${c[1]}-width: ${e*f}px;min-${o}: 0`}}var S7=la('<span class="choice-status svelte-158eiio"> </span>'),x7=(e,t,n)=>t(bi(n).id),_7=la('<span class="option-indicator correct svelte-158eiio">✓</span>'),C7=la('<span class="option-indicator incorrect svelte-158eiio">✗</span>'),I7=la('<button type="button"><span class="option-marker svelte-158eiio"> </span> <div class="option-content svelte-158eiio"><span class="option-label svelte-158eiio"> </span> <div class="option-text svelte-158eiio"><!></div></div> <!></button>'),D7=la('<div class="choice-explanation tuanki-answer-enter svelte-158eiio"><div class="tuanki-elegant-divider"><div class="divider-line"></div> <span class="divider-label">💡 答案解析</span> <div class="divider-line"></div></div> <div class="explanation-content svelte-158eiio"><!></div></div>'),T7=la('<div class="choice-empty svelte-158eiio"><div class="empty-icon svelte-158eiio">📝</div> <div class="empty-title svelte-158eiio">没有选项</div> <div class="empty-description svelte-158eiio">此选择题没有配置选项</div></div>'),M7=la('<div class="tuanki-card-base tuanki-choice-card tuanki-card-mount"><div class="choice-header svelte-158eiio"><span class="tuanki-card-type-badge"> </span> <!></div> <div class="choice-question svelte-158eiio"><!></div> <div class="choice-options svelte-158eiio"></div> <!> <!></div>');function A7(e,t){if(new.target)return Er({component:A7,...e});kt(t,!0);let n=Ar(t,"previewData",7),i=Ar(t,"plugin",7),a=Pn(null),r=Pn(!1);const s=In(()=>{var e;return(null==(e=n().sections.find(e=>"front"===e.type))?void 0:e.content)||""}),o=In(()=>{var e;return(null==(e=n().metadata)?void 0:e.options)||[]}),l=In(()=>{var e;return(null==(e=bi(o).find(e=>e.isCorrect))?void 0:e.id)||""}),c=In(()=>{var e;return(null==(e=n().sections.find(e=>"back"===e.type))?void 0:e.content)||""}),d=In(()=>{var e;return(null==(e=n().metadata)?void 0:e.sourcePath)||""});function u(e){null===bi(a)&&($n(a,e,!0),$n(r,!0),setTimeout(()=>{const t=document.querySelector(`[data-option-id="${e}"]`);t&&(e===bi(l)?t.classList.add("tuanki-correct-feedback"):t.classList.add("tuanki-incorrect-feedback"))},10))}var h={get previewData(){return n()},set previewData(e){n(e),hn()},get plugin(){return i()},set plugin(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=M7(),g=Gt(p),v=Gt(g),f=Gt(v);zt(v);var m=Kt(v,2),y=e=>{var t=S7(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(a)===bi(l)?"✓ 回答正确":"✗ 回答错误")),pa(e,t)};xa(m,e=>{bi(a)&&e(y)}),zt(g);var b=Kt(g,2);N6(Gt(b),{get plugin(){return i()},get content(){return bi(s)},get sourcePath(){return bi(d)}}),zt(b);var w=Kt(b,2);Ca(w,21,()=>bi(o),e=>e.id,(e,t)=>{var n=I7();n.__click=[x7,u,t];var r=Gt(n),s=Gt(r,!0);zt(r);var o=Kt(r,2),c=Gt(o),h=Gt(c);zt(c);var p=Kt(c,2);N6(Gt(p),{get plugin(){return i()},get content(){return bi(t).content},get sourcePath(){return bi(d)}}),zt(p),zt(o);var g=Kt(o,2),v=e=>{var n=ha(),i=Qt(n),r=e=>{var t=_7();ur(3,t,()=>w7),pa(e,t)},s=e=>{var n=ha(),i=Qt(n),r=e=>{var t=C7();ur(3,t,()=>w7),pa(e,t)};xa(i,e=>{bi(t).id===bi(a)&&e(r)},!0),pa(e,n)};xa(i,e=>{bi(t).id===bi(l)?e(r):e(s,!1)}),pa(e,n)};xa(g,e=>{null!==bi(a)&&e(v)}),zt(n),zi((e,i)=>{Fa(n,1,e,"svelte-158eiio"),er(n,"data-option-id",bi(t).id),n.disabled=null!==bi(a),va(s,bi(a)===bi(t).id?"●":"○"),va(h,`${null!=i?i:""}.`)},[()=>$a(function(e){const t="choice-option";return null===bi(a)?t:e===bi(l)?`${t} choice-correct`:e===bi(a)?`${t} choice-incorrect`:`${t} choice-unselected`}(bi(t).id)),()=>bi(t).label||bi(t).id.toUpperCase()]),pa(e,n)}),zt(w);var k=Kt(w,2),S=e=>{var t=D7(),n=Kt(Gt(t),2);N6(Gt(n),{get plugin(){return i()},get content(){return bi(c)},get sourcePath(){return bi(d)}}),zt(n),zt(t),ur(3,t,()=>k7,()=>({duration:350})),pa(e,t)};xa(k,e=>{bi(r)&&bi(c)&&e(S)});var x=Kt(k,2),_=e=>{pa(e,T7())};return xa(x,e=>{0===bi(o).length&&e(_)}),zt(p),zi(e=>va(f,`${null!=e?e:""} 选择题`),[()=>function(e){switch(e){case"basic-qa":return"💬";case"single-choice":return"📝";case"multiple-choice":return"☑️";case"cloze-deletion":return"✏️";case"fill-in-blank":return"✍️";case"sequence":return"📋";case"extensible":return"🔧";default:return"❓"}}(CS.MULTIPLE_CHOICE)]),pa(e,p),St(h)}function E7(e,t,n){var i;const a=e.target;"A"!==a.tagName&&"BUTTON"!==a.tagName?t()||null==(i=n())||i(e):e.stopPropagation()}function z7(e,t,n){var i;t()||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),null==(i=n())||i(e))}ia(["click"]);var P7=la('<div><!> <span class="badge-text svelte-1ar5xqm"> </span></div>'),R7=la('<div class="choice-option-status-icon correct svelte-1ar5xqm"><!></div>'),$7=la('<div class="choice-option-status-icon wrong svelte-1ar5xqm"><!></div>'),O7=la('<div role="button"><div class="choice-option-layout svelte-1ar5xqm"><div class="choice-option-label-container svelte-1ar5xqm"><span class="choice-option-label svelte-1ar5xqm"> </span></div> <div class="choice-option-content-wrapper svelte-1ar5xqm"><!></div> <!></div></div>');function L7(e,t){if(new.target)return Er({component:L7,...e});kt(t,!0);let n=Ar(t,"option",7),i=Ar(t,"isSelected",7,!1),a=Ar(t,"isCorrect",7,!1),r=Ar(t,"isWrong",7,!1),s=Ar(t,"disabled",7,!1),o=Ar(t,"showStatusIcon",7,!1),l=Ar(t,"badgeText",7),c=Ar(t,"badgeIcon",7),d=Ar(t,"plugin",7),u=Ar(t,"sourcePath",7,""),h=Ar(t,"onclick",7),p=Ar(t,"onkeydown",7),g=Ar(t,"className",7,"");var v={get option(){return n()},set option(e){n(e),hn()},get isSelected(){return i()},set isSelected(e=!1){i(e),hn()},get isCorrect(){return a()},set isCorrect(e=!1){a(e),hn()},get isWrong(){return r()},set isWrong(e=!1){r(e),hn()},get disabled(){return s()},set disabled(e=!1){s(e),hn()},get showStatusIcon(){return o()},set showStatusIcon(e=!1){o(e),hn()},get badgeText(){return l()},set badgeText(e){l(e),hn()},get badgeIcon(){return c()},set badgeIcon(e){c(e),hn()},get plugin(){return d()},set plugin(e){d(e),hn()},get sourcePath(){return u()},set sourcePath(e=""){u(e),hn()},get onclick(){return h()},set onclick(e){h(e),hn()},get onkeydown(){return p()},set onkeydown(e){p(e),hn()},get className(){return g()},set className(e=""){g(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},f=O7();let m;f.__click=[E7,s,h],f.__keydown=[z7,s,p];var y=Gt(f),b=Gt(y),w=Gt(b),k=Gt(w,!0);zt(w),zt(b);var S=Kt(b,2);N6(Gt(S),{get plugin(){return d()},get content(){return n().content},get sourcePath(){return u()}}),zt(S);var x=Kt(S,2),_=e=>{var t=P7();let n;var i=Gt(t),s=e=>{m5(e,{get name(){return c()},size:16})};xa(i,e=>{c()&&e(s)});var o=Kt(i,2),d=Gt(o,!0);zt(o),zt(t),zi(e=>{n=Fa(t,1,"choice-option-badge svelte-1ar5xqm",null,n,e),va(d,l())},[()=>({correct:a(),wrong:r()})]),pa(e,t)},C=e=>{var t=ha(),n=Qt(t),i=e=>{var t=ha(),n=Qt(t),i=e=>{var t=R7();m5(Gt(t),{name:"check",size:18}),zt(t),pa(e,t)},s=e=>{var t=ha(),n=Qt(t),i=e=>{var t=$7();m5(Gt(t),{name:"x",size:18}),zt(t),pa(e,t)};xa(n,e=>{r()&&e(i)},!0),pa(e,t)};xa(n,e=>{a()?e(i):e(s,!1)}),pa(e,t)};xa(n,e=>{o()&&e(i)},!0),pa(e,t)};return xa(x,e=>{l()?e(_):e(C,!1)}),zt(y),zt(f),zi(e=>{var t,a;m=Fa(f,1,`choice-option-wrapper ${null!=(t=g())?t:""}`,"svelte-1ar5xqm",m,e),er(f,"tabindex",s()?-1:0),er(f,"aria-label",`选项${null!=(a=n().label)?a:""}`),er(f,"aria-pressed",i()),er(f,"aria-disabled",s()),er(f,"data-option-label",n().label),va(k,n().label)},[()=>({selected:i(),correct:a(),wrong:r(),disabled:s()})]),pa(e,f),St(v)}ia(["click","keydown"]);var N7=la('<div class="answer-comparison svelte-5dgnwu"><div class="comparison-row svelte-5dgnwu"><div class="comparison-item your-answer svelte-5dgnwu"><span class="comparison-label svelte-5dgnwu">你的答案</span> <span> </span></div> <div class="comparison-divider svelte-5dgnwu"></div> <div class="comparison-item correct-answer svelte-5dgnwu"><span class="comparison-label svelte-5dgnwu">正确答案</span> <span class="comparison-value correct svelte-5dgnwu"> </span></div></div></div>'),F7=la('<div class="explanation-section svelte-5dgnwu"><div class="explanation-header svelte-5dgnwu"><span class="explanation-icon svelte-5dgnwu">💡</span> <span class="explanation-title svelte-5dgnwu">详细解析</span></div> <div class="explanation-content svelte-5dgnwu"></div></div>'),B7=la('<div><div class="choice-question-title svelte-5dgnwu"><span class="choice-question-label svelte-5dgnwu"> </span> <span class="choice-question-count svelte-5dgnwu"> <!></span></div> <div class="question-header svelte-5dgnwu"><div class="question-text svelte-5dgnwu"></div></div> <div class="options-container svelte-5dgnwu"></div> <!> <!></div>');function j7(e,t){if(new.target)return Er({component:j7,...e});kt(t,!0);let n=Ar(t,"question",7),i=Ar(t,"showAnswer",7),a=Ar(t,"onOptionSelect",7),r=Ar(t,"onShowAnswer",7),s=Ar(t,"selectedOptions",31,()=>Ot([])),o=Ar(t,"plugin",7),l=Ar(t,"enableAnimations",7,!0),c=Ar(t,"card",7),d=Ar(t,"onAddToErrorBook",7),u=Ar(t,"onRemoveFromErrorBook",7),h=Ar(t,"currentResponseTime",7),p=Pn(null),g=Pn(null);async function v(e,t){var n;if(e&&t)try{e.innerHTML="";const i=o().app.workspace.getActiveFile(),a=(null==i?void 0:i.path)||(null==(n=c())?void 0:n.sourceFile)||"",r=new ge.Component;await ge.MarkdownRenderer.render(o().app,t,e,a,r),r.load(),await new Promise(e=>setTimeout(e,50)),function(e,t){if(!e)return;const n=e.querySelectorAll("a.internal-link");n.forEach(n=>{const i=n,a=i.getAttribute("data-href");if(!a)return;const r=e=>{e.preventDefault(),e.stopPropagation(),o().app.workspace.openLinkText(a,t,e.ctrlKey||e.metaKey)};i.addEventListener("click",r),i.setAttribute("data-href",a),i.setAttribute("data-tooltip-position","top"),i.setAttribute("rel","noopener"),i.setAttribute("target","_blank"),i.classList.add("internal-link"),i.addEventListener("mouseenter",n=>{const i=n.currentTarget;o().app.workspace.trigger("hover-link",{event:n,source:"preview",hoverParent:e,targetEl:i,linktext:a,sourcePath:t})})})}(e,a),function(e){if(!e)return;const t=e.querySelectorAll('a.footnote-ref, sup a[href^="#fn"]'),n=e.querySelector(".footnotes, section.footnotes");if(0===t.length&&!n)return;t.forEach(t=>{const n=t,i=n.getAttribute("href");if(!i||!i.startsWith("#"))return;const a=i.substring(1),r=t=>{t.preventDefault(),t.stopPropagation();let n=e.querySelector(`#${a}`)||e.querySelector(`li[id="${a}"]`)||e.querySelector(`[data-footnote-id="${a}"]`);if(!n&&a.startsWith("fn:")){const t=a.substring(3);n=e.querySelector(`#fnref\\:${t}`)}n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("footnote-highlighted"),setTimeout(()=>n.classList.remove("footnote-highlighted"),2e3))};n.addEventListener("click",r,{capture:!0})});const i=e.querySelectorAll('a.footnote-backref, .footnotes a[href^="#fnref"]');i.forEach(t=>{const n=t,i=n.getAttribute("href");if(!i||!i.startsWith("#"))return;const a=i.substring(1),r=t=>{t.preventDefault(),t.stopPropagation();let n=e.querySelector(`#${a}`);if(!n&&a.startsWith("fnref:")){const t=a.substring(6);n=e.querySelector(`a[href="#fn:${t}"]`)||e.querySelector(`sup a[href="#fn:${t}"]`)||e.querySelector(`a.footnote-ref[href="#fn:${t}"]`)}n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("footnote-highlighted"),setTimeout(()=>{n.classList.remove("footnote-highlighted")},2e3))};n.addEventListener("click",r,{capture:!0})}),n&&(n.style.display="",n.style.visibility="visible")}(e)}catch(i){_e.error("[ChoiceQuestionPreview] Markdown渲染失败:",i),e.textContent=t}}Ti(()=>{bi(p)&&n().question&&v(bi(p),n().question)}),Ti(()=>{i()&&bi(g)&&n().explanation&&v(bi(g),n().explanation)});let f=In(()=>s().length>0),m=In(()=>{if(0===s().length)return!1;if(n().isMultipleChoice){const e=n().options.filter(e=>e.isCorrect).map(e=>e.label),t=new Set(s()),i=new Set(e);if(t.size!==i.size)return!1;for(const n of s())if(!i.has(n))return!1;return!0}{const e=n().options.find(e=>e.label===s()[0]);return(null==e?void 0:e.isCorrect)||!1}}),y=In(()=>n().options.filter(e=>e.isCorrect).map(e=>e.label));function b(e){var t,o;if(i())return;const l=e.label;n().isMultipleChoice?s().includes(l)?s(s().filter(e=>e!==l)):s([...s(),l]):(s([l]),null==(t=r())||t()),null==(o=a())||o(l)}function w(e){if(i())return;const t=e.target;if("INPUT"===(null==t?void 0:t.tagName)||"TEXTAREA"===(null==t?void 0:t.tagName)||(null==t?void 0:t.isContentEditable))return;const a=e.key.toUpperCase(),r=n().options.find(e=>e.label===a);r&&(e.preventDefault(),e.stopPropagation(),b(r))}Pr(()=>(window.addEventListener("keydown",w,{capture:!1}),()=>{window.removeEventListener("keydown",w,{capture:!1})}));var k={get question(){return n()},set question(e){n(e),hn()},get showAnswer(){return i()},set showAnswer(e){i(e),hn()},get onOptionSelect(){return a()},set onOptionSelect(e){a(e),hn()},get onShowAnswer(){return r()},set onShowAnswer(e){r(e),hn()},get selectedOptions(){return s()},set selectedOptions(e=[]){s(e),hn()},get plugin(){return o()},set plugin(e){o(e),hn()},get enableAnimations(){return l()},set enableAnimations(e=!0){l(e),hn()},get card(){return c()},set card(e){c(e),hn()},get onAddToErrorBook(){return d()},set onAddToErrorBook(e){d(e),hn()},get onRemoveFromErrorBook(){return u()},set onRemoveFromErrorBook(e){u(e),hn()},get currentResponseTime(){return h()},set currentResponseTime(e){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},S=B7();let x;var _=Gt(S),C=Gt(_),I=Gt(C,!0);zt(C);var D=Kt(C,2),T=Gt(D),M=Kt(T),A=e=>{var t=ua();zi(()=>{var e;return va(t,`· 已选 ${null!=(e=s().length)?e:""}`)}),pa(e,t)};xa(M,e=>{s().length>0&&!i()&&e(A)}),zt(D),zt(_);var E=Kt(_,2);kr(Gt(E),e=>$n(p,e),()=>bi(p)),zt(E);var z=Kt(E,2);Ca(z,21,()=>n().options,e=>e.label,(e,t)=>{const n=In(()=>s().includes(bi(t).label)),a=In(()=>bi(t).isCorrect),r=In(()=>bi(n)&&!bi(a));{let s=In(()=>i()&&bi(a)),l=In(()=>i()&&bi(r)),d=In(()=>{var e;return(null==(e=c())?void 0:e.sourceFile)||""});L7(e,{get option(){return bi(t)},get isSelected(){return bi(n)},get isCorrect(){return bi(s)},get isWrong(){return bi(l)},get disabled(){return i()},get showStatusIcon(){return i()},get plugin(){return o()},get sourcePath(){return bi(d)},onclick:()=>b(bi(t)),className:"memory-study-option"})}}),zt(z);var P=Kt(z,2),R=e=>{var t=N7(),n=Gt(t),i=Gt(n),a=Kt(Gt(i),2);let r;var o=Gt(a,!0);zt(a),zt(i);var l=Kt(i,4),c=Kt(Gt(l),2),d=Gt(c,!0);zt(c),zt(l),zt(n),zt(t),zi((e,t,n)=>{r=Fa(a,1,"comparison-value svelte-5dgnwu",null,r,e),va(o,t),va(d,n)},[()=>({incorrect:!bi(m)}),()=>s().sort().join("、"),()=>bi(y).sort().join("、")]),pa(e,t)};xa(P,e=>{i()&&bi(f)&&e(R)});var $=Kt(P,2),O=e=>{var t=F7();kr(Kt(Gt(t),2),e=>$n(g,e),()=>bi(g)),zt(t),pa(e,t)};return xa($,e=>{i()&&n().explanation&&e(O)}),zt(S),zi(e=>{var t;x=Fa(S,1,"choice-question-container svelte-5dgnwu",null,x,e),va(I,n().isMultipleChoice?"多选题":"单选题"),va(T,`${null!=(t=n().options.length)?t:""} 个选项 `)},[()=>({"animations-enabled":l()})]),pa(e,S),St(k)}const U7="\x3c!-- tuanki-mask:",V7="--\x3e",q7="1.0",H7="rgba(0, 0, 0, 0.7)",W7=10,G7=300;class Q7{constructor(e){oe(this,"app"),this.app=e}parseCommentToMaskData(e){try{const t=this.extractJSONFromComment(e);if(!t)return{success:!1,error:"无法从注释中提取 JSON 数据"};const n=JSON.parse(t),i=this.validateMaskData(n);return i.success?{success:!0,data:n}:{success:!1,error:i.error}}catch(t){return _e.error("[MaskDataParser] 解析注释失败:",t),{success:!1,error:t instanceof Error?t.message:"未知错误"}}}maskDataToComment(e){const t=JSON.stringify(e);return`${U7} ${t} ${V7}`}findMaskCommentForImage(e,t){const n=e.split("\n");if(t>=n.length)return{found:!1};const i=t+1;if(i>=n.length)return{found:!1};const a=n[i].trim();return this.isMaskComment(a)?{found:!0,line:i,content:a}:{found:!1}}resolveImagePath(e,t){try{const n=this.extractImageFilename(e);if(!n)return _e.warn("[MaskDataParser] 无法从链接中提取文件名:",e),null;const i=this.app.metadataCache.getFirstLinkpathDest(n,t);return i||(_e.warn("[MaskDataParser] 无法找到图片文件:",n),null)}catch(n){return _e.error("[MaskDataParser] 解析图片路径失败:",n),null}}hasImageLink(e){return/!\[\[.*?\]\]/.test(e)||/!\[.*?\]\(.*?\)/.test(e)}extractImageLink(e){const t=e.match(/!\[\[.*?\]\]/);if(t)return t[0];const n=e.match(/!\[.*?\]\(.*?\)/);return n?n[0]:null}extractJSONFromComment(e){const t=e.trim();if(!t.startsWith(U7))return null;if(!t.endsWith(V7))return null;const n=U7.length,i=t.length-V7.length;return t.substring(n,i).trim()}validateMaskData(e){if(!e||"object"!=typeof e)return{success:!1,error:"遮罩数据格式错误"};if(!e.version||e.version!==q7)return{success:!1,error:`不支持的数据版本: ${e.version}`};if(!Array.isArray(e.masks))return{success:!1,error:"masks 必须是数组"};for(let t=0;t<e.masks.length;t++){const n=e.masks[t],i=this.validateMask(n,t);if(!i.success)return i}return{success:!0}}validateMask(e,t){if(!e.id||"string"!=typeof e.id)return{success:!1,error:`遮罩 #${t}: 缺少 id 字段`};if(!e.type||!["rect","circle"].includes(e.type))return{success:!1,error:`遮罩 #${t}: type 必须是 'rect' 或 'circle'`};if("number"!=typeof e.x||e.x<0||e.x>1)return{success:!1,error:`遮罩 #${t}: x 必须是 0-1 之间的数字`};if("number"!=typeof e.y||e.y<0||e.y>1)return{success:!1,error:`遮罩 #${t}: y 必须是 0-1 之间的数字`};if("rect"===e.type){if("number"!=typeof e.width||e.width<=0||e.width>1)return{success:!1,error:`遮罩 #${t}: width 必须是 0-1 之间的正数`};if("number"!=typeof e.height||e.height<=0||e.height>1)return{success:!1,error:`遮罩 #${t}: height 必须是 0-1 之间的正数`}}return"circle"===e.type&&("number"!=typeof e.radius||e.radius<=0||e.radius>1)?{success:!1,error:`遮罩 #${t}: radius 必须是 0-1 之间的正数`}:{success:!0}}isMaskComment(e){return e.startsWith(U7)&&e.endsWith(V7)}extractImageFilename(e){const t=e.match(/!\[\[(.*?)\]\]/);if(t)return t[1];const n=e.match(/!\[.*?\]\((.*?)\)/);return n?n[1]:null}}function K7(){return`mask_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Z7=Object.freeze(Object.defineProperty({__proto__:null,MaskDataParser:Q7,generateMaskId:K7},Symbol.toStringTag,{value:"Module"})),Y7=new Map;function X7(e){if(Y7.has(e))return Y7.get(e);const t={rgb:"rgb(0, 0, 0)",opacity:.7};if(!e||"string"!=typeof e)return t;const n=e.replace(/\s+/g," ").trim(),i=n.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*([\d.]+))?\s*\)/);if(i){const t={rgb:`rgb(${i[1]}, ${i[2]}, ${i[3]})`,opacity:i[4]?parseFloat(i[4]):1};return Y7.set(e,t),t}const a=n.match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);if(a){let t=a[1];3===t.length&&(t=t.split("").map(e=>e+e).join(""));const n={rgb:`rgb(${parseInt(t.substring(0,2),16)}, ${parseInt(t.substring(2,4),16)}, ${parseInt(t.substring(4,6),16)})`,opacity:1};return Y7.set(e,n),n}return Y7.set(e,t),t}function J7(e,t){const n=t.getBoundingClientRect();return{x:(e.clientX-n.left)/n.width,y:(e.clientY-n.top)/n.height}}function e8(e){return Math.max(0,Math.min(1,e))}function t8(e,t=.01){return"rect"===e.type?(e.width||0)<t||(e.height||0)<t:"circle"===e.type&&(e.radius||0)<t}class n8{constructor(){oe(this,"maskStates",new Map)}renderMasksOnImage(e,t,n={visible:!0,interactive:!1}){if(!t||!t.masks||0===t.masks.length)return;const i=this.createMaskContainer(e,n.interactive);t.masks.forEach(t=>{var a;const r=this.createMaskElement(t,e,n);r&&(i.appendChild(r),this.maskStates.set(t.id,null==(a=n.visible)||a),n.interactive&&this.makeMaskInteractive(r,t.id))})}showMasks(e,t=G7){e&&(e.style.display="",e.style.opacity="1",e.style.transition=`opacity ${t}ms ease-in`)}hideMasks(e,t=G7){if(!e)return;e.style.opacity="0",e.style.transition=`opacity ${t}ms ease-out`;e.querySelectorAll(".tuanki-mask").forEach(e=>{const t=e.getAttribute("data-mask-id");t&&this.maskStates.set(t,!1)}),setTimeout(()=>{e.style.display="none"},t)}toggleMask(e,t=G7){var n;const i=document.querySelector(`[data-mask-id="${e}"]`);if(!i)return;const a=!(null==(n=this.maskStates.get(e))||n);this.maskStates.set(e,a),a?(i.style.transition=`fill-opacity ${t}ms ease-in`,i.style.fillOpacity=i.getAttribute("data-original-opacity")||"0.7",i.classList.remove("mask-revealed"),i.classList.remove("mask-hovering")):(i.style.transition=`fill-opacity ${t}ms ease-out`,i.style.fillOpacity="0",i.classList.add("mask-revealed"),i.classList.remove("mask-hovering"))}makeMaskInteractive(e,t){e.style.pointerEvents="auto",e.style.cursor="pointer",e.classList.add("tuanki-mask-interactive");const n=e.getAttribute("fill-opacity")||"0.7";e.setAttribute("data-original-opacity",n),e.addEventListener("click",e=>{e.stopPropagation(),this.toggleMask(t),_e.debug("[MaskRenderer] 切换遮罩:",t)}),e.addEventListener("mouseenter",()=>{var n;if((null==(n=this.maskStates.get(t))||n)&&!e.classList.contains("mask-revealed")){const t=e.style.fillOpacity||e.getAttribute("fill-opacity")||"0.7";e.setAttribute("data-hover-backup-opacity",t),e.style.transition="fill-opacity 150ms ease",e.style.fillOpacity="0",e.classList.add("mask-hovering")}}),e.addEventListener("mouseleave",()=>{var n;if((null==(n=this.maskStates.get(t))||n)&&e.classList.contains("mask-hovering")){const t=e.getAttribute("data-hover-backup-opacity")||"0.7";e.style.fillOpacity=t,e.classList.remove("mask-hovering")}})}findMaskContainer(e){const t=e.parentElement;return t&&t.classList.contains("tuanki-image-with-masks")?t.querySelector(".tuanki-mask-overlay"):null}createMaskContainer(e,t=!1){let n=e.parentElement;if(!n||!n.classList.contains("tuanki-image-with-masks")){n=document.createElement("div"),n.className="tuanki-image-with-masks";const t=e.parentElement;t&&(t.insertBefore(n,e),n.appendChild(e))}const i=n.querySelector(".tuanki-mask-overlay");i&&i.remove();const a=document.createElementNS("http://www.w3.org/2000/svg","svg");return a.setAttribute("class",t?"tuanki-mask-overlay interactive":"tuanki-mask-overlay"),a.setAttribute("viewBox","0 0 100 100"),a.setAttribute("preserveAspectRatio","none"),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.pointerEvents=t?"auto":"none",n.appendChild(a),a}createMaskElement(e,t,n){let i;if("rect"===e.type)i=this.createRectMask(e);else{if("circle"!==e.type)return _e.warn("[MaskRenderer] 不支持的遮罩类型:",e.type),null;i=this.createCircleMask(e)}return this.applyMaskStyle(i,e),n.visible||(i.style.display="none"),i}createRectMask(e){const t=document.createElementNS("http://www.w3.org/2000/svg","rect");return t.setAttribute("x",100*e.x+"%"),t.setAttribute("y",100*e.y+"%"),t.setAttribute("width",100*e.width+"%"),t.setAttribute("height",100*e.height+"%"),t.setAttribute("data-mask-id",e.id),t}createCircleMask(e){const t=document.createElementNS("http://www.w3.org/2000/svg","circle");return t.setAttribute("cx",100*e.x+"%"),t.setAttribute("cy",100*e.y+"%"),t.setAttribute("r",100*e.radius+"%"),t.setAttribute("data-mask-id",e.id),t}applyMaskStyle(e,t){const n=t.fill||H7,{rgb:i,opacity:a}=X7(n);if(e.setAttribute("fill",i),e.setAttribute("fill-opacity",a.toString()),e.style.opacity="1","blur"===t.style){const n=`blur-${t.id}`,i=this.createBlurFilter(n,t.blurRadius||W7),a=e.parentElement;if(a){let t=a.querySelector("defs");t||(t=document.createElementNS("http://www.w3.org/2000/svg","defs"),a.insertBefore(t,a.firstChild)),t.appendChild(i),e.setAttribute("filter",`url(#${n})`)}}e.classList.add("tuanki-mask"),e.classList.add(`tuanki-mask-${t.style}`)}resetMaskStates(){this.maskStates.clear()}createBlurFilter(e,t){const n=document.createElementNS("http://www.w3.org/2000/svg","filter");n.setAttribute("id",e);const i=document.createElementNS("http://www.w3.org/2000/svg","feGaussianBlur");return i.setAttribute("in","SourceGraphic"),i.setAttribute("stdDeviation",`${t}`),n.appendChild(i),n}}function i8(e,t=G7){const n=new n8,i=function(e){return Array.from(e.querySelectorAll(".tuanki-image-with-masks"))}(e);i.forEach(e=>{const i=e.querySelector(".tuanki-mask-overlay");n.hideMasks(i,t)})}class a8{constructor(e){oe(this,"app"),oe(this,"parser"),oe(this,"renderer"),this.app=e,this.parser=new Q7(e),this.renderer=new n8}applyMasksInContainer(e,t,n=!1){const i=e.querySelectorAll("img");if(0===i.length)return;const a=this.parseMaskDataFromContent(t);0!==a.size&&i.forEach((e,t)=>{const i=e.getAttribute("src")||"",r=this.findMaskDataForImage(i,t,a);r&&(_e.debug(`[ImageMaskIntegration] 为图片 ${t} 应用遮罩，数据:`,{maskCount:r.masks.length,masks:r.masks.map(e=>({id:e.id,type:e.type,fill:e.fill,style:e.style}))}),this.renderer.renderMasksOnImage(e,r,{visible:!0,interactive:n}))})}showAllMasks(e,t=!1){e.querySelectorAll(".tuanki-image-with-masks").forEach(e=>{const n=e.querySelector(".tuanki-mask-overlay");n&&(t?this.renderer.showMasks(n,G7):(n.style.display="",n.style.opacity="1"))}),_e.debug(`[ImageMaskIntegration] 显示所有遮罩（动画: ${t}）`)}revealAllMasks(e,t=G7){i8(e,t),_e.debug(`[ImageMaskIntegration] 揭示所有遮罩（动画 ${t}ms）`)}removeMasksInContainer(e){e.querySelectorAll(".tuanki-mask-overlay").forEach(e=>e.remove());e.querySelectorAll(".tuanki-image-with-masks").forEach(e=>{const t=e.querySelector("img");t&&e.parentElement&&(e.parentElement.insertBefore(t,e),e.remove())})}parseMaskDataFromContent(e){const t=new Map,n=e.split("\n");let i=0;for(let a=0;a<n.length;a++){const e=n[a].trim();if(this.parser.hasImageLink(e)){const e=a+1;if(e<n.length){const a=n[e].trim();if(a.startsWith(U7)){const e=this.parser.parseCommentToMaskData(a);e.success&&e.data&&(t.set(i,e.data),_e.debug(`[ImageMaskIntegration] 找到遮罩数据：图片序号=${i}，遮罩数量=${e.data.masks.length}`))}}i++}}return _e.debug(`[ImageMaskIntegration] 解析完成：共 ${i} 张图片，${t.size} 张有遮罩`),t}findMaskDataForImage(e,t,n){const i=n.get(t);return i?(_e.debug(`[ImageMaskIntegration] 为图片 #${t} 找到遮罩数据，包含 ${i.masks.length} 个遮罩`),i):null}}function r8(e){return e.type===Kr.ProgressiveParent}function s8(e){return e.type===Kr.ProgressiveChild}class o8{constructor(e,t){oe(this,"contentCache",null),oe(this,"clozeDataCache",null),this.card=e,this.cardStore=t}getContent(){if(null!==this.contentCache)return this.contentCache;let e;if(s8(this.card))if(this.card.content&&this.card.content.trim())e=this.card.content;else{const t=this.cardStore.getCard(this.card.parentCardId);if(!t)throw new Error(`[CardAccessor] Parent card not found: ${this.card.parentCardId} for child card: ${this.card.uuid}`);if(!r8(t))throw new Error(`[CardAccessor] Parent card is not a progressive-parent type: ${t.uuid}`);e=t.content}else e=this.card.content||"";return this.contentCache=e,e}getParentCard(){if(!s8(this.card))return null;const e=this.cardStore.getCard(this.card.parentCardId);return e&&r8(e)?e:null}parseClozes(){var e;if(null!==this.clozeDataCache)return this.clozeDataCache;const t=this.getContent(),n=[],i=/\{\{c(\d+)::([^:}]+)(?:::([^}]+))?\}\}/g;let a;for(;null!==(a=i.exec(t));){const t=parseInt(a[1],10)-1,i=a[2].trim(),r=null==(e=a[3])?void 0:e.trim(),s=n.findIndex(e=>e.ord===t);s>=0?(n[s].text+=`, ${i}`,r&&!n[s].hint&&(n[s].hint=r)):n.push({ord:t,text:i,hint:r,position:{start:a.index,end:a.index+a[0].length}})}return n.sort((e,t)=>e.ord-t.ord),this.clozeDataCache=n,n}getActiveClozeData(){if(!s8(this.card))return null;const e=this.parseClozes(),t=this.card;return e.find(e=>e.ord===t.clozeOrd)||null}getActiveClozeText(){const e=this.getActiveClozeData();return(null==e?void 0:e.text)||null}getActiveClozeHint(){const e=this.getActiveClozeData();return(null==e?void 0:e.hint)||null}getDisplayContent(e=!0){const t=this.getContent();if(!s8(this.card))return t;const n=this.card.clozeOrd;return t.replace(/\{\{c(\d+)::([^:}]+)(?:::([^}]+))?\}\}/g,(t,i,a,r)=>parseInt(i,10)-1===n?e&&r?`[${r}]`:"[...]":a)}getAnswerContent(){const e=this.getContent();if(!s8(this.card))return e;const t=this.card.clozeOrd;return e.replace(/\{\{c(\d+)::([^:}]+)(?:::([^}]+))?\}\}/g,(e,n,i)=>parseInt(n,10)-1===t?`**${i}**`:i)}clearCache(){this.contentCache=null,this.clozeDataCache=null}getSiblingCards(){if(!s8(this.card))return[];const e=this.getParentCard();if(!e)return[];return this.cardStore.getCards(e.progressiveCloze.childCardIds).filter(e=>s8(e)&&e.uuid!==this.card.uuid)}hasSiblingStudiedToday(){const e=this.getSiblingCards(),t=(new Date).setHours(0,0,0,0),n=(new Date).setHours(23,59,59,999);return e.some(e=>{var i;const a=null==(i=e.fsrs)?void 0:i.lastReview;if(!a)return!1;const r=new Date(a).getTime();return r>=t&&r<=n})}}class l8{constructor(e){oe(this,"cardsCache",new Map),oe(this,"cacheInitialized",!1),this.storage=e}async initializeCache(){if(!this.cacheInitialized)try{const e=await this.storage.getDecks();for(const t of e){const e=await this.storage.getCards({deckId:t.id});for(const t of e)this.cardsCache.set(t.uuid,t)}this.cacheInitialized=!0,_e.debug(`[CardStoreAdapter] 缓存初始化完成: ${this.cardsCache.size}张卡片`)}catch(e){throw _e.error("[CardStoreAdapter] 缓存初始化失败:",e),e}}getCard(e){return this.cardsCache.get(e)||null}getCards(e){const t=[];for(const n of e){const e=this.cardsCache.get(n);e&&t.push(e)}return t}updateCache(e){this.cardsCache.set(e.uuid,e)}removeFromCache(e){this.cardsCache.delete(e)}updateCacheBatch(e){for(const t of e)this.cardsCache.set(t.uuid,t)}clearCache(){this.cardsCache.clear(),this.cacheInitialized=!1}getAllCards(){return Array.from(this.cardsCache.values())}getCacheStats(){return{totalCards:this.cardsCache.size,initialized:this.cacheInitialized}}}var c8=la('<div><div class="sticky-number svelte-1ergjlu"> </div> <div class="sticky-label svelte-1ergjlu"> </div></div>'),d8=la('<div class="tuanki-preview-loading svelte-1ergjlu"><div class="loading-spinner svelte-1ergjlu"></div> <div class="loading-text svelte-1ergjlu">正在生成预览...</div></div>'),u8=la('<div class="tuanki-preview-error svelte-1ergjlu"><div class="error-icon svelte-1ergjlu">⚠️</div> <div class="error-title svelte-1ergjlu">预览渲染失败</div> <div class="error-message svelte-1ergjlu"> </div></div>'),h8=la('<div class="tuanki-preview-empty svelte-1ergjlu"><div class="empty-icon svelte-1ergjlu">📝</div> <div class="empty-title svelte-1ergjlu">没有可显示的卡片</div> <div class="empty-description svelte-1ergjlu">请选择一张卡片开始学习</div></div>'),p8=la('<div class="fallback-section svelte-1ergjlu"><!></div>'),g8=la('<div class="tuanki-card-base svelte-1ergjlu"><div class="preview-fallback svelte-1ergjlu"><div class="fallback-header svelte-1ergjlu"><span class="tuanki-card-type-badge svelte-1ergjlu"> </span></div> <!></div></div>'),v8=la("<div><!> <!></div>");function f8(e,t){if(new.target)return Er({component:f8,...e});kt(t,!0);let n,i,a,r=Ar(t,"card",15),s=Ar(t,"template",7),o=Ar(t,"showAnswer",15),l=Ar(t,"enableAnimations",7,!0),c=Ar(t,"enableAnswerControls",7,!0),d=Ar(t,"themeMode",7,"auto"),u=Ar(t,"renderingMode",7,"performance"),h=Ar(t,"plugin",7),p=Ar(t,"activeClozeOrdinal",7),g=Ar(t,"refreshTrigger",7,0),v=Ar(t,"onCardTypeDetected",7),f=Ar(t,"onPreviewReady",7),m=Ar(t,"onAddToErrorBook",7),y=Ar(t,"onRemoveFromErrorBook",7),b=Ar(t,"currentResponseTime",7),w=Pn(void 0),k=Pn(null),S=Pn(!1),x=Pn(null),_=Pn(null),C=Pn(!1),I=Pn(Ot(c())),D=Pn(0),T=Pn(null),M=Pn(Ot([]));async function A(){if(r()&&n){$n(S,!0),$n(x,null);try{const e=await n.parseCardContent(r(),s());if($n(k,e,!0),e.cardType===CS.SINGLE_CHOICE||e.cardType===CS.MULTIPLE_CHOICE){const e=q6(function(e){try{const t=new l8(h().dataStorage),n=new o8(e,t).getContent();if(n&&n.trim())return n.trim()}catch(r){if(_e.error("[PreviewContainer] CardAccessor获取内容失败:",r),e.content&&e.content.trim())return e.content.trim()}if(!e.fields)return"";const t=e.fields.options||e.fields.Options,n=e.fields.correctAnswers||e.fields.CorrectAnswers;if(t&&n){const n=e.fields.front||e.fields.Front||e.fields.question||"",i=e.fields.back||e.fields.Back||e.fields.answer||"";let a="";return n&&!n.trim().startsWith("Q:")?a+=`Q: ${n}\n\n`:a+=`${n}\n\n`,a+=`${t}\n\n`,i&&(a+=`---div---\n\n${i}`),a.trim()}const i=e.fields.front||e.fields.Front||e.fields.question||"",a=e.fields.back||e.fields.Back||e.fields.answer||"";if(i&&a)return`${i}\n\n---div---\n\n${a}`;return i||a}(r()));e?($n(T,e,!0),$n(M,[],!0)):$n(T,null)}else $n(T,null),$n(M,[],!0);v()&&v()(e.cardType),f()&&f()(e)}catch(e){_e.error("[PreviewContainer] 卡片解析失败:",e),$n(x,e instanceof Error?e.message:"未知错误",!0)}finally{$n(S,!1)}}}function E(e){}function z(){o(!0)}Pr(()=>{n=new Q6(h()),a=new a8(h().app);const e={enableAnimations:l(),reducedMotion:!1,performanceMode:"performance"===u()?"performance":"quality"};$n(w,new K6(e),!0)}),Rr(()=>{n&&n.clearCache(),bi(w)&&bi(w).cleanup()}),Ti(()=>{!r()||r().uuid===bi(_)&&c()===bi(I)&&g()===bi(D)?r()&&o()!==bi(C)&&$n(C,o(),!0):($n(_,r().uuid,!0),$n(C,o(),!0),$n(I,c()),$n(D,g()),A())}),Ti(()=>{if(r()&&bi(k)&&i&&a){const e=i;yi().then(async()=>{try{let t=0;const n=20,i=100;for(;t<n;){const n=e.querySelectorAll("img");if(n.length>0){const t=Array.from(n).map(e=>e.complete?Promise.resolve():new Promise(t=>{e.addEventListener("load",()=>t(null),{once:!0}),e.addEventListener("error",()=>t(null),{once:!0}),setTimeout(()=>t(null),1e3)}));await Promise.all(t);const i=r().content||"",s=!o();return void a.applyMasksInContainer(e,i,s)}await new Promise(e=>setTimeout(e,i)),t++}}catch(t){_e.error("[PreviewContainer] 应用图片遮罩失败:",t)}})}}),Ti(()=>{o()&&i&&a?yi().then(()=>{try{a.revealAllMasks(i,300)}catch(e){_e.error("[PreviewContainer] 揭示遮罩失败:",e)}}):!o()&&i&&a&&yi().then(()=>{try{a.showAllMasks(i,!1)}catch(e){_e.error("[PreviewContainer] 显示遮罩失败:",e)}})});var P={getChoiceQuestionData:function(){return{questionData:bi(T),selectedOptions:bi(M),isChoiceQuestion:null!==bi(T)}},toggleAnswer:function(){o(!o())},refreshPreview:function(){n&&n.clearCache(),A()},getPreviewStats:function(){var e,t,i;return{cacheStats:(null==n?void 0:n.getCacheStats())||null,cardType:(null==(e=bi(k))?void 0:e.cardType)||null,confidence:(null==(t=bi(k))?void 0:t.metadata.confidence)||0,animationStats:(null==(i=bi(w))?void 0:i.getAnimationStats())||null}},get card(){return r()},set card(e){r(e),hn()},get template(){return s()},set template(e){s(e),hn()},get showAnswer(){return o()},set showAnswer(e){o(e),hn()},get enableAnimations(){return l()},set enableAnimations(e=!0){l(e),hn()},get enableAnswerControls(){return c()},set enableAnswerControls(e=!0){c(e),hn()},get themeMode(){return d()},set themeMode(e="auto"){d(e),hn()},get renderingMode(){return u()},set renderingMode(e="performance"){u(e),hn()},get plugin(){return h()},set plugin(e){h(e),hn()},get activeClozeOrdinal(){return p()},set activeClozeOrdinal(e){p(e),hn()},get refreshTrigger(){return g()},set refreshTrigger(e=0){g(e),hn()},get onCardTypeDetected(){return v()},set onCardTypeDetected(e){v(e),hn()},get onPreviewReady(){return f()},set onPreviewReady(e){f(e),hn()},get onAddToErrorBook(){return m()},set onAddToErrorBook(e){m(e),hn()},get onRemoveFromErrorBook(){return y()},set onRemoveFromErrorBook(e){y(e),hn()},get currentResponseTime(){return b()},set currentResponseTime(e){b(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},R=v8();let $;var O=Gt(R),L=e=>{var t=c8(),n=Gt(t),i=Gt(n,!0);zt(n);var a=Kt(n,2),s=Gt(a,!0);zt(a),zt(t),zi(()=>{var e;Fa(t,1,`priority-sticky-note priority-${null!=(e=r().priority)?e:""}`,"svelte-1ergjlu"),va(i,r().priority),va(s,1===r().priority?"低":2===r().priority?"中":3===r().priority?"高":"紧急")}),pa(e,t)};xa(O,e=>{r()&&r().priority&&e(L)});var N=Kt(O,2),F=e=>{pa(e,d8())},B=e=>{var t=ha(),n=Qt(t),i=e=>{var t=u8(),n=Kt(Gt(t),4),i=Gt(n,!0);zt(n),zt(t),zi(()=>va(i,bi(x))),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,h8())},a=e=>{var t=ha(),n=Qt(t),i=e=>{const t=In(()=>bi(k).cardType);var n=ha(),i=Qt(n),a=e=>{var t=ha(),n=Qt(t),i=e=>{j7(e,{get question(){return bi(T)},get showAnswer(){return o()},onOptionSelect:E,onShowAnswer:z,get plugin(){return h()},get enableAnimations(){return l()},get card(){return r()},get onAddToErrorBook(){return m()},get onRemoveFromErrorBook(){return y()},get currentResponseTime(){return b()},get selectedOptions(){return bi(M)},set selectedOptions(e){$n(M,e,!0)}})},a=e=>{{let t=In(()=>bi(k).metadata.sourcePath||"");h7(e,{get sections(){return bi(k).sections},get showAnswer(){return o()},get plugin(){return h()},get card(){return r()},get sourcePath(){return bi(t)},get animationController(){return bi(w)},get enableAnimations(){return l()}})}};xa(n,e=>{bi(T)?e(i):e(a,!1)}),pa(e,t)},s=e=>{var n=ha(),i=Qt(n),a=e=>{{let t=In(()=>bi(k).metadata.sourcePath||"");h7(e,{get sections(){return bi(k).sections},get showAnswer(){return o()},get plugin(){return h()},get card(){return r()},get sourcePath(){return bi(t)},get animationController(){return bi(w)},get enableAnimations(){return l()}})}},s=e=>{var n=ha(),i=Qt(n),a=e=>{{let t=In(()=>bi(k).metadata.sourcePath||"");m7(e,{get sections(){return bi(k).sections},get showAnswer(){return o()},get plugin(){return h()},get sourcePath(){return bi(t)},get animationController(){return bi(w)},get enableAnimations(){return l()},get card(){return r()},get activeClozeOrdinal(){return p()}})}},s=e=>{var n=ha(),i=Qt(n),a=e=>{A7(e,{get previewData(){return bi(k)},get plugin(){return h()}})},r=e=>{var t=g8(),n=Gt(t),i=Gt(n),a=Gt(i),r=Gt(a);zt(a),zt(i),Ca(Kt(i,2),17,()=>bi(k).sections,_a,(e,t)=>{var n=p8();Aa(Gt(n),()=>bi(t).content),zt(n),pa(e,n)}),zt(n),zt(t),zi(()=>{var e;return va(r,`未知题型: ${null!=(e=bi(k).cardType)?e:""}`)}),pa(e,t)};xa(i,e=>{"multiple-choice"===bi(t)?e(a):e(r,!1)},!0),pa(e,n)};xa(i,e=>{bi(t)===CS.CLOZE_DELETION||"cloze-deletion"===bi(t)?e(a):e(s,!1)},!0),pa(e,n)};xa(i,e=>{bi(t)===CS.BASIC_QA||"basic-qa"===bi(t)?e(a):e(s,!1)},!0),pa(e,n)};xa(i,e=>{bi(t)===CS.SINGLE_CHOICE||bi(t)===CS.MULTIPLE_CHOICE?e(a):e(s,!1)}),pa(e,n)};xa(n,e=>{bi(k)&&e(i)},!0),pa(e,t)};xa(n,e=>{r()?e(a,!1):e(i)},!0),pa(e,t)};xa(n,e=>{bi(x)?e(i):e(a,!1)},!0),pa(e,t)};return xa(N,e=>{bi(S)?e(F):e(B,!1)}),zt(R),kr(R,e=>i=e,()=>i),zi(e=>$=Fa(R,1,"tuanki-preview-container svelte-1ergjlu",null,$,e),[()=>({loading:bi(S),"has-error":!!bi(x)})]),pa(e,R),St(P)}var m8=la('<div><div role="progressbar"><div class="progress-segment mastered svelte-6nz5g3"></div> <div class="progress-segment learning svelte-6nz5g3"></div> <div class="progress-segment new svelte-6nz5g3"></div> <div class="progress-segment review svelte-6nz5g3"></div></div></div>');function y8(e,t){if(new.target)return Er({component:y8,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"deckId",7),s=Ar(t,"dataStorage",7),o=Ar(t,"refreshTrigger",7,0),l=Ar(t,"className",7,""),c=In(n),d=Pn(Ot([])),u=Pn(!1);Ti(()=>{const e=o();if(r()&&s()){(async()=>{try{$n(u,!0);const t=await s().getCardsByDeck(r());$n(d,t,!0),_e.debug("StudyProgressBar - Loaded deck cards:",t.length,"Trigger:",e)}catch(t){_e.error("StudyProgressBar - Failed to load deck cards:",t),$n(d,[],!0)}finally{$n(u,!1)}})()}});let h=In(()=>()=>{const e=bi(d).length;if(0===e)return{newCards:0,learning:0,review:0,mastered:0,total:0};const t=new Date;let n=0,i=0,a=0,r=0;return bi(d).forEach(e=>{if(!e.fsrs)return void n++;const s=e.fsrs,o=new Date(s.due);switch(s.state){case Gr.New:n++;break;case Gr.Learning:case Gr.Relearning:i++;break;case Gr.Review:o<=t?a++:r++;break;default:n++}}),{newCards:n,learning:i,review:a,mastered:r,total:e}}),p=In(()=>()=>{const e=bi(h)(),{newCards:t,learning:n,review:i,mastered:a,total:r}=e;return 0===r?{newCards:0,learning:0,review:0,mastered:0}:{newCards:t/r*100,learning:n/r*100,review:i/r*100,mastered:a/r*100}}),g=In(()=>()=>{const e=bi(h)();return{newCards:bi(c)("studyInterface.progress.newCards").replace("{n}",String(e.newCards)),learning:bi(c)("studyInterface.progress.learning").replace("{n}",String(e.learning)),review:bi(c)("studyInterface.progress.review").replace("{n}",String(e.review)),mastered:bi(c)("studyInterface.progress.mastered").replace("{n}",String(e.mastered)),total:bi(c)("studyInterface.progress.total").replace("{n}",String(e.total))}});var v={get deckId(){return r()},set deckId(e){r(e),hn()},get dataStorage(){return s()},set dataStorage(e){s(e),hn()},get refreshTrigger(){return o()},set refreshTrigger(e=0){o(e),hn()},get className(){return l()},set className(e=""){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},f=m8(),m=Gt(f);let y;var b=Gt(m),w=Kt(b,2),k=Kt(w,2),S=Kt(k,2);zt(m),zt(f),zi((e,t,n,i,a,r,s,o,c,d,u)=>{var h;Fa(f,1,`study-progress-container ${null!=(h=l())?h:""}`,"svelte-6nz5g3"),y=Fa(m,1,"study-progress-bar svelte-6nz5g3",null,y,e),er(m,"title",t),er(m,"aria-label",n),ja(b,`width: ${null!=i?i:""}%`),er(b,"title",a),ja(w,`width: ${null!=r?r:""}%`),er(w,"title",s),ja(k,`width: ${null!=o?o:""}%`),er(k,"title",c),ja(S,`width: ${null!=d?d:""}%`),er(S,"title",u)},[()=>({loading:bi(u)}),()=>bi(g)().total,()=>bi(c)("studyInterface.progress.ariaLabel"),()=>bi(p)().mastered,()=>bi(g)().mastered,()=>bi(p)().learning,()=>bi(g)().learning,()=>bi(p)().newCards,()=>bi(g)().newCards,()=>bi(p)().review,()=>bi(g)().review]),pa(e,f);var x=St(v);return a(),x}var b8=la('<div class="study-header svelte-zetfd6"><div class="header-left svelte-zetfd6"><h2 class="study-title svelte-zetfd6"> </h2> <div class="study-progress svelte-zetfd6"><!> <span class="progress-text svelte-zetfd6"> </span></div></div> <div class="header-right svelte-zetfd6"><!> <!> <!></div></div>');function w8(e,t){if(new.target)return Er({component:w8,...e});kt(t,!0);let n=Ar(t,"currentDeckName",7),i=Ar(t,"currentIndexDisplay",7),a=Ar(t,"cardsLength",7),r=Ar(t,"statsCollapsed",7),s=Ar(t,"showSidebar",7),o=Ar(t,"session",7),l=Ar(t,"dataStorage",7),c=Ar(t,"progressBarRefreshTrigger",7),d=Ar(t,"onToggleStats",7),u=Ar(t,"onToggleSidebar",7),h=Ar(t,"onClose",7);var p={get currentDeckName(){return n()},set currentDeckName(e){n(e),hn()},get currentIndexDisplay(){return i()},set currentIndexDisplay(e){i(e),hn()},get cardsLength(){return a()},set cardsLength(e){a(e),hn()},get statsCollapsed(){return r()},set statsCollapsed(e){r(e),hn()},get showSidebar(){return s()},set showSidebar(e){s(e),hn()},get session(){return o()},set session(e){o(e),hn()},get dataStorage(){return l()},set dataStorage(e){l(e),hn()},get progressBarRefreshTrigger(){return c()},set progressBarRefreshTrigger(e){c(e),hn()},get onToggleStats(){return d()},set onToggleStats(e){d(e),hn()},get onToggleSidebar(){return u()},set onToggleSidebar(e){u(e),hn()},get onClose(){return h()},set onClose(e){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},g=b8(),v=Gt(g),f=Gt(v),m=Gt(f,!0);zt(f);var y=Kt(f,2),b=Gt(y);y8(b,{get deckId(){return o().deckId},get dataStorage(){return l()},get refreshTrigger(){return c()}});var w=Kt(b,2),k=Gt(w);zt(w),zt(y),zt(v);var S=Kt(v,2),x=Gt(S);{let e=In(()=>r()?"展开统计":"收起统计");Hg(x,{variant:"ghost",get onclick(){return d()},get ariaLabel(){return bi(e)},children:(e,t)=>{{let t=In(()=>r()?"chevron-down":"chevron-up");Ng(e,{get name(){return bi(t)},size:"18"})}},$$slots:{default:!0}})}var _=Kt(x,2);{let e=In(()=>s()?"隐藏侧边栏":"显示侧边栏");Hg(_,{variant:"ghost",get onclick(){return u()},get ariaLabel(){return bi(e)},children:(e,t)=>{{let t=In(()=>s()?"sidebar-close":"sidebar-open");Ng(e,{get name(){return bi(t)},size:"18"})}},$$slots:{default:!0}})}return Hg(Kt(_,2),{variant:"ghost",get onclick(){return h()},ariaLabel:"关闭",children:(e,t)=>{Ng(e,{name:"times",size:"18"})},$$slots:{default:!0}}),zt(S),zt(g),zi(()=>{var e,t;va(m,n()||"学习"),va(k,`${null!=(e=i())?e:""} / ${null!=(t=a())?t:""}`)}),pa(e,g),St(p)}function k8(e,t){var n,i;const a={...t};try{a.fields&&(delete a.fields,_e.debug("[CardMarkdownSerializer] 🗑️ 删除继承的 fields 字段（Content-Only 架构）"));const{frontmatter:t,markdownContent:r}=function(e){var t,n;const i=e.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);if(!i)return{frontmatter:{},markdownContent:e};const a=i[1],r=i[2];try{const e={},i=a.split("\n");let s="",o=null,l=!1,c=[];for(const a of i){const i=a.trim();if(!i)continue;const r=((null==(n=null==(t=a.match(/^(\s*)/))?void 0:t[1])?void 0:n.length)||0)>=2;if(i.startsWith("- ")){if(l){const e=i.substring(2).trim().replace(/^["']|["']$/g,"");c.push(e)}}else if(i.includes(":")){const t=i.indexOf(":"),n=i.substring(0,t).trim(),a=i.substring(t+1).trim();if(r){if(o)if(""===a)o[n]="";else{let e=a.replace(/^["']|["']$/g,"");/^\d+$/.test(e)?e=parseInt(e):/^\d+\.\d+$/.test(e)&&(e=parseFloat(e)),o[n]=e}}else if(l&&s&&(e[s]=c,c=[],l=!1),o&&s&&(e[s]=o,o=null),""===a)s=n,l=!0,c=[],o={};else{s=n,l=!1,o=null;let t=a.replace(/^["']|["']$/g,"");/^\d+$/.test(t)?t=parseInt(t):/^\d+\.\d+$/.test(t)&&(t=parseFloat(t)),e[n]=t}}}return l&&s&&c.length>0?e[s]=c:o&&s&&Object.keys(o).length>0&&(e[s]=o),{frontmatter:e,markdownContent:r}}catch(s){return _e.error("[CardMarkdownSerializer] 解析YAML frontmatter失败:",s),{frontmatter:{},markdownContent:e}}}(e);a.content=r.trim(),_e.debug(`[CardMarkdownSerializer] 更新content字段: ${r.length}字符`);const s=function(e){if(!e||!e.trim())return"basic";const t=e.includes("{{c"),n=/==.+?==/s.test(e);return t||n?(_e.debug(`[CardMarkdownSerializer] ✅ 检测到挖空标记 (Anki: ${t}, Markdown: ${n})`),"cloze"):e.includes("---choice---")||/^[A-D][.)、]\s/m.test(e)?(_e.debug("[CardMarkdownSerializer] ✅ 检测到选择题标记"),"multiple"):(_e.debug("[CardMarkdownSerializer] ⚠️ 未检测到特殊标记，返回basic"),"basic")}(r);if("basic"===a.type&&"basic"!==s&&(a.type=s,_e.debug(`[CardMarkdownSerializer] ✅ 自动检测并更新type: basic → ${s}`)),t.tags&&Array.isArray(t.tags)&&(a.tags=t.tags),t.priority&&(a.priority=t.priority),t.tuanki_fsrs&&"object"==typeof t.tuanki_fsrs&&a.fsrs){const e=t.tuanki_fsrs;e.due&&(a.fsrs.due=e.due),void 0!==e.stability&&(a.fsrs.stability=e.stability),void 0!==e.difficulty&&(a.fsrs.difficulty=e.difficulty),void 0!==e.state&&(a.fsrs.state=e.state),void 0!==e.reps&&(a.fsrs.reps=e.reps),void 0!==e.lapses&&(a.fsrs.lapses=e.lapses),void 0!==e.elapsed_days&&(a.fsrs.elapsedDays=e.elapsed_days),void 0!==e.scheduled_days&&(a.fsrs.scheduledDays=e.scheduled_days),e.last_review&&(a.fsrs.lastReview=e.last_review)}if(t.tuanki_source&&"object"==typeof t.tuanki_source){const e=t.tuanki_source;e.block_link&&(a.sourceBlock=e.block_link),e.file_path&&(a.sourceFile=e.file_path)}(function(e){switch(e){case"cloze":return new wh;case"multiple":return new yh;default:new mh}})(s);_e.debug("[markdownToCard] Content-Only 架构：使用 content 作为唯一数据源"),a.content=r,a.modified=(new Date).toISOString(),_e.debug("[CardMarkdownSerializer] 卡片数据解析完成（Content-Only）:",{cardId:a.uuid,contentLength:(null==(n=a.content)?void 0:n.length)||0,tagsCount:(null==(i=a.tags)?void 0:i.length)||0});const o=ep.extractTagsExcludingCode(r);return o.length>0&&(a.tags=ep.mergeTags(r,a.tags||[],"smart"),_e.debug("[CardMarkdownSerializer] 自动提取标签:",o)),a}catch(r){return _e.error("[CardMarkdownSerializer] 解析Markdown内容失败:",r),t}}var S8=e=>{},x8=(e,t)=>{const n=document.querySelector(".plain-text-editor");n&&t(n.value)},_8=la('<div class="plain-editor-container svelte-ql92t4"><textarea class="plain-text-editor svelte-ql92t4" placeholder="在此编辑卡片内容..."></textarea> <div class="plain-editor-actions svelte-ql92t4"><button class="btn-secondary svelte-ql92t4">取消</button> <button class="btn-primary svelte-ql92t4">保存</button></div></div>'),C8=la("<div><!></div>");function I8(e,t){if(new.target)return Er({component:I8,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"realCardId",7),a=Ar(t,"showEditModal",7),r=Ar(t,"tempFileUnavailable",7),s=Ar(t,"isClozeMode",7),o=Ar(t,"editorPoolManager",7),l=Ar(t,"dataStorage",7),c=Ar(t,"modalRef",7),d=Ar(t,"statsCollapsed",7),u=Ar(t,"onEditComplete",7),h=Ar(t,"onEditCancel",7),p=Ar(t,"onToggleCloze",7),g=Pn(null),v=Pn(!1),f=Pn(null);async function m(){if(n()&&o())try{const e=o().studySessionCardId;await yi();const t=bi(g);if(!t)return _e.error("[CardEditorContainer] 编辑器容器未找到"),void h()();if(bi(v)){_e.debug("[CardEditorContainer]"," 复用编辑器实例，更新卡片内容:",n().uuid),o().setCurrentEditingCard(n().uuid);const i=await o().updateSessionContent(e,n().content,t);if(!i.success)return _e.error("[CardEditorContainer] 更新编辑器内容失败:",i.error),void new window.Notice("更新编辑器内容失败");_e.debug("[CardEditorContainer]"," ✅ 编辑器内容已更新")}else{_e.debug("[CardEditorContainer]"," 首次创建编辑器实例"),t.innerHTML="";const i=await o().createEditorSession(n(),{isStudySession:!0,sessionId:e});if(!i.success)return _e.error("Failed to create editor session:",i.error),h()(),void new window.Notice("编辑器会话创建失败");const a=await o().createEmbeddedEditor(t,e,y,b);if(!a.success)return _e.error("Failed to create embedded editor:",a.error),h()(),void new window.Notice("编辑器创建失败");$n(f,a.cleanup||null,!0),o().setCurrentEditingCard(n().uuid),$n(v,!0),_e.debug("[CardEditorContainer]"," ✅ 编辑器创建成功")}_e.debug("[CardEditorContainer]"," 编辑模式启动成功，当前卡片:",n().uuid),setTimeout(()=>{!function(){const e=function(){if(!c())return 400;const e=c().getBoundingClientRect(),t=c().querySelector(".study-header"),n=c().querySelector(".study-footer"),i=c().querySelector(".stats-cards");let r=0;t&&(r+=t.offsetHeight);n&&!a()&&(r+=n.offsetHeight);i&&!d()&&(r+=i.offsetHeight);const s=a()?48:80;return Math.max(400,e.height-r-s)}(),t=bi(g);if(t&&a()){if(!t.querySelector(".cm-editor"))return;const n=Math.max(400,e);t.style.height=`${n}px`,t.style.maxHeight="none"}}()},50)}catch(e){_e.error("[CardEditorContainer] 进入编辑模式失败:",e),h()(),new window.Notice("进入编辑模式失败")}else _e.error("Cannot enter edit mode: missing card or editorPoolManager")}function y(e){_e.debug("[CardEditorContainer]","Editor save callback triggered")}async function b(){if(_e.debug("[CardEditorContainer]","Editor cancel callback triggered"),o()){if(bi(v)){const e=o().studySessionCardId,t=bi(g);if(t){(await o().updateSessionContent(e,"",t)).success&&_e.debug("[CardEditorContainer]"," ✅ 编辑器内容已清空（取消编辑）")}}h()()}else h()()}async function w(e){if(n())try{const t=k8(e,n());await l().saveCard(t),_e.debug("[CardEditorContainer]","Plain editor: Card saved successfully:",t.uuid),new window.Notice("卡片已保存"),await Promise.resolve(u()(t))}catch(t){_e.error("Failed to save card from plain editor:",t);const e=t instanceof Error?t.message:String(t);new window.Notice("保存失败: "+e)}}Ti(()=>{a()&&n()&&o()&&!r()&&m()}),Ti(()=>{if(a()&&n()&&o()&&bi(v)&&!r()){const e=o().studySessionCardId,t=bi(g);t&&(o().setCurrentEditingCard(n().uuid),o().updateSessionContent(e,n().content,t))}}),Ti(()=>()=>{bi(f)&&(bi(f)(),$n(f,null))});var k={get card(){return n()},set card(e){n(e),hn()},get realCardId(){return i()},set realCardId(e){i(e),hn()},get showEditModal(){return a()},set showEditModal(e){a(e),hn()},get tempFileUnavailable(){return r()},set tempFileUnavailable(e){r(e),hn()},get isClozeMode(){return s()},set isClozeMode(e){s(e),hn()},get editorPoolManager(){return o()},set editorPoolManager(e){o(e),hn()},get dataStorage(){return l()},set dataStorage(e){l(e),hn()},get modalRef(){return c()},set modalRef(e){c(e),hn()},get statsCollapsed(){return d()},set statsCollapsed(e){d(e),hn()},get onEditComplete(){return u()},set onEditComplete(e){u(e),hn()},get onEditCancel(){return h()},set onEditCancel(e){h(e),hn()},get onToggleCloze(){return p()},set onToggleCloze(e){p(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},S=ha(),x=Qt(S),_=e=>{var t=C8();let i;var a=Gt(t),o=e=>{var t=_8(),i=Gt(t);jn(i),i.__input=[S8];var a=Kt(i,2),r=Gt(a);r.__click=b,Kt(r,2).__click=[x8,w],zt(a),zt(t),zi(e=>Ya(i,e),[()=>n()?function(e){var t;const n=[];return n.push("---"),n.push(`tuanki_uuid: "${e.uuid}"`),n.push(`tuanki_deck_id: "${e.deckId}"`),e.templateId&&n.push(`tuanki_template_id: "${e.templateId}"`),n.push(`created: "${e.created}"`),n.push(`modified: "${e.modified}"`),e.tags&&e.tags.length>0&&(n.push("tags:"),e.tags.forEach(e=>{n.push(`  - "${e}"`)})),e.fsrs&&(n.push("tuanki_fsrs:"),n.push(`  due: "${e.fsrs.due}"`),n.push(`  stability: ${e.fsrs.stability}`),n.push(`  difficulty: ${e.fsrs.difficulty}`),n.push(`  state: ${e.fsrs.state}`),n.push(`  reps: ${e.fsrs.reps}`),n.push(`  lapses: ${e.fsrs.lapses}`),n.push(`  elapsed_days: ${e.fsrs.elapsedDays}`),n.push(`  scheduled_days: ${e.fsrs.scheduledDays}`),e.fsrs.lastReview&&n.push(`  last_review: "${e.fsrs.lastReview}"`)),e.priority&&n.push(`priority: ${e.priority}`),(e.sourceBlock||e.sourceFile)&&(n.push("tuanki_source:"),e.sourceBlock&&n.push(`  block_link: "${e.sourceBlock}"`),e.sourceFile&&n.push(`  file_path: "${e.sourceFile}"`)),n.push("---"),n.push(""),(null==(t=e.content)?void 0:t.trim())?(_e.debug(`[CardMarkdownSerializer] 使用 content 生成 Markdown (${e.content.length}字符)`),n.push(e.content.trim())):(_e.warn("[CardMarkdownSerializer] content 为空！卡片数据异常:",e.uuid),n.push("")),n.join("\n")}(n()):""]),pa(e,t)};xa(a,e=>{r()&&e(o)}),zt(t),kr(t,e=>$n(g,e),()=>bi(g)),zi(e=>i=Fa(t,1,"inline-editor-container svelte-ql92t4",null,i,e),[()=>({"cloze-deletion-mode":s()})]),pa(e,t)};return xa(x,e=>{a()&&e(_)}),pa(e,S),St(k)}ia(["input","click"]);class D8{static getBuiltinSystemPrompt(e){const{cardCount:t,difficulty:n,typeDistribution:i}=e;let a='生成**恰好{cardCount}张**学习卡片（不多不少），难度：{difficulty}\n\n类型分布：QA {qaPercent}%、Cloze {clozePercent}%、Choice {choicePercent}%\n\n返回JSON数组，**必须包含且仅包含{cardCount}个卡片对象**。\n\n## 卡片格式示例\n\n### [1] 问答题（QA）\n{\n  "type": "qa",\n  "content": "间隔重复学习的核心原理是什么？\\n\\n---div---\\n\\n在即将遗忘时复习，利用遗忘曲线规律。\\n\\n通过间隔重复，记忆会更加牢固。"\n}\n\n【注意】使用 content 字段，通过 ---div--- 分隔问题和答案。问题和答案不需要 Q: 和 A: 前缀。\n\n### [2] 挖空题（Cloze）\n{\n  "type": "cloze",\n  "content": "FSRS算法通过计算卡片的==稳定性==和==难度==两个核心参数，来预测最佳复习时间。\\n\\n---div---\\n\\n稳定性反映记忆的保持程度，难度反映内容的记忆难易程度。"\n}\n\n【注意】优先使用 ==文本== 标记挖空内容（这是插件的默认格式），也支持 {{c1::文本}} Anki格式。通过 ---div--- 分隔主内容和解析说明。\n\n### [3] 选择题（Choice）\n\n单选题：\n{\n  "type": "choice",\n  "content": "Q: 间隔重复学习的核心原理是什么？\\n\\nA) 每天固定时间复习\\nB) 在即将遗忘时复习{✓}\\nC) 随机复习\\nD) 只复习难题\\n\\n---div---\\n\\n间隔重复利用遗忘曲线规律，在即将遗忘时进行复习，使记忆更牢固且学习效率更高。"\n}\n\n多选题：\n{\n  "type": "choice",\n  "content": "Q: 以下哪些是FSRS算法的核心参数？\\n\\nA) Stability{✓}\\nB) Difficulty{✓}\\nC) Speed\\nD) Accuracy\\n\\n---div---\\n\\nFSRS算法主要通过Stability（稳定性）和Difficulty（难度）两个参数来预测最佳复习时间。"\n}\n\n【注意】选择题使用 Q: 前缀，正确答案标记 {✓}（紧跟选项，无空格）。通过 ---div--- 分隔题目和解析。\n\n## 格式要求：\n\n### 问答题（QA）：\n- 使用 content 字段存储完整内容\n- 格式：问题内容\\n\\n---div---\\n\\n答案内容\n- 不需要 Q: 和 A: 前缀\n\n### 挖空题（Cloze）：\n- 使用 content 字段存储完整内容\n- 挖空标记：==文本==（推荐，插件默认格式）或 {{c1::文本}}（Anki兼容格式）\n- 格式：挖空内容\\n\\n---div---\\n\\n解析说明（可选）\n- 【重要】优先使用 ==文本== 标记（高亮Markdown格式），也支持 {{c1::文本}}\n\n### 选择题（Choice）：\n- 使用 content 字段存储完整内容\n- 格式：Q: 题目\\n\\n选项列表\\n\\n---div---\\n\\n详细解析\n- 选项格式：A)、B)、C)、D)（使用圆括号）\n- 正确答案标记：{✓} 紧跟在选项后，无空格\n- 多选题：所有正确选项都添加 {✓}\n\n## 约束规则：\n\n1. **卡片数量**：严格生成{cardCount}张，不多不少\n2. **分隔符**：必须使用 ---div--- 分隔正面和背面内容\n3. **挖空标记**：优先使用 ==文本== 格式（插件默认），也支持 {{c1::文本}} (Anki兼容)\n4. **选择题标记**：正确答案必须有 {✓} 标记，紧跟选项无空格\n5. **换行符**：使用 \\n\\n 分隔段落，\\n 分隔单行\n6. **统一字段**：所有题型都使用 content 字段，不要使用 front 和 back\n\n【重要】\n- 所有卡片必须使用 content 字段\n- 必须使用 ---div--- 作为分隔符\n- 挖空题优先使用 ==文本== 标记（插件默认），也支持 {{c1::文本}} (Anki格式)\n- 选择题的 {✓} 标记紧跟选项，无空格';return a=a.replace(/{cardCount}/g,String(t)),a=a.replace(/{difficulty}/g,n),a=a.replace(/{qaPercent}/g,String(i.qa)),a=a.replace(/{clozePercent}/g,String(i.cloze)),a=a.replace(/{choicePercent}/g,String(i.choice)),a}static buildSystemPrompt(e,t){if(!t)return this.getBuiltinSystemPrompt(e);if(t.selectedSystemPromptId&&t.customSystemPrompts){const n=t.customSystemPrompts.find(e=>e.id===t.selectedSystemPromptId);if(n)return this.replaceVariables(n.content,e)}return!t.useBuiltin&&t.customPrompt?this.replaceVariables(t.customPrompt,e):this.getBuiltinSystemPrompt(e)}static buildUserPrompt(e,t){return`${t||"基于以下材料生成学习卡片"}\n\n${e}`}static buildFullPrompt(e,t,n,i){const a=this.buildSystemPrompt(t,i),r=this.buildUserPrompt(e,n);return{systemPrompt:a,userPrompt:r,fullText:`=== System Prompt ===\n${a}\n\n=== User Prompt ===\n${r}\n\n=== Content ===\n${e}`}}static replaceVariables(e,t){let n=e;const i={cardCount:t.cardCount,count:t.cardCount,difficulty:t.difficulty,template:t.templateId,qaPercent:t.typeDistribution.qa,clozePercent:t.typeDistribution.cloze,choicePercent:t.typeDistribution.choice};for(const[a,r]of Object.entries(i)){const e=new RegExp(`\\{${a}\\}`,"g");n=n.replace(e,String(r))}return n}static loadTemplates(e){const t=e.templates;return t?{qa:xf.find(e=>e.id===t.qa),choice:xf.find(e=>e.id===t.choice),cloze:xf.find(e=>e.id===t.cloze)}:{}}}class T8{constructor(e,t,n,i){oe(this,"apiKey"),oe(this,"model"),oe(this,"baseUrl"),oe(this,"systemPromptConfig"),this.apiKey=e,this.model=t,this.systemPromptConfig=i,n&&(this.baseUrl=n)}loadTemplates(e){const t=e.templates;return t?{qa:xf.find(e=>e.id===t.qa),choice:xf.find(e=>e.id===t.choice),cloze:xf.find(e=>e.id===t.cloze)}:{}}buildSystemPrompt(e){return D8.buildSystemPrompt(e,this.systemPromptConfig)}buildUserPrompt(e,t){return D8.buildUserPrompt(e,t)}parseResponse(e){try{const t=e.match(/\[[\s\S]*\]/);return t?JSON.parse(t[0]):JSON.parse(e)}catch(t){throw _e.error("Failed to parse AI response:",t),new Error("AI返回的内容格式不正确")}}generateCardId(){return`ai-card-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}estimateCost(e,t){return e/1e3*.03+t/1e3*.06}handleError(e){var t,n;_e.error("AI Service Error:",e);let i="AI服务调用失败";return e.message?i=e.message:(null==(n=null==(t=e.response)?void 0:t.data)?void 0:n.error)?i=e.response.data.error.message||i:401===e.status?i="API密钥无效或已过期":429===e.status?i="API调用频率超限，请稍后再试":500===e.status&&(i="AI服务暂时不可用"),{success:!1,error:i}}}class M8 extends T8{constructor(e,t,n,i){super(e,t,n,i),oe(this,"baseUrl","https://api.openai.com/v1"),n&&(this.baseUrl=n)}async generateCards(e,t,n){try{null==n||n({status:"preparing",progress:15,message:"准备生成卡片..."});const i=this.buildSystemPrompt(t),a=this.buildUserPrompt(e,t.promptTemplate);null==n||n({status:"generating",progress:25,message:"正在调用AI服务..."});const r=setInterval(()=>{if(n){const e=Math.min(85,25+5*Math.random());n({status:"generating",progress:e,message:`AI正在思考...（${t.cardCount}张卡片）`})}},500),s=await ge.requestUrl({url:`${this.baseUrl}/chat/completions`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:[{role:"system",content:i},{role:"user",content:a}],temperature:t.temperature,max_tokens:t.maxTokens,response_format:{type:"json_object"}})});clearInterval(r),null==n||n({status:"parsing",progress:90,message:"解析生成结果..."});const o=s.json,l=o.choices[0].message.content,c=this.parseResponse(l).map(e=>{let n;if(e.content)n=this.ensureString(e.content);else if(e.front||e.back){const t=this.ensureString(e.front),i=this.ensureString(e.back);n=i?`${t}\n\n---div---\n\n${i}`:t}else n="";return{uuid:Vu(),type:e.type||"qa",content:n,front:e.front?this.ensureString(e.front):void 0,back:e.back?this.ensureString(e.back):void 0,choices:e.choices,correctAnswer:e.correctAnswer,clozeText:e.clozeText,tags:e.tags||[],images:e.images||[],explanation:e.explanation,metadata:{generatedAt:(new Date).toISOString(),provider:"openai",model:this.model,temperature:t.temperature}}});return null==n||n({status:"completed",progress:100,message:`成功生成${c.length}张卡片`}),{success:!0,cards:c,usage:{promptTokens:o.usage.prompt_tokens,completionTokens:o.usage.completion_tokens,totalTokens:o.usage.total_tokens,estimatedCost:this.estimateCost(o.usage.prompt_tokens,o.usage.completion_tokens)}}}catch(i){return null==n||n({status:"failed",progress:0,message:"生成失败"}),this.handleError(i)}}async regenerateCard(e,t){try{const n=`你是一个专业的学习卡片生成助手。现在需要根据用户的修改要求，重新生成一张卡片。\n\n原始卡片信息：\n类型：${e.originalCard.type}\n内容：${e.originalCard.content||`${e.originalCard.front}\n\n---div---\n\n${e.originalCard.back}`}\n\n请根据用户的修改要求生成新卡片，保持与原卡片相同的格式。使用 content 字段，通过 ---div--- 分隔正反面。以JSON格式返回。`,i=(await ge.requestUrl({url:`${this.baseUrl}/chat/completions`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:[{role:"system",content:n},{role:"user",content:e.instruction}],temperature:t.temperature,max_tokens:t.maxTokens,response_format:{type:"json_object"}})})).json,a=i.choices[0].message.content,r=this.parseResponse(a);if(0===r.length)throw new Error("未能生成新卡片");const s=r[0];let o;if(s.content)o=this.ensureString(s.content);else if(s.front||s.back){const e=this.ensureString(s.front),t=this.ensureString(s.back);o=t?`${e}\n\n---div---\n\n${t}`:e}else o="";return{success:!0,cards:[{uuid:e.cardId,type:s.type||e.originalCard.type,content:o,front:s.front?this.ensureString(s.front):void 0,back:s.back?this.ensureString(s.back):void 0,choices:s.choices,correctAnswer:s.correctAnswer,clozeText:s.clozeText,tags:s.tags||[],images:s.images||[],explanation:s.explanation,metadata:{generatedAt:(new Date).toISOString(),provider:"openai",model:this.model,temperature:t.temperature}}],usage:{promptTokens:i.usage.prompt_tokens,completionTokens:i.usage.completion_tokens,totalTokens:i.usage.total_tokens,estimatedCost:this.estimateCost(i.usage.prompt_tokens,i.usage.completion_tokens)}}}catch(n){return this.handleError(n)}}async splitParentCard(e){try{const t='你是一个专业的学习卡片拆分助手，遵循"最小信息原则"。\n\n你的任务是将一张包含多个知识点的父卡片拆分为多张独立的子卡片。每张子卡片应该只包含一个清晰的知识点。\n\n拆分原则：\n1. 每张子卡片只包含一个核心概念或知识点\n2. 保持子卡片的独立性和完整性\n3. 子卡片应该可以独立复习和理解\n4. 保留必要的上下文，但避免重复信息\n5. 保持原有的格式风格和表达方式\n\n输出格式（JSON）：\n{\n  "cards": [\n    {\n      "front": "问题或提示",\n      "back": "答案或解释",\n      "tags": ["可选标签"],\n      "explanation": "可选的额外说明"\n    }\n  ]\n}\n\n'+(e.targetCount?`请生成约${e.targetCount}张子卡片。`:"请根据内容自动决定合适的子卡片数量（建议2-5张）。"),n=`请将以下卡片拆分为多张子卡片：\n\n【卡片正面】\n${e.content.front}\n\n【卡片背面】\n${e.content.back}\n\n${e.instruction?`\n【额外要求】\n${e.instruction}`:""}\n\n请按照JSON格式输出拆分后的子卡片。`,i=(await ge.requestUrl({url:`${this.baseUrl}/chat/completions`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:[{role:"system",content:t},{role:"user",content:n}],temperature:.7,max_tokens:3e3,response_format:{type:"json_object"}})})).json,a=i.choices[0].message.content,r=JSON.parse(a).cards||[];if(!Array.isArray(r)||0===r.length)throw new Error("AI未能生成有效的子卡片");return{success:!0,childCards:r.map(e=>({front:this.ensureString(e.front),back:this.ensureString(e.back),tags:Array.isArray(e.tags)?e.tags:[],explanation:e.explanation?this.ensureString(e.explanation):void 0})),usage:{promptTokens:i.usage.prompt_tokens,completionTokens:i.usage.completion_tokens,totalTokens:i.usage.total_tokens,estimatedCost:this.estimateCost(i.usage.prompt_tokens,i.usage.completion_tokens)}}}catch(t){return _e.error("OpenAI splitParentCard error:",t),{success:!1,error:t instanceof Error?t.message:"拆分卡片失败"}}}async testConnection(){try{return 200===(await ge.requestUrl({url:`${this.baseUrl}/models`,method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`}})).status}catch(e){return _e.error("OpenAI connection test failed:",e),!1}}async chat(e){var t,n,i,a,r,s,o,l;try{const c=(await ge.requestUrl({url:`${this.baseUrl}/chat/completions`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:e.messages,temperature:null!=(t=e.temperature)?t:.7,max_tokens:null!=(n=e.maxTokens)?n:2e3})})).json,d=null==(r=null==(a=null==(i=c.choices)?void 0:i[0])?void 0:a.message)?void 0:r.content;if(!d)throw new Error("OpenAI未返回有效内容");return{success:!0,content:d.trim(),model:this.model,tokensUsed:null==(s=c.usage)?void 0:s.total_tokens,cost:this.estimateCost((null==(o=c.usage)?void 0:o.prompt_tokens)||0,(null==(l=c.usage)?void 0:l.completion_tokens)||0)}}catch(c){return _e.error("OpenAI chat error:",c),{success:!1,error:c instanceof Error?c.message:"OpenAI调用失败"}}}ensureString(e){if(null==e)return"";if("string"==typeof e)return e;if("object"==typeof e){_e.warn("AI返回了非字符串类型的卡片内容:",e);try{return JSON.stringify(e)}catch(t){return String(e)}}return String(e)}}class A8 extends M8{constructor(e,t,n,i){super(e,t,n,i),this.baseUrl=n||"https://open.bigmodel.cn/api/paas/v4"}estimateCost(e,t){return 0}async testConnection(){try{return 200===(await ge.requestUrl({url:`${this.baseUrl}/chat/completions`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:[{role:"user",content:"hi"}],max_tokens:5})})).status}catch(e){return _e.error("Zhipu AI connection test failed:",e),!1}}handleError(e){var t,n;_e.error("Zhipu AI Service Error:",e);let i="AI服务调用失败";return e.message?i=e.message:(null==(n=null==(t=e.response)?void 0:t.data)?void 0:n.error)?i=e.response.data.error.message||i:401===e.status?i="API密钥无效或已过期，请检查智谱AI配置":429===e.status?i="免费额度已用完，请稍后再试或升级套餐":500===e.status?i="智谱AI服务暂时不可用，请稍后重试":"ECONNREFUSED"===e.code&&(i="无法连接到智谱AI服务器，请检查网络连接"),"QUOTA_EXCEEDED"===e.code&&(i="今日免费额度已用完，明日自动重置"),{success:!1,error:i}}}class E8 extends M8{constructor(e,t,n,i){super(e,t,n,i),oe(this,"baseUrl","https://api.deepseek.com"),n&&(this.baseUrl=n)}estimateCost(e,t){return e/1e6*1+t/1e6*2}async testConnection(){try{const{requestUrl:e}=await import("obsidian");return 200===(await e({url:`${this.baseUrl}/models`,method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`}})).status}catch(e){return _e.error("DeepSeek connection test failed:",e),!1}}handleError(e){_e.error("DeepSeek API Error:",e);let t="DeepSeek API调用失败";return e.message&&(t=e.message.includes("401")||e.message.includes("Unauthorized")?"DeepSeek API密钥无效，请检查配置":e.message.includes("429")||e.message.includes("rate limit")?"DeepSeek API请求频率超限，请稍后重试":e.message.includes("quota")?"DeepSeek API配额不足":e.message.includes("timeout")?"DeepSeek API请求超时":`DeepSeek API错误: ${e.message}`),{success:!1,error:t,cards:[]}}}class z8 extends T8{constructor(e,t,n,i){super(e,t,n,i),oe(this,"baseUrl","https://generativelanguage.googleapis.com/v1beta"),n&&(this.baseUrl=n)}async generateCards(e,t,n){var i,a,r,s,o;try{null==n||n({status:"preparing",progress:10,message:"准备生成卡片..."});const l=this.buildSystemPrompt(t),c=this.buildUserPrompt(e,t.promptTemplate);null==n||n({status:"generating",progress:25,message:"正在调用Gemini服务..."});const{requestUrl:d}=await import("obsidian"),u=await d({url:`${this.baseUrl}/models/${this.model}:generateContent?key=${this.apiKey}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`${l}\n\n${c}`}]}],generationConfig:{temperature:t.temperature,maxOutputTokens:t.maxTokens,responseMimeType:"application/json"}})});null==n||n({status:"parsing",progress:90,message:"解析生成结果..."});const h=u.json;if(!h.candidates||0===h.candidates.length)throw new Error("Gemini未返回有效内容");const p=h.candidates[0].content.parts[0].text,g=this.parseResponse(p).map(e=>{let n;if(e.content)n=this.ensureString(e.content);else if(e.front||e.back){const t=this.ensureString(e.front),i=this.ensureString(e.back);n=i?`${t}\n\n---div---\n\n${i}`:t}else n="";return{id:this.generateCardId(),type:e.type||"qa",content:n,front:e.front?this.ensureString(e.front):void 0,back:e.back?this.ensureString(e.back):void 0,choices:e.choices,correctAnswer:e.correctAnswer,clozeText:e.clozeText,tags:e.tags||[],images:e.images||[],explanation:e.explanation,metadata:{generatedAt:(new Date).toISOString(),provider:"gemini",model:this.model,temperature:t.temperature}}});return null==n||n({status:"completed",progress:100,message:`成功生成${g.length}张卡片`}),{success:!0,cards:g,usage:{promptTokens:(null==(i=h.usageMetadata)?void 0:i.promptTokenCount)||0,completionTokens:(null==(a=h.usageMetadata)?void 0:a.candidatesTokenCount)||0,totalTokens:(null==(r=h.usageMetadata)?void 0:r.totalTokenCount)||0},cost:this.estimateCost((null==(s=h.usageMetadata)?void 0:s.promptTokenCount)||0,(null==(o=h.usageMetadata)?void 0:o.candidatesTokenCount)||0)}}catch(l){return this.handleError(l)}}estimateCost(e,t){return e/1e3*25e-5+t/1e3*5e-4}async testConnection(){try{const{requestUrl:e}=await import("obsidian");return 200===(await e({url:`${this.baseUrl}/models?key=${this.apiKey}`,method:"GET"})).status}catch(e){return _e.error("Gemini connection test failed:",e),!1}}async chat(e){var t,n,i,a,r,s,o;try{const{requestUrl:l}=await import("obsidian"),c=e.messages.filter(e=>"system"!==e.role).map(e=>({role:"assistant"===e.role?"model":"user",parts:[{text:e.content}]})),d=e.messages.find(e=>"system"===e.role);d&&c.length>0&&"user"===c[0].role&&(c[0].parts[0].text=`${d.content}\n\n${c[0].parts[0].text}`);const u=await l({url:`${this.baseUrl}/models/${this.model}:generateContent?key=${this.apiKey}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:c,generationConfig:{temperature:null!=(t=e.temperature)?t:.7,maxOutputTokens:null!=(n=e.maxTokens)?n:2e3}})}),h=null==(o=null==(s=null==(r=null==(a=null==(i=u.json.candidates)?void 0:i[0])?void 0:a.content)?void 0:r.parts)?void 0:s[0])?void 0:o.text;if(!h)throw new Error("Gemini未返回有效内容");return{success:!0,content:h.trim(),model:this.model}}catch(l){return _e.error("Gemini chat error:",l),{success:!1,error:l instanceof Error?l.message:"Gemini调用失败"}}}handleError(e){_e.error("Gemini API Error:",e);let t="Gemini API调用失败";return e.message&&(t=e.message.includes("API_KEY_INVALID")||e.message.includes("401")?"Gemini API密钥无效，请检查配置":e.message.includes("QUOTA_EXCEEDED")||e.message.includes("429")?"Gemini API配额超限，请稍后重试":e.message.includes("SAFETY")?"Gemini安全过滤器触发，请调整内容":e.message.includes("timeout")?"Gemini API请求超时":`Gemini API错误: ${e.message}`),{success:!1,error:t,cards:[]}}generateCardId(){return`gemini-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}ensureString(e){if(null==e)return"";if("string"==typeof e)return e;if("object"==typeof e){_e.warn("Gemini返回了非字符串类型的卡片内容:",e);try{return JSON.stringify(e)}catch(t){return String(e)}}return String(e)}}class P8 extends T8{constructor(e,t,n,i){super(e,t,n,i),oe(this,"baseUrl","https://api.anthropic.com/v1"),n&&(this.baseUrl=n)}async generateCards(e,t,n){var i,a,r,s,o,l;try{null==n||n({status:"preparing",progress:10,message:"准备生成卡片..."});const c=this.buildSystemPrompt(t),d=this.buildUserPrompt(e,t.promptTemplate);null==n||n({status:"generating",progress:25,message:"正在调用Claude服务..."});const{requestUrl:u}=await import("obsidian"),h=await u({url:`${this.baseUrl}/messages`,method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:this.model,max_tokens:t.maxTokens,temperature:t.temperature,system:c,messages:[{role:"user",content:d}]})});null==n||n({status:"parsing",progress:90,message:"解析生成结果..."});const p=h.json;if(!p.content||0===p.content.length)throw new Error("Claude未返回有效内容");const g=p.content[0].text,v=this.parseResponse(g).map(e=>{let n;if(e.content)n=this.ensureString(e.content);else if(e.front||e.back){const t=this.ensureString(e.front),i=this.ensureString(e.back);n=i?`${t}\n\n---div---\n\n${i}`:t}else n="";return{id:this.generateCardId(),type:e.type||"qa",content:n,front:e.front?this.ensureString(e.front):void 0,back:e.back?this.ensureString(e.back):void 0,choices:e.choices,correctAnswer:e.correctAnswer,clozeText:e.clozeText,tags:e.tags||[],images:e.images||[],explanation:e.explanation,metadata:{generatedAt:(new Date).toISOString(),provider:"anthropic",model:this.model,temperature:t.temperature}}});return null==n||n({status:"completed",progress:100,message:`成功生成${v.length}张卡片`}),{success:!0,cards:v,usage:{promptTokens:(null==(i=p.usage)?void 0:i.input_tokens)||0,completionTokens:(null==(a=p.usage)?void 0:a.output_tokens)||0,totalTokens:((null==(r=p.usage)?void 0:r.input_tokens)||0)+((null==(s=p.usage)?void 0:s.output_tokens)||0)},cost:this.estimateCost((null==(o=p.usage)?void 0:o.input_tokens)||0,(null==(l=p.usage)?void 0:l.output_tokens)||0)}}catch(c){return this.handleError(c)}}estimateCost(e,t){let n=3,i=15;this.model.includes("opus")&&(n=15,i=75);return e/1e6*n+t/1e6*i}async testConnection(){try{const{requestUrl:e}=await import("obsidian");return 200===(await e({url:`${this.baseUrl}/messages`,method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:this.model,max_tokens:10,messages:[{role:"user",content:"test"}]})})).status}catch(e){return _e.error("Anthropic connection test failed:",e),!1}}async chat(e){var t,n,i,a,r,s;try{const{requestUrl:o}=await import("obsidian"),l=e.messages.find(e=>"system"===e.role),c=e.messages.filter(e=>"system"!==e.role),d=(await o({url:`${this.baseUrl}/messages`,method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:this.model,messages:c,system:null==l?void 0:l.content,temperature:null!=(t=e.temperature)?t:.7,max_tokens:null!=(n=e.maxTokens)?n:2e3})})).json,u=null==(a=null==(i=d.content)?void 0:i[0])?void 0:a.text;if(!u)throw new Error("Claude未返回有效内容");return{success:!0,content:u.trim(),model:this.model,tokensUsed:((null==(r=d.usage)?void 0:r.input_tokens)||0)+((null==(s=d.usage)?void 0:s.output_tokens)||0)}}catch(o){return _e.error("Anthropic chat error:",o),{success:!1,error:o instanceof Error?o.message:"Claude调用失败"}}}handleError(e){_e.error("Anthropic API Error:",e);let t="Claude API调用失败";return e.message&&(t=e.message.includes("authentication")||e.message.includes("401")?"Claude API密钥无效，请检查配置":e.message.includes("rate_limit")||e.message.includes("429")?"Claude API请求频率超限，请稍后重试":e.message.includes("overloaded")||e.message.includes("529")?"Claude服务器过载，请稍后重试":e.message.includes("timeout")?"Claude API请求超时":`Claude API错误: ${e.message}`),{success:!1,error:t,cards:[]}}generateCardId(){return`claude-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}ensureString(e){if(null==e)return"";if("string"==typeof e)return e;if("object"==typeof e){_e.warn("Claude返回了非字符串类型的卡片内容:",e);try{return JSON.stringify(e)}catch(t){return String(e)}}return String(e)}}class R8 extends M8{constructor(e,t,n,i){super(e,t,n,i),oe(this,"baseUrl","https://api.siliconflow.cn/v1"),n&&(this.baseUrl=n)}estimateCost(e,t){return e/1e3*5e-4+t/1e3*.001}async testConnection(){try{return 200===(await ge.requestUrl({url:`${this.baseUrl}/models`,method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`}})).status}catch(e){return _e.error("SiliconFlow connection test failed:",e),!1}}handleError(e){_e.error("SiliconFlow API Error:",e);let t="硅基流动API调用失败";if(e.message)t=e.message.includes("401")||e.message.includes("Unauthorized")?"硅基流动API密钥无效，请在设置中检查配置":e.message.includes("429")||e.message.includes("rate limit")?"硅基流动API请求频率超限，请稍后重试":e.message.includes("quota")||e.message.includes("insufficient")?"硅基流动API配额不足，请检查账户余额":e.message.includes("timeout")?"硅基流动API请求超时，请检查网络连接":e.message.includes("model")&&e.message.includes("not found")?"所选模型不可用，请在设置中选择其他模型":`硅基流动API错误: ${e.message}`;else if(e.status)switch(e.status){case 401:t="硅基流动API密钥无效或已过期";break;case 403:t="硅基流动API访问被拒绝，请检查权限";break;case 429:t="硅基流动API请求过于频繁，请稍后再试";break;case 500:t="硅基流动服务器错误，请稍后重试";break;case 503:t="硅基流动服务暂时不可用，请稍后重试";break;default:t=`硅基流动API错误 (状态码: ${e.status})`}else"ECONNREFUSED"===e.code&&(t="无法连接到硅基流动服务器，请检查网络连接");return{success:!1,error:t,cards:[]}}}class $8{static createService(e,t,n){const i=t.settings.aiConfig;if(!i)throw new Error("AI配置未初始化");const a=i.apiKeys[e];if(!a||!a.apiKey)throw new Error(`${e} API密钥未配置`);const r=a.baseUrl,s=n||a.model;switch(e){case"openai":return new M8(a.apiKey,s,r);case"zhipu":return new A8(a.apiKey,s,r);case"deepseek":return new E8(a.apiKey,s,r);case"gemini":return new z8(a.apiKey,s,r);case"anthropic":return new P8(a.apiKey,s,r);case"siliconflow":return new R8(a.apiKey,s,r);default:throw new Error(`不支持的AI服务提供商: ${e}`)}}static getDefaultService(e){const t=e.settings.aiConfig;if(!t)throw new Error("AI配置未初始化");return this.createService(t.defaultProvider,e)}}const O8=Object.freeze(Object.defineProperty({__proto__:null,AIServiceFactory:$8},Symbol.toStringTag,{value:"Module"})),L8={"{{cardContent}}":"卡片完整内容（包含正反面）","{{cardFront}}":"卡片正面内容","{{cardBack}}":"卡片背面内容","{{cardType}}":"卡片类型（问答/选择/挖空）","{{templateName}}":"当前使用的模板名称","{{deckName}}":"所属牌组名称","{{tags}}":"卡片标签（逗号分隔）"},N8={"{{cardContent}}":"卡片完整内容（包含正反面）","{{cardFront}}":"卡片正面内容","{{cardBack}}":"卡片背面内容","{{cardType}}":"卡片类型（问答/选择/挖空）","{{templateName}}":"当前使用的模板名称","{{deckName}}":"所属牌组名称","{{tags}}":"卡片标签（逗号分隔）","{{数量}}":"生成题目数量","{{类型}}":"题目类型（单选/多选/判断/填空）","{{难度}}":"难度级别（简单/中等/困难/混合）","{{目标牌组}}":"目标刷题牌组名称"};class F8{resolve(e,t,n){var i,a,r;let s=e;return s=s.replace(/\{\{cardContent\}\}/g,t.content||""),s=s.replace(/\{\{cardFront\}\}/g,this.getCardFront(t)),s=s.replace(/\{\{cardBack\}\}/g,this.getCardBack(t)),s=s.replace(/\{\{cardType\}\}/g,this.getCardType(t)),s=s.replace(/\{\{templateName\}\}/g,(null==(i=n.template)?void 0:i.name)||"未知模板"),s=s.replace(/\{\{deckName\}\}/g,(null==(a=n.deck)?void 0:a.name)||"未知牌组"),s=s.replace(/\{\{tags\}\}/g,(null==(r=t.tags)?void 0:r.join(", "))||""),s}validate(e){const t=e.matchAll(/\{\{([^}]+)\}\}/g),n=Object.keys(L8),i=[];for(const a of t){const e=`{{${a[1]}}}`;n.includes(e)||i.push(e)}return{isValid:0===i.length,invalidVariables:i}}getAvailableVariables(){return L8}extractVariables(e){const t=e.matchAll(/\{\{([^}]+)\}\}/g),n=[];for(const i of t){const e=`{{${i[1]}}}`;n.includes(e)||n.push(e)}return n}getCardFront(e){var t,n,i;return(null==(t=e.fields)?void 0:t.front)||(null==(n=e.fields)?void 0:n.question)||(null==(i=e.fields)?void 0:i.prompt)||""}getCardBack(e){var t,n,i;return(null==(t=e.fields)?void 0:t.back)||(null==(n=e.fields)?void 0:n.answer)||(null==(i=e.fields)?void 0:i.response)||""}getCardType(e){var t,n;if((null==(t=e.fields)?void 0:t.choices)||(null==(n=e.fields)?void 0:n.correctAnswer))return"选择题";const i=e.content||"";return i.includes("==")||i.includes("{{c")?"挖空题":"问答题"}}class B8{static async formatWithCustomAction(e,t,n,i){var a,r,s;try{const o=i.settings.aiConfig;if(!(null==(a=null==o?void 0:o.formatting)?void 0:a.enabled))return{success:!1,originalContent:t.content||"",error:"AI格式化功能未启用"};const l=e.provider||o.defaultProvider;if(!l)return{success:!1,originalContent:t.content||"",error:"未设置AI提供商"};const c=o.apiKeys[l];if(!c||!c.apiKey)return{success:!1,originalContent:t.content||"",error:`AI提供商"${l}"未配置API密钥，请前往 [插件设置 > AI服务] 进行配置`};const d=this.variableResolver.resolve(e.systemPrompt,t,n),u=this.variableResolver.resolve(e.userPromptTemplate,t,n),h=$8.createService(l,i),p=await h.chat({messages:[{role:"system",content:d},{role:"user",content:u}],temperature:null!=(r=e.temperature)?r:.1,maxTokens:null!=(s=e.maxTokens)?s:2e3});if(!p.success||!p.content)return{success:!1,originalContent:t.content||"",error:p.error||"AI格式化失败"};const g=this.cleanAIResponse(p.content);return{success:!0,originalContent:t.content||"",formattedContent:g,provider:l,model:p.model}}catch(o){return _e.error("[AIFormatterService] Error:",o),{success:!1,originalContent:t.content||"",error:o instanceof Error?o.message:"未知错误"}}}static async formatChoiceQuestion(e,t){var n;try{const i=t.settings.aiConfig;if(!(null==(n=null==i?void 0:i.formatting)?void 0:n.enabled))return{success:!1,error:"AI格式化功能未启用，请在设置中开启"};const a=i.formattingProvider||i.defaultProvider;if(!a)return{success:!1,error:"未设置AI提供商，请在设置中配置"};const r=i.apiKeys[a];if(!r||!r.apiKey)return{success:!1,error:`格式化AI提供商"${a}"未配置API密钥，请在设置中配置`};r.model;const s=$8.createService(a,t),o=this.buildSystemPrompt(),l=this.buildUserPrompt(e.content),c=await s.chat({messages:[{role:"system",content:o},{role:"user",content:l}],temperature:.1,maxTokens:2e3});if(!c.success||!c.content)return _e.error("[AIFormatterService] AI调用失败:",c.error),{success:!1,error:c.error||"AI格式化失败"};const d=this.cleanAIResponse(c.content),u=this.validateChoiceFormat(d);return u.isValid?{success:!0,formattedContent:d,provider:a,model:c.model}:(_e.error("[AIFormatterService] 格式验证失败:",u.reason),{success:!1,error:`格式化结果不符合规范：${u.reason}`})}catch(i){return _e.error("[AIFormatterService] Error:",i),{success:!1,error:i instanceof Error?i.message:"未知错误"}}}static buildSystemPrompt(){return'你是一个选择题格式规范化助手。\n\n## 核心原则\n1. **不修改内容** - 保持所有文本完全一致\n2. **仅调整格式** - 将内容重组为标准格式\n3. **识别正确答案** - 添加 {✓} 标记\n\n## 标准格式\n```\nQ: [问题内容]\n\nA) [选项A]\nB) [选项B] {✓}\nC) [选项C]\nD) [选项D]\n\n---\n\nExplanation: [解析内容]\n```\n\n## 格式要求\n- 问题以"Q: "开头\n- 选项用A) B) C) D)标记\n- 正确答案后添加 {✓}\n- 解析用"---"分隔，以"Explanation: "开头\n\n## ❌ 严格禁止\n- ❌ 改写或润色任何文本\n- ❌ 添加新内容或删除原有内容\n- ❌ 修改正确答案\n- ❌ 纠正拼写/语法错误\n\n## ✅ 允许操作\n- ✅ 统一格式标记（A. → A)）\n- ✅ 添加/调整空行\n- ✅ 添加正确答案标记 {✓}\n- ✅ 规范分隔符格式\n\n## 📝 输出格式要求\n**重要**：直接返回格式化后的文本内容，不要使用markdown代码块（```）包裹，不要添加任何前缀、后缀或额外说明。\n\n示例正确输出：\nQ: 问题内容\n\nA) 选项A\nB) 选项B {✓}\n\n---\n\nExplanation: 解析内容'}static buildUserPrompt(e){return`请规范化以下选择题：\n\n${e}`}static cleanAIResponse(e){if(!e)return"";let t=e.trim();const n=t.match(/^```(?:markdown|md|text|)?\s*\n?([\s\S]*?)\n?```$/);return n&&(t=n[1].trim()),t=t.replace(/\n{3,}/g,"\n\n"),t}static validateChoiceFormat(e){if(!e.includes("Q:")&&!e.includes("q:"))return{isValid:!1,reason:"缺少问题部分（Q:）"};const t=e.match(/[A-Z]\)/g);return!t||t.length<2?{isValid:!1,reason:"选项数量不足（至少需要2个）"}:e.includes("{✓}")?{isValid:!0}:{isValid:!1,reason:"缺少正确答案标记 {✓}"}}}function j8(e){return{sourceFile:e.sourceFile,sourceBlock:e.sourceBlock,sourceRange:e.sourceRange,sourceExists:e.sourceExists,sourceFileMtime:e.sourceFileMtime}}function U8(e){const t=(new Date).toISOString();return{id:Gu(),uuid:Vu(),deckId:e.deckId,...e.templateId&&{templateId:e.templateId},type:"basic",cardPurpose:"test",difficulty:e.difficulty||"medium",content:e.content,stats:{totalReviews:0,totalTime:0,averageTime:0,testStats:{totalAttempts:0,correctAttempts:0,incorrectAttempts:0,accuracy:0,bestScore:0,averageScore:0,lastScore:0,averageResponseTime:0,fastestTime:0,lastTestDate:t,isInErrorBook:!1,consecutiveCorrect:0}},created:t,modified:t,tags:e.tags||[],priority:e.priority||2,...e.sourceFile&&{sourceFile:e.sourceFile},...e.sourceBlock&&{sourceBlock:e.sourceBlock},...e.sourceRange&&{sourceRange:e.sourceRange},...void 0!==e.sourceExists&&{sourceExists:e.sourceExists},...e.sourceFileMtime&&{sourceFileMtime:e.sourceFileMtime},metadata:e.questionType||e.correctAnswer?{questionMetadata:{type:e.questionType,correctAnswer:e.correctAnswer}}:void 0}}oe(B8,"variableResolver",new F8);const V8=class e{constructor(e){this.plugin=e}async generateTests(e){var t;try{const{sourceCard:n,action:i}=e;if(!i.testConfig)throw new Error("测试题配置缺失");const a=this.plugin.settings.aiConfig;if(!(null==(t=null==a?void 0:a.cardSplitting)?void 0:t.enabled))return{success:!1,error:"AI测试题生成功能未启用，请在设置中开启"};const r=i.provider||a.defaultProvider;if(!r)return{success:!1,error:"未设置AI提供商，请在设置中配置"};const s=a.apiKeys[r];if(!s||!s.apiKey)return{success:!1,error:`AI提供商"${r}"未配置API密钥，请在设置中配置`};const o=$8.createService(r,this.plugin),{systemPrompt:l,userPrompt:c}=this.buildPrompts(n,i),d=await o.chat({messages:[{role:"system",content:l},{role:"user",content:c}],temperature:.3,maxTokens:3e3});if(!d.success||!d.content)return{success:!1,error:d.error||"AI生成测试题失败"};return{success:!0,generatedQuestions:this.parseAIResponse(d.content,i),metadata:{provider:r,model:d.model||s.model,tokensUsed:d.tokensUsed||0,cost:d.cost}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"生成测试题失败"}}}buildPrompts(t,n){const i={template:void 0,deck:void 0},a=e.variableResolver.resolve(n.systemPrompt,t,i);let r=n.userPromptTemplate;const s=n.testConfig;return s&&(r=r.replace(/\{\{数量\}\}/g,s.defaultCount.toString()).replace(/\{\{类型\}\}/g,this.getQuestionTypeLabel(s.questionType)).replace(/\{\{难度\}\}/g,this.getDifficultyLabel(s.difficultyLevel))),r=e.variableResolver.resolve(r,t,i),{systemPrompt:a,userPrompt:r}}parseAIResponse(e,t){try{let i=e.trim();const a=/^```(?:json|markdown|md|text|)?\s*\n?([\s\S]*?)\n?```$/,r=i.match(a);r&&(i=r[1].trim());const s=i.match(/\[[\s\S]*\]/)||i.match(/\{[\s\S]*"questions"[\s\S]*\}/);if(s)try{const e=JSON.parse(s[0]);return this.parseJSONResponse(e,t)}catch(n){}return this.parseTextResponse(i,t)}catch(i){throw new Error(`AI响应格式错误: ${i instanceof Error?i.message:"未知错误"}`)}}parseJSONResponse(e,t){const n=[],i=e.questions||(Array.isArray(e)?e:[]);if(!Array.isArray(i)||0===i.length)throw new Error("AI返回的测试题列表为空");if(i.forEach((e,i)=>{var a,r,s,o,l,c,d;if("multiple"===(null==(a=t.testConfig)?void 0:a.questionType)||"single"===(null==(r=t.testConfig)?void 0:r.questionType)){const a=e.question||e.front,r=e.options||e.choices||[],o=e.correctAnswer||e.correct||[],l=e.explanation||"";if(!a||""===a.trim())throw new Error(`第${i+1}题缺少问题描述（question字段）`);if(!Array.isArray(r)||0===r.length)throw new Error(`第${i+1}题缺少选项（options字段必须是非空数组）`);if(r.length<2)throw new Error(`第${i+1}题选项不足（至少需要2个选项）`);if(!Array.isArray(o)||0===o.length)throw new Error(`第${i+1}题缺少正确答案（correctAnswer字段必须是非空数组）`);const c=r.map((e,t)=>`${String.fromCharCode(65+t)}) ${e}${o.includes(t)?" {✓}":""}`).join("\n"),d=`Q: ${a}\n\n${c}`;let u=d;l&&l.trim()&&(u+=`\n\n---div---\n\n${l}`),n.push({content:u,front:d,back:l,type:"choice",choices:r,correctAnswer:o,explanation:l,difficulty:null==(s=t.testConfig)?void 0:s.difficultyLevel})}else if("fill"===(null==(o=t.testConfig)?void 0:o.questionType)){const i=e.content||e.question||e.front||"",a=e.explanation||"";let r=i;a&&a.trim()&&(r+=`\n\n---div---\n\n${a}`),n.push({content:r,front:i,back:"",type:"fill",explanation:a,difficulty:null==(l=t.testConfig)?void 0:l.difficultyLevel})}else if("judge"===(null==(c=t.testConfig)?void 0:c.questionType)){const i=e.statement||e.question||e.front||"",a="boolean"==typeof e.answer?e.answer?"正确":"错误":e.answer||e.back||"",r=e.explanation||"";let s=`Q: ${i}\n\nA: ${a}`;r&&r.trim()&&(s+=`\n\n---div---\n\n${r}`),n.push({content:s,front:i,back:a,type:"judge",explanation:r,difficulty:null==(d=t.testConfig)?void 0:d.difficultyLevel})}}),0===n.length)throw new Error("未能从AI响应中解析出有效的测试题");return n}parseTextResponse(e,t){var n,i,a,r;const s=[];try{const o=e.split(/---div---|---/).map(e=>e.trim()).filter(e=>e);if(o.length<2)throw new Error("纯文本格式应包含问题和答案两部分，用 ---div--- 分隔");const l=o[0],c=o[1];if("multiple"===(null==(n=t.testConfig)?void 0:n.questionType)||"single"===(null==(i=t.testConfig)?void 0:i.questionType)){const e=l.match(/^Q:\s*(.+?)(?=\n[A-D]\))/s);if(!e)throw new Error("未找到有效的题目格式（应以 Q: 开头）");const n=e[1].trim(),i=l.match(/^([A-D]\).+?)$/gm);if(!i||i.length<2)throw new Error("选择题应包含至少2个选项（格式：A) 选项内容）");const r=i.map(e=>e.replace(/^[A-D]\)\s*/,"").trim());let o=[],d=c;const u=c.match(/(?:正确答案|答案)[：:]\s*([A-D])/i)||c.match(/^([A-D])\)/m);if(u){const e=u[1].charCodeAt(0)-"A".charCodeAt(0);o=[e],d=c.replace(/(?:正确答案|答案)[：:]\s*[A-D]\)\s*/i,"").trim()}else o=[0];const h=r.map((e,t)=>`${String.fromCharCode(65+t)}) ${e}${o.includes(t)?" {✓}":""}`).join("\n");let p=`Q: ${n}\n\n${h}`;d&&d.trim()&&(p+=`\n\n---div---\n\n${d}`),s.push({content:p,front:n,back:r[o[0]]||"未知答案",type:"choice",choices:r,correctAnswer:o,explanation:d||"暂无解释",difficulty:null==(a=t.testConfig)?void 0:a.difficultyLevel})}else{let e=`Q: ${l}\n\nA: ${c}`;s.push({content:e,front:l,back:c,type:"judge",explanation:"",difficulty:null==(r=t.testConfig)?void 0:r.difficultyLevel})}return s}catch(o){throw new Error(`纯文本格式解析错误: ${o instanceof Error?o.message:"未知错误"}`)}}async importToQuestionBank(e,t,n,i){try{let a=0;for(const r of e){const e=U8({deckId:t,content:r.content,difficulty:("mixed"===r.difficulty?"medium":r.difficulty)||"medium",tags:["AI生成",`来源:${n.uuid}`,...n.tags||[]],priority:0,questionType:"choice"===r.type?"single_choice":"fill"===r.type?"cloze":"qa",correctAnswer:void 0!==r.correctAnswer?Array.isArray(r.correctAnswer)?r.correctAnswer.map(e=>String.fromCharCode(65+e)):String.fromCharCode(65+r.correctAnswer):void 0,...j8(n)});e.metadata||(e.metadata={}),e.metadata.generatedBy=(null==i?void 0:i.id)||"ai-test-generator",e.metadata.generatedAt=(new Date).toISOString(),e.metadata.explanation=r.explanation,e.metadata.sourceCardId=n.uuid,await this.plugin.dataStorage.saveCard(e),a++}return{success:!0,importedCount:a}}catch(a){return{success:!1,importedCount:0}}}getQuestionTypeLabel(e){return{single:"单选题",multiple:"多选题",judge:"判断题",fill:"填空题"}[e||"multiple"]||"测试题"}getDifficultyLabel(e){return{easy:"简单",medium:"中等",hard:"困难",mixed:"混合"}[e||"medium"]||"中等"}async getOrCreateQuestionBankDeck(e){var t;try{if(!this.plugin.questionBankService)throw new Error("题库服务未初始化");if(this.plugin.questionBankHierarchy){return(await this.plugin.questionBankHierarchy.ensureQuestionBankExists(e)).id}const n=await this.plugin.questionBankService.findBankByMemoryDeckId(e);if(n)return n.id;const i=await this.plugin.dataStorage.getDeck(e);if(!i)throw new Error("源牌组不存在");let a;i.parentId&&(a=await this.getOrCreateQuestionBankDeck(i.parentId));const r=`${i.name} - 刷题`,s=a&&(null==(t=await this.plugin.questionBankService.getBankById(a))?void 0:t.path)+`::${r}`||r,o={name:r,description:`从牌组"${i.name}"自动生成的刷题牌组`,deckType:"question-bank",parentId:a,path:s,level:i.level||0,categoryIds:i.categoryIds||[],tags:i.tags||[],metadata:{pairedMemoryDeckId:e}};return(await this.plugin.questionBankService.createBank(o)).id}catch(n){throw n}}};oe(V8,"variableResolver",new F8);let q8=V8;const H8=Object.freeze(Object.defineProperty({__proto__:null,AITestGeneratorService:q8},Symbol.toStringTag,{value:"Module"}));var W8=e=>e.stopPropagation(),G8=(e,t)=>"Escape"===e.key&&t()(),Q8=la('<span class="provider-badge svelte-psf14o"> </span>'),K8=la('<div class="error-message svelte-psf14o"><!> <span> </span></div>'),Z8=la('<div class="modal-overlay svelte-psf14o" role="presentation"><div class="preview-modal svelte-psf14o" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-header svelte-psf14o"><h3 class="svelte-psf14o"> </h3> <button class="close-btn svelte-psf14o" aria-label="关闭">×</button></div> <div class="modal-body svelte-psf14o"><div class="comparison-container svelte-psf14o"><div class="content-panel original svelte-psf14o"><div class="panel-header svelte-psf14o"><!> <span>原始内容</span></div> <div class="content-preview svelte-psf14o"> </div></div> <div class="arrow-indicator svelte-psf14o"><!></div> <div class="content-panel formatted svelte-psf14o"><div class="panel-header svelte-psf14o"><!> <span>格式化后</span> <!></div> <div class="content-preview svelte-psf14o"> </div></div></div> <!></div> <div class="modal-footer svelte-psf14o"><!> <!></div></div></div>');function Y8(e,t){if(new.target)return Er({component:Y8,...e});kt(t,!0);let n=Ar(t,"show",7),i=Ar(t,"previewResult",7),a=Ar(t,"actionName",7),r=Ar(t,"onConfirm",7),s=Ar(t,"onCancel",7);var o={get show(){return n()},set show(e){n(e),hn()},get previewResult(){return i()},set previewResult(e){i(e),hn()},get actionName(){return a()},set actionName(e){a(e),hn()},get onConfirm(){return r()},set onConfirm(e){r(e),hn()},get onCancel(){return s()},set onCancel(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=ha(),c=Qt(l),d=e=>{var t=Z8();t.__click=function(...e){var t;null==(t=s())||t.apply(this,e)};var n=Gt(t);n.__click=[W8],n.__keydown=[G8,s];var o=Gt(n),l=Gt(o),c=Gt(l);zt(l),Kt(l,2).__click=function(...e){var t;null==(t=s())||t.apply(this,e)},zt(o);var d=Kt(o,2),u=Gt(d),h=Gt(u),p=Gt(h);Ng(Gt(p),{name:"file",size:"14"}),Pt(2),zt(p);var g=Kt(p,2),v=Gt(g,!0);zt(g),zt(h);var f=Kt(h,2);Ng(Gt(f),{name:"chevronRight",size:"24"}),zt(f);var m=Kt(f,2),y=Gt(m),b=Gt(y);Ng(b,{name:"wand",size:"14"});var w=Kt(b,4),k=e=>{var t=Q8(),n=Gt(t,!0);zt(t),zi(()=>va(n,i().provider)),pa(e,t)};xa(w,e=>{i().provider&&e(k)}),zt(y);var S=Kt(y,2),x=Gt(S,!0);zt(S),zt(m),zt(u);var _=Kt(u,2),C=e=>{var t=K8(),n=Gt(t);Ng(n,{name:"alertCircle",size:"16"});var a=Kt(n,2),r=Gt(a,!0);zt(a),zt(t),zi(()=>va(r,i().error)),pa(e,t)};xa(_,e=>{i().success||e(C)}),zt(d);var I=Kt(d,2),D=Gt(I);Hg(D,{variant:"secondary",get onclick(){return s()},children:(e,t)=>{Pt(),pa(e,ua("取消"))},$$slots:{default:!0}});var T=Kt(D,2);{let e=In(()=>!i().success);Hg(T,{variant:"primary",get onclick(){return r()},get disabled(){return bi(e)},children:(e,t)=>{Pt(),pa(e,ua("应用更改"))},$$slots:{default:!0}})}zt(I),zt(n),zt(t),zi(()=>{var e;va(c,`AI格式化预览 - ${null!=(e=a())?e:""}`),va(v,i().originalContent),va(x,i().formattedContent||"")}),pa(e,t)};return xa(c,e=>{n()&&e(d)}),pa(e,l),St(o)}ia(["click","keydown"]);var X8=(e,t)=>t()("format"),J8=(e,t)=>t()("test-generator"),e9=(e,t)=>t()("split"),t9=la('<div class="action-type-tab-bar svelte-1xogkow"><button><span>AI格式化</span> <span class="count-badge svelte-1xogkow"> </span></button> <button><span>AI题库</span> <span class="count-badge svelte-1xogkow"> </span></button> <button><span>AI拆分</span> <span class="count-badge svelte-1xogkow"> </span></button></div>');function n9(e,t){if(new.target)return Er({component:n9,...e});kt(t,!0);let n=Ar(t,"activeType",7),i=Ar(t,"formatCount",7),a=Ar(t,"testGenCount",7),r=Ar(t,"splitCount",7),s=Ar(t,"onTypeChange",7);var o={get activeType(){return n()},set activeType(e){n(e),hn()},get formatCount(){return i()},set formatCount(e){i(e),hn()},get testGenCount(){return a()},set testGenCount(e){a(e),hn()},get splitCount(){return r()},set splitCount(e){r(e),hn()},get onTypeChange(){return s()},set onTypeChange(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=t9(),c=Gt(l);let d;c.__click=[X8,s];var u=Kt(Gt(c),2),h=Gt(u,!0);zt(u),zt(c);var p=Kt(c,2);let g;p.__click=[J8,s];var v=Kt(Gt(p),2),f=Gt(v,!0);zt(v),zt(p);var m=Kt(p,2);let y;m.__click=[e9,s];var b=Kt(Gt(m),2),w=Gt(b,!0);return zt(b),zt(m),zt(l),zi((e,t,n)=>{d=Fa(c,1,"tab-btn svelte-1xogkow",null,d,e),va(h,i()),g=Fa(p,1,"tab-btn svelte-1xogkow",null,g,t),va(f,a()),y=Fa(m,1,"tab-btn svelte-1xogkow",null,y,n),va(w,r())},[()=>({active:"format"===n()}),()=>({active:"test-generator"===n()}),()=>({active:"split"===n()})]),pa(e,l),St(o)}ia(["click"]);var i9=(e,t)=>t({defaultCount:parseInt(e.target.value)||1}),a9=(e,t,n)=>t({questionType:bi(n).value}),r9=la('<label class="radio-item svelte-1vdrxb4"><input type="radio" name="questionType" class="svelte-1vdrxb4"/> <span class="svelte-1vdrxb4"> </span></label>'),s9=(e,t,n)=>t({difficultyLevel:bi(n).value}),o9=la('<label class="radio-item svelte-1vdrxb4"><input type="radio" name="difficulty" class="svelte-1vdrxb4"/> <span class="svelte-1vdrxb4"> </span></label>'),l9=(e,t)=>t({targetDeckStrategy:"auto",targetDeckId:void 0}),c9=(e,t)=>t({targetDeckStrategy:"manual"}),d9=(e,t)=>t({targetDeckId:e.target.value}),u9=la("<option> </option>"),h9=la('<select class="deck-select svelte-1vdrxb4"><option>请选择目标牌组</option><!></select>'),p9=la('<div class="test-gen-config-panel svelte-1vdrxb4"><div class="section-header svelte-1vdrxb4"><h4 class="section-title svelte-1vdrxb4">生成配置</h4></div> <div class="config-row svelte-1vdrxb4"><label class="config-label svelte-1vdrxb4" for="gen-count-input">生成数量</label> <div class="input-with-suffix svelte-1vdrxb4"><input id="gen-count-input" type="number" min="1" max="20" class="number-input svelte-1vdrxb4" aria-label="生成数量"/> <span class="input-suffix svelte-1vdrxb4">张</span></div></div> <div class="config-row svelte-1vdrxb4"><div class="config-label svelte-1vdrxb4" id="question-type-label">题目类型</div> <div class="radio-group svelte-1vdrxb4" role="group" aria-labelledby="question-type-label"></div></div> <div class="config-row svelte-1vdrxb4"><div class="config-label svelte-1vdrxb4" id="difficulty-label">难度级别</div> <div class="radio-group svelte-1vdrxb4" role="group" aria-labelledby="difficulty-label"></div></div> <div class="config-row svelte-1vdrxb4"><div class="config-label svelte-1vdrxb4" id="export-strategy-label">导出到</div> <div class="export-strategy svelte-1vdrxb4" role="group" aria-labelledby="export-strategy-label"><label class="radio-item svelte-1vdrxb4"><input type="radio" name="targetStrategy" value="auto" class="svelte-1vdrxb4"/> <span class="svelte-1vdrxb4">自动创建对应的刷题牌组</span></label> <label class="radio-item svelte-1vdrxb4"><input type="radio" name="targetStrategy" value="manual" class="svelte-1vdrxb4"/> <span class="svelte-1vdrxb4">手动指定牌组</span></label> <!></div></div> <div class="config-hint svelte-1vdrxb4">自动模式会为当前牌组创建配套的刷题牌组，手动模式可指定已存在的题库牌组</div></div>');function g9(e,t){if(new.target)return Er({component:g9,...e});kt(t,!0);let n=Ar(t,"config",7),i=Ar(t,"availableDecks",7),a=Ar(t,"onChange",7);const r=[{value:"single",label:"单选题"},{value:"multiple",label:"多选题"},{value:"judge",label:"判断题"},{value:"fill",label:"填空题"}],s=[{value:"easy",label:"简单"},{value:"medium",label:"中等"},{value:"hard",label:"困难"},{value:"mixed",label:"混合"}];function o(e){a()({...n(),...e})}var l={get config(){return n()},set config(e){n(e),hn()},get availableDecks(){return i()},set availableDecks(e){i(e),hn()},get onChange(){return a()},set onChange(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=p9(),d=Kt(Gt(c),2),u=Kt(Gt(d),2),h=Gt(u);Za(h),h.__input=[i9,o],Pt(2),zt(u),zt(d);var p=Kt(d,2),g=Kt(Gt(p),2);Ca(g,21,()=>r,_a,(e,t)=>{var i=r9(),a=Gt(i);Za(a),a.__change=[a9,o,t];var r=Kt(a,2),s=Gt(r,!0);zt(r),zt(i),zi(()=>{Ya(a,bi(t).value),Xa(a,n().questionType===bi(t).value),va(s,bi(t).label)}),pa(e,i)}),zt(g),zt(p);var v=Kt(p,2),f=Kt(Gt(v),2);Ca(f,21,()=>s,_a,(e,t)=>{var i=o9(),a=Gt(i);Za(a),a.__change=[s9,o,t];var r=Kt(a,2),s=Gt(r,!0);zt(r),zt(i),zi(()=>{Ya(a,bi(t).value),Xa(a,n().difficultyLevel===bi(t).value),va(s,bi(t).label)}),pa(e,i)}),zt(f),zt(v);var m=Kt(v,2),y=Kt(Gt(m),2),b=Gt(y),w=Gt(b);Za(w),w.__change=[l9,o],Pt(2),zt(b);var k=Kt(b,2),S=Gt(k);Za(S),S.__change=[c9,o],Pt(2),zt(k);var x=Kt(k,2),_=e=>{var t=h9();t.__change=[d9,o];var a,r=Gt(t);r.value=r.__value="",Ca(Kt(r),17,()=>i().filter(e=>"question-bank"===e.deckType||"test"===e.purpose),_a,(e,t)=>{var n=u9(),i=Gt(n,!0);zt(n);var a={};zi(()=>{var e;va(i,bi(t).name),a!==(a=bi(t).id)&&(n.value=null!=(e=n.__value=bi(t).id)?e:"")}),pa(e,n)}),zt(t),Va(t),zi(()=>{var e;a!==(a=n().targetDeckId||"")&&(t.value=null!=(e=t.__value=n().targetDeckId||"")?e:"",Ua(t,n().targetDeckId||""))}),pa(e,t)};return xa(x,e=>{"manual"===n().targetDeckStrategy&&e(_)}),zt(y),zt(m),Pt(2),zt(c),zi(()=>{Ya(h,n().defaultCount),Xa(w,"auto"===n().targetDeckStrategy),Xa(S,"manual"===n().targetDeckStrategy)}),pa(e,c),St(l)}function v9(e,t,n){t()&&n()}ia(["input","change"]);var f9=la('<div role="presentation"></div>'),m9=la('<div class="tuanki-modal__loading svelte-10l74hm"><!></div>'),y9=la('<h3 id="modal-title" class="tuanki-modal__title svelte-10l74hm"> </h3>'),b9=la('<div class="tuanki-modal__title-wrapper svelte-10l74hm"><!></div> <!>',1),w9=la('<div class="tuanki-modal__header svelte-10l74hm"><!></div>'),k9=la('<div class="tuanki-modal__actions svelte-10l74hm"><!> <!></div>'),S9=la('<div class="tuanki-modal__footer svelte-10l74hm"><!></div>'),x9=la('<!> <div><div><!> <!> <div class="tuanki-modal__body svelte-10l74hm"><!></div> <!></div></div>',1);function _9(e,t){if(new.target)return Er({component:_9,...e});kt(t,!0);let n=Ar(t,"open",7),i=Ar(t,"onClose",7),a=Ar(t,"size",7,"md"),r=Ar(t,"width",7),s=Ar(t,"height",7),o=Ar(t,"title",7),l=Ar(t,"closable",7,!0),c=Ar(t,"maskClosable",7,!0),d=Ar(t,"keyboard",7,!0),u=Ar(t,"centered",7,!0),h=Ar(t,"destroyOnClose",7,!1),p=Ar(t,"zIndex",7,999999),g=Ar(t,"mask",7,!0),v=Ar(t,"maskStyle",7),f=Ar(t,"draggable",7,!1),m=Ar(t,"resizable",7,!1),y=Ar(t,"loading",7,!1),b=Ar(t,"confirmDialog",7,!1),w=Ar(t,"okText",7,"确定"),k=Ar(t,"cancelText",7,"取消"),S=Ar(t,"okType",7,"primary"),x=Ar(t,"onOk",7),_=Ar(t,"onCancel",7),C=Ar(t,"class",7,""),I=Ar(t,"children",7),D=Ar(t,"header",7),T=Ar(t,"footer",7),M=Mr(t,["$$slots","$$events","$$legacy","open","onClose","size","width","height","title","closable","maskClosable","keyboard","centered","destroyOnClose","zIndex","mask","maskStyle","draggable","resizable","loading","confirmDialog","okText","cancelText","okType","onOk","onCancel","class","children","header","footer"]);const A=$r();let E=Pn(null),z=Pn(!1),P=Pn(Ot(n())),R=In(()=>()=>{const e={};return r()&&(e.width=r()),s()&&(e.height=s()),p()&&(e.zIndex=p().toString()),Object.entries(e).map(([e,t])=>`${e}: ${t}`).join("; ")}),$=In(()=>()=>{const e={zIndex:(p()-1).toString()};return v()&&Object.assign(e,Object.fromEntries(v().split(";").map(e=>e.split(":").map(e=>e.trim())))),Object.entries(e).map(([e,t])=>`${e}: ${t}`).join("; ")}),O=In(()=>()=>{const e=["tuanki-modal",`tuanki-modal--${a()}`];return u()&&e.push("tuanki-modal--centered"),f()&&e.push("tuanki-modal--draggable"),m()&&e.push("tuanki-modal--resizable"),y()&&e.push("tuanki-modal--loading"),b()&&e.push("tuanki-modal--confirm"),C()&&e.push(C()),e.join(" ")});function L(){y()||bi(z)||(i()(),A("close"))}function N(e){d()&&"Escape"===e.key&&L()}async function F(){var e;if(!bi(z))try{$n(z,!0),await(null==(e=x())?void 0:e()),A("ok"),b()||L()}catch(t){_e.error("Modal ok handler error:",t),A("error",t)}finally{$n(z,!1)}}function B(){var e;null==(e=_())||e(),A("cancel"),L()}Ti(()=>{n()?($n(P,!0),document.addEventListener("keydown",N),document.body.style.overflow="hidden"):(document.removeEventListener("keydown",N),document.body.style.overflow="",h()?setTimeout(()=>{$n(P,!1)},300):$n(P,!1))}),Rr(()=>{document.removeEventListener("keydown",N),document.body.style.overflow=""});var j={get open(){return n()},set open(e){n(e),hn()},get onClose(){return i()},set onClose(e){i(e),hn()},get size(){return a()},set size(e="md"){a(e),hn()},get width(){return r()},set width(e){r(e),hn()},get height(){return s()},set height(e){s(e),hn()},get title(){return o()},set title(e){o(e),hn()},get closable(){return l()},set closable(e=!0){l(e),hn()},get maskClosable(){return c()},set maskClosable(e=!0){c(e),hn()},get keyboard(){return d()},set keyboard(e=!0){d(e),hn()},get centered(){return u()},set centered(e=!0){u(e),hn()},get destroyOnClose(){return h()},set destroyOnClose(e=!1){h(e),hn()},get zIndex(){return p()},set zIndex(e=999999){p(e),hn()},get mask(){return g()},set mask(e=!0){g(e),hn()},get maskStyle(){return v()},set maskStyle(e){v(e),hn()},get draggable(){return f()},set draggable(e=!1){f(e),hn()},get resizable(){return m()},set resizable(e=!1){m(e),hn()},get loading(){return y()},set loading(e=!1){y(e),hn()},get confirmDialog(){return b()},set confirmDialog(e=!1){b(e),hn()},get okText(){return w()},set okText(e="确定"){w(e),hn()},get cancelText(){return k()},set cancelText(e="取消"){k(e),hn()},get okType(){return S()},set okType(e="primary"){S(e),hn()},get onOk(){return x()},set onOk(e){x(e),hn()},get onCancel(){return _()},set onCancel(e){_(e),hn()},get class(){return C()},set class(e=""){C(e),hn()},get children(){return I()},set children(e){I(e),hn()},get header(){return D()},set header(e){D(e),hn()},get footer(){return T()},set footer(e){T(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},U=ha(),V=Qt(U),q=e=>{var t=x9(),i=Qt(t),a=e=>{var t=f9();let i;t.__click=[v9,c,L],zi((e,n)=>{i=Fa(t,1,"tuanki-modal-backdrop svelte-10l74hm",null,i,e),ja(t,n)},[()=>({open:n()}),()=>bi($)()]),pa(e,t)};xa(i,e=>{g()&&e(a)});var r=Kt(i,2);let s;var d=Gt(r),h=e=>e.stopPropagation();tr(d,(e,t,n)=>({class:e,style:t,role:"dialog","aria-modal":"true","aria-labelledby":o()?"modal-title":void 0,tabindex:"-1",onclick:h,...M,[Wa]:n}),[()=>bi(O)(),()=>bi(R)(),()=>({open:n()})],void 0,"svelte-10l74hm");var v=Gt(d),f=e=>{var t=m9();Ng(Gt(t),{name:"spinner",animation:"spin",size:"xl",variant:"primary"}),zt(t),pa(e,t)};xa(v,e=>{y()&&e(f)});var m=Kt(v,2),x=e=>{var t=w9(),n=Gt(t),i=e=>{var t=ha();Ea(Qt(t),D),pa(e,t)},a=e=>{var t=b9(),n=Qt(t),i=Gt(n),a=e=>{var t=y9(),n=Gt(t,!0);zt(t),zi(()=>va(n,o())),pa(e,t)};xa(i,e=>{o()&&e(a)}),zt(n);var r=Kt(n,2),s=e=>{Hg(e,{variant:"ghost",size:"sm",iconOnly:!0,icon:"times",onclick:L,ariaLabel:"关闭",class:"tuanki-modal__close"})};xa(r,e=>{l()&&e(s)}),pa(e,t)};xa(n,e=>{D()?e(i):e(a,!1)}),zt(t),pa(e,t)};xa(m,e=>{(D()||o()||l())&&e(x)});var _=Kt(m,2);Ea(Gt(_),()=>{var e;return null!=(e=I())?e:je}),zt(_);var C=Kt(_,2),A=e=>{var t=S9(),n=Gt(t),i=e=>{var t=ha();Ea(Qt(t),T),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=k9(),n=Gt(t);Hg(n,{variant:"secondary",onclick:B,get disabled(){return bi(z)},children:(e,t)=>{Pt();var n=ua();zi(()=>va(n,k())),pa(e,n)},$$slots:{default:!0}}),Hg(Kt(n,2),{get variant(){return S()},onclick:F,get loading(){return bi(z)},children:(e,t)=>{Pt();var n=ua();zi(()=>va(n,w())),pa(e,n)},$$slots:{default:!0}}),zt(t),pa(e,t)};xa(n,e=>{b()&&e(i)},!0),pa(e,t)};xa(n,e=>{T()?e(i):e(a,!1)}),zt(t),pa(e,t)};xa(C,e=>{(T()||b())&&e(A)}),zt(d),kr(d,e=>$n(E,e),()=>bi(E)),zt(r),zi(e=>{var t;s=Fa(r,1,"tuanki-modal-container svelte-10l74hm",null,s,e),ja(r,`z-index: ${null!=(t=p())?t:""}`)},[()=>({centered:u(),open:n()})]),pa(e,t)};return xa(V,e=>{bi(P)&&e(q)}),pa(e,U),St(j)}ia(["click"]);var C9=(e,t)=>"Enter"===e.key&&t()(),I9=la('<div class="ai-config-backdrop svelte-1awg2ix" role="button" tabindex="0"></div>'),D9=(e,t,n)=>$n(t,bi(n).id,!0),T9=(e,t,n)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),$n(t,bi(n).id,!0))},M9=la('<span class="official-badge svelte-1awg2ix">官方</span>'),A9=la('<div role="button" tabindex="0"><span class="action-name svelte-1awg2ix"> </span> <!> <!></div>'),E9=la('<div class="official-notice svelte-1awg2ix"><!> <div class="notice-content svelte-1awg2ix"><strong class="svelte-1awg2ix">官方模板说明</strong> <p class="svelte-1awg2ix">官方模板仅作为参考示例，不会显示在AI助手菜单中。请点击"复制为自定义"按钮创建您自己的AI功能。</p></div></div>'),z9=(e,t)=>t({name:e.target.value}),P9=(e,t,n)=>t({splitConfig:bi(n).splitConfig}),R9=(e,t,n)=>t({splitConfig:bi(n).splitConfig}),$9=(e,t,n)=>t({splitConfig:bi(n).splitConfig}),O9=la('<div class="form-section form-section-split svelte-1awg2ix"><div class="section-header svelte-1awg2ix"><h4 class="section-title svelte-1awg2ix">拆分配置</h4></div> <div class="form-row"><label class="form-label svelte-1awg2ix" for="split-target-count">目标拆分数量</label> <input id="split-target-count" type="number" class="form-input svelte-1awg2ix" min="2" max="8"/></div> <div class="form-row"><label class="form-label svelte-1awg2ix" for="split-strategy-select">拆分策略</label> <select id="split-strategy-select" class="form-select svelte-1awg2ix"><option>知识点拆分</option><option>难度层次拆分</option><option>内容长度拆分</option></select></div> <div class="form-row"><label class="form-label svelte-1awg2ix" for="split-output-format-select">输出格式</label> <select id="split-output-format-select" class="form-select svelte-1awg2ix"><option>问答题</option><option>挖空题</option><option>混合格式</option></select></div></div>'),L9=(e,t,n)=>{var i,a,r,s;const o=e.target.value;if(o){const e=null==(a=null==(i=t().settings.aiConfig)?void 0:i.apiKeys)?void 0:a[o],l=null==e?void 0:e.model,c=null==(s=null==(r=nx[o])?void 0:r[0])?void 0:s.id;n({provider:o,model:l||c||void 0})}else n({provider:void 0,model:void 0})},N9=la("<option> </option>"),F9=(e,t)=>{t({model:e.target.value||void 0})},B9=la("<option> <!></option>"),j9=la('<div class="form-group svelte-1awg2ix"><label class="form-label svelte-1awg2ix" for="ai-model-select">AI模型</label> <select id="ai-model-select" class="form-select svelte-1awg2ix"></select> <div class="form-hint svelte-1awg2ix">选择该服务商下可用的AI模型</div></div>'),U9=(e,t)=>t({systemPrompt:e.target.value}),V9=(e,t)=>t({userPromptTemplate:e.target.value}),q9=la('<div class="variable-item svelte-1awg2ix"><code class="variable-code svelte-1awg2ix"> </code> <span class="variable-desc svelte-1awg2ix"> </span></div>'),H9=la('<div class="variable-help svelte-1awg2ix"><h5 class="variable-help-title svelte-1awg2ix">可用的模板变量</h5> <div class="variable-list svelte-1awg2ix"></div></div>'),W9=la('<div class="form-actions svelte-1awg2ix"><!></div>'),G9=la('<div class="edit-form svelte-1awg2ix"><!> <div class="form-section form-section-basic svelte-1awg2ix"><div class="section-header svelte-1awg2ix"><h4 class="section-title svelte-1awg2ix">基础信息</h4></div> <div class="form-group svelte-1awg2ix"><label class="form-label svelte-1awg2ix" for="action-name-input">功能名称</label> <input id="action-name-input" type="text" placeholder="请输入功能名称" class="form-input svelte-1awg2ix"/></div></div> <!> <!> <div class="form-section form-section-ai svelte-1awg2ix"><div class="section-header svelte-1awg2ix"><h4 class="section-title svelte-1awg2ix">AI服务配置</h4></div> <div class="form-group svelte-1awg2ix"><label class="form-label svelte-1awg2ix" for="ai-provider-select">AI服务商</label> <select id="ai-provider-select" class="form-select svelte-1awg2ix"><option>使用默认配置</option><!></select> <div class="form-hint svelte-1awg2ix">未选择时将使用插件设置中的默认服务商和模型</div></div> <!></div> <div class="form-section form-section-prompt svelte-1awg2ix"><div class="section-header svelte-1awg2ix"><h4 class="section-title svelte-1awg2ix">AI提示词配置</h4></div> <div class="form-group svelte-1awg2ix"><div class="label-with-help svelte-1awg2ix"><label class="form-label svelte-1awg2ix" for="system-prompt-textarea">系统提示词</label> <!></div> <textarea id="system-prompt-textarea" placeholder="定义AI的角色和行为规则..." rows="8" class="form-textarea svelte-1awg2ix"></textarea></div> <div class="form-group svelte-1awg2ix"><label class="form-label svelte-1awg2ix" for="user-prompt-textarea">用户提示词模板</label> <textarea id="user-prompt-textarea" rows="6" class="form-textarea svelte-1awg2ix"></textarea></div> <!></div> <!></div>'),Q9=la('<div class="ai-action-manager svelte-1awg2ix"><div class="top-navigation svelte-1awg2ix"><!> <div class="top-actions svelte-1awg2ix"><!> <div class="save-indicator svelte-1awg2ix"><span class="status saved svelte-1awg2ix"><!> 更改即时保存</span></div></div></div> <div class="manager-layout svelte-1awg2ix"><div class="sidebar svelte-1awg2ix"><div class="actions-list svelte-1awg2ix"><div class="list-header svelte-1awg2ix"><span class="list-title svelte-1awg2ix">功能列表</span> <span class="list-count svelte-1awg2ix"> </span></div> <div class="list-content svelte-1awg2ix"><!> <div class="new-action-section svelte-1awg2ix"><button class="new-action-btn svelte-1awg2ix" title="新建自定义功能"><!> <span> </span></button></div></div></div></div> <div class="config-editor svelte-1awg2ix"><!></div></div></div>'),K9=la("<!> <!>",1);function Z9(e,t){if(new.target)return Er({component:Z9,...e});kt(t,!0);const n=()=>Ir(hp,"$allFormatActions",r),i=()=>Ir(pp,"$allTestGenActions",r),a=()=>Ir(gp,"$allSplitActions",r),[r,s]=Dr();let o=Ar(t,"show",7),l=Ar(t,"availableDecks",7),c=Ar(t,"plugin",7),d=Ar(t,"onClose",7),u=Pn("format"),h=Pn(null),p=Pn(!1);const g=In(n),v=In(i),f=In(a);Ti(()=>{o()&&($n(h,null),$n(p,!1))});const m=In(()=>"format"===bi(u)?bi(g):"test-generator"===bi(u)?bi(v):bi(f)),y=In(()=>bi(m).find(e=>e.id===bi(h))||null),b=In(()=>"format"===bi(u)?L8:N8),w=["openai","gemini","anthropic","deepseek","zhipu","siliconflow","xai"],k=In(()=>()=>{var e;return(null==(e=bi(y))?void 0:e.provider)&&nx[bi(y).provider]||[]}),S=In(()=>()=>{var e,t,n,i,a;if(!(null==(e=bi(y))?void 0:e.provider))return"";const r=null==(n=null==(t=c().settings.aiConfig)?void 0:t.apiKeys)?void 0:n[bi(y).provider];return(null==r?void 0:r.model)||(null==(a=null==(i=nx[bi(y).provider])?void 0:i[0])?void 0:a.id)||""});function x(e){$n(u,e,!0),$n(h,null)}function _(){var e,t,n,i,a;const r=(null==(e=c().settings.aiConfig)?void 0:e.defaultProvider)||"zhipu",s=null==(n=null==(t=c().settings.aiConfig)?void 0:t.apiKeys)?void 0:n[r],o=(null==s?void 0:s.model)||(null==(a=null==(i=nx[r])?void 0:i[0])?void 0:a.id)||"",l="format"===bi(u)?"格式化":"test-generator"===bi(u)?"AI题库":"AI拆分",d={id:`custom-${bi(u)}-${Date.now()}`,name:"format"===bi(u)?"新格式化功能":"test-generator"===bi(u)?"新AI题库功能":"新AI拆分功能",icon:"sparkles",type:bi(u),systemPrompt:"你是一个专业的AI助手。",userPromptTemplate:"请处理以下内容:\n\n{{cardContent}}",provider:r,model:o,category:"custom",createdAt:(new Date).toISOString(),enabled:!0};"test-generator"===bi(u)&&(d.testConfig={defaultCount:3,questionType:"multiple",difficultyLevel:"medium",targetDeckStrategy:"auto"}),"split"===bi(u)&&(d.splitConfig={targetCount:3,splitStrategy:"knowledge-point",outputFormat:"qa"});const p=[...bi(m).filter(e=>"custom"===e.category),d];"format"===bi(u)?up.updateFormatActions(p):"test-generator"===bi(u)?up.updateTestGenActions(p):up.updateSplitActions(p),$n(h,d.id,!0),new window.Notice(`✨ 已创建新的${l}功能`)}function C(e){if(!bi(y))return;const t={...bi(y),...e,updatedAt:(new Date).toISOString()},n=bi(m).filter(e=>"custom"===e.category),i=n.findIndex(e=>e.id===bi(y).id);i>=0&&(n[i]=t,"format"===bi(u)?up.updateFormatActions(n):"test-generator"===bi(u)?up.updateTestGenActions(n):up.updateSplitActions(n))}function I(){var e,t,n,i,a;if(!bi(y)||"official"!==bi(y).category)return;const r=(null==(e=c().settings.aiConfig)?void 0:e.defaultProvider)||"zhipu",s=bi(y).provider||r,o=null==(n=null==(t=c().settings.aiConfig)?void 0:t.apiKeys)?void 0:n[s],l=(null==o?void 0:o.model)||(null==(a=null==(i=nx[s])?void 0:i[0])?void 0:a.id)||"",d={...bi(y),id:`custom-${bi(u)}-${Date.now()}`,name:`${bi(y).name} (副本)`,category:"custom",provider:s,model:bi(y).model||l,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},p=[...bi(m).filter(e=>"custom"===e.category),d];"format"===bi(u)?up.updateFormatActions(p):"test-generator"===bi(u)?up.updateTestGenActions(p):up.updateSplitActions(p),$n(h,d.id,!0),new window.Notice(`📋 已复制"${bi(y).name}"为自定义功能`)}function D(){if(confirm("确定要恢复官方默认模板吗？\n\n这将在当前功能列表中添加官方预设的AI功能模板（不会删除您的自定义功能）。"))if("format"===bi(u)){const e=new Set(bi(m).map(e=>e.id)),t=cp.filter(t=>!e.has(t.id));if(t.length>0){const e=bi(m).filter(e=>"custom"===e.category);up.updateFormatActions(e),new window.Notice(`✨ 已添加 ${t.length} 个官方格式化模板`)}else new window.Notice("所有官方格式化模板已存在")}else if("test-generator"===bi(u)){const e=new Set(bi(m).map(e=>e.id)),t=dp.filter(t=>!e.has(t.id));if(t.length>0){const e=bi(m).filter(e=>"custom"===e.category);up.updateTestGenActions(e),new window.Notice(`✨ 已添加 ${t.length} 个官方题库模板`)}else new window.Notice("所有官方题库模板已存在")}else new window.Notice("AI拆分功能暂无官方模板")}Ti(()=>{if(bi(y)&&!bi(y).model){const e=bi(S)();e&&"custom"===bi(y).category&&(_e.debug("[AIActionManager] 自动初始化model字段:",{actionId:bi(y).id,provider:bi(y).provider,model:e}),C({model:e}))}});var T={get show(){return o()},set show(e){o(e),hn()},get availableDecks(){return l()},set availableDecks(e){l(e),hn()},get plugin(){return c()},set plugin(e){c(e),hn()},get onClose(){return d()},set onClose(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},M=K9(),A=Qt(M),E=e=>{var t=I9();t.__click=function(...e){var t;null==(t=d())||t.apply(this,e)},t.__keydown=[C9,d],pa(e,t)};xa(A,e=>{o()&&e(E)}),_9(Kt(A,2),{get open(){return o()},get onClose(){return d()},size:"xl",title:"AI功能配置",zIndex:6e3,mask:!1,children:(e,t)=>{var n=Q9(),i=Gt(n),a=Gt(i);n9(a,{get activeType(){return bi(u)},get formatCount(){return bi(g).length},get testGenCount(){return bi(v).length},get splitCount(){return bi(f).length},onTypeChange:x});var r=Kt(a,2),s=Gt(r);Hg(s,{variant:"ghost",size:"sm",icon:"refresh-cw",onclick:D,ariaLabel:"恢复官方默认模板",children:(e,t)=>{Pt(),pa(e,ua("恢复官方模板"))},$$slots:{default:!0}});var o=Kt(s,2),d=Gt(o);Ng(Gt(d),{name:"zap",size:"sm"}),Pt(),zt(d),zt(o),zt(r),zt(i);var T=Kt(i,2),M=Gt(T),A=Gt(M),E=Gt(A),z=Kt(Gt(E),2),P=Gt(z,!0);zt(z),zt(E);var R=Kt(E,2),$=Gt(R);Ca($,17,()=>bi(m),_a,(e,t)=>{var n=A9();let i;n.__click=[D9,h,t],n.__keydown=[T9,h,t];var a=Gt(n),r=Gt(a,!0);zt(a);var s=Kt(a,2),o=e=>{pa(e,M9())};xa(s,e=>{"official"===bi(t).category&&e(o)});var l=Kt(s,2),c=e=>{Hg(e,{variant:"ghost",size:"xs",icon:"trash",iconOnly:!0,onclick:e=>{e.stopPropagation(),function(e){var t;const n=(null==(t=bi(m).find(t=>t.id===e))?void 0:t.name)||"此功能";if(confirm(`确定要删除"${n}"吗？`)){const t=bi(m).filter(e=>"custom"===e.category).filter(t=>t.id!==e);"format"===bi(u)?up.updateFormatActions(t):"test-generator"===bi(u)?up.updateTestGenActions(t):up.updateSplitActions(t),bi(h)===e&&$n(h,null),new window.Notice(`🗑️ 已删除"${n}"`)}}(bi(t).id)},ariaLabel:"删除功能",class:"delete-btn"})};xa(l,e=>{"custom"===bi(t).category&&e(c)}),zt(n),zi(e=>{i=Fa(n,1,"action-item svelte-1awg2ix",null,i,e),va(r,bi(t).name)},[()=>({selected:bi(h)===bi(t).id})]),pa(e,n)});var O=Kt($,2),L=Gt(O);L.__click=_;var N=Gt(L);Ng(N,{name:"plus",size:"16"});var F=Kt(N,2),B=Gt(F);zt(F),zt(L),zt(O),zt(R),zt(A),zt(M);var j=Kt(M,2),U=Gt(j),V=e=>{var t=G9(),n=Gt(t),i=e=>{var t=E9();Ng(Gt(t),{name:"info",size:"sm",variant:"primary"}),Pt(2),zt(t),pa(e,t)};xa(n,e=>{"official"===bi(y).category&&e(i)});var a=Kt(n,2),r=Kt(Gt(a),2),s=Kt(Gt(r),2);Za(s),s.__input=[z9,C],zt(r),zt(a);var o=Kt(a,2),d=e=>{g9(e,{get config(){return bi(y).testConfig},get availableDecks(){return l()},onChange:e=>C({testConfig:e})})};xa(o,e=>{"test-generator"===bi(y).type&&bi(y).testConfig&&e(d)});var u=Kt(o,2),h=e=>{var t=O9(),n=Kt(Gt(t),2),i=Kt(Gt(n),2);Za(i),i.__change=[P9,C,y],zt(n);var a=Kt(n,2),r=Kt(Gt(a),2);r.__change=[R9,C,y];var s=Gt(r);s.value=s.__value="knowledge-point";var o=Kt(s);o.value=o.__value="difficulty";var l=Kt(o);l.value=l.__value="content-length",zt(r),zt(a);var c=Kt(a,2),d=Kt(Gt(c),2);d.__change=[$9,C,y];var u=Gt(d);u.value=u.__value="qa";var h=Kt(u);h.value=h.__value="cloze";var p=Kt(h);p.value=p.__value="mixed",zt(d),zt(c),zt(t),pr(i,()=>bi(y).splitConfig.targetCount,e=>bi(y).splitConfig.targetCount=e),qa(r,()=>bi(y).splitConfig.splitStrategy,e=>bi(y).splitConfig.splitStrategy=e),qa(d,()=>bi(y).splitConfig.outputFormat,e=>bi(y).splitConfig.outputFormat=e),pa(e,t)};xa(u,e=>{"split"===bi(y).type&&bi(y).splitConfig&&e(h)});var g=Kt(u,2),v=Kt(Gt(g),2),f=Kt(Gt(v),2);f.__change=[L9,c,C];var m,x=Gt(f);x.value=x.__value="",Ca(Kt(x),17,()=>w,_a,(e,t)=>{var n=N9(),i=Gt(n,!0);zt(n);var a={};zi(()=>{var e;va(i,ix[bi(t)]),a!==(a=bi(t))&&(n.value=null!=(e=n.__value=bi(t))?e:"")}),pa(e,n)}),zt(f),Va(f),Pt(2),zt(v);var _=Kt(v,2),D=e=>{var t,n=j9(),i=Kt(Gt(n),2);i.__change=[F9,C],Ca(i,21,()=>bi(k)(),_a,(e,t)=>{var n=B9(),i=Gt(n),a=Kt(i),r=e=>{var n=ua();zi(()=>{var e;return va(n,`- ${null!=(e=bi(t).description)?e:""}`)}),pa(e,n)};xa(a,e=>{bi(t).description&&e(r)}),zt(n);var s={};zi(()=>{var e,a;va(i,`${null!=(e=bi(t).label)?e:""} `),s!==(s=bi(t).id)&&(n.value=null!=(a=n.__value=bi(t).id)?a:"")}),pa(e,n)}),zt(i),Va(i),Pt(2),zt(n),zi(e=>{var n;t!==(t=e)&&(i.value=null!=(n=i.__value=e)?n:"",Ua(i,e))},[()=>bi(y).model||bi(S)()]),pa(e,n)};xa(_,e=>{bi(y).provider&&e(D)}),zt(g);var T=Kt(g,2),M=Kt(Gt(T),2),A=Gt(M),E=Kt(Gt(A),2);{let e=In(()=>bi(p)?"chevron-up":"chevron-down");Hg(E,{variant:"ghost",size:"xs",get icon(){return bi(e)},onclick:()=>$n(p,!bi(p)),ariaLabel:"查看可用变量",children:(e,t)=>{Pt(),pa(e,ua("可用变量"))},$$slots:{default:!0}})}zt(A);var z=Kt(A,2);jn(z),z.__input=[U9,C],zt(M);var P=Kt(M,2),R=Kt(Gt(P),2);jn(R),R.__input=[V9,C],er(R,"placeholder","使用模板变量如 {{cardContent}}..."),zt(P);var $=Kt(P,2),O=e=>{var t=H9(),n=Kt(Gt(t),2);Ca(n,21,()=>Object.entries(bi(b)),_a,(e,t)=>{var n=In(()=>qe(bi(t),2));var i=q9(),a=Gt(i),r=Gt(a,!0);zt(a);var s=Kt(a,2),o=Gt(s,!0);zt(s),zt(i),zi(()=>{va(r,bi(n)[0]),va(o,bi(n)[1])}),pa(e,i)}),zt(n),zt(t),pa(e,t)};xa($,e=>{bi(p)&&bi(b)&&e(O)}),zt(T);var L=Kt(T,2),N=e=>{var t=W9();Hg(Gt(t),{variant:"primary",icon:"copy",onclick:I,children:(e,t)=>{Pt(),pa(e,ua("复制为自定义"))},$$slots:{default:!0}}),zt(t),pa(e,t)};xa(L,e=>{"official"===bi(y).category&&e(N)}),zt(t),zi(()=>{var e;Ya(s,bi(y).name),s.disabled="official"===bi(y).category,m!==(m=bi(y).provider||"")&&(f.value=null!=(e=f.__value=bi(y).provider||"")?e:"",Ua(f,bi(y).provider||"")),Ya(z,bi(y).systemPrompt),z.disabled="official"===bi(y).category,Ya(R,bi(y).userPromptTemplate),R.disabled="official"===bi(y).category}),pa(e,t)};xa(U,e=>{bi(y)&&e(V)}),zt(j),zt(T),zt(n),zi(()=>{va(P,bi(m).length),va(B,`新建${"format"===bi(u)?"格式化":"test-generator"===bi(u)?"题库":"拆分"}功能`)}),pa(e,n)},$$slots:{default:!0}}),pa(e,M);var z=St(T);return s(),z}ia(["click","keydown","input","change"]);class Y9{constructor(){oe(this,"learningRate",.05),oe(this,"validationSplit",.2),oe(this,"minDataPoints",50)}async collectBaseline(e){if(e.length<this.minDataPoints)throw new Error(`需要至少${this.minDataPoints}条历史记录才能建立基准`);const t={accuracy:this.calculatePredictionAccuracy(e),avgInterval:this.calculateAvgInterval(e),retentionRate:this.calculateRetentionRate(e),timestamp:Date.now()};return _e.debug("📊 [GradientOptimizer] 基准数据收集完成:",t),t}async optimizePhase1(e,t){_e.debug("🔬 [GradientOptimizer] 开始阶段1优化...");const n=Array.from(xs.DEFAULT_WEIGHTS),i=[...n],a=[0,1,2,3,17,18,19,20];for(const s of a){const t=this.calculateGradient(e,i,s);i[s]+=this.learningRate*t,i[s]=this.clampToSafeRange(i[s],s)}const r=await this.validateImprovement(e,n,i);return r>.05?(_e.debug(`✨ [GradientOptimizer] 优化成功，性能提升: ${(100*r).toFixed(1)}%`),i):(_e.warn("⚠️ [GradientOptimizer] 优化效果不明显，保持标准权重"),n)}async optimizePhase2(e,t){_e.debug("🚀 [GradientOptimizer] 开始阶段2优化（全参数）...");return await this.gradientBoostingOptimization(e,t,{learningRate:.8*this.learningRate,validationSplit:this.validationSplit,minDataPoints:this.minDataPoints,maxIterations:10})}async gradientBoostingOptimization(e,t,n){let i=[...t],a=[...i],r=this.calculateLoss(e,i),s=0;for(let o=0;o<n.maxIterations;o++){const t=i.map((t,n)=>this.calculateGradient(e,i,n));i=i.map((e,i)=>{const a=e+n.learningRate*t[i];return this.clampToSafeRange(a,i)});const l=this.calculateLoss(e,i);if(l<r?(r=l,a=[...i],s=0,_e.debug(`  迭代 ${o+1}: 损失 ${l.toFixed(4)}`)):s++,s>=3){_e.debug(`  早停于迭代 ${o+1}`);break}}return _e.debug(`✅ [GradientOptimizer] 优化完成，最终损失: ${r.toFixed(4)}`),a}calculateGradient(e,t,n){const i=.01,a=[...t];a[n]+=i;const r=this.calculateLoss(e,a),s=[...t];s[n]-=i;return-(r-this.calculateLoss(e,s))/.02}calculateLoss(e,t){let n=0;for(const i of e){n+=(this.predictRetention(i,t)-(i.rating>=3?1:0))**2}return n/e.length}predictRetention(e,t){const n=e.elapsedDays||0,i=e.stability||1,a=Math.exp(-n/i),r=1+.1*(t[17]||0);return Math.max(0,Math.min(1,a*r))}async validateImprovement(e,t,n){const i=this.calculateLoss(e,t);return(i-this.calculateLoss(e,n))/i}clampToSafeRange(e,t){const n=_s[`w${t}`];return n?Math.max(n.min,Math.min(n.max,e)):e}calculatePredictionAccuracy(e){let t=0;for(const n of e){const e=this.predictRetention(n,xs.DEFAULT_WEIGHTS),i=n.rating>=3?1:0;Math.round(e)===i&&t++}return t/e.length}calculateAvgInterval(e){const t=e.map(e=>e.scheduledDays||0).filter(e=>e>0);return 0===t.length?0:t.reduce((e,t)=>e+t,0)/t.length}calculateRetentionRate(e){return e.filter(e=>e.rating>=3).length/e.length}}class X9{constructor(e,t,n="default"){oe(this,"optimizer"),oe(this,"plugin"),oe(this,"storage"),oe(this,"userId"),oe(this,"personalizationData"),this.optimizer=new Y9,this.plugin=e,this.storage=t,this.userId=n,this.personalizationData={state:"baseline",lastUpdate:Date.now(),totalReviews:0}}async loadPersonalizationData(){try{const e=localStorage.getItem(`tuanki_personalization_${this.userId}`);e&&(this.personalizationData=JSON.parse(e),_e.debug("📥 [PersonalizationManager] 加载个性化数据:",this.personalizationData.state))}catch(e){_e.error("❌ [PersonalizationManager] 加载数据失败:",e)}return this.personalizationData}async savePersonalizationData(){try{localStorage.setItem(`tuanki_personalization_${this.userId}`,JSON.stringify(this.personalizationData))}catch(e){_e.error("❌ [PersonalizationManager] 保存数据失败:",e)}}async updateAfterReview(e,t){const n=t.length;this.personalizationData.totalReviews=n,50===n&&"baseline"===this.personalizationData.state?await this.executeBaselineCollection(t):100===n&&"phase1"===this.personalizationData.state?await this.executePhase1Optimization(t):n>=200&&"phase2"===this.personalizationData.state&&await this.executePhase2Optimization(t),await this.savePersonalizationData()}async executeBaselineCollection(e){try{_e.debug("📊 [PersonalizationManager] 开始收集基准数据...");const t=await this.optimizer.collectBaseline(e);this.personalizationData.baseline=t,this.personalizationData.state="phase1",this.personalizationData.lastUpdate=Date.now(),new ge.Notice("🎯 Tuanki正在学习您的记忆模式...",3e3),_e.debug("✅ [PersonalizationManager] 基准数据收集完成")}catch(t){_e.error("❌ [PersonalizationManager] 基准收集失败:",t)}}async executePhase1Optimization(e){try{if(_e.debug("🔬 [PersonalizationManager] 开始阶段1优化..."),!this.personalizationData.baseline)return void _e.warn("⚠️ [PersonalizationManager] 缺少基准数据，跳过优化");const t=await this.optimizer.optimizePhase1(e,this.personalizationData.baseline);this.personalizationData.phase1Weights=t,this.personalizationData.state="phase2",this.personalizationData.lastUpdate=Date.now(),await this.applyOptimizedWeights(t),new ge.Notice("✨ 个性化优化已激活（阶段1）",4e3),_e.debug("✅ [PersonalizationManager] 阶段1优化完成")}catch(t){_e.error("❌ [PersonalizationManager] 阶段1优化失败:",t)}}async executePhase2Optimization(e){try{_e.debug("🚀 [PersonalizationManager] 开始阶段2优化...");const t=this.personalizationData.phase1Weights||[...await this.loadOptimizedWeights()],n=await this.optimizer.optimizePhase2(e,t);this.personalizationData.phase2Weights=n,this.personalizationData.state="optimized",this.personalizationData.lastUpdate=Date.now(),await this.applyOptimizedWeights(n),new ge.Notice("🚀 个性化优化已完成（阶段2）",4e3),_e.debug("✅ [PersonalizationManager] 阶段2优化完成")}catch(t){_e.error("❌ [PersonalizationManager] 阶段2优化失败:",t)}}async applyOptimizedWeights(e){try{localStorage.setItem(`tuanki_optimized_weights_${this.userId}`,JSON.stringify(e)),_e.debug("✅ [PersonalizationManager] 优化权重已应用")}catch(t){_e.error("❌ [PersonalizationManager] 应用权重失败:",t)}}async loadOptimizedWeights(){try{const e=localStorage.getItem(`tuanki_optimized_weights_${this.userId}`);if(e)return JSON.parse(e)}catch(e){_e.error("❌ [PersonalizationManager] 加载权重失败:",e)}return[...Array(21)].map((e,t)=>[.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,.1542][t]||1)}async saveBaseline(e){this.personalizationData.baseline=e,await this.savePersonalizationData()}getOptimizationState(){return this.personalizationData.state}getOptimizationProgress(){const{state:e,totalReviews:t}=this.personalizationData;let n=0,i=50;return"baseline"===e?(n=25*Math.min(t/50,1),i=50):"phase1"===e?(n=25+25*Math.min((t-50)/50,1),i=100):"phase2"===e?(n=50+25*Math.min((t-100)/100,1),i=200):(n=100,i=200),{state:e,progress:n,nextMilestone:i}}async getOptimizationComparison(e){let t=0;if(this.personalizationData.baseline)t=this.personalizationData.baseline.accuracy;else if(e.length>=50){t=(await this.optimizer.collectBaseline(e.slice(0,50))).accuracy}const n=await this.optimizer.calculatePredictionAccuracy(e);let i=0;return t>0?i=(n-t)/t*100:n>0&&(i=100*n),{baselineAccuracy:100*t,optimizedAccuracy:100*n,improvement:Math.max(0,i)}}async resetPersonalization(){this.personalizationData={state:"baseline",lastUpdate:Date.now(),totalReviews:0},await this.savePersonalizationData(),localStorage.removeItem(`tuanki_optimized_weights_${this.userId}`),new ge.Notice("🔄 个性化数据已重置",3e3),_e.debug("🔄 [PersonalizationManager] 个性化数据已重置")}}class J9{constructor(){oe(this,"historyCheckpoints",new Map),oe(this,"performanceWindow",20),oe(this,"maxCheckpoints",5),oe(this,"performanceThreshold",.1)}createCheckpoint(e,t,n){if(this.historyCheckpoints.set(e,{weights:[...t],performance:{...n},timestamp:Date.now(),reviewCount:e}),_e.debug(`📍 [BacktrackingStrategy] 创建检查点 #${e}:`,{accuracy:n.predictionAccuracy.toFixed(3),retention:n.retentionRate.toFixed(3)}),this.historyCheckpoints.size>this.maxCheckpoints){const e=Math.min(...this.historyCheckpoints.keys());this.historyCheckpoints.delete(e),_e.debug(`🗑️ [BacktrackingStrategy] 删除旧检查点 #${e}`)}}async detectAndBacktrack(e){const t=Array.from(this.historyCheckpoints.values()).sort((e,t)=>t.reviewCount-e.reviewCount);if(t.length<2)return _e.debug("ℹ️ [BacktrackingStrategy] 检查点不足，跳过回溯检测"),null;const n=t[1],i=e.predictionAccuracy,a=n.performance.predictionAccuracy,r=a-i;if(_e.debug("📊 [BacktrackingStrategy] 性能对比:",{current:i.toFixed(3),previous:a.toFixed(3),drop:r.toFixed(3)}),r>this.performanceThreshold)return _e.warn(`⚠️ [BacktrackingStrategy] 检测到性能下降 ${(100*r).toFixed(1)}%，执行回溯`),n.weights;const s=this.findMostStableCheckpoint(e);return s&&s!==n?(_e.debug(`🎯 [BacktrackingStrategy] 找到更稳定的检查点 #${s.reviewCount}`),s.weights):null}findMostStableCheckpoint(e){const t=Array.from(this.historyCheckpoints.values());if(0===t.length)return null;const n=t.sort((e,t)=>{const n=this.calculateStabilityScore(e.performance);return this.calculateStabilityScore(t.performance)-n})[0],i=this.calculateStabilityScore(e);return this.calculateStabilityScore(n.performance)>i+this.performanceThreshold?n:null}calculateStabilityScore(e){return.7*e.predictionAccuracy+.3*e.retentionRate}applyDecayToCheckpoint(e,t,n=.7){return _e.debug(`🔄 [BacktrackingStrategy] 应用衰减策略 (因子: ${n})`),e.map((e,i)=>e*n+t[i]*(1-n))}calculateAdaptiveDecayFactor(e,t){const n=this.calculateStabilityScore(e)-this.calculateStabilityScore(t);return n>.2?.9:n>.15?.8:n>.1?.7:.5}getCheckpointHistory(){return Array.from(this.historyCheckpoints.values()).sort((e,t)=>e.reviewCount-t.reviewCount)}clearCheckpoints(){this.historyCheckpoints.clear(),_e.debug("🗑️ [BacktrackingStrategy] 已清除所有检查点")}getStatistics(){const e=Array.from(this.historyCheckpoints.values());if(0===e.length)return{totalCheckpoints:0,oldestCheckpoint:0,newestCheckpoint:0,avgAccuracy:0,avgRetention:0};const t=e.map(e=>e.performance.predictionAccuracy),n=e.map(e=>e.performance.retentionRate),i=e.map(e=>e.reviewCount);return{totalCheckpoints:e.length,oldestCheckpoint:Math.min(...i),newestCheckpoint:Math.max(...i),avgAccuracy:t.reduce((e,t)=>e+t,0)/t.length,avgRetention:n.reduce((e,t)=>e+t,0)/n.length}}}class eee extends X9{constructor(e,t,n="default"){super(e,t,n),oe(this,"backtracking"),oe(this,"lastCheckpointReviewCount",0),oe(this,"checkpointInterval",50),this.backtracking=new J9}async updateAfterReview(e,t){if(!t||!Array.isArray(t))return void _e.warn("[RobustPersonalizationManager] 复习历史数据缺失，跳过个性化优化");await super.updateAfterReview(e,t);const n=t.length;n-this.lastCheckpointReviewCount>=this.checkpointInterval&&(await this.createPerformanceCheckpoint(t),this.lastCheckpointReviewCount=n);const i=await this.calculatePerformance(t),a=await this.backtracking.detectAndBacktrack(i);a&&await this.handleBacktracking(a,i,t)}async createPerformanceCheckpoint(e){const t=await this.loadOptimizedWeights(),n=await this.calculatePerformance(e),i=e.length;this.backtracking.createCheckpoint(i,t,n),_e.debug(`📍 [RobustPersonalizationManager] 创建检查点 @${i}次复习`)}async handleBacktracking(e,t,n){_e.warn("🔄 [RobustPersonalizationManager] 执行参数回溯...");const i=await this.loadOptimizedWeights(),a=this.backtracking.getCheckpointHistory(),r=a[a.length-1],s=r?this.backtracking.calculateAdaptiveDecayFactor(r.performance,t):.8,o=this.backtracking.applyDecayToCheckpoint(e,i,s);await this.applyOptimizedWeights(o),new ge.Notice(`📉 检测到学习效果波动，已自动优化参数（衰减因子: ${(100*s).toFixed(0)}%）`,4e3),_e.debug(`✅ [RobustPersonalizationManager] 回溯完成，衰减因子: ${s.toFixed(2)}`)}async calculatePerformance(e){const t=e.slice(-50);return{predictionAccuracy:this.calculatePredictionAccuracy(t),retentionRate:this.calculateRetentionRate(t),avgResponseTime:this.calculateAvgResponseTime(t),reviewCount:e.length,timestamp:Date.now()}}calculatePredictionAccuracy(e){if(0===e.length)return 0;let t=0;for(const n of e){const e=n.stability||1,i=n.elapsedDays||0,a=Math.exp(-i/e),r=n.rating>=3?1:0;(a>.5&&1===r||a<=.5&&0===r)&&t++}return t/e.length}calculateRetentionRate(e){if(0===e.length)return 0;return e.filter(e=>e.rating>=3).length/e.length}calculateAvgResponseTime(e){return 5e3}async applyOptimizedWeights(e){try{localStorage.setItem("tuanki_optimized_weights_default",JSON.stringify(e)),_e.debug("✅ [RobustPersonalizationManager] 优化权重已应用")}catch(t){_e.error("❌ [RobustPersonalizationManager] 应用权重失败:",t)}}getBacktrackingStatistics(){return this.backtracking.getStatistics()}async resetPersonalization(){await super.resetPersonalization(),this.backtracking.clearCheckpoints(),this.lastCheckpointReviewCount=0,_e.debug("🔄 [RobustPersonalizationManager] 包括回溯数据在内的所有数据已重置")}}class tee{constructor(){oe(this,"undoStack",[]),oe(this,"MAX_STACK_SIZE",10),_e.debug("[ReviewUndoManager] 初始化撤销管理器")}saveSnapshot(e){try{if(!e.cardSnapshot.fsrs)throw new Error("[ReviewUndoManager] 卡片缺少FSRS数据，无法保存快照");const t={cardIndex:e.cardIndex,cardId:e.cardId,cardSnapshot:{fsrs:JSON.parse(JSON.stringify(e.cardSnapshot.fsrs)),reviewHistory:JSON.parse(JSON.stringify(e.cardSnapshot.reviewHistory||[])),stats:JSON.parse(JSON.stringify(e.cardSnapshot.stats)),modified:e.cardSnapshot.modified},sessionSnapshot:{cardsReviewed:e.sessionSnapshot.cardsReviewed,newCardsLearned:e.sessionSnapshot.newCardsLearned,correctAnswers:e.sessionSnapshot.correctAnswers,totalTime:e.sessionSnapshot.totalTime},reviewInfo:{rating:e.reviewInfo.rating,timestamp:e.reviewInfo.timestamp,responseTime:e.reviewInfo.responseTime}};this.undoStack.push(t),this.undoStack.length>this.MAX_STACK_SIZE&&(this.undoStack.shift(),_e.debug("[ReviewUndoManager] 撤销栈已满，移除最早的快照")),_e.debug(`[ReviewUndoManager] 保存快照成功，当前栈大小: ${this.undoStack.length}`)}catch(t){_e.error("[ReviewUndoManager] 保存快照失败:",t)}}undo(){if(0===this.undoStack.length)return _e.warn("[ReviewUndoManager] 撤销栈为空，无法撤销"),null;const e=this.undoStack.pop();return _e.debug(`[ReviewUndoManager] 撤销操作，剩余快照: ${this.undoStack.length}`),e||null}canUndo(){return this.undoStack.length>0}getUndoCount(){return this.undoStack.length}clear(){const e=this.undoStack.length;this.undoStack=[],_e.debug(`[ReviewUndoManager] 清空撤销栈，已清除 ${e} 个快照`)}getStackInfo(){return{size:this.undoStack.length,maxSize:this.MAX_STACK_SIZE,snapshots:this.undoStack.map(e=>({cardId:e.cardId,rating:e.reviewInfo.rating,timestamp:e.reviewInfo.timestamp}))}}}class nee{constructor(e){this.dataStorage=e}async createChildCards(e,t,n=DerivationMethod.AI_SPLIT){const i=(new Date).toISOString(),a=[];for(let r=0;r<t.length;r++){const s=t[r],o={id:Gu(),uuid:Vu(),deckId:e.deckId,templateId:e.templateId,type:e.type,content:s.content,fields:s.fields||{},tags:s.tags||e.tags||[],sourceFile:e.sourceFile,sourceBlock:e.sourceBlock,sourceRange:e.sourceRange,priority:s.priority||e.priority||0,fsrs:{due:i,stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:0,retrievability:0},reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},created:i,modified:i,parentCardId:e.uuid,relationMetadata:{isParent:!1,level:1,siblingIndex:r,derivationMetadata:{method:n,splitTimestamp:i,originalContentHash:this.hashContent(e.content)},learningStrategy:{requireParentMastery:!1,reviewTogether:!1,inheritTags:!0},relationStatus:{isSynced:!0,lastSyncCheck:i}}};a.push(o)}return e.relationMetadata||(e.relationMetadata={isParent:!0,childCardIds:[],level:0}),e.relationMetadata.isParent=!0,e.relationMetadata.childCardIds=a.map(e=>e.uuid),a}async getOrCreateChildDeck(e){var t;const n=await this.dataStorage.getAllDecks();if(null==(t=e.metadata)?void 0:t.pairedChildDeck){const t=n.find(t=>{var n;return t.id===(null==(n=e.metadata)?void 0:n.pairedChildDeck)});if(t)return t}const i=`${e.name} - 子卡片`,a={id:Gu(),name:i,description:`${e.name}的子卡片牌组`,cards:[],createdAt:(new Date).toISOString(),metadata:{pairedParentDeck:e.id,deckType:"child"}};return await this.dataStorage.saveDeck(a),e.metadata=e.metadata||{},e.metadata.pairedChildDeck=a.id,await this.dataStorage.saveDeck(e),a}async saveChildCardsToDeck(e,t){const n=(await this.dataStorage.getAllDecks()).find(e=>e.id===t.deckId);if(!n)throw new Error("找不到父卡片所在的牌组");const i=await this.getOrCreateChildDeck(n);for(const a of e)a.deckId=i.id;for(const a of e)await this.dataStorage.saveCard(a);return await this.dataStorage.saveCard(t),e.length}async getChildCards(e){const t=(await this.dataStorage.getAllCards()).filter(t=>t.parentCardId===e);return _e.debug(`[CardRelationService] 找到${t.length}张子卡片（父卡片: ${e.slice(0,8)}...）`),t}async updateChildCard(e){return e.modified=(new Date).toISOString(),await this.dataStorage.saveCard(e),_e.debug(`[CardRelationService] 更新子卡片: ${e.id}`),e}hashContent(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t.toString(36)}}function iee(e){const t=e-1;return t*t*t+1}function aee(e,t,n,i){t()||n()||i()()}var ree=la('<div class="regenerating-indicator svelte-km1fc5"><div class="regenerating-text svelte-km1fc5"><span class="regenerating-icon svelte-km1fc5">🔄</span> <span class="svelte-km1fc5">正在重新生成...</span></div> <div class="regenerating-progress svelte-km1fc5"><div class="regenerating-progress-bar svelte-km1fc5"></div></div></div>'),see=la('<span class="card-label svelte-km1fc5"> </span>'),oee=la('<button type="button"><!></button>');function lee(e,t){if(new.target)return Er({component:lee,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"index",7),a=Ar(t,"selected",7),r=Ar(t,"regenerating",7,!1),s=Ar(t,"disabled",7,!1),o=Ar(t,"onclick",7);const l=In(()=>()=>{var e;if(!n().content)return"";const t=n().content.trim(),i=t.indexOf("---div---");let a="",r="";return i>=0?(a=t.substring(0,i).trim(),r=t.substring(i+9).trim()):(a=t,r=""),a=a.replace(/<[^>]*>/g,"").trim(),r=r.replace(/<[^>]*>/g,"").trim(),a&&r?`${a}\n\n---\n\n${r}`:a||(r||((null==(e=n().content)?void 0:e.replace(/<[^>]*>/g,"").trim())||""))});var c={get card(){return n()},set card(e){n(e),hn()},get index(){return i()},set index(e){i(e),hn()},get selected(){return a()},set selected(e){a(e),hn()},get regenerating(){return r()},set regenerating(e=!1){r(e),hn()},get disabled(){return s()},set disabled(e=!1){s(e),hn()},get onclick(){return o()},set onclick(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},d=oee();let u;d.__click=[aee,s,r,o];var h=Gt(d),p=e=>{pa(e,ree())},g=e=>{var t=see(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>bi(l)()]),pa(e,t)};return xa(h,e=>{r()?e(p):e(g,!1)}),zt(d),zi(e=>{u=Fa(d,1,"child-card-mini svelte-km1fc5",null,u,e),ja(d,`animation-delay: ${.05*i()}s`)},[()=>({selected:a(),regenerating:r(),disabled:s()})]),pa(e,d),St(c)}ia(["click"]);var cee=la('<div class="child-cards-overlay svelte-yz5kdx"><div class="child-cards-scroll-container svelte-yz5kdx"></div></div>');function dee(e,t){if(new.target)return Er({component:dee,...e});kt(t,!0);let n=Ar(t,"childCards",7),i=Ar(t,"regeneratingCardIds",23,()=>new Set),a=Ar(t,"isRegenerating",7,!1),r=Pn(Ot(new Set));var s={getSelectedCardIds:function(){return Array.from(bi(r))},clearSelection:function(){bi(r).clear(),$n(r,new Set(bi(r)),!0)},get childCards(){return n()},set childCards(e){n(e),hn()},get regeneratingCardIds(){return i()},set regeneratingCardIds(e=new Set){i(e),hn()},get isRegenerating(){return a()},set isRegenerating(e=!1){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=ha(),l=Qt(o),c=e=>{var t=cee(),s=Gt(t);Ca(s,21,n,_a,(e,t,n)=>{{let s=In(()=>bi(r).has(bi(t).uuid)),o=In(()=>i().has(bi(t).uuid)),l=In(()=>a()&&!i().has(bi(t).uuid));lee(e,{get card(){return bi(t)},index:n,get selected(){return bi(s)},get regenerating(){return bi(o)},get disabled(){return bi(l)},onclick:()=>{return e=bi(t).uuid,bi(r).has(e)?bi(r).delete(e):bi(r).add(e),void $n(r,new Set(bi(r)),!0);var e}})}}),zt(s),zt(t),ur(3,t,()=>k7,()=>({duration:300,easing:iee})),pa(e,t)};return xa(l,e=>{n().length>0&&e(c)}),pa(e,o),St(s)}function uee(e,t){"Escape"===e.key&&(e.preventDefault(),t()())}var hee=e=>e.stopPropagation(),pee=la('<div class="card-debug-backdrop svelte-1wr8cxx"><div class="card-debug-container svelte-1wr8cxx" role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="card-debug-title"><div class="card-debug-header svelte-1wr8cxx"><h3 id="card-debug-title" class="svelte-1wr8cxx">🔍 卡片数据结构</h3> <button class="card-debug-close svelte-1wr8cxx">×</button></div> <div class="card-debug-content svelte-1wr8cxx"><pre class="card-debug-json svelte-1wr8cxx"> </pre></div></div></div>');function gee(e,t){if(new.target)return Er({component:gee,...e});kt(t,!0);let n=Ar(t,"card",7),i=Ar(t,"onClose",7);const a=JSON.stringify(n(),null,2);var r={get card(){return n()},set card(e){n(e),hn()},get onClose(){return i()},set onClose(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=pee();s.__click=function(...e){var t;null==(t=i())||t.apply(this,e)},s.__keydown=[uee,i];var o=Gt(s);o.__click=[hee];var l=Gt(o);Kt(Gt(l),2).__click=function(...e){var t;null==(t=i())||t.apply(this,e)},zt(l);var c=Kt(l,2),d=Gt(c),u=Gt(d,!0);return zt(d),zt(c),zt(o),zt(s),zi(()=>va(u,a)),pa(e,s),St(r)}ia(["click","keydown"]);var vee=(e,t)=>{var n,i;const a=null==(n=e.target)?void 0:n.value;null==(i=t())||i(a)},fee=la("<option> </option>"),mee=la('<div class="deck-selector svelte-ypv19o"><label for="deck-select" class="svelte-ypv19o">导入到记忆牌组：</label> <select id="deck-select" class="deck-select svelte-ypv19o"><option>选择牌组...</option><!></select></div>'),yee=la('<div class="flex-spacer svelte-ypv19o"></div> <!> <button class="action-btn secondary svelte-ypv19o" type="button"><!> <span> </span></button> <button class="action-btn primary svelte-ypv19o" type="button"><!> <span> </span></button> <button class="action-btn primary svelte-ypv19o" type="button"><!> <span> </span></button>',1),bee=la('<div class="unified-actions-bar svelte-ypv19o"><!></div>');function wee(e,t){if(new.target)return Er({component:wee,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"showChildOverlay",7),s=Ar(t,"selectedCount",7),o=Ar(t,"onReturn",7),l=Ar(t,"onRegenerate",7),c=Ar(t,"onSave",7),d=Ar(t,"canUndo",7,!1),u=Ar(t,"onUndo",7),h=Ar(t,"isRegenerating",7,!1),p=Ar(t,"showDeckSelector",7,!1),g=Ar(t,"availableDecks",23,()=>[]),v=Ar(t,"selectedDeckId",7,""),f=Ar(t,"onDeckChange",7),m=In(n);var y={get showChildOverlay(){return r()},set showChildOverlay(e){r(e),hn()},get selectedCount(){return s()},set selectedCount(e){s(e),hn()},get onReturn(){return o()},set onReturn(e){o(e),hn()},get onRegenerate(){return l()},set onRegenerate(e){l(e),hn()},get onSave(){return c()},set onSave(e){c(e),hn()},get canUndo(){return d()},set canUndo(e=!1){d(e),hn()},get onUndo(){return u()},set onUndo(e){u(e),hn()},get isRegenerating(){return h()},set isRegenerating(e=!1){h(e),hn()},get showDeckSelector(){return p()},set showDeckSelector(e=!1){p(e),hn()},get availableDecks(){return g()},set availableDecks(e=[]){g(e),hn()},get selectedDeckId(){return v()},set selectedDeckId(e=""){v(e),hn()},get onDeckChange(){return f()},set onDeckChange(e){f(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},b=bee(),w=Gt(b),k=e=>{var t=yee(),n=Kt(Qt(t),2),i=e=>{var t=mee(),n=Kt(Gt(t),2);n.__change=[vee,f];var i,a=Gt(n);a.value=a.__value="",Ca(Kt(a),17,g,_a,(e,t)=>{var n=fee(),i=Gt(n,!0);zt(n);var a={};zi(()=>{var e;va(i,bi(t).name),a!==(a=bi(t).id)&&(n.value=null!=(e=n.__value=bi(t).id)?e:"")}),pa(e,n)}),zt(n),Va(n),zt(t),zi(()=>{var e;i!==(i=v())&&(n.value=null!=(e=n.__value=v())?e:"",Ua(n,v()))}),pa(e,t)};xa(n,e=>{p()&&g().length>0&&e(i)});var a=Kt(n,2);a.__click=function(...e){var t;null==(t=o())||t.apply(this,e)};var r=Gt(a);Ng(r,{name:"arrow-left",size:"18"});var d=Kt(r,2),u=Gt(d,!0);zt(d),zt(a);var y=Kt(a,2);y.__click=function(...e){var t;null==(t=l())||t.apply(this,e)};var b=Gt(y);Ng(b,{name:"refresh-cw",size:"18"});var w=Kt(b,2),k=Gt(w,!0);zt(w),zt(y);var S=Kt(y,2);S.__click=function(...e){var t;null==(t=c())||t.apply(this,e)};var x=Gt(S);Ng(x,{name:"save",size:"18"});var _=Kt(x,2),C=Gt(_,!0);zt(_),zt(S),zi((e,t,n)=>{va(u,e),y.disabled=h(),er(y,"title",h()?"正在重新生成，请稍候...":""),va(k,t),S.disabled=0===s()||h()||p()&&!v(),er(S,"title",h()?"正在重新生成，请稍候...":p()&&!v()?"请先选择目标牌组":""),va(C,n)},[()=>bi(m)("studyInterface.actions.return"),()=>bi(m)("studyInterface.actions.regenerate"),()=>bi(m)("studyInterface.actions.collect").replace("{n}",String(s()))]),pa(e,t)};xa(w,e=>{r()&&e(k)}),zt(b),pa(e,b);var S=St(y);return a(),S}function kee(e,t,n=!1,i,a){if(!e)return e;let r=e;const s=/==(.*?)==/g;r=n?r.replace(s,'<span class="cloze-answer">$1</span>'):r.replace(s,'<span class="cloze-placeholder">[...]</span>');const o=/\{\{c(\d+)::(.*?)(?:::(.*?))?\}\}/g;return r=n||"back"===t?r.replace(o,'<span class="cloze-answer">$2</span>'):r.replace(o,(e,t,n,i)=>i?`<span class="cloze-placeholder" title="${i}">[${i}]</span>`:'<span class="cloze-placeholder">[...]</span>'),r}function See(e){return e&&Array.isArray(e)?e.filter(e=>!function(e){if(!e)return!1;const t=[lo,co];if(e.tags&&Array.isArray(e.tags)&&e.tags.some(e=>t.includes(xS(e))))return!0;if(e.content&&"string"==typeof e.content&&ep.extractTags(e.content).some(e=>t.includes(e)))return!0;return!1}(e)):[]}function xee(e){var t;if(!e)return!1;if(null==(t=e.metadata)?void 0:t.recycleInfo)return e.metadata.recycleInfo.status!==ho.REACTIVATED;const n=[so,oo,lo,co];if(e.tags&&Array.isArray(e.tags)){if(e.tags.some(e=>n.includes(xS(e))))return!0}if(e.content&&"string"==typeof e.content){if(ep.extractTags(e.content).some(e=>n.includes(e)))return!0}return!1}function _ee(e,t=!0){var n,i;e||(e="");const a=t?so:oo,r=ep.extractTags(e);if(r.includes(a)||r.includes(so)||r.includes(oo))return e;const s=e.split("\n");let o=0;if("---"===(null==(n=s[0])?void 0:n.trim())){const e=s.findIndex((e,t)=>t>0&&"---"===e.trim());if(e>0)return o=e+1,s.splice(o,0,"",`#${a}`,""),s.join("\n")}return(null==(i=s[0])?void 0:i.match(/^#{1,6}\s/))?(s.splice(1,0,"",`#${a}`,""),s.join("\n")):`#${a}\n\n${e}`}async function Cee(e,t=uo.MANUAL,n=5){var i;if(!e)return;e.content=_ee(e.content||"",!0),e.tags||(e.tags=[]);const a=so;if(e.tags.includes(a)||e.tags.includes(`#${a}`)||e.tags.push(a),e.metadata||(e.metadata={}),e.metadata.recycleInfo={recycledAt:(new Date).toISOString(),reasons:[t],severity:n,status:ho.PENDING,manual:t===uo.MANUAL,originalDue:null==(i=e.fsrs)?void 0:i.due},e.fsrs){const t=new Date;t.setFullYear(t.getFullYear()+10),e.fsrs.due=t.toISOString()}e.modified=(new Date).toISOString()}function Iee(e=!0){return`#${e?so:oo}`}function Dee(e){return e&&Array.isArray(e)?e.filter(e=>!xee(e)):[]}ia(["change","click"]);const Tee=Object.freeze(Object.defineProperty({__proto__:null,filterRecycledCards:Dee,getRecycleTagText:Iee,insertRecycleTag:_ee,isRecycled:xee,recycleCard:Cee},Symbol.toStringTag,{value:"Module"}));class Mee{constructor(e){this.cardStore=e}getTodaysInstances(e,t={}){const{onlyDue:n=!0,now:i=Date.now()}=t;return r8(e)?[]:s8(e)?this.getChildCardInstances(e,n,i):this.getBasicCardInstances(e,n,i)}getChildCardInstances(e,t,n){if(!e.fsrs)return _e.warn(`[CardInstanceProvider] Child card missing FSRS data: ${e.uuid}`),[];if(this.cardStore&&this.hasSiblingStudiedToday(e))return[];if(t&&0!==e.fsrs.state){if(this.parseDueTime(e.fsrs.due)>n)return[]}return[e]}getBasicCardInstances(e,t,n){if(!e.fsrs)return[];if(t&&0!==e.fsrs.state){if(this.parseDueTime(e.fsrs.due)>n)return[]}return[e]}parseDueTime(e){return"number"==typeof e?e:"string"==typeof e?Date.parse(e):e.getTime()}hasSiblingStudiedToday(e){if(!this.cardStore)return!1;const t=this.cardStore.getCard(e.parentCardId);if(!t||!r8(t))return!1;const n=this.cardStore.getCards(t.progressiveCloze.childCardIds).filter(t=>s8(t)&&t.uuid!==e.uuid),i=(new Date).setHours(0,0,0,0),a=(new Date).setHours(23,59,59,999);return n.some(e=>{var t;if(!s8(e)||!(null==(t=e.fsrs)?void 0:t.lastReview))return!1;const n=new Date(e.fsrs.lastReview).getTime();return n>=i&&n<=a})}canStudyToday(e){return this.getTodaysInstances(e,{onlyDue:!0}).length>0}getBatchInstances(e,t={}){const n=[];for(const i of e){const e=this.getTodaysInstances(i,t);n.push(...e)}return n}}const Aee=Object.freeze(Object.defineProperty({__proto__:null,CardInstanceProvider:Mee},Symbol.toStringTag,{value:"Module"}));class Eee{constructor(e){oe(this,"provider"),this.provider=new Mee(e)}performQuickFix(e){_e.warn("[StudyQueueGenerator] performQuickFix is deprecated in V2")}generateQueuePure(e,t=!0){const n=[];let i=0,a=0,r=0;for(const o of e)try{const e=this.provider.getTodaysInstances(o,{onlyDue:t});if(0===e.length){r8(o)&&r++;continue}n.push(e[0]),s8(e[0])?i++:a++}catch(s){_e.error(`[StudyQueueGenerator] 处理卡片失败: ${o.uuid}`,s);continue}return _e.debug(`[StudyQueueGenerator V2] 队列生成完成:\n      - 输入卡片数: ${e.length}\n      - 跳过父卡片: ${r}\n      - 普通卡片: ${a}\n      - 子卡片: ${i}\n      - 队列总数: ${n.length}\n      ✅ 所有实例都是真实Card对象`),n}filterQueue(e,t){return e.filter(e=>{if(t.excludeProgressiveCloze&&s8(e))return!1;if(t.excludeNormalCards&&!s8(e))return!1;const n=e.tags||[];if(t.includeTags&&t.includeTags.length>0){if(!t.includeTags.some(e=>n.includes(e)))return!1}if(t.excludeTags&&t.excludeTags.length>0){if(t.excludeTags.some(e=>n.includes(e)))return!1}return!0})}shuffleQueue(e){const t=[...e];for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return t}sortByPriority(e){return[...e].sort((e,t)=>{try{const n=e.fsrs,i=t.fsrs;if(!n||!i)return 0;const a=new Date(n.due),r=new Date(i.due);return a.getTime()-r.getTime()}catch(n){return _e.error("[StudyQueueGenerator] 排序失败:",n),0}})}getQueueStats(e){const t=new Set;let n=0,i=0;for(const a of e)s8(a)?(i++,t.add(a.parentCardId)):n++;return{total:e.length,normalCards:n,childCards:i,uniqueParentCards:t.size}}generateQueue(e){return this.generateQueuePure(e)}}const zee=200,Pee=48,Ree=80,$ee=400,Oee=300,Lee=5e3,Nee=50,Fee=.9,Bee=.1,jee=.1,Uee=.8,Vee=.2,qee=.8,Hee=.2,Wee={CARD_OPERATION:"[StudyInterface:Card]",AI_OPERATION:"[StudyInterface:AI]",ERROR_BOOK:"[StudyInterface:ErrorBook]",SUSPEND:"[StudyInterface:Suspend]",REMINDER:"[StudyInterface:Reminder]",PRIORITY:"[StudyInterface:Priority]",FORMAT:"[StudyInterface:Format]",CHILD_CARDS:"[StudyInterface:ChildCards]",UNDO:"[StudyInterface:Undo]",SESSION:"[StudyInterface:Session]"};async function Gee(e,t,n={}){const{operation:i="保存卡片",showSuccessNotice:a=!1,successMessage:r,showErrorNotice:s=!0,errorMessage:o}=n;try{const n=await t.saveCard(e);if(n.success)return a&&r&&new ge.Notice(r),{success:!0,card:e};{const e=n.error||"未知错误";return s&&new ge.Notice(o||`❌ ${i}失败: ${e}`),_e.error(`${Wee.CARD_OPERATION} ${i}失败:`,e),{success:!1,error:e}}}catch(l){const e=l instanceof Error?l.message:String(l);return s&&new ge.Notice(o||`❌ ${i}失败`),_e.error(`${Wee.CARD_OPERATION} ${i}异常:`,l),{success:!1,error:e}}}function Qee(e){return e?!!e.uuid||(_e.warn(`${Wee.CARD_OPERATION} 卡片缺少uuid`,e),!1):(_e.warn(`${Wee.CARD_OPERATION} 卡片为null或undefined`),!1)}function Kee(e,t,n){$n(t,!1),$n(n,Date.now(),!0),_e.debug("撤销显示答案，返回预览状态")}async function Zee(e,t,n,i,a,r,s,o){if(bi(t)&&bi(n)&&bi(i))try{const e=new Date(`${bi(n)}T${bi(i)}`);if(e<=new Date)return void new window.Notice("复习时间必须是未来时间");const l={...bi(t),fsrs:bi(t).fsrs?{...bi(t).fsrs,due:e.toISOString()}:void 0,modified:(new Date).toISOString()};if((await a().saveCard(l)).success){const n=bi(t).uuid,i=bi(r).findIndex(e=>e.uuid===n);-1!==i&&(bi(r)[i]=l,$n(r,[...bi(r)],!0));const a=bi(s).findIndex(e=>e.uuid===n);-1!==a&&(bi(s)[a]=l,$n(s,[...bi(s)],!0)),new window.Notice(`复习时间已设置为：${e.toLocaleString()}`),$n(o,!1)}else new window.Notice("设置复习时间失败")}catch(l){_e.error("Error setting reminder:",l),new window.Notice("设置复习时间时出错")}else new window.Notice("请选择有效的日期和时间")}async function Yee(e,t,n,i,a,r,s){if(bi(t))try{const e={...bi(t),priority:bi(n),modified:(new Date).toISOString()};if((await i().saveCard(e)).success){const i=bi(t).uuid,o=bi(a).findIndex(e=>e.uuid===i);-1!==o&&(bi(a)[o]=e,$n(a,[...bi(a)],!0));const l=bi(r).findIndex(e=>e.uuid===i);-1!==l&&(bi(r)[l]=e,$n(r,[...bi(r)],!0));const c=["","低","中","高","紧急"][bi(n)]||"中";new window.Notice(`优先级已设置为：${c}`),$n(s,!1)}else new window.Notice("设置优先级失败")}catch(o){_e.error("Error changing priority:",o),new window.Notice("设置优先级时出错")}}async function Xee(e,t,n){$n(t,!1),await n(!0)}var Jee=(e,t)=>{"Escape"===e.key&&t()()},ete=e=>e.stopPropagation(),tte=e=>e.stopPropagation(),nte=(e,t)=>$n(t,!0),ite=la('<div class="stats-locked-hint svelte-1krx52u"><div class="stats-locked-content svelte-1krx52u"><span class="lock-icon svelte-1krx52u">🔒</span> <span class="lock-text svelte-1krx52u">统计情况详情</span> <button class="unlock-btn svelte-1krx52u">激活查看</button></div></div>'),ate=la('<!> <div class="card-study-container svelte-1krx52u"><div class="card-container svelte-1krx52u"><!></div></div>',1),rte=(e,t)=>"Escape"===e.key&&t(),ste=e=>e.stopPropagation(),ote=(e,t)=>"Escape"===e.key&&t(),lte=la('<div class="modal-backdrop svelte-1krx52u" role="button" tabindex="0"><div class="delete-confirm-modal svelte-1krx52u" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-header svelte-1krx52u"><h3 class="svelte-1krx52u">确认删除卡片</h3> <button class="close-btn svelte-1krx52u"><!></button></div> <div class="modal-content svelte-1krx52u"><p class="svelte-1krx52u">确定要删除卡片 <strong class="svelte-1krx52u"> </strong> 吗？</p> <p class="warning-text svelte-1krx52u">⚠️ 此操作无法撤销</p></div> <div class="modal-footer svelte-1krx52u"><button class="btn btn-secondary svelte-1krx52u">取消</button> <button class="btn btn-danger svelte-1krx52u">确认删除</button></div></div></div>'),cte=la('<div class="study-footer svelte-1krx52u"><!></div>'),dte=la('<div class="sidebar-content svelte-1krx52u"><!></div>'),ute=la('<button class="compact-control-btn return-btn svelte-1krx52u" title="返回预览状态（重新隐藏答案）" aria-label="返回预览状态"><!></button>'),hte=la('<div class="bottom-left-controls svelte-1krx52u"><!> <button><!></button></div>'),pte=(e,t)=>"Escape"===e.key&&t(),gte=e=>e.stopPropagation(),vte=(e,t)=>{"Escape"===e.key&&(e.stopPropagation(),t())},fte=(e,t,n)=>t(bi(n)),mte=(e,t,n)=>"Enter"===e.key&&t(bi(n)),yte=la('<span class="current-marker svelte-1krx52u">⭐</span>'),bte=la('<div role="button" tabindex="0"><span class="template-name svelte-1krx52u"> </span> <!></div>'),wte=la('<div class="no-templates-message svelte-1krx52u">未找到可用模板</div>'),kte=la('<div class="menu-overlay svelte-1krx52u" role="dialog" aria-modal="true" tabindex="-1"><div class="template-menu svelte-1krx52u" role="menu" tabindex="0"><div class="template-dropdown-list svelte-1krx52u"><!></div></div></div>'),Ste=(e,t)=>$n(t,!1),xte=(e,t)=>"Escape"===e.key&&$n(t,!1),_te=e=>e.stopPropagation(),Cte=(e,t)=>{"Escape"===e.key&&(e.stopPropagation(),$n(t,!1))},Ite=(e,t)=>$n(t,!1),Dte=(e,t)=>$n(t,!1),Tte=la('<div class="modal-overlay svelte-1krx52u" role="dialog" aria-modal="true" tabindex="-1"><div class="reminder-modal svelte-1krx52u" role="button" tabindex="0"><div class="modal-header svelte-1krx52u"><h3 class="svelte-1krx52u">设置复习提醒</h3> <button class="modal-close svelte-1krx52u">×</button></div> <div class="modal-body svelte-1krx52u"><p class="modal-description svelte-1krx52u">为当前卡片自定义下次复习时间：</p> <div class="form-group svelte-1krx52u"><label for="review-date" class="svelte-1krx52u">复习日期：</label> <input id="review-date" type="date" class="date-input svelte-1krx52u"/></div> <div class="form-group svelte-1krx52u"><label for="review-time" class="svelte-1krx52u">复习时间：</label> <input id="review-time" type="time" class="time-input svelte-1krx52u"/></div> <div class="warning-message svelte-1krx52u"><!> <span class="svelte-1krx52u">注意：自定义复习时间将覆盖算法计算的时间</span></div></div> <div class="modal-footer svelte-1krx52u"><button class="btn-secondary svelte-1krx52u">取消</button> <button class="btn-primary svelte-1krx52u">确认设置</button></div></div></div>'),Mte=(e,t)=>$n(t,!1),Ate=(e,t)=>"Escape"===e.key&&$n(t,!1),Ete=e=>e.stopPropagation(),zte=(e,t)=>{"Escape"===e.key&&(e.stopPropagation(),$n(t,!1))},Pte=(e,t)=>$n(t,!1),Rte=(e,t,n)=>$n(t,n,!0),$te=la('<button><div class="priority-stars svelte-1krx52u"><!> <!></div> <span class="priority-label svelte-1krx52u"> </span></button>'),Ote=(e,t)=>$n(t,!1),Lte=la('<div class="modal-overlay svelte-1krx52u" role="dialog" aria-modal="true" tabindex="-1"><div class="priority-modal svelte-1krx52u" role="button" tabindex="0"><div class="modal-header svelte-1krx52u"><h3 class="svelte-1krx52u">设置优先级</h3> <button class="modal-close svelte-1krx52u">×</button></div> <div class="modal-body svelte-1krx52u"><p class="modal-description svelte-1krx52u">选择当前卡片的重要程度：</p> <div class="priority-options svelte-1krx52u"></div></div> <div class="modal-footer svelte-1krx52u"><button class="btn-secondary svelte-1krx52u">取消</button> <button class="btn-primary svelte-1krx52u">确认设置</button></div></div></div>'),Nte=la('<div class="study-interface-overlay svelte-1krx52u" role="presentation"><div class="study-interface-content svelte-1krx52u" role="dialog" aria-modal="true" tabindex="-1"><!> <div><div class="main-study-area svelte-1krx52u"><!></div>  <!> <!> <!> <!> <!> <!> <!></div> <!></div></div>  <!> <!> <!> <!> <!> <!>',1);function Fte(e,t){var n,i,a,r,s,o,l,c,d;if(new.target)return Er({component:Fte,...e});kt(t,!0);const u=()=>Ir(Vp,"$tr",p),h=()=>Ir(vp,"$customActionsForMenu",p),[p,g]=Dr();let v=Ar(t,"cards",7),f=Ar(t,"fsrs",7),m=Ar(t,"dataStorage",7),y=Ar(t,"plugin",7),b=Ar(t,"mode",7),w=Ar(t,"onClose",7),k=Ar(t,"onComplete",7),S=Pn(Ot(See(v()))),x=In(u);const _=es.getInstance(),C=new eee(y(),m()),I=Qh.getInstance(),D=new tee;new nee(m());const T=new Eee;let M=Pn(!1);Ti(()=>{var e;if(bi(S)&&bi(S).length>0&&!bi(M))try{!bi(et).deckId&&(null==(e=bi(S)[0])?void 0:e.deckId)&&(bi(et).deckId=bi(S)[0].deckId),bi(S).forEach(e=>{T.performQuickFix(e)}),$n(M,!0),Wee.SESSION,bi(S).length}catch(t){_e.error("[StudyInterface] 卡片预处理失败:",t)}});let A=Pn(Ot([])),E=Pn(!1);Ti(()=>{if(bi(M)&&!bi(E)&&bi(S).length>0){const e="advance"!==b();$n(A,T.generateQueuePure(bi(S),e),!0),$n(E,!0);const t={total:bi(A).length,newCards:bi(A).filter(e=>{var t;return(null==(t=e.fsrs)?void 0:t.state)===Gr.New}).length,learning:bi(A).filter(e=>{var t;return(null==(t=e.fsrs)?void 0:t.state)===Gr.Learning}).length,review:bi(A).filter(e=>{var t;return(null==(t=e.fsrs)?void 0:t.state)===Gr.Review}).length,mode:b()||"normal",onlyDue:e};Wee.SESSION,_e.debug("[StudyInterface] 队列详情:",{queueLength:bi(A).length,cardIds:bi(A).map(e=>e.uuid.slice(0,8)),stats:t})}});let z=Pn(null),P=Pn(0),R=Pn(!1),$=Pn(Ot(Date.now())),O=Pn(!0),L=Pn(Ot(new Set)),N=Pn(Ot([])),F=Pn(Ot([])),B=Pn(Ot([])),j=Pn(null),U=Pn(0),V=Pn(null),q=In(()=>bi(V)?function(e){var t;return(null==(t=IS[e])?void 0:t.name)||"未知题型"}(bi(V)):"未知题型"),H=Pn(Ot(null!=(i=null==(n=y().settings.mediaAutoPlay)?void 0:n.enabled)&&i)),W=Pn(Ot(null!=(r=null==(a=y().settings.mediaAutoPlay)?void 0:a.mode)?r:"first")),G=Pn(Ot(null!=(o=null==(s=y().settings.mediaAutoPlay)?void 0:s.timing)?o:"cardChange")),Q=Pn(Ot(null!=(c=null==(l=y().settings.mediaAutoPlay)?void 0:l.playbackInterval)?c:2e3)),K=Pn(!1),Z=Pn(Ot([])),Y=Pn(!1),X=Pn(null),J=Pn(Ot(new Set)),ee=In(()=>bi(J).size>0),te=Pn(null),ne=Pn(null),ie=Pn(""),ae=In(()=>bi(N).filter(e=>{const t=e;return"question-bank"!==t.deckType&&"test"!==t.purpose})),re=In(()=>bi(ae).map(e=>({id:e.id,name:e.name}))),se=Pn(!1),oe=Pn(!1),le=Pn(!1),ce=Pn(null),de=In(()=>bi(R)?Date.now()-bi($):0);function ue(e){$n(le,e,!0),_e.debug(`[图谱联动] 状态变更: ${e}`)}function he(e){$n(ce,e,!0),_e.debug("[图谱联动] Leaf引用更新:",e?"已设置":"已清除")}function pe(e){_e.debug(`检测到卡片题型: ${e}`),$n(V,e,!0),_e.debug(`统一题型: ${bi(V)} (${bi(q)})`)}function ve(e){_e.debug("预览就绪:",e),(null==e?void 0:e.cardType)&&$n(V,e.cardType,!0)}async function fe(){if(!Qee(bi(nt)))return;bi(nt).stats.choiceStats||(bi(nt).stats.choiceStats={totalAttempts:0,correctAttempts:0,accuracy:0,averageResponseTime:0,recentAttempts:[],isInErrorBook:!1,errorCount:0}),bi(nt).stats.choiceStats.isInErrorBook=!0;(await Gee(bi(nt),m(),{operation:"加入错题集",showSuccessNotice:!0,successMessage:"✅ 已加入错题集",errorMessage:"❌ 加入错题集失败"})).success&&($n(S,[...bi(S)],!0),Wee.ERROR_BOOK,bi(nt).uuid)}async function me(){if(!Qee(bi(nt))||!bi(nt).stats.choiceStats)return;bi(nt).stats.choiceStats.isInErrorBook=!1;(await Gee(bi(nt),m(),{operation:"移出错题集",showSuccessNotice:!0,successMessage:"✅ 已移出错题集",errorMessage:"❌ 移出错题集失败"})).success&&($n(S,[...bi(S)],!0),Wee.ERROR_BOOK,bi(nt).uuid)}async function ye(e,t=0,n){var i,a,r,s,o,l,c,d,u,h;if(!bi(nt)||bi(Y))return;const p=bi(st).split.find(t=>t.id===e);if(!p)return void new window.Notice("未找到该AI拂分功能");const g=bi(nt);if(g)try{$n(Y,!0);const e=n&&n.size>0;e||new window.Notice("🤖 正在拂分卡片...");const{AIServiceFactory:f}=await Promise.resolve().then(()=>O8),m=p.provider||(null==(i=y().settings.aiConfig)?void 0:i.defaultProvider)||"openai";let b=p.model;if(!b){const e=null==(r=null==(a=y().settings.aiConfig)?void 0:a.apiKeys)?void 0:r[m];b=null==e?void 0:e.model,_e.warn(`[AI拆分] action.model为空，使用provider配置的model: ${b}`)}if(!b){b={openai:"gpt-3.5-turbo",zhipu:"glm-4-plus",deepseek:"deepseek-chat",anthropic:"claude-3-5-sonnet-20241022",gemini:"gemini-pro",siliconflow:"Qwen/Qwen2.5-7B-Instruct"}[m]||"gpt-3.5-turbo",_e.warn(`[AI拆分] provider配置的model也为空，使用默认model: ${b}`)}_e.debug("[AI拆分] 使用配置:",{actionName:p.name,actionId:p.id,provider:m,model:b,actionModelDefined:!!p.model,providerConfigModel:null==(l=null==(o=null==(s=y().settings.aiConfig)?void 0:s.apiKeys)?void 0:o[m])?void 0:l.model});const w=f.createService(m,y(),b);if(!w)throw new Error(`AI服务未配置，请在设置中配置 ${m} 的API密钥`);let k="";try{const e=new l8(y().dataStorage);k=new o8(g,e).getContent()}catch(v){_e.error("[StudyInterface] CardAccessor获取内容失败:",v),k=g.content||""}const S={parentCardId:g.uuid,content:{front:(null==(c=g.fields)?void 0:c.front)||k||"",back:(null==(d=g.fields)?void 0:d.back)||""},targetCount:t,instruction:(null==(h=null==(u=y().settings.aiConfig)?void 0:u.cardSplitting)?void 0:h.defaultInstruction)||void 0},x=await w.splitParentCard(S);if(!x.success||!x.childCards||0===x.childCards.length)throw new Error(x.error||"拆分失败");const _=x.childCards.map((e,t)=>({uuid:`temp-uuid-${Date.now()}-${t}`,deckId:g.deckId,templateId:g.templateId,type:Kr.Basic,content:e.front&&e.back?`${e.front}\n\n---div---\n\n${e.back}`:e.content||e.front||"",tags:e.tags||g.tags||[],priority:0,fsrs:{due:(new Date).toISOString(),stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:0,retrievability:0},reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},created:(new Date).toISOString(),modified:(new Date).toISOString()}));if(e&&n){const e=[...bi(Z)],t=Array.from(n.keys()).sort((e,t)=>e-t);_.forEach((n,i)=>{const a=t[i];void 0!==a&&a<e.length&&(e[a]=n)}),$n(Z,e,!0)}else $n(Z,_,!0),$n(ne,p,!0),$n(ie,g.deckId,!0),$n(K,!0),new window.Notice(`✅ 成功拆分为${bi(Z).length}张子卡片`)}catch(v){_e.error("[StudyInterface] AI拆分失败:",v);const e=v instanceof Error?v.message:"拆分失败";new window.Notice(`❌ 拆分失败: ${e}`)}finally{$n(Y,!1)}}async function be(){if(bi(nt)&&bi(X))try{const e=bi(X).getSelectedCardIds()||[],t=e.length>0,n=null!==bi(te),i=null!==bi(ne);if(t){const t=e.length,a=new Map;bi(Z).forEach((t,n)=>{e.includes(t.uuid)&&a.set(n,t.uuid)}),new window.Notice(`🔄 正在重新生成 ${t} 张选中的${n?"测试题":"卡片"}...`),$n(J,new Set(e),!0),bi(X).clearSelection(),n&&bi(te)?await we(bi(te).id,t,a):i&&bi(ne)?await ye(bi(ne).id,t,a):new window.Notice("⚠️ 无法重新生成：未找到原始配置"),new window.Notice(`✅ 已重新生成 ${t} 张${n?"测试题":"卡片"}`)}else{const e=bi(Z).length,t=new Map;bi(Z).forEach((e,n)=>{t.set(n,e.uuid)}),new window.Notice(`🔄 正在重新生成全部 ${e} 张${n?"测试题":"卡片"}...`),$n(J,new Set(bi(Z).map(e=>e.uuid)),!0),bi(X).clearSelection(),n&&bi(te)?await we(bi(te).id,e,t):i&&bi(ne)?await ye(bi(ne).id,e>0?e:0,t):new window.Notice("⚠️ 无法重新生成：未找到原始配置"),new window.Notice(`✅ 已重新生成全部 ${e} 张${n?"测试题":"卡片"}`)}}catch(e){_e.error("[StudyInterface] 重新生成失败:",e),new window.Notice("❌ 重新生成失败，已保留原卡片")}finally{$n(J,new Set,!0)}}async function we(e,t,n){if(!bi(nt))return;const i=bi(nt);if(!i)return;const a=bi(st).testGen.find(t=>t.id===e);if(!a||!a.testConfig)throw new Error("找不到指定的测试题生成功能");const{AITestGeneratorService:r}=await Promise.resolve().then(()=>H8),s=new r(y()),o={sourceCard:i,action:a,targetDeckId:void 0},l=await s.generateTests(o);if(!l.success||!l.generatedQuestions||0===l.generatedQuestions.length)throw new Error(l.error||"生成失败");const c=l.generatedQuestions.map((e,t)=>{var n,r,s;return{uuid:`temp-uuid-${Date.now()}-${t}`,deckId:i.deckId,templateId:i.templateId,type:(e.type,Kr.Basic),content:`${e.front}\n\n${e.back}`,fields:{front:e.front,back:e.back},tags:i.tags||[],priority:0,difficulty:e.difficulty||(null==(r=null==(n=bi(te))?void 0:n.testConfig)?void 0:r.difficultyLevel),cardPurpose:"test",metadata:{questionType:e.type||(null==(s=a.testConfig)?void 0:s.questionType)||"single",generatedBy:a.id,generatedAt:(new Date).toISOString(),explanation:e.explanation},fsrs:{due:(new Date).toISOString(),stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:0,retrievability:0},reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},created:(new Date).toISOString(),modified:(new Date).toISOString()}}),d=[...bi(Z)],u=Array.from(n.keys()).sort((e,t)=>e-t);c.forEach((e,t)=>{const n=u[t];void 0!==n&&n<d.length&&(d[n]=e)}),$n(Z,d,!0)}async function ke(){var e,t,n;if(bi(nt)&&0!==bi(Z).length)try{const i=(null==(t=null==(e=bi(X))?void 0:e.getSelectedCardIds)?void 0:t.call(e))||[];if(0===i.length)return void new window.Notice("⚠️ 请先选择要保存的卡片");const a=bi(Z).filter(e=>i.includes(e.uuid)),r=null!==bi(ne),s=null!==bi(te);if(r){if(!bi(ie))return void new window.Notice("⚠️ 请先选择目标记忆牌组");new window.Notice("💾 正在保存到记忆牌组...");const e=await async function(e,t,n){var i,a;try{const{generateUUID:s}=await Promise.resolve().then(()=>Xu);let o=0;for(const a of e)try{const e={...a,uuid:s(),deckId:n,cardPurpose:"memory",parentCardId:t.uuid,relationMetadata:{isParent:!1,level:1,derivationMetadata:{method:Nx.AI_SPLIT,splitTimestamp:(new Date).toISOString(),splitReason:(null==(i=bi(ne))?void 0:i.name)||"AI拆分"}},metadata:{...a.metadata,sourceCardId:t.uuid,sourceDeckId:t.deckId},created:(new Date).toISOString(),modified:(new Date).toISOString()};delete e.fields;const r=await y().dataStorage.saveCard(e);r.success?(o++,_e.debug(`[AI拆分] 已保存子卡片: ${e.uuid}`)):_e.error(`[AI拆分] 保存子卡片失败: ${r.error}`)}catch(r){_e.error("[AI拆分] 保存单张子卡片失败:",r)}if(o>0)try{const n=(null==(a=t.relationMetadata)?void 0:a.childCardIds)||[],i=e.map(e=>e.uuid),r={...t,relationMetadata:{isParent:!0,level:0,childCardIds:[...n,...i]},modified:(new Date).toISOString()};await y().dataStorage.saveCard(r),_e.debug(`[AI拆分] 已更新父卡片关系: ${t.uuid}`)}catch(r){_e.error("[AI拆分] 更新父卡片失败:",r)}return _e.debug(`[AI拆分] 成功保存${o}张子卡片到记忆牌组`),o}catch(r){throw _e.error("[AI拆分] 保存到记忆牌组失败:",r),r}}(a,bi(nt),bi(ie));new window.Notice(`✅ 成功导入${e}张子卡片到记忆牌组`)}else{if(!s)return void new window.Notice("⚠️ 无法确定保存模式");{new window.Notice("💾 正在保存到题库...");const e=await async function(e,t){var n,i,a,r,s,o,l,c;if(!y().questionBankService)throw new Error("题库服务未初始化");try{const u=await y().dataStorage.getDeck(t.deckId);if(!u)throw new Error("当前牌组不存在");const h=`${u.name} - 题库`;let p=y().questionBankService.getAllQuestionBanks().find(e=>e.name===h);p||(_e.debug(`[AI拆分] 创建新题库: ${h}`),p=await y().questionBankService.createBank({name:h,description:`从牌组"${u.name}"自动生成的题库`,tags:u.tags||[],category:u.category||"未分类",deckType:"question-bank"}));let g=0;for(const v of e)try{const{generateId:e,generateUUID:d}=await Promise.resolve().then(()=>Xu),u=(null==(n=v.metadata)?void 0:n.questionType)||"short_answer",h=v.difficulty||(null==(a=null==(i=bi(te))?void 0:i.testConfig)?void 0:a.difficultyLevel)||"medium",f="mixed"===h?"medium":h,m={uuid:d(),deckId:p.id,templateId:v.templateId,type:v.type,cardPurpose:"test",difficulty:f,content:v.content,tags:v.tags||[],priority:v.priority||0,metadata:{questionType:u,generatedBy:null==(r=v.metadata)?void 0:r.generatedBy,generatedAt:null==(s=v.metadata)?void 0:s.generatedAt,explanation:null==(o=v.metadata)?void 0:o.explanation,questionMetadata:{type:u,correctAnswer:(null==(c=null==(l=v.metadata)?void 0:l.questionMetadata)?void 0:c.correctAnswer)||""},sourceCardId:t.uuid,sourceDeckId:t.deckId},stats:{totalReviews:0,totalTime:0,averageTime:0,testStats:{totalAttempts:0,correctAttempts:0,incorrectAttempts:0,accuracy:0,bestScore:0,averageScore:0,lastScore:0,averageResponseTime:0,fastestTime:0,lastTestDate:(new Date).toISOString(),isInErrorBook:!1,consecutiveCorrect:0}},created:(new Date).toISOString(),modified:(new Date).toISOString()};await y().questionBankService.addQuestion(p.id,m),g++,_e.debug(`[测试题保存] 已添加题目到题库: ${m.uuid}, 类型: ${u}, 难度: ${f}`)}catch(d){_e.error("[测试题保存] 添加题目失败:",d)}return _e.debug(`[AI拆分] 成功保存${g}道题目到题库: ${h}`),g}catch(d){throw _e.error("[AI拆分] 保存到题库失败:",d),d}}(a,bi(nt));new window.Notice(`✅ 成功收入${e}道题目到题库`)}}$n(K,!1),$n(Z,[],!0),$n(ne,null),$n(te,null),$n(ie,""),(null==(n=bi(X))?void 0:n.clearSelection)&&bi(X).clearSelection()}catch(i){_e.error("[StudyInterface] 保存子卡片失败:",i);const e=i instanceof Error?i.message:"保存失败";new window.Notice(`❌ 保存失败: ${e}`)}}function Se(e){$n(ie,e,!0),_e.debug("[AI拆分] 选择目标牌组:",e)}function xe(){var e;$n(K,!1),$n(Z,[],!0),$n(ne,null),$n(te,null),$n(ie,""),(null==(e=bi(X))?void 0:e.clearSelection)&&bi(X).clearSelection()}function Ce(){bi(nt)&&$n(se,!0)}function Ie(){$n(se,!1)}function De(){bi(nt)&&$n(oe,!0)}function Te(){$n(oe,!1)}Ti(()=>{var e;const t=bi(nt),n=null==t?void 0:t.sourceFile;bi(le)&&n&&(_e.debug("[图谱联动] 检测到卡片切换，同步图谱到:",{cardId:null==(e=null==t?void 0:t.uuid)?void 0:e.slice(0,8),sourceFile:n,cardIndex:bi(P)}),async function(e){try{if(!bi(ce))return void _e.warn("[图谱同步] 未找到专属图谱视图引用，请先开启图谱联动");await bi(ce).setViewState({type:"localgraph",state:{file:e}}),_e.debug("[图谱同步] 图谱已切换到:",e)}catch(t){_e.error("[图谱同步] 同步失败:",t)}}(n))});const Me=y().settings.studyInterfaceViewPreferences||{showSidebar:!0,sidebarCompactModeSetting:"auto",statsCollapsed:!0};if(!y().settings.studyInterfaceViewPreferences&&"undefined"!=typeof window)try{const e=localStorage.getItem("tuanki-sidebar-compact-mode-setting");!e||"auto"!==e&&"fixed"!==e||(Me.sidebarCompactModeSetting=e,_e.debug("从localStorage迁移紧凑模式设置:",e))}catch(di){_e.debug("[StudyInterface] 恢复localStorage设置失败:",di)}let Ae=Pn(Ot(Me.showSidebar)),Ee=Pn(Ot(Me.statsCollapsed)),ze=Pn(!1),Pe=Pn(Ot(null!=(d=y().settings.enableDirectDelete)&&d)),Re=Pn(!1),$e=Pn(""),Oe=Pn(!1),Le=null,Ne=null,Fe=Pn(null),Be={width:0,height:0},je=Pn(Ot(Me.sidebarCompactModeSetting));Ti(()=>{bi(Ae)&&("auto"===bi(je)?setTimeout(()=>{mn()},100):"fixed"===bi(je)&&($n(Oe,!0),$n(Fe,!0)))});let Ue=null;Ti(()=>(bi(Ae),bi(je),bi(Ee),null!==Ue&&clearTimeout(Ue),Ue=window.setTimeout(()=>{!async function(){try{y().settings.studyInterfaceViewPreferences||(y().settings.studyInterfaceViewPreferences={}),y().settings.studyInterfaceViewPreferences.showSidebar=bi(Ae),y().settings.studyInterfaceViewPreferences.sidebarCompactModeSetting=bi(je),y().settings.studyInterfaceViewPreferences.statsCollapsed=bi(Ee),await y().saveSettings(),_e.debug("✅ 学习界面视图偏好已保存到 plugin.settings")}catch(di){_e.error("[StudyInterface] ❌ 保存视图偏好失败:",di)}}(),Ue=null},300),()=>{null!==Ue&&clearTimeout(Ue)}));let Ve=Pn(!1),qe=Pn(null),He=Pn(""),We=Pn(!1),Ge=Pn(!1),Qe=Pn(!1);function Ke(e,t){var n;try{if(!e)return _e.warn("getFieldContent: card is null/undefined"),`<div class="field-container error-field"><div class="field-label">${bi(x)("studyInterface.labels.error")}</div><div class="field-content">${bi(x)("studyInterface.errors.invalidCard")}</div></div>`;if(!e.uuid)return _e.warn("getFieldContent: card has no uuid",e),`<div class="field-container error-field"><div class="field-label">${bi(x)("studyInterface.labels.error")}</div><div class="field-content">${bi(x)("studyInterface.errors.invalidCardUuid")}</div></div>`;const a=e.fields||{};if(_e.debug(`getFieldContent: card ${e.uuid}, side ${t}, fields:`,a),"object"!=typeof a||Array.isArray(a))return _e.error("getFieldContent: invalid fields structure",{cardId:e.uuid,fields:a}),`<div class="field-container error-field"><div class="field-label">${bi(x)("studyInterface.labels.error")}</div><div class="field-content">${bi(x)("studyInterface.errors.invalidFields")}</div></div>`;let r=null;try{r=(null==(n=bi(F))?void 0:n.find(t=>t&&t.id===e.templateId))||null}catch(i){_e.error("getFieldContent: template search failed",i)}return r?function(e,t,n){try{if(!t||!t.fields||!Array.isArray(t.fields))return _e.error("handleTemplateFieldContent: invalid template structure",t),Ze(e,n);_e.debug(`handleTemplateFieldContent: using template ${t.name}`);const i=t.fields.filter(e=>{try{return e&&"field"===e.type&&(e.side===n||"both"===e.side)}catch(di){return _e.warn("handleTemplateFieldContent: field filter error",di),!1}}).filter(t=>{try{const n=t,i=e[n.key],a=i&&"string"==typeof i&&i.trim();return _e.debug(`handleTemplateFieldContent: field ${n.key} has content:`,a),a}catch(di){return _e.warn("handleTemplateFieldContent: field content check error",di),!1}}).map(t=>{try{const i=t,a=String(e[i.key]||""),r=i.name||i.key,s=kee(a,n,bi(R));return`<div class="field-container template-field" data-field-key="${i.key}">\n                      <div class="field-label">${r}</div>\n                      <div class="field-content">${s}</div>\n                    </div>`}catch(di){return _e.error("handleTemplateFieldContent: field mapping error",di),""}}).filter(Boolean);return _e.debug(`handleTemplateFieldContent: found ${i.length} relevant fields for ${n}`),0===i.length?(_e.debug(`handleTemplateFieldContent: no relevant fields found for ${n}, using fallback`),function(e,t){try{const n=Object.keys(e).filter(t=>{try{const n=e[t];return!["templateId","templateName","notes"].includes(t)&&n&&"string"==typeof n&&n.trim()}catch(di){return _e.warn("handleFallbackFieldContent: field check error",di),!1}});return n.length>0?n.map(n=>{try{const i=String(e[n]);return`<div class="field-container fallback-field" data-field-key="${n}">\n                      <div class="field-label">${n}</div>\n                      <div class="field-content">${kee(i,t,bi(R))}</div>\n                    </div>`}catch(di){return _e.error("handleFallbackFieldContent: field processing error",di),""}}).filter(Boolean).join(""):`<div class="field-container error-field">\n                  <div class="field-label">无内容</div>\n                  <div class="field-content">该卡片没有可显示的${"front"===t?"问题":"答案"}内容</div>\n                </div>`}catch(di){return _e.error("handleFallbackFieldContent: unexpected error",di),'<div class="field-container error-field">\n                <div class="field-label">处理错误</div>\n                <div class="field-content">降级字段处理失败</div>\n              </div>'}}(e,n)):i.join("")}catch(di){return _e.error("handleTemplateFieldContent: unexpected error",di),Ze(e,n)}}(a,r,t):(_e.debug(`getFieldContent: no template found for ${e.templateId}, using default fields`),Ze(a,t))}catch(di){return _e.error("getFieldContent: unexpected error",{error:di instanceof Error?di.message:String(di),cardId:(null==e?void 0:e.uuid)||"unknown",side:t}),'<div class="field-container error-field">\n                <div class="field-label">渲染错误</div>\n                <div class="field-content">字段内容处理失败，请刷新重试</div>\n              </div>'}}function Ze(e,t){try{let n="";if("front"===t&&(n=e.question||e.front||e.prompt||""),_e.debug(`handleDefaultFieldContent: default field content for ${t}:`,n),n&&"string"!=typeof n&&(_e.warn("handleDefaultFieldContent: content is not string",{content:n,type:typeof n}),n=String(n)),!n||!n.trim()){const i=Object.keys(e).filter(t=>{const n=e[t];return!["templateId","templateName","notes"].includes(t)&&n&&"string"==typeof n&&n.trim()});if(!(i.length>0))return _e.debug("handleDefaultFieldContent: no content found in any field"),`<div class="field-container error-field">\n                    <div class="field-label">无内容</div>\n                    <div class="field-content">该卡片没有${"front"===t?"问题":"答案"}内容</div>\n                  </div>`;_e.debug(`handleDefaultFieldContent: using first available field: ${i[0]}`),n=String(e[i[0]])}const i=kee(n,t,bi(R));return`<div class="field-container default-field">\n                <div class="field-label">${"front"===t?"问题":"答案"}</div>\n                <div class="field-content">${i}</div>\n              </div>`}catch(di){return _e.error("handleDefaultFieldContent: error processing default fields",di),'<div class="field-container error-field">\n                <div class="field-label">处理错误</div>\n                <div class="field-content">默认字段处理失败</div>\n              </div>'}}Ti(()=>I.isPremiumActive.subscribe(e=>{$n(Ge,e,!0)}));let Ye=Pn(null),Xe=Pn(!1),Je=Pn(!1);Pr(async()=>{try{$n(Ye,y().editorPoolManager,!0),await async function(){var e;try{const t=y().settings;(null==(e=null==t?void 0:t.simplifiedParsing)?void 0:e.templates)?($n(F,t.simplifiedParsing.templates,!0),$n(B,t.simplifiedParsing.templates,!0),_e.debug("已加载模板数据:",bi(F).length,"个模板")):(_e.warn("[StudyModal] 未找到模板数据"),$n(F,[],!0),$n(B,[],!0))}catch(di){_e.error("[StudyModal] 加载模板数据失败:",di),$n(F,[],!0),$n(B,[],!0)}}()}catch(di){_e.error("Failed to initialize editor manager:",di)}});let et=Pn(Ot({id:Gu(),deckId:"",startTime:new Date,cardsReviewed:0,newCardsLearned:0,correctAnswers:0,totalTime:0,cardReviews:[]})),tt=Pn(Ot(new Map)),nt=In(()=>{var e,t;if(Array.isArray(bi(A))&&bi(P)>=0&&bi(P)<bi(A).length){const n=bi(A)[bi(P)];return(null==(t=null==(e=y())?void 0:e.settings)?void 0:t.enableDebugMode)&&_e.debug("[StudyModal] currentCard updated:",{cardId:null==n?void 0:n.uuid,isProgressiveCloze:s8(n),activeClozeOrd:s8(n)?n.clozeOrd:void 0,currentCardIndex:bi(P),queueLength:bi(A).length}),n}}),it=In(()=>{if(bi(nt))return s8(bi(nt))?bi(nt).clozeOrd+1:void 0}),at=In(()=>bi(A).length>0?Math.min(bi(P)+1,bi(A).length):0),rt=In(()=>{const e=bi(nt);if(null==e?void 0:e.deckId){const t=bi(N).find(t=>t.id===e.deckId);return(null==t?void 0:t.name)||""}{const e=bi(N).find(e=>e.id===bi(et).deckId);return(null==e?void 0:e.name)||""}}),st=In(h),ot=Pn(0);function lt(){$n(ot,D.getUndoCount(),!0)}let ct=Pn(0),dt=Pn(0),ut=Pn(0);function ht(){$n(mt,!1)}function pt(e){_e.debug("选择模板:",e.name),$n(mt,!1),new window.Notice(`已选择模板: ${e.name}`)}Ti(()=>{var e,t,n,i,a,r,s;const o=bi(nt),l=(null==o?void 0:o.deckId)||"",c=bi(tt).get(l)||{},d=(null==(e=y())?void 0:e.settings)||{};$n(j,{learningSteps:null!=(n=null!=(t=c.learningSteps)?t:d.learningSteps)?n:[1,10],relearningSteps:null!=(i=c.relearningSteps)?i:[10],graduatingInterval:null!=(r=null!=(a=c.graduatingInterval)?a:d.graduatingInterval)?r:1,easyInterval:null!=(s=c.easyInterval)?s:4},!0)}),Ti(()=>{var e,t,n,i,a;const r=bi(nt);if(r&&r.uuid){bi(z)&&_.dispose(bi(z));const s=null!=(n=null!=(t=null==(e=bi(j))?void 0:e.learningSteps)?t:y().settings.learningSteps)?n:[1,10],o=null!=(a=null==(i=bi(j))?void 0:i.relearningSteps)?a:[10];$n(z,_.createSession(r,s,o),!0)}}),Ti(()=>{$n(U,bi(R)?Date.now()-bi($):0,!0)}),Ti(()=>{if(0===bi(et).cardReviews.length)$n(dt,0);else{const e=bi(et).cardReviews.reduce((e,t)=>e+t.responseTime,0);$n(dt,e/bi(et).cardReviews.length)}});let gt=Pn(0);function vt(){Ln(gt),_e.debug("强制刷新界面，触发器:",bi(gt))}Ti(()=>{bi(gt)>0&&_e.debug("刷新触发，PreviewContainer会自动更新")});let ft=null;Ti(()=>(ft=setInterval(()=>{!bi(ze)&&bi(nt)&&($n(ct,Date.now()-bi($)),bi(et).totalTime=Math.floor((Date.now()-bi(et).startTime.getTime())/1e3))},1e3),()=>{ft&&clearInterval(ft)}));let mt=Pn(!1),yt=Pn(0),bt=Pn(0),wt=Pn(null),xt=Pn(Ot([])),_t=!1;function Ct(e,t,n,i){var a,r,s,o,l,c,d;const u=bi(tt).get(i.deckId),h=y().settings,p=null!=(r=null!=(a=null==u?void 0:u.learningSteps)?a:h.learningSteps)?r:[1,10],g=null!=(s=null==u?void 0:u.relearningSteps)?s:[10],v=null!=(l=null!=(o=null==u?void 0:u.graduatingInterval)?o:h.graduatingInterval)?l:1,f=null!=(c=null==u?void 0:u.easyInterval)?c:4,m=bi(z)?_.getSessionState(bi(z)):null;let b=null!=(d=null==m?void 0:m.learningStepIndex)?d:0;const w=n.state,k=w===Gr.New||w===Gr.Learning,S=w===Gr.Relearning;if(!k&&!S)return;const x=S?g:p,C=e=>{var t,n;return n=null!=(t=x[Math.min(e,x.length-1)])?t:1,Math.max(0,(n||0)/1440)},I=new Date,D=e=>{n.scheduledDays=Math.max(0,e);const t=Math.round(24*e*60*60*1e3);n.due=new Date(I.getTime()+t)},T=Xr.calculateNext(b,t,x);if(-1===T){const e=4===t?f:v;D(Math.max(1,e)),n.state=Gr.Review}else b=T,D(C(b)),n.state=k?Gr.Learning:Gr.Relearning,bi(z)&&_.updateStepIndex(bi(z),b)}function It(e){return!!e&&Boolean(e.closest('input, textarea, select, [contenteditable=""], [contenteditable="true"], .cm-editor, .cm-content'))}function Dt(e){if(y().settings.enableShortcuts&&!bi(ze)&&bi(nt)&&!It(e.target)&&!It(document.activeElement))switch(e.key){case" ":case"Enter":case"NumpadEnter":e.preventDefault(),bi(R)||Tt();break;case"1":case"Numpad1":bi(R)&&(e.preventDefault(),At(1));break;case"2":case"Numpad2":bi(R)&&(e.preventDefault(),At(2));break;case"3":case"Numpad3":bi(R)&&(e.preventDefault(),At(3));break;case"4":case"Numpad4":bi(R)&&(e.preventDefault(),At(4));break;case"Escape":e.preventDefault(),Ut();break;case"e":case"E":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),Vt());break;case"d":case"D":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),Wt());break;case"s":case"S":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),$n(Ae,!bi(Ae)));break;case"r":case"R":if(e.ctrlKey||e.metaKey){e.preventDefault(),vt();try{new window.Notice("界面已刷新")}catch(t){_e.debug("界面已刷新")}}}}function Tt(){$n(R,!0),$n($,Date.now(),!0),bi(H)&&(_e.debug("🎵 显示答案，触发背面内容自动播放"),Nt("callback"))}async function Mt(){const e=D.undo();if(!e)return new window.Notice("没有可撤销的操作"),void _e.debug("撤销栈为空");try{if(_e.debug("开始撤销评分:",{cardId:e.cardId,cardIndex:e.cardIndex,rating:e.reviewInfo.rating}),$n(P,e.cardIndex,!0),await yi(),!bi(nt)||bi(nt).uuid!==e.cardId)throw new Error("卡片索引恢复失败");bi(nt).fsrs=JSON.parse(JSON.stringify(e.cardSnapshot.fsrs)),bi(nt).reviewHistory=JSON.parse(JSON.stringify(e.cardSnapshot.reviewHistory)),bi(nt).stats=JSON.parse(JSON.stringify(e.cardSnapshot.stats)),bi(nt).modified=e.cardSnapshot.modified,bi(et).cardsReviewed=e.sessionSnapshot.cardsReviewed,bi(et).newCardsLearned=e.sessionSnapshot.newCardsLearned,bi(et).correctAnswers=e.sessionSnapshot.correctAnswers,bi(et).totalTime=e.sessionSnapshot.totalTime;if(!(await m().saveCard(bi(nt))).success)throw new Error("保存卡片失败");bi(S)[bi(P)]=bi(nt),$n(S,[...bi(S)],!0),$n(R,!1),$n($,Date.now(),!0),lt(),Ln(ut),new window.Notice("✅ 已撤销上一次评分"),_e.debug("撤销成功")}catch(di){_e.error("[StudyModal] 撤销失败:",di),new window.Notice("❌ 撤销失败: "+(di instanceof Error?di.message:"未知错误")),e&&(D.saveSnapshot(e),lt())}}async function At(e){const t=bi(nt);if(_e.debug("rateCard called:",{rating:e,hasCurrentCard:!!t,currentCardId:null==t?void 0:t.uuid,showAnswer:bi(R),cardStartTime:bi($)}),!t||!bi(R))return void _e.debug("rateCard early return:",{hasCurrentCard:!!t,showAnswer:bi(R)});const n=Date.now()-bi($);try{const i={cardIndex:bi(P),cardId:t.uuid,cardSnapshot:{fsrs:t.fsrs,reviewHistory:t.reviewHistory||[],stats:t.stats||{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},modified:t.modified||(new Date).toISOString()},sessionSnapshot:{cardsReviewed:bi(et).cardsReviewed,newCardsLearned:bi(et).newCardsLearned,correctAnswers:bi(et).correctAnswers,totalTime:bi(et).totalTime},reviewInfo:{rating:e,timestamp:Date.now(),responseTime:n}};D.saveSnapshot(i),lt()}catch(di){_e.error("[StudyModal] 保存撤销快照失败:",di)}if(!t.fsrs)return _e.error("[StudyModal] fsrs is undefined, cannot rate card"),void new window.Notice("卡片数据异常，无法评分");const i=t.fsrs.state,{card:a,log:r}=f().review(t.fsrs,e);Ct(0,e,a,t),t.fsrs=a,t.reviewHistory||(t.reviewHistory=[],_e.warn("[StudyModal] reviewHistory was undefined, initialized as empty array")),t.reviewHistory.push(r),t.stats||(t.stats={totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},_e.warn("[StudyModal] currentCard.stats was undefined, initialized with default values")),t.stats.totalReviews++;const s=Math.max(0,Math.round(n/1e3));t.stats.totalTime+=s,t.stats.averageTime=t.stats.totalReviews>0?t.stats.totalTime/t.stats.totalReviews:0,function(e,t,n){if(void 0!==e.stats.predictionAccuracy){const i=t>=3?1:0,a=n<Lee&&i?jee:0,r=e.stats.predictionAccuracy;e.stats.predictionAccuracy=r*Fee+(i+a)*Bee}else e.stats.predictionAccuracy=t>=3?1:0;if(e.reviewHistory&&e.reviewHistory.length>=2&&e.fsrs){const t=e.reviewHistory[e.reviewHistory.length-2].stability,n=(e.fsrs.stability-t)/t;void 0!==e.stats.stabilityTrend?e.stats.stabilityTrend=e.stats.stabilityTrend*Uee+n*Vee:e.stats.stabilityTrend=n}if(e.reviewHistory&&e.reviewHistory.length>=2&&e.fsrs){const t=e.reviewHistory[e.reviewHistory.length-2].difficulty,n=e.fsrs.difficulty-t;void 0!==e.stats.difficultyTrend?e.stats.difficultyTrend=e.stats.difficultyTrend*qee+n*Hee:e.stats.difficultyTrend=n}}(t,e,n),function(e,t){const n=t>=3,i=e.stats.totalReviews;if(1===i)e.stats.memoryRate=n?1:0;else{const t=Math.round((e.stats.memoryRate||0)*(i-1))+(n?1:0);e.stats.memoryRate=t/i}void 0===e.stats.memoryRate&&(e.stats.memoryRate=n?1:0)}(t,e),function(e,t,n){var i,a;if(bi(V)!==CS.SINGLE_CHOICE&&bi(V)!==CS.MULTIPLE_CHOICE)return;const r=null==(a=null==(i=bi(gn))?void 0:i.getChoiceQuestionData)?void 0:a.call(i);if(!r||!r.isChoiceQuestion)return void _e.warn("[StudyModal] 无法获取选择题数据");const{questionData:s,selectedOptions:o}=r;if(!s)return;const l=s.correctAnswers;let c=!1;if(s.isMultipleChoice){const e=new Set(o),t=new Set(l);if(e.size===t.size){c=!0;for(const e of o)if(!t.has(e)){c=!1;break}}}else c=1===o.length&&l.includes(o[0]);_e.debug("选择题答题结果:",{selected:o,correct:l,isCorrect:c}),e.stats.choiceStats||(e.stats.choiceStats={totalAttempts:0,correctAttempts:0,accuracy:0,averageResponseTime:0,recentAttempts:[],isInErrorBook:!1,errorCount:0});const d=e.stats.choiceStats;d.totalAttempts++,c?d.correctAttempts++:(d.errorCount++,d.lastErrorDate=(new Date).toISOString());d.accuracy=d.correctAttempts/d.totalAttempts,1===d.totalAttempts?d.averageResponseTime=n:d.averageResponseTime=(d.averageResponseTime*(d.totalAttempts-1)+n)/d.totalAttempts;const u={timestamp:(new Date).toISOString(),selectedOptions:[...o],correctOptions:[...l],correct:c,responseTime:n};d.recentAttempts.unshift(u),d.recentAttempts.length>10&&(d.recentAttempts=d.recentAttempts.slice(0,10));_e.debug("选择题统计已更新:",{totalAttempts:d.totalAttempts,correctAttempts:d.correctAttempts,accuracy:`${Math.round(100*d.accuracy)}%`,avgResponseTime:`${Math.round(d.averageResponseTime/1e3)}s`})}(t,0,n),bi(et).cardReviews||(bi(et).cardReviews=[],_e.warn("[StudyModal] session.cardReviews was undefined, initialized as empty array")),bi(et).cardReviews.push({cardId:t.uuid,rating:e,responseTime:n,timestamp:new Date}),bi(et).cardsReviewed++,i===Gr.New&&bi(et).newCardsLearned++,e>=3&&bi(et).correctAnswers++,bi(L).add(t.uuid);try{if(await m().saveCard(t),bi(O)&&y().settings.enablePersonalization)try{await C.updateAfterReview(r,t.reviewHistory);const e=C.getOptimizationProgress();"baseline"!==e.state&&bi(et).cardsReviewed%Nee===0&&Wee.SESSION}catch(di){!function(e,t,n={}){const{showNotice:i=!0,noticeMessage:a,logPrefix:r=Wee.CARD_OPERATION}=n;if(e instanceof Error?e.message:String(e),_e.error(`${r} ${t}失败:`,e),i){const e=a||`❌ ${t}失败`;new ge.Notice(e)}}(di,"个性化优化",{showNotice:!1,logPrefix:Wee.SESSION})}Ln(ut),_e.debug("Card saved, triggering progress bar refresh:",bi(ut)),await async function(e,t,n){const i=y().settings.learningSteps||[1,10];Math.max(...i);let a=!1,r=1;n===Gr.New&&t<=Qr.Hard?(a=!0,r=t===Qr.Again?1:3,Wee.SESSION,e.uuid.slice(0,8)):n===Gr.Learning&&t===Qr.Again?(a=!0,r=1,Wee.SESSION,e.uuid.slice(0,8)):n===Gr.Review&&t===Qr.Again&&(a=!0,r=2,Wee.SESSION,e.uuid.slice(0,8));if(a&&bi(A).length>0){const t=bi(P),n=Math.min(t+r,bi(A).length);bi(A).splice(n,0,e),$n(A,[...bi(A)],!0),Wee.SESSION,bi(A).length}}(t,e,i)}catch(o){_e.error("保存卡片失败",o)}Bt()}function Et(e,t=!1){const n=e||document.body,i=new Set;t&&(_e.debug("[findMediaElements] 🔍 开始媒体元素搜索"),_e.debug("[findMediaElements] 容器:",n.className,n.id));["audio","video",".internal-embed audio",".internal-embed video",".media-embed audio",".media-embed video",".audio-embed audio",".video-embed video",".file-embed audio",".file-embed video",".markdown-preview-view audio",".markdown-preview-view video",".markdown-reading-view audio",".markdown-reading-view video",".card-preview audio",".card-preview video",".preview-container audio",".preview-container video",".main-study-area audio",".main-study-area video",".tuanki-obsidian-renderer audio",".tuanki-obsidian-renderer video"].forEach(e=>{try{const a=n.querySelectorAll(e);a.forEach(e=>i.add(e)),t&&a.length>0&&_e.debug(`[findMediaElements] ✅ 标准选择器 "${e}" 找到 ${a.length} 个元素`)}catch(a){_e.warn(`[findMediaElements] 选择器查询失败: ${e}`,a)}});[".mx-video-player video",".mx-audio-player audio",".mx-media-player video",".mx-media-player audio",".media-extended-player video",".media-extended-player audio","[data-mx-video] video","[data-mx-audio] audio","[data-media-extended] video","[data-media-extended] audio","iframe video","iframe audio"].forEach(e=>{try{const a=n.querySelectorAll(e);a.forEach(e=>i.add(e)),t&&a.length>0&&_e.debug(`[findMediaElements] 🔌 media-extended 选择器 "${e}" 找到 ${a.length} 个元素`)}catch(a){}}),0===i.size&&(t&&_e.debug("[findMediaElements] ⚠️ 前两个策略未找到媒体，启动深度遍历"),function e(n){var a;"AUDIO"!==n.tagName&&"VIDEO"!==n.tagName||(i.add(n),t&&_e.debug(`[findMediaElements] 🌲 深度遍历找到: ${n.tagName}`,{src:n.src,parent:null==(a=n.parentElement)?void 0:a.className})),n.shadowRoot&&(t&&_e.debug("[findMediaElements] 🌑 检测到 Shadow DOM"),n.shadowRoot.querySelectorAll("audio, video").forEach(e=>{i.add(e),t&&_e.debug(`[findMediaElements] 🌑 Shadow DOM 找到: ${e.tagName}`)})),Array.from(n.children).forEach(t=>e(t))}(n));n.querySelectorAll("iframe").forEach(e=>{var n;try{const a=e.contentDocument||(null==(n=e.contentWindow)?void 0:n.document);a&&a.querySelectorAll("audio, video").forEach(e=>{i.add(e),t&&_e.debug(`[findMediaElements] 🖼️ iframe 内找到: ${e.tagName}`)})}catch(a){t&&_e.debug("[findMediaElements] ⚠️ iframe 跨域，无法访问内容")}});const a=Array.from(i);return t&&(_e.debug(`[findMediaElements] 📊 总计找到 ${a.length} 个媒体元素`),a.length>0&&a.forEach((e,t)=>{var n;_e.debug(`[findMediaElements]   ${t+1}. ${e.tagName}:`,{src:e.src||e.currentSrc||"no-src",className:e.className,parent:null==(n=e.parentElement)?void 0:n.className,controls:e.controls,autoplay:e.autoplay})})),a}async function Rt(e){if(0!==e.length){_e.debug(`🎵 找到 ${e.length} 个媒体元素，播放模式: ${bi(W)}`);try{if("first"===bi(W)){const t=e[0];await async function(e){const t="";_e.debug(`${t} 准备播放: ${e.tagName}`,{src:e.src||e.currentSrc||"no-src",readyState:e.readyState,networkState:e.networkState});const n=e.src||e.currentSrc;if(!n||"no-src"===n||""===n.trim())return void _e.warn(`[StudyInterface] ${t} ⚠️ 跳过：媒体源未设置`);if(e.readyState>=2){_e.debug(` ${t} ✅ 媒体已就绪 (readyState: ${e.readyState})`);try{return await e.play(),void _e.debug(`${t} ✅ 播放成功`)}catch(di){return void _e.warn(`[StudyInterface] ${t} ⚠️ 播放失败:`,di)}}_e.debug(` ${t} ⏳ 等待媒体加载 (readyState: ${e.readyState})`);try{await Lt(e,5e3),_e.debug(` ${t} ✅ 媒体加载完成 (readyState: ${e.readyState})`),await e.play(),_e.debug(`${t} ✅ 播放成功`)}catch(di){di instanceof Error&&di.message.includes("timeout")?_e.warn(`[StudyInterface] ${t} ⚠️ 等待超时：媒体加载失败`):_e.warn(`[StudyInterface] ${t} ⚠️ 播放失败:`,di)}}(t)}else{_e.debug(" 🎵 开始顺序播放所有媒体");for(let t=0;t<e.length;t++){const n=e[t];await $t(n,t+1,e.length),t<e.length-1&&(_e.debug(`⏸️ 等待 ${bi(Q)}ms 后播放下一个媒体`),await new Promise(e=>setTimeout(e,bi(Q))))}_e.debug(" ✅ 所有媒体顺序播放完成")}}catch(di){_e.warn("[StudyInterface] ⚠️ 自动播放失败（可能需要用户交互）:",di)}}else _e.debug(" 没有媒体元素需要播放")}async function $t(e,t,n){const i=n>1?`${t}/${n}`:"",a=i?`[${i}]`:"";_e.debug(`${a} 🎬 顺序播放: ${e.tagName}`,{src:e.src||e.currentSrc||"no-src",readyState:e.readyState,networkState:e.networkState});const r=e.src||e.currentSrc;if(r&&"no-src"!==r&&""!==r.trim()){if(e.readyState<2){_e.debug(` ${a} ⏳ 等待媒体加载 (readyState: ${e.readyState})`);try{await Lt(e,5e3),_e.debug(` ${a} ✅ 媒体加载完成 (readyState: ${e.readyState})`)}catch(di){return void _e.warn(`[StudyInterface] ${a} ⚠️ 等待超时：媒体加载失败`)}}else _e.debug(` ${a} ✅ 媒体已就绪 (readyState: ${e.readyState})`);try{e.currentTime=0,await e.play(),_e.debug(`${a} ▶️ 开始播放`),await function(e){return new Promise(t=>{if(e.ended)return void t();const n=()=>{r(),t()},i=()=>{r(),t()},a=()=>{e.ended&&(r(),t())};function r(){e.removeEventListener("ended",n),e.removeEventListener("error",i),e.removeEventListener("pause",a)}e.addEventListener("ended",n),e.addEventListener("error",i),e.addEventListener("pause",a)})}(e),_e.debug(`${a} ✅ 播放完成`)}catch(di){_e.warn(`[StudyInterface] ${a} ⚠️ 播放失败:`,di)}}else _e.warn(`[StudyInterface] ${a} ⚠️ 跳过：媒体源未设置`)}function Lt(e,t){return new Promise((n,i)=>{if(e.readyState>=2)return void n();let a=!1;const r=setTimeout(()=>{a||(a=!0,c(),i(new Error("Media loading timeout")))},t),s=()=>{!a&&e.readyState>=2&&(a=!0,c(),n())},o=()=>{!a&&e.readyState>=2&&(a=!0,c(),n())},l=e=>{a||(a=!0,c(),i(new Error(`Media loading error: ${e.message||"unknown"}`)))};function c(){clearTimeout(r),e.removeEventListener("loadeddata",s),e.removeEventListener("canplay",o),e.removeEventListener("error",l)}e.addEventListener("loadeddata",s),e.addEventListener("canplay",o),e.addEventListener("error",l),0===e.networkState&&(_e.debug("[waitForMediaReady] 主动触发加载: load()"),e.load())})}async function Nt(e="manual"){if(!bi(H))return;await yi();let t=Et();if(t.length>0)return void(await Rt(t));for(let n=0;n<3;n++)if(await new Promise(e=>setTimeout(e,200)),t=Et(),t.length>0)return void(await Rt(t));await new Promise(e=>setTimeout(e,300)),t=Et(void 0,!1),t.length>0?await Rt(t):await new Promise(e=>{const t=document.querySelector(".main-study-area")||document.body;let n=!1;const i=new MutationObserver(a=>{if(n)return;const r=Et(t,!1);r.length>0&&(n=!0,i.disconnect(),_e.debug("✅ MutationObserver 检测到媒体元素"),Rt(r),e())});i.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","class","data-mx-video","data-mx-audio"]}),setTimeout(()=>{if(!n){n=!0,i.disconnect();const a=Et(t,!1);a.length>0&&Rt(a),e()}},3e3)})}async function Bt(){var e,t,n,i;if(bi(ze)&&(_e.debug("切换卡片前退出编辑模式"),qt(),await yi()),!Array.isArray(bi(A))||0===bi(A).length)return _e.warn("nextCard: No study queue available"),void jt();if(Wee.SESSION,bi(P),bi(A).length,bi(A).length,bi(P),null==(e=bi(nt))||e.uuid.slice(0,8),bi(L).size,bi(P)>=bi(A).length-1)_e.debug("[StudyModal] Reached end of study queue, finishing session"),jt();else{const e=bi(P)+1;if(e<bi(A).length){const a=bi(P);$n(P,e),$n(R,!1),$n($,Date.now(),!0),(null==(n=null==(t=y())?void 0:t.settings)?void 0:n.enableDebugMode)&&_e.debug("[StudyModal] Card index updated:",{from:a,to:bi(P),newCardId:null==(i=bi(A)[bi(P)])?void 0:i.uuid}),bi(H)&&"cardChange"===bi(G)&&Nt(),y().settings.autoShowAnswerSeconds}else _e.warn("nextCard: Invalid next index",e,"queueLength:",bi(A).length),jt()}}async function jt(){bi(et).endTime=new Date,bi(et).totalTime=Math.max(0,Math.round((bi(et).endTime.getTime()-bi(et).startTime.getTime())/1e3));try{await m().saveStudySession(bi(et))}catch(e){_e.error("保存学习会话失败",e)}D.clear(),lt(),k()(bi(et)),w()()}function Ut(){if(function(e){var t;const n=e.app;(null==(t=null==n?void 0:n.workspace)?void 0:t.hoverLink)&&n.workspace.hoverLink.hide(),document.querySelectorAll(".popover, .tooltip, .hover-editor, .popover-content, .mod-hover, .tuanki-hover-preview, .tuanki-hover-card, .suggestion-container, .mod-suggestion").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),document.querySelectorAll("[data-tooltip-visible], .is-hovered").forEach(e=>{e.removeAttribute("data-tooltip-visible"),e.classList.remove("is-hovered")})}(y()),bi(et).cardsReviewed>0){if(!confirm("确定要退出学习吗？当前进度将会保存。"))return;jt()}else w()()}async function Vt(){if(bi(nt))if(bi(ze)){if(!bi(Ye))return _e.error("Cannot save: editorPoolManager not available"),void $n(ze,!1);try{const e=bi(Ye).studySessionCardId,t=await bi(Ye).finishEditing(e,!0,{isStudySession:!0,targetCardId:bi(nt).uuid});if(t.success&&t.updatedCard){_e.debug("✅ 卡片保存成功（点击预览）:",t.updatedCard.uuid),new window.Notice("卡片已保存");const e=t.updatedCard.uuid,n=bi(S).findIndex(t=>t.uuid===e);-1!==n&&(bi(S)[n]=t.updatedCard,$n(S,[...bi(S)],!0));const i=bi(A).findIndex(t=>t.uuid===e);-1!==i&&(bi(A)[i]=t.updatedCard,$n(A,[...bi(A)],!0)),$n(ze,!1),$n(Xe,!1),$n(Je,!1)}else _e.error("保存失败（点击预览）:",t.error),new window.Notice("保存失败: "+(t.error||"未知错误"))}catch(di){_e.error("保存异常（点击预览）:",di),new window.Notice("保存失败: "+(di instanceof Error?di.message:"未知错误"))}}else $n(Xe,!1),$n(ze,!0),await yi();else _e.warn("No current card available for editing")}async function qt(){_e.debug("Editor cancel callback triggered"),$n(ze,!1),$n(Xe,!1),$n(Je,!1)}function Ht(){$n(Je,!bi(Je)),_e.debug("Cloze mode toggled:",bi(Je))}async function Wt(e=!1){var t;if(bi(nt)){if(!e){const e=Ke(bi(nt),"front").slice(0,30)||`UUID: ${bi(nt).uuid}`;return $n(Re,!0),void $n($e,e,!0)}try{const e=await m().deleteCard(bi(nt).uuid);if(!(null==e?void 0:e.success)){try{new window.Notice(`删除失败：${(null==e?void 0:e.error)||"未知错误"}`)}catch(n){alert(`删除失败：${(null==e?void 0:e.error)||"未知错误"}`)}return}bi(ze)&&($n(ze,!1),$n(Xe,!1),$n(Je,!1));const i=bi(nt).uuid,a={cardsLength:bi(S).length,queueLength:bi(A).length,currentIndex:bi(P)};if($n(S,bi(S).filter(e=>e.uuid!==i),!0),$n(A,bi(A).filter(e=>e.uuid!==i),!0),0===bi(A).length)return $n(P,0),$n(R,!1),_e.info("[Delete] 所有卡片已完成，结束学习会话"),void jt();bi(P)>=bi(A).length&&$n(P,bi(A).length-1),$n(R,!1),$n($,Date.now(),!0),$n(ze,!1),$n(S,[...bi(S)],!0),$n(A,[...bi(A)],!0),vt();try{new window.Notice("✅ 卡片已删除")}catch(n){_e.debug("卡片已删除")}_e.info("[Delete] 卡片已删除并切换:",{deletedCard:i.slice(0,8),before:a,after:{cardsLength:bi(S).length,queueLength:bi(A).length,currentIndex:bi(P),nextCard:null==(t=bi(A)[bi(P)])?void 0:t.uuid.slice(0,8)}})}catch(n){_e.error("删除失败",n);try{new window.Notice("删除卡片时发生错误，请重试")}catch(i){alert("删除卡片时发生错误，请重试")}}}}async function Zt(){var e;if(bi(nt))try{const t={...bi(nt)};await Cee(t,uo.MANUAL,5);const n=await m().saveCard(t);if(!(null==n?void 0:n.success))return void new window.Notice(`回收失败：${(null==n?void 0:n.error)||"未知错误"}`);const i=bi(nt).uuid,a={cardsLength:bi(S).length,queueLength:bi(A).length,currentIndex:bi(P)};if($n(S,bi(S).filter(e=>e.uuid!==i),!0),$n(A,bi(A).filter(e=>e.uuid!==i),!0),0===bi(A).length)return $n(P,0),$n(R,!1),_e.info("[Recycle] 所有卡片已完成，结束学习会话"),void jt();bi(P)>=bi(A).length&&$n(P,bi(A).length-1),$n(R,!1),$n($,Date.now(),!0),$n(ze,!1),$n(S,[...bi(S)],!0),$n(A,[...bi(A)],!0),vt();const r=Iee(!0);new window.Notice(`✅ 已回收卡片（添加了 ${r} 标签）`),_e.info("[Recycle] 卡片已回收并切换:",{removedCard:i.slice(0,8),tagAdded:r,before:a,after:{cardsLength:bi(S).length,queueLength:bi(A).length,currentIndex:bi(P),nextCard:null==(e=bi(A)[bi(P)])?void 0:e.uuid.slice(0,8)}})}catch(di){_e.error("[Recycle] 回收卡片失败:",di),new window.Notice("❌ 回收卡片失败，请重试")}}Ti(()=>{_t||(async()=>{try{const e=await m().getDecks(),t=new Map;for(const n of e)t.set(n.id,n.settings);$n(tt,t,!0),$n(N,e,!0),_t=!0}catch(e){_e.warn("加载牌组设置失败",e)}})()});let Yt=Pn(!1),Xt=Pn(""),Jt=Pn(""),en=Pn(!1),tn=Pn(2),nn=Pn(null);function an(){if(!bi(nt))return;const e=new Date;e.setDate(e.getDate()+1),$n(Xt,e.toISOString().split("T")[0],!0),$n(Jt,(new Date).toTimeString().slice(0,5),!0),$n(Yt,!0)}function rn(){bi(nt)&&($n(tn,bi(nt).priority||2,!0),$n(en,!0))}let sn=Pn(!1);async function on(e){if(!bi(nt))return void new window.Notice("当前没有可格式化的卡片");const t=bi(st).format.find(t=>t.id===e);if(!t)return void new window.Notice("未找到该格式化功能");const n=new window.Notice("🤖 AI正在格式化...",0),i=bi(nt);if(i)try{const e=await B8.formatWithCustomAction(t,i,{template:bi(F).find(e=>e.id===i.templateId),deck:bi(N).find(e=>e.id===i.deckId)},y());n.hide(),e.success?($n(qe,e,!0),$n(He,t.name,!0),$n(Ve,!0)):new window.Notice("格式化失败: "+e.error)}catch(di){n.hide(),_e.error("[StudyInterface] 格式化异常:",di),new window.Notice("格式化失败: "+(di instanceof Error?di.message:"未知错误"))}}async function ln(){var e;if(!bi(nt)||!(null==(e=bi(qe))?void 0:e.formattedContent))return;const t=bi(qe),n=t.provider||"Unknown",i=t.formattedContent;try{const e={...bi(nt)};e.content=i,e.modified=(new Date).toISOString();try{const t=k8(i,bi(nt));e.fields=t.fields,e.parsedMetadata=t.parsedMetadata}catch(a){_e.warn("[StudyInterface] 字段解析失败，仅更新content:",a)}const t=await m().saveCard(e);if(t.success){const t=bi(nt).uuid,i=bi(S).findIndex(e=>e.uuid===t);-1!==i&&(bi(S)[i]=e,$n(S,[...bi(S)],!0));const a=bi(A).findIndex(e=>e.uuid===t);-1!==a&&(bi(A)[a]=e,$n(A,[...bi(A)],!0));const r=n?` (${n})`:"";new window.Notice(`✨ AI格式化成功${r}`),_e.info("[Format] AI格式化已应用:",{cardId:t.slice(0,8),provider:n,cardsUpdated:-1!==i,queueUpdated:-1!==a,contentLength:e.content.length}),vt(),$n(Ve,!1),$n(qe,null)}else new window.Notice("❌ 保存失败："+(t.error||"未知错误"))}catch(di){_e.error("[Format] 应用格式化失败:",di),new window.Notice("❌ 应用失败: "+(di instanceof Error?di.message:"未知错误"))}}async function cn(e){if(!bi(nt)||bi(Y))return void new window.Notice("当前没有可生成测试题的卡片");const t=bi(nt);if(t)try{$n(Y,!0);const n=bi(st).testGen.find(t=>t.id===e);if(!n||!n.testConfig)return void new window.Notice("找不到指定的测试题生成功能");new window.Notice("🤖 正在生成测试题...");const{AITestGeneratorService:i}=await Promise.resolve().then(()=>H8),a=new i(y());_e.debug("[测试题生成] 使用测试题生成服务:",n.id);const r={sourceCard:t,action:n,targetDeckId:void 0},s=await a.generateTests(r);if(!s.success||!s.generatedQuestions||0===s.generatedQuestions.length)throw new Error(s.error||"生成失败");const o=s.generatedQuestions.map((e,i)=>{var a,r;return{uuid:`temp-uuid-${Date.now()}-${i}`,deckId:t.deckId,templateId:t.templateId,type:Kr.Basic,cardPurpose:"test",difficulty:e.difficulty||(null==(a=n.testConfig)?void 0:a.difficultyLevel)||"medium",content:e.content||`${e.front}\n\n---div---\n\n${e.back}`,tags:t.tags||[],priority:0,metadata:{questionType:e.type||(null==(r=n.testConfig)?void 0:r.questionType)||"single",generatedBy:n.id,generatedAt:(new Date).toISOString(),explanation:e.explanation},stats:{totalReviews:0,totalTime:0,averageTime:0,testStats:{totalAttempts:0,correctAttempts:0,incorrectAttempts:0,accuracy:0,bestScore:0,averageScore:0,lastScore:0,averageResponseTime:0,fastestTime:0,lastTestDate:(new Date).toISOString(),isInErrorBook:!1,consecutiveCorrect:0}},created:(new Date).toISOString(),modified:(new Date).toISOString()}});$n(Z,o,!0),$n(te,n,!0),$n(K,!0),new window.Notice(`✅ 成功生成${bi(Z).length}道测试题`)}catch(di){_e.error("[StudyInterface] 生成测试题失败:",di);const t=di instanceof Error?di.message:"生成失败";new window.Notice(`❌ 生成失败: ${t}`)}finally{$n(Y,!1)}}async function dn(e){var t;if(bi(nt)&&!bi(sn)){$n(sn,!0);try{_e.debug(`开始切换牌组: ${bi(nt).uuid} -> ${e}`);const i=bi(nt).deckId,a=await m().getDeckCards(i),r=await m().getDeckCards(e),s=a.filter(e=>e.uuid!==bi(nt).uuid),o=(new Date).toISOString(),l={...bi(nt),deckId:e,modified:o},c=[...r,l];await m().saveDeckCards(i,s),await m().saveDeckCards(e,c);const d=null==(t=m().plugin)?void 0:t.dataSyncService;d&&await d.notifyChange({type:"cards",action:"update",ids:[bi(nt).uuid],metadata:{sourceDeckId:i,targetDeckId:e}});const u=bi(nt).uuid,h=bi(S).findIndex(e=>e.uuid===u);-1!==h&&(bi(S)[h]=l,$n(S,[...bi(S)],!0));const p=bi(A).findIndex(e=>e.uuid===u);-1!==p&&(bi(A)[p]=l,$n(A,[...bi(A)],!0));const g=bi(N).find(t=>t.id===e),v=(null==g?void 0:g.name)||"未知牌组";try{new window.Notice(`已将卡片移动到：${v}`)}catch(n){_e.debug(`已将卡片移动到：${v}`)}_e.debug(`卡片已移动到牌组：${v} (${i} -> ${e})`),setTimeout(()=>{$n(sn,!1),Bt()},300)}catch(di){$n(sn,!1),_e.error("Error changing deck:",di);try{new window.Notice("更换牌组时发生错误")}catch(n){alert("更换牌组时发生错误")}}}else _e.debug("handleChangeDeck: 跳过 - 无当前卡片或正在切换中")}function un(e,t){"enabled"===e&&"boolean"==typeof t?($n(H,t,!0),y().settings.mediaAutoPlay=y().settings.mediaAutoPlay||{enabled:!1,mode:"first",timing:"cardChange",playbackInterval:2e3},y().settings.mediaAutoPlay.enabled=t):"mode"!==e||"first"!==t&&"all"!==t?"timing"!==e||"cardChange"!==t&&"showAnswer"!==t?"interval"===e&&"number"==typeof t&&($n(Q,t,!0),y().settings.mediaAutoPlay=y().settings.mediaAutoPlay||{enabled:!1,mode:"first",timing:"cardChange",playbackInterval:2e3},y().settings.mediaAutoPlay.playbackInterval=t):($n(G,t,!0),y().settings.mediaAutoPlay=y().settings.mediaAutoPlay||{enabled:!1,mode:"first",timing:"cardChange",playbackInterval:2e3},y().settings.mediaAutoPlay.timing=t):($n(W,t,!0),y().settings.mediaAutoPlay=y().settings.mediaAutoPlay||{enabled:!1,mode:"first",timing:"cardChange",playbackInterval:2e3},y().settings.mediaAutoPlay.mode=t),y().saveSettings()}Ti(()=>{let e=null;return!bi(ze)&&y().settings.autoShowAnswerSeconds>0&&!bi(R)&&(e=setTimeout(()=>Tt(),1e3*y().settings.autoShowAnswerSeconds)),bi(ze)||document.addEventListener("keydown",Dt),()=>{document.removeEventListener("keydown",Dt),e&&clearTimeout(e)}}),Ti(()=>{!bi(pn)||void 0===bi(ze)&&void 0===bi(R)&&void 0===bi(Ee)||setTimeout(vn,zee)});let pn=Pn(null),gn=Pn(null);function vn(){var e;const t=function(){if(!bi(pn))return $ee;const e=bi(pn).getBoundingClientRect(),t=bi(pn).querySelector(".study-header"),n=bi(pn).querySelector(".study-footer"),i=bi(pn).querySelector(".stats-cards");let a=0;t&&(a+=t.offsetHeight),n&&!bi(ze)&&(a+=n.offsetHeight),i&&!bi(Ee)&&(a+=i.offsetHeight);const r=bi(ze)?Pee:Ree;return Math.max($ee,e.height-a-r)}(),n=null==(e=bi(pn))?void 0:e.querySelector(".tuanki-preview-container");n&&!bi(ze)&&(n.style.height="auto",n.style.minHeight=`${Math.max(Oee,t)}px`,n.style.maxHeight="none")}function fn(e){if(bi(ze))return;if(!bi(pn))return;const t=bi(pn).querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(0===t.length)return;const n=t[0],i=t[t.length-1];e.target===document.body&&n.focus(),bi(pn).addEventListener("keydown",e=>{"Tab"===e.key&&(e.shiftKey&&document.activeElement===n?(e.preventDefault(),i.focus()):e.shiftKey||document.activeElement!==i||(e.preventDefault(),n.focus()))},{once:!0})}function mn(){if("fixed"===bi(je))return $n(Oe,!0),void $n(Fe,!0);null!==Ne&&(clearTimeout(Ne),Ne=null),Ne=window.setTimeout(()=>{yn()},150)}function yn(){if(!bi(pn))return;const e=window.innerHeight<750,t=bi(pn).querySelector(".sidebar-content");let n=!1;if(t){n=t.scrollHeight-t.clientHeight>(bi(Oe)?-20:20)}const i=e||n;bi(Fe)!==i&&($n(Oe,i,!0),$n(Fe,i,!0))}async function bn(e){$n(Pe,e,!0),y().settings.enableDirectDelete=e;try{await y().saveSettings(),_e.debug("✅ 直接删除设置已保存:",e)}catch(di){_e.error("[StudyInterface] ❌ 保存直接删除设置失败:",di)}}function wn(){$n(Re,!1),$n($e,"")}function kn(e){$n(je,e,!0),"fixed"===e?($n(Oe,!0),$n(Fe,!0),new ge.Notice("侧边栏已切换为固定紧凑模式（仅显示图标）")):(new ge.Notice("侧边栏已切换为自动调整模式"),$n(Fe,null),setTimeout(()=>{yn()},100))}Pr(()=>{document.addEventListener("focus",fn,!0);const e=()=>{setTimeout(vn,100),setTimeout(mn,150)};return window.addEventListener("resize",e),setTimeout(()=>{const e=bi(pn);e&&"function"==typeof e.focus&&e.focus(),vn()},100),setTimeout(()=>mn(),500),setTimeout(()=>{if(!bi(pn))return;const e=bi(pn).querySelector(".sidebar-content");e&&(Le=new ResizeObserver(e=>{try{if("fixed"===bi(je))return;for(const t of e){const e=t.contentRect.width,n=t.contentRect.height,i=Math.abs(e-Be.width),a=Math.abs(n-Be.height);(i>5||a>5)&&(Be={width:e,height:n},mn())}}catch(di){if(di instanceof Error&&di.message.includes("ResizeObserver"))return;_e.error("[StudyInterface] ResizeObserver error:",di)}}),Le.observe(e))},500),()=>{window.removeEventListener("resize",e)}}),Rr(()=>{document.removeEventListener("focus",fn,!0),Le&&(Le.disconnect(),Le=null),null!==Ne&&(clearTimeout(Ne),Ne=null),null!==bi(nn)&&(clearInterval(bi(nn)),$n(nn,null)),bi(Ye)&&(_e.debug(" 🧹 清理学习会话编辑器资源"),bi(Ye).cleanup()),bi(z)&&(_.dispose(bi(z)),_e.debug(" 会话已清理:",bi(z)))});var Sn={get cards(){return v()},set cards(e){v(e),hn()},get fsrs(){return f()},set fsrs(e){f(e),hn()},get dataStorage(){return m()},set dataStorage(e){m(e),hn()},get plugin(){return y()},set plugin(e){y(e),hn()},get mode(){return b()},set mode(e){b(e),hn()},get onClose(){return w()},set onClose(e){w(e),hn()},get onComplete(){return k()},set onComplete(e){k(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},xn=Nte();na("keydown",Ft,function(e){bi(ze)||"Escape"===e.key&&Ut()});var _n=Qt(xn);_n.__keydown=[Jee,w];var Cn=Gt(_n);Cn.__click=[ete],Cn.__keydown=[tte];var Dn=Gt(Cn);w8(Dn,{get currentDeckName(){return bi(rt)},get currentIndexDisplay(){return bi(at)},get cardsLength(){return bi(A).length},get statsCollapsed(){return bi(Ee)},get showSidebar(){return bi(Ae)},get session(){return bi(et)},get dataStorage(){return m()},get progressBarRefreshTrigger(){return bi(ut)},onToggleStats:()=>$n(Ee,!bi(Ee)),onToggleSidebar:()=>$n(Ae,!bi(Ae)),get onClose(){return w()}});var Tn=Kt(Dn,2);let Mn;var An=Gt(Tn),En=Gt(An),zn=e=>{var t=ate(),n=Qt(t),i=e=>{var t=ha(),n=Qt(t),i=e=>{w5(e,{get card(){return bi(nt)},get fsrs(){return f()}})},a=e=>{var t=ite(),n=Gt(t);Kt(Gt(n),4).__click=[nte,Qe],zt(n),zt(t),pa(e,t)};xa(n,e=>{bi(Ge)?e(i):e(a,!1)}),pa(e,t)};xa(n,e=>{bi(Ee)||e(i)});var a=Kt(n,2),r=Gt(a),s=Gt(r),o=e=>{I8(e,{get card(){return bi(nt)},get showEditModal(){return bi(ze)},get tempFileUnavailable(){return bi(Xe)},get isClozeMode(){return bi(Je)},get editorPoolManager(){return bi(Ye)},get dataStorage(){return m()},get modalRef(){return bi(pn)},get statsCollapsed(){return bi(Ee)},onEditComplete:e=>{const t=e.uuid,n=bi(S).findIndex(e=>e.uuid===t);-1!==n&&(bi(S)[n]=e,$n(S,[...bi(S)],!0));const i=bi(A).findIndex(e=>e.uuid===t);-1!==i&&(bi(A)[i]=e,$n(A,[...bi(A)],!0)),$n(ze,!1),$n(Xe,!1),$n(Je,!1)},onEditCancel:qt,onToggleCloze:Ht})},l=e=>{kr(f8(e,{get card(){return bi(nt)},get showAnswer(){return bi(R)},get refreshTrigger(){return bi(gt)},get activeClozeOrdinal(){return bi(it)},enableAnimations:!0,enableAnswerControls:!1,themeMode:"auto",renderingMode:"quality",get plugin(){return y()},onCardTypeDetected:pe,onPreviewReady:ve,onAddToErrorBook:fe,onRemoveFromErrorBook:me,get currentResponseTime(){return bi(de)}}),e=>$n(gn,e,!0),()=>bi(gn))};xa(s,e=>{bi(ze)?e(o):e(l,!1)}),zt(r),zt(a),pa(e,t)};xa(En,e=>{bi(nt)&&e(zn)}),zt(An);var Rn=Kt(An,2),On=e=>{kr(dee(e,{get childCards(){return bi(Z)},get regeneratingCardIds(){return bi(J)},get isRegenerating(){return bi(ee)}}),e=>$n(X,e,!0),()=>bi(X))};xa(Rn,e=>{bi(nt)&&!bi(ze)&&bi(K)&&e(On)});var Nn=Kt(Rn,2),Fn=e=>{{let t=In(()=>{var e,t;return(null==(t=null==(e=bi(X))?void 0:e.getSelectedCardIds)?void 0:t.call(e).length)||0}),n=In(()=>D.canUndo()),i=In(()=>null!==bi(ne));wee(e,{get showChildOverlay(){return bi(K)},get selectedCount(){return bi(t)},onReturn:xe,onRegenerate:be,onSave:ke,get canUndo(){return bi(n)},onUndo:Mt,get isRegenerating(){return bi(ee)},get showDeckSelector(){return bi(i)},get availableDecks(){return bi(re)},get selectedDeckId(){return bi(ie)},onDeckChange:Se})}};xa(Nn,e=>{bi(nt)&&!bi(ze)&&bi(K)&&e(Fn)});var Bn=Kt(Nn,2),jn=e=>{X4(e,{get open(){return bi(se)},get card(){return bi(nt)},get plugin(){return y()},get allDecks(){return bi(N)},onClose:Ie})};xa(Bn,e=>{bi(nt)&&bi(se)&&e(jn)});var Un=Kt(Bn,2),Vn=e=>{gee(e,{get card(){return bi(nt)},onClose:Te})};xa(Un,e=>{bi(nt)&&bi(oe)&&e(Vn)});var qn=Kt(Un,2),Hn=e=>{var t=lte();t.__click=wn,t.__keydown=[rte,wn];var n=Gt(t);n.__click=[ste],n.__keydown=[ote,wn];var i=Gt(n),a=Kt(Gt(i),2);a.__click=wn,Ng(Gt(a),{name:"times",size:"14"}),zt(a),zt(i);var r=Kt(i,2),s=Gt(r),o=Kt(Gt(s)),l=Gt(o);zt(o),Pt(),zt(s),Pt(2),zt(r);var c=Kt(r,2),d=Gt(c);d.__click=wn,Kt(d,2).__click=[Xee,Re,Wt],zt(c),zt(n),zt(t),zi(()=>{var e;return va(l,`"${null!=(e=bi($e))?e:""}..."`)}),pa(e,t)};xa(qn,e=>{bi(Re)&&e(Hn)});var Wn=Kt(qn,2),Gn=e=>{var t=cte(),n=Gt(t);{let e=In(()=>{var e;return null!=(e=bi(j))?e:void 0}),t=In(()=>{var e;return bi(z)?null==(e=_.getSessionState(bi(z)))?void 0:e.learningStepIndex:void 0});$6(n,{get card(){return bi(nt)},get fsrs(){return f()},get showAnswer(){return bi(R)},onRate:At,onShowAnswer:Tt,get cardType(){return bi(V)},get learningConfig(){return bi(e)},get learningStepIndex(){return bi(t)}})}zt(t),pa(e,t)};xa(Wn,e=>{bi(nt)&&!bi(ze)&&e(Gn)});var Qn=Kt(Wn,2),Kn=e=>{var t=dte();M6(Gt(t),{get compactMode(){return bi(Oe)},get compactModeSetting(){return bi(je)},onCompactModeSettingChange:kn,get card(){return bi(nt)},get currentCardTime(){return bi(ct)},get averageTime(){return bi(dt)},get plugin(){return y()},get decks(){return bi(N)},get isEditing(){return bi(ze)},get tempFileUnavailable(){return bi(Xe)},onToggleEdit:Vt,onDelete:Wt,onSetReminder:an,onChangePriority:rn,onSuspendCard:Zt,onRecycleCard:Zt,onChangeDeck:dn,get enableDirectDelete(){return bi(Pe)},onDirectDeleteToggle:bn,onOpenPlainEditor:()=>{$n(Xe,!0),$n(ze,!0)},onAIFormatCustom:on,onTestGenerate:cn,onSplitCard:e=>ye(e,0),onManageFormatActions:()=>{_e.debug("触发管理功能，当前showFormatManager:",bi(We)),$n(We,!0),_e.debug("设置showFormatManager为true:",bi(We))},onOpenDetailedView:Ce,onOpenCardDebug:De,get autoPlayMedia(){return bi(H)},get playMediaMode(){return bi(W)},get playMediaTiming(){return bi(G)},get playbackInterval(){return bi(Q)},onMediaAutoPlayChange:un,get isGraphLinked(){return bi(le)},onGraphLinkToggle:ue,onGraphLeafChange:he}),zt(t),pa(e,t)};xa(Qn,e=>{bi(nt)&&bi(Ae)&&e(Kn)}),zt(Tn);var Zn=Kt(Tn,2),Yn=e=>{var t=hte(),n=Gt(t),i=e=>{var t=ute();t.__click=[Kee,R,$],Ng(Gt(t),{name:"arrow-left",size:"18"}),zt(t),pa(e,t)};xa(n,e=>{bi(R)&&e(i)});var a=Kt(n,2);let r;a.__click=function(...e){var t;null==(t=bi(ot)>0?Mt:void 0)||t.apply(this,e)},Ng(Gt(a),{name:"undo",size:"18"}),zt(a),zt(t),zi(e=>{r=Fa(a,1,"compact-control-btn undo-btn svelte-1krx52u",null,r,e),er(a,"title",bi(ot)>0?"撤销上一次评分":"没有可撤销的操作"),a.disabled=0===bi(ot)},[()=>({disabled:0===bi(ot)})]),pa(e,t)};xa(Zn,e=>{bi(nt)&&!bi(ze)&&e(Yn)}),zt(Cn),kr(Cn,e=>$n(pn,e),()=>bi(pn)),zt(_n);var Xn=Kt(_n,2),Jn=e=>{var t=kte();t.__click=ht,t.__keydown=[pte,ht];var n=Gt(t);n.__click=[gte],n.__keydown=[vte,ht];var i=Gt(n),a=Gt(i),r=e=>{var t=ha();Ca(Qt(t),17,()=>bi(xt),_a,(e,t)=>{const n=In(()=>bi(nt)&&bi(t).id===bi(nt).templateId);var i=bte();let a;i.__click=[fte,pt,t],i.__keydown=[mte,pt,t];var r=Gt(i),s=Gt(r,!0);zt(r);var o=Kt(r,2),l=e=>{pa(e,yte())};xa(o,e=>{bi(n)&&e(l)}),zt(i),zi(e=>{a=Fa(i,1,"template-dropdown-item svelte-1krx52u",null,a,e),va(s,bi(t).name)},[()=>({current:bi(n)})]),pa(e,i)}),pa(e,t)},s=e=>{pa(e,wte())};xa(a,e=>{bi(xt).length>0?e(r):e(s,!1)}),zt(i),zt(n),kr(n,e=>$n(wt,e),()=>bi(wt)),zt(t),zi(()=>ja(n,`top:${bi(yt)}px; left:${bi(bt)}px;`)),pa(e,t)};xa(Xn,e=>{bi(mt)&&e(Jn)});var ei=Kt(Xn,2),ti=e=>{var t=Tte();t.__click=[Ste,Yt],t.__keydown=[xte,Yt];var n=Gt(t);n.__click=[_te],n.__keydown=[Cte,Yt];var i=Gt(n);Kt(Gt(i),2).__click=[Ite,Yt],zt(i);var a=Kt(i,2),r=Kt(Gt(a),2),s=Kt(Gt(r),2);Za(s),zt(r);var o=Kt(r,2),l=Kt(Gt(o),2);Za(l),zt(o);var c=Kt(o,2);Ng(Gt(c),{name:"info",size:"16"}),Pt(2),zt(c),zt(a);var d=Kt(a,2),u=Gt(d);u.__click=[Dte,Yt],Kt(u,2).__click=[Zee,nt,Xt,Jt,m,S,A,Yt],zt(d),zt(n),zt(t),pr(s,()=>bi(Xt),e=>$n(Xt,e)),pr(l,()=>bi(Jt),e=>$n(Jt,e)),pa(e,t)};xa(ei,e=>{bi(Yt)&&e(ti)});var ni=Kt(ei,2),ii=e=>{var t=Lte();t.__click=[Mte,en],t.__keydown=[Ate,en];var n=Gt(t);n.__click=[Ete],n.__keydown=[zte,en];var i=Gt(n);Kt(Gt(i),2).__click=[Pte,en],zt(i);var a=Kt(i,2),r=Kt(Gt(a),2);Ca(r,20,()=>[1,2,3,4],_a,(e,t)=>{var n=$te();let i;n.__click=[Rte,tn,t];var a=Gt(n),r=Gt(a);Ca(r,17,()=>Array(t),_a,(e,t)=>{Ng(e,{name:"starFilled",size:"16"})}),Ca(Kt(r,2),17,()=>Array(4-t),_a,(e,t)=>{Ng(e,{name:"star",size:"16"})}),zt(a);var s=Kt(a,2),o=Gt(s,!0);zt(s),zt(n),zi(e=>{i=Fa(n,1,"priority-option svelte-1krx52u",null,i,e),va(o,["","低优先级","中优先级","高优先级","紧急"][t])},[()=>({selected:bi(tn)===t})]),pa(e,n)}),zt(r),zt(a);var s=Kt(a,2),o=Gt(s);o.__click=[Ote,en],Kt(o,2).__click=[Yee,nt,tn,m,S,A,en],zt(s),zt(n),zt(t),pa(e,t)};xa(ni,e=>{bi(en)&&e(ii)});var ai=Kt(ni,2);s3(ai,{get featureId(){return Hh.ADVANCED_ANALYTICS},get visible(){return bi(Qe)},onClose:()=>$n(Qe,!1)});var ri=Kt(ai,2),si=e=>{Y8(e,{get show(){return bi(Ve)},get previewResult(){return bi(qe)},get actionName(){return bi(He)},onConfirm:ln,onCancel:()=>{$n(Ve,!1),$n(qe,null)}})};xa(ri,e=>{bi(Ve)&&bi(qe)&&e(si)});var oi=Kt(ri,2),li=e=>{Z9(e,{get show(){return bi(We)},get plugin(){return y()},get availableDecks(){return bi(N)},onClose:()=>$n(We,!1)})};xa(oi,e=>{bi(We)&&e(li)}),zi(e=>Mn=Fa(Tn,1,"study-content svelte-1krx52u",null,Mn,e),[()=>({"with-sidebar":bi(Ae)})]),na("drop",_n,e=>e.stopPropagation()),na("dragover",_n,e=>e.stopPropagation()),na("dragleave",_n,e=>e.stopPropagation()),pa(e,xn);var ci=St(Sn);return g(),ci}function Bte(e,t,n,i){"Enter"===e.key?(e.preventDefault(),bi(t).trim()&&n(bi(t))):"Backspace"===e.key&&""===bi(t)&&bi(i)&&(e.preventDefault(),$n(i,""))}function jte(e,t){$n(t,"")}async function Ute(e,t,n,i,a,r,s,o,l,c,d,u,h,p){var g,v;if(bi(t).trim()&&!bi(n)){$n(n,!0);try{const e=new Date;if("edit"===i()&&a()){const n={...a(),name:bi(t).trim(),category:bi(r).trim()||a().category||"默认",tags:bi(s)?[bi(s)]:[],modified:e.toISOString()},i=await o().saveDeck(n);if(!i.success)throw new Error(i.error||"saveDeck failed");return null==(g=l())||g(n),void c()}let n;if(bi(d))n=await u().deckHierarchy.createSubdeck(bi(d),bi(t).trim()),n.category=bi(r).trim()||"默认",n.tags=bi(s)?[bi(s)]:[],await o().saveDeck(n);else{const e={newCardsPerDay:20,maxReviewsPerDay:100,enableAutoAdvance:!0,showAnswerTime:0,fsrsParams:{w:u().settings.fsrsParams.w,requestRetention:u().settings.fsrsParams.requestRetention,maximumInterval:u().settings.fsrsParams.maximumInterval,enableFuzz:u().settings.fsrsParams.enableFuzz},learningSteps:u().settings.learningSteps,relearningSteps:[10],graduatingInterval:u().settings.graduatingInterval,easyInterval:4};n=await u().deckHierarchy.createRootDeck(bi(t).trim(),e),n.category=bi(r).trim()||"默认",n.tags=bi(s)?[bi(s)]:[],await o().saveDeck(n)}null==(v=h())||v(n),c()}catch(f){_e.error("Failed to create deck:",f);const e=f instanceof Error?f.message:"Unknown error";alert(bi(p)("modals.createDeck.createFailed").replace("{error}",e))}finally{$n(n,!1)}}}function Vte(e,t,n,i){const a=new ge.Menu;a.addItem(e=>{e.setTitle(bi(t)("modals.createDeck.noParent")).setChecked(null===bi(n)).onClick(()=>{$n(n,null)})}),a.addSeparator(),bi(i).forEach(e=>{a.addItem(t=>{t.setTitle(e.path||e.name).setChecked(bi(n)===e.id).onClick(()=>{$n(n,e.id,!0)})})}),a.showAtMouseEvent(e)}ia(["keydown","click"]);var qte=e=>e.stopPropagation(),Hte=(e,t)=>{"Escape"===e.key&&t()},Wte=la('<span class="hint svelte-ha69id"> </span>'),Gte=la('<label class="svelte-ha69id"><span class="svelte-ha69id"> </span> <button type="button" class="deck-selector-btn svelte-ha69id"><span class="deck-selector-text svelte-ha69id"> </span> <svg class="deck-selector-icon svelte-ha69id" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></button> <!></label>'),Qte=la('<div class="selected-tags svelte-ha69id"><span class="tag-chip svelte-ha69id"><span class="tag-text svelte-ha69id"> </span> <button type="button" class="tag-chip-remove svelte-ha69id" aria-label="移除标签">×</button></span></div>'),Kte=(e,t,n)=>t(bi(n)),Zte=la('<button type="button"> </button>'),Yte=la('<div class="available-tags svelte-ha69id"><div class="available-tags-title svelte-ha69id">可选标签（点击选择）</div> <div class="available-tags-list svelte-ha69id"></div></div>'),Xte=la('<div class="modal-overlay svelte-ha69id" role="presentation"><div class="modal svelte-ha69id" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-header svelte-ha69id"><h3 class="svelte-ha69id"> </h3> <button class="icon-btn svelte-ha69id">×</button></div> <div class="modal-body svelte-ha69id"><!> <label class="svelte-ha69id"><span class="svelte-ha69id"> </span> <input class="text-input svelte-ha69id"/></label> <label class="svelte-ha69id"><span class="svelte-ha69id">牌组标签（单选）</span> <div class="tag-input-wrapper svelte-ha69id"><!> <input class="tag-input svelte-ha69id"/></div> <!> <span class="hint svelte-ha69id">标签用于牌组分类，仅可选择一个标签</span></label></div> <div class="modal-footer svelte-ha69id"><button class="btn svelte-ha69id"> </button> <button class="btn primary svelte-ha69id"> </button></div></div></div>');function Jte(e,t){if(new.target)return Er({component:Jte,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"open",7),s=Ar(t,"plugin",7),o=Ar(t,"dataStorage",7),l=Ar(t,"onClose",7),c=Ar(t,"onCreated",7),d=Ar(t,"mode",7,"create"),u=Ar(t,"initialDeck",7,null),h=Ar(t,"onUpdated",7),p=Ar(t,"parentDeckId",7,null),g=In(n),v=Pn(""),f=Pn("默认"),m=Pn(null),y=Pn(Ot([])),b=Pn(!1),w=Pn(""),k=Pn(""),S=Pn(Ot([]));function x(e){const t=e.trim();t&&($n(w,t,!0),$n(k,""),bi(S).includes(t)||$n(S,[...bi(S),t].sort(),!0))}function _(){$n(v,""),$n(f,"默认"),$n(w,""),$n(k,""),$n(m,null),"function"==typeof l()&&l()()}function C(e){const t=bi(y).find(t=>t.id===e);return(null==t?void 0:t.path)||(null==t?void 0:t.name)||e}Ti(()=>{r()&&(async()=>{try{await async function(){try{const e=await o().getDecks();$n(y,e,!0)}catch(e){_e.error("Failed to load decks:",e),$n(y,[],!0)}}(),"edit"===d()&&u()?($n(v,u().name||"",!0),$n(f,u().category||"默认",!0),$n(w,u().tags&&u().tags.length>0?u().tags[0]:"",!0),$n(m,u().parentId||null,!0)):"create"===d()&&($n(v,""),$n(f,"默认"),$n(w,""),$n(k,""),$n(m,p()||null,!0)),function(){const e=new Set;bi(y).forEach(t=>{t.tags&&Array.isArray(t.tags)&&t.tags.forEach(t=>e.add(t))}),$n(S,Array.from(e).sort(),!0)}()}catch(e){_e.error("[CreateDeckModal] 初始化失败:",e),new ge.Notice(bi(g)("modals.createDeck.initFailed"))}})()});var I={get open(){return r()},set open(e){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},get dataStorage(){return o()},set dataStorage(e){o(e),hn()},get onClose(){return l()},set onClose(e){l(e),hn()},get onCreated(){return c()},set onCreated(e){c(e),hn()},get mode(){return d()},set mode(e="create"){d(e),hn()},get initialDeck(){return u()},set initialDeck(e=null){u(e),hn()},get onUpdated(){return h()},set onUpdated(e){h(e),hn()},get parentDeckId(){return p()},set parentDeckId(e=null){p(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},D=ha(),T=Qt(D),M=e=>{var t=Xte();t.__click=_;var n=Gt(t);n.__click=[qte],n.__keydown=[Hte,_];var i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var l=Kt(a,2);l.__click=_,zt(i);var p=Kt(i,2),I=Gt(p),D=e=>{var t=Gte(),n=Gt(t),i=Gt(n,!0);zt(n);var a=Kt(n,2);a.__click=[Vte,g,m,y];var r=Gt(a),s=Gt(r,!0);zt(r),Pt(2),zt(a);var o=Kt(a,2),l=e=>{var t=Wte(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>bi(g)("modals.createDeck.willCreateAs").replace("{parent}",C(bi(m)))]),pa(e,t)};xa(o,e=>{bi(m)&&e(l)}),zt(t),zi((e,t)=>{va(i,e),va(s,t)},[()=>bi(g)("modals.createDeck.parentDeck"),()=>bi(m)?C(bi(m)):bi(g)("modals.createDeck.noParent")]),pa(e,t)};xa(I,e=>{"create"===d()&&e(D)});var T=Kt(I,2),M=Gt(T),A=Gt(M,!0);zt(M);var E=Kt(M,2);Za(E),zt(T);var z=Kt(T,2),P=Kt(Gt(z),2),R=Gt(P),$=e=>{var t=Qte(),n=Gt(t),i=Gt(n),a=Gt(i,!0);zt(i),Kt(i,2).__click=[jte,w],zt(n),zt(t),zi(()=>va(a,bi(w))),pa(e,t)};xa(R,e=>{bi(w)&&e($)});var O=Kt(R,2);Za(O),O.__keydown=[Bte,k,x,w],zt(P);var L=Kt(P,2),N=e=>{var t=Yte(),n=Kt(Gt(t),2);Ca(n,21,()=>bi(S),_a,(e,t)=>{var n=Zte();n.__click=[Kte,x,t];var i=Gt(n,!0);zt(n),zi(()=>{Fa(n,1,"available-tag-item "+(bi(w)===bi(t)?"selected":""),"svelte-ha69id"),va(i,bi(t))}),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(L,e=>{bi(S).length>0&&e(N)}),Pt(2),zt(z),zt(p);var F=Kt(p,2),B=Gt(F);B.__click=_;var j=Gt(B,!0);zt(B);var U=Kt(B,2);U.__click=[Ute,v,b,d,u,f,w,o,h,_,m,s,c,g];var V=Gt(U,!0);zt(U),zt(F),zt(n),zt(t),zi((e,t,n,i,a,s,o)=>{va(r,e),er(l,"aria-label",t),va(A,n),er(E,"placeholder",i),er(O,"placeholder",bi(w)?"":"输入标签后按回车添加"),va(j,a),U.disabled=s,va(V,o)},[()=>"edit"===d()?bi(g)("modals.createDeck.titleEdit"):bi(m)?bi(g)("modals.createDeck.titleCreateSub"):bi(g)("modals.createDeck.titleCreate"),()=>bi(g)("modals.createDeck.close"),()=>bi(g)("modals.createDeck.name"),()=>bi(g)("modals.createDeck.namePlaceholder"),()=>bi(g)("modals.createDeck.cancel"),()=>!bi(v).trim()||bi(b),()=>"edit"===d()?bi(g)("modals.createDeck.save"):bi(g)("modals.createDeck.create")]),na("drop",t,e=>e.stopPropagation()),na("dragover",t,e=>e.stopPropagation()),na("dragleave",t,e=>e.stopPropagation()),pr(E,()=>bi(v),e=>$n(v,e)),pr(O,()=>bi(k),e=>$n(k,e)),pa(e,t)};xa(T,e=>{r()&&e(M)}),pa(e,D);var A=St(I);return a(),A}function ene(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function tne(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}ia(["click","keydown"]);var nne={exports:{}};nne.exports=function e(t,n,i){function a(s,o){if(!n[s]){if(!t[s]){if(!o&&tne)return tne(s);if(r)return r(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[s]={exports:{}};t[s][0].call(c.exports,function(e){return a(t[s][1][e]||e)},c,c.exports,e,t,n,i)}return n[s].exports}for(var r=tne,s=0;s<i.length;s++)a(i[s]);return a}({1:[function(e,t,n){var i=e("./utils"),a=e("./support"),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.encode=function(e){for(var t,n,a,s,o,l,c,d=[],u=0,h=e.length,p=h,g="string"!==i.getTypeOf(e);u<e.length;)p=h-u,a=g?(t=e[u++],n=u<h?e[u++]:0,u<h?e[u++]:0):(t=e.charCodeAt(u++),n=u<h?e.charCodeAt(u++):0,u<h?e.charCodeAt(u++):0),s=t>>2,o=(3&t)<<4|n>>4,l=1<p?(15&n)<<2|a>>6:64,c=2<p?63&a:64,d.push(r.charAt(s)+r.charAt(o)+r.charAt(l)+r.charAt(c));return d.join("")},n.decode=function(e){var t,n,i,s,o,l,c=0,d=0,u="data:";if(e.substr(0,u.length)===u)throw new Error("Invalid base64 input, it looks like a data url.");var h,p=3*(e=e.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(e.charAt(e.length-1)===r.charAt(64)&&p--,e.charAt(e.length-2)===r.charAt(64)&&p--,p%1!=0)throw new Error("Invalid base64 input, bad content length.");for(h=a.uint8array?new Uint8Array(0|p):new Array(0|p);c<e.length;)t=r.indexOf(e.charAt(c++))<<2|(s=r.indexOf(e.charAt(c++)))>>4,n=(15&s)<<4|(o=r.indexOf(e.charAt(c++)))>>2,i=(3&o)<<6|(l=r.indexOf(e.charAt(c++))),h[d++]=t,64!==o&&(h[d++]=n),64!==l&&(h[d++]=i);return h}},{"./support":30,"./utils":32}],2:[function(e,t,n){var i=e("./external"),a=e("./stream/DataWorker"),r=e("./stream/Crc32Probe"),s=e("./stream/DataLengthProbe");function o(e,t,n,i,a){this.compressedSize=e,this.uncompressedSize=t,this.crc32=n,this.compression=i,this.compressedContent=a}o.prototype={getContentWorker:function(){var e=new a(i.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new s("data_length")),t=this;return e.on("end",function(){if(this.streamInfo.data_length!==t.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),e},getCompressedWorker:function(){return new a(i.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},o.createWorkerFrom=function(e,t,n){return e.pipe(new r).pipe(new s("uncompressedSize")).pipe(t.compressWorker(n)).pipe(new s("compressedSize")).withStreamInfo("compression",t)},t.exports=o},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,t,n){var i=e("./stream/GenericWorker");n.STORE={magic:"\0\0",compressWorker:function(){return new i("STORE compression")},uncompressWorker:function(){return new i("STORE decompression")}},n.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,t,n){var i=e("./utils"),a=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();t.exports=function(e,t){return void 0!==e&&e.length?"string"!==i.getTypeOf(e)?function(e,t,n,i){var r=a,s=i+n;e^=-1;for(var o=i;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e}(0|t,e,e.length,0):function(e,t,n,i){var r=a,s=i+n;e^=-1;for(var o=i;o<s;o++)e=e>>>8^r[255&(e^t.charCodeAt(o))];return-1^e}(0|t,e,e.length,0):0}},{"./utils":32}],5:[function(e,t,n){n.base64=!1,n.binary=!1,n.dir=!1,n.createFolders=!0,n.date=null,n.compression=null,n.compressionOptions=null,n.comment=null,n.unixPermissions=null,n.dosPermissions=null},{}],6:[function(e,t,n){var i=null;i="undefined"!=typeof Promise?Promise:e("lie"),t.exports={Promise:i}},{lie:37}],7:[function(e,t,n){var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,a=e("pako"),r=e("./utils"),s=e("./stream/GenericWorker"),o=i?"uint8array":"array";function l(e,t){s.call(this,"FlateWorker/"+e),this._pako=null,this._pakoAction=e,this._pakoOptions=t,this.meta={}}n.magic="\b\0",r.inherits(l,s),l.prototype.processChunk=function(e){this.meta=e.meta,null===this._pako&&this._createPako(),this._pako.push(r.transformTo(o,e.data),!1)},l.prototype.flush=function(){s.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},l.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this._pako=null},l.prototype._createPako=function(){this._pako=new a[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var e=this;this._pako.onData=function(t){e.push({data:t,meta:e.meta})}},n.compressWorker=function(e){return new l("Deflate",e)},n.uncompressWorker=function(){return new l("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,t,n){function i(e,t){var n,i="";for(n=0;n<t;n++)i+=String.fromCharCode(255&e),e>>>=8;return i}function a(e,t,n,a,s,d){var u,h,p=e.file,g=e.compression,v=d!==o.utf8encode,f=r.transformTo("string",d(p.name)),m=r.transformTo("string",o.utf8encode(p.name)),y=p.comment,b=r.transformTo("string",d(y)),w=r.transformTo("string",o.utf8encode(y)),k=m.length!==p.name.length,S=w.length!==y.length,x="",_="",C="",I=p.dir,D=p.date,T={crc32:0,compressedSize:0,uncompressedSize:0};t&&!n||(T.crc32=e.crc32,T.compressedSize=e.compressedSize,T.uncompressedSize=e.uncompressedSize);var M=0;t&&(M|=8),v||!k&&!S||(M|=2048);var A,E,z,P=0,R=0;I&&(P|=16),"UNIX"===s?(R=798,P|=(A=p.unixPermissions,E=I,z=A,A||(z=E?16893:33204),(65535&z)<<16)):(R=20,P|=function(e){return 63&(e||0)}(p.dosPermissions)),u=D.getUTCHours(),u<<=6,u|=D.getUTCMinutes(),u<<=5,u|=D.getUTCSeconds()/2,h=D.getUTCFullYear()-1980,h<<=4,h|=D.getUTCMonth()+1,h<<=5,h|=D.getUTCDate(),k&&(_=i(1,1)+i(l(f),4)+m,x+="up"+i(_.length,2)+_),S&&(C=i(1,1)+i(l(b),4)+w,x+="uc"+i(C.length,2)+C);var $="";return $+="\n\0",$+=i(M,2),$+=g.magic,$+=i(u,2),$+=i(h,2),$+=i(T.crc32,4),$+=i(T.compressedSize,4),$+=i(T.uncompressedSize,4),$+=i(f.length,2),$+=i(x.length,2),{fileRecord:c.LOCAL_FILE_HEADER+$+f+x,dirRecord:c.CENTRAL_FILE_HEADER+i(R,2)+$+i(b.length,2)+"\0\0\0\0"+i(P,4)+i(a,4)+f+x+b}}var r=e("../utils"),s=e("../stream/GenericWorker"),o=e("../utf8"),l=e("../crc32"),c=e("../signature");function d(e,t,n,i){s.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=t,this.zipPlatform=n,this.encodeFileName=i,this.streamFiles=e,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}r.inherits(d,s),d.prototype.push=function(e){var t=e.meta.percent||0,n=this.entriesCount,i=this._sources.length;this.accumulate?this.contentBuffer.push(e):(this.bytesWritten+=e.data.length,s.prototype.push.call(this,{data:e.data,meta:{currentFile:this.currentFile,percent:n?(t+100*(n-i-1))/n:100}}))},d.prototype.openedSource=function(e){this.currentSourceOffset=this.bytesWritten,this.currentFile=e.file.name;var t=this.streamFiles&&!e.file.dir;if(t){var n=a(e,t,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:n.fileRecord,meta:{percent:0}})}else this.accumulate=!0},d.prototype.closedSource=function(e){this.accumulate=!1;var t,n=this.streamFiles&&!e.file.dir,r=a(e,n,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),n)this.push({data:(t=e,c.DATA_DESCRIPTOR+i(t.crc32,4)+i(t.compressedSize,4)+i(t.uncompressedSize,4)),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},d.prototype.flush=function(){for(var e=this.bytesWritten,t=0;t<this.dirRecords.length;t++)this.push({data:this.dirRecords[t],meta:{percent:100}});var n,a,s,o,l,d,u=this.bytesWritten-e,h=(n=this.dirRecords.length,a=u,s=e,o=this.zipComment,l=this.encodeFileName,d=r.transformTo("string",l(o)),c.CENTRAL_DIRECTORY_END+"\0\0\0\0"+i(n,2)+i(n,2)+i(a,4)+i(s,4)+i(d.length,2)+d);this.push({data:h,meta:{percent:100}})},d.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},d.prototype.registerPrevious=function(e){this._sources.push(e);var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.closedSource(t.previous.streamInfo),t._sources.length?t.prepareNextSource():t.end()}),e.on("error",function(e){t.error(e)}),this},d.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},d.prototype.error=function(e){var t=this._sources;if(!s.prototype.error.call(this,e))return!1;for(var n=0;n<t.length;n++)try{t[n].error(e)}catch(i){}return!0},d.prototype.lock=function(){s.prototype.lock.call(this);for(var e=this._sources,t=0;t<e.length;t++)e[t].lock()},t.exports=d},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,t,n){var i=e("../compressions"),a=e("./ZipFileWorker");n.generateWorker=function(e,t,n){var r=new a(t.streamFiles,n,t.platform,t.encodeFileName),s=0;try{e.forEach(function(e,n){s++;var a=function(e,t){var n=e||t,a=i[n];if(!a)throw new Error(n+" is not a valid compression method !");return a}(n.options.compression,t.compression),o=n.options.compressionOptions||t.compressionOptions||{},l=n.dir,c=n.date;n._compressWorker(a,o).withStreamInfo("file",{name:e,dir:l,date:c,comment:n.comment||"",unixPermissions:n.unixPermissions,dosPermissions:n.dosPermissions}).pipe(r)}),r.entriesCount=s}catch(o){r.error(o)}return r}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,t,n){function i(){if(!(this instanceof i))return new i;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var e=new i;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e}}(i.prototype=e("./object")).loadAsync=e("./load"),i.support=e("./support"),i.defaults=e("./defaults"),i.version="3.10.1",i.loadAsync=function(e,t){return(new i).loadAsync(e,t)},i.external=e("./external"),t.exports=i},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,t,n){var i=e("./utils"),a=e("./external"),r=e("./utf8"),s=e("./zipEntries"),o=e("./stream/Crc32Probe"),l=e("./nodejsUtils");function c(e){return new a.Promise(function(t,n){var i=e.decompressed.getContentWorker().pipe(new o);i.on("error",function(e){n(e)}).on("end",function(){i.streamInfo.crc32!==e.decompressed.crc32?n(new Error("Corrupted zip : CRC32 mismatch")):t()}).resume()})}t.exports=function(e,t){var n=this;return t=i.extend(t||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:r.utf8decode}),l.isNode&&l.isStream(e)?a.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):i.prepareContent("the loaded zip file",e,!0,t.optimizedBinaryString,t.base64).then(function(e){var n=new s(t);return n.load(e),n}).then(function(e){var n=[a.Promise.resolve(e)],i=e.files;if(t.checkCRC32)for(var r=0;r<i.length;r++)n.push(c(i[r]));return a.Promise.all(n)}).then(function(e){for(var a=e.shift(),r=a.files,s=0;s<r.length;s++){var o=r[s],l=o.fileNameStr,c=i.resolve(o.fileNameStr);n.file(c,o.decompressed,{binary:!0,optimizedBinaryString:!0,date:o.date,dir:o.dir,comment:o.fileCommentStr.length?o.fileCommentStr:null,unixPermissions:o.unixPermissions,dosPermissions:o.dosPermissions,createFolders:t.createFolders}),o.dir||(n.file(c).unsafeOriginalName=l)}return a.zipComment.length&&(n.comment=a.zipComment),n})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,t,n){var i=e("../utils"),a=e("../stream/GenericWorker");function r(e,t){a.call(this,"Nodejs stream input adapter for "+e),this._upstreamEnded=!1,this._bindStream(t)}i.inherits(r,a),r.prototype._bindStream=function(e){var t=this;(this._stream=e).pause(),e.on("data",function(e){t.push({data:e,meta:{percent:0}})}).on("error",function(e){t.isPaused?this.generatedError=e:t.error(e)}).on("end",function(){t.isPaused?t._upstreamEnded=!0:t.end()})},r.prototype.pause=function(){return!!a.prototype.pause.call(this)&&(this._stream.pause(),!0)},r.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},t.exports=r},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,t,n){var i=e("readable-stream").Readable;function a(e,t,n){i.call(this,t),this._helper=e;var a=this;e.on("data",function(e,t){a.push(e)||a._helper.pause(),n&&n(t)}).on("error",function(e){a.emit("error",e)}).on("end",function(){a.push(null)})}e("../utils").inherits(a,i),a.prototype._read=function(){this._helper.resume()},t.exports=a},{"../utils":32,"readable-stream":16}],14:[function(e,t,n){t.exports={isNode:"undefined"!=typeof Buffer,newBufferFrom:function(e,t){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(e,t);if("number"==typeof e)throw new Error('The "data" argument must not be a number');return new Buffer(e,t)},allocBuffer:function(e){if(Buffer.alloc)return Buffer.alloc(e);var t=new Buffer(e);return t.fill(0),t},isBuffer:function(e){return Buffer.isBuffer(e)},isStream:function(e){return e&&"function"==typeof e.on&&"function"==typeof e.pause&&"function"==typeof e.resume}}},{}],15:[function(e,t,n){function i(e,t,n){var i,a=r.getTypeOf(t),o=r.extend(n||{},l);o.date=o.date||new Date,null!==o.compression&&(o.compression=o.compression.toUpperCase()),"string"==typeof o.unixPermissions&&(o.unixPermissions=parseInt(o.unixPermissions,8)),o.unixPermissions&&16384&o.unixPermissions&&(o.dir=!0),o.dosPermissions&&16&o.dosPermissions&&(o.dir=!0),o.dir&&(e=v(e)),o.createFolders&&(i=g(e))&&f.call(this,i,!0);var u="string"===a&&!1===o.binary&&!1===o.base64;n&&void 0!==n.binary||(o.binary=!u),(t instanceof c&&0===t.uncompressedSize||o.dir||!t||0===t.length)&&(o.base64=!1,o.binary=!0,t="",o.compression="STORE",a="string");var m=null;m=t instanceof c||t instanceof s?t:h.isNode&&h.isStream(t)?new p(e,t):r.prepareContent(e,t,o.binary,o.optimizedBinaryString,o.base64);var y=new d(e,m,o);this.files[e]=y}var a=e("./utf8"),r=e("./utils"),s=e("./stream/GenericWorker"),o=e("./stream/StreamHelper"),l=e("./defaults"),c=e("./compressedObject"),d=e("./zipObject"),u=e("./generate"),h=e("./nodejsUtils"),p=e("./nodejs/NodejsStreamInputAdapter"),g=function(e){"/"===e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return 0<t?e.substring(0,t):""},v=function(e){return"/"!==e.slice(-1)&&(e+="/"),e},f=function(e,t){return t=void 0!==t?t:l.createFolders,e=v(e),this.files[e]||i.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]};function m(e){return"[object RegExp]"===Object.prototype.toString.call(e)}var y={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(e){var t,n,i;for(t in this.files)i=this.files[t],(n=t.slice(this.root.length,t.length))&&t.slice(0,this.root.length)===this.root&&e(n,i)},filter:function(e){var t=[];return this.forEach(function(n,i){e(n,i)&&t.push(i)}),t},file:function(e,t,n){if(1!==arguments.length)return e=this.root+e,i.call(this,e,t,n),this;if(m(e)){var a=e;return this.filter(function(e,t){return!t.dir&&a.test(e)})}var r=this.files[this.root+e];return r&&!r.dir?r:null},folder:function(e){if(!e)return this;if(m(e))return this.filter(function(t,n){return n.dir&&e.test(t)});var t=this.root+e,n=f.call(this,t),i=this.clone();return i.root=n.name,i},remove:function(e){e=this.root+e;var t=this.files[e];if(t||("/"!==e.slice(-1)&&(e+="/"),t=this.files[e]),t&&!t.dir)delete this.files[e];else for(var n=this.filter(function(t,n){return n.name.slice(0,e.length)===e}),i=0;i<n.length;i++)delete this.files[n[i].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(e){var t,n={};try{if((n=r.extend(e||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:a.utf8encode})).type=n.type.toLowerCase(),n.compression=n.compression.toUpperCase(),"binarystring"===n.type&&(n.type="string"),!n.type)throw new Error("No output type specified.");r.checkSupport(n.type),"darwin"!==n.platform&&"freebsd"!==n.platform&&"linux"!==n.platform&&"sunos"!==n.platform||(n.platform="UNIX"),"win32"===n.platform&&(n.platform="DOS");var i=n.comment||this.comment||"";t=u.generateWorker(this,n,i)}catch(l){(t=new s("error")).error(l)}return new o(t,n.type||"string",n.mimeType)},generateAsync:function(e,t){return this.generateInternalStream(e).accumulate(t)},generateNodeStream:function(e,t){return(e=e||{}).type||(e.type="nodebuffer"),this.generateInternalStream(e).toNodejsStream(t)}};t.exports=y},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,t,n){t.exports=e("stream")},{stream:void 0}],17:[function(e,t,n){var i=e("./DataReader");function a(e){i.call(this,e);for(var t=0;t<this.data.length;t++)e[t]=255&e[t]}e("../utils").inherits(a,i),a.prototype.byteAt=function(e){return this.data[this.zero+e]},a.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),n=e.charCodeAt(1),i=e.charCodeAt(2),a=e.charCodeAt(3),r=this.length-4;0<=r;--r)if(this.data[r]===t&&this.data[r+1]===n&&this.data[r+2]===i&&this.data[r+3]===a)return r-this.zero;return-1},a.prototype.readAndCheckSignature=function(e){var t=e.charCodeAt(0),n=e.charCodeAt(1),i=e.charCodeAt(2),a=e.charCodeAt(3),r=this.readData(4);return t===r[0]&&n===r[1]&&i===r[2]&&a===r[3]},a.prototype.readData=function(e){if(this.checkOffset(e),0===e)return[];var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./DataReader":18}],18:[function(e,t,n){var i=e("../utils");function a(e){this.data=e,this.length=e.length,this.index=0,this.zero=0}a.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<this.zero+e||e<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(){},readInt:function(e){var t,n=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)n=(n<<8)+this.byteAt(t);return this.index+=e,n},readString:function(e){return i.transformTo("string",this.readData(e))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var e=this.readInt(4);return new Date(Date.UTC(1980+(e>>25&127),(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1))}},t.exports=a},{"../utils":32}],19:[function(e,t,n){var i=e("./Uint8ArrayReader");function a(e){i.call(this,e)}e("../utils").inherits(a,i),a.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,t,n){var i=e("./DataReader");function a(e){i.call(this,e)}e("../utils").inherits(a,i),a.prototype.byteAt=function(e){return this.data.charCodeAt(this.zero+e)},a.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)-this.zero},a.prototype.readAndCheckSignature=function(e){return e===this.readData(4)},a.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./DataReader":18}],21:[function(e,t,n){var i=e("./ArrayReader");function a(e){i.call(this,e)}e("../utils").inherits(a,i),a.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=a},{"../utils":32,"./ArrayReader":17}],22:[function(e,t,n){var i=e("../utils"),a=e("../support"),r=e("./ArrayReader"),s=e("./StringReader"),o=e("./NodeBufferReader"),l=e("./Uint8ArrayReader");t.exports=function(e){var t=i.getTypeOf(e);return i.checkSupport(t),"string"!==t||a.uint8array?"nodebuffer"===t?new o(e):a.uint8array?new l(i.transformTo("uint8array",e)):new r(i.transformTo("array",e)):new s(e)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,t,n){n.LOCAL_FILE_HEADER="PK",n.CENTRAL_FILE_HEADER="PK",n.CENTRAL_DIRECTORY_END="PK",n.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",n.ZIP64_CENTRAL_DIRECTORY_END="PK",n.DATA_DESCRIPTOR="PK\b"},{}],24:[function(e,t,n){var i=e("./GenericWorker"),a=e("../utils");function r(e){i.call(this,"ConvertWorker to "+e),this.destType=e}a.inherits(r,i),r.prototype.processChunk=function(e){this.push({data:a.transformTo(this.destType,e.data),meta:e.meta})},t.exports=r},{"../utils":32,"./GenericWorker":28}],25:[function(e,t,n){var i=e("./GenericWorker"),a=e("../crc32");function r(){i.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(r,i),r.prototype.processChunk=function(e){this.streamInfo.crc32=a(e.data,this.streamInfo.crc32||0),this.push(e)},t.exports=r},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,t,n){var i=e("../utils"),a=e("./GenericWorker");function r(e){a.call(this,"DataLengthProbe for "+e),this.propName=e,this.withStreamInfo(e,0)}i.inherits(r,a),r.prototype.processChunk=function(e){if(e){var t=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=t+e.data.length}a.prototype.processChunk.call(this,e)},t.exports=r},{"../utils":32,"./GenericWorker":28}],27:[function(e,t,n){var i=e("../utils"),a=e("./GenericWorker");function r(e){a.call(this,"DataWorker");var t=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,e.then(function(e){t.dataIsReady=!0,t.data=e,t.max=e&&e.length||0,t.type=i.getTypeOf(e),t.isPaused||t._tickAndRepeat()},function(e){t.error(e)})}i.inherits(r,a),r.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this.data=null},r.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,i.delay(this._tickAndRepeat,[],this)),!0)},r.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(i.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},r.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var e=null,t=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":e=this.data.substring(this.index,t);break;case"uint8array":e=this.data.subarray(this.index,t);break;case"array":case"nodebuffer":e=this.data.slice(this.index,t)}return this.index=t,this.push({data:e,meta:{percent:this.max?this.index/this.max*100:0}})},t.exports=r},{"../utils":32,"./GenericWorker":28}],28:[function(e,t,n){function i(e){this.name=e||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}i.prototype={push:function(e){this.emit("data",e)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(e){this.emit("error",e)}return!0},error:function(e){return!this.isFinished&&(this.isPaused?this.generatedError=e:(this.isFinished=!0,this.emit("error",e),this.previous&&this.previous.error(e),this.cleanUp()),!0)},on:function(e,t){return this._listeners[e].push(t),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(e,t){if(this._listeners[e])for(var n=0;n<this._listeners[e].length;n++)this._listeners[e][n].call(this,t)},pipe:function(e){return e.registerPrevious(this)},registerPrevious:function(e){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=e.streamInfo,this.mergeStreamInfo(),this.previous=e;var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.end()}),e.on("error",function(e){t.error(e)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var e=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),e=!0),this.previous&&this.previous.resume(),!e},flush:function(){},processChunk:function(e){this.push(e)},withStreamInfo:function(e,t){return this.extraStreamInfo[e]=t,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var e in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,e)&&(this.streamInfo[e]=this.extraStreamInfo[e])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var e="Worker "+this.name;return this.previous?this.previous+" -> "+e:e}},t.exports=i},{}],29:[function(e,t,n){var i=e("../utils"),a=e("./ConvertWorker"),r=e("./GenericWorker"),s=e("../base64"),o=e("../support"),l=e("../external"),c=null;if(o.nodestream)try{c=e("../nodejs/NodejsStreamOutputAdapter")}catch(h){}function d(e,t){return new l.Promise(function(n,a){var r=[],o=e._internalType,l=e._outputType,c=e._mimeType;e.on("data",function(e,n){r.push(e),t&&t(n)}).on("error",function(e){r=[],a(e)}).on("end",function(){try{var e=function(e,t,n){switch(e){case"blob":return i.newBlob(i.transformTo("arraybuffer",t),n);case"base64":return s.encode(t);default:return i.transformTo(e,t)}}(l,function(e,t){var n,i=0,a=null,r=0;for(n=0;n<t.length;n++)r+=t[n].length;switch(e){case"string":return t.join("");case"array":return Array.prototype.concat.apply([],t);case"uint8array":for(a=new Uint8Array(r),n=0;n<t.length;n++)a.set(t[n],i),i+=t[n].length;return a;case"nodebuffer":return Buffer.concat(t);default:throw new Error("concat : unsupported type '"+e+"'")}}(o,r),c);n(e)}catch(t){a(t)}r=[]}).resume()})}function u(e,t,n){var s=t;switch(t){case"blob":case"arraybuffer":s="uint8array";break;case"base64":s="string"}try{this._internalType=s,this._outputType=t,this._mimeType=n,i.checkSupport(s),this._worker=e.pipe(new a(s)),e.lock()}catch(o){this._worker=new r("error"),this._worker.error(o)}}u.prototype={accumulate:function(e){return d(this,e)},on:function(e,t){var n=this;return"data"===e?this._worker.on(e,function(e){t.call(n,e.data,e.meta)}):this._worker.on(e,function(){i.delay(t,arguments,n)}),this},resume:function(){return i.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(e){if(i.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new c(this,{objectMode:"nodebuffer"!==this._outputType},e)}},t.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,t,n){if(n.base64=!0,n.array=!0,n.string=!0,n.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,n.nodebuffer="undefined"!=typeof Buffer,n.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)n.blob=!1;else{var i=new ArrayBuffer(0);try{n.blob=0===new Blob([i],{type:"application/zip"}).size}catch(r){try{var a=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);a.append(i),n.blob=0===a.getBlob("application/zip").size}catch(s){n.blob=!1}}}try{n.nodestream=!!e("readable-stream").Readable}catch(r){n.nodestream=!1}},{"readable-stream":16}],31:[function(e,t,n){for(var i=e("./utils"),a=e("./support"),r=e("./nodejsUtils"),s=e("./stream/GenericWorker"),o=new Array(256),l=0;l<256;l++)o[l]=252<=l?6:248<=l?5:240<=l?4:224<=l?3:192<=l?2:1;function c(){s.call(this,"utf-8 decode"),this.leftOver=null}function d(){s.call(this,"utf-8 encode")}o[254]=o[254]=1,n.utf8encode=function(e){return a.nodebuffer?r.newBufferFrom(e,"utf-8"):function(e){var t,n,i,r,s,o=e.length,l=0;for(r=0;r<o;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(i=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(i-56320),r++),l+=n<128?1:n<2048?2:n<65536?3:4;for(t=a.uint8array?new Uint8Array(l):new Array(l),r=s=0;s<l;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(i=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(i-56320),r++),n<128?t[s++]=n:(n<2048?t[s++]=192|n>>>6:(n<65536?t[s++]=224|n>>>12:(t[s++]=240|n>>>18,t[s++]=128|n>>>12&63),t[s++]=128|n>>>6&63),t[s++]=128|63&n);return t}(e)},n.utf8decode=function(e){return a.nodebuffer?i.transformTo("nodebuffer",e).toString("utf-8"):function(e){var t,n,a,r,s=e.length,l=new Array(2*s);for(t=n=0;t<s;)if((a=e[t++])<128)l[n++]=a;else if(4<(r=o[a]))l[n++]=65533,t+=r-1;else{for(a&=2===r?31:3===r?15:7;1<r&&t<s;)a=a<<6|63&e[t++],r--;1<r?l[n++]=65533:a<65536?l[n++]=a:(a-=65536,l[n++]=55296|a>>10&1023,l[n++]=56320|1023&a)}return l.length!==n&&(l.subarray?l=l.subarray(0,n):l.length=n),i.applyFromCharCode(l)}(e=i.transformTo(a.uint8array?"uint8array":"array",e))},i.inherits(c,s),c.prototype.processChunk=function(e){var t=i.transformTo(a.uint8array?"uint8array":"array",e.data);if(this.leftOver&&this.leftOver.length){if(a.uint8array){var r=t;(t=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),t.set(r,this.leftOver.length)}else t=this.leftOver.concat(t);this.leftOver=null}var s=function(e,t){var n;for((t=t||e.length)>e.length&&(t=e.length),n=t-1;0<=n&&128==(192&e[n]);)n--;return n<0||0===n?t:n+o[e[n]]>t?n:t}(t),l=t;s!==t.length&&(a.uint8array?(l=t.subarray(0,s),this.leftOver=t.subarray(s,t.length)):(l=t.slice(0,s),this.leftOver=t.slice(s,t.length))),this.push({data:n.utf8decode(l),meta:e.meta})},c.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:n.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},n.Utf8DecodeWorker=c,i.inherits(d,s),d.prototype.processChunk=function(e){this.push({data:n.utf8encode(e.data),meta:e.meta})},n.Utf8EncodeWorker=d},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,t,n){var i=e("./support"),a=e("./base64"),r=e("./nodejsUtils"),s=e("./external");function o(e){return e}function l(e,t){for(var n=0;n<e.length;++n)t[n]=255&e.charCodeAt(n);return t}e("setimmediate"),n.newBlob=function(e,t){n.checkSupport("blob");try{return new Blob([e],{type:t})}catch(a){try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return i.append(e),i.getBlob(t)}catch(r){throw new Error("Bug : can't construct the Blob.")}}};var c={stringifyByChunk:function(e,t,n){var i=[],a=0,r=e.length;if(r<=n)return String.fromCharCode.apply(null,e);for(;a<r;)"array"===t||"nodebuffer"===t?i.push(String.fromCharCode.apply(null,e.slice(a,Math.min(a+n,r)))):i.push(String.fromCharCode.apply(null,e.subarray(a,Math.min(a+n,r)))),a+=n;return i.join("")},stringifyByChar:function(e){for(var t="",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t},applyCanBeUsed:{uint8array:function(){try{return i.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(e){return!1}}(),nodebuffer:function(){try{return i.nodebuffer&&1===String.fromCharCode.apply(null,r.allocBuffer(1)).length}catch(e){return!1}}()}};function d(e){var t=65536,i=n.getTypeOf(e),a=!0;if("uint8array"===i?a=c.applyCanBeUsed.uint8array:"nodebuffer"===i&&(a=c.applyCanBeUsed.nodebuffer),a)for(;1<t;)try{return c.stringifyByChunk(e,i,t)}catch(r){t=Math.floor(t/2)}return c.stringifyByChar(e)}function u(e,t){for(var n=0;n<e.length;n++)t[n]=e[n];return t}n.applyFromCharCode=d;var h={};h.string={string:o,array:function(e){return l(e,new Array(e.length))},arraybuffer:function(e){return h.string.uint8array(e).buffer},uint8array:function(e){return l(e,new Uint8Array(e.length))},nodebuffer:function(e){return l(e,r.allocBuffer(e.length))}},h.array={string:d,array:o,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBufferFrom(e)}},h.arraybuffer={string:function(e){return d(new Uint8Array(e))},array:function(e){return u(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:o,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return r.newBufferFrom(new Uint8Array(e))}},h.uint8array={string:d,array:function(e){return u(e,new Array(e.length))},arraybuffer:function(e){return e.buffer},uint8array:o,nodebuffer:function(e){return r.newBufferFrom(e)}},h.nodebuffer={string:d,array:function(e){return u(e,new Array(e.length))},arraybuffer:function(e){return h.nodebuffer.uint8array(e).buffer},uint8array:function(e){return u(e,new Uint8Array(e.length))},nodebuffer:o},n.transformTo=function(e,t){if(t=t||"",!e)return t;n.checkSupport(e);var i=n.getTypeOf(t);return h[i][e](t)},n.resolve=function(e){for(var t=e.split("/"),n=[],i=0;i<t.length;i++){var a=t[i];"."===a||""===a&&0!==i&&i!==t.length-1||(".."===a?n.pop():n.push(a))}return n.join("/")},n.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":i.nodebuffer&&r.isBuffer(e)?"nodebuffer":i.uint8array&&e instanceof Uint8Array?"uint8array":i.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},n.checkSupport=function(e){if(!i[e.toLowerCase()])throw new Error(e+" is not supported by this platform")},n.MAX_VALUE_16BITS=65535,n.MAX_VALUE_32BITS=-1,n.pretty=function(e){var t,n,i="";for(n=0;n<(e||"").length;n++)i+="\\x"+((t=e.charCodeAt(n))<16?"0":"")+t.toString(16).toUpperCase();return i},n.delay=function(e,t,n){setImmediate(function(){e.apply(n||null,t||[])})},n.inherits=function(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n},n.extend=function(){var e,t,n={};for(e=0;e<arguments.length;e++)for(t in arguments[e])Object.prototype.hasOwnProperty.call(arguments[e],t)&&void 0===n[t]&&(n[t]=arguments[e][t]);return n},n.prepareContent=function(e,t,r,o,c){return s.Promise.resolve(t).then(function(e){return i.blob&&(e instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(e)))&&"undefined"!=typeof FileReader?new s.Promise(function(t,n){var i=new FileReader;i.onload=function(e){t(e.target.result)},i.onerror=function(e){n(e.target.error)},i.readAsArrayBuffer(e)}):e}).then(function(t){var d,u=n.getTypeOf(t);return u?("arraybuffer"===u?t=n.transformTo("uint8array",t):"string"===u&&(c?t=a.decode(t):r&&!0!==o&&(t=l(d=t,i.uint8array?new Uint8Array(d.length):new Array(d.length)))),t):s.Promise.reject(new Error("Can't read the data of '"+e+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,t,n){var i=e("./reader/readerFor"),a=e("./utils"),r=e("./signature"),s=e("./zipEntry"),o=e("./support");function l(e){this.files=[],this.loadOptions=e}l.prototype={checkSignature:function(e){if(!this.reader.readAndCheckSignature(e)){this.reader.index-=4;var t=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+a.pretty(t)+", expected "+a.pretty(e)+")")}},isSignature:function(e,t){var n=this.reader.index;this.reader.setIndex(e);var i=this.reader.readString(4)===t;return this.reader.setIndex(n),i},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var e=this.reader.readData(this.zipCommentLength),t=o.uint8array?"uint8array":"array",n=a.transformTo(t,e);this.zipComment=this.loadOptions.decodeFileName(n)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var e,t,n,i=this.zip64EndOfCentralSize-44;0<i;)e=this.reader.readInt(2),t=this.reader.readInt(4),n=this.reader.readData(t),this.zip64ExtensibleData[e]={id:e,length:t,value:n}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(r.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8(),t.processAttributes()},readCentralDir:function(){var e;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(r.CENTRAL_FILE_HEADER);)(e=new s({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(e);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(r.CENTRAL_DIRECTORY_END);if(e<0)throw this.isSignature(0,r.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(e);var t=e;if(this.checkSignature(r.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===a.MAX_VALUE_16BITS||this.diskWithCentralDirStart===a.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===a.MAX_VALUE_16BITS||this.centralDirRecords===a.MAX_VALUE_16BITS||this.centralDirSize===a.MAX_VALUE_32BITS||this.centralDirOffset===a.MAX_VALUE_32BITS){if(this.zip64=!0,(e=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(e),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,r.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(r.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var n=this.centralDirOffset+this.centralDirSize;this.zip64&&(n+=20,n+=12+this.zip64EndOfCentralSize);var i=t-n;if(0<i)this.isSignature(t,r.CENTRAL_FILE_HEADER)||(this.reader.zero=i);else if(i<0)throw new Error("Corrupted zip: missing "+Math.abs(i)+" bytes.")},prepareReader:function(e){this.reader=i(e)},load:function(e){this.prepareReader(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=l},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,t,n){var i=e("./reader/readerFor"),a=e("./utils"),r=e("./compressedObject"),s=e("./crc32"),o=e("./utf8"),l=e("./compressions"),c=e("./support");function d(e,t){this.options=e,this.loadOptions=t}d.prototype={isEncrypted:function(){return!(1&~this.bitFlag)},useUTF8:function(){return!(2048&~this.bitFlag)},readLocalPart:function(e){var t,n;if(e.skip(22),this.fileNameLength=e.readInt(2),n=e.readInt(2),this.fileName=e.readData(this.fileNameLength),e.skip(n),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(t=function(e){for(var t in l)if(Object.prototype.hasOwnProperty.call(l,t)&&l[t].magic===e)return l[t];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+a.pretty(this.compressionMethod)+" unknown (inner file : "+a.transformTo("string",this.fileName)+")");this.decompressed=new r(this.compressedSize,this.uncompressedSize,this.crc32,t,e.readData(this.compressedSize))},readCentralPart:function(e){this.versionMadeBy=e.readInt(2),e.skip(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4);var t=e.readInt(2);if(this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");e.skip(t),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var e=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0==e&&(this.dosPermissions=63&this.externalFileAttributes),3==e&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var e=i(this.extraFields[1].value);this.uncompressedSize===a.MAX_VALUE_32BITS&&(this.uncompressedSize=e.readInt(8)),this.compressedSize===a.MAX_VALUE_32BITS&&(this.compressedSize=e.readInt(8)),this.localHeaderOffset===a.MAX_VALUE_32BITS&&(this.localHeaderOffset=e.readInt(8)),this.diskNumberStart===a.MAX_VALUE_32BITS&&(this.diskNumberStart=e.readInt(4))}},readExtraFields:function(e){var t,n,i,a=e.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});e.index+4<a;)t=e.readInt(2),n=e.readInt(2),i=e.readData(n),this.extraFields[t]={id:t,length:n,value:i};e.setIndex(a)},handleUTF8:function(){var e=c.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=o.utf8decode(this.fileName),this.fileCommentStr=o.utf8decode(this.fileComment);else{var t=this.findExtraFieldUnicodePath();if(null!==t)this.fileNameStr=t;else{var n=a.transformTo(e,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(n)}var i=this.findExtraFieldUnicodeComment();if(null!==i)this.fileCommentStr=i;else{var r=a.transformTo(e,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(r)}}},findExtraFieldUnicodePath:function(){var e=this.extraFields[28789];if(e){var t=i(e.value);return 1!==t.readInt(1)||s(this.fileName)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null},findExtraFieldUnicodeComment:function(){var e=this.extraFields[25461];if(e){var t=i(e.value);return 1!==t.readInt(1)||s(this.fileComment)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null}},t.exports=d},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,t,n){function i(e,t,n){this.name=e,this.dir=n.dir,this.date=n.date,this.comment=n.comment,this.unixPermissions=n.unixPermissions,this.dosPermissions=n.dosPermissions,this._data=t,this._dataBinary=n.binary,this.options={compression:n.compression,compressionOptions:n.compressionOptions}}var a=e("./stream/StreamHelper"),r=e("./stream/DataWorker"),s=e("./utf8"),o=e("./compressedObject"),l=e("./stream/GenericWorker");i.prototype={internalStream:function(e){var t=null,n="string";try{if(!e)throw new Error("No output type specified.");var i="string"===(n=e.toLowerCase())||"text"===n;"binarystring"!==n&&"text"!==n||(n="string"),t=this._decompressWorker();var r=!this._dataBinary;r&&!i&&(t=t.pipe(new s.Utf8EncodeWorker)),!r&&i&&(t=t.pipe(new s.Utf8DecodeWorker))}catch(o){(t=new l("error")).error(o)}return new a(t,n,"")},async:function(e,t){return this.internalStream(e).accumulate(t)},nodeStream:function(e,t){return this.internalStream(e||"nodebuffer").toNodejsStream(t)},_compressWorker:function(e,t){if(this._data instanceof o&&this._data.compression.magic===e.magic)return this._data.getCompressedWorker();var n=this._decompressWorker();return this._dataBinary||(n=n.pipe(new s.Utf8EncodeWorker)),o.createWorkerFrom(n,e,t)},_decompressWorker:function(){return this._data instanceof o?this._data.getContentWorker():this._data instanceof l?this._data:new r(this._data)}};for(var c=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],d=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<c.length;u++)i.prototype[c[u]]=d;t.exports=i},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,t,n){(function(e){var n,i,a=e.MutationObserver||e.WebKitMutationObserver;if(a){var r=0,s=new a(d),o=e.document.createTextNode("");s.observe(o,{characterData:!0}),n=function(){o.data=r=++r%2}}else if(e.setImmediate||void 0===e.MessageChannel)n="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){d(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(d,0)};else{var l=new e.MessageChannel;l.port1.onmessage=d,n=function(){l.port2.postMessage(0)}}var c=[];function d(){var e,t;i=!0;for(var n=c.length;n;){for(t=c,c=[],e=-1;++e<n;)t[e]();n=c.length}i=!1}t.exports=function(e){1!==c.push(e)||i||n()}}).call(this,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],37:[function(e,t,n){var i=e("immediate");function a(){}var r={},s=["REJECTED"],o=["FULFILLED"],l=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==a&&p(this,e)}function d(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function u(e,t,n){i(function(){var i;try{i=t(n)}catch(a){return r.reject(e,a)}i===e?r.reject(e,new TypeError("Cannot resolve promise with itself")):r.resolve(e,i)})}function h(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var n=!1;function i(t){n||(n=!0,r.reject(e,t))}function a(t){n||(n=!0,r.resolve(e,t))}var s=g(function(){t(a,i)});"error"===s.status&&i(s.value)}function g(e,t){var n={};try{n.value=e(t),n.status="success"}catch(i){n.status="error",n.value=i}return n}(t.exports=c).prototype.finally=function(e){if("function"!=typeof e)return this;var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){throw n})})},c.prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===o||"function"!=typeof t&&this.state===s)return this;var n=new this.constructor(a);return this.state!==l?u(n,this.state===o?e:t,this.outcome):this.queue.push(new d(n,e,t)),n},d.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},d.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},d.prototype.callRejected=function(e){r.reject(this.promise,e)},d.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},r.resolve=function(e,t){var n=g(h,t);if("error"===n.status)return r.reject(e,n.value);var i=n.value;if(i)p(e,i);else{e.state=o,e.outcome=t;for(var a=-1,s=e.queue.length;++a<s;)e.queue[a].callFulfilled(t)}return e},r.reject=function(e,t){e.state=s,e.outcome=t;for(var n=-1,i=e.queue.length;++n<i;)e.queue[n].callRejected(t);return e},c.resolve=function(e){return e instanceof this?e:r.resolve(new this(a),e)},c.reject=function(e){var t=new this(a);return r.reject(t,e)},c.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var s=new Array(n),o=0,l=-1,c=new this(a);++l<n;)d(e[l],l);return c;function d(e,a){t.resolve(e).then(function(e){s[a]=e,++o!==n||i||(i=!0,r.resolve(c,s))},function(e){i||(i=!0,r.reject(c,e))})}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var s,o=-1,l=new this(a);++o<n;)s=e[o],t.resolve(s).then(function(e){i||(i=!0,r.resolve(l,e))},function(e){i||(i=!0,r.reject(l,e))});return l}},{immediate:36}],38:[function(e,t,n){var i={};(0,e("./lib/utils/common").assign)(i,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=i},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,t,n){var i=e("./zlib/deflate"),a=e("./utils/common"),r=e("./utils/strings"),s=e("./zlib/messages"),o=e("./zlib/zstream"),l=Object.prototype.toString,c=0,d=-1,u=0,h=8;function p(e){if(!(this instanceof p))return new p(e);this.options=a.assign({level:d,method:h,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},e||{});var t=this.options;t.raw&&0<t.windowBits?t.windowBits=-t.windowBits:t.gzip&&0<t.windowBits&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new o,this.strm.avail_out=0;var n=i.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==c)throw new Error(s[n]);if(t.header&&i.deflateSetHeader(this.strm,t.header),t.dictionary){var g;if(g="string"==typeof t.dictionary?r.string2buf(t.dictionary):"[object ArrayBuffer]"===l.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(n=i.deflateSetDictionary(this.strm,g))!==c)throw new Error(s[n]);this._dict_set=!0}}function g(e,t){var n=new p(t);if(n.push(e,!0),n.err)throw n.msg||s[n.err];return n.result}p.prototype.push=function(e,t){var n,s,o=this.strm,d=this.options.chunkSize;if(this.ended)return!1;s=t===~~t?t:!0===t?4:0,"string"==typeof e?o.input=r.string2buf(e):"[object ArrayBuffer]"===l.call(e)?o.input=new Uint8Array(e):o.input=e,o.next_in=0,o.avail_in=o.input.length;do{if(0===o.avail_out&&(o.output=new a.Buf8(d),o.next_out=0,o.avail_out=d),1!==(n=i.deflate(o,s))&&n!==c)return this.onEnd(n),!(this.ended=!0);0!==o.avail_out&&(0!==o.avail_in||4!==s&&2!==s)||("string"===this.options.to?this.onData(r.buf2binstring(a.shrinkBuf(o.output,o.next_out))):this.onData(a.shrinkBuf(o.output,o.next_out)))}while((0<o.avail_in||0===o.avail_out)&&1!==n);return 4===s?(n=i.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===c):2!==s||(this.onEnd(c),!(o.avail_out=0))},p.prototype.onData=function(e){this.chunks.push(e)},p.prototype.onEnd=function(e){e===c&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Deflate=p,n.deflate=g,n.deflateRaw=function(e,t){return(t=t||{}).raw=!0,g(e,t)},n.gzip=function(e,t){return(t=t||{}).gzip=!0,g(e,t)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,t,n){var i=e("./zlib/inflate"),a=e("./utils/common"),r=e("./utils/strings"),s=e("./zlib/constants"),o=e("./zlib/messages"),l=e("./zlib/zstream"),c=e("./zlib/gzheader"),d=Object.prototype.toString;function u(e){if(!(this instanceof u))return new u(e);this.options=a.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var n=i.inflateInit2(this.strm,t.windowBits);if(n!==s.Z_OK)throw new Error(o[n]);this.header=new c,i.inflateGetHeader(this.strm,this.header)}function h(e,t){var n=new u(t);if(n.push(e,!0),n.err)throw n.msg||o[n.err];return n.result}u.prototype.push=function(e,t){var n,o,l,c,u,h,p=this.strm,g=this.options.chunkSize,v=this.options.dictionary,f=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?s.Z_FINISH:s.Z_NO_FLUSH,"string"==typeof e?p.input=r.binstring2buf(e):"[object ArrayBuffer]"===d.call(e)?p.input=new Uint8Array(e):p.input=e,p.next_in=0,p.avail_in=p.input.length;do{if(0===p.avail_out&&(p.output=new a.Buf8(g),p.next_out=0,p.avail_out=g),(n=i.inflate(p,s.Z_NO_FLUSH))===s.Z_NEED_DICT&&v&&(h="string"==typeof v?r.string2buf(v):"[object ArrayBuffer]"===d.call(v)?new Uint8Array(v):v,n=i.inflateSetDictionary(this.strm,h)),n===s.Z_BUF_ERROR&&!0===f&&(n=s.Z_OK,f=!1),n!==s.Z_STREAM_END&&n!==s.Z_OK)return this.onEnd(n),!(this.ended=!0);p.next_out&&(0!==p.avail_out&&n!==s.Z_STREAM_END&&(0!==p.avail_in||o!==s.Z_FINISH&&o!==s.Z_SYNC_FLUSH)||("string"===this.options.to?(l=r.utf8border(p.output,p.next_out),c=p.next_out-l,u=r.buf2string(p.output,l),p.next_out=c,p.avail_out=g-c,c&&a.arraySet(p.output,p.output,l,c,0),this.onData(u)):this.onData(a.shrinkBuf(p.output,p.next_out)))),0===p.avail_in&&0===p.avail_out&&(f=!0)}while((0<p.avail_in||0===p.avail_out)&&n!==s.Z_STREAM_END);return n===s.Z_STREAM_END&&(o=s.Z_FINISH),o===s.Z_FINISH?(n=i.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===s.Z_OK):o!==s.Z_SYNC_FLUSH||(this.onEnd(s.Z_OK),!(p.avail_out=0))},u.prototype.onData=function(e){this.chunks.push(e)},u.prototype.onEnd=function(e){e===s.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Inflate=u,n.inflate=h,n.inflateRaw=function(e,t){return(t=t||{}).raw=!0,h(e,t)},n.ungzip=h},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,t,n){var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;n.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var i in n)n.hasOwnProperty(i)&&(e[i]=n[i])}}return e},n.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,n,i,a){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+i),a);else for(var r=0;r<i;r++)e[a+r]=t[n+r]},flattenChunks:function(e){var t,n,i,a,r,s;for(t=i=0,n=e.length;t<n;t++)i+=e[t].length;for(s=new Uint8Array(i),t=a=0,n=e.length;t<n;t++)r=e[t],s.set(r,a),a+=r.length;return s}},r={arraySet:function(e,t,n,i,a){for(var r=0;r<i;r++)e[a+r]=t[n+r]},flattenChunks:function(e){return[].concat.apply([],e)}};n.setTyped=function(e){e?(n.Buf8=Uint8Array,n.Buf16=Uint16Array,n.Buf32=Int32Array,n.assign(n,a)):(n.Buf8=Array,n.Buf16=Array,n.Buf32=Array,n.assign(n,r))},n.setTyped(i)},{}],42:[function(e,t,n){var i=e("./common"),a=!0,r=!0;try{String.fromCharCode.apply(null,[0])}catch(c){a=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(c){r=!1}for(var s=new i.Buf8(256),o=0;o<256;o++)s[o]=252<=o?6:248<=o?5:240<=o?4:224<=o?3:192<=o?2:1;function l(e,t){if(t<65537&&(e.subarray&&r||!e.subarray&&a))return String.fromCharCode.apply(null,i.shrinkBuf(e,t));for(var n="",s=0;s<t;s++)n+=String.fromCharCode(e[s]);return n}s[254]=s[254]=1,n.string2buf=function(e){var t,n,a,r,s,o=e.length,l=0;for(r=0;r<o;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(a=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(a-56320),r++),l+=n<128?1:n<2048?2:n<65536?3:4;for(t=new i.Buf8(l),r=s=0;s<l;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<o&&56320==(64512&(a=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(a-56320),r++),n<128?t[s++]=n:(n<2048?t[s++]=192|n>>>6:(n<65536?t[s++]=224|n>>>12:(t[s++]=240|n>>>18,t[s++]=128|n>>>12&63),t[s++]=128|n>>>6&63),t[s++]=128|63&n);return t},n.buf2binstring=function(e){return l(e,e.length)},n.binstring2buf=function(e){for(var t=new i.Buf8(e.length),n=0,a=t.length;n<a;n++)t[n]=e.charCodeAt(n);return t},n.buf2string=function(e,t){var n,i,a,r,o=t||e.length,c=new Array(2*o);for(n=i=0;n<o;)if((a=e[n++])<128)c[i++]=a;else if(4<(r=s[a]))c[i++]=65533,n+=r-1;else{for(a&=2===r?31:3===r?15:7;1<r&&n<o;)a=a<<6|63&e[n++],r--;1<r?c[i++]=65533:a<65536?c[i++]=a:(a-=65536,c[i++]=55296|a>>10&1023,c[i++]=56320|1023&a)}return l(c,i)},n.utf8border=function(e,t){var n;for((t=t||e.length)>e.length&&(t=e.length),n=t-1;0<=n&&128==(192&e[n]);)n--;return n<0||0===n?t:n+s[e[n]]>t?n:t}},{"./common":41}],43:[function(e,t,n){t.exports=function(e,t,n,i){for(var a=65535&e,r=e>>>16&65535,s=0;0!==n;){for(n-=s=2e3<n?2e3:n;r=r+(a=a+t[i++]|0)|0,--s;);a%=65521,r%=65521}return a|r<<16}},{}],44:[function(e,t,n){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,t,n){var i=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();t.exports=function(e,t,n,a){var r=i,s=a+n;e^=-1;for(var o=a;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e}},{}],46:[function(e,t,n){var i,a=e("../utils/common"),r=e("./trees"),s=e("./adler32"),o=e("./crc32"),l=e("./messages"),c=0,d=4,u=0,h=-2,p=-1,g=4,v=2,f=8,m=9,y=286,b=30,w=19,k=2*y+1,S=15,x=3,_=258,C=_+x+1,I=42,D=113,T=1,M=2,A=3,E=4;function z(e,t){return e.msg=l[t],t}function P(e){return(e<<1)-(4<e?9:0)}function R(e){for(var t=e.length;0<=--t;)e[t]=0}function $(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(a.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function O(e,t){r._tr_flush_block(e,0<=e.block_start?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,$(e.strm)}function L(e,t){e.pending_buf[e.pending++]=t}function N(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function F(e,t){var n,i,a=e.max_chain_length,r=e.strstart,s=e.prev_length,o=e.nice_match,l=e.strstart>e.w_size-C?e.strstart-(e.w_size-C):0,c=e.window,d=e.w_mask,u=e.prev,h=e.strstart+_,p=c[r+s-1],g=c[r+s];e.prev_length>=e.good_match&&(a>>=2),o>e.lookahead&&(o=e.lookahead);do{if(c[(n=t)+s]===g&&c[n+s-1]===p&&c[n]===c[r]&&c[++n]===c[r+1]){r+=2,n++;do{}while(c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&r<h);if(i=_-(h-r),r=h-_,s<i){if(e.match_start=t,o<=(s=i))break;p=c[r+s-1],g=c[r+s]}}}while((t=u[t&d])>l&&0!=--a);return s<=e.lookahead?s:e.lookahead}function B(e){var t,n,i,r,l,c,d,u,h,p,g=e.w_size;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=g+(g-C)){for(a.arraySet(e.window,e.window,g,g,0),e.match_start-=g,e.strstart-=g,e.block_start-=g,t=n=e.hash_size;i=e.head[--t],e.head[t]=g<=i?i-g:0,--n;);for(t=n=g;i=e.prev[--t],e.prev[t]=g<=i?i-g:0,--n;);r+=g}if(0===e.strm.avail_in)break;if(c=e.strm,d=e.window,u=e.strstart+e.lookahead,p=void 0,(h=r)<(p=c.avail_in)&&(p=h),n=0===p?0:(c.avail_in-=p,a.arraySet(d,c.input,c.next_in,p,u),1===c.state.wrap?c.adler=s(c.adler,d,p,u):2===c.state.wrap&&(c.adler=o(c.adler,d,p,u)),c.next_in+=p,c.total_in+=p,p),e.lookahead+=n,e.lookahead+e.insert>=x)for(l=e.strstart-e.insert,e.ins_h=e.window[l],e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+x-1])&e.hash_mask,e.prev[l&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=l,l++,e.insert--,!(e.lookahead+e.insert<x)););}while(e.lookahead<C&&0!==e.strm.avail_in)}function j(e,t){for(var n,i;;){if(e.lookahead<C){if(B(e),e.lookahead<C&&t===c)return T;if(0===e.lookahead)break}if(n=0,e.lookahead>=x&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-C&&(e.match_length=F(e,n)),e.match_length>=x)if(i=r._tr_tally(e,e.strstart-e.match_start,e.match_length-x),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=x){for(e.match_length--;e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart,0!=--e.match_length;);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else i=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(O(e,!1),0===e.strm.avail_out))return T}return e.insert=e.strstart<x-1?e.strstart:x-1,t===d?(O(e,!0),0===e.strm.avail_out?A:E):e.last_lit&&(O(e,!1),0===e.strm.avail_out)?T:M}function U(e,t){for(var n,i,a;;){if(e.lookahead<C){if(B(e),e.lookahead<C&&t===c)return T;if(0===e.lookahead)break}if(n=0,e.lookahead>=x&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=x-1,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-C&&(e.match_length=F(e,n),e.match_length<=5&&(1===e.strategy||e.match_length===x&&4096<e.strstart-e.match_start)&&(e.match_length=x-1)),e.prev_length>=x&&e.match_length<=e.prev_length){for(a=e.strstart+e.lookahead-x,i=r._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-x),e.lookahead-=e.prev_length-1,e.prev_length-=2;++e.strstart<=a&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+x-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!=--e.prev_length;);if(e.match_available=0,e.match_length=x-1,e.strstart++,i&&(O(e,!1),0===e.strm.avail_out))return T}else if(e.match_available){if((i=r._tr_tally(e,0,e.window[e.strstart-1]))&&O(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return T}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=r._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<x-1?e.strstart:x-1,t===d?(O(e,!0),0===e.strm.avail_out?A:E):e.last_lit&&(O(e,!1),0===e.strm.avail_out)?T:M}function V(e,t,n,i,a){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=a}function q(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=f,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new a.Buf16(2*k),this.dyn_dtree=new a.Buf16(2*(2*b+1)),this.bl_tree=new a.Buf16(2*(2*w+1)),R(this.dyn_ltree),R(this.dyn_dtree),R(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new a.Buf16(S+1),this.heap=new a.Buf16(2*y+1),R(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new a.Buf16(2*y+1),R(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function H(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=v,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?I:D,e.adler=2===t.wrap?0:1,t.last_flush=c,r._tr_init(t),u):z(e,h)}function W(e){var t,n=H(e);return n===u&&((t=e.state).window_size=2*t.w_size,R(t.head),t.max_lazy_match=i[t.level].max_lazy,t.good_match=i[t.level].good_length,t.nice_match=i[t.level].nice_length,t.max_chain_length=i[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=x-1,t.match_available=0,t.ins_h=0),n}function G(e,t,n,i,r,s){if(!e)return h;var o=1;if(t===p&&(t=6),i<0?(o=0,i=-i):15<i&&(o=2,i-=16),r<1||m<r||n!==f||i<8||15<i||t<0||9<t||s<0||g<s)return z(e,h);8===i&&(i=9);var l=new q;return(e.state=l).strm=e,l.wrap=o,l.gzhead=null,l.w_bits=i,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=r+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+x-1)/x),l.window=new a.Buf8(2*l.w_size),l.head=new a.Buf16(l.hash_size),l.prev=new a.Buf16(l.w_size),l.lit_bufsize=1<<r+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new a.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=s,l.method=n,W(e)}i=[new V(0,0,0,0,function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(B(e),0===e.lookahead&&t===c)return T;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var i=e.block_start+n;if((0===e.strstart||e.strstart>=i)&&(e.lookahead=e.strstart-i,e.strstart=i,O(e,!1),0===e.strm.avail_out))return T;if(e.strstart-e.block_start>=e.w_size-C&&(O(e,!1),0===e.strm.avail_out))return T}return e.insert=0,t===d?(O(e,!0),0===e.strm.avail_out?A:E):(e.strstart>e.block_start&&(O(e,!1),e.strm.avail_out),T)}),new V(4,4,8,4,j),new V(4,5,16,8,j),new V(4,6,32,32,j),new V(4,4,16,16,U),new V(8,16,32,32,U),new V(8,16,128,128,U),new V(8,32,128,256,U),new V(32,128,258,1024,U),new V(32,258,258,4096,U)],n.deflateInit=function(e,t){return G(e,t,f,15,8,0)},n.deflateInit2=G,n.deflateReset=W,n.deflateResetKeep=H,n.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?h:(e.state.gzhead=t,u):h},n.deflate=function(e,t){var n,a,s,l;if(!e||!e.state||5<t||t<0)return e?z(e,h):h;if(a=e.state,!e.output||!e.input&&0!==e.avail_in||666===a.status&&t!==d)return z(e,0===e.avail_out?-5:h);if(a.strm=e,n=a.last_flush,a.last_flush=t,a.status===I)if(2===a.wrap)e.adler=0,L(a,31),L(a,139),L(a,8),a.gzhead?(L(a,(a.gzhead.text?1:0)+(a.gzhead.hcrc?2:0)+(a.gzhead.extra?4:0)+(a.gzhead.name?8:0)+(a.gzhead.comment?16:0)),L(a,255&a.gzhead.time),L(a,a.gzhead.time>>8&255),L(a,a.gzhead.time>>16&255),L(a,a.gzhead.time>>24&255),L(a,9===a.level?2:2<=a.strategy||a.level<2?4:0),L(a,255&a.gzhead.os),a.gzhead.extra&&a.gzhead.extra.length&&(L(a,255&a.gzhead.extra.length),L(a,a.gzhead.extra.length>>8&255)),a.gzhead.hcrc&&(e.adler=o(e.adler,a.pending_buf,a.pending,0)),a.gzindex=0,a.status=69):(L(a,0),L(a,0),L(a,0),L(a,0),L(a,0),L(a,9===a.level?2:2<=a.strategy||a.level<2?4:0),L(a,3),a.status=D);else{var p=f+(a.w_bits-8<<4)<<8;p|=(2<=a.strategy||a.level<2?0:a.level<6?1:6===a.level?2:3)<<6,0!==a.strstart&&(p|=32),p+=31-p%31,a.status=D,N(a,p),0!==a.strstart&&(N(a,e.adler>>>16),N(a,65535&e.adler)),e.adler=1}if(69===a.status)if(a.gzhead.extra){for(s=a.pending;a.gzindex<(65535&a.gzhead.extra.length)&&(a.pending!==a.pending_buf_size||(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),$(e),s=a.pending,a.pending!==a.pending_buf_size));)L(a,255&a.gzhead.extra[a.gzindex]),a.gzindex++;a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),a.gzindex===a.gzhead.extra.length&&(a.gzindex=0,a.status=73)}else a.status=73;if(73===a.status)if(a.gzhead.name){s=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),$(e),s=a.pending,a.pending===a.pending_buf_size)){l=1;break}l=a.gzindex<a.gzhead.name.length?255&a.gzhead.name.charCodeAt(a.gzindex++):0,L(a,l)}while(0!==l);a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),0===l&&(a.gzindex=0,a.status=91)}else a.status=91;if(91===a.status)if(a.gzhead.comment){s=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),$(e),s=a.pending,a.pending===a.pending_buf_size)){l=1;break}l=a.gzindex<a.gzhead.comment.length?255&a.gzhead.comment.charCodeAt(a.gzindex++):0,L(a,l)}while(0!==l);a.gzhead.hcrc&&a.pending>s&&(e.adler=o(e.adler,a.pending_buf,a.pending-s,s)),0===l&&(a.status=103)}else a.status=103;if(103===a.status&&(a.gzhead.hcrc?(a.pending+2>a.pending_buf_size&&$(e),a.pending+2<=a.pending_buf_size&&(L(a,255&e.adler),L(a,e.adler>>8&255),e.adler=0,a.status=D)):a.status=D),0!==a.pending){if($(e),0===e.avail_out)return a.last_flush=-1,u}else if(0===e.avail_in&&P(t)<=P(n)&&t!==d)return z(e,-5);if(666===a.status&&0!==e.avail_in)return z(e,-5);if(0!==e.avail_in||0!==a.lookahead||t!==c&&666!==a.status){var g=2===a.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(B(e),0===e.lookahead)){if(t===c)return T;break}if(e.match_length=0,n=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(O(e,!1),0===e.strm.avail_out))return T}return e.insert=0,t===d?(O(e,!0),0===e.strm.avail_out?A:E):e.last_lit&&(O(e,!1),0===e.strm.avail_out)?T:M}(a,t):3===a.strategy?function(e,t){for(var n,i,a,s,o=e.window;;){if(e.lookahead<=_){if(B(e),e.lookahead<=_&&t===c)return T;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=x&&0<e.strstart&&(i=o[a=e.strstart-1])===o[++a]&&i===o[++a]&&i===o[++a]){s=e.strstart+_;do{}while(i===o[++a]&&i===o[++a]&&i===o[++a]&&i===o[++a]&&i===o[++a]&&i===o[++a]&&i===o[++a]&&i===o[++a]&&a<s);e.match_length=_-(s-a),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=x?(n=r._tr_tally(e,1,e.match_length-x),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=r._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(O(e,!1),0===e.strm.avail_out))return T}return e.insert=0,t===d?(O(e,!0),0===e.strm.avail_out?A:E):e.last_lit&&(O(e,!1),0===e.strm.avail_out)?T:M}(a,t):i[a.level].func(a,t);if(g!==A&&g!==E||(a.status=666),g===T||g===A)return 0===e.avail_out&&(a.last_flush=-1),u;if(g===M&&(1===t?r._tr_align(a):5!==t&&(r._tr_stored_block(a,0,0,!1),3===t&&(R(a.head),0===a.lookahead&&(a.strstart=0,a.block_start=0,a.insert=0))),$(e),0===e.avail_out))return a.last_flush=-1,u}return t!==d?u:a.wrap<=0?1:(2===a.wrap?(L(a,255&e.adler),L(a,e.adler>>8&255),L(a,e.adler>>16&255),L(a,e.adler>>24&255),L(a,255&e.total_in),L(a,e.total_in>>8&255),L(a,e.total_in>>16&255),L(a,e.total_in>>24&255)):(N(a,e.adler>>>16),N(a,65535&e.adler)),$(e),0<a.wrap&&(a.wrap=-a.wrap),0!==a.pending?u:1)},n.deflateEnd=function(e){var t;return e&&e.state?(t=e.state.status)!==I&&69!==t&&73!==t&&91!==t&&103!==t&&t!==D&&666!==t?z(e,h):(e.state=null,t===D?z(e,-3):u):h},n.deflateSetDictionary=function(e,t){var n,i,r,o,l,c,d,p,g=t.length;if(!e||!e.state)return h;if(2===(o=(n=e.state).wrap)||1===o&&n.status!==I||n.lookahead)return h;for(1===o&&(e.adler=s(e.adler,t,g,0)),n.wrap=0,g>=n.w_size&&(0===o&&(R(n.head),n.strstart=0,n.block_start=0,n.insert=0),p=new a.Buf8(n.w_size),a.arraySet(p,t,g-n.w_size,n.w_size,0),t=p,g=n.w_size),l=e.avail_in,c=e.next_in,d=e.input,e.avail_in=g,e.next_in=0,e.input=t,B(n);n.lookahead>=x;){for(i=n.strstart,r=n.lookahead-(x-1);n.ins_h=(n.ins_h<<n.hash_shift^n.window[i+x-1])&n.hash_mask,n.prev[i&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=i,i++,--r;);n.strstart=i,n.lookahead=x-1,B(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=x-1,n.match_available=0,e.next_in=c,e.input=d,e.avail_in=l,n.wrap=o,u},n.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,t,n){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,t,n){t.exports=function(e,t){var n,i,a,r,s,o,l,c,d,u,h,p,g,v,f,m,y,b,w,k,S,x,_,C,I;n=e.state,i=e.next_in,C=e.input,a=i+(e.avail_in-5),r=e.next_out,I=e.output,s=r-(t-e.avail_out),o=r+(e.avail_out-257),l=n.dmax,c=n.wsize,d=n.whave,u=n.wnext,h=n.window,p=n.hold,g=n.bits,v=n.lencode,f=n.distcode,m=(1<<n.lenbits)-1,y=(1<<n.distbits)-1;e:do{g<15&&(p+=C[i++]<<g,g+=8,p+=C[i++]<<g,g+=8),b=v[p&m];t:for(;;){if(p>>>=w=b>>>24,g-=w,0==(w=b>>>16&255))I[r++]=65535&b;else{if(!(16&w)){if(!(64&w)){b=v[(65535&b)+(p&(1<<w)-1)];continue t}if(32&w){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}k=65535&b,(w&=15)&&(g<w&&(p+=C[i++]<<g,g+=8),k+=p&(1<<w)-1,p>>>=w,g-=w),g<15&&(p+=C[i++]<<g,g+=8,p+=C[i++]<<g,g+=8),b=f[p&y];n:for(;;){if(p>>>=w=b>>>24,g-=w,!(16&(w=b>>>16&255))){if(!(64&w)){b=f[(65535&b)+(p&(1<<w)-1)];continue n}e.msg="invalid distance code",n.mode=30;break e}if(S=65535&b,g<(w&=15)&&(p+=C[i++]<<g,(g+=8)<w&&(p+=C[i++]<<g,g+=8)),l<(S+=p&(1<<w)-1)){e.msg="invalid distance too far back",n.mode=30;break e}if(p>>>=w,g-=w,(w=r-s)<S){if(d<(w=S-w)&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(_=h,(x=0)===u){if(x+=c-w,w<k){for(k-=w;I[r++]=h[x++],--w;);x=r-S,_=I}}else if(u<w){if(x+=c+u-w,(w-=u)<k){for(k-=w;I[r++]=h[x++],--w;);if(x=0,u<k){for(k-=w=u;I[r++]=h[x++],--w;);x=r-S,_=I}}}else if(x+=u-w,w<k){for(k-=w;I[r++]=h[x++],--w;);x=r-S,_=I}for(;2<k;)I[r++]=_[x++],I[r++]=_[x++],I[r++]=_[x++],k-=3;k&&(I[r++]=_[x++],1<k&&(I[r++]=_[x++]))}else{for(x=r-S;I[r++]=I[x++],I[r++]=I[x++],I[r++]=I[x++],2<(k-=3););k&&(I[r++]=I[x++],1<k&&(I[r++]=I[x++]))}break}}break}}while(i<a&&r<o);i-=k=g>>3,p&=(1<<(g-=k<<3))-1,e.next_in=i,e.next_out=r,e.avail_in=i<a?a-i+5:5-(i-a),e.avail_out=r<o?o-r+257:257-(r-o),n.hold=p,n.bits=g}},{}],49:[function(e,t,n){var i=e("../utils/common"),a=e("./adler32"),r=e("./crc32"),s=e("./inffast"),o=e("./inftrees"),l=1,c=2,d=0,u=-2,h=1,p=852,g=592;function v(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function f(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new i.Buf16(320),this.work=new i.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function m(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=h,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new i.Buf32(p),t.distcode=t.distdyn=new i.Buf32(g),t.sane=1,t.back=-1,d):u}function y(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,m(e)):u}function b(e,t){var n,i;return e&&e.state?(i=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?u:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,y(e))):u}function w(e,t){var n,i;return e?(i=new f,(e.state=i).window=null,(n=b(e,t))!==d&&(e.state=null),n):u}var k,S,x=!0;function _(e){if(x){var t;for(k=new i.Buf32(512),S=new i.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(o(l,e.lens,0,288,k,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;o(c,e.lens,0,32,S,0,e.work,{bits:5}),x=!1}e.lencode=k,e.lenbits=9,e.distcode=S,e.distbits=5}function C(e,t,n,a){var r,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new i.Buf8(s.wsize)),a>=s.wsize?(i.arraySet(s.window,t,n-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):(a<(r=s.wsize-s.wnext)&&(r=a),i.arraySet(s.window,t,n-a,r,s.wnext),(a-=r)?(i.arraySet(s.window,t,n-a,a,0),s.wnext=a,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0}n.inflateReset=y,n.inflateReset2=b,n.inflateResetKeep=m,n.inflateInit=function(e){return w(e,15)},n.inflateInit2=w,n.inflate=function(e,t){var n,p,g,f,m,y,b,w,k,S,x,I,D,T,M,A,E,z,P,R,$,O,L,N,F=0,B=new i.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return u;12===(n=e.state).mode&&(n.mode=13),m=e.next_out,g=e.output,b=e.avail_out,f=e.next_in,p=e.input,y=e.avail_in,w=n.hold,k=n.bits,S=y,x=b,O=d;e:for(;;)switch(n.mode){case h:if(0===n.wrap){n.mode=13;break}for(;k<16;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(2&n.wrap&&35615===w){B[n.check=0]=255&w,B[1]=w>>>8&255,n.check=r(n.check,B,2,0),k=w=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&w)<<8)+(w>>8))%31){e.msg="incorrect header check",n.mode=30;break}if(8!=(15&w)){e.msg="unknown compression method",n.mode=30;break}if(k-=4,$=8+(15&(w>>>=4)),0===n.wbits)n.wbits=$;else if($>n.wbits){e.msg="invalid window size",n.mode=30;break}n.dmax=1<<$,e.adler=n.check=1,n.mode=512&w?10:12,k=w=0;break;case 2:for(;k<16;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(n.flags=w,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=30;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=30;break}n.head&&(n.head.text=w>>8&1),512&n.flags&&(B[0]=255&w,B[1]=w>>>8&255,n.check=r(n.check,B,2,0)),k=w=0,n.mode=3;case 3:for(;k<32;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}n.head&&(n.head.time=w),512&n.flags&&(B[0]=255&w,B[1]=w>>>8&255,B[2]=w>>>16&255,B[3]=w>>>24&255,n.check=r(n.check,B,4,0)),k=w=0,n.mode=4;case 4:for(;k<16;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}n.head&&(n.head.xflags=255&w,n.head.os=w>>8),512&n.flags&&(B[0]=255&w,B[1]=w>>>8&255,n.check=r(n.check,B,2,0)),k=w=0,n.mode=5;case 5:if(1024&n.flags){for(;k<16;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}n.length=w,n.head&&(n.head.extra_len=w),512&n.flags&&(B[0]=255&w,B[1]=w>>>8&255,n.check=r(n.check,B,2,0)),k=w=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&(y<(I=n.length)&&(I=y),I&&(n.head&&($=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),i.arraySet(n.head.extra,p,f,I,$)),512&n.flags&&(n.check=r(n.check,p,I,f)),y-=I,f+=I,n.length-=I),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===y)break e;for(I=0;$=p[f+I++],n.head&&$&&n.length<65536&&(n.head.name+=String.fromCharCode($)),$&&I<y;);if(512&n.flags&&(n.check=r(n.check,p,I,f)),y-=I,f+=I,$)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===y)break e;for(I=0;$=p[f+I++],n.head&&$&&n.length<65536&&(n.head.comment+=String.fromCharCode($)),$&&I<y;);if(512&n.flags&&(n.check=r(n.check,p,I,f)),y-=I,f+=I,$)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;k<16;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(w!==(65535&n.check)){e.msg="header crc mismatch",n.mode=30;break}k=w=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=12;break;case 10:for(;k<32;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}e.adler=n.check=v(w),k=w=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=m,e.avail_out=b,e.next_in=f,e.avail_in=y,n.hold=w,n.bits=k,2;e.adler=n.check=1,n.mode=12;case 12:if(5===t||6===t)break e;case 13:if(n.last){w>>>=7&k,k-=7&k,n.mode=27;break}for(;k<3;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}switch(n.last=1&w,k-=1,3&(w>>>=1)){case 0:n.mode=14;break;case 1:if(_(n),n.mode=20,6!==t)break;w>>>=2,k-=2;break e;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=30}w>>>=2,k-=2;break;case 14:for(w>>>=7&k,k-=7&k;k<32;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if((65535&w)!=(w>>>16^65535)){e.msg="invalid stored block lengths",n.mode=30;break}if(n.length=65535&w,k=w=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(I=n.length){if(y<I&&(I=y),b<I&&(I=b),0===I)break e;i.arraySet(g,p,f,I,m),y-=I,f+=I,b-=I,m+=I,n.length-=I;break}n.mode=12;break;case 17:for(;k<14;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(n.nlen=257+(31&w),w>>>=5,k-=5,n.ndist=1+(31&w),w>>>=5,k-=5,n.ncode=4+(15&w),w>>>=4,k-=4,286<n.nlen||30<n.ndist){e.msg="too many length or distance symbols",n.mode=30;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;k<3;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}n.lens[j[n.have++]]=7&w,w>>>=3,k-=3}for(;n.have<19;)n.lens[j[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,L={bits:n.lenbits},O=o(0,n.lens,0,19,n.lencode,0,n.work,L),n.lenbits=L.bits,O){e.msg="invalid code lengths set",n.mode=30;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;A=(F=n.lencode[w&(1<<n.lenbits)-1])>>>16&255,E=65535&F,!((M=F>>>24)<=k);){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(E<16)w>>>=M,k-=M,n.lens[n.have++]=E;else{if(16===E){for(N=M+2;k<N;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(w>>>=M,k-=M,0===n.have){e.msg="invalid bit length repeat",n.mode=30;break}$=n.lens[n.have-1],I=3+(3&w),w>>>=2,k-=2}else if(17===E){for(N=M+3;k<N;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}k-=M,$=0,I=3+(7&(w>>>=M)),w>>>=3,k-=3}else{for(N=M+7;k<N;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}k-=M,$=0,I=11+(127&(w>>>=M)),w>>>=7,k-=7}if(n.have+I>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=30;break}for(;I--;)n.lens[n.have++]=$}}if(30===n.mode)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=30;break}if(n.lenbits=9,L={bits:n.lenbits},O=o(l,n.lens,0,n.nlen,n.lencode,0,n.work,L),n.lenbits=L.bits,O){e.msg="invalid literal/lengths set",n.mode=30;break}if(n.distbits=6,n.distcode=n.distdyn,L={bits:n.distbits},O=o(c,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,L),n.distbits=L.bits,O){e.msg="invalid distances set",n.mode=30;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(6<=y&&258<=b){e.next_out=m,e.avail_out=b,e.next_in=f,e.avail_in=y,n.hold=w,n.bits=k,s(e,x),m=e.next_out,g=e.output,b=e.avail_out,f=e.next_in,p=e.input,y=e.avail_in,w=n.hold,k=n.bits,12===n.mode&&(n.back=-1);break}for(n.back=0;A=(F=n.lencode[w&(1<<n.lenbits)-1])>>>16&255,E=65535&F,!((M=F>>>24)<=k);){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(A&&!(240&A)){for(z=M,P=A,R=E;A=(F=n.lencode[R+((w&(1<<z+P)-1)>>z)])>>>16&255,E=65535&F,!(z+(M=F>>>24)<=k);){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}w>>>=z,k-=z,n.back+=z}if(w>>>=M,k-=M,n.back+=M,n.length=E,0===A){n.mode=26;break}if(32&A){n.back=-1,n.mode=12;break}if(64&A){e.msg="invalid literal/length code",n.mode=30;break}n.extra=15&A,n.mode=22;case 22:if(n.extra){for(N=n.extra;k<N;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}n.length+=w&(1<<n.extra)-1,w>>>=n.extra,k-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;A=(F=n.distcode[w&(1<<n.distbits)-1])>>>16&255,E=65535&F,!((M=F>>>24)<=k);){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(!(240&A)){for(z=M,P=A,R=E;A=(F=n.distcode[R+((w&(1<<z+P)-1)>>z)])>>>16&255,E=65535&F,!(z+(M=F>>>24)<=k);){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}w>>>=z,k-=z,n.back+=z}if(w>>>=M,k-=M,n.back+=M,64&A){e.msg="invalid distance code",n.mode=30;break}n.offset=E,n.extra=15&A,n.mode=24;case 24:if(n.extra){for(N=n.extra;k<N;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}n.offset+=w&(1<<n.extra)-1,w>>>=n.extra,k-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=30;break}n.mode=25;case 25:if(0===b)break e;if(I=x-b,n.offset>I){if((I=n.offset-I)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=30;break}D=I>n.wnext?(I-=n.wnext,n.wsize-I):n.wnext-I,I>n.length&&(I=n.length),T=n.window}else T=g,D=m-n.offset,I=n.length;for(b<I&&(I=b),b-=I,n.length-=I;g[m++]=T[D++],--I;);0===n.length&&(n.mode=21);break;case 26:if(0===b)break e;g[m++]=n.length,b--,n.mode=21;break;case 27:if(n.wrap){for(;k<32;){if(0===y)break e;y--,w|=p[f++]<<k,k+=8}if(x-=b,e.total_out+=x,n.total+=x,x&&(e.adler=n.check=n.flags?r(n.check,g,x,m-x):a(n.check,g,x,m-x)),x=b,(n.flags?w:v(w))!==n.check){e.msg="incorrect data check",n.mode=30;break}k=w=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;k<32;){if(0===y)break e;y--,w+=p[f++]<<k,k+=8}if(w!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=30;break}k=w=0}n.mode=29;case 29:O=1;break e;case 30:O=-3;break e;case 31:return-4;default:return u}return e.next_out=m,e.avail_out=b,e.next_in=f,e.avail_in=y,n.hold=w,n.bits=k,(n.wsize||x!==e.avail_out&&n.mode<30&&(n.mode<27||4!==t))&&C(e,e.output,e.next_out,x-e.avail_out)?(n.mode=31,-4):(S-=e.avail_in,x-=e.avail_out,e.total_in+=S,e.total_out+=x,n.total+=x,n.wrap&&x&&(e.adler=n.check=n.flags?r(n.check,g,x,e.next_out-x):a(n.check,g,x,e.next_out-x)),e.data_type=n.bits+(n.last?64:0)+(12===n.mode?128:0)+(20===n.mode||15===n.mode?256:0),(0==S&&0===x||4===t)&&O===d&&(O=-5),O)},n.inflateEnd=function(e){if(!e||!e.state)return u;var t=e.state;return t.window&&(t.window=null),e.state=null,d},n.inflateGetHeader=function(e,t){var n;return e&&e.state&&2&(n=e.state).wrap?((n.head=t).done=!1,d):u},n.inflateSetDictionary=function(e,t){var n,i=t.length;return e&&e.state?0!==(n=e.state).wrap&&11!==n.mode?u:11===n.mode&&a(1,t,i,0)!==n.check?-3:C(e,t,i,i)?(n.mode=31,-4):(n.havedict=1,d):u},n.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,t,n){var i=e("../utils/common"),a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],r=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],s=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,n,l,c,d,u,h){var p,g,v,f,m,y,b,w,k,S=h.bits,x=0,_=0,C=0,I=0,D=0,T=0,M=0,A=0,E=0,z=0,P=null,R=0,$=new i.Buf16(16),O=new i.Buf16(16),L=null,N=0;for(x=0;x<=15;x++)$[x]=0;for(_=0;_<l;_++)$[t[n+_]]++;for(D=S,I=15;1<=I&&0===$[I];I--);if(I<D&&(D=I),0===I)return c[d++]=20971520,c[d++]=20971520,h.bits=1,0;for(C=1;C<I&&0===$[C];C++);for(D<C&&(D=C),x=A=1;x<=15;x++)if(A<<=1,(A-=$[x])<0)return-1;if(0<A&&(0===e||1!==I))return-1;for(O[1]=0,x=1;x<15;x++)O[x+1]=O[x]+$[x];for(_=0;_<l;_++)0!==t[n+_]&&(u[O[t[n+_]]++]=_);if(y=0===e?(P=L=u,19):1===e?(P=a,R-=257,L=r,N-=257,256):(P=s,L=o,-1),x=C,m=d,M=_=z=0,v=-1,f=(E=1<<(T=D))-1,1===e&&852<E||2===e&&592<E)return 1;for(;;){for(b=x-M,k=u[_]<y?(w=0,u[_]):u[_]>y?(w=L[N+u[_]],P[R+u[_]]):(w=96,0),p=1<<x-M,C=g=1<<T;c[m+(z>>M)+(g-=p)]=b<<24|w<<16|k,0!==g;);for(p=1<<x-1;z&p;)p>>=1;if(0!==p?(z&=p-1,z+=p):z=0,_++,0==--$[x]){if(x===I)break;x=t[n+u[_]]}if(D<x&&(z&f)!==v){for(0===M&&(M=D),m+=C,A=1<<(T=x-M);T+M<I&&!((A-=$[T+M])<=0);)T++,A<<=1;if(E+=1<<T,1===e&&852<E||2===e&&592<E)return 1;c[v=z&f]=D<<24|T<<16|m-d}}return 0!==z&&(c[m+z]=x-M<<24|64<<16),h.bits=D,0}},{"../utils/common":41}],51:[function(e,t,n){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,t,n){var i=e("../utils/common"),a=0,r=1;function s(e){for(var t=e.length;0<=--t;)e[t]=0}var o=0,l=29,c=256,d=c+1+l,u=30,h=19,p=2*d+1,g=15,v=16,f=7,m=256,y=16,b=17,w=18,k=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],x=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],_=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],C=new Array(2*(d+2));s(C);var I=new Array(2*u);s(I);var D=new Array(512);s(D);var T=new Array(256);s(T);var M=new Array(l);s(M);var A,E,z,P=new Array(u);function R(e,t,n,i,a){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=a,this.has_stree=e&&e.length}function $(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function O(e){return e<256?D[e]:D[256+(e>>>7)]}function L(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function N(e,t,n){e.bi_valid>v-n?(e.bi_buf|=t<<e.bi_valid&65535,L(e,e.bi_buf),e.bi_buf=t>>v-e.bi_valid,e.bi_valid+=n-v):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function F(e,t,n){N(e,n[2*t],n[2*t+1])}function B(e,t){for(var n=0;n|=1&e,e>>>=1,n<<=1,0<--t;);return n>>>1}function j(e,t,n){var i,a,r=new Array(g+1),s=0;for(i=1;i<=g;i++)r[i]=s=s+n[i-1]<<1;for(a=0;a<=t;a++){var o=e[2*a+1];0!==o&&(e[2*a]=B(r[o]++,o))}}function U(e){var t;for(t=0;t<d;t++)e.dyn_ltree[2*t]=0;for(t=0;t<u;t++)e.dyn_dtree[2*t]=0;for(t=0;t<h;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*m]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function V(e){8<e.bi_valid?L(e,e.bi_buf):0<e.bi_valid&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function q(e,t,n,i){var a=2*t,r=2*n;return e[a]<e[r]||e[a]===e[r]&&i[t]<=i[n]}function H(e,t,n){for(var i=e.heap[n],a=n<<1;a<=e.heap_len&&(a<e.heap_len&&q(t,e.heap[a+1],e.heap[a],e.depth)&&a++,!q(t,i,e.heap[a],e.depth));)e.heap[n]=e.heap[a],n=a,a<<=1;e.heap[n]=i}function W(e,t,n){var i,a,r,s,o=0;if(0!==e.last_lit)for(;i=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],a=e.pending_buf[e.l_buf+o],o++,0===i?F(e,a,t):(F(e,(r=T[a])+c+1,t),0!==(s=k[r])&&N(e,a-=M[r],s),F(e,r=O(--i),n),0!==(s=S[r])&&N(e,i-=P[r],s)),o<e.last_lit;);F(e,m,t)}function G(e,t){var n,i,a,r=t.dyn_tree,s=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=p,n=0;n<l;n++)0!==r[2*n]?(e.heap[++e.heap_len]=c=n,e.depth[n]=0):r[2*n+1]=0;for(;e.heap_len<2;)r[2*(a=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[a]=0,e.opt_len--,o&&(e.static_len-=s[2*a+1]);for(t.max_code=c,n=e.heap_len>>1;1<=n;n--)H(e,r,n);for(a=l;n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],H(e,r,1),i=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=i,r[2*a]=r[2*n]+r[2*i],e.depth[a]=(e.depth[n]>=e.depth[i]?e.depth[n]:e.depth[i])+1,r[2*n+1]=r[2*i+1]=a,e.heap[1]=a++,H(e,r,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e,t){var n,i,a,r,s,o,l=t.dyn_tree,c=t.max_code,d=t.stat_desc.static_tree,u=t.stat_desc.has_stree,h=t.stat_desc.extra_bits,v=t.stat_desc.extra_base,f=t.stat_desc.max_length,m=0;for(r=0;r<=g;r++)e.bl_count[r]=0;for(l[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<p;n++)f<(r=l[2*l[2*(i=e.heap[n])+1]+1]+1)&&(r=f,m++),l[2*i+1]=r,c<i||(e.bl_count[r]++,s=0,v<=i&&(s=h[i-v]),o=l[2*i],e.opt_len+=o*(r+s),u&&(e.static_len+=o*(d[2*i+1]+s)));if(0!==m){do{for(r=f-1;0===e.bl_count[r];)r--;e.bl_count[r]--,e.bl_count[r+1]+=2,e.bl_count[f]--,m-=2}while(0<m);for(r=f;0!==r;r--)for(i=e.bl_count[r];0!==i;)c<(a=e.heap[--n])||(l[2*a+1]!==r&&(e.opt_len+=(r-l[2*a+1])*l[2*a],l[2*a+1]=r),i--)}}(e,t),j(r,c,e.bl_count)}function Q(e,t,n){var i,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),t[2*(n+1)+1]=65535,i=0;i<=n;i++)a=s,s=t[2*(i+1)+1],++o<l&&a===s||(o<c?e.bl_tree[2*a]+=o:0!==a?(a!==r&&e.bl_tree[2*a]++,e.bl_tree[2*y]++):o<=10?e.bl_tree[2*b]++:e.bl_tree[2*w]++,r=a,c=(o=0)===s?(l=138,3):a===s?(l=6,3):(l=7,4))}function K(e,t,n){var i,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),i=0;i<=n;i++)if(a=s,s=t[2*(i+1)+1],!(++o<l&&a===s)){if(o<c)for(;F(e,a,e.bl_tree),0!=--o;);else 0!==a?(a!==r&&(F(e,a,e.bl_tree),o--),F(e,y,e.bl_tree),N(e,o-3,2)):o<=10?(F(e,b,e.bl_tree),N(e,o-3,3)):(F(e,w,e.bl_tree),N(e,o-11,7));r=a,c=(o=0)===s?(l=138,3):a===s?(l=6,3):(l=7,4)}}s(P);var Z=!1;function Y(e,t,n,a){var r,s,l;N(e,(o<<1)+(a?1:0),3),s=t,l=n,V(r=e),L(r,l),L(r,~l),i.arraySet(r.pending_buf,r.window,s,l,r.pending),r.pending+=l}n._tr_init=function(e){Z||(function(){var e,t,n,i,a,r=new Array(g+1);for(i=n=0;i<l-1;i++)for(M[i]=n,e=0;e<1<<k[i];e++)T[n++]=i;for(T[n-1]=i,i=a=0;i<16;i++)for(P[i]=a,e=0;e<1<<S[i];e++)D[a++]=i;for(a>>=7;i<u;i++)for(P[i]=a<<7,e=0;e<1<<S[i]-7;e++)D[256+a++]=i;for(t=0;t<=g;t++)r[t]=0;for(e=0;e<=143;)C[2*e+1]=8,e++,r[8]++;for(;e<=255;)C[2*e+1]=9,e++,r[9]++;for(;e<=279;)C[2*e+1]=7,e++,r[7]++;for(;e<=287;)C[2*e+1]=8,e++,r[8]++;for(j(C,d+1,r),e=0;e<u;e++)I[2*e+1]=5,I[2*e]=B(e,5);A=new R(C,k,c+1,d,g),E=new R(I,S,0,u,g),z=new R(new Array(0),x,0,h,f)}(),Z=!0),e.l_desc=new $(e.dyn_ltree,A),e.d_desc=new $(e.dyn_dtree,E),e.bl_desc=new $(e.bl_tree,z),e.bi_buf=0,e.bi_valid=0,U(e)},n._tr_stored_block=Y,n._tr_flush_block=function(e,t,n,i){var s,o,l=0;0<e.level?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return a;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return r;for(t=32;t<c;t++)if(0!==e.dyn_ltree[2*t])return r;return a}(e)),G(e,e.l_desc),G(e,e.d_desc),l=function(e){var t;for(Q(e,e.dyn_ltree,e.l_desc.max_code),Q(e,e.dyn_dtree,e.d_desc.max_code),G(e,e.bl_desc),t=h-1;3<=t&&0===e.bl_tree[2*_[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),s=e.opt_len+3+7>>>3,(o=e.static_len+3+7>>>3)<=s&&(s=o)):s=o=n+5,n+4<=s&&-1!==t?Y(e,t,n,i):4===e.strategy||o===s?(N(e,2+(i?1:0),3),W(e,C,I)):(N(e,4+(i?1:0),3),function(e,t,n,i){var a;for(N(e,t-257,5),N(e,n-1,5),N(e,i-4,4),a=0;a<i;a++)N(e,e.bl_tree[2*_[a]+1],3);K(e,e.dyn_ltree,t-1),K(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,l+1),W(e,e.dyn_ltree,e.dyn_dtree)),U(e),i&&V(e)},n._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(T[n]+c+1)]++,e.dyn_dtree[2*O(t)]++),e.last_lit===e.lit_bufsize-1},n._tr_align=function(e){var t;N(e,2,3),F(e,m,C),16===(t=e).bi_valid?(L(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):8<=t.bi_valid&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}},{"../utils/common":41}],53:[function(e,t,n){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,t,n){(function(e){!function(e,t){if(!e.setImmediate){var n,i,a,r,s=1,o={},l=!1,c=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,n="[object process]"==={}.toString.call(e.process)?function(e){process.nextTick(function(){h(e)})}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?(r="setImmediate$"+Math.random()+"$",e.addEventListener?e.addEventListener("message",p,!1):e.attachEvent("onmessage",p),function(t){e.postMessage(r+t,"*")}):e.MessageChannel?((a=new MessageChannel).port1.onmessage=function(e){h(e.data)},function(e){a.port2.postMessage(e)}):c&&"onreadystatechange"in c.createElement("script")?(i=c.documentElement,function(e){var t=c.createElement("script");t.onreadystatechange=function(){h(e),t.onreadystatechange=null,i.removeChild(t),t=null},i.appendChild(t)}):function(e){setTimeout(h,0,e)},d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),i=0;i<t.length;i++)t[i]=arguments[i+1];var a={callback:e,args:t};return o[s]=a,n(s),s++},d.clearImmediate=u}function u(e){delete o[e]}function h(e){if(l)setTimeout(h,0,e);else{var n=o[e];if(n){l=!0;try{!function(e){var n=e.callback,i=e.args;switch(i.length){case 0:n();break;case 1:n(i[0]);break;case 2:n(i[0],i[1]);break;case 3:n(i[0],i[1],i[2]);break;default:n.apply(t,i)}}(n)}finally{u(e),l=!1}}}}function p(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(r)&&h(+t.data.slice(r.length))}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[10])(10);const ine=ene(nne.exports),ane={level:"info",enableConsole:!0,enableFile:!1,prefix:"[APKG Import]",maxEntries:1e3},rne={debug:0,info:1,warn:2,error:3};class sne{constructor(e){oe(this,"config"),oe(this,"entries",[]),this.config={...ane,...e}}debug(e,t,n){this.log("debug",e,t,n)}info(e,t,n){this.log("info",e,t,n)}warn(e,t,n){this.log("warn",e,t,n)}error(e,t,n){this.log("error",e,t,n)}log(e,t,n,i){if(!this.shouldLog(e))return;const a={timestamp:Date.now(),level:e,message:t,data:n,source:i||this.config.prefix};this.entries.push(a),this.entries.length>this.config.maxEntries&&this.entries.shift(),this.config.enableConsole&&this.outputToConsole(a),this.config.enableFile&&this.outputToFile(a)}shouldLog(e){return rne[e]>=rne[this.config.level]}outputToConsole(e){const t=`${new Date(e.timestamp).toISOString()} ${e.source||this.config.prefix} [${e.level.toUpperCase()}] ${e.message}`;switch(e.level){case"debug":case"info":_e.debug(t,e.data||"");break;case"warn":_e.warn(t,e.data||"");break;case"error":_e.error(t,e.data||""),e.data instanceof Error&&_e.error("Stack:",e.data.stack)}}outputToFile(e){}getEntries(){return[...this.entries]}getEntriesByLevel(e){return this.entries.filter(t=>t.level===e)}clear(){this.entries=[]}setLevel(e){this.config.level=e}exportAsText(){return this.entries.map(e=>{const t=new Date(e.timestamp).toISOString(),n=e.data?` | Data: ${JSON.stringify(e.data)}`:"";return`${t} [${e.level.toUpperCase()}] ${e.message}${n}`}).join("\n")}exportAsJSON(){return JSON.stringify(this.entries,null,2)}createChild(e){return new one(this,e)}}class one{constructor(e,t){this.parent=e,this.source=t}debug(e,t){this.parent.debug(e,t,this.source)}info(e,t){this.parent.info(e,t,this.source)}warn(e,t){this.parent.warn(e,t,this.source)}error(e,t){this.parent.error(e,t,this.source)}}new sne({level:"info",enableConsole:!0,prefix:"[APKG]"});var lne,cne,dne,une={exports:{}};cne=void 0,dne=function(e){return cne||(cne=new Promise(function(t,n){var i,a=void 0!==e?e:{},r=a.onAbort;a.onAbort=function(e){n(new Error(e)),r&&r(e)},a.postRun=a.postRun||[],a.postRun.push(function(){t(a)}),lne=void 0,i||(i=void 0!==a?a:{});var s="object"==typeof window,o="undefined"!=typeof WorkerGlobalScope,l="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node&&"renderer"!=process.type;i.onRuntimeInitialized=function(){function e(e,t){switch(typeof t){case"boolean":Y(e,t?1:0);break;case"number":V(e,t);break;case"string":Q(e,t,-1,-1);break;case"object":if(null===t)H(e);else if(null!=t.length){var n=wt(t,bt);Z(e,n,t.length,-1),Dt(n)}else X(e,"Wrong API use : tried to return a value of an unknown type ("+t+").",-1);break;default:H(e)}}function t(e,t){for(var n=[],i=0;i<e;i+=1){var a=U(t+4*i,"i32"),r=L(a);if(1===r||2===r)a=j(a);else if(3===r)a=F(a);else if(4===r){a=N(r=a),r=B(r);for(var s=new Uint8Array(a),o=0;o<a;o+=1)s[o]=w[r+o];a=s}else a=null;n.push(a)}return n}function n(e,t){this.Qa=e,this.db=t,this.Oa=1,this.lb=[]}function a(e,t){if(this.db=t,t=ee(e)+1,this.eb=It(t),null===this.eb)throw Error("Unable to allocate memory for the SQL string");te(e,k,this.eb,t),this.kb=this.eb,this.Za=this.pb=null}function r(e){if(this.filename="dbfile_"+(4294967295*Math.random()>>>0),null!=e){var t=this.filename,n="/",i=t;if(n&&(n="string"==typeof n?n:Ce(n),i=t?K(n+"/"+t):n),i=function(e,t=438){return Ue(e,4095&t|32768,0)}(i,t=de(!0,!0)),e){if("string"==typeof e){n=Array(e.length);for(var a=0,r=e.length;a<r;++a)n[a]=e.charCodeAt(a);e=n}Ze(i,146|t),nt(n=Xe(i,577),e,0,e.length,0),Je(n),Ze(i,t)}}this.handleError(l(this.filename,s)),this.db=U(s,"i32"),ie(this.db),this.fb={},this.Sa={}}var s=Et(4),o=i.cwrap,l=o("sqlite3_open","number",["string","number"]),c=o("sqlite3_close_v2","number",["number"]),d=o("sqlite3_exec","number",["number","string","number","number","number"]),u=o("sqlite3_changes","number",["number"]),h=o("sqlite3_prepare_v2","number",["number","string","number","number","number"]),p=o("sqlite3_sql","string",["number"]),g=o("sqlite3_normalized_sql","string",["number"]),v=o("sqlite3_prepare_v2","number",["number","number","number","number","number"]),f=o("sqlite3_bind_text","number",["number","number","number","number","number"]),m=o("sqlite3_bind_blob","number",["number","number","number","number","number"]),y=o("sqlite3_bind_double","number",["number","number","number"]),b=o("sqlite3_bind_int","number",["number","number","number"]),S=o("sqlite3_bind_parameter_index","number",["number","string"]),x=o("sqlite3_step","number",["number"]),_=o("sqlite3_errmsg","string",["number"]),C=o("sqlite3_column_count","number",["number"]),I=o("sqlite3_data_count","number",["number"]),D=o("sqlite3_column_double","number",["number","number"]),T=o("sqlite3_column_text","string",["number","number"]),M=o("sqlite3_column_blob","number",["number","number"]),A=o("sqlite3_column_bytes","number",["number","number"]),E=o("sqlite3_column_type","number",["number","number"]),z=o("sqlite3_column_name","string",["number","number"]),P=o("sqlite3_reset","number",["number"]),R=o("sqlite3_clear_bindings","number",["number"]),$=o("sqlite3_finalize","number",["number"]),O=o("sqlite3_create_function_v2","number","number string number number number number number number number".split(" ")),L=o("sqlite3_value_type","number",["number"]),N=o("sqlite3_value_bytes","number",["number"]),F=o("sqlite3_value_text","string",["number"]),B=o("sqlite3_value_blob","number",["number"]),j=o("sqlite3_value_double","number",["number"]),V=o("sqlite3_result_double","",["number","number"]),H=o("sqlite3_result_null","",["number"]),Q=o("sqlite3_result_text","",["number","string","number","number"]),Z=o("sqlite3_result_blob","",["number","number","number","number"]),Y=o("sqlite3_result_int","",["number","number"]),X=o("sqlite3_result_error","",["number","string","number"]),J=o("sqlite3_aggregate_context","number",["number","number"]),ie=o("RegisterExtensionFunctions","number",["number"]),ae=o("sqlite3_update_hook","number",["number","number","number"]);n.prototype.bind=function(e){if(!this.Qa)throw"Statement closed";return this.reset(),Array.isArray(e)?this.Cb(e):null==e||"object"!=typeof e||this.Db(e)},n.prototype.step=function(){if(!this.Qa)throw"Statement closed";this.Oa=1;var e=x(this.Qa);switch(e){case 100:return!0;case 101:return!1;default:throw this.db.handleError(e)}},n.prototype.wb=function(e){return null==e&&(e=this.Oa,this.Oa+=1),D(this.Qa,e)},n.prototype.Gb=function(e){if(null==e&&(e=this.Oa,this.Oa+=1),e=T(this.Qa,e),"function"!=typeof BigInt)throw Error("BigInt is not supported");return BigInt(e)},n.prototype.Hb=function(e){return null==e&&(e=this.Oa,this.Oa+=1),T(this.Qa,e)},n.prototype.getBlob=function(e){null==e&&(e=this.Oa,this.Oa+=1);var t=A(this.Qa,e);e=M(this.Qa,e);for(var n=new Uint8Array(t),i=0;i<t;i+=1)n[i]=w[e+i];return n},n.prototype.get=function(e,t){t=t||{},null!=e&&this.bind(e)&&this.step(),e=[];for(var n=I(this.Qa),i=0;i<n;i+=1)switch(E(this.Qa,i)){case 1:var a=t.useBigInt?this.Gb(i):this.wb(i);e.push(a);break;case 2:e.push(this.wb(i));break;case 3:e.push(this.Hb(i));break;case 4:e.push(this.getBlob(i));break;default:e.push(null)}return e},n.prototype.getColumnNames=function(){for(var e=[],t=C(this.Qa),n=0;n<t;n+=1)e.push(z(this.Qa,n));return e},n.prototype.getAsObject=function(e,t){e=this.get(e,t),t=this.getColumnNames();for(var n={},i=0;i<t.length;i+=1)n[t[i]]=e[i];return n},n.prototype.getSQL=function(){return p(this.Qa)},n.prototype.getNormalizedSQL=function(){return g(this.Qa)},n.prototype.run=function(e){return null!=e&&this.bind(e),this.step(),this.reset()},n.prototype.sb=function(e,t){null==t&&(t=this.Oa,this.Oa+=1),e=ne(e);var n=wt(e,bt);this.lb.push(n),this.db.handleError(f(this.Qa,t,n,e.length-1,0))},n.prototype.Bb=function(e,t){null==t&&(t=this.Oa,this.Oa+=1);var n=wt(e,bt);this.lb.push(n),this.db.handleError(m(this.Qa,t,n,e.length,0))},n.prototype.rb=function(e,t){null==t&&(t=this.Oa,this.Oa+=1),this.db.handleError((e===(0|e)?b:y)(this.Qa,t,e))},n.prototype.Eb=function(e){null==e&&(e=this.Oa,this.Oa+=1),m(this.Qa,e,0,0,0)},n.prototype.tb=function(e,t){switch(null==t&&(t=this.Oa,this.Oa+=1),typeof e){case"string":return void this.sb(e,t);case"number":return void this.rb(e,t);case"bigint":return void this.sb(e.toString(),t);case"boolean":return void this.rb(e+0,t);case"object":if(null===e)return void this.Eb(t);if(null!=e.length)return void this.Bb(e,t)}throw"Wrong API use : tried to bind a value of an unknown type ("+e+")."},n.prototype.Db=function(e){var t=this;return Object.keys(e).forEach(function(n){var i=S(t.Qa,n);0!==i&&t.tb(e[n],i)}),!0},n.prototype.Cb=function(e){for(var t=0;t<e.length;t+=1)this.tb(e[t],t+1);return!0},n.prototype.reset=function(){return this.freemem(),0===R(this.Qa)&&0===P(this.Qa)},n.prototype.freemem=function(){for(var e;void 0!==(e=this.lb.pop());)Dt(e)},n.prototype.free=function(){this.freemem();var e=0===$(this.Qa);return delete this.db.fb[this.Qa],this.Qa=0,e},a.prototype.next=function(){if(null===this.eb)return{done:!0};if(null!==this.Za&&(this.Za.free(),this.Za=null),!this.db.db)throw this.mb(),Error("Database closed");var e=zt(),t=Et(4);q(s),q(t);try{this.db.handleError(v(this.db.db,this.kb,-1,s,t)),this.kb=U(t,"i32");var i=U(s,"i32");return 0===i?(this.mb(),{done:!0}):(this.Za=new n(i,this.db),this.db.fb[i]=this.Za,{value:this.Za,done:!1})}catch(a){throw this.pb=G(this.kb),this.mb(),a}finally{At(e)}},a.prototype.mb=function(){Dt(this.eb),this.eb=null},a.prototype.getRemainingSQL=function(){return null!==this.pb?this.pb:G(this.kb)},"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator&&(a.prototype[Symbol.iterator]=function(){return this}),r.prototype.run=function(e,t){if(!this.db)throw"Database closed";if(t){e=this.prepare(e,t);try{e.step()}finally{e.free()}}else this.handleError(d(this.db,e,0,0,s));return this},r.prototype.exec=function(e,t,i){if(!this.db)throw"Database closed";var a=zt(),r=null;try{var o=yt(e),l=Et(4);for(e=[];0!==U(o,"i8");){q(s),q(l),this.handleError(v(this.db,o,-1,s,l));var c=U(s,"i32");if(o=U(l,"i32"),0!==c){var d=null;for(r=new n(c,this),null!=t&&r.bind(t);r.step();)null===d&&(d={columns:r.getColumnNames(),values:[]},e.push(d)),d.values.push(r.get(null,i));r.free()}}return e}catch(u){throw r&&r.free(),u}finally{At(a)}},r.prototype.each=function(e,t,n,i,a){"function"==typeof t&&(i=n,n=t,t=void 0),e=this.prepare(e,t);try{for(;e.step();)n(e.getAsObject(null,a))}finally{e.free()}if("function"==typeof i)return i()},r.prototype.prepare=function(e,t){if(q(s),this.handleError(h(this.db,e,-1,s,0)),0===(e=U(s,"i32")))throw"Nothing to prepare";var i=new n(e,this);return null!=t&&i.bind(t),this.fb[e]=i},r.prototype.iterateStatements=function(e){return new a(e,this)},r.prototype.export=function(){Object.values(this.fb).forEach(function(e){e.free()}),Object.values(this.Sa).forEach(St),this.Sa={},this.handleError(c(this.db));var e=function(e){var t,n=Xe(e,n||0);e=Qe(e).size;var i=new Uint8Array(e);return tt(n,i,0,e,0),t=i,Je(n),t}(this.filename);return this.handleError(l(this.filename,s)),this.db=U(s,"i32"),ie(this.db),e},r.prototype.close=function(){null!==this.db&&(Object.values(this.fb).forEach(function(e){e.free()}),Object.values(this.Sa).forEach(St),this.Sa={},this.Ya&&(St(this.Ya),this.Ya=void 0),this.handleError(c(this.db)),Ge("/"+this.filename),this.db=null)},r.prototype.handleError=function(e){if(0===e)return null;throw e=_(this.db),Error(e)},r.prototype.getRowsModified=function(){return u(this.db)},r.prototype.create_function=function(n,i){Object.prototype.hasOwnProperty.call(this.Sa,n)&&(St(this.Sa[n]),delete this.Sa[n]);var a=xt(function(n,a,r){a=t(a,r);try{var s=i.apply(null,a)}catch(o){return void X(n,o,-1)}e(n,s)},"viii");return this.Sa[n]=a,this.handleError(O(this.db,n,i.length,1,0,a,0,0,0)),this},r.prototype.create_aggregate=function(n,i){var a=i.init||function(){return null},r=i.finalize||function(e){return e},s=i.step;if(!s)throw"An aggregate function must have a step function in "+n;var o={};Object.hasOwnProperty.call(this.Sa,n)&&(St(this.Sa[n]),delete this.Sa[n]),i=n+"__finalize",Object.hasOwnProperty.call(this.Sa,i)&&(St(this.Sa[i]),delete this.Sa[i]);var l=xt(function(e,n,i){var r=J(e,1);Object.hasOwnProperty.call(o,r)||(o[r]=a()),n=t(n,i),n=[o[r]].concat(n);try{o[r]=s.apply(null,n)}catch(l){delete o[r],X(e,l,-1)}},"viii"),c=xt(function(t){var n=J(t,1);try{var i=r(o[n])}catch(a){return delete o[n],void X(t,a,-1)}e(t,i),delete o[n]},"vi");return this.Sa[n]=l,this.Sa[i]=c,this.handleError(O(this.db,n,s.length-1,1,0,0,l,c,0)),this},r.prototype.updateHook=function(e){this.Ya&&(ae(this.db,0,0),St(this.Ya),this.Ya=void 0),e&&(this.Ya=xt(function(t,n,i,a,r){switch(n){case 18:t="insert";break;case 23:t="update";break;case 9:t="delete";break;default:throw"unknown operationCode in updateHook callback: "+n}if(i=i?W(k,i):"",a=a?W(k,a):"",r>Number.MAX_SAFE_INTEGER)throw"rowId too big to fit inside a Number";e(t,i,a,Number(r))},"viiiij"),ae(this.db,this.Ya,0))},i.Database=r};var c,d,u={...i},h="./this.program",p=(e,t)=>{throw t},g="";if(l){var v=fe;g=__dirname+"/",d=e=>(e=A(e)?new URL(e):e,v.readFileSync(e)),c=async e=>(e=A(e)?new URL(e):e,v.readFileSync(e,void 0)),!i.thisProgram&&1<process.argv.length&&(h=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),lne.exports=i,p=(e,t)=>{throw process.exitCode=e,t}}else(s||o)&&(o?g=self.location.href:"undefined"!=typeof document&&document.currentScript&&(g=document.currentScript.src),g=g.startsWith("blob:")?"":g.slice(0,g.replace(/[?#].*/,"").lastIndexOf("/")+1),o&&(d=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),c=async e=>{if(A(e))return new Promise((t,n)=>{var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=()=>{200==i.status||0==i.status&&i.response?t(i.response):n(i.status)},i.onerror=n,i.send(null)});var t=await fetch(e,{credentials:"same-origin"});if(t.ok)return t.arrayBuffer();throw Error(t.status+" : "+t.url)});var f=i.print||function(){}.bind(),m=i.printErr||function(){}.bind();Object.assign(i,u),u=null,i.thisProgram&&(h=i.thisProgram);var y,b,w,k,S,x,_,C,I,D,T=i.wasmBinary,M=!1,A=e=>e.startsWith("file://");function E(){var e=y.buffer;i.HEAP8=w=new Int8Array(e),i.HEAP16=S=new Int16Array(e),i.HEAPU8=k=new Uint8Array(e),i.HEAPU16=new Uint16Array(e),i.HEAP32=x=new Int32Array(e),i.HEAPU32=_=new Uint32Array(e),i.HEAPF32=C=new Float32Array(e),i.HEAPF64=D=new Float64Array(e),i.HEAP64=I=new BigInt64Array(e),i.HEAPU64=new BigUint64Array(e)}var z,P=0,R=null;function $(e){var t;throw null==(t=i.onAbort)||t.call(i,e),m(e="Aborted("+e+")"),M=!0,new WebAssembly.RuntimeError(e+". Build with -sASSERTIONS for more info.")}async function O(e,t){try{var n=await async function(e){if(!T)try{var t=await c(e);return new Uint8Array(t)}catch(n){}if(e==z&&T)e=new Uint8Array(T);else{if(!d)throw"both async and sync fetching of the wasm failed";e=d(e)}return e}(e);return await WebAssembly.instantiate(n,t)}catch(i){m(`failed to asynchronously prepare wasm: ${i}`),$(i)}}class L{constructor(e){oe(this,"name","ExitStatus"),this.message=`Program terminated with exit(${e})`,this.status=e}}var N=e=>{for(;0<e.length;)e.shift()(i)},F=[],B=[],j=()=>{var e=i.preRun.shift();B.unshift(e)};function U(e,t="i8"){switch(t.endsWith("*")&&(t="*"),t){case"i1":case"i8":return w[e];case"i16":return S[e>>1];case"i32":return x[e>>2];case"i64":return I[e>>3];case"float":return C[e>>2];case"double":return D[e>>3];case"*":return _[e>>2];default:$(`invalid type for getValue: ${t}`)}}var V=i.noExitRuntime||!0;function q(e){var t="i32";switch(t.endsWith("*")&&(t="*"),t){case"i1":case"i8":w[e]=0;break;case"i16":S[e>>1]=0;break;case"i32":x[e>>2]=0;break;case"i64":I[e>>3]=BigInt(0);break;case"float":C[e>>2]=0;break;case"double":D[e>>3]=0;break;case"*":_[e>>2]=0;break;default:$(`invalid type for setValue: ${t}`)}}var H="undefined"!=typeof TextDecoder?new TextDecoder:void 0,W=(e,t=0,n=NaN)=>{var i=t+n;for(n=t;e[n]&&!(n>=i);)++n;if(16<n-t&&e.buffer&&H)return H.decode(e.subarray(t,n));for(i="";t<n;){var a=e[t++];if(128&a){var r=63&e[t++];if(192==(224&a))i+=String.fromCharCode((31&a)<<6|r);else{var s=63&e[t++];65536>(a=224==(240&a)?(15&a)<<12|r<<6|s:(7&a)<<18|r<<12|s<<6|63&e[t++])?i+=String.fromCharCode(a):(a-=65536,i+=String.fromCharCode(55296|a>>10,56320|1023&a))}}else i+=String.fromCharCode(a)}return i},G=(e,t)=>e?W(k,e,t):"",Q=(e,t)=>{for(var n=0,i=e.length-1;0<=i;i--){var a=e[i];"."===a?e.splice(i,1):".."===a?(e.splice(i,1),n++):n&&(e.splice(i,1),n--)}if(t)for(;n;n--)e.unshift("..");return e},K=e=>{var t="/"===e.charAt(0),n="/"===e.slice(-1);return(e=Q(e.split("/").filter(e=>!!e),!t).join("/"))||t||(e="."),e&&n&&(e+="/"),(t?"/":"")+e},Z=e=>{var t=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1);return e=t[0],t=t[1],e||t?(t&&(t=t.slice(0,-1)),e+t):"."},Y=e=>e&&e.match(/([^\/]+|\/)\/*$/)[1],X=e=>{(X=(()=>{if(l){var e=me;return t=>e.randomFillSync(t)}return e=>crypto.getRandomValues(e)})())(e)},J=[],ee=e=>{for(var t=0,n=0;n<e.length;++n){var i=e.charCodeAt(n);127>=i?t++:2047>=i?t+=2:55296<=i&&57343>=i?(t+=4,++n):t+=3}return t},te=(e,t,n,i)=>{if(!(0<i))return 0;var a=n;i=n+i-1;for(var r=0;r<e.length;++r){var s=e.charCodeAt(r);if(55296<=s&&57343>=s&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++r)),127>=s){if(n>=i)break;t[n++]=s}else{if(2047>=s){if(n+1>=i)break;t[n++]=192|s>>6}else{if(65535>=s){if(n+2>=i)break;t[n++]=224|s>>12}else{if(n+3>=i)break;t[n++]=240|s>>18,t[n++]=128|s>>12&63}t[n++]=128|s>>6&63}t[n++]=128|63&s}}return t[n]=0,n-a},ne=(e,t)=>{var n=Array(ee(e)+1);return e=te(e,n,0,n.length),t&&(n.length=e),n},ie=[];function ae(e,t){ie[e]={input:[],output:[],cb:t},Be(e,re)}var re={open(e){var t=ie[e.node.rdev];if(!t)throw new ke(43);e.tty=t,e.seekable=!1},close(e){e.tty.cb.fsync(e.tty)},fsync(e){e.tty.cb.fsync(e.tty)},read(e,t,n,i){if(!e.tty||!e.tty.cb.xb)throw new ke(60);for(var a=0,r=0;r<i;r++){try{var s=e.tty.cb.xb(e.tty)}catch(o){throw new ke(29)}if(void 0===s&&0===a)throw new ke(6);if(null==s)break;a++,t[n+r]=s}return a&&(e.node.atime=Date.now()),a},write(e,t,n,i){if(!e.tty||!e.tty.cb.qb)throw new ke(60);try{for(var a=0;a<i;a++)e.tty.cb.qb(e.tty,t[n+a])}catch(r){throw new ke(29)}return i&&(e.node.mtime=e.node.ctime=Date.now()),a}},se={xb(){e:{if(!J.length){var e=null;if(l){var t=Buffer.alloc(256),n=0,i=process.stdin.fd;try{n=v.readSync(i,t,0,256)}catch(a){if(!a.toString().includes("EOF"))throw a;n=0}0<n&&(e=t.slice(0,n).toString("utf-8"))}else"undefined"!=typeof window&&"function"==typeof window.prompt&&null!==(e=window.prompt("Input: "))&&(e+="\n");if(!e){e=null;break e}J=ne(e,!0)}e=J.shift()}return e},qb(e,t){null===t||10===t?(f(W(e.output)),e.output=[]):0!=t&&e.output.push(t)},fsync(e){var t;0<(null==(t=e.output)?void 0:t.length)&&(f(W(e.output)),e.output=[])},Tb:()=>({Ob:25856,Qb:5,Nb:191,Pb:35387,Mb:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),Ub:()=>0,Vb:()=>[24,80]},le={qb(e,t){null===t||10===t?(m(W(e.output)),e.output=[]):0!=t&&e.output.push(t)},fsync(e){var t;0<(null==(t=e.output)?void 0:t.length)&&(m(W(e.output)),e.output=[])}},ce={Wa:null,Xa:()=>ce.createNode(null,"/",16895,0),createNode(e,t,n,i){if(24576==(61440&n)||4096==(61440&n))throw new ke(63);return ce.Wa||(ce.Wa={dir:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua,lookup:ce.La.lookup,hb:ce.La.hb,rename:ce.La.rename,unlink:ce.La.unlink,rmdir:ce.La.rmdir,readdir:ce.La.readdir,symlink:ce.La.symlink},stream:{Va:ce.Ma.Va}},file:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua},stream:{Va:ce.Ma.Va,read:ce.Ma.read,write:ce.Ma.write,ib:ce.Ma.ib,jb:ce.Ma.jb}},link:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua,readlink:ce.La.readlink},stream:{}},ub:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua},stream:Fe}}),Ae((n=Me(e,t,n,i)).mode)?(n.La=ce.Wa.dir.node,n.Ma=ce.Wa.dir.stream,n.Na={}):32768==(61440&n.mode)?(n.La=ce.Wa.file.node,n.Ma=ce.Wa.file.stream,n.Ra=0,n.Na=null):40960==(61440&n.mode)?(n.La=ce.Wa.link.node,n.Ma=ce.Wa.link.stream):8192==(61440&n.mode)&&(n.La=ce.Wa.ub.node,n.Ma=ce.Wa.ub.stream),n.atime=n.mtime=n.ctime=Date.now(),e&&(e.Na[t]=n,e.atime=e.mtime=e.ctime=n.atime),n},Sb:e=>e.Na?e.Na.subarray?e.Na.subarray(0,e.Ra):new Uint8Array(e.Na):new Uint8Array(0),La:{Ta(e){var t={};return t.dev=8192==(61440&e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,Ae(e.mode)?t.size=4096:32768==(61440&e.mode)?t.size=e.Ra:40960==(61440&e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.atime),t.mtime=new Date(e.mtime),t.ctime=new Date(e.ctime),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},Ua(e,t){for(var n of["mode","atime","mtime","ctime"])null!=t[n]&&(e[n]=t[n]);void 0!==t.size&&(t=t.size,e.Ra!=t&&(0==t?(e.Na=null,e.Ra=0):(n=e.Na,e.Na=new Uint8Array(t),n&&e.Na.set(n.subarray(0,Math.min(t,e.Ra))),e.Ra=t)))},lookup(){throw ce.vb},hb:(e,t,n,i)=>ce.createNode(e,t,n,i),rename(e,t,n){try{var i=Te(t,n)}catch(r){}if(i){if(Ae(e.mode))for(var a in i.Na)throw new ke(55);De(i)}delete e.parent.Na[e.name],t.Na[n]=e,e.name=n,t.ctime=t.mtime=e.parent.ctime=e.parent.mtime=Date.now()},unlink(e,t){delete e.Na[t],e.ctime=e.mtime=Date.now()},rmdir(e,t){var n,i=Te(e,t);for(n in i.Na)throw new ke(55);delete e.Na[t],e.ctime=e.mtime=Date.now()},readdir:e=>[".","..",...Object.keys(e.Na)],symlink:(e,t,n)=>((e=ce.createNode(e,t,41471,0)).link=n,e),readlink(e){if(40960!=(61440&e.mode))throw new ke(28);return e.link}},Ma:{read(e,t,n,i,a){var r=e.node.Na;if(a>=e.node.Ra)return 0;if(8<(e=Math.min(e.node.Ra-a,i))&&r.subarray)t.set(r.subarray(a,a+e),n);else for(i=0;i<e;i++)t[n+i]=r[a+i];return e},write(e,t,n,i,a,r){if(t.buffer===w.buffer&&(r=!1),!i)return 0;if((e=e.node).mtime=e.ctime=Date.now(),t.subarray&&(!e.Na||e.Na.subarray)){if(r)return e.Na=t.subarray(n,n+i),e.Ra=i;if(0===e.Ra&&0===a)return e.Na=t.slice(n,n+i),e.Ra=i;if(a+i<=e.Ra)return e.Na.set(t.subarray(n,n+i),a),i}r=a+i;var s=e.Na?e.Na.length:0;if(s>=r||(r=Math.max(r,s*(1048576>s?2:1.125)>>>0),0!=s&&(r=Math.max(r,256)),s=e.Na,e.Na=new Uint8Array(r),0<e.Ra&&e.Na.set(s.subarray(0,e.Ra),0)),e.Na.subarray&&t.subarray)e.Na.set(t.subarray(n,n+i),a);else for(r=0;r<i;r++)e.Na[a+r]=t[n+r];return e.Ra=Math.max(e.Ra,a+i),i},Va(e,t,n){if(1===n?t+=e.position:2===n&&32768==(61440&e.node.mode)&&(t+=e.node.Ra),0>t)throw new ke(28);return t},ib(e,t,n,i,a){if(32768!=(61440&e.node.mode))throw new ke(43);if(e=e.node.Na,2&a||!e||e.buffer!==w.buffer){a=!0,i=65536*Math.ceil(t/65536);var r=Tt(65536,i);if(r&&k.fill(0,r,r+i),!(i=r))throw new ke(48);e&&((0<n||n+t<e.length)&&(e=e.subarray?e.subarray(n,n+t):Array.prototype.slice.call(e,n,n+t)),w.set(e,i))}else a=!1,i=e.byteOffset;return{Kb:i,Ab:a}},jb:(e,t,n,i)=>(ce.Ma.write(e,t,0,i,n,!1),0)}},de=(e,t)=>{var n=0;return e&&(n|=365),t&&(n|=146),n},ue=null,he={},pe=[],ge=1,ve=null,ye=!1,be=!0,we={},ke=class{constructor(e){oe(this,"name","ErrnoError"),this.Pa=e}},Se=class{constructor(){oe(this,"gb",{}),oe(this,"node",null)}get flags(){return this.gb.flags}set flags(e){this.gb.flags=e}get position(){return this.gb.position}set position(e){this.gb.position=e}},xe=class{constructor(e,t,n,i){oe(this,"La",{}),oe(this,"Ma",{}),oe(this,"ab",null),e||(e=this),this.parent=e,this.Xa=e.Xa,this.id=ge++,this.name=t,this.mode=n,this.rdev=i,this.atime=this.mtime=this.ctime=Date.now()}get read(){return!(365&~this.mode)}set read(e){e?this.mode|=365:this.mode&=-366}get write(){return!(146&~this.mode)}set write(e){e?this.mode|=146:this.mode&=-147}};function _e(e,t={}){if(!e)throw new ke(44);null!=t.nb||(t.nb=!0),"/"===e.charAt(0)||(e="//"+e);var n=0;e:for(;40>n;n++){e=e.split("/").filter(e=>!!e);for(var i=ue,a="/",r=0;r<e.length;r++){var s=r===e.length-1;if(s&&t.parent)break;if("."!==e[r])if(".."===e[r])a=Z(a),i=i.parent;else{a=K(a+"/"+e[r]);try{i=Te(i,e[r])}catch(o){if(44===(null==o?void 0:o.Pa)&&s&&t.Jb)return{path:a};throw o}if(!i.ab||s&&!t.nb||(i=i.ab.root),40960==(61440&i.mode)&&(!s||t.$a)){if(!i.La.readlink)throw new ke(52);"/"===(i=i.La.readlink(i)).charAt(0)||(i=Z(a)+"/"+i),e=i+"/"+e.slice(r+1).join("/");continue e}}}return{path:a,node:i}}throw new ke(32)}function Ce(e){for(var t;;){if(e===e.parent)return e=e.Xa.zb,t?"/"!==e[e.length-1]?`${e}/${t}`:e+t:e;t=t?`${e.name}/${t}`:e.name,e=e.parent}}function Ie(e,t){for(var n=0,i=0;i<t.length;i++)n=(n<<5)-n+t.charCodeAt(i)|0;return(e+n>>>0)%ve.length}function De(e){var t=Ie(e.parent.id,e.name);if(ve[t]===e)ve[t]=e.bb;else for(t=ve[t];t;){if(t.bb===e){t.bb=e.bb;break}t=t.bb}}function Te(e,t){var n=Ae(e.mode)?(n=ze(e,"x"))?n:e.La.lookup?0:2:54;if(n)throw new ke(n);for(n=ve[Ie(e.id,t)];n;n=n.bb){var i=n.name;if(n.parent.id===e.id&&i===t)return n}return e.La.lookup(e,t)}function Me(e,t,n,i){return t=Ie((e=new xe(e,t,n,i)).parent.id,e.name),e.bb=ve[t],ve[t]=e}function Ae(e){return 16384==(61440&e)}function Ee(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t}function ze(e,t){return be?0:!t.includes("r")||292&e.mode?t.includes("w")&&!(146&e.mode)||t.includes("x")&&!(73&e.mode)?2:0:2}function Pe(e,t){if(!Ae(e.mode))return 54;try{return Te(e,t),20}catch(n){}return ze(e,"wx")}function Re(e,t,n){try{var i=Te(e,t)}catch(a){return a.Pa}if(e=ze(e,"wx"))return e;if(n){if(!Ae(i.mode))return 54;if(i===i.parent||"/"===Ce(i))return 10}else if(Ae(i.mode))return 31;return 0}function $e(e){if(!e)throw new ke(63);return e}function Oe(e){if(!(e=pe[e]))throw new ke(8);return e}function Le(e,t=-1){if(e=Object.assign(new Se,e),-1==t)e:{for(t=0;4096>=t;t++)if(!pe[t])break e;throw new ke(33)}return e.fd=t,pe[t]=e}function Ne(e,t,n){var i=null==e?void 0:e.Ma.Ua;e=i?e:t,null!=i||(i=t.La.Ua),$e(i),i(e,n)}var Fe={open(e){var t,n;e.Ma=he[e.node.rdev].Ma,null==(n=(t=e.Ma).open)||n.call(t,e)},Va(){throw new ke(70)}};function Be(e,t){he[e]={Ma:t}}function je(e,t){var n="/"===t;if(n&&ue)throw new ke(10);if(!n&&t){var i=_e(t,{nb:!1});if(t=i.path,(i=i.node).ab)throw new ke(10);if(!Ae(i.mode))throw new ke(54)}t={type:e,Wb:{},zb:t,Ib:[]},(e=e.Xa(t)).Xa=t,t.root=e,n?ue=e:i&&(i.ab=t,i.Xa&&i.Xa.Ib.push(t))}function Ue(e,t,n){var i=_e(e,{parent:!0}).node;if(!(e=Y(e)))throw new ke(28);if("."===e||".."===e)throw new ke(20);var a=Pe(i,e);if(a)throw new ke(a);if(!i.La.hb)throw new ke(63);return i.La.hb(i,e,t,n)}function Ve(e,t=511){return Ue(e,1023&t|16384,0)}function qe(e,t,n){void 0===n&&(n=t,t=438),Ue(e,8192|t,n)}function He(e,t){if(!((...e)=>{for(var t="",n=!1,i=e.length-1;-1<=i&&!n;i--){if("string"!=typeof(n=0<=i?e[i]:"/"))throw new TypeError("Arguments to path.resolve must be strings");if(!n)return"";t=n+"/"+t,n="/"===n.charAt(0)}return(n?"/":"")+(t=Q(t.split("/").filter(e=>!!e),!n).join("/"))||"."})(e))throw new ke(44);var n=_e(t,{parent:!0}).node;if(!n)throw new ke(44);var i=Pe(n,t=Y(t));if(i)throw new ke(i);if(!n.La.symlink)throw new ke(63);n.La.symlink(n,t,e)}function We(e){var t=_e(e,{parent:!0}).node,n=Te(t,e=Y(e)),i=Re(t,e,!0);if(i)throw new ke(i);if(!t.La.rmdir)throw new ke(63);if(n.ab)throw new ke(10);t.La.rmdir(t,e),De(n)}function Ge(e){var t=_e(e,{parent:!0}).node;if(!t)throw new ke(44);var n=Te(t,e=Y(e)),i=Re(t,e,!1);if(i)throw new ke(i);if(!t.La.unlink)throw new ke(63);if(n.ab)throw new ke(10);t.La.unlink(t,e),De(n)}function Qe(e,t){return $e((e=_e(e,{$a:!t}).node).La.Ta)(e)}function Ke(e,t,n,i){Ne(e,t,{mode:4095&n|-4096&t.mode,ctime:Date.now(),Fb:i})}function Ze(e,t){Ke(null,e="string"==typeof e?_e(e,{$a:!0}).node:e,t)}function Ye(e,t,n){if(Ae(t.mode))throw new ke(31);if(32768!=(61440&t.mode))throw new ke(28);var i=ze(t,"w");if(i)throw new ke(i);Ne(e,t,{size:n,timestamp:Date.now()})}function Xe(e,t,n=438){if(""===e)throw new ke(44);if("string"==typeof t){var a={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[t];if(void 0===a)throw Error(`Unknown file open mode: ${t}`);t=a}if(n=64&t?4095&n|32768:0,"object"==typeof e)a=e;else{var r=e.endsWith("/");a=(e=_e(e,{$a:!(131072&t),Jb:!0})).node,e=e.path}var s=!1;if(64&t)if(a){if(128&t)throw new ke(20)}else{if(r)throw new ke(31);a=Ue(e,511|n,0),s=!0}if(!a)throw new ke(44);if(8192==(61440&a.mode)&&(t&=-513),65536&t&&!Ae(a.mode))throw new ke(54);if(!s&&(r=a?40960==(61440&a.mode)?32:Ae(a.mode)&&("r"!==Ee(t)||576&t)?31:ze(a,Ee(t)):44))throw new ke(r);return 512&t&&!s&&Ye(null,r="string"==typeof(r=a)?_e(r,{$a:!0}).node:r,0),t&=-131713,(r=Le({node:a,path:Ce(a),flags:t,seekable:!0,position:0,Ma:a.Ma,Lb:[],error:!1})).Ma.open&&r.Ma.open(r),s&&Ze(a,511&n),!i.logReadFiles||1&t||e in we||(we[e]=1),r}function Je(e){if(null===e.fd)throw new ke(8);e.ob&&(e.ob=null);try{e.Ma.close&&e.Ma.close(e)}catch(t){throw t}finally{pe[e.fd]=null}e.fd=null}function et(e,t,n){if(null===e.fd)throw new ke(8);if(!e.seekable||!e.Ma.Va)throw new ke(70);if(0!=n&&1!=n&&2!=n)throw new ke(28);e.position=e.Ma.Va(e,t,n),e.Lb=[]}function tt(e,t,n,i,a){if(0>i||0>a)throw new ke(28);if(null===e.fd)throw new ke(8);if(1==(2097155&e.flags))throw new ke(8);if(Ae(e.node.mode))throw new ke(31);if(!e.Ma.read)throw new ke(28);var r=void 0!==a;if(r){if(!e.seekable)throw new ke(70)}else a=e.position;return t=e.Ma.read(e,t,n,i,a),r||(e.position+=t),t}function nt(e,t,n,i,a){if(0>i||0>a)throw new ke(28);if(null===e.fd)throw new ke(8);if(!(2097155&e.flags))throw new ke(8);if(Ae(e.node.mode))throw new ke(31);if(!e.Ma.write)throw new ke(28);e.seekable&&1024&e.flags&&et(e,0,2);var r=void 0!==a;if(r){if(!e.seekable)throw new ke(70)}else a=e.position;return t=e.Ma.write(e,t,n,i,a,void 0),r||(e.position+=t),t}function it(e,t,n){e=K("/dev/"+e);var i=de(!!t,!!n);null!=it.yb||(it.yb=64);var a=it.yb++<<8;Be(a,{open(e){e.seekable=!1},close(){var e;(null==(e=null==n?void 0:n.buffer)?void 0:e.length)&&n(10)},read(e,n,i,a){for(var r=0,s=0;s<a;s++){try{var o=t()}catch(l){throw new ke(29)}if(void 0===o&&0===r)throw new ke(6);if(null==o)break;r++,n[i+s]=o}return r&&(e.node.atime=Date.now()),r},write(e,t,i,a){for(var r=0;r<a;r++)try{n(t[i+r])}catch(s){throw new ke(29)}return a&&(e.node.mtime=e.node.ctime=Date.now()),r}}),qe(e,i,a)}function at(e,t,n){if("/"===t.charAt(0))return t;if(e=-100===e?"/":Oe(e).path,0==t.length){if(!n)throw new ke(44);return e}return e+"/"+t}function rt(e,t){x[e>>2]=t.dev,x[e+4>>2]=t.mode,_[e+8>>2]=t.nlink,x[e+12>>2]=t.uid,x[e+16>>2]=t.gid,x[e+20>>2]=t.rdev,I[e+24>>3]=BigInt(t.size),x[e+32>>2]=4096,x[e+36>>2]=t.blocks;var n=t.atime.getTime(),i=t.mtime.getTime(),a=t.ctime.getTime();return I[e+40>>3]=BigInt(Math.floor(n/1e3)),_[e+48>>2]=n%1e3*1e6,I[e+56>>3]=BigInt(Math.floor(i/1e3)),_[e+64>>2]=i%1e3*1e6,I[e+72>>3]=BigInt(Math.floor(a/1e3)),_[e+80>>2]=a%1e3*1e6,I[e+88>>3]=BigInt(t.ino),0}var st,ot,lt,ct=void 0,dt=()=>{var e=x[+ct>>2];return ct+=4,e},ut=0,ht=[0,31,60,91,121,152,182,213,244,274,305,335],pt=[0,31,59,90,120,151,181,212,243,273,304,334],gt={},vt=e=>{var t;b=e,V||0<ut||(null==(t=i.onExit)||t.call(i,e),M=!0),p(e,new L(e))},ft={},mt=()=>{if(!st){var e,t={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:h||"./this.program"};for(e in ft)void 0===ft[e]?delete t[e]:t[e]=ft[e];var n=[];for(e in t)n.push(`${e}=${t[e]}`);st=n}return st},yt=e=>{var t=ee(e)+1,n=Et(t);return te(e,k,n,t),n},bt=0,wt=(e,t)=>(t=1==t?Et(e.length):It(e.length),e.subarray||e.slice||(e=new Uint8Array(e)),k.set(e,t),t),kt=[],St=e=>{ot.delete(lt.get(e)),lt.set(e,null),kt.push(e)},xt=(e,t)=>{if(!ot){ot=new WeakMap;var n=lt.length;if(ot)for(var i=0;i<0+n;i++){var a=lt.get(i);a&&ot.set(a,i)}}if(n=ot.get(e)||0)return n;if(kt.length)n=kt.pop();else{try{lt.grow(1)}catch(l){if(!(l instanceof RangeError))throw l;throw"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH."}n=lt.length-1}try{lt.set(n,e)}catch(l){if(!(l instanceof TypeError))throw l;if("function"==typeof WebAssembly.Function){var r=WebAssembly.Function;i={i:"i32",j:"i64",f:"f32",d:"f64",e:"externref",p:"i32"},a={parameters:[],results:"v"==t[0]?[]:[i[t[0]]]};for(var s=1;s<t.length;++s)a.parameters.push(i[t[s]]);t=new r(a,e)}else{i=[1],a=t.slice(0,1),t=t.slice(1),s={i:127,p:127,j:126,f:125,d:124,e:111},i.push(96);var o=t.length;for(r of(128>o?i.push(o):i.push(o%128|128,o>>7),t))i.push(s[r]);"v"==a?i.push(0):i.push(1,s[a]),t=[0,97,115,109,1,0,0,0,1],128>(r=i.length)?t.push(r):t.push(r%128|128,r>>7),t.push(...i),t.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0),t=new WebAssembly.Module(new Uint8Array(t)),t=new WebAssembly.Instance(t,{e:{f:e}}).exports.f}lt.set(n,t)}return ot.set(e,n),n};ve=Array(4096),je(ce,"/"),Ve("/tmp"),Ve("/home"),Ve("/home/web_user"),function(){Ve("/dev"),Be(259,{read:()=>0,write:(e,t,n,i)=>i,Va:()=>0}),qe("/dev/null",259),ae(1280,se),ae(1536,le),qe("/dev/tty",1280),qe("/dev/tty1",1536);var e=new Uint8Array(1024),t=0,n=()=>(0===t&&(X(e),t=e.byteLength),e[--t]);it("random",n),it("urandom",n),Ve("/dev/shm"),Ve("/dev/shm/tmp")}(),function(){Ve("/proc");var e=Ve("/proc/self");Ve("/proc/self/fd"),je({Xa(){var t=Me(e,"fd",16895,73);return t.Ma={Va:ce.Ma.Va},t.La={lookup(e,t){var n=Oe(e=+t);return(e={parent:null,Xa:{zb:"fake"},La:{readlink:()=>n.path},id:e+1}).parent=e},readdir:()=>Array.from(pe.entries()).filter(([,e])=>e).map(([e])=>e.toString())},t}},"/proc/self/fd")}(),ce.vb=new ke(44),ce.vb.stack="<generic error, no stack>";var _t,Ct={a:(e,t,n,i)=>$(`Assertion failed: ${e?W(k,e):""}, at: `+[t?t?W(k,t):"":"unknown filename",n,i?i?W(k,i):"":"unknown function"]),i:function(e,t){try{return Ze(e=e?W(k,e):"",t),0}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},L:function(e,t,n){try{if(t=at(e,t=t?W(k,t):""),-8&n)return-28;var i=_e(t,{$a:!0}).node;return i?(e="",4&n&&(e+="r"),2&n&&(e+="w"),1&n&&(e+="x"),e&&ze(i,e)?-2:0):-44}catch(a){if("ErrnoError"!==a.name)throw a;return-a.Pa}},j:function(e,t){try{var n=Oe(e);return Ke(n,n.node,t,!1),0}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},h:function(e){try{var t=Oe(e);return Ne(t,t.node,{timestamp:Date.now(),Fb:!1}),0}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},b:function(e,t,n){ct=n;try{var i=Oe(e);switch(t){case 0:var a=dt();if(0>a)break;for(;pe[a];)a++;return function(e,t=-1){var n,i;return null==(i=null==(n=(e=Le(e,t)).Ma)?void 0:n.Rb)||i.call(n,e),e}(i,a).fd;case 1:case 2:case 13:case 14:return 0;case 3:return i.flags;case 4:return a=dt(),i.flags|=a,0;case 12:return a=dt(),S[a+0>>1]=2,0}return-28}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},g:function(e,t){try{var n=Oe(e),i=n.node,a=n.Ma.Ta;return e=a?n:i,null!=a||(a=i.La.Ta),$e(a),rt(t,a(e))}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},H:function(e,t){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t);try{if(isNaN(t))return 61;var n=Oe(e);if(0>t||!(2097155&n.flags))throw new ke(28);return Ye(n,n.node,t),0}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},G:function(e,t){try{if(0===t)return-28;var n=ee("/")+1;return t<n?-68:(te("/",k,e,t),n)}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},K:function(e,t){try{return rt(t,Qe(e=e?W(k,e):"",!0))}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},C:function(e,t,n){try{return Ve(t=at(e,t=t?W(k,t):""),n),0}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},J:function(e,t,n,i){try{t=t?W(k,t):"";var a=256&i;return t=at(e,t,4096&i),rt(n,a?Qe(t,!0):Qe(t))}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},x:function(e,t,n,i){ct=i;try{return Xe(t=at(e,t=t?W(k,t):""),n,i?dt():0).fd}catch(a){if("ErrnoError"!==a.name)throw a;return-a.Pa}},v:function(e,t,n,i){try{if(t=at(e,t=t?W(k,t):""),0>=i)return-28;var a=_e(t).node;if(!a)throw new ke(44);if(!a.La.readlink)throw new ke(28);var r=a.La.readlink(a),s=Math.min(i,ee(r)),o=w[n+s];return te(r,k,n,i+1),w[n+s]=o,s}catch(l){if("ErrnoError"!==l.name)throw l;return-l.Pa}},u:function(e){try{return We(e=e?W(k,e):""),0}catch(t){if("ErrnoError"!==t.name)throw t;return-t.Pa}},f:function(e,t){try{return rt(t,Qe(e=e?W(k,e):""))}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},r:function(e,t,n){try{return t=at(e,t=t?W(k,t):""),0===n?Ge(t):512===n?We(t):$("Invalid flags passed to unlinkat"),0}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},q:function(e,t,n){try{t=at(e,t=t?W(k,t):"",!0);var i,a,r=Date.now();if(n){var s=_[n>>2]+4294967296*x[n+4>>2],o=x[n+8>>2];i=1073741823==o?r:1073741822==o?null:1e3*s+o/1e6,s=_[(n+=16)>>2]+4294967296*x[n+4>>2],a=1073741823==(o=x[n+8>>2])?r:1073741822==o?null:1e3*s+o/1e6}else a=i=r;if(null!==(null!=a?a:i)){e=i;var l=_e(t,{$a:!0}).node;$e(l.La.Ua)(l,{atime:e,mtime:a})}return 0}catch(c){if("ErrnoError"!==c.name)throw c;return-c.Pa}},m:()=>$(""),l:()=>{V=!1,ut=0},A:function(e,t){e=-9007199254740992>e||9007199254740992<e?NaN:Number(e),e=new Date(1e3*e),x[t>>2]=e.getSeconds(),x[t+4>>2]=e.getMinutes(),x[t+8>>2]=e.getHours(),x[t+12>>2]=e.getDate(),x[t+16>>2]=e.getMonth(),x[t+20>>2]=e.getFullYear()-1900,x[t+24>>2]=e.getDay();var n=e.getFullYear();x[t+28>>2]=(0!=n%4||0==n%100&&0!=n%400?pt:ht)[e.getMonth()]+e.getDate()-1|0,x[t+36>>2]=-60*e.getTimezoneOffset(),n=new Date(e.getFullYear(),6,1).getTimezoneOffset();var i=new Date(e.getFullYear(),0,1).getTimezoneOffset();x[t+32>>2]=0|(n!=i&&e.getTimezoneOffset()==Math.min(i,n))},y:function(e,t,n,i,a,r,s){a=-9007199254740992>a||9007199254740992<a?NaN:Number(a);try{if(isNaN(a))return 61;var o=Oe(i);if(2&t&&!(2&n)&&2!=(2097155&o.flags))throw new ke(2);if(1==(2097155&o.flags))throw new ke(2);if(!o.Ma.ib)throw new ke(43);if(!e)throw new ke(28);var l=o.Ma.ib(o,e,a,t,n),c=l.Kb;return x[r>>2]=l.Ab,_[s>>2]=c,0}catch(d){if("ErrnoError"!==d.name)throw d;return-d.Pa}},z:function(e,t,n,i,a,r){r=-9007199254740992>r||9007199254740992<r?NaN:Number(r);try{var s=Oe(a);if(2&n){if(n=r,32768!=(61440&s.node.mode))throw new ke(43);if(!(2&i)){var o=k.slice(e,e+t);s.Ma.jb&&s.Ma.jb(s,o,n,t,i)}}}catch(l){if("ErrnoError"!==l.name)throw l;return-l.Pa}},n:(e,t)=>{if(gt[e]&&(clearTimeout(gt[e].id),delete gt[e]),!t)return 0;var n=setTimeout(()=>{delete gt[e],(e=>{if(!M)try{if(e(),!(V||0<ut))try{b=e=b,vt(e)}catch(t){t instanceof L||"unwind"==t||p(1,t)}}catch(t){t instanceof L||"unwind"==t||p(1,t)}})(()=>Mt(e,performance.now()))},t);return gt[e]={id:n,Xb:t},0},B:(e,t,n,i)=>{var a=(new Date).getFullYear(),r=new Date(a,0,1).getTimezoneOffset();a=new Date(a,6,1).getTimezoneOffset(),_[e>>2]=60*Math.max(r,a),x[t>>2]=Number(r!=a),e=(t=e=>{var t=Math.abs(e);return`UTC${0<=e?"-":"+"}${String(Math.floor(t/60)).padStart(2,"0")}${String(t%60).padStart(2,"0")}`})(r),t=t(a),a<r?(te(e,k,n,17),te(t,k,i,17)):(te(e,k,i,17),te(t,k,n,17))},d:()=>Date.now(),s:()=>2147483648,c:()=>performance.now(),o:e=>{var t=k.length;if(2147483648<(e>>>=0))return!1;for(var n=1;4>=n;n*=2){var i=t*(1+.2/n);i=Math.min(i,e+100663296);e:{i=(Math.min(2147483648,65536*Math.ceil(Math.max(e,i)/65536))-y.buffer.byteLength+65535)/65536|0;try{y.grow(i),E();var a=1;break e}catch(r){}a=void 0}if(a)return!0}return!1},E:(e,t)=>{var n=0;return mt().forEach((i,a)=>{var r=t+n;for(a=_[e+4*a>>2]=r,r=0;r<i.length;++r)w[a++]=i.charCodeAt(r);w[a]=0,n+=i.length+1}),0},F:(e,t)=>{var n=mt();_[e>>2]=n.length;var i=0;return n.forEach(e=>i+=e.length+1),_[t>>2]=i,0},e:function(e){try{return Je(Oe(e)),0}catch(t){if("ErrnoError"!==t.name)throw t;return t.Pa}},p:function(e,t){try{var n=Oe(e);return w[t]=n.tty?2:Ae(n.mode)?3:40960==(61440&n.mode)?7:4,S[t+2>>1]=0,I[t+8>>3]=BigInt(0),I[t+16>>3]=BigInt(0),0}catch(i){if("ErrnoError"!==i.name)throw i;return i.Pa}},w:function(e,t,n,i){try{e:{var a=Oe(e);e=t;for(var r,s=t=0;s<n;s++){var o=_[e>>2],l=_[e+4>>2];e+=8;var c=tt(a,w,o,l,r);if(0>c){var d=-1;break e}if(t+=c,c<l)break;void 0!==r&&(r+=c)}d=t}return _[i>>2]=d,0}catch(u){if("ErrnoError"!==u.name)throw u;return u.Pa}},D:function(e,t,n,i){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t);try{if(isNaN(t))return 61;var a=Oe(e);return et(a,t,n),I[i>>3]=BigInt(a.position),a.ob&&0===t&&0===n&&(a.ob=null),0}catch(r){if("ErrnoError"!==r.name)throw r;return r.Pa}},I:function(e){var t;try{var n=Oe(e);return(null==(t=n.Ma)?void 0:t.fsync)?n.Ma.fsync(n):0}catch(i){if("ErrnoError"!==i.name)throw i;return i.Pa}},t:function(e,t,n,i){try{e:{var a=Oe(e);e=t;for(var r,s=t=0;s<n;s++){var o=_[e>>2],l=_[e+4>>2];e+=8;var c=nt(a,w,o,l,r);if(0>c){var d=-1;break e}if(t+=c,c<l)break;void 0!==r&&(r+=c)}d=t}return _[i>>2]=d,0}catch(u){if("ErrnoError"!==u.name)throw u;return u.Pa}},k:vt};!async function(){var e;function t(e){var t;return _t=e.exports,y=_t.M,E(),lt=_t.O,P--,null==(t=i.monitorRunDependencies)||t.call(i,P),0==P&&R&&(e=R,R=null,e()),_t}P++,null==(e=i.monitorRunDependencies)||e.call(i,P);var n={a:Ct};i.instantiateWasm?new Promise(e=>{i.instantiateWasm(n,(n,i)=>{t(n),e(n.exports)})}):(null!=z||(z=i.locateFile?i.locateFile("sql-wasm.wasm",g):g+"sql-wasm.wasm"),t((await async function(e){var t=z;if(!T&&"function"==typeof WebAssembly.instantiateStreaming&&!A(t)&&!l)try{var n=fetch(t,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(n,e)}catch(i){m(`wasm streaming compile failed: ${i}`),m("falling back to ArrayBuffer instantiation")}return O(t,e)}(n)).instance))}(),i._sqlite3_free=e=>(i._sqlite3_free=_t.P)(e),i._sqlite3_value_text=e=>(i._sqlite3_value_text=_t.Q)(e),i._sqlite3_prepare_v2=(e,t,n,a,r)=>(i._sqlite3_prepare_v2=_t.R)(e,t,n,a,r),i._sqlite3_step=e=>(i._sqlite3_step=_t.S)(e),i._sqlite3_reset=e=>(i._sqlite3_reset=_t.T)(e),i._sqlite3_exec=(e,t,n,a,r)=>(i._sqlite3_exec=_t.U)(e,t,n,a,r),i._sqlite3_finalize=e=>(i._sqlite3_finalize=_t.V)(e),i._sqlite3_column_name=(e,t)=>(i._sqlite3_column_name=_t.W)(e,t),i._sqlite3_column_text=(e,t)=>(i._sqlite3_column_text=_t.X)(e,t),i._sqlite3_column_type=(e,t)=>(i._sqlite3_column_type=_t.Y)(e,t),i._sqlite3_errmsg=e=>(i._sqlite3_errmsg=_t.Z)(e),i._sqlite3_clear_bindings=e=>(i._sqlite3_clear_bindings=_t._)(e),i._sqlite3_value_blob=e=>(i._sqlite3_value_blob=_t.$)(e),i._sqlite3_value_bytes=e=>(i._sqlite3_value_bytes=_t.aa)(e),i._sqlite3_value_double=e=>(i._sqlite3_value_double=_t.ba)(e),i._sqlite3_value_int=e=>(i._sqlite3_value_int=_t.ca)(e),i._sqlite3_value_type=e=>(i._sqlite3_value_type=_t.da)(e),i._sqlite3_result_blob=(e,t,n,a)=>(i._sqlite3_result_blob=_t.ea)(e,t,n,a),i._sqlite3_result_double=(e,t)=>(i._sqlite3_result_double=_t.fa)(e,t),i._sqlite3_result_error=(e,t,n)=>(i._sqlite3_result_error=_t.ga)(e,t,n),i._sqlite3_result_int=(e,t)=>(i._sqlite3_result_int=_t.ha)(e,t),i._sqlite3_result_int64=(e,t)=>(i._sqlite3_result_int64=_t.ia)(e,t),i._sqlite3_result_null=e=>(i._sqlite3_result_null=_t.ja)(e),i._sqlite3_result_text=(e,t,n,a)=>(i._sqlite3_result_text=_t.ka)(e,t,n,a),i._sqlite3_aggregate_context=(e,t)=>(i._sqlite3_aggregate_context=_t.la)(e,t),i._sqlite3_column_count=e=>(i._sqlite3_column_count=_t.ma)(e),i._sqlite3_data_count=e=>(i._sqlite3_data_count=_t.na)(e),i._sqlite3_column_blob=(e,t)=>(i._sqlite3_column_blob=_t.oa)(e,t),i._sqlite3_column_bytes=(e,t)=>(i._sqlite3_column_bytes=_t.pa)(e,t),i._sqlite3_column_double=(e,t)=>(i._sqlite3_column_double=_t.qa)(e,t),i._sqlite3_bind_blob=(e,t,n,a,r)=>(i._sqlite3_bind_blob=_t.ra)(e,t,n,a,r),i._sqlite3_bind_double=(e,t,n)=>(i._sqlite3_bind_double=_t.sa)(e,t,n),i._sqlite3_bind_int=(e,t,n)=>(i._sqlite3_bind_int=_t.ta)(e,t,n),i._sqlite3_bind_text=(e,t,n,a,r)=>(i._sqlite3_bind_text=_t.ua)(e,t,n,a,r),i._sqlite3_bind_parameter_index=(e,t)=>(i._sqlite3_bind_parameter_index=_t.va)(e,t),i._sqlite3_sql=e=>(i._sqlite3_sql=_t.wa)(e),i._sqlite3_normalized_sql=e=>(i._sqlite3_normalized_sql=_t.xa)(e),i._sqlite3_changes=e=>(i._sqlite3_changes=_t.ya)(e),i._sqlite3_close_v2=e=>(i._sqlite3_close_v2=_t.za)(e),i._sqlite3_create_function_v2=(e,t,n,a,r,s,o,l,c)=>(i._sqlite3_create_function_v2=_t.Aa)(e,t,n,a,r,s,o,l,c),i._sqlite3_update_hook=(e,t,n)=>(i._sqlite3_update_hook=_t.Ba)(e,t,n),i._sqlite3_open=(e,t)=>(i._sqlite3_open=_t.Ca)(e,t);var It=i._malloc=e=>(It=i._malloc=_t.Da)(e),Dt=i._free=e=>(Dt=i._free=_t.Ea)(e);i._RegisterExtensionFunctions=e=>(i._RegisterExtensionFunctions=_t.Fa)(e);var Tt=(e,t)=>(Tt=_t.Ga)(e,t),Mt=(e,t)=>(Mt=_t.Ha)(e,t),At=e=>(At=_t.Ia)(e),Et=e=>(Et=_t.Ja)(e),zt=()=>(zt=_t.Ka)();if(i.stackSave=()=>zt(),i.stackRestore=e=>At(e),i.stackAlloc=e=>Et(e),i.cwrap=(e,t,n,a)=>{var r=!n||n.every(e=>"number"===e||"boolean"===e);return"string"!==t&&r&&!a?i["_"+e]:(...a)=>((e,t,n,a)=>{var r={string:e=>{var t=0;return null!=e&&0!==e&&(t=yt(e)),t},array:e=>{var t=Et(e.length);return w.set(e,t),t}};e=i["_"+e];var s,o=[],l=0;if(a)for(var c=0;c<a.length;c++){var d=r[n[c]];d?(0===l&&(l=zt()),o[c]=d(a[c])):o[c]=a[c]}return n=e(...o),s=n,0!==l&&At(l),"string"===t?s?W(k,s):"":"boolean"===t?!!s:s})(e,t,n,a)},i.addFunction=xt,i.removeFunction=St,i.UTF8ToString=G,i.ALLOC_NORMAL=bt,i.allocate=wt,i.allocateUTF8OnStack=yt,i.preInit)for("function"==typeof i.preInit&&(i.preInit=[i.preInit]);0<i.preInit.length;)i.preInit.pop()();return function e(){function t(){var e;if(i.calledRun=!0,!M){var t,n;if(i.noFSInit||ye||(ye=!0,null!=a||(a=i.stdin),null!=t||(t=i.stdout),null!=n||(n=i.stderr),a?it("stdin",a):He("/dev/tty","/dev/stdin"),t?it("stdout",null,t):He("/dev/tty","/dev/stdout"),n?it("stderr",null,n):He("/dev/tty1","/dev/stderr"),Xe("/dev/stdin",0),Xe("/dev/stdout",1),Xe("/dev/stderr",1)),_t.N(),be=!1,null==(e=i.onRuntimeInitialized)||e.call(i),i.postRun)for("function"==typeof i.postRun&&(i.postRun=[i.postRun]);i.postRun.length;){var a=i.postRun.shift();F.unshift(a)}N(F)}}if(0<P)R=e;else{if(i.preRun)for("function"==typeof i.preRun&&(i.preRun=[i.preRun]);i.preRun.length;)j();N(B),0<P?R=e:i.setStatus?(i.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>i.setStatus(""),1),t()},1)):t()}}(),a}))},(lne=une).exports=dne,lne.exports.default=dne;const hne=ene(une.exports);class pne{constructor(e){oe(this,"logger"),oe(this,"wasmUrl"),this.logger=new sne({prefix:"[SQLiteReader]"}),this.wasmUrl=e||"https://sql.js.org/dist/sql-wasm.wasm"}async read(e,t){this.logger.info(`开始读取SQLite数据库 (格式: ${t.version})`);try{const t=new((await hne({locateFile:()=>this.wasmUrl})).Database)(e);try{const e=this.readModels(t),n=this.readDecks(t),i=this.readNotes(t),a=this.readMetadata(t,i.length);return this.logger.info(`数据读取完成: ${e.length} 个模型, ${n.length} 个牌组, ${i.length} 个笔记`),{models:e,decks:n,notes:i,metadata:a}}finally{t.close()}}catch(n){throw this.logger.error("SQLite读取失败",n),n}}readModels(e){const t=e.exec("SELECT models FROM col");if(!t.length||!t[0].values.length)throw new Error("数据库格式错误：col表为空");const n=t[0].values[0][0],i=JSON.parse(n),a=Object.values(i).map(e=>({id:e.id,name:e.name,type:e.type||0,flds:e.flds||[],tmpls:e.tmpls||[],css:e.css||"",sortf:e.sortf,latexPre:e.latexPre,latexPost:e.latexPost}));return this.logger.debug(`读取到 ${a.length} 个模型`),a}readDecks(e){const t=e.exec("SELECT decks FROM col");if(!t.length||!t[0].values.length)throw new Error("数据库格式错误：无法读取牌组");const n=t[0].values[0][0],i=JSON.parse(n),a=Object.values(i).filter(e=>1!==e.id).map(e=>({id:e.id,name:e.name,desc:e.desc||"",conf:e.conf,dyn:e.dyn}));return this.logger.debug(`读取到 ${a.length} 个牌组`),a}readNotes(e){const t=e.exec("SELECT id, mid, flds, tags, mod, guid, sfld FROM notes");if(!t.length)return this.logger.warn("未找到笔记数据"),[];const n=t[0].values.map(e=>({id:e[0],mid:e[1],flds:e[2],tags:e[3],mod:e[4],guid:e[5],sfld:e[6]}));return this.logger.debug(`读取到 ${n.length} 个笔记`),n}readMetadata(e,t){try{const n=e.exec("SELECT crt, mod, ver FROM col");if(n.length&&n[0].values.length){const e=n[0].values[0];return{created:1e3*e[0],modified:1e3*e[1],ankiVersion:String(e[2]||"unknown"),totalCards:0,totalNotes:t}}}catch(n){this.logger.warn("读取元数据失败",n)}return{created:Date.now(),modified:Date.now(),totalCards:0,totalNotes:t}}}class gne{constructor(){oe(this,"logger"),oe(this,"sqlReader"),this.logger=new sne({prefix:"[APKGParser]"}),this.sqlReader=new pne}async parse(e){var t;this.logger.info(`开始解析APKG文件: ${e.name}`);try{const n=await this.extractZip(e),i=this.detectFormat(n);if(this.logger.info(`检测到APKG格式: ${i.description}`),!i.supported)throw new Error(`不支持的APKG格式: ${i.description}`);const a=await(null==(t=n.file(i.dbFileName))?void 0:t.async("uint8array"));if(!a)throw new Error(`未找到数据库文件: ${i.dbFileName}`);const{models:r,decks:s,notes:o,metadata:l}=await this.sqlReader.read(a,i),c=await this.extractMedia(n);return this.logger.info(`解析完成: ${o.length} 个笔记, ${c.size} 个媒体文件`),{models:r,decks:s,notes:o,media:c,metadata:l}}catch(n){throw this.logger.error("APKG解析失败",n),n}}async extractZip(e){try{const t=await e.arrayBuffer(),n=await ine.loadAsync(t);return this.logger.debug(`ZIP解压成功，包含 ${Object.keys(n.files).length} 个文件`),n}catch(t){throw new Error(`ZIP解压失败: ${t.message}`)}}detectFormat(e){if(e.file("collection.anki21b"))return{version:"anki21b",dbFileName:"collection.anki21b",supported:!1,description:"Anki 2.1.50+ 最新格式 (已弃用，请使用旧版格式)",mediaFormat:"protobuf",compression:"zstd"};if(e.file("collection.anki21"))return{version:"anki21",dbFileName:"collection.anki21",supported:!0,description:"Anki 2.1.x Legacy 2 格式 (deflate压缩 + JSON)",mediaFormat:"json",compression:"deflate"};if(e.file("collection.anki2"))return{version:"anki2",dbFileName:"collection.anki2",supported:!0,description:"Anki 2.0.x Legacy 1 格式 (deflate压缩 + JSON)",mediaFormat:"json",compression:"deflate"};throw new Error("无法识别的APKG格式：未找到有效的数据库文件")}async extractMedia(e){const t=new Map,n=e.file("media");if(!n)return this.logger.warn("未找到媒体映射文件"),t;const i=await n.async("text"),a=JSON.parse(i);for(const[r,s]of Object.entries(a)){const n=e.file(r);if(n){const e=await n.async("uint8array");t.set(s,e),this.logger.debug(`提取媒体文件: ${s} (${e.length} bytes)`)}else this.logger.warn(`媒体文件缺失: ${s} (索引: ${r})`)}return t}}function vne(e){const t=new Set;if(!e||"string"!=typeof e)return t;const n=/\{\{([^}]+?)\}\}/g;let i;for(;null!==(i=n.exec(e));){let e=i[1].trim();fne(e)||(e=mne(e),0!==e.length&&t.add(e))}return t}function fne(e){if(["#","/","!","^"].some(t=>e.startsWith(t)))return!0;return["FrontSide","Card","Deck","Subdeck","CardFlag","Type"].includes(e)}function mne(e){const t=["cloze:","type:","hint:","text:","furigana:","kana:","kanji:"];for(const n of t)if(e.startsWith(n))return e.substring(n.length).trim();return e}function yne(e){const t={},n=e.tmpls[0];if(!n)return e.flds.forEach(e=>{t[e.name]="both"}),t;const i=vne(n.qfmt),a=vne(n.afmt);return e.flds.forEach(e=>{const n=function(e){const t=e.toLowerCase().trim(),n=["front","question","问题","题目","正面","问","q"],i=["back","answer","答案","背面","答","a","解答","解释"];for(const a of n)if(t===a||t.includes(a))return"front";for(const a of i)if(t===a||t.includes(a))return"back";return null}(e.name);if(n)return void(t[e.name]=n);const r=i.has(e.name),s=a.has(e.name);t[e.name]=r&&s?"both":r?"front":s?"back":"both"}),t}class bne{constructor(){oe(this,"logger"),this.logger=new sne({prefix:"[FieldSideResolver]"})}resolve(e){this.logger.info(`开始解析 ${e.length} 个模型的字段显示面`);const t={};for(const n of e){const e=yne(n);t[n.id]=e,this.logger.debug(`模型 "${n.name}" 字段配置:`,e)}return this.logger.info("字段显示面解析完成"),t}resolveSingle(e){return yne(e)}analyze(e){if(!e.tmpls||0===e.tmpls.length)return this.logger.warn(`模型 "${e.name}" 没有模板`),[];const t=e.tmpls[0],n=vne(t.qfmt),i=vne(t.afmt);return e.flds.map(e=>{const t=n.has(e.name),a=i.has(e.name);let r,s;return t&&a?(r="both",s="high"):t?(r="front",s="high"):a?(r="back",s="high"):(r="both",s="low",this.logger.warn(`字段 "${e.name}" 未在模板中使用，默认设为 both`)),{fieldName:e.name,side:r,appearsInFront:t,appearsInBack:a,confidence:s}})}}class wne{constructor(){oe(this,"logger"),oe(this,"mediaCounter",0),this.logger=new sne({prefix:"[ContentConverter]"})}convert(e){const t=Date.now();this.logger.debug(`开始转换HTML (长度: ${e.length})`),this.logger.debug(`原始HTML预览: ${e.substring(0,200)}...`),this.mediaCounter=0;const{html:n,mediaRefs:i}=this.extractMediaReferences(e);this.logger.debug(`[步骤1] 提取媒体: ${i.length} 个媒体文件`);let a=this.convertAnkiSyntax(n);this.logger.debug("[步骤2] 转换Anki语法完成"),a=this.convertBasicHTML(a),this.logger.debug("[步骤3] 转换基础HTML标签完成"),a=this.convertBlockquotes(a),this.logger.debug("[步骤4] 转换引用块完成"),a=this.convertLists(a),this.logger.debug("[步骤5] 转换列表完成"),a=this.convertTables(a),this.logger.debug("[步骤6] 转换表格完成"),a=this.convertHeadings(a),this.logger.debug("[步骤7] 转换标题完成"),a=this.cleanupMarkdown(a),this.logger.debug("[步骤8] 清理完成");const r=Date.now()-t;return this.logger.debug(`转换完成 (耗时: ${r}ms)`),this.logger.debug(`结果预览: ${a.substring(0,200)}...`),{markdown:a,mediaRefs:i}}replaceMediaPlaceholders(e,t,n){let i=e;for(const a of t){const e=n.get(a.originalName);if(e){const t=`![[${e}]]`,n=this.escapeRegExp(a.placeholder);i=i.replace(new RegExp(n,"g"),t),this.logger.debug(`替换媒体: ${a.placeholder} → ${t}`)}else this.logger.warn(`未找到媒体文件映射: ${a.originalName}`)}return i}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}extractMediaReferences(e){const t=[];let n=e;return n=n.replace(/<img[^>]+src=["']([^"']+)["'][^>]*>/gi,(e,n)=>{const i=this.extractFilename(n),a=`__MEDIA_${this.mediaCounter++}__`;return t.push({originalName:i,placeholder:a,type:"image"}),a}),n=n.replace(/\[sound:([^\]]+)\]/gi,(e,n)=>{const i=`__MEDIA_${this.mediaCounter++}__`;return t.push({originalName:n.trim(),placeholder:i,type:"audio"}),i}),n=n.replace(/<video[^>]+src=["']([^"']+)["'][^>]*>/gi,(e,n)=>{const i=this.extractFilename(n),a=`__MEDIA_${this.mediaCounter++}__`;return t.push({originalName:i,placeholder:a,type:"video"}),a}),{html:n,mediaRefs:t}}extractFilename(e){const t=e.split("?")[0].split("/");return t[t.length-1]}convertAnkiSyntax(e){let t=e;return t=t.replace(/\{\{c\d+::([^}]+)\}\}/g,"==$1=="),t=t.replace(/\{\{c\d+::([^:}]+)::[^}]+\}\}/g,"==$1=="),t}convertBasicHTML(e){let t=e;return t=t.replace(/<b>(.*?)<\/b>/gi,"**$1**"),t=t.replace(/<strong>(.*?)<\/strong>/gi,"**$1**"),t=t.replace(/<i>(.*?)<\/i>/gi,"*$1*"),t=t.replace(/<em>(.*?)<\/em>/gi,"*$1*"),t=t.replace(/<u>(.*?)<\/u>/gi,"**$1**"),t=t.replace(/<s>(.*?)<\/s>/gi,"~~$1~~"),t=t.replace(/<strike>(.*?)<\/strike>/gi,"~~$1~~"),t=t.replace(/<del>(.*?)<\/del>/gi,"~~$1~~"),t=t.replace(/<code>(.*?)<\/code>/gi,"`$1`"),t=t.replace(/<pre[^>]*>(.*?)<\/pre>/gis,(e,t)=>`\n\`\`\`\n${t.replace(/<\/?code[^>]*>/gi,"").trim()}\n\`\`\`\n`),t=t.replace(/<a\s+href=(["\']?)([^"'\s>]+)\1[^>]*>(.*?)<\/a>/gi,(e,t,n,i)=>`[${i.replace(/^\[/,"").replace(/\]$/,"")}](${n})`),t=t.replace(/<br\s*\/?>/gi,"\n"),t=t.replace(/<hr\s*\/?>/gi,"\n---\n"),t=t.replace(/<p[^>]*>/gi,"\n"),t=t.replace(/<\/p>/gi,"\n"),t=t.replace(/<div[^>]*>/gi,"\n"),t=t.replace(/<\/div>/gi,"\n"),t=t.replace(/<span[^>]*>/gi,""),t=t.replace(/<\/span>/gi,""),t=t.replace(/<font[^>]*>(.*?)<\/font>/gi,"$1"),t=t.replace(/<sup>(.*?)<\/sup>/gi,"^$1^"),t=t.replace(/<sub>(.*?)<\/sub>/gi,"~$1~"),t=t.replace(/<mark[^>]*>(.*?)<\/mark>/gi,"==$1=="),t=t.replace(/<center[^>]*>(.*?)<\/center>/gis,"$1"),t}convertBlockquotes(e){return e.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gis,(e,t)=>`${t.trim().split("\n").map(e=>`> ${e}`).join("\n")}\n`)}convertLists(e){let t=e;return t=t.replace(/<ol[^>]*>(.*?)<\/ol>/gis,(e,t)=>{let n=1;return`\n${t.replace(/<li[^>]*>(.*?)<\/li>/gis,(e,t)=>`${n++}. ${t.trim()}\n`)}\n`}),t=t.replace(/<ul[^>]*>(.*?)<\/ul>/gis,(e,t)=>`\n${t.replace(/<li[^>]*>(.*?)<\/li>/gis,(e,t)=>`- ${t.trim()}\n`)}\n`),t=t.replace(/<\/?li[^>]*>/gi,""),t}convertTables(e){return e.replace(/<table[^>]*>(.*?)<\/table>/gis,(e,t)=>{if(t.includes("<table"))return e;try{const n=t.match(/<thead[^>]*>(.*?)<\/thead>/is),i=t.match(/<tbody[^>]*>(.*?)<\/tbody>/is),a=[];if(n){const e=this.parseTableRow(n[1]);e&&a.push(e)}const r=(i?i[1]:t).matchAll(/<tr[^>]*>(.*?)<\/tr>/gis);for(const e of r){const t=this.parseTableRow(e[1]);t&&a.push(t)}if(0===a.length)return e;let s="\n";return a.forEach((e,t)=>{s+=`| ${e.join(" | ")} |\n`,0===t&&(s+=`| ${e.map(()=>"---").join(" | ")} |\n`)}),s+="\n",s}catch(n){return this.logger.warn("表格转换失败，保留HTML",n),e}})}parseTableRow(e){const t=[],n=e.matchAll(/<t[hd][^>]*>(.*?)<\/t[hd]>/gis);for(const i of n)t.push(i[1].trim());return t.length>0?t:null}convertHeadings(e){let t=e;for(let n=6;n>=1;n--){const e="#".repeat(n),i=new RegExp(`<h${n}[^>]*>(.*?)</h${n}>`,"gi");t=t.replace(i,`\n${e} $1\n`)}return t}cleanupMarkdown(e){let t=e;return t=t.replace(/<!--[\s\S]*?-->/g,""),t=this.decodeHTMLEntities(t),t=t.replace(/<[^>]+>/g,""),t=t.replace(/\n{3,}/g,"\n\n"),t=t.trim(),t}decodeHTMLEntities(e){const t={"&nbsp;":" ","&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&#39;":"'","&apos;":"'","&times;":"×","&divide;":"÷","&copy;":"©","&reg;":"®","&trade;":"™","&euro;":"€","&pound;":"£","&yen;":"¥","&cent;":"¢","&deg;":"°","&plusmn;":"±","&sup2;":"²","&sup3;":"³","&frac14;":"¼","&frac12;":"½","&frac34;":"¾"};let n=e;for(const[i,a]of Object.entries(t))n=n.replace(new RegExp(i,"g"),a);return n=n.replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(parseInt(t,10))),n=n.replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>String.fromCharCode(parseInt(t,16))),n}}class kne{constructor(e){oe(this,"logger"),oe(this,"storage"),this.logger=new sne({prefix:"[MediaProcessor]"}),this.storage=e}async process(e,t){this.logger.info(`开始处理 ${e.size} 个媒体文件`);const n=[],i=new Map,a=[];let r=0,s=0,o=0,l=0;try{const d=await this.storage.createDeckMediaFolder(t);this.logger.debug(`媒体文件夹创建: ${d}`);for(const[t,p]of e.entries())try{l+=p.length;const e=await this.storage.calculateHash(p),n=this.storage.generateObsidianPath(t,d);if(await this.storage.mediaFileExists(n)){this.logger.debug(`文件已存在，跳过: ${t}`),i.set(t,n),s++;continue}const o=await this.storage.saveMediaFile(t,p,d);i.set(t,o);const c={id:Gu(),originalName:t,savedPath:o,type:this.detectMediaType(t),size:p.length,hash:e,usedByCards:[],created:(new Date).toISOString()};a.push(c),r++,this.logger.debug(`保存成功: ${t} → ${o}`)}catch(c){o++;const e=`保存失败: ${t}`;this.logger.error(e,c),n.push({file:t,error:c instanceof Error?c.message:String(c),severity:"error",code:"SAVE_FAILED"})}const u={deckName:t,basePath:d,files:a,created:(new Date).toISOString(),version:1};await this.storage.saveManifest(u);const h={totalFiles:e.size,savedFiles:r,skippedFiles:s,failedFiles:o,totalSize:l};return this.logger.info(`媒体处理完成: 保存${r}, 跳过${s}, 失败${o}`),{success:0===o,savedFiles:i,manifest:u,errors:n,stats:h}}catch(c){return this.logger.error("媒体处理失败",c),{success:!1,savedFiles:i,manifest:{deckName:t,basePath:"",files:[],created:(new Date).toISOString(),version:1},errors:[{file:"all",error:c instanceof Error?c.message:String(c),severity:"error",code:"PROCESS_FAILED"}],stats:{totalFiles:e.size,savedFiles:r,skippedFiles:s,failedFiles:o,totalSize:l}}}}detectMediaType(e){var t;const n=(null==(t=e.split(".").pop())?void 0:t.toLowerCase())||"";if(["jpg","jpeg","png","gif","bmp","svg","webp"].includes(n))return"image";if(["mp3","wav","ogg","aac","m4a","flac"].includes(n))return"audio";return["mp4","webm","ogv","mov","avi","mkv"].includes(n)?"video":"image"}}class Sne{constructor(){oe(this,"logger"),oe(this,"converter"),this.logger=new sne({prefix:"[CardBuilder]"}),this.converter=new wne}build(e){const t=[];try{this.logger.debug(`构建卡片: 笔记${e.note.id}`);const n=this.parseFields(e.note,e.model),{frontFields:i,backFields:a,bothFields:r}=this.classifyFields(n,e.fieldSideMap),s=this.convertFields(i,e.mediaPathMap),o=this.convertFields(a,e.mediaPathMap),l=this.convertFields(r,e.mediaPathMap),c=this.assembleContent(s,o,l),d=this.createCard(c,e.deckId,e.templateId,e.note,e.model,n);return this.logger.debug(`卡片构建成功: ${d.uuid}`),{card:d,warnings:t,success:!0}}catch(n){return this.logger.error("卡片构建失败",n),{card:null,warnings:[`构建失败: ${n.message}`],success:!1}}}parseFields(e,t){const n=e.flds.split(""),i={};return t.flds.forEach((e,t)=>{const a=n[t]||"";a.trim()&&(i[e.name]=a)}),i}classifyFields(e,t){const n={},i={},a={};for(const[r,s]of Object.entries(e)){const e=t[r]||"both";"front"===e?n[r]=s:"back"===e?i[r]=s:a[r]=s}return{frontFields:n,backFields:i,bothFields:a}}convertFields(e,t){const n=[];for(const[i,a]of Object.entries(e)){const e=this.converter.convert(a),i=this.converter.replaceMediaPlaceholders(e.markdown,e.mediaRefs,t);n.push(i)}return n}assembleContent(e,t,n){const i=[],a=[];e.length>0&&a.push(e.join("\n\n")),n.length>0&&a.push(n.join("\n\n"));const r=[];return t.length>0&&r.push(t.join("\n\n")),n.length>0&&0===e.length&&r.push(n.join("\n\n")),a.length>0&&r.length>0?(i.push(a.join("\n\n")),i.push("---div---"),i.push(r.join("\n\n"))):a.length>0?i.push(a.join("\n\n")):r.length>0&&i.push(r.join("\n\n")),i.join("\n\n").trim()}createCard(e,t,n,i,a,r){const s=Date.now(),o=i.tags?i.tags.split(" ").filter(e=>e.trim()):[],l=1===a.type?Kr.Cloze:Kr.Basic;return this.extractFieldsMap(e,r),{uuid:Vu(),deckId:t,templateId:n||"unknown",content:e,type:l,tags:o,created:s.toString(),modified:s.toString(),fsrs:{state:0,difficulty:0,stability:0,due:s.toString(),elapsedDays:0,scheduledDays:0,reps:0,lapses:0,lastReview:void 0,retrievability:0},reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},customFields:{importedFrom:"apkg",importedAt:(new Date).toISOString()}}}extractFieldsMap(e,t){const n={},i=e.indexOf("---div---");if(-1===i){const t=this.stripFieldNamePrefix(e.trim());t&&(n.front=t)}else if(0===i){const t=e.substring(9).trim(),i=this.stripFieldNamePrefix(t);i&&(n.front=i)}else{const t=e.substring(0,i).trim(),a=e.substring(i+9).trim(),r=this.stripFieldNamePrefix(t);r&&(n.front=r);const s=this.stripFieldNamePrefix(a);s&&(n.back=s)}return n}stripFieldNamePrefix(e){if(!e||!e.trim())return"";const t=[/^\*\*([^*]+)\*\*:\s*/,/^\*\*([^*]+)\*\*:/,/^\*([^*]+)\*:\s*/,/^([^:]+):\s+/];return e.split(/\n\n+/).map(e=>{let n=e.trim();if(!n)return"";for(const i of t){if(n.match(i)){n=n.replace(i,"");break}}return n}).filter(e=>e.length>0).join("\n\n")}}let xne=class{constructor(){oe(this,"logger"),this.logger=new sne({prefix:"[AnkiTemplateConverter]"})}convertModelToTemplate(e,t){this.logger.info(`转换Anki模型: ${e.name} (ID: ${e.id})`);const n=e.flds.map(e=>({name:e.name,pattern:"",isRegex:!1,required:!1,type:"field",side:t[e.name]||"both",key:e.name.toLowerCase().replace(/\s+/g,"_"),description:e.description||`${e.name} 字段`}));this.logger.debug(`转换了 ${n.length} 个字段:`,n.map(e=>`${e.name}(${e.side})`).join(", "));const i={id:`anki-import-${e.id}-${Date.now()}`,name:`【Anki】${e.name}`,description:`从APKG导入的Anki模板\n原始Model ID: ${e.id}\n字段数量: ${e.flds.length}`,type:"single-field",fields:n,scenarios:["study","edit"],isOfficial:!1,isDefault:!1,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),tuankiMetadata:{signature:`anki-model-${e.id}`,version:"1.0.0",ankiCompatible:!0,source:"anki_imported",createdInTuanki:!1,editedInTuanki:!1},ankiImportMetadata:{originalAnkiModelId:e.id.toString(),originalAnkiModelName:e.name,ankiModelType:1===e.type?"cloze":"standard",ankiTemplates:e.tmpls,ankiCSS:e.css,ankiFieldCount:e.flds.length,importedAt:(new Date).toISOString(),source:"APKG Import"}};return this.logger.info(`成功创建模板: ${i.name}`),i}findExistingTemplate(e,t){const n=t.find(t=>{var n;return(null==(n=t.ankiImportMetadata)?void 0:n.originalAnkiModelId)===e.toString()});return n&&this.logger.info(`找到已存在的模板: ${n.name} (Model ID: ${e})`),n||null}convertModels(e,t,n=[]){this.logger.info(`开始批量转换 ${e.length} 个Anki模型`);const i=[];for(const a of e){if(this.findExistingTemplate(a.id,n)){this.logger.debug(`跳过已存在的模板: ${a.name}`);continue}const e=t[a.id]||{},r=this.convertModelToTemplate(a,e);i.push(r)}return this.logger.info(`批量转换完成: 新创建 ${i.length} 个模板`),i}validateTemplate(e){var t;return e.id&&e.name?e.fields&&0!==e.fields.length?!!(null==(t=e.tuankiMetadata)?void 0:t.source)||(this.logger.error(`模板 "${e.name}" 缺少来源标识`),!1):(this.logger.error(`模板 "${e.name}" 没有字段定义`),!1):(this.logger.error("模板缺少必需字段: id 或 name"),!1)}};class _ne{constructor(e,t){oe(this,"logger"),oe(this,"parser"),oe(this,"fieldResolver"),oe(this,"contentConverter"),oe(this,"mediaProcessor"),oe(this,"cardBuilder"),oe(this,"templateConverter"),oe(this,"dataStorage"),oe(this,"progressCallback"),this.logger=new sne({prefix:"[APKGImportService]"}),this.parser=new gne,this.fieldResolver=new bne,this.contentConverter=new wne,this.mediaProcessor=new kne(t),this.cardBuilder=new Sne,this.templateConverter=new xne,this.dataStorage=e}async import(e,t,n){var i;const a=Date.now();this.progressCallback=n;const r=[],s=[],o={totalCards:0,importedCards:0,skippedCards:0,failedCards:0,mediaFiles:0,mediaTotalSize:0};try{this.logger.info(`开始导入APKG: ${e.file.name}`),this.updateProgress("parsing",10,"正在解析APKG文件...");const n=await this.parser.parse(e.file);o.totalCards=n.notes.length,this.updateProgress("analyzing",30,"正在分析字段配置...");const l=this.fieldResolver.resolve(n.models);this.updateProgress("analyzing",40,"正在创建模板...");const c=await this.createTemplates(n.models,l,t);this.updateProgress("media",50,"正在处理媒体文件...");const d=e.targetDeckName||(null==(i=n.decks[0])?void 0:i.name)||"导入牌组",u=await this.mediaProcessor.process(n.media,d);o.mediaFiles=u.stats.savedFiles,o.mediaTotalSize=u.stats.totalSize,u.errors.length>0&&s.push(...u.errors.map(e=>e.error)),this.updateProgress("building",60,"正在创建牌组...");const h=await this.getOrCreateDeck(d);this.updateProgress("building",70,"正在构建卡片...",{totalItems:n.notes.length,completedItems:0});const p=[];for(let t=0;t<n.notes.length;t++){const i=n.notes[t],a=n.models.find(e=>e.id===i.mid);if(!a){r.push({noteId:i.id,stage:"building",message:`未找到模型: ${i.mid}`,code:"MODEL_NOT_FOUND"}),o.failedCards++;continue}const s=c.get(a.id),d=this.cardBuilder.build({note:i,model:a,deckId:h.id,templateId:null==s?void 0:s.id,fieldSideMap:l[a.id],mediaPathMap:u.savedFiles,conversionConfig:e.conversion});d.success&&d.card?(p.push(d.card),o.importedCards++):(o.failedCards++,r.push({noteId:i.id,stage:"building",message:d.warnings.join("; "),code:"BUILD_FAILED"})),t%10==0&&this.updateProgress("building",70+t/n.notes.length*15,"正在构建卡片...",{totalItems:n.notes.length,completedItems:t})}this.updateProgress("saving",90,"正在保存数据..."),await this.dataStorage.createCards(p),await this.dataStorage.saveAll(),this.updateProgress("saving",100,"导入完成！");const g=Date.now()-a;return this.logger.info(`导入完成: ${o.importedCards}/${o.totalCards} 张卡片, 耗时 ${g}ms`),{success:0===r.length,deckId:h.id,deckName:h.name,stats:o,errors:r,warnings:s,duration:g}}catch(l){return this.logger.error("导入失败",l),r.push({stage:"parsing",message:l instanceof Error?l.message:String(l),code:"IMPORT_FAILED",stack:l instanceof Error?l.stack:void 0}),{success:!1,stats:o,errors:r,warnings:s,duration:Date.now()-a}}}async getOrCreateDeck(e){let t=await this.dataStorage.getDeckByName(e);return t?this.logger.info(`使用已存在牌组: ${t.name} (${t.id})`):(t={id:Gu(),name:e,description:"从 APKG文件导入的牌组",category:"",path:e,level:0,order:0,inheritSettings:!1,settings:{},stats:{},includeSubdecks:!1,created:(new Date).toISOString(),modified:(new Date).toISOString(),tags:[],metadata:{source:"apkg_import",importedAt:(new Date).toISOString()}},await this.dataStorage.createDeck(t),this.logger.info(`创建新牌组: ${t.name} (${t.id})`)),t}updateProgress(e,t,n,i){this.progressCallback&&this.progressCallback({stage:e,progress:t,message:n,detail:null==i?void 0:i.currentItem,totalItems:null==i?void 0:i.totalItems,completedItems:null==i?void 0:i.completedItems})}async createTemplates(e,t,n){const i=new Map,a=n.settings.simplifiedParsing;this.logger.info(`开始为 ${e.length} 个Anki模型创建模板`);for(const r of e){const e=this.templateConverter.findExistingTemplate(r.id,a.templates);if(e){this.logger.info(`复用已存在模板: ${e.name} (Model ID: ${r.id})`),i.set(r.id,e);continue}const s=this.templateConverter.convertModelToTemplate(r,t[r.id]);a.templates.push(s),await n.saveSettings(),this.logger.info(`创建新模板: ${s.name} (Model ID: ${r.id})`),i.set(r.id,s)}return this.logger.info(`模板创建完成: ${i.size} 个模板`),i}}class Cne{constructor(e){oe(this,"logger"),oe(this,"plugin"),oe(this,"baseMediaPath"),this.logger=new sne({prefix:"[ObsidianMediaStorage]"}),this.plugin=e,this.baseMediaPath=ps()}async createDeckMediaFolder(e){const t=this.sanitizeFilename(e),n=`${this.baseMediaPath}/[APKG] ${t}`;return await this.ensureFolder(n),this.logger.debug(`创建牌组媒体文件夹: ${n}`),n}async saveMediaFile(e,t,n){const i=`${n}/${this.sanitizeFilename(e)}`,a=await this.getUniqueFilePath(i);try{const n=new ArrayBuffer(t.byteLength);return new Uint8Array(n).set(t),await this.plugin.app.vault.createBinary(a,n),this.logger.debug(`保存媒体文件: ${e} → ${a}`),a}catch(r){if(r instanceof Error&&r.message.includes("already exists")){this.logger.debug(`文件已存在，尝试生成新的唯一路径: ${a}`);const n=await this.getUniqueFilePath(i),r=new ArrayBuffer(t.byteLength);return new Uint8Array(r).set(t),await this.plugin.app.vault.createBinary(n,r),this.logger.debug(`重试保存成功: ${e} → ${n}`),n}throw r}}async calculateHash(e){const t=new ArrayBuffer(e.byteLength);new Uint8Array(t).set(e);const n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}async mediaFileExists(e){return null!==this.plugin.app.vault.getAbstractFileByPath(e)}async deleteMediaFile(e){const t=this.plugin.app.vault.getAbstractFileByPath(e);t&&t instanceof this.plugin.app.vault.adapter.constructor&&(await this.plugin.app.vault.delete(t),this.logger.debug(`删除媒体文件: ${e}`))}async loadManifest(e){const t=`${e}/.manifest.json`;try{const e=this.plugin.app.vault.getAbstractFileByPath(t);if(!e)return null;const n=await this.plugin.app.vault.read(e);return JSON.parse(n)}catch(n){return this.logger.error("读取媒体清单失败:",n),null}}generateObsidianPath(e,t){return`${t}/${this.sanitizeFilename(e)}`}async saveManifest(e){const t=`${e.basePath}/.manifest.json`,n=JSON.stringify(e,null,2);try{const e=this.plugin.app.vault.getAbstractFileByPath(t);e?(await this.plugin.app.vault.modify(e,n),this.logger.debug(`更新媒体清单: ${t}`)):(await this.plugin.app.vault.create(t,n),this.logger.debug(`创建媒体清单: ${t}`))}catch(i){if(!(i instanceof Error&&i.message.includes("already exists")))throw i;{this.logger.debug(`清单文件已存在，尝试修改: ${t}`);const e=this.plugin.app.vault.getAbstractFileByPath(t);e&&(await this.plugin.app.vault.modify(e,n),this.logger.debug(`重试修改清单成功: ${t}`))}}}async ensureFolder(e){var t;const n=e.split("/");let i="";for(const r of n){i=i?`${i}/${r}`:r;if(!this.plugin.app.vault.getAbstractFileByPath(i))try{await this.plugin.app.vault.createFolder(i)}catch(a){if(!(null==(t=a.message)?void 0:t.includes("already exists")))throw a}}}sanitizeFilename(e){return e.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,"")}async getUniqueFilePath(e){let t=e;if(!(await this.mediaFileExists(t)))return t;const n=Date.now(),i=Math.floor(1e3*Math.random()),a=e.lastIndexOf(".");if(a>0){t=`${e.substring(0,a)}_${n}_${i}${e.substring(a)}`}else t=`${e}_${n}_${i}`;if(!(await this.mediaFileExists(t)))return t;let r=1;for(;r<=1e3;){if(a>0){t=`${e.substring(0,a)}_${n}_${i}_${r}${e.substring(a)}`}else t=`${e}_${n}_${i}_${r}`;if(!(await this.mediaFileExists(t)))return t;r++}throw new Error(`无法生成唯一文件路径: ${e}`)}}class Ine{constructor(e){oe(this,"logger"),oe(this,"storage"),this.logger=new sne({prefix:"[WeaveDataStorage]"}),this.storage=e}async getDecks(){try{return await this.storage.getDecks()}catch(e){return this.logger.error("获取牌组列表失败",e),[]}}async getDeckById(e){try{return(await this.storage.getDecks()).find(t=>t.id===e)||null}catch(t){return this.logger.error(`获取牌组失败: ${e}`,t),null}}async getDeckByName(e){try{return(await this.storage.getDecks()).find(t=>t.name===e)||null}catch(t){return this.logger.error(`获取牌组失败: ${e}`,t),null}}async createDeck(e){try{await this.storage.saveDeck(e),this.logger.info(`创建牌组: ${e.name} (${e.id})`)}catch(t){throw this.logger.error("创建牌组失败",t),t}}async updateDeck(e){try{await this.storage.saveDeck(e),this.logger.debug(`更新牌组: ${e.id}`)}catch(t){throw this.logger.error("更新牌组失败",t),t}}async deleteDeck(e){try{await this.storage.deleteDeck(e),this.logger.info(`删除牌组: ${e}`)}catch(t){throw this.logger.error("删除牌组失败",t),t}}async getCardsByDeck(e){try{return await this.storage.getCardsByDeck(e)}catch(t){return this.logger.error(`获取卡片列表失败: ${e}`,t),[]}}async getCardById(e){try{return await this.storage.getCard(e)}catch(t){return this.logger.error(`获取卡片失败: ${e}`,t),null}}async createCard(e){try{await this.storage.saveCard(e),this.logger.debug(`创建卡片: ${e.id}`)}catch(t){throw this.logger.error("创建卡片失败",t),t}}async createCards(e){try{for(const t of e)await this.storage.saveCard(t);this.logger.info(`批量创建卡片: ${e.length} 张`)}catch(t){throw this.logger.error("批量创建卡片失败",t),t}}async updateCard(e){try{await this.storage.saveCard(e),this.logger.debug(`更新卡片: ${e.id}`)}catch(t){throw this.logger.error("更新卡片失败",t),t}}async deleteCard(e){try{await this.storage.deleteCard(e),this.logger.debug(`删除卡片: ${e}`)}catch(t){throw this.logger.error("删除卡片失败",t),t}}async saveAll(){try{this.logger.debug("保存所有更改")}catch(e){throw this.logger.error("保存失败",e),e}}}const Dne=class e{constructor(){oe(this,"currentTheme"),oe(this,"listeners",[]),oe(this,"mediaQuery"),oe(this,"domObserver"),oe(this,"isInitialized",!1),this.currentTheme=this.detectTheme(),this.mediaQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.domObserver=new MutationObserver(()=>this.handleThemeChange()),this.initialize()}static getInstance(){return e.instance||(e.instance=new e),e.instance}initialize(){this.isInitialized||(this.mediaQuery.addEventListener("change",()=>this.handleThemeChange()),this.domObserver.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),this.domObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]}),this.isInitialized=!0)}detectTheme(){if(document.documentElement.classList.contains("theme-dark"))return{mode:"dark",isDark:!0,source:"obsidian-class",confidence:"high"};if(document.documentElement.classList.contains("theme-light"))return{mode:"light",isDark:!1,source:"obsidian-class",confidence:"high"};if(document.body.classList.contains("theme-dark"))return{mode:"dark",isDark:!0,source:"obsidian-class",confidence:"medium"};if(document.body.classList.contains("theme-light"))return{mode:"light",isDark:!1,source:"obsidian-class",confidence:"medium"};return{mode:"auto",isDark:this.mediaQuery.matches,source:"system-preference",confidence:"medium"}}handleThemeChange(){const e=this.detectTheme();if(this.hasThemeChanged(this.currentTheme,e)){const t=this.currentTheme;this.currentTheme=e,_e.debug("[ThemeManager] 主题变化:",{from:t,to:e}),this.listeners.forEach(t=>{try{t(e)}catch(n){_e.error("[ThemeManager] 监听器执行失败:",n)}})}}hasThemeChanged(e,t){return e.isDark!==t.isDark||e.mode!==t.mode||e.source!==t.source}getCurrentTheme(){return{...this.currentTheme}}isDarkMode(){return this.currentTheme.isDark}addListener(e){this.listeners.push(e);try{e(this.currentTheme)}catch(t){_e.error("[ThemeManager] 初始监听器调用失败:",t)}return()=>{const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}}destroy(){this.mediaQuery.removeEventListener("change",()=>this.handleThemeChange()),this.domObserver.disconnect(),this.listeners.length=0,this.isInitialized=!1}};oe(Dne,"instance");let Tne=Dne;function Mne(e){const t=Tne.getInstance(),n=()=>{!function(e){e.classList.remove("theme-dark","theme-light"),e.classList.remove("theme-source-obsidian-class","theme-source-system-preference","theme-source-fallback"),e.classList.remove("theme-confidence-high","theme-confidence-medium","theme-confidence-low")}(e);const t=function(){const e=Tne.getInstance().getCurrentTheme(),t=[];return e.isDark?t.push("theme-dark"):t.push("theme-light"),t.push(`theme-source-${e.source}`),t.push(`theme-confidence-${e.confidence}`),t}();e.classList.add(...t)};n();return t.addListener(()=>{n()})}async function Ane(e,t,n,i){var a;const r=null==(a=e.target.files)?void 0:a[0];if(r){if(!r.name.toLowerCase().endsWith(".apkg"))return void alert("请选择 .apkg 文件");$n(t,r,!0),$n(n,null),await i()}}function Ene(e,t){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())}var zne=(e,t)=>"Escape"===e.key&&t(),Pne=e=>e.stopPropagation(),Rne=e=>e.stopPropagation(),$ne=la('<div class="apkg-stage apkg-selection svelte-1ayff6e"><div role="button" tabindex="0"><!> <h3 class="dropzone-title svelte-1ayff6e">选择或拖拽 APKG 文件</h3> <p class="dropzone-hint svelte-1ayff6e">支持 Anki 标准导出格式</p></div> <input type="file" accept=".apkg" style="display: none"/></div>'),One=la('<div class="apkg-stage apkg-importing svelte-1ayff6e"><div class="progress-container svelte-1ayff6e"><div class="tuanki-spinner" style="width: 48px; height: 48px;"></div> <h3 class="progress-title svelte-1ayff6e"> </h3> <div class="tuanki-progress svelte-1ayff6e"><div class="tuanki-progress-fill svelte-1ayff6e"></div></div> <p class="progress-message svelte-1ayff6e"> </p></div></div>'),Lne=la('<div class="detail-item mod-warning svelte-1ayff6e"><span class="detail-label svelte-1ayff6e">失败：</span> <span class="detail-value svelte-1ayff6e"> </span></div>'),Nne=la('<div class="tuanki-card tuanki-card--flat result-details svelte-1ayff6e"><div class="detail-item svelte-1ayff6e"><span class="detail-label svelte-1ayff6e">牌组：</span> <span class="detail-value svelte-1ayff6e"> </span></div> <div class="detail-item svelte-1ayff6e"><span class="detail-label svelte-1ayff6e">成功导入：</span> <span class="detail-value svelte-1ayff6e"> </span></div> <!></div>'),Fne=la('<div class="failed-card svelte-1ayff6e"><div class="failed-header svelte-1ayff6e"><span class="failed-id svelte-1ayff6e"> </span> <span class="failed-model svelte-1ayff6e"> </span></div> <div class="failed-reason svelte-1ayff6e"> </div></div>'),Bne=la('<details class="tuanki-collapsible svelte-1ayff6e"><summary class="tuanki-collapsible-trigger svelte-1ayff6e"><!> <span> </span> <!></summary> <div class="tuanki-collapsible-content svelte-1ayff6e"></div></details>'),jne=la('<div class="result-success svelte-1ayff6e"><div class="result-icon svelte-1ayff6e"><!></div> <h3 class="result-title svelte-1ayff6e">导入成功</h3> <p class="result-message svelte-1ayff6e"> </p> <!> <!></div>'),Une=la('<div class="result-error svelte-1ayff6e"><div class="result-icon svelte-1ayff6e"><!></div> <h3 class="result-title svelte-1ayff6e">导入失败</h3> <p class="result-message svelte-1ayff6e"> </p></div>'),Vne=la('<div class="apkg-stage apkg-result svelte-1ayff6e"><!></div>'),qne=la('<div class="tuanki-modal-footer"><div class="tuanki-modal-footer-actions"><button class="tuanki-btn tuanki-btn--primary tuanki-btn--md">关闭</button></div></div>'),Hne=la('<div class="tuanki-modal-overlay" role="presentation" tabindex="-1"><div class="tuanki-modal-content large" role="dialog" aria-modal="true" aria-labelledby="apkg-modal-title" tabindex="0"><div class="tuanki-modal-header"><div class="tuanki-modal-title" id="apkg-modal-title"><!> <span>导入 APKG 文件</span></div> <button class="tuanki-modal-close" aria-label="关闭"><!></button></div> <div class="tuanki-modal-body"><!></div> <!></div></div>');function Wne(e,t){if(new.target)return Er({component:Wne,...e});kt(t,!0);let n=Ar(t,"show",7),i=Ar(t,"dataStorage",7),a=Ar(t,"wasmUrl",7),r=Ar(t,"plugin",7),s=Ar(t,"onClose",7),o=Ar(t,"onImportComplete",7),l=Pn("selection"),c=Pn(null),d=Pn(null),u=Pn(Ot({stage:"parsing",progress:0,message:""})),h=Pn(!1),p=Pn(Ot(Tne.getInstance().isDarkMode())),g=null,v=Pn(!1);Ot({});let f=Pn(void 0);function m(){var e;null==(e=bi(f))||e.click()}async function y(e){var t;e.preventDefault(),$n(v,!1);const n=null==(t=e.dataTransfer)?void 0:t.files;if(n&&n.length>0){const e=n[0];e.name.toLowerCase().endsWith(".apkg")?($n(c,e,!0),$n(d,null),await k()):alert("请选择 .apkg 文件")}}function b(e){e.preventDefault(),$n(v,!0)}function w(e){e.preventDefault(),$n(v,!1)}async function k(){if(bi(c)){$n(h,!0),$n(d,null),$n(l,"importing");try{const e=new Ine(r().dataStorage),t=new Cne(r()),n=new _ne(e,t),i={file:bi(c),conversion:{preserveComplexTables:!0,convertSimpleTables:!0,mediaFormat:"wikilink",clozeFormat:"==",preserveStyles:!1,tableComplexityThreshold:{maxColumns:10,maxRows:20,allowMergedCells:!1}},skipExisting:!1,createDeckIfNotExist:!0},a=await n.import(i,r(),e=>{$n(u,e,!0)});$n(d,a,!0),$n(l,"result"),a.success&&o()(bi(d))}catch(e){$n(d,{success:!1,stats:{totalCards:0,importedCards:0,skippedCards:0,failedCards:0,mediaFiles:0,mediaTotalSize:0},errors:[{stage:"parsing",message:e instanceof Error?e.message:"导入失败",code:"UNKNOWN_ERROR"}],warnings:[],duration:0},!0),$n(l,"result")}finally{$n(h,!1)}}}function S(){$n(c,null),$n(d,null),$n(u,{stage:"parsing",progress:0,message:""},!0),$n(l,"selection"),"function"==typeof s()&&s()()}Pr(()=>{var e;e=e=>{$n(p,e,!0)},g=Tne.getInstance().addListener(t=>{e(t.isDark)})}),Rr(()=>{g&&g()});var x={get show(){return n()},set show(e){n(e),hn()},get dataStorage(){return i()},set dataStorage(e){i(e),hn()},get wasmUrl(){return a()},set wasmUrl(e){a(e),hn()},get plugin(){return r()},set plugin(e){r(e),hn()},get onClose(){return s()},set onClose(e){s(e),hn()},get onImportComplete(){return o()},set onImportComplete(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},_=ha(),C=Qt(_),I=e=>{var t=Hne();t.__click=S,t.__keydown=[zne,S];var n=Gt(t);n.__click=[Pne],n.__keydown=[Rne];var i=Gt(n),a=Gt(i);Ng(Gt(a),{name:"package",size:24}),Pt(2),zt(a);var r=Kt(a,2);r.__click=S,Ng(Gt(r),{name:"x",size:20}),zt(r),zt(i);var s=Kt(i,2),o=Gt(s),h=e=>{var t=$ne(),n=Gt(t);let i;n.__click=m,n.__keydown=[Ene,m],Ng(Gt(n),{name:"upload",size:56}),Pt(4),zt(n);var a=Kt(n,2);a.__change=[Ane,c,d,k],kr(a,e=>$n(f,e),()=>bi(f)),zt(t),zi(e=>i=Fa(n,1,"tuanki-card tuanki-glass dropzone svelte-1ayff6e",null,i,e),[()=>({"is-dragover":bi(v)})]),na("dragover",n,b),na("dragleave",n,w),na("drop",n,y),pa(e,t)},p=e=>{var t=ha(),n=Qt(t),i=e=>{var t=One(),n=Gt(t),i=Kt(Gt(n),2),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r);zt(r);var o=Kt(r,2),l=Gt(o,!0);zt(o),zt(n),zt(t),zi(()=>{var e;va(a,bi(u).stage||"正在导入..."),ja(s,`width: ${null!=(e=bi(u).progress)?e:""}%`),va(l,bi(u).message)}),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=Vne(),n=Gt(t),i=e=>{var t=jne(),n=Gt(t);Ng(Gt(n),{name:"check-circle",size:56,color:"var(--tuanki-success)"}),zt(n);var i=Kt(n,4),a=Gt(i);zt(i);var r=Kt(i,2),s=e=>{var t=Nne(),n=Gt(t),i=Kt(Gt(n),2),a=Gt(i,!0);zt(i),zt(n);var r=Kt(n,2),s=Kt(Gt(r),2),o=Gt(s);zt(s),zt(r);var l=Kt(r,2),c=e=>{var t=Lne(),n=Kt(Gt(t),2),i=Gt(n);zt(n),zt(t),zi(()=>{var e;return va(i,`${null!=(e=bi(d).stats.failedCards)?e:""} 张`)}),pa(e,t)};xa(l,e=>{bi(d).stats.failedCards>0&&e(c)}),zt(t),zi(()=>{var e;va(a,bi(d).deckName),va(o,`${null!=(e=bi(d).stats.importedCards)?e:""} 张`)}),pa(e,t)};xa(r,e=>{bi(d).deckName&&e(s)});var o=Kt(r,2),l=e=>{var t=Bne(),n=Gt(t),i=Gt(n);Ng(i,{name:"alert-triangle",size:16});var a=Kt(i,2),r=Gt(a);zt(a),Ng(Kt(a,2),{name:"chevron-down",size:16,class:"chevron"}),zt(n);var s=Kt(n,2);Ca(s,21,()=>bi(d).errors,_a,(e,t)=>{var n=Fne(),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var s=Kt(a,2),o=Gt(s,!0);zt(s),zt(i);var l=Kt(i,2),c=Gt(l,!0);zt(l),zt(n),zi(()=>{va(r,bi(t).stage),va(o,bi(t).code),va(c,bi(t).message)}),pa(e,n)}),zt(s),zt(t),zi(()=>{var e;return va(r,`查看错误信息 (${null!=(e=bi(d).errors.length)?e:""})`)}),pa(e,t)};xa(o,e=>{bi(d).errors&&bi(d).errors.length>0&&e(l)}),zt(t),zi(()=>{var e;return va(a,`成功导入 ${null!=(e=bi(d).stats.importedCards)?e:""} 张卡片`)}),pa(e,t)},a=e=>{var t=Une(),n=Gt(t);Ng(Gt(n),{name:"alert-circle",size:56,color:"var(--tuanki-error)"}),zt(n);var i=Kt(n,4),a=Gt(i,!0);zt(i),zt(t),zi(()=>{var e,t,n;return va(a,(null==(n=null==(t=null==(e=bi(d))?void 0:e.errors)?void 0:t[0])?void 0:n.message)||"未知错误")}),pa(e,t)};xa(n,e=>{var t;(null==(t=bi(d))?void 0:t.success)?e(i):e(a,!1)}),zt(t),pa(e,t)};xa(n,e=>{"result"===bi(l)&&e(i)},!0),pa(e,t)};xa(n,e=>{"importing"===bi(l)?e(i):e(a,!1)},!0),pa(e,t)};xa(o,e=>{"selection"===bi(l)?e(h):e(p,!1)}),zt(s);var g=Kt(s,2),x=e=>{var t=qne(),n=Gt(t);Gt(n).__click=S,zt(n),zt(t),pa(e,t)};xa(g,e=>{"result"===bi(l)&&e(x)}),zt(n),zt(t),pa(e,t)};return xa(C,e=>{n()&&e(I)}),pa(e,_),St(x)}ia(["click","keydown","change"]);var Gne=(e,t)=>{e.currentTarget===e.target&&t()},Qne=(e,t)=>{"Escape"===e.key&&t()},Kne=(e,t)=>t(null),Zne=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t(null))},Yne=la('<div class="mdc-deck-check svelte-11xpj20"><!></div>'),Xne=la('<div class="mdc-empty svelte-11xpj20"><!> <p class="svelte-11xpj20">没有找到可选的目标牌组</p></div>'),Jne=(e,t,n)=>t(bi(n).node.deck.id),eie=(e,t,n)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t(bi(n).node.deck.id))},tie=(e,t,n)=>{e.stopPropagation(),t(bi(n).node.deck.id)},nie=la('<button class="expand-toggle svelte-11xpj20"><!></button>'),iie=la('<span class="expand-spacer svelte-11xpj20"></span>'),aie=la('<div class="mdc-deck-desc svelte-11xpj20"> </div>'),rie=la('<div class="mdc-deck-check svelte-11xpj20"><!></div>'),sie=la('<div role="button" tabindex="0"><!> <div class="mdc-deck-icon svelte-11xpj20"><!></div> <div class="mdc-deck-info svelte-11xpj20"><div class="mdc-deck-name svelte-11xpj20"> </div> <!></div> <!></div>'),oie=la(" <!>",1),lie=la('<div class="mdc-overlay svelte-11xpj20" role="button" tabindex="0"><div class="mdc-modal svelte-11xpj20" role="dialog" aria-labelledby="mdc-title"><header class="mdc-header svelte-11xpj20"><h2 id="mdc-title" class="svelte-11xpj20"> </h2> <!></header> <main class="mdc-main svelte-11xpj20"><div class="mdc-info svelte-11xpj20"><!> <div class="mdc-info-content svelte-11xpj20"><span> </span></div></div> <div class="mdc-search svelte-11xpj20"><!> <input type="text" class="svelte-11xpj20"/></div> <div class="mdc-target-section svelte-11xpj20"><h3 class="svelte-11xpj20"> </h3> <div role="button" tabindex="0"><div class="mdc-deck-icon svelte-11xpj20"><!></div> <div class="mdc-deck-info svelte-11xpj20"><div class="mdc-deck-name svelte-11xpj20"> </div> <div class="mdc-deck-desc svelte-11xpj20"> </div></div> <!></div> <div class="mdc-deck-list svelte-11xpj20"><!></div></div></main> <footer class="mdc-footer svelte-11xpj20"><!> <!></footer></div></div>');function cie(e,t){if(new.target)return Er({component:cie,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"open",7),s=Ar(t,"currentDeck",7),o=Ar(t,"deckTree",7),l=Ar(t,"onconfirm",7),c=Ar(t,"oncancel",7),d=In(n),u=Pn(null),h=Pn(""),p=Pn(Ot(new Set)),g=In(()=>{const e=new Set;return function t(n,i){e.add(n);const a=f(n,i);(null==a?void 0:a.children)&&a.children.forEach(e=>t(e.deck.id,i))}(s().id,o()),function(e){const t=[];function n(e){for(const i of e)t.push(i),i.children&&n(i.children)}return n(e),t}(o()).filter(t=>!e.has(t.deck.id))}),v=In(()=>{if(!bi(h).trim())return bi(g);const e=bi(h).toLowerCase();return bi(g).filter(t=>{var n;return t.deck.name.toLowerCase().includes(e)||(null==(n=t.deck.description)?void 0:n.toLowerCase().includes(e))})});function f(e,t){for(const n of t){if(n.deck.id===e)return n;if(n.children){const t=f(e,n.children);if(t)return t}}return null}function m(e){bi(p).has(e)?bi(p).delete(e):bi(p).add(e),$n(p,new Set(bi(p)),!0)}function y(e){$n(u,e,!0)}function b(){var e;null==(e=l())||e(bi(u)),k()}function w(){var e;null==(e=c())||e(),k()}function k(){$n(u,null),$n(h,""),$n(p,new Set,!0)}let S=!1;Ti(()=>{if(r()){if(!S){S=!0;const e=new Set;o().forEach(t=>{e.add(t.deck.id)}),$n(p,e,!0)}}else k(),S=!1});var x={get open(){return r()},set open(e){r(e),hn()},get currentDeck(){return s()},set currentDeck(e){s(e),hn()},get deckTree(){return o()},set deckTree(e){o(e),hn()},get onconfirm(){return l()},set onconfirm(e){l(e),hn()},get oncancel(){return c()},set oncancel(e){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},_=ha(),C=Qt(_),I=e=>{var t=lie();t.__click=[Gne,w],t.__keydown=[Qne,w];var n=Gt(t),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a),Hg(Kt(a,2),{variant:"secondary",size:"sm",onclick:w,children:(e,t)=>{Ng(e,{get name(){return yg},size:16})},$$slots:{default:!0}}),zt(i);var o=Kt(i,2),l=Gt(o),c=Gt(l);Ng(c,{get name(){return Ig},size:16});var g=Kt(c,2),f=Gt(g),k=Gt(f,!0);zt(f),zt(g),zt(l);var S=Kt(l,2),x=Gt(S);Ng(x,{get name(){return Cg},size:16});var _=Kt(x,2);Za(_),zt(S);var C=Kt(S,2),I=Gt(C),D=Gt(I,!0);zt(I);var T=Kt(I,2);let M;T.__click=[Kne,y],T.__keydown=[Zne,y];var A=Gt(T);Ng(Gt(A),{get name(){return Sg},size:20}),zt(A);var E=Kt(A,2),z=Gt(E),P=Gt(z,!0);zt(z);var R=Kt(z,2),$=Gt(R,!0);zt(R),zt(E);var O=Kt(E,2),L=e=>{var t=Yne();Ng(Gt(t),{get name(){return Ag},size:20}),zt(t),pa(e,t)};xa(O,e=>{null===bi(u)&&e(L)}),zt(T);var N=Kt(T,2),F=Gt(N),B=e=>{var t=Xne();Ng(Gt(t),{get name(){return Mg},size:24}),Pt(2),zt(t),pa(e,t)},j=e=>{var t=ha();Ca(Qt(t),17,()=>bi(v),_a,(e,t)=>{const n=In(()=>{const{node:e,depth:n,hasChildren:i,isExpanded:a,isSelected:r,isExcluded:o}=function(e,t=0){return{node:e,depth:t,hasChildren:e.children&&e.children.length>0,isExpanded:bi(p).has(e.deck.id),isSelected:bi(u)===e.deck.id,isExcluded:e.deck.id===s().id}}(bi(t),0);return{node:e,depth:n,hasChildren:i,isExpanded:a,isSelected:r,isExcluded:o}});var i=ha(),a=Qt(i),r=e=>{var t=sie();let i;t.__click=[Jne,y,n],t.__keydown=[eie,y,n];var a=Gt(t),r=e=>{var t=nie();t.__click=[tie,m,n];var i=Gt(t);{let e=In(()=>bi(n).isExpanded?kg:xg);Ng(i,{get name(){return bi(e)},size:14})}zt(t),zi(()=>er(t,"aria-label",bi(n).isExpanded?"折叠":"展开")),pa(e,t)},s=e=>{pa(e,iie())};xa(a,e=>{bi(n).hasChildren?e(r):e(s,!1)});var o=Kt(a,2);Ng(Gt(o),{get name(){return Rg},size:20}),zt(o);var l=Kt(o,2),c=Gt(l),d=Gt(c,!0);zt(c);var u=Kt(c,2),h=e=>{var t=aie(),i=Gt(t,!0);zt(t),zi(()=>va(i,bi(n).node.deck.description)),pa(e,t)};xa(u,e=>{bi(n).node.deck.description&&e(h)}),zt(l);var p=Kt(l,2),g=e=>{var t=rie();Ng(Gt(t),{get name(){return Ag},size:20}),zt(t),pa(e,t)};xa(p,e=>{bi(n).isSelected&&e(g)}),zt(t),zi(e=>{i=Fa(t,1,"mdc-deck-item svelte-11xpj20",null,i,e),ja(t,`padding-left: ${24*bi(n).depth+16}px`),er(t,"aria-label",`选择牌组: ${bi(n).node.deck.name}`),va(d,bi(n).node.deck.name)},[()=>({selected:bi(n).isSelected})]),pa(e,t)};xa(a,e=>{bi(n).isExcluded||e(r)}),pa(e,i)}),pa(e,t)};xa(F,e=>{0===bi(v).length?e(B):e(j,!1)}),zt(N),zt(C),zt(o);var U=Kt(o,2),V=Gt(U);Hg(V,{variant:"secondary",onclick:w,children:(e,t)=>{Pt();var n=ua();zi(e=>va(n,e),[()=>bi(d)("modals.moveDeck.cancel")]),pa(e,n)},$$slots:{default:!0}}),Hg(Kt(V,2),{variant:"primary",onclick:b,children:(e,t)=>{Pt();var n=oie(),i=Qt(n);Ng(Kt(i),{get name(){return _g},size:16}),zi(e=>va(i,`${null!=e?e:""} `),[()=>bi(d)("modals.moveDeck.confirm")]),pa(e,n)},$$slots:{default:!0}}),zt(U),zt(n),zt(t),zi((e,t,n,i,a,s,o,l)=>{va(r,e),va(k,t),er(_,"placeholder",n),va(D,i),M=Fa(T,1,"mdc-deck-item root-option svelte-11xpj20",null,M,a),er(T,"aria-label",s),va(P,o),va($,l)},[()=>bi(d)("modals.moveDeck.title"),()=>bi(d)("modals.moveDeck.moveToNew").replace("{name}",s().name),()=>bi(d)("modals.moveDeck.searchPlaceholder"),()=>bi(d)("modals.moveDeck.selectTarget"),()=>({selected:null===bi(u)}),()=>bi(d)("modals.moveDeck.moveToRoot"),()=>bi(d)("modals.moveDeck.rootOption"),()=>bi(d)("modals.moveDeck.rootDesc")]),pr(_,()=>bi(h),e=>$n(h,e)),pa(e,t)};xa(C,e=>{r()&&e(I)}),pa(e,_);var D=St(x);return a(),D}async function die(e,t,n=5e3,i=50){const a=Date.now(),r=e();if(null!=r)return _e.debug(`[ServiceReady] ${t} 已就绪（立即可用）`),r;for(_e.debug(`[ServiceReady] 等待 ${t} 初始化...`);Date.now()-a<n;){const n=e();if(null!=n){const e=Date.now()-a;return _e.debug(`[ServiceReady] ${t} 已就绪（等待 ${e}ms）`),n}await new Promise(e=>setTimeout(e,i))}const s=new Error(`Service ${t} initialization timeout after ${n}ms`);throw _e.error(`[ServiceReady] ${t} 初始化超时`,s),s}ia(["click","keydown"]);class uie{constructor(e,t){oe(this,"storage"),oe(this,"cardsCache",null),oe(this,"cacheTimestamp",0),oe(this,"CACHE_TTL",3e4),oe(this,"deckStats"),this.storage=e,this.deckStats=t}updateDeckStats(e){this.deckStats=e}async getAllCards(){const e=Date.now();return this.cardsCache&&e-this.cacheTimestamp<this.CACHE_TTL||(this.cardsCache=await this.storage.getCards(),this.cacheTimestamp=e),this.cardsCache}clearCache(){this.cardsCache=null,this.cacheTimestamp=0}analyzeCompletion(e){var t;const n=(null==(t=this.deckStats)?void 0:t[e.id])||e.stats;return n.newCards>0?"new":n.learningCards>0?"learning":n.reviewCards>0?"review":"completed"}async analyzeTimeRange(e){try{const t=(await this.getAllCards()).filter(t=>t.deckId===e.id);if(0===t.length)return"future";const n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()),a=new Date(i.getTime()+6048e5);let r=null;for(const e of t){if(!e.fsrs)continue;const t=new Date(e.fsrs.due);(!r||t<r)&&(r=t)}return r?r<n?"urgent":r<new Date(i.getTime()+864e5)?"today":r<a?"thisWeek":"future":"future"}catch(t){return _e.error("Error analyzing time range:",t),"future"}}async analyzePriority(e){var t;try{if(null==(t=e.metadata)?void 0:t.priority)return e.metadata.priority;const n=(await this.getAllCards()).filter(t=>t.deckId===e.id);if(0===n.length)return"none";let i=!1,a=!1,r=!1;for(const e of n){const t=e.priority||0;4===t?i=!0:3===t?a=!0:2===t&&(r=!0)}return i?"high":a?"medium":r?"low":"none"}catch(n){return _e.error("Error analyzing priority:",n),"none"}}analyzeTag(e){return e.tags&&e.tags.length>0?e.tags[0]:"noTag"}async groupDecks(e,t){const n={};if("timeRange"===t||"priority"===t){const i=await Promise.all(e.map(async e=>{let n;switch(t){case"timeRange":n=await this.analyzeTimeRange(e);break;case"priority":n=await this.analyzePriority(e);break;default:n="unknown"}return{deck:e,groupKey:n}}));for(const{deck:e,groupKey:t}of i)n[t]||(n[t]=[]),n[t].push(e)}else for(const i of e){let e;switch(t){case"completion":e=this.analyzeCompletion(i);break;case"tag":e=this.analyzeTag(i);break;default:e="unknown"}n[e]||(n[e]=[]),n[e].push(i)}return n}flattenDeckTree(e){const t=[],n=e=>{for(const i of e)t.push(i.deck),i.children&&i.children.length>0&&n(i.children)};return n(e),t}}const hie={completion:{title:"完成情况",icon:"check-circle",groups:[{key:"new",label:"新卡片",color:"#10b981",icon:"circle"},{key:"learning",label:"学习中",color:"#f59e0b",icon:"book-open"},{key:"review",label:"待复习",color:"#3b82f6",icon:"refresh-cw"},{key:"completed",label:"已完成",color:"#6b7280",icon:"check-circle"}]},timeRange:{title:"时间范围",icon:"clock",groups:[{key:"urgent",label:"紧急",color:"#ef4444",icon:"alert-circle"},{key:"today",label:"今日",color:"#f59e0b",icon:"sun"},{key:"thisWeek",label:"本周",color:"#3b82f6",icon:"calendar"},{key:"future",label:"未来",color:"#6b7280",icon:"clock"}]},priority:{title:"优先级",icon:"flag",groups:[{key:"high",label:"高优先级",color:"#ef4444",icon:"alert-triangle"},{key:"medium",label:"中优先级",color:"#f59e0b",icon:"flag"},{key:"low",label:"低优先级",color:"#10b981",icon:"minus-circle"},{key:"none",label:"无优先级",color:"#6b7280",icon:"circle"}]},tag:{title:"标签分组",icon:"tag",groups:[{key:"noTag",label:"无标签",color:"#6b7280",icon:"circle"}]}},pie={completion:"完成情况",timeRange:"时间范围",priority:"优先级",tag:"标签分组"};function gie(e){return"number"==typeof e?e:"string"==typeof e?Date.parse(e):e.getTime()}function vie(e){const t=[],n=new Set;for(const i of e){if(i.type===Kr.ProgressiveChild){const e=i;if(n.has(e.parentCardId)){_e.debug(`[filterProgressiveSiblings] 跳过子卡片 ${e.uuid.slice(0,8)} (cloze ${e.clozeOrd})，父卡片 ${e.parentCardId.slice(0,8)} 的其他子卡片已在队列中`);continue}n.add(e.parentCardId)}t.push(i)}return n.size>0&&_e.info(`[filterProgressiveSiblings] ✅ 过滤完成: 原始 ${e.length} 张 → 过滤后 ${t.length} 张 (${n.size} 组渐进式挖空)`),t}function fie(e,t,n){if(r8(e))return!1;const i=e.fsrs;return!!i&&(i.state===t&&gie(i.due)<=n)}async function mie(e,t){try{const n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()).getTime(),a=(await e.getStudySessions()).filter(e=>{const n=new Date(e.startTime).getTime()>=i,a=!t||e.deckId===t;return n&&a});return a.reduce((e,t)=>e+(t.newCardsLearned||0),0)}catch(n){return _e.error("[studyCompletionHelper] 获取今日新卡片数量失败:",n),0}}function yie(e,t){return Math.max(0,e-t)}async function bie(e,t,n){const{CardInstanceProvider:i}=await Promise.resolve().then(()=>Aee),a=new i;let r=0;for(const o of e){const e=a.getTodaysInstances(o,{onlyDue:!0});if(0===e.length)continue;const t=e[0].fsrs;t&&(0===t.state||r++)}const s=yie(t,n);return 0===r&&s<=0}function wie(e,t=20,n=7){const i=Date.now(),a=i+24*n*60*60*1e3;return e.filter(e=>{if(r8(e))return!1;if(!e.fsrs)return!1;const t=1===e.fsrs.state||2===e.fsrs.state,n=gie(e.fsrs.due);return t&&n>i&&n<=a}).sort((e,t)=>{const n=e=>e.fsrs?gie(e.fsrs.due):1/0;return n(e)-n(t)}).slice(0,t)}async function kie(e,t,n){try{_e.debug("[loadCardsByIds] 开始加载卡片:",{requestedCount:t.length,cardIds:t.map(e=>e.slice(0,8)),deckId:n});const i=n?await e.getCards({deckId:n}):await e.getAllCards();_e.debug("[loadCardsByIds] getCards结果:",{totalCards:i.length,sampleCardIds:i.slice(0,5).map(e=>e.uuid.slice(0,8)),fromDeck:!!n});const a=new Map;i.forEach(e=>{a.set(e.uuid,e)});const r=[],s=[];for(const e of t){const t=a.get(e);t?r.push(t):(s.push(e),_e.warn(`[loadCardsByIds] ❌ 卡片ID不存在: ${e.slice(0,8)}`))}return _e.debug("[loadCardsByIds] ✅ 加载完成:",{requested:t.length,loaded:r.length,notFound:s.length,notFoundIds:s.map(e=>e.slice(0,8))}),r}catch(i){return _e.error("[loadCardsByIds] 加载卡片失败:",i),[]}}async function Sie(e,t,n,i,a=!0){try{const r=await e.getAllCards(),{filterRecycledCards:s}=await Promise.resolve().then(()=>Tee),o=s(r).filter(e=>e.deckId===t);_e.debug("[loadDeckCardsForStudy] 🔍 卡片过滤:",{deckId:t.slice(0,8),totalCards:r.filter(e=>e.deckId===t).length,afterFilterRecycled:o.length});const{CardInstanceProvider:l}=await Promise.resolve().then(()=>Aee),c=new l,d=[],u=[],h=[],p=[];for(const e of o){const t=c.getTodaysInstances(e,{onlyDue:!0});if(0===t.length)continue;const n=t[0].fsrs;n&&(0===n.state?p.push(e):1===n.state?d.push(e):3===n.state?u.push(e):2===n.state&&h.push(e))}const g=yie(n,await mie(e,t)),v=[...d,...u,...h,...p.slice(0,g)];let f;return a?(f=vie(v),_e.info(`[loadDeckCardsForStudy] ✅ 兄弟过滤已启用: ${v.length} → ${f.length} 张卡片`)):(f=v,_e.info(`[loadDeckCardsForStudy] ⚠️  兄弟过滤已禁用: 保留所有 ${f.length} 张卡片`)),f.slice(0,i)}catch(r){return _e.error("[studyCompletionHelper] 加载牌组卡片失败:",r),[]}}async function xie(e,t,n){try{const i=await e.getAllCards(),{filterRecycledCards:a}=await Promise.resolve().then(()=>Tee),r=a(i);_e.debug("[loadAllDueCardsForStudy] 🔍 卡片过滤:",{totalCards:i.length,afterFilterRecycled:r.length});const s=Date.now(),o=r.filter(e=>fie(e,1,s)),l=r.filter(e=>fie(e,3,s)),c=r.filter(e=>fie(e,2,s)),d=r.filter(e=>!r8(e)&&(e.fsrs&&0===e.fsrs.state)),u=yie(t,await mie(e));return[...o,...l,...c,...d.slice(0,u)].slice(0,n)}catch(i){return _e.error("[studyCompletionHelper] 加载全局卡片失败:",i),[]}}const _ie=Object.freeze(Object.defineProperty({__proto__:null,filterProgressiveSiblings:vie,getAdvanceStudyCards:wie,getLearnedNewCardsCountToday:mie,getRemainingNewCardsQuota:yie,isDeckCompleteForToday:bie,loadAllDueCardsForStudy:xie,loadCardsByIds:kie,loadDeckCardsForStudy:Sie,parseDueTime:gie},Symbol.toStringTag,{value:"Module"}));function Cie(e,t,n,i,a,r,s,o){if(e.stopPropagation(),bi(t))n();else{if(bi(i)){const e=bi(i).getBoundingClientRect(),t=window.innerHeight,n=window.innerWidth;let r=e.bottom+4,s=n-e.right;r+400>t&&(r=e.top-400-4),s+280>n&&(s=n-e.left-280),$n(a,{top:r,right:s},!0)}if(0===bi(r).order.length){const e=Object.keys(bi(s));e.length>0&&(bi(r).order=e,o())}$n(t,!0)}}function Iie(e,t){e.target===e.currentTarget&&t()}var Die=la('<div class="loading-indicator svelte-d34sxl"><div class="spinner svelte-d34sxl"></div> <span>正在分组...</span></div>'),Tie=(e,t,n)=>t(e,bi(n).id),Mie=la('<div class="stat-item svelte-d34sxl"><span class="stat-value new svelte-d34sxl"> </span> <span class="stat-label svelte-d34sxl">新</span></div>'),Aie=la('<div class="stat-item svelte-d34sxl"><span class="stat-value learning svelte-d34sxl"> </span> <span class="stat-label svelte-d34sxl">学习</span></div>'),Eie=la('<div class="stat-item svelte-d34sxl"><span class="stat-value review svelte-d34sxl"> </span> <span class="stat-label svelte-d34sxl">复习</span></div>'),zie=la('<span class="stat-label svelte-d34sxl">今日已完成</span>'),Pie=(e,t,n)=>t()(bi(n).id),Rie=la('<div role="button"><div class="card-header svelte-d34sxl"><span class="deck-icon svelte-d34sxl"><!></span> <h4 class="deck-name svelte-d34sxl"> </h4> <button class="deck-menu-button svelte-d34sxl" aria-label="更多操作"><!></button></div> <div class="card-stats svelte-d34sxl"><!> <!> <!> <!></div> <button class="action-button svelte-d34sxl"><!> 学习</button></div>'),$ie=la('<div class="empty-message svelte-d34sxl"><!> <span>暂无牌组</span></div>'),Oie=la('<div role="region"><div class="column-header svelte-d34sxl"><div class="header-content svelte-d34sxl"><span class="header-icon svelte-d34sxl"><!></span> <h3 class="header-title svelte-d34sxl"> </h3></div> <span class="count-badge svelte-d34sxl"> </span></div> <div class="column-content svelte-d34sxl"><!> <!></div></div>'),Lie=la('<div class="kanban-columns svelte-d34sxl"></div>'),Nie=(e,t)=>{"Escape"===e.key&&t()},Fie=(e,t)=>$n(t,"groupby"),Bie=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),$n(t,"groupby"))},jie=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},Uie=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},Vie=(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},qie=e=>{"Enter"!==e.key&&" "!==e.key||e.preventDefault()},Hie=(e,t,n)=>{e.stopPropagation(),t(bi(n).key)},Wie=la('<div draggable="true" role="button" tabindex="0"><div class="notion-drag-handle svelte-d34sxl" role="presentation" aria-hidden="true">⋮⋮</div> <div class="notion-group-name svelte-d34sxl"> </div> <div class="notion-group-actions svelte-d34sxl"><button><!></button></div></div>'),Gie=la('<div class="notion-menu-header svelte-d34sxl"><div class="notion-menu-title svelte-d34sxl"><!> <span>视图选项</span></div> <button class="notion-close-btn svelte-d34sxl"><!></button></div> <div class="notion-menu-row notion-menu-row--clickable svelte-d34sxl" role="button" tabindex="0"><span class="notion-menu-label svelte-d34sxl">分组方式</span> <div class="notion-menu-value svelte-d34sxl"><span> </span> <!></div></div> <div class="notion-divider svelte-d34sxl"></div> <div class="notion-menu-row svelte-d34sxl"><span class="notion-menu-label svelte-d34sxl">隐藏空白分组</span> <div role="switch" tabindex="0"><div class="notion-toggle-thumb svelte-d34sxl"></div></div></div> <div class="notion-section-header svelte-d34sxl"><span class="notion-section-title svelte-d34sxl">群组</span> <div class="notion-action-group svelte-d34sxl"><span class="notion-section-action svelte-d34sxl" role="button" tabindex="0">重置</span> <span class="notion-separator svelte-d34sxl">·</span> <span class="notion-section-action svelte-d34sxl" role="button" tabindex="0"> </span></div></div> <div class="notion-menu-content svelte-d34sxl"></div>',1),Qie=(e,t,n)=>{e.stopPropagation(),t(n)},Kie=(e,t,n)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),t(n))},Zie=la('<div role="button" tabindex="0"><div class="notion-option-content svelte-d34sxl"><!> <span> </span></div> <!></div>'),Yie=la('<div class="notion-menu-header svelte-d34sxl"><button class="notion-back-btn svelte-d34sxl"><!> <span>分组方式</span></button> <button class="notion-close-btn svelte-d34sxl"><!></button></div> <div class="notion-menu-content svelte-d34sxl"></div>',1),Xie=la('<div class="tuanki-column-menu-overlay svelte-d34sxl" role="presentation"><div class="tuanki-column-menu kanban-dropdown-menu svelte-d34sxl" role="dialog" aria-label="看板设置" tabindex="-1"><!></div></div>'),Jie=la('<div class="kanban-view svelte-d34sxl"><div class="deck-kanban-toolbar svelte-d34sxl"><div class="toolbar-left svelte-d34sxl"><h3 class="kanban-title svelte-d34sxl"> <span class="total-count-badge svelte-d34sxl"> </span></h3></div> <div class="toolbar-right svelte-d34sxl"><button class="kanban-menu-button svelte-d34sxl" title="看板设置"><!> <span class="svelte-d34sxl">设置</span></button></div></div> <!></div> <!>',1);function eae(e,t){if(new.target)return Er({component:eae,...e});kt(t,!0);let n,i=Ar(t,"deckTree",7),a=Ar(t,"deckStats",7),r=Ar(t,"dataStorage",7),s=Ar(t,"plugin",7),o=Ar(t,"groupBy",7,"completion"),l=Ar(t,"onStartStudy",7),c=Ar(t,"onDeckUpdate",7),d=Ar(t,"onEditDeck",7),u=Ar(t,"onDeleteDeck",7),h=Ar(t,"onCreateSubdeck",7),p=Ar(t,"onMoveDeck",7),g=Pn(Ot(o())),v=Pn(Ot({})),f=Pn(!1),m=Pn(!1),y=Pn("main"),b=Pn(null),w=Pn(null),k=Pn(Ot({top:0,right:0})),S=Pn(Ot({hidden:[],pinned:[],order:[],hideEmptyGroups:!1})),x=Pn(null),_=Pn(null),C=Pn(null),I=Pn(null);function D(e){const t=[];for(const n of e)t.push(n.deck),n.children.length>0&&t.push(...D(n.children));return t}n=new uie(r(),a()),Ti(()=>{n.updateDeckStats(a())});const T=In(()=>D(i())),M=In(()=>(()=>{if("tag"===bi(g)){const e=new Set;bi(T).forEach(t=>{t.tags&&t.tags.length>0&&e.add(t.tags[0])});const t=["#3b82f6","#10b981","#f59e0b","#ec4899","#8b5cf6","#06b6d4","#ef4444"],n=Array.from(e).sort().map((e,n)=>({key:e,label:e,color:t[n%t.length],icon:"tag"}));return n.push({key:"noTag",label:"无标签",color:"#6b7280",icon:"circle"}),{title:"标签分组",icon:"tag",groups:n}}return hie[bi(g)]})()),A=In(()=>pie[bi(g)]),E=In(()=>(()=>{const e=bi(M).groups;if(bi(S).order.length>0){const t=e.map(e=>e.key),n=bi(S).order.filter(e=>t.includes(e)),i=t.filter(e=>!n.includes(e));return[...n,...i].map(t=>e.find(e=>e.key===t)).filter(e=>void 0!==e).filter(e=>{const t=bi(S).hidden.includes(e.key),n=0===(bi(v)[e.key]||[]).length;return!(t||bi(S).hideEmptyGroups&&n)})}return e.filter(e=>{const t=bi(S).hidden.includes(e.key),n=0===(bi(v)[e.key]||[]).length;return!(t||bi(S).hideEmptyGroups&&n)})})());function z(){localStorage.setItem("tuanki-deck-kanban-columns",JSON.stringify(bi(S)))}function P(){$n(m,!1),$n(y,"main")}function R(){$n(y,"main")}async function $(e){if(!["completion","timeRange","priority","tag"].includes(e))return;$n(g,e,!0),localStorage.setItem("tuanki-deck-kanban-groupby",e),await yi();const t=Object.keys(bi(v));bi(S).order=t,bi(S).hidden=[],z(),setTimeout(()=>{R()},200)}function O(e){bi(S).hidden.includes(e)?bi(S).hidden=bi(S).hidden.filter(t=>t!==e):bi(S).hidden=[...bi(S).hidden,e],z()}function L(){bi(S).hideEmptyGroups=!bi(S).hideEmptyGroups,z()}function N(){bi(F)?(bi(S).hidden=[],z()):function(){const e=Object.keys(bi(v));bi(S).hidden=[...e],z()}()}Ti(()=>{!async function(){$n(f,!0);try{$n(v,await n.groupDecks(bi(T),bi(g)),!0)}catch(e){_e.error("Error grouping decks:",e),$n(v,{},!0)}finally{$n(f,!1)}}()}),Pr(()=>{const e=localStorage.getItem("tuanki-deck-kanban-groupby");e&&["completion","timeRange","priority","tag"].includes(e)&&$n(g,e,!0);const t=localStorage.getItem("tuanki-deck-kanban-columns");if(t)try{const e=JSON.parse(t);$n(S,{hidden:e.hidden||[],pinned:e.pinned||[],order:e.order||[],hideEmptyGroups:e.hideEmptyGroups||!1},!0)}catch(n){_e.error("Failed to parse column config:",n)}});const F=In(()=>{const e=Object.keys(bi(v)).length;return bi(S).hidden.length>=e});function B(){$n(S,{hidden:[],pinned:[],order:Object.keys(bi(v)),hideEmptyGroups:!1},!0),z()}function j(){$n(x,null),$n(_,null)}function U(e,t){e.stopPropagation();const n=new ge.Menu,i=bi(T).find(e=>e.id===t);i&&(n.addItem(e=>e.setTitle("提前学习").setIcon("fast-forward").onClick(async()=>{var e;try{const t=await r().getCardsByDeck(i.id),n=wie(t,20,(null==(e=s())?void 0:e.settings.maxAdvanceDays)||7);if(0===n.length)return void new ge.Notice("该牌组暂无需要提前学习的卡片");new ge.Notice(`找到 ${n.length} 张可提前学习的卡片`)}catch(t){_e.error("获取提前学习卡片失败:",t),new ge.Notice("获取卡片信息失败")}})),n.addSeparator(),n.addItem(e=>e.setTitle("创建子牌组").setIcon("folder-plus").onClick(()=>{var e;return null==(e=h())?void 0:e(t)})),n.addItem(e=>e.setTitle("移动牌组").setIcon("move").onClick(()=>{var e;return null==(e=p())?void 0:e(t)})),n.addSeparator(),n.addItem(e=>e.setTitle("牌组编辑").setIcon("edit").onClick(()=>{var e;return null==(e=d())?void 0:e(t)})),n.addItem(e=>e.setTitle("删除").setIcon("trash-2").onClick(()=>{var e;return null==(e=u())?void 0:e(t)})),n.addSeparator(),n.showAtMouseEvent(e))}function V(){return"priority"===bi(g)}function q(){$n(C,null),$n(I,null)}function H(){$n(I,null)}async function W(e){if(bi(C)&&V())try{const t=function(e){for(const[t,n]of Object.entries(bi(v)))if(n.some(t=>t.id===e.id))return t;return""}(bi(C));if(t===e)return void q();const i={...bi(C),metadata:{...bi(C).metadata,priority:e},modified:(new Date).toISOString()};await r().saveDeck(i),c()?c()():$n(v,await n.groupDecks(bi(T),bi(g)),!0),_e.debug(`[KanbanView] 牌组 ${bi(C).name} 优先级已更新为 ${e}`)}catch(t){_e.error("[KanbanView] 更新牌组优先级失败:",t)}finally{q()}}var G={get deckTree(){return i()},set deckTree(e){i(e),hn()},get deckStats(){return a()},set deckStats(e){a(e),hn()},get dataStorage(){return r()},set dataStorage(e){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},get groupBy(){return o()},set groupBy(e="completion"){o(e),hn()},get onStartStudy(){return l()},set onStartStudy(e){l(e),hn()},get onDeckUpdate(){return c()},set onDeckUpdate(e){c(e),hn()},get onEditDeck(){return d()},set onEditDeck(e){d(e),hn()},get onDeleteDeck(){return u()},set onDeleteDeck(e){u(e),hn()},get onCreateSubdeck(){return h()},set onCreateSubdeck(e){h(e),hn()},get onMoveDeck(){return p()},set onMoveDeck(e){p(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},Q=Jie(),K=Qt(Q),Z=Gt(K),Y=Gt(Z),X=Gt(Y),J=Gt(X),ee=Kt(J),te=Gt(ee,!0);zt(ee),zt(X),zt(Y);var ne=Kt(Y,2),ie=Gt(ne);ie.__click=[Cie,m,P,b,k,S,v,z],Ng(Gt(ie),{name:"sliders",size:16}),Pt(2),zt(ie),kr(ie,e=>$n(b,e),()=>bi(b)),zt(ne),zt(Z);var ae=Kt(Z,2),re=e=>{pa(e,Die())},se=e=>{var t=Lie();Ca(t,21,()=>bi(E),e=>e.key,(e,t)=>{const n=In(()=>bi(v)[bi(t).key]||[]);var i=Oie();let r;var s=Gt(i),o=Gt(s),c=Gt(o);Ng(Gt(c),{get name(){return bi(t).icon},size:16,get color(){return bi(t).color}}),zt(c);var d=Kt(c,2),u=Gt(d,!0);zt(d),zt(o);var h=Kt(o,2),p=Gt(h,!0);zt(h),zt(s);var g=Kt(s,2),f=Gt(g);Ca(f,17,()=>bi(n),e=>e.id,(e,t)=>{const n=In(()=>function(e){return a()[e.id]||{newCards:0,learningCards:0,reviewCards:0,memoryRate:0}}(bi(t)));var i=Rie();let r;var s=Gt(i),o=Gt(s),c=Gt(o),d=e=>{var n=ua();zi(()=>va(n,bi(t).icon)),pa(e,n)},u=e=>{Ng(e,{name:"folder",size:16})};xa(c,e=>{bi(t).icon?e(d):e(u,!1)}),zt(o);var h=Kt(o,2),p=Gt(h,!0);zt(h);var g=Kt(h,2);g.__click=[Tie,U,t],Ng(Gt(g),{name:"more-horizontal",size:16}),zt(g),zt(s);var v=Kt(s,2),f=Gt(v),m=e=>{var t=Mie(),i=Gt(t),a=Gt(i,!0);zt(i),Pt(2),zt(t),zi(()=>va(a,bi(n).newCards)),pa(e,t)};xa(f,e=>{bi(n).newCards>0&&e(m)});var y=Kt(f,2),b=e=>{var t=Aie(),i=Gt(t),a=Gt(i,!0);zt(i),Pt(2),zt(t),zi(()=>va(a,bi(n).learningCards)),pa(e,t)};xa(y,e=>{bi(n).learningCards>0&&e(b)});var w=Kt(y,2),k=e=>{var t=Eie(),i=Gt(t),a=Gt(i,!0);zt(i),Pt(2),zt(t),zi(()=>va(a,bi(n).reviewCards)),pa(e,t)};xa(w,e=>{bi(n).reviewCards>0&&e(k)});var S=Kt(w,2),x=e=>{pa(e,zie())};xa(S,e=>{0===bi(n).newCards&&0===bi(n).learningCards&&0===bi(n).reviewCards&&e(x)}),zt(v);var _=Kt(v,2);_.__click=[Pie,l,t],Ng(Gt(_),{name:"play",size:12}),Pt(),zt(_),zt(i),zi((e,n,a)=>{r=Fa(i,1,"kanban-card svelte-d34sxl",null,r,e),er(i,"tabindex",n),er(i,"draggable",a),er(h,"title",bi(t).name),va(p,bi(t).name)},[()=>{var e;return{dragging:(null==(e=bi(C))?void 0:e.id)===bi(t).id,draggable:V()}},()=>V()?0:void 0,V]),na("dragstart",i,e=>function(e,t){V()&&($n(C,t,!0),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("application/x-tuanki-deck",t.id)))}(e,bi(t))),na("dragend",i,q),pa(e,i)});var m=Kt(f,2),y=e=>{var t=$ie();Ng(Gt(t),{name:"inbox",size:24}),Pt(2),zt(t),pa(e,t)};xa(m,e=>{0===bi(n).length&&e(y)}),zt(g),zt(i),zi(e=>{var a;r=Fa(i,1,"kanban-column svelte-d34sxl",null,r,e),ja(i,`--column-color: ${null!=(a=bi(t).color)?a:""}`),er(i,"aria-label",`${bi(t).label}分组`),va(u,bi(t).label),va(p,bi(n).length)},[()=>({"drag-over":bi(I)===bi(t).key})]),na("dragover",i,e=>function(e,t){bi(C)&&(e.preventDefault(),$n(I,t,!0))}(e,bi(t).key)),na("dragleave",i,H),na("drop",i,()=>W(bi(t).key)),pa(e,i)}),zt(t),pa(e,t)};xa(ae,e=>{bi(f)?e(re):e(se,!1)}),zt(K);var oe=Kt(K,2),le=e=>{var t=Xie();t.__click=[Iie,P],t.__keydown=[Nie,P];var n=Gt(t),i=Gt(n),a=e=>{var t=Gie(),n=Qt(t),i=Gt(n);Ng(Gt(i),{name:"sliders",size:14}),Pt(2),zt(i);var a=Kt(i,2);a.__click=P,Ng(Gt(a),{name:"x",size:14}),zt(a),zt(n);var r=Kt(n,2);r.__click=[Fie,y],r.__keydown=[Bie,y];var s=Kt(Gt(r),2),o=Gt(s),l=Gt(o,!0);zt(o),Ng(Kt(o,2),{name:"chevron-right",size:12}),zt(s),zt(r);var c=Kt(r,4),d=Kt(Gt(c),2);d.__click=L,d.__keydown=[jie,L],zt(c);var u=Kt(c,2),h=Kt(Gt(u),2),p=Gt(h);p.__click=B,p.__keydown=[Uie,B];var v=Kt(p,4);v.__click=N,v.__keydown=[Vie,N];var f=Gt(v,!0);zt(v),zt(h),zt(u);var m=Kt(u,2);Ca(m,21,()=>bi(M).groups,e=>e.key,(e,t)=>{const n=In(()=>bi(S).hidden.includes(bi(t).key));var i=Wie();let a;i.__keydown=[qie];var r=Kt(Gt(i),2),s=Gt(r,!0);zt(r);var o=Kt(r,2),l=Gt(o);l.__click=[Hie,O,t];var c=Gt(l);{let e=In(()=>bi(n)?"eye-off":"eye");Ng(c,{get name(){return bi(e)},size:12})}zt(l),zt(o),zt(i),zi(e=>{a=Fa(i,1,"notion-group-item svelte-d34sxl",null,a,e),va(s,bi(t).label),Fa(l,1,"notion-icon-btn "+(bi(n)?"":"active"),"svelte-d34sxl")},[()=>({dragging:bi(x)===bi(t).key,"drag-over":bi(_)===bi(t).key})]),na("dragstart",i,()=>{return e=bi(t).key,void $n(x,e,!0);var e}),na("dragover",i,e=>function(e,t){e.preventDefault(),bi(x)&&bi(x)!==t&&$n(_,t,!0)}(e,bi(t).key)),na("drop",i,e=>function(e,t){if(e.preventDefault(),bi(x)&&bi(x)!==t){const e=bi(E).map(e=>e.key),n=e.indexOf(bi(x)),i=e.indexOf(t);if(-1!==n&&-1!==i){const e=[...bi(S).order],n=e.indexOf(bi(x)),i=e.indexOf(t);if(-1!==n&&-1!==i){e.splice(n,1);const t=n<i?i-1:i;e.splice(t,0,bi(x)),bi(S).order=e,z()}}}$n(x,null),$n(_,null)}(e,bi(t).key)),na("dragend",i,j),pa(e,i)}),zt(m),zi(()=>{va(l,pie[bi(g)]),Fa(d,1,"notion-toggle-mini "+(bi(S).hideEmptyGroups?"active":""),"svelte-d34sxl"),er(d,"aria-checked",bi(S).hideEmptyGroups),er(v,"title",bi(F)?"显示所有列":"隐藏所有列"),va(f,bi(F)?"全部显示":"全部隐藏")}),pa(e,t)},r=e=>{var t=ha(),n=Qt(t),i=e=>{var t=Yie(),n=Qt(t),i=Gt(n);i.__click=R,Ng(Gt(i),{name:"arrow-left",size:14}),Pt(2),zt(i);var a=Kt(i,2);a.__click=P,Ng(Gt(a),{name:"x",size:14}),zt(a),zt(n);var r=Kt(n,2);Ca(r,20,()=>["completion","timeRange","priority","tag"],_a,(e,t)=>{const n=In(()=>hie[t]);var i=Zie();i.__click=[Qie,$,t],i.__keydown=[Kie,$,t];var a=Gt(i),r=Gt(a);Ng(r,{get name(){return bi(n).icon},size:14});var s=Kt(r,2),o=Gt(s,!0);zt(s),zt(a);var l=Kt(a,2),c=e=>{Ng(e,{name:"check",size:14})};xa(l,e=>{bi(g)===t&&e(c)}),zt(i),zi(()=>{Fa(i,1,"notion-menu-row notion-menu-row--option "+(bi(g)===t?"notion-menu-row--selected":""),"svelte-d34sxl"),va(o,bi(n).title)}),pa(e,i)}),zt(r),pa(e,t)};xa(n,e=>{"groupby"===bi(y)&&e(i)},!0),pa(e,t)};xa(i,e=>{"main"===bi(y)?e(a):e(r,!1)}),zt(n),kr(n,e=>$n(w,e),()=>bi(w)),zt(t),zi(()=>{var e,t;return ja(n,`position: fixed; top: ${null!=(e=bi(k).top)?e:""}px; right: ${null!=(t=bi(k).right)?t:""}px;`)}),pa(e,t)};return xa(oe,e=>{bi(m)&&e(le)}),zi(()=>{var e;va(J,`${null!=(e=bi(A))?e:""} `),va(te,bi(T).length)}),pa(e,Q),St(G)}ia(["click","keydown"]);const tae=[{id:"cool",name:"冷色调系列",urgent:{gradient:"linear-gradient(135deg, #3A3E6C 0%, #2A2E4C 100%)",textColor:"#E8DCC4"},normal:{gradient:"linear-gradient(135deg, #8387C3 0%, #6367A3 100%)",textColor:"#FFFFFF"},completed:{gradient:"linear-gradient(135deg, #959BB5 0%, #757B95 100%)",textColor:"#FFFFFF"},infoBar:{background:"rgba(0, 0, 0, 0.25)",textColor:"rgba(255, 255, 255, 0.95)"}},{id:"pink",name:"粉紫色系列",urgent:{gradient:"linear-gradient(135deg, #4B1535 0%, #3B0525 100%)",textColor:"#F3C8DD"},normal:{gradient:"linear-gradient(135deg, #71557A 0%, #61456A 100%)",textColor:"#F3E5F5"},completed:{gradient:"linear-gradient(135deg, #D186A9 0%, #C176A9 100%)",textColor:"#FFFFFF"},infoBar:{background:"rgba(0, 0, 0, 0.25)",textColor:"rgba(255, 255, 255, 0.95)"}},{id:"green",name:"绿色系列",urgent:{gradient:"linear-gradient(135deg, #122B1D 0%, #0A1B0D 100%)",textColor:"#E8F5E9"},normal:{gradient:"linear-gradient(135deg, #537E72 0%, #436E62 100%)",textColor:"#FFFFFF"},completed:{gradient:"linear-gradient(135deg, #9CC97F 0%, #8CB96F 100%)",textColor:"#1B4D3E"},infoBar:{background:"rgba(0, 0, 0, 0.25)",textColor:"rgba(255, 255, 255, 0.95)"}},{id:"nature",name:"自然混合系列",urgent:{gradient:"linear-gradient(135deg, #2D4B48 0%, #1D3B38 100%)",textColor:"#E8F5E9"},normal:{gradient:"linear-gradient(135deg, #5C8966 0%, #4C7956 100%)",textColor:"#FFFFFF"},completed:{gradient:"linear-gradient(135deg, #7BB497 0%, #6BA487 100%)",textColor:"#1A3A2E"},infoBar:{background:"rgba(0, 0, 0, 0.25)",textColor:"rgba(255, 255, 255, 0.95)"}},{id:"flat",name:"现代扁平纯色",urgent:{gradient:"linear-gradient(135deg, #EF4444 0%, #DC2626 100%)",textColor:"#FFFFFF"},normal:{gradient:"linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)",textColor:"#FFFFFF"},completed:{gradient:"linear-gradient(135deg, #10B981 0%, #059669 100%)",textColor:"#FFFFFF"},infoBar:{background:"rgba(0, 0, 0, 0.25)",textColor:"rgba(255, 255, 255, 0.95)"}}];function nae(e){const t=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return Math.abs(t)}(e);return tae[t%tae.length]}function iae(e,t){e.preventDefault(),t()(e)}function aae(e,t){e.stopPropagation(),t()(e)}function rae(e,t){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())}var sae=la('<div class="deck-grid-card svelte-1tz4atw" role="button" tabindex="0"><div class="card-main svelte-1tz4atw"><div class="light-effect svelte-1tz4atw"></div> <button class="menu-btn svelte-1tz4atw" aria-label="更多操作" title="更多操作"><!></button> <div class="deck-title svelte-1tz4atw"> </div></div> <div class="card-info-bar svelte-1tz4atw"><div class="info-left svelte-1tz4atw"><span class="category-name svelte-1tz4atw"> </span></div> <div class="info-center svelte-1tz4atw"><div class="stat-item svelte-1tz4atw"><span class="stat-number svelte-1tz4atw"> </span> <span class="stat-label svelte-1tz4atw"> </span></div> <div class="stat-item svelte-1tz4atw"><span class="stat-number svelte-1tz4atw"> </span> <span class="stat-label svelte-1tz4atw"> </span></div> <div class="stat-item svelte-1tz4atw"><span class="stat-number svelte-1tz4atw"> </span> <span class="stat-label svelte-1tz4atw"> </span></div></div> <div class="info-right svelte-1tz4atw"></div></div></div>');function oae(e,t){if(new.target)return Er({component:oae,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"deck",7),s=Ar(t,"stats",7),o=Ar(t,"colorScheme",7),l=Ar(t,"categoryName",7),c=Ar(t,"onStudy",7),d=Ar(t,"onMenu",7),u=In(n);const h=In(()=>function(e,t,n){const i=e+t+n;return 0===i?"completed":i>20?"urgent":"normal"}(s().newCards,s().learningCards,s().reviewCards)),p=In(()=>o()[bi(h)]),g=In(()=>()=>`background: ${bi(p).gradient}; color: ${bi(p).textColor};`),v=In(()=>()=>`background: ${o().infoBar.background}; color: ${o().infoBar.textColor};`);function f(){c()()}var m={get deck(){return r()},set deck(e){r(e),hn()},get stats(){return s()},set stats(e){s(e),hn()},get colorScheme(){return o()},set colorScheme(e){o(e),hn()},get categoryName(){return l()},set categoryName(e){l(e),hn()},get onStudy(){return c()},set onStudy(e){c(e),hn()},get onMenu(){return d()},set onMenu(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=sae();y.__click=f,y.__keydown=[rae,f],y.__contextmenu=[iae,d];var b=Gt(y),w=Kt(Gt(b),2);w.__click=[aae,d],Ng(Gt(w),{name:"more-horizontal",size:16}),zt(w);var k=Kt(w,2),S=Gt(k,!0);zt(k),zt(b);var x=Kt(b,2),_=Gt(x),C=Gt(_),I=Gt(C,!0);zt(C),zt(_);var D=Kt(_,2),T=Gt(D),M=Gt(T),A=Gt(M,!0);zt(M);var E=Kt(M,2),z=Gt(E,!0);zt(E),zt(T);var P=Kt(T,2),R=Gt(P),$=Gt(R,!0);zt(R);var O=Kt(R,2),L=Gt(O,!0);zt(O),zt(P);var N=Kt(P,2),F=Gt(N),B=Gt(F,!0);zt(F);var j=Kt(F,2),U=Gt(j,!0);zt(j),zt(N),zt(D),Pt(2),zt(x),zt(y),zi((e,t,n,i,a,o)=>{er(y,"aria-label",e),ja(b,t),va(S,r().name),ja(x,n),va(I,l()),va(A,s().newCards),va(z,i),va($,s().learningCards),va(L,a),va(B,s().reviewCards),va(U,o)},[()=>bi(u)("decks.card.ariaLabel").replace("{name}",r().name),()=>bi(g)(),()=>bi(v)(),()=>bi(u)("decks.card.new"),()=>bi(u)("decks.card.learning"),()=>bi(u)("decks.card.review")]),pa(e,y);var V=St(m);return a(),V}ia(["click","keydown","contextmenu"]);var lae=(e,t,n)=>t()(bi(n).id),cae=la('<span class="selected-indicator svelte-1lv1bd5"></span>'),dae=la("<button><!></button>"),uae=la('<div class="category-filter svelte-1lv1bd5"></div>');function hae(e,t){if(new.target)return Er({component:hae,...e});kt(t,!0);let n=Ar(t,"selectedFilter",7),i=Ar(t,"onSelect",7);const a=[{id:"memory",name:"记忆牌组",icon:"📚",colorStart:"#ef4444",colorEnd:"#dc2626"},{id:"reading",name:"渐进式阅读",icon:"📖",colorStart:"#3b82f6",colorEnd:"#2563eb"},{id:"question-bank",name:"题库牌组 🔒",icon:"📝",colorStart:"#10b981",colorEnd:"#059669"}];var r={get selectedFilter(){return n()},set selectedFilter(e){n(e),hn()},get onSelect(){return i()},set onSelect(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=uae();return Ca(s,21,()=>a,_a,(e,t)=>{var a=dae();let r;a.__click=[lae,i,t];var s=Gt(a),o=e=>{pa(e,cae())};xa(s,e=>{n()===bi(t).id&&e(o)}),zt(a),zi((e,n)=>{r=Fa(a,1,"category-dot svelte-1lv1bd5",null,r,e),ja(a,n),er(a,"aria-label",bi(t).name),er(a,"title",bi(t).name)},[()=>({selected:n()===bi(t).id}),()=>function(e){return`background: linear-gradient(135deg, ${e.colorStart}, ${e.colorEnd})`}(bi(t))]),pa(e,a)}),zt(s),pa(e,s),St(r)}function pae(e,t,n,i){bi(t)<n?Ln(t):i()}function gae(e,t){bi(t)>1&&Ln(t,-1)}function vae(e,t){e.target===e.currentTarget&&t()}ia(["click"]),ia(["click","keydown"]);var fae=e=>e.stopPropagation(),mae=(e,t)=>t("practice"),yae=(e,t)=>"Enter"===e.key&&t("practice"),bae=(e,t)=>t("exam"),wae=(e,t)=>"Enter"===e.key&&t("exam"),kae=(e,t)=>t("quiz"),Sae=(e,t)=>"Enter"===e.key&&t("quiz"),xae=la('<section class="config-step active svelte-1xi1vf"><div class="scenario-grid svelte-1xi1vf"><button type="button"><div class="scenario-icon svelte-1xi1vf"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-1xi1vf"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg></div> <div class="scenario-content svelte-1xi1vf"><div class="scenario-title-row svelte-1xi1vf"><h3 class="scenario-title svelte-1xi1vf">常规刷题</h3></div></div></button> <button type="button"><div class="scenario-icon svelte-1xi1vf"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-1xi1vf"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><path d="M9 15l2 2 4-4"></path></svg></div> <div class="scenario-content svelte-1xi1vf"><div class="scenario-title-row svelte-1xi1vf"><h3 class="scenario-title svelte-1xi1vf">考试模式</h3></div></div></button> <button type="button"><div class="scenario-icon svelte-1xi1vf"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-1xi1vf"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg></div> <div class="scenario-content svelte-1xi1vf"><div class="scenario-title-row svelte-1xi1vf"><h3 class="scenario-title svelte-1xi1vf">小测验</h3></div></div></button></div></section>'),_ae=(e,t,n)=>bi(t).customQuestionCount={...bi(t).customQuestionCount,[bi(n)]:null},Cae=(e,t,n)=>bi(t).customQuestionCount={...bi(t).customQuestionCount,[bi(n)]:20},Iae=(e,t,n)=>bi(t).customQuestionCount={...bi(t).customQuestionCount,[bi(n)]:30},Dae=(e,t,n)=>bi(t).customQuestionCount={...bi(t).customQuestionCount,[bi(n)]:50},Tae=(e,t,n,i)=>bi(t).customQuestionCount={...bi(t).customQuestionCount,[bi(n)]:i()},Mae=(e,t)=>bi(t).questionSource="all",Aae=(e,t)=>bi(t).questionSource="untested",Eae=(e,t)=>bi(t).questionSource="incorrect",zae=(e,t)=>bi(t).questionSource="marked",Pae=(e,t,n)=>bi(t).examTimeLimit={...bi(t).examTimeLimit,["practice"===bi(n)?"exam":bi(n)]:void 0},Rae=(e,t,n)=>bi(t).examTimeLimit={...bi(t).examTimeLimit,["practice"===bi(n)?"exam":bi(n)]:15},$ae=(e,t,n)=>bi(t).examTimeLimit={...bi(t).examTimeLimit,["practice"===bi(n)?"exam":bi(n)]:30},Oae=(e,t,n)=>bi(t).examTimeLimit={...bi(t).examTimeLimit,["practice"===bi(n)?"exam":bi(n)]:60},Lae=la('<section class="config-step active svelte-1xi1vf"><div class="config-grid svelte-1xi1vf"><div class="config-group config-section question-count svelte-1xi1vf"><div class="section-header svelte-1xi1vf"><h3 class="section-title svelte-1xi1vf">题目数量</h3></div> <div class="option-buttons svelte-1xi1vf"><button>智能推荐</button> <button>20题</button> <button>30题</button> <button>50题</button> <button>全部</button></div></div> <div class="config-group config-section question-source svelte-1xi1vf"><div class="section-header svelte-1xi1vf"><h3 class="section-title svelte-1xi1vf">题目来源</h3></div> <div class="option-buttons svelte-1xi1vf"><button>全部题目</button> <button>未练习</button> <button>错题本</button> <button>已标记</button></div></div> <div class="config-group config-section time-limit svelte-1xi1vf"><div class="section-header svelte-1xi1vf"><h3 class="section-title svelte-1xi1vf">时间限制</h3></div> <div class="option-buttons svelte-1xi1vf"><button>不限时</button> <button>15分钟</button> <button>30分钟</button> <button>60分钟</button></div></div></div> <div class="config-preview svelte-1xi1vf"><div class="preview-stats svelte-1xi1vf"><div class="stat-item svelte-1xi1vf"><span class="stat-label svelte-1xi1vf">预计题数</span> <span class="stat-value svelte-1xi1vf"> </span></div> <div class="stat-item svelte-1xi1vf"><span class="stat-label svelte-1xi1vf">预计用时</span> <span class="stat-value svelte-1xi1vf"> </span></div></div></div></section>'),Nae=(e,t)=>bi(t).questionTypeRatio={...bi(t).questionTypeRatio,single_choice:parseInt(e.currentTarget.value)},Fae=(e,t)=>bi(t).questionTypeRatio={...bi(t).questionTypeRatio,multiple_choice:parseInt(e.currentTarget.value)},Bae=(e,t)=>bi(t).questionTypeRatio={...bi(t).questionTypeRatio,cloze:parseInt(e.currentTarget.value)},jae=(e,t)=>bi(t).questionTypeRatio={...bi(t).questionTypeRatio,short_answer:parseInt(e.currentTarget.value)},Uae=(e,t)=>bi(t).difficultyDistribution={...bi(t).difficultyDistribution,easy:parseInt(e.currentTarget.value)},Vae=(e,t)=>bi(t).difficultyDistribution={...bi(t).difficultyDistribution,medium:parseInt(e.currentTarget.value)},qae=(e,t)=>bi(t).difficultyDistribution={...bi(t).difficultyDistribution,hard:parseInt(e.currentTarget.value)},Hae=la('<section class="config-step active svelte-1xi1vf"><div class="advanced-config svelte-1xi1vf"><div class="config-section question-type svelte-1xi1vf"><div class="section-header svelte-1xi1vf"><h3 class="section-title svelte-1xi1vf">题型分布</h3></div> <div class="slider-group svelte-1xi1vf"><div class="slider-item svelte-1xi1vf"><div class="slider-header svelte-1xi1vf"><span class="slider-label svelte-1xi1vf">单选题</span> <span class="slider-value svelte-1xi1vf"> </span></div> <input type="range" class="config-slider svelte-1xi1vf" min="0" max="100" step="5"/></div> <div class="slider-item svelte-1xi1vf"><div class="slider-header svelte-1xi1vf"><span class="slider-label svelte-1xi1vf">多选题</span> <span class="slider-value svelte-1xi1vf"> </span></div> <input type="range" class="config-slider svelte-1xi1vf" min="0" max="100" step="5"/></div> <div class="slider-item svelte-1xi1vf"><div class="slider-header svelte-1xi1vf"><span class="slider-label svelte-1xi1vf">填空题</span> <span class="slider-value svelte-1xi1vf"> </span></div> <input type="range" class="config-slider svelte-1xi1vf" min="0" max="100" step="5"/></div> <div class="slider-item svelte-1xi1vf"><div class="slider-header svelte-1xi1vf"><span class="slider-label svelte-1xi1vf">简答题</span> <span class="slider-value svelte-1xi1vf"> </span></div> <input type="range" class="config-slider svelte-1xi1vf" min="0" max="100" step="5"/></div></div></div> <div class="config-section difficulty svelte-1xi1vf"><div class="section-header svelte-1xi1vf"><h3 class="section-title svelte-1xi1vf">难度分布</h3></div> <div class="slider-group svelte-1xi1vf"><div class="slider-item svelte-1xi1vf"><div class="slider-header svelte-1xi1vf"><span class="slider-label svelte-1xi1vf">简单</span> <span class="slider-value svelte-1xi1vf"> </span></div> <input type="range" class="config-slider svelte-1xi1vf" min="0" max="100" step="5"/></div> <div class="slider-item svelte-1xi1vf"><div class="slider-header svelte-1xi1vf"><span class="slider-label svelte-1xi1vf">中等</span> <span class="slider-value svelte-1xi1vf"> </span></div> <input type="range" class="config-slider svelte-1xi1vf" min="0" max="100" step="5"/></div> <div class="slider-item svelte-1xi1vf"><div class="slider-header svelte-1xi1vf"><span class="slider-label svelte-1xi1vf">困难</span> <span class="slider-value svelte-1xi1vf"> </span></div> <input type="range" class="config-slider svelte-1xi1vf" min="0" max="100" step="5"/></div></div></div> <div class="config-section advanced-options svelte-1xi1vf"><div class="section-header svelte-1xi1vf"><h3 class="section-title svelte-1xi1vf">其他选项</h3></div> <div class="checkbox-group svelte-1xi1vf"><label class="checkbox-item svelte-1xi1vf"><input type="checkbox" class="config-checkbox svelte-1xi1vf"/> <span class="checkbox-custom svelte-1xi1vf"></span> <div class="checkbox-content svelte-1xi1vf"><span class="checkbox-title svelte-1xi1vf">随机题目顺序</span> <span class="checkbox-desc svelte-1xi1vf">打乱题目出现顺序</span></div></label> <label class="checkbox-item svelte-1xi1vf"><input type="checkbox" class="config-checkbox svelte-1xi1vf"/> <span class="checkbox-custom svelte-1xi1vf"></span> <div class="checkbox-content svelte-1xi1vf"><span class="checkbox-title svelte-1xi1vf">随机选项顺序</span> <span class="checkbox-desc svelte-1xi1vf">打乱选择题选项顺序</span></div></label> <label class="checkbox-item svelte-1xi1vf"><input type="checkbox" class="config-checkbox svelte-1xi1vf"/> <span class="checkbox-custom svelte-1xi1vf"></span> <div class="checkbox-content svelte-1xi1vf"><span class="checkbox-title svelte-1xi1vf">自动保存进度</span> <span class="checkbox-desc svelte-1xi1vf">自动保存答题进度</span></div></label></div></div></div></section>'),Wae=la('<footer class="modal-footer svelte-1xi1vf"><button class="btn-secondary svelte-1xi1vf">上一步</button> <button class="btn-primary svelte-1xi1vf"> </button></footer>'),Gae=la('<div class="modal-overlay svelte-1xi1vf" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-container svelte-1xi1vf" role="dialog" tabindex="0"><header class="modal-header svelte-1xi1vf"><div class="header-left svelte-1xi1vf"><h1 class="modal-title svelte-1xi1vf">刷题模式配置</h1></div> <div class="header-center svelte-1xi1vf"><span class="bank-name svelte-1xi1vf"> </span></div> <div class="header-right svelte-1xi1vf"><button class="close-button svelte-1xi1vf" aria-label="关闭"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg></button></div></header> <main class="modal-content svelte-1xi1vf"><!> <!> <!></main> <!></div></div>');function Qae(e,t){if(new.target)return Er({component:Qae,...e});kt(t,!0);let n=Ar(t,"open",7),i=Ar(t,"bankName",7),a=Ar(t,"totalQuestions",7),r=Ar(t,"onSelect",7),s=Ar(t,"onCancel",7),o=Pn(1),l=Pn("practice"),c=Pn(Ot({questionTypeRatio:{single_choice:40,multiple_choice:30,cloze:20,short_answer:10},difficultyDistribution:{easy:20,medium:50,hard:30},questionSource:"all",customQuestionCount:{practice:null,exam:null,quiz:10},examTimeLimit:{exam:60,quiz:10},options:{shuffleQuestions:!0,shuffleOptions:!0,autoSave:!0}}));bi(c).options||(bi(c).options={shuffleQuestions:!0,shuffleOptions:!0,autoSave:!0});const d={practice:{questionSource:"all",customQuestionCount:{practice:null,exam:null,quiz:10},questionTypeRatio:{single_choice:40,multiple_choice:30,cloze:20,short_answer:10},difficultyDistribution:{easy:30,medium:50,hard:20}},exam:{questionSource:"all",customQuestionCount:{practice:null,exam:50,quiz:10},examTimeLimit:{exam:60,quiz:10},questionTypeRatio:{single_choice:60,multiple_choice:30,cloze:10,short_answer:0},difficultyDistribution:{easy:20,medium:40,hard:40}},quiz:{questionSource:"all",customQuestionCount:{practice:null,exam:null,quiz:10},examTimeLimit:{exam:60,quiz:15},questionTypeRatio:{single_choice:50,multiple_choice:35,cloze:15,short_answer:0},difficultyDistribution:{easy:40,medium:40,hard:20}}};function u(e){$n(l,e,!0);const t=d[e];t&&$n(c,{...bi(c),...t},!0),$n(o,2)}function h(){r()(bi(l),bi(c)),new ge.Notice("配置已应用，开始刷题")}function p(){"function"==typeof s()&&s()()}function g(e){"Escape"===e.key?p():(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),h())}function v(){var e;const t=null==(e=bi(c).customQuestionCount)?void 0:e[bi(l)];return null==t?a():Math.min(t,a())}function f(){const e=v(),t=Math.ceil(1.5*e);if(t<60)return`${t}分钟`;{const e=Math.floor(t/60),n=t%60;return n>0?`${e}小时${n}分钟`:`${e}小时`}}var m={get open(){return n()},set open(e){n(e),hn()},get bankName(){return i()},set bankName(e){i(e),hn()},get totalQuestions(){return a()},set totalQuestions(e){a(e),hn()},get onSelect(){return r()},set onSelect(e){r(e),hn()},get onCancel(){return s()},set onCancel(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=ha();na("keydown",Ft,g);var b=Qt(y),w=e=>{var t=Gae();t.__click=[vae,p],t.__keydown=g;var n=Gt(t);n.__click=[fae],n.__keydown=g;var r=Gt(n),s=Kt(Gt(r),2),d=Gt(s),m=Gt(d,!0);zt(d),zt(s);var y=Kt(s,2);Gt(y).__click=p,zt(y),zt(r);var b=Kt(r,2),w=Gt(b),k=e=>{var t=xae(),n=Gt(t),i=Gt(n);let a;i.__click=[mae,u],i.__keydown=[yae,u];var r=Kt(i,2);let s;r.__click=[bae,u],r.__keydown=[wae,u];var o=Kt(r,2);let c;o.__click=[kae,u],o.__keydown=[Sae,u],zt(n),zt(t),zi((e,t,n)=>{a=Fa(i,1,"scenario-card svelte-1xi1vf",null,a,e),s=Fa(r,1,"scenario-card svelte-1xi1vf",null,s,t),c=Fa(o,1,"scenario-card svelte-1xi1vf",null,c,n)},[()=>({selected:"practice"===bi(l)}),()=>({selected:"exam"===bi(l)}),()=>({selected:"quiz"===bi(l)})]),pa(e,t)};xa(w,e=>{1===bi(o)&&e(k)});var S=Kt(w,2),x=e=>{var t=Lae(),n=Gt(t),i=Gt(n),r=Kt(Gt(i),2),s=Gt(r);let o;s.__click=[_ae,c,l];var d=Kt(s,2);let u;d.__click=[Cae,c,l];var h=Kt(d,2);let p;h.__click=[Iae,c,l];var g=Kt(h,2);let m;g.__click=[Dae,c,l];var y=Kt(g,2);let b;y.__click=[Tae,c,l,a],zt(r),zt(i);var w=Kt(i,2),k=Kt(Gt(w),2),S=Gt(k);let x;S.__click=[Mae,c];var _=Kt(S,2);let C;_.__click=[Aae,c];var I=Kt(_,2);let D;I.__click=[Eae,c];var T=Kt(I,2);let M;T.__click=[zae,c],zt(k),zt(w);var A=Kt(w,2),E=Kt(Gt(A),2),z=Gt(E);let P;z.__click=[Pae,c,l];var R=Kt(z,2);let $;R.__click=[Rae,c,l];var O=Kt(R,2);let L;O.__click=[$ae,c,l];var N=Kt(O,2);let F;N.__click=[Oae,c,l],zt(E),zt(A),zt(n);var B=Kt(n,2),j=Gt(B),U=Gt(j),V=Kt(Gt(U),2),q=Gt(V);zt(V),zt(U);var H=Kt(U,2),W=Kt(Gt(H),2),G=Gt(W,!0);zt(W),zt(H),zt(j),zt(B),zt(t),zi((e,t,n,i,a,r,l,c,v,f,w,k,A,E,B)=>{o=Fa(s,1,"option-btn svelte-1xi1vf",null,o,e),u=Fa(d,1,"option-btn svelte-1xi1vf",null,u,t),p=Fa(h,1,"option-btn svelte-1xi1vf",null,p,n),m=Fa(g,1,"option-btn svelte-1xi1vf",null,m,i),b=Fa(y,1,"option-btn svelte-1xi1vf",null,b,a),x=Fa(S,1,"option-btn svelte-1xi1vf",null,x,r),C=Fa(_,1,"option-btn svelte-1xi1vf",null,C,l),D=Fa(I,1,"option-btn svelte-1xi1vf",null,D,c),M=Fa(T,1,"option-btn svelte-1xi1vf",null,M,v),P=Fa(z,1,"option-btn svelte-1xi1vf",null,P,f),$=Fa(R,1,"option-btn svelte-1xi1vf",null,$,w),L=Fa(O,1,"option-btn svelte-1xi1vf",null,L,k),F=Fa(N,1,"option-btn svelte-1xi1vf",null,F,A),va(q,`${null!=E?E:""}题`),va(G,B)},[()=>{var e;return{active:null===(null==(e=bi(c).customQuestionCount)?void 0:e[bi(l)])}},()=>{var e;return{active:20===(null==(e=bi(c).customQuestionCount)?void 0:e[bi(l)])}},()=>{var e;return{active:30===(null==(e=bi(c).customQuestionCount)?void 0:e[bi(l)])}},()=>{var e;return{active:50===(null==(e=bi(c).customQuestionCount)?void 0:e[bi(l)])}},()=>{var e;return{active:(null==(e=bi(c).customQuestionCount)?void 0:e[bi(l)])===a()}},()=>({active:"all"===bi(c).questionSource}),()=>({active:"untested"===bi(c).questionSource}),()=>({active:"incorrect"===bi(c).questionSource}),()=>({active:"marked"===bi(c).questionSource}),()=>{var e;return{active:!(null==(e=bi(c).examTimeLimit)?void 0:e["practice"===bi(l)?"exam":bi(l)])}},()=>{var e;return{active:15===(null==(e=bi(c).examTimeLimit)?void 0:e["practice"===bi(l)?"exam":bi(l)])}},()=>{var e;return{active:30===(null==(e=bi(c).examTimeLimit)?void 0:e["practice"===bi(l)?"exam":bi(l)])}},()=>{var e;return{active:60===(null==(e=bi(c).examTimeLimit)?void 0:e["practice"===bi(l)?"exam":bi(l)])}},v,f]),pa(e,t)};xa(S,e=>{2===bi(o)&&e(x)});var _=Kt(S,2),C=e=>{var t=Hae(),n=Gt(t),i=Gt(n),a=Kt(Gt(i),2),r=Gt(a),s=Gt(r),o=Kt(Gt(s),2),l=Gt(o);zt(o),zt(s);var d=Kt(s,2);Za(d),d.__input=[Nae,c],zt(r);var u=Kt(r,2),h=Gt(u),p=Kt(Gt(h),2),g=Gt(p);zt(p),zt(h);var v=Kt(h,2);Za(v),v.__input=[Fae,c],zt(u);var f=Kt(u,2),m=Gt(f),y=Kt(Gt(m),2),b=Gt(y);zt(y),zt(m);var w=Kt(m,2);Za(w),w.__input=[Bae,c],zt(f);var k=Kt(f,2),S=Gt(k),x=Kt(Gt(S),2),_=Gt(x);zt(x),zt(S);var C=Kt(S,2);Za(C),C.__input=[jae,c],zt(k),zt(a),zt(i);var I=Kt(i,2),D=Kt(Gt(I),2),T=Gt(D),M=Gt(T),A=Kt(Gt(M),2),E=Gt(A);zt(A),zt(M);var z=Kt(M,2);Za(z),z.__input=[Uae,c],zt(T);var P=Kt(T,2),R=Gt(P),$=Kt(Gt(R),2),O=Gt($);zt($),zt(R);var L=Kt(R,2);Za(L),L.__input=[Vae,c],zt(P);var N=Kt(P,2),F=Gt(N),B=Kt(Gt(F),2),j=Gt(B);zt(B),zt(F);var U=Kt(F,2);Za(U),U.__input=[qae,c],zt(N),zt(D),zt(I);var V=Kt(I,2),q=Kt(Gt(V),2),H=Gt(q),W=Gt(H);Za(W),Pt(4),zt(H);var G=Kt(H,2),Q=Gt(G);Za(Q),Pt(4),zt(G);var K=Kt(G,2),Z=Gt(K);Za(Z),Pt(4),zt(K),zt(q),zt(V),zt(n),zt(t),zi(()=>{var e,t,n,i,a,r,s,o,u,h,p,f,m,y,k,S,x,I,D,T,M;va(l,`${null!=(t=(null==(e=bi(c).questionTypeRatio)?void 0:e.single_choice)||40)?t:""}%`),Ya(d,(null==(n=bi(c).questionTypeRatio)?void 0:n.single_choice)||40),va(g,`${null!=(a=(null==(i=bi(c).questionTypeRatio)?void 0:i.multiple_choice)||30)?a:""}%`),Ya(v,(null==(r=bi(c).questionTypeRatio)?void 0:r.multiple_choice)||30),va(b,`${null!=(o=(null==(s=bi(c).questionTypeRatio)?void 0:s.cloze)||20)?o:""}%`),Ya(w,(null==(u=bi(c).questionTypeRatio)?void 0:u.cloze)||20),va(_,`${null!=(p=(null==(h=bi(c).questionTypeRatio)?void 0:h.short_answer)||10)?p:""}%`),Ya(C,(null==(f=bi(c).questionTypeRatio)?void 0:f.short_answer)||10),va(E,`${null!=(y=(null==(m=bi(c).difficultyDistribution)?void 0:m.easy)||30)?y:""}%`),Ya(z,(null==(k=bi(c).difficultyDistribution)?void 0:k.easy)||30),va(O,`${null!=(x=(null==(S=bi(c).difficultyDistribution)?void 0:S.medium)||50)?x:""}%`),Ya(L,(null==(I=bi(c).difficultyDistribution)?void 0:I.medium)||50),va(j,`${null!=(T=(null==(D=bi(c).difficultyDistribution)?void 0:D.hard)||20)?T:""}%`),Ya(U,(null==(M=bi(c).difficultyDistribution)?void 0:M.hard)||20)}),fr(W,()=>bi(c).options.shuffleQuestions,e=>bi(c).options.shuffleQuestions=e),fr(Q,()=>bi(c).options.shuffleOptions,e=>bi(c).options.shuffleOptions=e),fr(Z,()=>bi(c).options.autoSave,e=>bi(c).options.autoSave=e),pa(e,t)};xa(_,e=>{3===bi(o)&&e(C)}),zt(b);var I=Kt(b,2),D=e=>{var t=Wae(),n=Gt(t);n.__click=[gae,o];var i=Kt(n,2);i.__click=[pae,o,3,h];var a=Gt(i,!0);zt(i),zt(t),zi(()=>{n.disabled=1===bi(o),va(a,3===bi(o)?"开始刷题":"下一步")}),pa(e,t)};xa(I,e=>{bi(o)>1&&e(D)}),zt(n),zt(t),zi(()=>va(m,i())),pa(e,t)};return xa(b,e=>{n()&&e(w)}),pa(e,y),St(m)}function Kae(){const e=getComputedStyle(document.body);return{text:e.getPropertyValue("--text-normal").trim()||"#000",textMuted:e.getPropertyValue("--text-muted").trim()||"#666",accent:e.getPropertyValue("--interactive-accent").trim()||"#7c3aed",background:e.getPropertyValue("--background-primary").trim()||"#fff",backgroundSecondary:e.getPropertyValue("--background-secondary").trim()||"#f5f5f5",border:e.getPropertyValue("--background-modifier-border").trim()||"#ddd",success:e.getPropertyValue("--text-success").trim()||"#10b981",warning:e.getPropertyValue("--text-warning").trim()||"#f59e0b",error:e.getPropertyValue("--text-error").trim()||"#ef4444"}}function Zae(e,t=.25,n=.05){const{r:i,g:a,b:r}=function(e){const t={r:124,g:58,b:237};try{if(e.match(/^#?[0-9a-fA-F]{6}$/)){const t=e.replace("#",""),n=parseInt(t.substring(0,2),16),i=parseInt(t.substring(2,4),16),a=parseInt(t.substring(4,6),16);if(!isNaN(n)&&!isNaN(i)&&!isNaN(a))return{r:n,g:i,b:a}}const n=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return n?{r:parseInt(n[1]),g:parseInt(n[2]),b:parseInt(n[3])}:(_e.warn(`[createGradient] 无法解析颜色: ${e}, 使用默认颜色`),t)}catch(n){return _e.error(`[createGradient] 颜色解析错误: ${e}`,n),t}}(e);return{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:`rgba(${i}, ${a}, ${r}, ${t})`},{offset:1,color:`rgba(${i}, ${a}, ${r}, ${n})`}]}}ia(["click","keydown","input"]);var Yae=la('<div class="ewma-tab svelte-11z1qdn"><div class="chart-container svelte-11z1qdn"><div class="chart svelte-11z1qdn"></div></div></div>');function Xae(e,t){if(new.target)return Er({component:Xae,...e});kt(t,!0);let n,i=Ar(t,"questionBank",7),a=Ar(t,"plugin",7),r=null;function s(){if(n)try{const e=Kae();if(!e.accent||!e.success||!e.warning)return void _e.error("[EWMA] Invalid theme colors:",e);const t={accent:e.accent||"#7c3aed",success:e.success||"#10b981",warning:e.warning||"#f59e0b",textMuted:e.textMuted||"#6b7280",backgroundSecondary:e.backgroundSecondary||"#f3f4f6",border:e.border||"#e5e7eb",text:e.text||"#374151"};_e.debug("[EWMA] 使用安全颜色配置:",t),r=EQ.init(n);const{dates:i,ewmaData:a,historicalData:s,confidenceData:o}=function(){const e=[],t=[],n=[],i=[],a=new Date;a.setDate(a.getDate()-29);for(let r=0;r<30;r++){const s=new Date(a);s.setDate(a.getDate()+r),e.push(s.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"}));const o=45+1.2*r,l=8*(Math.random()-.5);t.push(Math.max(0,Math.min(100,o+l))),n.push(Math.max(0,Math.min(100,55+.5*r+.5*l))),i.push(Math.min(.95,.3+.022*r))}return{dates:e,ewmaData:t,historicalData:n,confidenceData:i}}(),l={backgroundColor:"transparent",tooltip:{trigger:"axis",backgroundColor:t.backgroundSecondary,borderColor:t.border,textStyle:{color:t.text},formatter(e){let t=`<div style="font-weight: 600; margin-bottom: 4px;">${e[0].axisValue}</div>`;return e.forEach(e=>{const n=e.color,i="EWMA掌握度"===e.seriesName||"历史平均"===e.seriesName?e.value.toFixed(1)+"%":e.value.toFixed(2);t+=`<div style="margin: 2px 0;">\n              <span style="display: inline-block; width: 10px; height: 10px; background: ${n}; border-radius: 50%; margin-right: 8px;"></span>\n              ${e.seriesName}: <span style="font-weight: 600;">${i}</span>\n            </div>`}),t}},legend:{show:!0,top:10,textStyle:{color:t.text},itemGap:20},grid:{left:"3%",right:"3%",bottom:"15%",top:"15%",containLabel:!0},xAxis:{type:"category",data:i,axisLine:{lineStyle:{color:t.border}},axisLabel:{color:t.textMuted,fontSize:11,rotate:45},axisTick:{show:!1}},yAxis:[{type:"value",name:"掌握度 (%)",nameTextStyle:{color:t.textMuted,fontSize:12},min:0,max:100,axisLine:{lineStyle:{color:t.border}},axisLabel:{color:t.textMuted,fontSize:11,formatter:"{value}%"},splitLine:{lineStyle:{color:t.border,type:"dashed",opacity:.6}}},{type:"value",name:"置信度",nameTextStyle:{color:t.textMuted,fontSize:12},min:0,max:1,axisLine:{lineStyle:{color:t.border}},axisLabel:{color:t.textMuted,fontSize:11,formatter:"{value}"},splitLine:{show:!1}}],series:[{name:"EWMA掌握度",type:"line",data:a,smooth:!0,lineStyle:{color:t.accent,width:3},itemStyle:{color:t.accent,borderWidth:2},symbolSize:6,areaStyle:{color:Zae(t.accent,.15,.03)}},{name:"历史平均",type:"line",data:s,smooth:!0,lineStyle:{color:t.textMuted,width:2,type:"dashed"},itemStyle:{color:t.textMuted},symbolSize:4},{name:"目标掌握线",type:"line",data:i.map(()=>80),lineStyle:{color:t.success,width:2,type:"solid"},itemStyle:{color:t.success},symbol:"none",markLine:{silent:!0,data:[{yAxis:80}],lineStyle:{color:t.success,width:1,type:"dashed"}}},{name:"置信度",type:"line",yAxisIndex:1,data:o,smooth:!0,lineStyle:{color:t.warning,width:2},itemStyle:{color:t.warning},symbolSize:4}]};r.setOption(l),_e.debug("[EWMA] Chart initialized successfully")}catch(e){_e.error("[EWMA] Failed to initialize chart:",e),r&&(r.dispose(),r=null)}else _e.warn("[EWMA] Chart container not available")}Pr(()=>{setTimeout(()=>{s()},100);const e=new ResizeObserver(()=>{r&&r.resize()});return n&&e.observe(n),()=>{e.disconnect()}}),Rr(()=>{r&&(r.dispose(),r=null)});var o={get questionBank(){return i()},set questionBank(e){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=Yae(),c=Gt(l);return kr(Gt(c),e=>n=e,()=>n),zt(c),zt(l),pa(e,l),St(o)}function Jae(e,t){t((new Date).toISOString().split("T")[0])}var ere=(e,t)=>t(-1),tre=(e,t,n,i,a)=>{$n(t,bi(n).value,!0);const r=i(),s=r.find(e=>e.tests.length>0);s?$n(a,s.date,!0):r.length>0&&$n(a,r[Math.floor(r.length/2)].date,!0)},nre=la("<button> </button>"),ire=(e,t)=>t(1),are=(e,t,n)=>t(bi(n).date),rre=la("<div></div>"),sre=la('<button><div class="date-number svelte-18cs65n"> </div> <div class="date-day svelte-18cs65n"> </div> <div class="activity-dots svelte-18cs65n"></div></button>'),ore=la('<div><div class="test-info svelte-18cs65n"><div class="test-date svelte-18cs65n"> </div> <div class="test-mode svelte-18cs65n"> </div></div> <div class="test-stats svelte-18cs65n"><div class="stat-item svelte-18cs65n"><span class="stat-value svelte-18cs65n"> </span> <span class="stat-label svelte-18cs65n">得分</span></div> <div class="stat-item svelte-18cs65n"><span class="stat-value svelte-18cs65n"> </span> <span class="stat-label svelte-18cs65n">用时</span></div> <div class="stat-item svelte-18cs65n"><span><i></i></span> <span class="stat-label svelte-18cs65n">等级</span></div></div></div>'),lre=la('<div class="no-tests svelte-18cs65n">该日期暂无测试记录</div>'),cre=la('<div class="history-tab svelte-18cs65n"><div class="calendar-container svelte-18cs65n"><div class="month-selector svelte-18cs65n"><button class="month-nav prev svelte-18cs65n"><!></button> <div class="month-tabs svelte-18cs65n"></div> <button class="month-nav next svelte-18cs65n"><!></button> <div class="history-filter svelte-18cs65n"><button class="today-btn svelte-18cs65n" title="快速导航到今天"><!> 今天</button> <select class="filter-select svelte-18cs65n"><option>全部测试</option><option>常规刷题</option><option>考试模式</option><option>小测验</option></select></div></div> <div class="date-selector svelte-18cs65n"></div></div> <div class="test-records svelte-18cs65n"><h4 class="svelte-18cs65n"> </h4> <div class="test-list svelte-18cs65n"></div></div></div>');function dre(e,t){if(new.target)return Er({component:dre,...e});kt(t,!0);let n=Ar(t,"questionBank",7),i=Ar(t,"plugin",7),a=Pn(0);function r(){const e=new Date,t=e.getFullYear(),n=e.getMonth()+1,i=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],r=[];for(let s=-1;s<=1;s++){let e=n+bi(a)+s,o=t;for(;e<=0;)e+=12,o-=1;for(;e>12;)e-=12,o+=1;r.push({value:e,year:o,label:i[e-1],fullLabel:`${o}年${i[e-1]}`})}return r}let s=In(r),o=Pn("2025-11-27"),l=Pn((new Date).getMonth()+1),c=Pn("all"),d=Pn(Ot({}));function u(){const e={};return bi(s).forEach(t=>{const n=t.year,i=t.value,a=3+Math.floor(6*Math.random()),r=new Date(n,i,0).getDate();for(let s=0;s<a;s++){const t=1+Math.floor(Math.random()*r),a=`${n}-${String(i).padStart(2,"0")}-${String(t).padStart(2,"0")}`,s=1+Math.floor(3*Math.random());e[a]=[];for(let n=0;n<s;n++)e[a].push({isCorrect:Math.random()>.25,mode:["practice","exam","quiz"][Math.floor(3*Math.random())],timestamp:`${a}T${String(9+Math.floor(12*Math.random())).padStart(2,"0")}:${String(Math.floor(60*Math.random())).padStart(2,"0")}:00`,score:60+35*Math.random(),timeSpent:3e5+12e5*Math.random()})}}),e}function h(){const e=[],t=new Date(bi(o)),n=new Date(t);n.setDate(t.getDate()-60);const i=new Date(t);i.setDate(t.getDate()+60);const a=new Date(n);for(;a<=i;){const t=a.toISOString().split("T")[0],n=a.toLocaleDateString("zh-CN",{weekday:"short"}),i=a.getDate();e.push({date:t,day:i,dayName:n,tests:bi(d)[t]||[]}),a.setDate(a.getDate()+1)}return e}let p,g=In(()=>{bi(o),bi(k),bi(l),bi(a);const e=h(),t=e.findIndex(e=>e.date===bi(o));if(t>=0){const n="undefined"!=typeof window?.7*window.innerWidth:800,i=62,a=Math.floor(n/i),r=Math.floor(a/2),s=Math.max(0,t-r-5),o=Math.min(e.length-1,t+r+5);return e.slice(s,o+1)}return e});function v(e){return e?e>=85?"high":e>=70?"medium":"low":"low"}function f(e){$n(a,bi(a)+e);const t=bi(s)[1];$n(l,t.value,!0);const n=Math.ceil(new Date(t.year,t.value,0).getDate()/2),i=`${t.year}-${String(t.value).padStart(2,"0")}-${String(n).padStart(2,"0")}`;$n(o,i),setTimeout(()=>{b(i)},150),_e.debug(`[MonthSelector] 切换到${t.label}，居中日期: ${i}`)}let m=null,y=null;function b(e){if(!p)return;const t=e||bi(o);t!==y&&(m&&clearTimeout(m),m=window.setTimeout(()=>{requestAnimationFrame(()=>{const e=p.querySelector(`[data-date="${t}"]`);if(e){const n=p.getBoundingClientRect(),i=e.getBoundingClientRect(),a=i.left-n.left-n.width/2+i.width/2;p.scrollBy({left:a,behavior:"smooth"}),y=t,_e.debug(`[DateSelector] 高性能居中: ${t}`)}})},16))}function w(e){$n(o,e,!0);const t=new Date(e),n=t.getMonth()+1,i=t.getFullYear();bi(s).find(e=>e.value===n&&e.year===i)&&bi(l)!==n&&$n(l,n),setTimeout(()=>{b(e)},100),_e.debug(`[DateSelector] 选中日期: ${e}, 真实视觉居中`)}let k=Pn(0);function S(){"undefined"!=typeof window&&($n(k,window.innerWidth,!0),setTimeout(()=>{b()},200))}Pr(()=>(async function(){try{if(!i().questionBankService)return _e.warn("[HistoryTab] QuestionBank service not available"),void $n(d,u(),!0);const e=await i().questionBankService.getQuestionsByBank(n().id);if(e&&Array.isArray(e)){const t={};e.forEach(e=>{e.reviewHistory&&Array.isArray(e.reviewHistory)&&e.reviewHistory.forEach(e=>{const n=new Date(e.review).toISOString().split("T")[0];t[n]||(t[n]=[]),t[n].push({isCorrect:e.rating>=3,mode:"practice",timestamp:e.review,score:20*e.rating,timeSpent:0})})}),Object.keys(t).length>0?$n(d,t,!0):(_e.warn("[HistoryTab] No review history found, using fallback data"),$n(d,u(),!0))}else _e.warn("[HistoryTab] No questions found, using fallback data"),$n(d,u(),!0)}catch(e){_e.error("[HistoryTab] Failed to load test history:",e),$n(d,u(),!0)}}(),"undefined"!=typeof window&&($n(k,window.innerWidth,!0),window.addEventListener("resize",S)),setTimeout(()=>{b()},300),()=>{"undefined"!=typeof window&&window.removeEventListener("resize",S)}));var x={get questionBank(){return n()},set questionBank(e){n(e),hn()},get plugin(){return i()},set plugin(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},_=cre(),C=Gt(_),I=Gt(C),D=Gt(I);D.__click=[ere,f],m5(Gt(D),{name:"chevron-left",size:16}),zt(D);var T=Kt(D,2);Ca(T,21,()=>bi(s),_a,(e,t)=>{var n=nre();let i;n.__click=[tre,l,t,h,o];var a=Gt(n,!0);zt(n),zi(e=>{i=Fa(n,1,"month-tab svelte-18cs65n",null,i,e),va(a,bi(t).label)},[()=>({active:bi(l)===bi(t).value})]),pa(e,n)}),zt(T);var M=Kt(T,2);M.__click=[ire,f],m5(Gt(M),{name:"chevron-right",size:16}),zt(M);var A=Kt(M,2),E=Gt(A);E.__click=[Jae,w],m5(Gt(E),{name:"calendar",size:14}),Pt(),zt(E);var z=Kt(E,2),P=Gt(z);P.value=P.__value="all";var R=Kt(P);R.value=R.__value="practice";var $=Kt(R);$.value=$.__value="exam";var O=Kt($);O.value=O.__value="quiz",zt(z),zt(A),zt(I);var L=Kt(I,2);Ca(L,21,()=>bi(g),_a,(e,t)=>{var n=sre();let i;n.__click=[are,w,t];var a=Gt(n),r=Gt(a,!0);zt(a);var s=Kt(a,2),l=Gt(s,!0);zt(s);var c=Kt(s,2);Ca(c,21,()=>bi(t).tests,_a,(e,t)=>{var n=rre();zi(e=>Fa(n,1,e,"svelte-18cs65n"),[()=>$a(function(e){return`dot ${v(e.score)}-score`}(bi(t)))]),pa(e,n)}),zt(c),zt(n),zi(e=>{i=Fa(n,1,"date-item svelte-18cs65n",null,i,e),er(n,"data-date",bi(t).date),va(r,bi(t).day),va(l,bi(t).dayName)},[()=>({active:bi(o)===bi(t).date})]),pa(e,n)}),zt(L),kr(L,e=>p=e,()=>p),zt(C);var N=Kt(C,2),F=Gt(N),B=Gt(F);zt(F);var j=Kt(F,2);return Ca(j,21,()=>function(e){const t=bi(d)[e]||[];return"all"===bi(c)?t:t.filter(e=>e.mode===bi(c))}(bi(o)),_a,(e,t)=>{var n=ore(),i=Gt(n),a=Gt(i),r=Gt(a);zt(a);var s=Kt(a,2),l=Gt(s);zt(s),zt(i);var c=Kt(i,2),d=Gt(c),u=Gt(d),h=Gt(u);zt(u),Pt(2),zt(d);var p=Kt(d,2),g=Gt(p),f=Gt(g,!0);zt(g),Pt(2),zt(p);var m=Kt(p,2),y=Gt(m),b=Gt(y);zt(y),Pt(2),zt(m),zt(c),zt(n),zi((e,t,i,a,s,c,d)=>{var u;Fa(n,1,`test-item ${null!=e?e:""}-score`,"svelte-18cs65n"),va(r,`${null!=(u=bi(o))?u:""} ${null!=t?t:""}`),va(l,`${null!=i?i:""} • ${Math.floor(15*Math.random())+10}题`),va(h,`${null!=a?a:""}%`),va(f,s),Fa(y,1,`stat-value score-${null!=c?c:""}`,"svelte-18cs65n"),Fa(b,1,`fas fa-${null!=d?d:""}`,"svelte-18cs65n")},[()=>v(bi(t).score),()=>{return e=bi(t).timestamp,new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});var e},()=>{return{practice:"常规刷题",exam:"考试模式",quiz:"小测验"}[e=bi(t).mode]||e;var e},()=>{var e;return(null==(e=bi(t).score)?void 0:e.toFixed(1))||"-"},()=>{return(e=bi(t).timeSpent)?`${Math.floor(e/6e4)}分钟`:"-";var e},()=>v(bi(t).score),()=>{return(e=bi(t).score)?e>=85?"trophy":e>=70?"medal":"flag":"flag";var e}]),pa(e,n)},e=>{pa(e,lre())}),zt(j),zt(N),zt(_),zi(e=>va(B,`${null!=e?e:""} 测试记录`),[()=>new Date(bi(o)).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})]),qa(z,()=>bi(c),e=>$n(c,e)),pa(e,_),St(x)}ia(["click"]);var ure=(e,t)=>t("ewma"),hre=(e,t)=>t("history"),pre=la('<div class="analytics-container svelte-14edjfw"><div class="tabs-nav svelte-14edjfw"><button>EWMA分析</button> <button>历史记录</button></div> <div class="tab-content svelte-14edjfw"><div><!></div> <div><!></div></div></div>');function gre(e,t){if(new.target)return Er({component:gre,...e});kt(t,!0);let n=Ar(t,"open",15),i=Ar(t,"onClose",7),a=Ar(t,"plugin",7),r=Ar(t,"questionBank",7),s=Pn("ewma");function o(e){$n(s,e,!0)}var l={get open(){return n()},set open(e){n(e),hn()},get onClose(){return i()},set onClose(e){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get questionBank(){return r()},set questionBank(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=ha(),d=Qt(c),u=e=>{zx(e,{get plugin(){return a()},get title(){var e;return`${null!=(e=r().name)?e:""} - 题库分析`},get onClose(){return i()},keyboard:!0,get open(){return n()},set open(e){n(e)},children:(e,t)=>{var n=pre(),i=Gt(n),l=Gt(i);let c;l.__click=[ure,o];var d=Kt(l,2);let u;d.__click=[hre,o],zt(i);var h=Kt(i,2),p=Gt(h);let g;var v=Gt(p),f=e=>{Xae(e,{get questionBank(){return r()},get plugin(){return a()}})};xa(v,e=>{"ewma"===bi(s)&&e(f)}),zt(p);var m=Kt(p,2);let y;var b=Gt(m),w=e=>{dre(e,{get questionBank(){return r()},get plugin(){return a()}})};xa(b,e=>{"history"===bi(s)&&e(w)}),zt(m),zt(h),zt(n),zi((e,t,n,i)=>{c=Fa(l,1,"tab-btn svelte-14edjfw",null,c,e),u=Fa(d,1,"tab-btn svelte-14edjfw",null,u,t),g=Fa(p,1,"tab-pane svelte-14edjfw",null,g,n),y=Fa(m,1,"tab-pane svelte-14edjfw",null,y,i)},[()=>({active:"ewma"===bi(s)}),()=>({active:"history"===bi(s)}),()=>({hidden:"ewma"!==bi(s)}),()=>({hidden:"history"!==bi(s)})]),pa(e,n)},$$slots:{default:!0}})};return xa(d,e=>{n()&&e(u)}),pa(e,c),St(l)}function vre(e,t){e.preventDefault(),t()(e)}function fre(e,t){e.stopPropagation(),t()(e)}function mre(e,t,n){("Enter"===e.key||" "===e.key)&&t().total>0&&(e.preventDefault(),n())}ia(["click"]),ia(["click"]);var yre=la('<div class="empty-badge svelte-1vhnofy">空题库</div>'),bre=la('<div class="accuracy-display svelte-1vhnofy"> </div>'),wre=la('<div role="button" tabindex="0"><div class="card-main svelte-1vhnofy"><div class="light-effect svelte-1vhnofy"></div> <button class="menu-btn svelte-1vhnofy" aria-label="更多操作" title="更多操作"><!></button> <div class="bank-title svelte-1vhnofy"> </div> <!></div> <div class="card-info-bar svelte-1vhnofy"><div class="info-left svelte-1vhnofy"><!></div> <div class="info-center svelte-1vhnofy"><div class="stat-item svelte-1vhnofy"><span class="stat-label svelte-1vhnofy">总题</span> <span class="stat-number svelte-1vhnofy"> </span></div> <div class="stat-item svelte-1vhnofy"><span class="stat-label svelte-1vhnofy">已练</span> <span class="stat-number svelte-1vhnofy"> </span></div> <div class="stat-item svelte-1vhnofy"><span class="stat-label svelte-1vhnofy">错题</span> <span class="stat-number svelte-1vhnofy"> </span></div></div> <div class="info-right svelte-1vhnofy"></div></div></div>');function kre(e,t){if(new.target)return Er({component:kre,...e});kt(t,!0);let n=Ar(t,"bank",7),i=Ar(t,"stats",7),a=Ar(t,"colorScheme",7),r=Ar(t,"onTest",7),s=Ar(t,"onMenu",7);const o=In(()=>0===i().total||i().completed===i().total&&i().accuracy>=80?"completed":i().completed>0&&i().accuracy<60&&i().completed>.5*i().total?"urgent":(i().completed,i().total,"normal")),l=In(()=>a()[bi(o)]),c=In(()=>`background: ${bi(l).gradient}; color: ${bi(l).textColor};`),d=In(()=>`background: ${a().infoBar.background}; color: ${a().infoBar.textColor};`);function u(){i().total>0&&r()()}var h={get bank(){return n()},set bank(e){n(e),hn()},get stats(){return i()},set stats(e){i(e),hn()},get colorScheme(){return a()},set colorScheme(e){a(e),hn()},get onTest(){return r()},set onTest(e){r(e),hn()},get onMenu(){return s()},set onMenu(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=wre();let g;p.__click=u,p.__keydown=[mre,i,u],p.__contextmenu=[vre,s];var v=Gt(p),f=Kt(Gt(v),2);f.__click=[fre,s],Ng(Gt(f),{name:"more-horizontal",size:16}),zt(f);var m=Kt(f,2),y=Gt(m,!0);zt(m);var b=Kt(m,2),w=e=>{pa(e,yre())};xa(b,e=>{0===i().total&&e(w)}),zt(v);var k=Kt(v,2),S=Gt(k),x=Gt(S),_=e=>{var t=bre(),n=Gt(t);zt(t),zi(e=>va(n,`${null!=e?e:""}%`),[()=>i().accuracy.toFixed(0)]),pa(e,t)};xa(x,e=>{i().completed>0&&e(_)}),zt(S);var C=Kt(S,2),I=Gt(C),D=Kt(Gt(I),2),T=Gt(D,!0);zt(D),zt(I);var M=Kt(I,2),A=Kt(Gt(M),2),E=Gt(A,!0);zt(A),zt(M);var z=Kt(M,2),P=Kt(Gt(z),2),R=Gt(P,!0);return zt(P),zt(z),zt(C),Pt(2),zt(k),zt(p),zi((e,t)=>{var a,r,s;g=Fa(p,1,"question-bank-grid-card svelte-1vhnofy",null,g,e),er(p,"aria-label",`${null!=(a=n().name)?a:""} - 总题${null!=(r=i().total)?r:""}, 已练${null!=(s=i().completed)?s:""}, 正确率${null!=t?t:""}%`),ja(v,bi(c)),va(y,n().name),ja(k,bi(d)),va(T,i().total),va(E,i().completed),va(R,i().errorCount)},[()=>({empty:0===i().total}),()=>i().accuracy.toFixed(0)]),pa(e,p),St(h)}ia(["click","keydown","contextmenu"]);var Sre=la('<div class="loading-container svelte-l2n1w7"><!></div>'),xre=la('<div class="cards-grid svelte-l2n1w7"></div>'),_re=la('<div class="mode-placeholder svelte-l2n1w7"><div class="placeholder-icon svelte-l2n1w7">📝</div> <h2 class="placeholder-title svelte-l2n1w7">暂无刷题牌组</h2> <p class="placeholder-desc svelte-l2n1w7">刷题牌组会基于记忆牌组自动创建</p></div>'),Cre=la('<div class="question-bank-grid-view svelte-l2n1w7"><!></div> <!> <!>',1);function Ire(e,t){if(new.target)return Er({component:Ire,...e});kt(t,!0);let n=Ar(t,"plugin",7),i=Pn(Ot([])),a=Pn(Ot({})),r=Pn(!0),s=Pn(!1),o=Pn(null),l=Pn(""),c=Pn(0),d=Pn(Ot([])),u=Pn(!1),h=Pn(null);async function p(){$n(r,!0);try{if(!n().questionBankService||!n().questionBankHierarchy||!n().deckHierarchy)return _e.warn("[QuestionBankGridView] Required services not initialized"),void $n(i,[],!0);const e=await n().deckHierarchy.getDeckTree();$n(i,await n().questionBankHierarchy.buildQuestionBankTree(e),!0),await async function(){var e,t;if(!n().questionBankService)return;const i=await n().questionBankService.getAllBanks();for(const r of i){const i=await n().questionBankService.getQuestionsByBank(r.id),s=i.length;let o=0,l=0,c=0;for(const n of i)if((null==(e=n.stats)?void 0:e.testStats)&&n.stats.testStats.totalAttempts>0){o++;const e=null==(t=n.stats.testStats.masteryMetrics)?void 0:t.currentAccuracy;l+=void 0!==e?e:100*(n.stats.testStats.accuracy||0),c+=n.stats.testStats.incorrectAttempts}const d=o>0?l/o:0;bi(a)[r.id]={total:s,completed:o,accuracy:d,errorCount:c}}}()}catch(e){_e.error("[QuestionBankGridView] Failed to load question bank tree:",e),new ge.Notice("加载题库失败: "+(e instanceof Error?e.message:"未知错误")),$n(i,[],!0)}finally{$n(r,!1)}}function g(e){const t=[];for(const n of e)t.push(n.deck),n.children.length>0&&t.push(...g(n.children));return t}Pr(()=>{p()});const v=In(()=>g(bi(i)));function f(e,t){const i=new ge.Menu;i.addItem(e=>e.setTitle("分析").setIcon("bar-chart-2").onClick(()=>async function(e){var t;try{_e.debug("[QuestionBankGridView] 分析题库:",e);const i=await(null==(t=n().questionBankService)?void 0:t.getBankById(e));if(!i)return void new ge.Notice("题库不存在");$n(h,i,!0),$n(u,!0)}catch(i){_e.error("[QuestionBankGridView] 分析题库失败:",i),new ge.Notice("打开分析界面失败")}}(t))),i.addSeparator(),i.addItem(e=>e.setTitle("删除").setIcon("trash-2").onClick(()=>async function(e){var t,i;try{const a=await(null==(t=n().questionBankService)?void 0:t.getBankById(e));if(!a)return void new ge.Notice("题库不存在");if(!confirm(`确定要删除题库「${a.name}」吗？\n\n删除后题库数据将无法恢复。`))return;new ge.Notice("🗑️ 正在删除题库..."),await(null==(i=n().questionBankService)?void 0:i.deleteBank(e)),await p(),new ge.Notice("✅ 题库删除成功")}catch(a){_e.error("[QuestionBankGridView] 删除题库失败:",a),new ge.Notice(`❌ 删除失败: ${a instanceof Error?a.message:"未知错误"}`)}}(t))),i.showAtMouseEvent(e)}var m={get plugin(){return n()},set plugin(e){n(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=Cre(),b=Qt(y),w=Gt(b),k=e=>{var t=Sre();Qg(Gt(t),{message:"正在加载题库..."}),zt(t),pa(e,t)},S=e=>{var t=ha(),i=Qt(t),r=e=>{var t=xre();Ca(t,21,()=>bi(v),e=>e.id,(e,t)=>{const i=In(()=>bi(a)[bi(t).id]||{total:0,completed:0,accuracy:0,errorCount:0}),r=In(()=>nae(bi(t).id));kre(e,{get bank(){return bi(t)},get stats(){return bi(i)},get colorScheme(){return bi(r)},onTest:()=>async function(e){if(!n().questionBankService)return void new ge.Notice("题库服务未初始化");const t=await n().questionBankService.getQuestionsByBank(e),i=await n().questionBankService.getBankById(e);0!==t.length?($n(o,e,!0),$n(l,(null==i?void 0:i.name)||"未知题库",!0),$n(c,t.length,!0),$n(d,t,!0),$n(s,!0)):new ge.Notice("该题库暂无题目")}(bi(t).id),onMenu:e=>f(e,bi(t).id)})}),zt(t),pa(e,t)},u=e=>{pa(e,_re())};xa(i,e=>{bi(v).length>0?e(r):e(u,!1)},!0),pa(e,t)};xa(w,e=>{bi(r)?e(k):e(S,!1)}),zt(b);var x=Kt(b,2);Qae(x,{get open(){return bi(s)},get bankName(){return bi(l)},get totalQuestions(){return bi(c)},onSelect:async function(e,t){_e.debug("[QuestionBankGridView] 模式选择:",{mode:e,config:t}),$n(s,!1),bi(o)&&bi(d).length>0&&await async function(e,t,i,a="practice",r){if(_e.debug("[QuestionBankGridView] 开始刷题:",{bankId:e,bankName:t,questionCount:i.length,mode:a,config:r}),0!==i.length){if(r&&n().questionBankService)try{await n().questionBankService.updateBankConfig(e,r),_e.debug("[QuestionBankGridView] 配置已保存:",r)}catch(s){_e.error("[QuestionBankGridView] 保存配置失败:",s)}await n().openQuestionBankSession({bankId:e,bankName:t,mode:a,config:r})}else new ge.Notice("该题库暂无题目")}(bi(o),bi(l),bi(d),e,t)},onCancel:function(){_e.debug("[QuestionBankGridView] 取消模式选择"),$n(s,!1),$n(o,null),$n(l,""),$n(c,0),$n(d,[],!0)}});var _=Kt(x,2),C=e=>{gre(e,{get plugin(){return n()},get questionBank(){return bi(h)},onClose:()=>{$n(u,!1),$n(h,null)},get open(){return bi(u)},set open(e){$n(u,e,!0)}})};return xa(_,e=>{bi(h)&&e(C)}),pa(e,y),St(m)}var Dre=la('<div class="cards-grid svelte-19imyfo"></div>'),Tre=la('<div class="mode-placeholder svelte-19imyfo"><div class="placeholder-icon svelte-19imyfo">📚</div> <h2 class="placeholder-title svelte-19imyfo"> </h2> <p class="placeholder-desc svelte-19imyfo"> </p></div>'),Mre=la('<div class="mode-placeholder svelte-19imyfo"><div class="placeholder-icon svelte-19imyfo">📖</div> <h2 class="placeholder-title svelte-19imyfo">渐进式阅读</h2> <p class="placeholder-desc svelte-19imyfo">该功能正在开发中，敬请期待...</p></div>'),Are=la('<div class="grid-card-view svelte-19imyfo"><div class="category-filter-wrapper svelte-19imyfo"><!></div> <!></div>');function Ere(e,t){if(new.target)return Er({component:Ere,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"deckTree",7),s=Ar(t,"deckStats",7),o=Ar(t,"studySessions",7),l=Ar(t,"plugin",7),c=Ar(t,"onStartStudy",7),d=Ar(t,"onContinueStudy",7),u=Ar(t,"onAdvanceStudy",7),h=Ar(t,"onOpenDeckAnalytics",7),p=Ar(t,"onCreateSubdeck",7),g=Ar(t,"onMoveDeck",7),v=Ar(t,"onEditDeck",7),f=Ar(t,"onDeleteDeck",7),m=Ar(t,"onRefreshData",7),y=In(n),b=Pn("memory");function w(e){const t=[];for(const n of e)t.push(n.deck),n.children.length>0&&t.push(...w(n.children));return t}Pr(()=>{const e=localStorage.getItem("tuanki-deck-mode-filter");e&&["memory","reading","question-bank","parent","child","all"].includes(e)&&(["parent","child","all"].includes(e)?$n(b,"memory"):$n(b,e,!0)),_e.debug("[GridCardView] 模式筛选器初始化:",bi(b))});const k=In(()=>w(r())),S=In(()=>()=>"memory"===bi(b)?bi(k):"reading"===bi(b)||"question-bank"===bi(b)?[]:(["parent","child","all"].includes(bi(b)),bi(k)));var x={get deckTree(){return r()},set deckTree(e){r(e),hn()},get deckStats(){return s()},set deckStats(e){s(e),hn()},get studySessions(){return o()},set studySessions(e){o(e),hn()},get plugin(){return l()},set plugin(e){l(e),hn()},get onStartStudy(){return c()},set onStartStudy(e){c(e),hn()},get onContinueStudy(){return d()},set onContinueStudy(e){d(e),hn()},get onAdvanceStudy(){return u()},set onAdvanceStudy(e){u(e),hn()},get onOpenDeckAnalytics(){return h()},set onOpenDeckAnalytics(e){h(e),hn()},get onCreateSubdeck(){return p()},set onCreateSubdeck(e){p(e),hn()},get onMoveDeck(){return g()},set onMoveDeck(e){g(e),hn()},get onEditDeck(){return v()},set onEditDeck(e){v(e),hn()},get onDeleteDeck(){return f()},set onDeleteDeck(e){f(e),hn()},get onRefreshData(){return m()},set onRefreshData(e){m(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},_=Are(),C=Gt(_);hae(Gt(C),{get selectedFilter(){return bi(b)},onSelect:function(e){$n(b,e,!0),localStorage.setItem("tuanki-deck-mode-filter",e),_e.debug("[GridCardView] 切换模式筛选器:",e)}}),zt(C);var I=Kt(C,2),D=e=>{var t=ha(),n=Qt(t),i=e=>{var t=Dre();Ca(t,21,()=>bi(S)(),e=>e.id,(e,t)=>{const n=In(()=>s()[bi(t).id]||{newCards:0,learningCards:0,reviewCards:0,memoryRate:0,totalCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,averageEase:0,forecastDays:{}}),i=In(()=>nae(bi(t).id));oae(e,{get deck(){return bi(t)},get stats(){return bi(n)},get colorScheme(){return bi(i)},categoryName:"",onStudy:()=>c()(bi(t).id),onMenu:e=>function(e,t){const n=new ge.Menu,i=bi(k).find(e=>e.id===t);null==i||i.parentId,n.addItem(e=>e.setTitle("提前学习").setIcon("fast-forward").onClick(async()=>{var e;return await(null==(e=u())?void 0:e(t))})),n.addItem(e=>e.setTitle("牌组分析").setIcon("bar-chart-2").onClick(()=>{var e;return null==(e=h())?void 0:e(t)})),n.addSeparator(),n.addItem(e=>e.setTitle("创建子牌组").setIcon("folder-plus").onClick(()=>{var e;return null==(e=p())?void 0:e(t)})),n.addItem(e=>e.setTitle("移动牌组").setIcon("move").onClick(()=>{var e;return null==(e=g())?void 0:e(t)})),n.addSeparator(),n.addItem(e=>e.setTitle("牌组编辑").setIcon("edit").onClick(()=>{var e;return null==(e=v())?void 0:e(t)})),n.addItem(e=>e.setTitle("删除").setIcon("trash-2").onClick(()=>{var e;return null==(e=f())?void 0:e(t)})),n.addSeparator(),n.showAtMouseEvent(e)}(e,bi(t).id)})}),zt(t),pa(e,t)},a=e=>{var t=Tre(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n);var a=Kt(n,2),r=Gt(a,!0);zt(a),zt(t),zi((e,t)=>{va(i,e),va(r,t)},[()=>bi(y)("deckStudyPage.emptyState.noDecks"),()=>bi(y)("deckStudyPage.emptyState.createFirstDeck")]),pa(e,t)};xa(n,e=>{bi(S)().length>0?e(i):e(a,!1)}),pa(e,t)},T=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,Mre())},a=e=>{var t=ha(),n=Qt(t),i=e=>{Ire(e,{get plugin(){return l()}})};xa(n,e=>{"question-bank"===bi(b)&&e(i)},!0),pa(e,t)};xa(n,e=>{"reading"===bi(b)?e(i):e(a,!1)},!0),pa(e,t)};xa(I,e=>{"memory"===bi(b)?e(D):e(T,!1)}),zt(_),pa(e,_);var M=St(x);return a(),M}var zre=la("<div></div>"),Pre=la('<div class="confetti-container svelte-1g665f4"></div>');function Rre(e,t){if(new.target)return Er({component:Rre,...e});kt(t,!0);let n=Ar(t,"particleCount",7,40),i=Ar(t,"duration",7,2.5);const a=["#8b5cf6","#7c3aed","#6d28d9","#a78bfa","#c4b5fd"],r=In(()=>Array.from({length:n()},(e,t)=>({id:t,color:a[Math.floor(Math.random()*a.length)],angle:360*Math.random(),distance:200+300*Math.random(),rotation:360+720*Math.random(),size:4+8*Math.random(),delay:.2*Math.random(),shape:Math.random()>.5?"circle":"square"})));var s={get particleCount(){return n()},set particleCount(e=40){n(e),hn()},get duration(){return i()},set duration(e=2.5){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=Pre();return Ca(o,21,()=>bi(r),e=>e.id,(e,t)=>{var n=zre();let a;zi(e=>{var r,s,o,l,c,d,u;a=Fa(n,1,"confetti-particle svelte-1g665f4",null,a,e),ja(n,`\n        --color: ${null!=(r=bi(t).color)?r:""};\n        --angle: ${null!=(s=bi(t).angle)?s:""}deg;\n        --distance: ${null!=(o=bi(t).distance)?o:""}px;\n        --rotation: ${null!=(l=bi(t).rotation)?l:""}deg;\n        --size: ${null!=(c=bi(t).size)?c:""}px;\n        --delay: ${null!=(d=bi(t).delay)?d:""}s;\n        --duration: ${null!=(u=i())?u:""}s;\n      `)},[()=>({circle:"circle"===bi(t).shape,square:"square"===bi(t).shape})]),pa(e,n)}),zt(o),pa(e,o),St(s)}var $re=la('<div class="dot svelte-l78l7p"></div>'),Ore=la('<div class="waving-dots svelte-l78l7p"></div>');function Lre(e,t){if(new.target)return Er({component:Lre,...e});kt(t,!0);let n=Ar(t,"dotCount",7,5),i=Ar(t,"size",7,16);const a=["#8b5cf6","#7c3aed","#6366f1","#3b82f6","#ec4899"],r=In(()=>Array.from({length:n()},(e,t)=>({id:t,color:a[t%a.length],delay:.15*t})));var s={get dotCount(){return n()},set dotCount(e=5){n(e),hn()},get size(){return i()},set size(e=16){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=Ore();return Ca(o,21,()=>bi(r),e=>e.id,(e,t)=>{var n=$re();zi(()=>{var e,a,r;return ja(n,`\n        --color: ${null!=(e=bi(t).color)?e:""};\n        --delay: ${null!=(a=bi(t).delay)?a:""}s;\n        --size: ${null!=(r=i())?r:""}px;\n      `)}),pa(e,n)}),zt(o),pa(e,o),St(s)}class Nre{constructor(){oe(this,"audioContext",null),oe(this,"volume",.5),oe(this,"isPlaying",!1)}async play(e=this.volume){if(!this.isPlaying)try{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.isPlaying=!0,this.volume=Math.max(0,Math.min(1,e));const t=this.audioContext,n=t.currentTime,i=t.createGain();i.connect(t.destination),i.gain.setValueAtTime(this.volume,n);[523.25,659.25,783.99,1046.5].forEach((e,a)=>{const r=t.createOscillator(),s=t.createGain();r.type="sine",r.frequency.setValueAtTime(e,n+.1*a),s.gain.setValueAtTime(0,n+.1*a),s.gain.linearRampToValueAtTime(.3,n+.1*a+.02),s.gain.exponentialRampToValueAtTime(.01,n+.1*a+.2),r.connect(s),s.connect(i),r.start(n+.1*a),r.stop(n+.1*a+.3)});[523.25,659.25,783.99].forEach(e=>{const a=t.createOscillator(),r=t.createGain();a.type="triangle",a.frequency.setValueAtTime(e,n+.4),r.gain.setValueAtTime(0,n+.4),r.gain.linearRampToValueAtTime(.2,n+.45),r.gain.exponentialRampToValueAtTime(.01,n+1),a.connect(r),r.connect(i),a.start(n+.4),a.stop(n+1)});const a=t.createOscillator(),r=t.createGain();a.type="sine",a.frequency.setValueAtTime(2093,n+.6),r.gain.setValueAtTime(0,n+.6),r.gain.linearRampToValueAtTime(.15,n+.65),r.gain.exponentialRampToValueAtTime(.01,n+1),a.connect(r),r.connect(i),a.start(n+.6),a.stop(n+1),setTimeout(()=>{this.isPlaying=!1},1200)}catch(t){_e.error("[CelebrationSound] 播放失败:",t),this.isPlaying=!1}}stop(){this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.isPlaying=!1}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}destroy(){this.stop()}}let Fre=null;function Bre(){return Fre||(Fre=new Nre),Fre}const jre=[{emoji:"🎉",text:"太棒啦！你已经完成了今天的所有学习任务！"},{emoji:"✨",text:"哇哦！所有卡片都被你征服啦！"},{emoji:"🌟",text:"恭喜！大脑已经成功记住这些知识点啦！"},{emoji:"🎊",text:"完美！你的学习节奏把握得很好呢！"},{emoji:"💪",text:"干得漂亮！所有待学习的卡片都搞定了！"},{emoji:"🏆",text:"棒棒哒！又完成了一轮完美学习！"},{emoji:"🎯",text:"太厉害了！学习目标100%达成！"},{emoji:"🌈",text:"耶！知识的彩虹又多了一道！"}],Ure=[{icon:"🧠",text:"间隔效应是记忆的黄金法则",author:"Hermann Ebbinghaus",note:"艾宾浩斯遗忘曲线的发现者"},{icon:"💤",text:"睡眠是巩固记忆的最佳时间",author:"神经科学研究",note:"大脑在睡眠中整理和强化记忆"},{icon:"✍️",text:"主动回忆比被动复习效果好10倍",author:"认知心理学",note:"测试效应（Testing Effect）"},{icon:"🌱",text:"遗忘不是失败，而是学习的必要部分",author:"Robert Bjork",note:"UCLA 记忆研究专家"},{icon:"💎",text:"适度的困难能促进长期记忆",author:"Desirable Difficulty",note:"合适的挑战让学习更有效"},{icon:"🔄",text:"重复是记忆之母",author:"古罗马谚语",note:"被现代神经科学证实"},{icon:"📚",text:"分散学习比集中学习效果更持久",author:"学习科学",note:"多次短时间学习优于一次长时间"},{icon:"🎯",text:"检索练习能让记忆更牢固",author:"认知心理学",note:"回忆过程本身就是学习"},{icon:"🌟",text:"情绪与记忆紧密相连",author:"神经科学",note:"带有情感的记忆更容易保留"},{icon:"🔬",text:"大脑喜欢模式和关联",author:"认知神经科学",note:"建立知识网络让学习更高效"},{icon:"⚡",text:"短暂的休息能提升学习效率",author:"Pomodoro Technique",note:"劳逸结合，张弛有度"},{icon:"🎨",text:"多感官学习能加深记忆",author:"教育心理学",note:"视觉+听觉+动手效果最佳"}];var Vre=(e,t)=>{"function"==typeof t()&&t()()},qre=(e,t)=>{"Enter"!==e.key&&" "!==e.key||"function"==typeof t()&&t()()},Hre=e=>e.stopPropagation(),Wre=e=>e.stopPropagation(),Gre=la('<div class="celebration-backdrop svelte-1nu7nd2" role="button" tabindex="0" aria-label="关闭庆祝窗口"><!> <div role="dialog" tabindex="-1" aria-labelledby="celebration-title" aria-modal="true"><div class="celebration-header svelte-1nu7nd2"><div class="emoji-large svelte-1nu7nd2"> </div></div> <h2 id="celebration-title" class="celebration-title svelte-1nu7nd2"> </h2> <div class="dots-container svelte-1nu7nd2"><!></div> <div class="quote-card svelte-1nu7nd2"><div class="quote-icon svelte-1nu7nd2"> </div> <div class="quote-content svelte-1nu7nd2"><p class="quote-text svelte-1nu7nd2"> </p> <p class="quote-author svelte-1nu7nd2"> </p> <p class="quote-note svelte-1nu7nd2"> </p></div></div> <div class="stats-section svelte-1nu7nd2"><div class="stats-title svelte-1nu7nd2"> </div> <div class="stats-grid svelte-1nu7nd2"><div class="stat-item svelte-1nu7nd2"><div class="stat-icon svelte-1nu7nd2">✅</div> <div class="stat-value svelte-1nu7nd2"> </div> <div class="stat-label svelte-1nu7nd2"> </div></div> <div class="stat-item svelte-1nu7nd2"><div class="stat-icon svelte-1nu7nd2">⏱️</div> <div class="stat-value svelte-1nu7nd2"> </div> <div class="stat-label svelte-1nu7nd2"> </div></div> <div class="stat-item svelte-1nu7nd2"><div class="stat-icon svelte-1nu7nd2">📈</div> <div class="stat-value svelte-1nu7nd2"> </div> <div class="stat-label svelte-1nu7nd2"> </div></div></div></div> <div class="celebration-footer svelte-1nu7nd2"><p class="footer-hint svelte-1nu7nd2"> </p> <button class="btn-close svelte-1nu7nd2"> </button></div></div></div>');function Qre(e,t){if(new.target)return Er({component:Qre,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"deckName",7),s=Ar(t,"stats",7),o=Ar(t,"soundEnabled",7,!0),l=Ar(t,"soundVolume",7,.5),c=Ar(t,"onClose",7),d=In(n);const u=jre[Math.floor(Math.random()*jre.length)],h=Ure[Math.floor(Math.random()*Ure.length)],p=In(()=>()=>{const e=Math.floor(s().studyTime/60);if(0===e)return bi(d)("celebration.timeFormat.lessThan1Min");if(e<60)return bi(d)("celebration.timeFormat.minutes").replace("{n}",String(e));const t=Math.floor(e/60),n=e%60;return bi(d)("celebration.timeFormat.hoursMinutes").replace("{h}",String(t)).replace("{m}",String(n))});let g=Pn(!1);Pr(()=>{if(o()){Bre().play(l()).catch(e=>{_e.error("[CelebrationModal] Sound play failed:",e)})}setTimeout(()=>{$n(g,!0)},300);const e=e=>{"Escape"!==e.key&&"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),"function"==typeof c()&&c()())};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}});var v={get deckName(){return r()},set deckName(e){r(e),hn()},get stats(){return s()},set stats(e){s(e),hn()},get soundEnabled(){return o()},set soundEnabled(e=!0){o(e),hn()},get soundVolume(){return l()},set soundVolume(e=.5){l(e),hn()},get onClose(){return c()},set onClose(e){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},f=Gre();f.__click=[Vre,c],f.__keydown=[qre,c];var m=Gt(f);Rre(m,{});var y=Kt(m,2);let b;y.__click=[Hre],y.__keydown=[Wre];var w=Gt(y),k=Gt(w),S=Gt(k,!0);zt(k),zt(w);var x=Kt(w,2),_=Gt(x,!0);zt(x);var C=Kt(x,2);Lre(Gt(C),{}),zt(C);var I=Kt(C,2),D=Gt(I),T=Gt(D,!0);zt(D);var M=Kt(D,2),A=Gt(M),E=Gt(A);zt(A);var z=Kt(A,2),P=Gt(z);zt(z);var R=Kt(z,2),$=Gt(R,!0);zt(R),zt(M),zt(I);var O=Kt(I,2),L=Gt(O),N=Gt(L,!0);zt(L);var F=Kt(L,2),B=Gt(F),j=Kt(Gt(B),2),U=Gt(j,!0);zt(j);var V=Kt(j,2),q=Gt(V,!0);zt(V),zt(B);var H=Kt(B,2),W=Kt(Gt(H),2),G=Gt(W,!0);zt(W);var Q=Kt(W,2),K=Gt(Q,!0);zt(Q),zt(H);var Z=Kt(H,2),Y=Kt(Gt(Z),2),X=Gt(Y);zt(Y);var J=Kt(Y,2),ee=Gt(J,!0);zt(J),zt(Z),zt(F),zt(O);var te=Kt(O,2),ne=Gt(te),ie=Gt(ne,!0);zt(ne);var ae=Kt(ne,2);ae.__click=function(...e){var t;null==(t=c())||t.apply(this,e)};var re=Gt(ae,!0);zt(ae),zt(te),zt(y),zt(f),zi((e,t,n,i,a,r,o,l,c)=>{var d,p;b=Fa(y,1,"celebration-card svelte-1nu7nd2",null,b,e),va(S,u.emoji),va(_,u.text),va(T,h.icon),va(E,`"${null!=(d=h.text)?d:""}"`),va(P,`— ${null!=(p=h.author)?p:""}`),va($,h.note),va(N,t),va(U,s().reviewed),va(q,n),va(G,i),va(K,a),va(X,`${null!=r?r:""}%`),va(ee,o),va(ie,l),va(re,c)},[()=>({show:bi(g)}),()=>bi(d)("celebration.stats.title"),()=>bi(d)("celebration.stats.reviewed"),()=>bi(p)(),()=>bi(d)("celebration.stats.studyTime"),()=>Math.round(100*s().memoryRate),()=>bi(d)("celebration.stats.memoryRate"),()=>bi(d)("celebration.footer.hint"),()=>bi(d)("celebration.footer.closeButton")]),pa(e,f);var se=St(v);return a(),se}ia(["click","keydown"]);var Kre=(e,t)=>{"function"==typeof t()&&t()()},Zre=(e,t)=>{"Enter"!==e.key&&" "!==e.key||"function"==typeof t()&&t()()},Yre=e=>e.stopPropagation(),Xre=e=>e.stopPropagation(),Jre=la('<div class="stat-item svelte-1fl4evp"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="stat-icon svelte-1fl4evp"><circle cx="12" cy="12" r="10" class="svelte-1fl4evp"></circle><path d="M12 6v6l4 2" class="svelte-1fl4evp"></path></svg> <div class="stat-content svelte-1fl4evp"><span class="stat-label svelte-1fl4evp">最近到期</span> <span class="stat-value svelte-1fl4evp"> </span></div></div>'),ese=la('<div class="stat-item svelte-1fl4evp"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="stat-icon svelte-1fl4evp"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" class="svelte-1fl4evp"></path><path d="M14 2v6h6M12 18v-6M9 15l3-3 3 3" class="svelte-1fl4evp"></path></svg> <div class="stat-content svelte-1fl4evp"><span class="stat-label svelte-1fl4evp">今日新卡</span> <span class="stat-value svelte-1fl4evp"> </span></div></div>'),tse=la('<div class="stats-card svelte-1fl4evp"><div class="stats-header svelte-1fl4evp"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="stats-icon svelte-1fl4evp"><path d="M9 11l3 3L22 4" class="svelte-1fl4evp"></path><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" class="svelte-1fl4evp"></path></svg> <span class="stats-title svelte-1fl4evp">牌组统计</span></div> <div class="stats-divider svelte-1fl4evp"></div> <div class="stats-grid svelte-1fl4evp"><div class="stat-item svelte-1fl4evp"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="stat-icon svelte-1fl4evp"><path d="M3 3h18v18H3V3z" class="svelte-1fl4evp"></path><path d="M9 9h6M9 15h6" class="svelte-1fl4evp"></path></svg> <div class="stat-content svelte-1fl4evp"><span class="stat-label svelte-1fl4evp">总卡片</span> <span class="stat-value svelte-1fl4evp"> </span></div></div> <div class="stat-item svelte-1fl4evp"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="stat-icon svelte-1fl4evp"><path d="M22 11.08V12a10 10 0 11-5.93-9.14" class="svelte-1fl4evp"></path><path d="M22 4L12 14.01l-3-3" class="svelte-1fl4evp"></path></svg> <div class="stat-content svelte-1fl4evp"><span class="stat-label svelte-1fl4evp">已学完</span> <span class="stat-value svelte-1fl4evp"> </span></div></div> <!> <!></div></div>'),nse=la('<button class="btn-action btn-primary svelte-1fl4evp"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-1fl4evp"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" class="svelte-1fl4evp"></path></svg> 提前学习</button>'),ise=la('<button class="btn-action btn-secondary svelte-1fl4evp"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-1fl4evp"><path d="M3 3v18h18" class="svelte-1fl4evp"></path><path d="M18 17V9M13 17V5M8 17v-3" class="svelte-1fl4evp"></path></svg> 查看统计</button>'),ase=la('<div class="no-cards-backdrop svelte-1fl4evp" role="button" tabindex="0" aria-label="关闭提示窗口"><div role="dialog" tabindex="-1" aria-labelledby="no-cards-title" aria-modal="true"><div class="no-cards-header svelte-1fl4evp"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" class="icon-large svelte-1fl4evp"><path fill="currentColor" opacity="0.8" class="svelte-1fl4evp"></path></svg></div> <h2 id="no-cards-title" class="no-cards-title svelte-1fl4evp"> </h2> <div class="dots-container svelte-1fl4evp"><!></div> <!> <div class="suggestion-box svelte-1fl4evp"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="suggestion-icon svelte-1fl4evp"><path d="M12 2L2 7l10 5 10-5-10-5z" class="svelte-1fl4evp"></path><path d="M2 17l10 5 10-5" class="svelte-1fl4evp"></path><path d="M2 12l10 5 10-5" class="svelte-1fl4evp"></path></svg> <p class="suggestion-text svelte-1fl4evp">可以继续探索其他学习方式</p></div> <div class="action-buttons svelte-1fl4evp"><!> <!> <button class="btn-action btn-tertiary svelte-1fl4evp">关闭</button></div></div></div>');function rse(e,t){if(new.target)return Er({component:rse,...e});kt(t,!0);let n=Ar(t,"deckName",7),i=Ar(t,"reason",7),a=Ar(t,"stats",7),r=Ar(t,"onClose",7),s=Ar(t,"onAdvanceStudy",7),o=Ar(t,"onViewStats",7),l=Pn(!1);const c=In(()=>()=>{switch(i()){case"empty":return{title:"该牌组还没有卡片",message:"开始添加卡片来构建你的知识库吧",suggestion:"点击卡片管理页面创建新卡片",svgPath:"M3 3h18v18H3V3zm2 2v14h14V5H5zm4 4h6v2H9V9zm0 4h6v2H9v-2z"};case"all-learned":return{title:"今日学习目标已达成",message:`牌组「${n()}」的所有到期卡片都已复习完毕`,suggestion:"明天再来继续学习，或选择提前学习功能",svgPath:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"};case"no-due":return{title:"暂无到期卡片",message:a()?`牌组中有 ${a().totalCards} 张卡片，但目前都还没到复习时间`:"牌组中的卡片目前都还没到复习时间",suggestion:"可以选择提前学习功能，或等待卡片自然到期",svgPath:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"};default:return{title:"无可学习卡片",message:"当前牌组暂时没有需要学习的卡片",suggestion:"请稍后再试，或检查牌组设置",svgPath:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"}}});Pr(()=>{setTimeout(()=>{$n(l,!0)},300);const e=e=>{"Escape"!==e.key&&"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),"function"==typeof r()&&r()())};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}});var d={get deckName(){return n()},set deckName(e){n(e),hn()},get reason(){return i()},set reason(e){i(e),hn()},get stats(){return a()},set stats(e){a(e),hn()},get onClose(){return r()},set onClose(e){r(e),hn()},get onAdvanceStudy(){return s()},set onAdvanceStudy(e){s(e),hn()},get onViewStats(){return o()},set onViewStats(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},u=ase();u.__click=[Kre,r],u.__keydown=[Zre,r];var h=Gt(u);let p;h.__click=[Yre],h.__keydown=[Xre];var g=Gt(h),v=Gt(g),f=Gt(v);zt(v),zt(g);var m=Kt(g,2),y=Gt(m,!0);zt(m);var b=Kt(m,2);Lre(Gt(b),{}),zt(b);var w=Kt(b,2),k=e=>{var t=tse(),n=Kt(Gt(t),4),i=Gt(n),r=Kt(Gt(i),2),s=Kt(Gt(r),2),o=Gt(s);zt(s),zt(r),zt(i);var l=Kt(i,2),c=Kt(Gt(l),2),d=Kt(Gt(c),2),u=Gt(d);zt(d),zt(c),zt(l);var h=Kt(l,2),p=e=>{var t=Jre(),n=Kt(Gt(t),2),i=Kt(Gt(n),2),r=Gt(i,!0);zt(i),zt(n),zt(t),zi(()=>va(r,a().nextDueTime)),pa(e,t)};xa(h,e=>{a().nextDueTime&&e(p)});var g=Kt(h,2),v=e=>{var t=ese(),n=Kt(Gt(t),2),i=Kt(Gt(n),2),r=Gt(i);zt(i),zt(n),zt(t),zi(()=>{var e,t;return va(r,`${null!=(e=a().todayNewCards)?e:""}/${null!=(t=a().todayNewLimit)?t:""} 已完成`)}),pa(e,t)};xa(g,e=>{void 0!==a().todayNewCards&&a().todayNewLimit&&e(v)}),zt(n),zt(t),zi(()=>{var e,t;va(o,`${null!=(e=a().totalCards)?e:""} 张`),va(u,`${null!=(t=a().learnedCards)?t:""} 张`)}),pa(e,t)};xa(w,e=>{a()&&"empty"!==i()&&e(k)});var S=Kt(w,4),x=Gt(S),_=e=>{var t=nse();t.__click=function(...e){var t;null==(t=s())||t.apply(this,e)},pa(e,t)};xa(x,e=>{s()&&"empty"!==i()&&e(_)});var C=Kt(x,2),I=e=>{var t=ise();t.__click=function(...e){var t;null==(t=o())||t.apply(this,e)},pa(e,t)};return xa(C,e=>{o()&&"empty"!==i()&&e(I)}),Kt(C,2).__click=function(...e){var t;null==(t=r())||t.apply(this,e)},zt(S),zt(h),zt(u),zi((e,t,n)=>{p=Fa(h,1,"no-cards-card svelte-1fl4evp",null,p,e),er(f,"d",t),va(y,n)},[()=>({show:bi(l)}),()=>bi(c)().svgPath,()=>bi(c)().title]),pa(e,u),St(d)}ia(["click","keydown"]);var sse=la('<div class="updating-indicator svelte-rqfrg3"><div class="spinner svelte-rqfrg3"></div> <span class="svelte-rqfrg3">更新中...</span></div>'),ose=(e,t)=>t("retention"),lse=(e,t)=>t("quantity"),cse=(e,t)=>t("timing"),dse=(e,t)=>t("difficulty"),use=(e,t,n)=>t(bi(n).value),hse=la("<button> </button>"),pse=(e,t,n)=>{$n(t,new Date(e.currentTarget.value),!0),n()},gse=(e,t,n)=>{$n(t,new Date(e.currentTarget.value),!0),n()},vse=la('<div class="empty-state svelte-rqfrg3"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4; margin-bottom: 24px;" class="svelte-rqfrg3"><rect x="3" y="3" width="7" height="7" class="svelte-rqfrg3"></rect><rect x="14" y="3" width="7" height="7" class="svelte-rqfrg3"></rect><rect x="14" y="14" width="7" height="7" class="svelte-rqfrg3"></rect><rect x="3" y="14" width="7" height="7" class="svelte-rqfrg3"></rect></svg> <div class="empty-title svelte-rqfrg3">该牌组暂无卡片数据</div> <div class="empty-desc svelte-rqfrg3">请先添加卡片后再查看分析图表</div></div>'),fse=la('<div class="empty-state svelte-rqfrg3"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4; margin-bottom: 24px;" class="svelte-rqfrg3"><path d="M4 19.5A2.5 2.5 0 016.5 17H20" class="svelte-rqfrg3"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z" class="svelte-rqfrg3"></path></svg> <div class="empty-title svelte-rqfrg3">复习数据不足</div> <div class="empty-desc svelte-rqfrg3"> <br class="svelte-rqfrg3"/> 开始学习后即可查看分析图表</div></div>'),mse=la('<div class="data-warning svelte-rqfrg3"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-rqfrg3"><path d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" class="svelte-rqfrg3"></path></svg> <span class="svelte-rqfrg3"> </span></div>'),yse=la('<div class="empty-state svelte-rqfrg3"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4; margin-bottom: 24px;" class="svelte-rqfrg3"><path d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" class="svelte-rqfrg3"></path></svg> <div class="empty-title svelte-rqfrg3">无标签数据</div> <div class="empty-desc svelte-rqfrg3">当前牌组的卡片缺少标签信息<br class="svelte-rqfrg3"/> 为卡片添加标签后即可查看难度-标签分析</div></div>'),bse=la("<div></div> <div></div> <div></div> <div></div>",1),wse=la('<div class="deck-analytics-modal svelte-rqfrg3"><!> <div class="tabs-nav svelte-rqfrg3"><button>记忆率曲线图</button> <button>卡片数量变化双轴图</button> <button>复习时机分析图</button> <button>难度-标签矩阵图</button></div> <div class="toolbar svelte-rqfrg3"><div class="time-range-container svelte-rqfrg3"><div class="quick-range-section svelte-rqfrg3"><span class="section-label svelte-rqfrg3">快捷范围：</span> <div class="quick-range-buttons svelte-rqfrg3"></div></div> <div class="custom-range-section svelte-rqfrg3"><span class="section-label svelte-rqfrg3">自定义范围：</span> <div class="date-inputs svelte-rqfrg3"><input type="date" class="date-input svelte-rqfrg3"/> <span class="date-separator svelte-rqfrg3">至</span> <input type="date" class="date-input svelte-rqfrg3"/> <span class="days-indicator svelte-rqfrg3"> </span></div></div></div></div> <div><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-rqfrg3"><path d="M12 20V10M12 10l-4 4m4-4l4 4" class="svelte-rqfrg3"></path><path d="M12 4v2" class="svelte-rqfrg3"></path></svg> <span class="svelte-rqfrg3">滚动鼠标滚轮可快速切换快捷范围</span></div> <!> <!> <!></div>');function kse(e,t){if(new.target)return Er({component:kse,...e});kt(t,!0),eG([C1,b1,HJ,f2,R4,fK,UK,IY,AQ,j4]);let n=Ar(t,"open",15),i=Ar(t,"onClose",7),a=Ar(t,"plugin",7),r=Ar(t,"deckId",7),s=Ar(t,"cards",23,()=>[]),o=Pn("retention"),l=Pn(null),c=Pn(null),d=Pn(null),u=Pn(null),h=null,p=null,g=null,v=null,f=null;const m=In(()=>s()&&s().length>0),y=In(()=>s()&&s().filter(e=>e.reviewHistory&&e.reviewHistory.length>0).length>0),b=In(()=>s()?s().length:0),w=In(()=>s()?s().filter(e=>e.reviewHistory&&e.reviewHistory.length>0).length:0),k=new Date;let S=Pn(Ot(new Date(k.getTime()-2592e6))),x=Pn(Ot(k)),_=Pn(30),C=Pn(!1),I=!1;const D=[{value:7,label:"最近7天"},{value:14,label:"最近14天"},{value:30,label:"最近30天"},{value:60,label:"最近60天"},{value:90,label:"最近90天"}],T=In(()=>{const e=bi(x).getTime()-bi(S).getTime();return Math.round(e/864e5)});function M(){const e=document.body.classList.contains("theme-dark");return{textColor:e?"#e0e0e0":"#2c3e50",axisLineColor:e?"rgba(255, 255, 255, 0.15)":"rgba(0, 0, 0, 0.15)",splitLineColor:e?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",tooltipBg:e?"#1a1a1a":"#ffffff",tooltipBorder:e?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)"}}function A(e){const t=[];if(s()&&s().length>0){const n=s().filter(e=>e.reviewHistory&&e.reviewHistory.length>0),i=new Map,a=new Date;n.forEach(t=>{t.reviewHistory&&t.fsrs&&t.reviewHistory.forEach(n=>{const r=new Date(n.reviewDate),s=Math.floor((a.getTime()-r.getTime())/864e5);if(s>=0&&s<=e){i.has(s)||i.set(s,[]);const e=t.fsrs.retrievability?100*t.fsrs.retrievability:null;null!==e&&i.get(s).push(e)}})});for(let r=0;r<=e;r++){const e=i.get(r)||[],a=e.length>0?e.reduce((e,t)=>e+t,0)/e.length:null,s=n.length>0?n.reduce((e,t)=>{var n;return e+((null==(n=t.fsrs)?void 0:n.stability)||7)},0)/n.length:7,o=100*Math.exp(-r/s);t.push({day:r,predicted:o,actual:a,threshold:80})}}else for(let n=0;n<=e;n++){const e=7,i=100*Math.exp(-n/e);t.push({day:n,predicted:i,actual:null,threshold:80})}return t}function E(){if(!bi(l))return;h=qq(bi(l));const e=A(bi(_)),t=M(),n={tooltip:{trigger:"axis",backgroundColor:t.tooltipBg,borderColor:t.tooltipBorder,borderWidth:1,textStyle:{color:t.textColor,fontSize:14},shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.2)",extraCssText:"border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);",formatter(e){let n='<div style="padding: 12px; font-family: var(--font-interface);">';return n+=`<div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: ${t.textColor};">第 ${e[0].axisValue} 天</div>`,e.forEach(e=>{if(null!==e.value&&void 0!==e.value&&"number"==typeof e.value){let i=e.color;"预测保持率"===e.seriesName?i="#667eea":"实际保持率"===e.seriesName?i="#4facfe":"风险阈值"===e.seriesName&&(i="#f5576c"),n+='<div style="display: flex; align-items: center; margin: 8px 0; line-height: 1.4;">',n+=`<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${i}; margin-right: 10px;"></span>`,n+=`<span style="color: ${t.textColor}; font-size: 14px;">${e.seriesName}:</span>`,n+=`<strong style="margin-left: 8px; color: var(--interactive-accent); font-size: 15px;">${e.value.toFixed(1)}%</strong>`,n+="</div>"}}),n+="</div>",n}},legend:{data:["预测保持率","实际保持率","风险阈值"],bottom:20,textStyle:{color:t.textColor,fontSize:13},itemGap:20,icon:"roundRect",itemWidth:14,itemHeight:14},grid:{left:60,right:40,top:40,bottom:80},xAxis:{type:"category",data:e.map(e=>e.day),name:"天数",nameLocation:"middle",nameGap:30,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12},nameTextStyle:{color:t.textColor,fontSize:13}},yAxis:{type:"value",name:"记忆保持率 (%)",min:0,max:100,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,formatter:"{value}%",fontSize:12},nameTextStyle:{color:t.textColor,fontSize:13},splitLine:{lineStyle:{color:t.splitLineColor,type:"dashed"}}},series:[{name:"预测保持率",type:"line",data:e.map(e=>e.predicted),smooth:!0,lineStyle:{color:"#667eea",width:3},itemStyle:{color:"#667eea"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(102, 126, 234, 0.3)"},{offset:1,color:"rgba(102, 126, 234, 0.05)"}]}}},{name:"实际保持率",type:"line",data:e.map(e=>e.actual),smooth:!0,lineStyle:{color:"#4facfe",width:2,type:"solid"},itemStyle:{color:"#4facfe"},symbolSize:6},{name:"风险阈值",type:"line",data:e.map(e=>e.threshold),lineStyle:{color:"#f5576c",width:2,type:"dashed"},itemStyle:{color:"#f5576c"},symbol:"none"}]};h.setOption(n),h.on("click",function(e){"实际保持率"===e.seriesName&&e.value<80&&_e.debug(`第 ${e.name} 天的记忆保持率为 ${e.value.toFixed(1)}%`)})}function z(e){const t={dates:[],newCards:[],learning:[],review:[],mastered:[],masteryRate:[]},n=new Date;if(s()&&s().length>0)for(let i=e-1;i>=0;i--){const e=new Date(n);e.setDate(e.getDate()-i),e.setHours(23,59,59,999),t.dates.push(`${e.getMonth()+1}/${e.getDate()}`);let a=0,r=0,o=0,l=0;s().forEach(t=>{var n,i,s;if(new Date(t.created)<=e){switch(null!=(i=null==(n=t.fsrs)?void 0:n.state)?i:0){case 0:a++;break;case 1:case 3:r++;break;case 2:(null==(s=t.fsrs)?void 0:s.stability)&&t.fsrs.stability>21?l++:o++}}}),t.newCards.push(a),t.learning.push(r),t.review.push(o),t.mastered.push(l);const c=a+r+o+l,d=c>0?l/c*100:0;t.masteryRate.push(parseFloat(d.toFixed(1)))}else for(let i=e-1;i>=0;i--){const e=new Date(n);e.setDate(e.getDate()-i),t.dates.push(`${e.getMonth()+1}/${e.getDate()}`),t.newCards.push(0),t.learning.push(0),t.review.push(0),t.mastered.push(0),t.masteryRate.push(0)}return t}function P(){if(!bi(c))return;p=qq(bi(c));const e=z(bi(_)),t=M(),n={tooltip:{trigger:"axis",backgroundColor:t.tooltipBg,borderColor:t.tooltipBorder,borderWidth:1,textStyle:{color:t.textColor,fontSize:14},shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.2)",extraCssText:"border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);",axisPointer:{type:"cross"}},legend:{data:["新卡片","学习中","待复习","已掌握","掌握率"],bottom:20,textStyle:{color:t.textColor,fontSize:13},itemGap:20,icon:"circle"},grid:{left:"3%",right:"6%",bottom:"15%",top:"10%",containLabel:!0},xAxis:{type:"category",data:e.dates,name:"日期",nameLocation:"middle",nameGap:30,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12},nameTextStyle:{color:t.textColor,fontSize:13}},yAxis:[{type:"value",name:"卡片数量",position:"left",axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12},nameTextStyle:{color:t.textColor,fontSize:13},splitLine:{lineStyle:{color:t.splitLineColor,type:"dashed"}}},{type:"value",name:"掌握率 (%)",position:"right",min:0,max:100,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12,formatter:"{value}%"},nameTextStyle:{color:t.textColor,fontSize:13},splitLine:{show:!1}}],series:[{name:"新卡片",type:"bar",stack:"卡片",barWidth:"60%",itemStyle:{color:"#4facfe"},data:e.newCards},{name:"学习中",type:"bar",stack:"卡片",itemStyle:{color:"#feca57"},data:e.learning},{name:"待复习",type:"bar",stack:"卡片",itemStyle:{color:"#ff9ff3"},data:e.review},{name:"已掌握",type:"bar",stack:"卡片",itemStyle:{color:"#48dbfb"},data:e.mastered},{name:"掌握率",type:"line",yAxisIndex:1,smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:3,color:"#667eea"},itemStyle:{color:"#667eea",borderColor:"#fff",borderWidth:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(102, 126, 234, 0.3)"},{offset:1,color:"rgba(102, 126, 234, 0.05)"}]}},data:e.masteryRate}]};p.setOption(n)}function R(e){const t={dates:[],early:[],ontime:[],late:[]},n=new Date;if(s()&&s().length>0)for(let i=e-1;i>=0;i--){const e=new Date(n);e.setDate(e.getDate()-i);const a=e.toDateString();t.dates.push(`${e.getMonth()+1}/${e.getDate()}`);let r=0,o=0,l=0;s().forEach(e=>{e.reviewHistory&&0!==e.reviewHistory.length&&e.reviewHistory.forEach(e=>{const t=new Date(e.review),n=new Date(e.due);if(t.toDateString()===a){const e=(t.getTime()-n.getTime())/36e5;e<-24?r++:e>24?l++:o++}})});const c=r+o+l;c>0?(t.early.push(Math.round(r/c*100)),t.ontime.push(Math.round(o/c*100)),t.late.push(Math.round(l/c*100))):(t.early.push(0),t.ontime.push(0),t.late.push(0))}else for(let i=e-1;i>=0;i--){const e=new Date(n);e.setDate(e.getDate()-i),t.dates.push(`${e.getMonth()+1}/${e.getDate()}`),t.early.push(0),t.ontime.push(0),t.late.push(0)}return t}function $(){const e=[];if(!s()||0===s().length)return e;const t=new Map;return s().forEach(e=>{if(!e.tags||0===e.tags.length||!e.fsrs||void 0===e.fsrs.difficulty)return;const n=e.fsrs.difficulty;e.tags.forEach(e=>{t.has(e)||t.set(e,{difficulties:[],count:0});const i=t.get(e);i.difficulties.push(n),i.count++})}),t.forEach((t,n)=>{const i=t.difficulties.reduce((e,t)=>e+t,0)/t.difficulties.length;e.push({tag:n,difficulty:i,count:t.count})}),e.sort((e,t)=>t.count-e.count).slice(0,20)}function O(){if(!bi(u))return;v=qq(bi(u));const e=$(),t=M(),n={tooltip:{trigger:"item",backgroundColor:t.tooltipBg,borderColor:t.tooltipBorder,borderWidth:1,textStyle:{color:t.textColor,fontSize:14},shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.2)",extraCssText:"border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);",formatter(n){const i=e[n.dataIndex];let a='<div style="padding: 12px; font-family: var(--font-interface);">';return a+=`<div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: ${t.textColor};">${i.tag}</div>`,a+='<div style="display: flex; align-items: center; margin: 8px 0;">',a+=`<span style="color: ${t.textColor}; font-size: 14px;">难度:</span>`,a+=`<strong style="margin-left: 8px; color: var(--interactive-accent); font-size: 15px;">${i.difficulty.toFixed(1)}</strong>`,a+="</div>",a+='<div style="display: flex; align-items: center; margin: 8px 0;">',a+=`<span style="color: ${t.textColor}; font-size: 14px;">卡片数量:</span>`,a+=`<strong style="margin-left: 8px; color: var(--interactive-accent); font-size: 15px;">${i.count}张</strong>`,a+="</div>",a+="</div>",a}},grid:{left:60,right:40,top:40,bottom:80,containLabel:!0},xAxis:{type:"value",name:"卡片数量",nameLocation:"middle",nameGap:30,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12},nameTextStyle:{color:t.textColor,fontSize:13},splitLine:{lineStyle:{color:t.splitLineColor,type:"dashed"}}},yAxis:{type:"value",name:"难度",min:0,max:10,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12},nameTextStyle:{color:t.textColor,fontSize:13},splitLine:{lineStyle:{color:t.splitLineColor,type:"dashed"}}},series:[{type:"scatter",symbolSize:(t,n)=>8*Math.sqrt(e[n.dataIndex].count),data:e.map(e=>[e.count,e.difficulty]),itemStyle:{color(t){const n=e[t.dataIndex].difficulty;return n<4?"#4facfe":n<7?"#feca57":"#f5576c"},opacity:.8},emphasis:{itemStyle:{opacity:1,shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}},label:{show:!0,position:"top",formatter:t=>e[t.dataIndex].tag,fontSize:11,color:t.textColor,overflow:"truncate",width:80},labelLayout:{hideOverlap:!0,moveOverlap:"shiftY"}}]};v.setOption(n)}function L(){if(!bi(d))return;g=qq(bi(d));const e=R(bi(_)),t=M(),n={tooltip:{trigger:"axis",backgroundColor:t.tooltipBg,borderColor:t.tooltipBorder,borderWidth:1,textStyle:{color:t.textColor,fontSize:14},shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.2)",extraCssText:"border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);",axisPointer:{type:"shadow"},formatter(e){let n='<div style="padding: 12px; font-family: var(--font-interface);">';return n+=`<div style="font-weight: 600; font-size: 16px; margin-bottom: 12px; color: ${t.textColor};">${e[0].axisValue}</div>`,e.forEach(e=>{if(null!==e.value&&void 0!==e.value&&"number"==typeof e.value){const i={"提前复习":"#feca57","准时复习":"#26a641","延迟复习":"#f5576c"}[e.seriesName]||e.color;n+='<div style="display: flex; align-items: center; margin: 8px 0; line-height: 1.4;">',n+=`<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${i}; margin-right: 10px;"></span>`,n+=`<span style="color: ${t.textColor}; font-size: 14px;">${e.seriesName}:</span>`,n+=`<strong style="margin-left: 8px; color: var(--interactive-accent); font-size: 15px;">${e.value}%</strong>`,n+="</div>"}}),n+="</div>",n}},legend:{data:["提前复习","准时复习","延迟复习"],bottom:20,textStyle:{color:t.textColor,fontSize:13},itemGap:20,icon:"circle"},grid:{left:"3%",right:"4%",bottom:"15%",top:"10%",containLabel:!0},xAxis:{type:"category",data:e.dates,name:"日期",nameLocation:"middle",nameGap:30,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12,rotate:45},nameTextStyle:{color:t.textColor,fontSize:13}},yAxis:{type:"value",name:"百分比 (%)",max:100,axisLine:{lineStyle:{color:t.axisLineColor}},axisLabel:{color:t.textColor,fontSize:12,formatter:"{value}%"},nameTextStyle:{color:t.textColor,fontSize:13},splitLine:{lineStyle:{color:t.splitLineColor,type:"dashed"}}},series:[{name:"提前复习",type:"bar",stack:"total",barWidth:"60%",itemStyle:{color:"#feca57"},data:e.early},{name:"准时复习",type:"bar",stack:"total",itemStyle:{color:"#26a641"},emphasis:{itemStyle:{color:"#39d353"}},data:e.ontime},{name:"延迟复习",type:"bar",stack:"total",itemStyle:{color:"#f5576c"},data:e.late}]};g.setOption(n)}function N(){if(!h)return;const e=A(bi(_)),t={xAxis:{data:e.map(e=>e.day)},series:[{data:e.map(e=>e.predicted)},{data:e.map(e=>e.actual)},{data:e.map(e=>e.threshold)}]};requestAnimationFrame(()=>{null==h||h.setOption(t)})}function F(){if(!p)return;const e=z(bi(_)),t={xAxis:{data:e.dates},series:[{data:e.newCards},{data:e.learning},{data:e.review},{data:e.mastered},{data:e.masteryRate}]};requestAnimationFrame(()=>{null==p||p.setOption(t)})}function B(){if(!g)return;const e=R(bi(_)),t={xAxis:{data:e.dates},series:[{data:e.early},{data:e.ontime},{data:e.late}]};requestAnimationFrame(()=>{null==g||g.setOption(t)})}function j(){if(!v)return;const e={series:[{data:$().map(e=>[e.count,e.difficulty])}]};requestAnimationFrame(()=>{null==v||v.setOption(e)})}function U(e){const t=new Date,n=new Date(t.getTime()-24*e*60*60*1e3);$n(S,n,!0),$n(x,t,!0),$n(_,e,!0),"retention"===bi(o)?N():"quantity"===bi(o)?F():"timing"===bi(o)?B():"difficulty"===bi(o)&&j()}function V(){if(bi(S)>bi(x)){const e=bi(S);$n(S,bi(x),!0),$n(x,e,!0)}const e=bi(x).getTime()-bi(S).getTime();$n(_,Math.max(1,Math.round(e/864e5)),!0),"retention"===bi(o)?N():"quantity"===bi(o)?F():"timing"===bi(o)?B():"difficulty"===bi(o)&&j()}function q(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function H(e){if(e.preventDefault(),I)return;I=!0;const t=D.findIndex(e=>e.value===bi(T));if(e.deltaY<0){if(t<D.length-1){$n(C,!0);const e=D[t+1].value;requestAnimationFrame(()=>{U(e),setTimeout(()=>{$n(C,!1)},300)})}}else if(t>0){$n(C,!0);const e=D[t-1].value;requestAnimationFrame(()=>{U(e),setTimeout(()=>{$n(C,!1)},300)})}setTimeout(()=>{I=!1},200)}function W(){null==h||h.resize(),null==p||p.resize(),null==g||g.resize(),null==v||v.resize()}function G(e){$n(o,e,!0),setTimeout(()=>{"retention"===e?!h&&bi(l)?E():h&&h.resize():"quantity"===e?!p&&bi(c)?P():p&&p.resize():"timing"===e?!g&&bi(d)?L():g&&g.resize():"difficulty"===e&&(!v&&bi(u)?O():v&&v.resize())},50)}function Q(){"function"==typeof i()&&i()()}Pr(()=>{setTimeout(()=>{n()&&bi(l)&&(E(),bi(l).addEventListener("wheel",H,{passive:!1}))},100),window.addEventListener("resize",W),f=new MutationObserver(e=>{for(const t of e)if("attributes"===t.type&&"class"===t.attributeName){setTimeout(()=>(h&&(h.dispose(),h=null,bi(l)&&"retention"===bi(o)&&E()),p&&(p.dispose(),p=null,bi(c)&&"quantity"===bi(o)&&P()),g&&(g.dispose(),g=null,bi(d)&&"timing"===bi(o)&&L()),void(v&&(v.dispose(),v=null,bi(u)&&"difficulty"===bi(o)&&O()))),100);break}}),f.observe(document.body,{attributes:!0,attributeFilter:["class"]})}),Ti(()=>{n()&&setTimeout(()=>{"retention"===bi(o)&&bi(l)&&!h?E():"quantity"===bi(o)&&bi(c)&&!p?P():"timing"===bi(o)&&bi(d)&&!g?L():"difficulty"===bi(o)&&bi(u)&&!v&&O()},100)}),Rr(()=>{var e,t,n,i;null==h||h.dispose(),null==p||p.dispose(),null==g||g.dispose(),null==v||v.dispose(),null==(e=bi(l))||e.removeEventListener("wheel",H),null==(t=bi(c))||t.removeEventListener("wheel",H),null==(n=bi(d))||n.removeEventListener("wheel",H),null==(i=bi(u))||i.removeEventListener("wheel",H),window.removeEventListener("resize",W),null==f||f.disconnect()});var K={get open(){return n()},set open(e){n(e),hn()},get onClose(){return i()},set onClose(e){i(e),hn()},get plugin(){return a()},set plugin(e){a(e),hn()},get deckId(){return r()},set deckId(e){r(e),hn()},get cards(){return s()},set cards(e=[]){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},Z=ha(),Y=Qt(Z),X=e=>{zx(e,{get plugin(){return a()},title:"牌组分析",onClose:Q,enableTransparentMask:!1,enableWindowDrag:!1,keyboard:!0,get open(){return n()},set open(e){n(e)},children:(e,t)=>{var n=wse(),i=Gt(n),a=e=>{pa(e,sse())};xa(i,e=>{bi(C)&&e(a)});var r=Kt(i,2),h=Gt(r);let p;h.__click=[ose,G];var g=Kt(h,2);let v;g.__click=[lse,G];var f=Kt(g,2);let I;f.__click=[cse,G];var M=Kt(f,2);let A;M.__click=[dse,G],zt(r);var E=Kt(r,2),z=Gt(E),P=Gt(z),R=Kt(Gt(P),2);Ca(R,21,()=>D,_a,(e,t)=>{var n=hse();let i;n.__click=[use,U,t];var a=Gt(n,!0);zt(n),zi(e=>{i=Fa(n,1,"time-range-btn svelte-rqfrg3",null,i,e),va(a,bi(t).label)},[()=>({active:bi(T)===bi(t).value})]),pa(e,n)}),zt(R),zt(P);var $=Kt(P,2),O=Kt(Gt($),2),L=Gt(O);Za(L),L.__change=[pse,S,V];var N=Kt(L,4);Za(N),N.__change=[gse,x,V];var F=Kt(N,2),B=Gt(F);zt(F),zt(O),zt($),zt(z),zt(E);var j=Kt(E,2);let H;var W=Kt(j,2),Q=e=>{pa(e,vse())},K=e=>{var t=ha(),n=Qt(t),i=e=>{var t=fse(),n=Kt(Gt(t),4),i=Gt(n);Pt(2),zt(n),zt(t),zi(()=>{var e;return va(i,`当前牌组共有 ${null!=(e=bi(b))?e:""} 张卡片，但还没有复习记录`)}),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=mse(),n=Kt(Gt(t),2),i=Gt(n);zt(n),zt(t),zi(()=>{var e;return va(i,`数据量较少（已复习 ${null!=(e=bi(w))?e:""} 张卡片），分析结果仅供参考`)}),pa(e,t)};xa(n,e=>{bi(w)<5&&e(i)},!0),pa(e,t)};xa(n,e=>{bi(y)?e(a,!1):e(i)},!0),pa(e,t)};xa(W,e=>{bi(m)?e(K,!1):e(Q)});var Z=Kt(W,2),Y=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,yse())};xa(n,e=>{0===s().filter(e=>e.tags&&e.tags.length>0&&e.fsrs).length&&e(i)}),pa(e,t)};xa(Z,e=>{bi(m)&&"difficulty"===bi(o)&&e(Y)});var X=Kt(Z,2),J=e=>{var t=bse(),n=Qt(t);let i;kr(n,e=>$n(l,e),()=>bi(l));var a=Kt(n,2);let r;kr(a,e=>$n(c,e),()=>bi(c));var s=Kt(a,2);let h;kr(s,e=>$n(d,e),()=>bi(d));var p=Kt(s,2);let g;kr(p,e=>$n(u,e),()=>bi(u)),zi((e,t,o,l)=>{i=Fa(n,1,"chart-container svelte-rqfrg3",null,i,e),r=Fa(a,1,"chart-container svelte-rqfrg3",null,r,t),h=Fa(s,1,"chart-container svelte-rqfrg3",null,h,o),g=Fa(p,1,"chart-container svelte-rqfrg3",null,g,l)},[()=>({hidden:"retention"!==bi(o)}),()=>({hidden:"quantity"!==bi(o)}),()=>({hidden:"timing"!==bi(o)}),()=>({hidden:"difficulty"!==bi(o)})]),pa(e,t)};xa(X,e=>{bi(m)&&e(J)}),zt(n),zi((e,t,n,i,a,r,s,o,l,c)=>{var d;p=Fa(h,1,"tab-btn svelte-rqfrg3",null,p,e),v=Fa(g,1,"tab-btn svelte-rqfrg3",null,v,t),I=Fa(f,1,"tab-btn svelte-rqfrg3",null,I,n),A=Fa(M,1,"tab-btn svelte-rqfrg3",null,A,i),Ya(L,a),er(L,"max",r),Ya(N,s),er(N,"min",o),er(N,"max",l),va(B,`（${null!=(d=bi(_))?d:""}天）`),H=Fa(j,1,"scroll-hint svelte-rqfrg3",null,H,c)},[()=>({active:"retention"===bi(o)}),()=>({active:"quantity"===bi(o)}),()=>({active:"timing"===bi(o)}),()=>({active:"difficulty"===bi(o)}),()=>q(bi(S)),()=>q(bi(x)),()=>q(bi(x)),()=>q(bi(S)),()=>q(k),()=>({visible:!bi(C)})]),pa(e,n)},$$slots:{default:!0}})};return xa(Y,e=>{n()&&e(X)}),pa(e,Z),St(K)}ia(["click","change"]);var Sse=la('<div class="deck-loading-overlay svelte-vh2cdq"><!></div>'),xse=la('<div class="deck-study-content svelte-vh2cdq"><!></div>'),_se=la('<div class="anki-app deck-study-page svelte-vh2cdq"><!></div>   <!> <!> <!> <!> <!> <!> <!> <!>',1);function Cse(e,t){if(new.target)return Er({component:Cse,...e});kt(t,!0);const[n,i]=Dr();let a=Ar(t,"dataStorage",7),r=Ar(t,"fsrs",7),s=Ar(t,"plugin",7),o=Pn(Ot([])),l=Pn(!1),c=Pn(!1),d=Pn(!0),u=Pn(!1),h=Pn(null),p=Pn(null),g=Pn(!1),v=Pn(null),f=Pn(!1),m=Pn(""),y=Pn(null),b=Pn(!1),w=Pn(""),k=Pn("empty"),S=Pn(void 0),x=Pn(""),_=Pn(!1),C=Pn(void 0),I=Pn(Ot([])),D=Pn(Ot([])),T=Pn(Ot([])),M=Pn(Ot(new Set)),A=Pn(Ot([])),E=Pn(Ot({})),z=Pn(Ot([])),P=Pn("grid"),R=Pn("memory");const $=Qh.getInstance();let O=Pn(!1),L=Pn(!1),N=Pn("");async function F(e=!1){e&&$n(d,!0);try{$n(D,await a().getDecks(),!0),$n(A,await a().getCards(),!0),await async function(){var e,t,n;(new Date).setHours(0,0,0,0);const i={},r=Dee(bi(A)),{CardInstanceProvider:o}=await Promise.resolve().then(()=>Aee),l=new o,c=null==(n=null==(t=null==(e=s().settings.studyConfig)?void 0:e.siblingDispersion)?void 0:t.filterInQueue)||n,{getLearnedNewCardsCountToday:d,getRemainingNewCardsQuota:u}=await Promise.resolve().then(()=>_ie),h=s().settings.newCardsPerDay||20,p={},g={},v={},f={},m={};for(const a of r){const e=a.deckId,t=l.getTodaysInstances(a,{onlyDue:!0});if(0===t.length)continue;const n=t[0].fsrs;n&&0===n.state&&(m[e]=(m[e]||0)+1)}for(const s of Object.keys(m))v[s]=await d(a(),s),f[s]=u(h,v[s]);let y=r;if(c){const{filterProgressiveSiblings:e}=await Promise.resolve().then(()=>_ie);y=e(r),_e.info(`[calculateDeckStats] ✅ 兄弟过滤已启用: ${r.length} → ${y.length} 张卡片`)}else _e.info(`[calculateDeckStats] ⚠️  兄弟过滤已禁用: 统计所有 ${y.length} 张卡片`);const b={};for(const a of y){const e=a.deckId;i[e]||(i[e]={totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:0,forecastDays:{}},p[e]=0,g[e]=0,b[e]=0);const t=l.getTodaysInstances(a,{onlyDue:!0});if(0===t.length)continue;const n=t[0].fsrs;if(!n){_e.warn(`[DeckStudyPage] Missing FSRS data for card: ${a.uuid}`);continue}if(p[e]++,i[e].totalCards++,0===n.state){const t=f[e]||0,n=b[e]||0;n<t&&(i[e].newCards+=1,b[e]=n+1)}else 1===n.state?i[e].learningCards+=1:2===n.state&&(i[e].reviewCards+=1);const r=Math.max(0,n.elapsedDays||0),s=Math.max(.01,n.stability||.01),o=Math.exp(-r/s);g[e]+=o}for(const a of Object.keys(i)){const e=Math.max(1,p[a]);i[a].memoryRate=g[a]/e}$n(E,i,!0);const w=Object.keys(f).map(e=>{var t;return{deckId:e,totalNewCards:m[e]||0,learnedToday:v[e]||0,remainingQuota:f[e]||0,displayed:(null==(t=i[e])?void 0:t.newCards)||0}});_e.debug("[DeckStudyPage] 统计完成 (应用每日新卡片限制):",{newCardsPerDay:h,stats:i,quotaInfo:w,deckInstanceCounts:p})}(),await async function(){try{const e=await die(()=>{var e;return null==(e=s())?void 0:e.deckHierarchy},"deckHierarchy",5e3);$n(T,await e.getDeckTree(),!0);localStorage.getItem("tuanki-deck-expanded-state")?le():0===bi(M).size&&(bi(T).forEach(e=>{bi(M).add(e.deck.id)}),$n(M,new Set(bi(M)),!0),function(){try{const e=Array.from(bi(M));localStorage.setItem("tuanki-deck-expanded-state",JSON.stringify(e))}catch(e){_e.error("Failed to save expanded state:",e)}}())}catch(e){_e.error("[DeckStudyPage] Failed to load deck tree:",e),$n(T,[],!0)}}(),await async function(){try{const e=new Date;e.setDate(e.getDate()-30),$n(z,await a().getStudySessions({since:e.toISOString()}),!0)}catch(e){_e.error("[DeckStudyPage] 加载学习历史失败:",e),$n(z,[],!0)}}()}finally{e&&$n(d,!1)}}async function B(){var e,t,n;try{let i=0===bi(z).length?null:[...bi(z)].sort((e,t)=>new Date(t.startTime).getTime()-new Date(e.startTime).getTime())[0].deckId;if(!i)for(const a of Object.keys(bi(E))){const r=bi(E)[a];if((null!=(e=null==r?void 0:r.newCards)?e:0)+(null!=(t=null==r?void 0:r.learningCards)?t:0)+(null!=(n=null==r?void 0:r.reviewCards)?n:0)>0){i=a;break}}i?await G(i):new ge.Notice("没有需要学习的卡片")}catch(i){_e.error("[DeckStudyPage] 继续学习失败:",i),new ge.Notice("启动学习时出错，请重试")}}async function j(e){var t,n,i,a,r,o,l,c;if(e.success){const r=`导入成功！牌组: ${e.deckName||"未知"}, 导入: ${e.stats.importedCards} 张卡片`,o=(null==(a=null==(i=null==(n=null==(t=s().app)?void 0:t.plugins)?void 0:n.plugins)?void 0:i.obsidian)?void 0:a.Notice)||globalThis.Notice||((...e)=>_e.info(e.join(" ")));"function"==typeof o&&new o(`✅ ${r}`,5e3),await F()}else{const t=e.errors&&e.errors.length>0?e.errors[0].message:"导入失败",n=(null==(c=null==(l=null==(o=null==(r=s().app)?void 0:r.plugins)?void 0:o.plugins)?void 0:l.obsidian)?void 0:c.Notice)||globalThis.Notice||((...e)=>_e.error(e.join(" ")));"function"==typeof n&&new n(`❌ ${t}`,8e3)}}async function U(){const e=document.createElement("input");e.type="file",e.accept=".csv",e.onchange=async e=>{var t,n,i,o,l,c,d,u,h;const p=null==(t=e.target.files)?void 0:t[0];if(p)try{const e=await p.text(),t=await async function(e,t){var n,i;try{const s=e.split("\n").map(e=>e.trim()).filter(e=>e);if(s.length<2)throw new Error("CSV文件至少需要包含标题行和一行数据");const o=V(s[0]),l=q(o,["question","问题","front","正面","题目"]),c=q(o,["answer","答案","back","背面","答复"]);if(-1===l||-1===c)throw new Error("CSV文件必须包含问题和答案列。支持的列名：question/问题/front/正面/题目 和 answer/答案/back/背面/答复");const d=t.replace(/\.csv$/i,""),u={id:Gu(),name:d,description:`从CSV文件导入: ${t}`,category:"imported",path:d,level:0,order:0,inheritSettings:!1,includeSubdecks:!1,created:(new Date).toISOString(),modified:(new Date).toISOString(),settings:{newCardsPerDay:20,maxReviewsPerDay:100,enableAutoAdvance:!1,showAnswerTime:0,fsrsParams:{w:[.4,.6,2.4,5.8,4.93,.94,.86,.01,1.49,.14,.94,2.18,.05,.34,1.26,.29,2.61],requestRetention:.9,maximumInterval:36500,enableFuzz:!0},learningSteps:[1,10],relearningSteps:[10],graduatingInterval:1,easyInterval:4},stats:{totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:2.5,forecastDays:{}},tags:["csv-import"],metadata:{importedFrom:t,importDate:(new Date).toISOString()}},h=await a().saveDeck(u);if(!h.success)throw new Error(`创建牌组失败: ${h.error}`);const p=[];for(let e=1;e<s.length;e++){const t=V(s[e]);if(t.length<=Math.max(l,c))continue;const a=null==(n=t[l])?void 0:n.trim(),d=null==(i=t[c])?void 0:i.trim();if(!a||!d)continue;const h={};o.forEach((e,n)=>{n!==l&&n!==c&&t[n]&&(h[e]=t[n].trim())});const g={uuid:Vu(),deckId:u.id,templateId:"default",type:Kr.Basic,content:`${a}\n---div---\n${d}`,fields:{question:a,answer:d,...h},fsrs:r().createCard(),reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},created:(new Date).toISOString(),modified:(new Date).toISOString()};p.push(g)}if(0===p.length)throw new Error("没有找到有效的卡片数据");let g=0;for(const e of p){(await a().saveCard(e)).success&&g++}return{success:!0,cardsCount:g,deckName:u.name}}catch(s){return{success:!1,error:s instanceof Error?s.message:String(s)}}}(e,p.name);if(!t.success)throw new Error(t.error||"导入失败");{const e=(null==(l=null==(o=null==(i=null==(n=s().app)?void 0:n.plugins)?void 0:i.plugins)?void 0:o.obsidian)?void 0:l.Notice)||globalThis.Notice||((...e)=>_e.info(e.join(" ")));"function"==typeof e&&new e(`成功导入 ${t.cardsCount} 张卡片到牌组 "${t.deckName}"`,5e3),await F()}}catch(g){_e.error("CSV导入失败",g);const e=(null==(h=null==(u=null==(d=null==(c=s().app)?void 0:c.plugins)?void 0:d.plugins)?void 0:u.obsidian)?void 0:h.Notice)||globalThis.Notice||((...e)=>_e.error(e.join(" ")));if("function"==typeof e){new e(`CSV导入失败: ${g instanceof Error?g.message:String(g)}`,5e3)}}},e.click()}function V(e){const t=[];let n="",i=!1,a=0;for(;a<e.length;){const r=e[a];'"'===r?i&&'"'===e[a+1]?(n+='"',a+=2):(i=!i,a++):","!==r||i?(n+=r,a++):(t.push(n),n="",a++)}return t.push(n),t}function q(e,t){for(const n of t){const t=e.findIndex(e=>e.toLowerCase()===n.toLowerCase());if(-1!==t)return t}return-1}async function H(){try{const e=await a().exportData(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=`anki-data-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}catch(e){_e.error("导出失败",e)}}Ti(()=>$.isPremiumActive.subscribe(e=>{$n(O,e,!0)})),Pr(()=>{let e,t,n;(async()=>{const i=localStorage.getItem("tuanki-deck-mode-filter");i&&["memory","reading","question-bank","parent","child","all"].includes(i)&&(["parent","child","all"].includes(i)?$n(R,"memory"):$n(R,i,!0));try{const e=await s().loadData(),t=(null==e?void 0:e.deckView)||localStorage.getItem("tuanki-deck-view");if(t&&["kanban","grid"].includes(t)?$n(P,t,!0):"classic"!==t&&"timeline"!==t&&"card"!==t||($n(P,"grid"),await s().saveData({...e,deckView:"grid"})),localStorage.getItem("tuanki-deck-view")&&(null==e?void 0:e.deckView)!==localStorage.getItem("tuanki-deck-view")){const t=localStorage.getItem("tuanki-deck-view");t&&["kanban","grid"].includes(t)?(await s().saveData({...e,deckView:t}),$n(P,t,!0)):"classic"===t&&(await s().saveData({...e,deckView:"grid"}),$n(P,"grid"))}}catch(a){_e.warn("加载视图偏好失败:",a);const e=localStorage.getItem("tuanki-deck-view");e&&["kanban","grid"].includes(e)?$n(P,e,!0):"classic"===e&&$n(P,"grid")}s().dataSyncService&&(e=s().dataSyncService.subscribe("decks",async e=>{await F(!1)},{debounce:300}),t=s().dataSyncService.subscribe("sessions",async e=>{await F(!1)},{debounce:300}),n=s().dataSyncService.subscribe("cards",async e=>{await F(!1)},{debounce:500}))})();const i=async()=>{await F(!1)},a=async()=>{_e.debug("[DeckStudyPage] 接收到卡片更新事件，刷新数据"),await F(!1)};return s().app.workspace.on("tuanki:card-created",i),s().app.workspace.on("tuanki:card-updated",a),le(),F(),()=>{e&&e(),t&&t(),n&&n(),s().app.workspace.off("tuanki:card-created",i),s().app.workspace.off("tuanki:card-updated",a)}}),Ti(()=>{const e=e=>{!function(e){const t=new ge.Menu;[{id:"grid",label:"网格卡片",icon:"grid",desc:"色卡风格，多彩展示"},{id:"kanban",label:"看板视图",icon:"columns",desc:"按阶段组织，可视化流程"}].forEach(e=>{t.addItem(t=>{t.setTitle(e.label).setIcon(e.icon).setChecked(bi(P)===e.id).onClick(async()=>{$n(P,e.id,!0);try{const t=await s().loadData();await s().saveData({...t,deckView:e.id})}catch(t){_e.warn("[DeckStudyPage] 保存视图偏好失败，降级到localStorage:",t),localStorage.setItem("tuanki-deck-view",e.id)}})})}),t.showAtMouseEvent(e)}(e.detail.event)};return window.addEventListener("show-view-menu",e),()=>{window.removeEventListener("show-view-menu",e)}});let W=!1;async function G(e){var t,n,i,r,l,c,d,u,h,p,g,v,_,C,I,T,M;if(W)_e.debug("[DeckStudyPage] 正在启动学习，忽略重复点击");else try{W=!0,$n(o,[],!0);const C=bi(D).find(t=>t.id===e),I=await a().getCards({deckId:e}),T=Dee(I);_e.debug("[DeckStudyPage] 🔍 卡片过滤:",{deckId:e.slice(0,8),totalCards:I.length,afterFilterRecycled:T.length});const M=s().settings.newCardsPerDay||20,A=s().settings.reviewsPerDay||20,P=await mie(a(),e),R=await bie(T,M,P);if(_e.debug("[DeckStudyPage] 🔍 学习状态检查:",{deckId:e.slice(0,8),allCardsCount:T.length,isComplete:R,newCardsPerDay:M,learnedNewCardsToday:P}),R)_e.debug(`[DeckStudyPage] ✅ 牌组 ${e.slice(0,8)} 今日学习已完成`);else{const r=null==(i=null==(n=null==(t=s().settings.studyConfig)?void 0:t.siblingDispersion)?void 0:n.filterInQueue)||i;$n(o,await Sie(a(),e,M,A,r),!0),_e.debug("[DeckStudyPage] ✅ 加载卡片完成:",{studyCardsLength:bi(o).length,newCardsPerDay:M,learnedNewCardsToday:P,cardIds:bi(o).slice(0,3).map(e=>e.uuid.slice(0,8))})}const $=bi(o)&&bi(o).length>0;if(_e.debug("[DeckStudyPage] 🎯 最终决策:",{studyCardsLength:null!=(l=null==(r=bi(o))?void 0:r.length)?l:0,hasValidCards:$,willOpenSession:$}),$){const t=bi(o).map(e=>e.uuid);_e.info("[DeckStudyPage] 📖 打开学习界面:",{deckId:e.slice(0,8),cardCount:bi(o).length,cardIds:t.slice(0,3).map(e=>e.slice(0,8))}),await s().openStudySession({deckId:e,cardIds:t})}else{_e.info("[DeckStudyPage] ⚠️ 无可学卡片，显示提示模态窗");const t=bi(E)[e],n=T.length,i=null!=(c=null==t?void 0:t.totalCards)?c:0,a=null!=(d=null==t?void 0:t.newCards)?d:0,r=null!=(u=null==t?void 0:t.learningCards)?u:0,s=null!=(h=null==t?void 0:t.reviewCards)?h:0;if(_e.debug("[DeckStudyPage] 📊 卡片数量对比:",{deckId:e.slice(0,8),physicalTotal:n,learnableTotal:i,newCards:a,learningCards:r,reviewCards:s}),0===n)$n(w,(null==C?void 0:C.name)||"牌组",!0),$n(k,"empty"),$n(S,void 0),$n(x,e,!0),$n(b,!0);else if(R&&(r>0||s>0||0===a)){const n=`celebration-last-shown-${e}`,i=localStorage.getItem(n),a=Date.now(),r=18e5;if(!i||a-parseInt(i)>r){const i=new Date;i.setHours(0,0,0,0);const r=new Date;r.setHours(23,59,59,999);const s=bi(z).filter(t=>{const n=new Date(t.startTime);return t.deckId===e&&n>=i&&n<=r}),o=s.reduce((e,t)=>e+(t.totalTime||0),0)/1e3,l=s.reduce((e,t)=>e+(t.cardsReviewed||0),0);$n(m,(null==C?void 0:C.name)||"牌组",!0),$n(y,{reviewed:l,studyTime:o,memoryRate:null!=(p=null==t?void 0:t.memoryRate)?p:.9,newCards:null!=(g=null==t?void 0:t.newCards)?g:0},!0),$n(f,!0),localStorage.setItem(n,a.toString())}else{const n=new Date;n.setHours(0,0,0,0);const i=new Date;i.setHours(23,59,59,999);const a=bi(z).filter(t=>{const a=new Date(t.startTime);return t.deckId===e&&a>=n&&a<=i}),r=a.reduce((e,t)=>e+(t.totalTime||0),0)/1e3,s=a.reduce((e,t)=>e+(t.cardsReviewed||0),0);$n(m,(null==C?void 0:C.name)||"牌组",!0),$n(y,{reviewed:s,studyTime:r,memoryRate:null!=(v=null==t?void 0:t.memoryRate)?v:.9,newCards:null!=(_=null==t?void 0:t.newCards)?_:0},!0),$n(f,!0)}}else if(a>0&&P>=M){$n(w,(null==C?void 0:C.name)||"牌组",!0),$n(k,"all-learned");const t=T.filter(e=>e.fsrs&&new Date(e.fsrs.due)>new Date).sort((e,t)=>new Date(e.fsrs.due).getTime()-new Date(t.fsrs.due).getTime())[0],a=t?J(new Date(t.fsrs.due)):void 0;$n(S,{totalCards:n,learnedCards:n-i,nextDueTime:a,todayNewCards:P,todayNewLimit:M},!0),$n(x,e,!0),$n(b,!0)}else{$n(w,(null==C?void 0:C.name)||"牌组",!0),$n(k,"no-due");const t=T.filter(e=>e.fsrs&&new Date(e.fsrs.due)>new Date).sort((e,t)=>new Date(e.fsrs.due).getTime()-new Date(t.fsrs.due).getTime())[0],a=t?J(new Date(t.fsrs.due)):void 0;$n(S,{totalCards:n,learnedCards:n-i,nextDueTime:a,todayNewCards:P,todayNewLimit:M},!0),$n(x,e,!0),$n(b,!0)}}}catch(A){_e.error("Error starting study:",A);const e=(null==(M=null==(T=null==(I=null==(C=s().app)?void 0:C.plugins)?void 0:I.plugins)?void 0:T.obsidian)?void 0:M.Notice)||globalThis.Notice;"function"==typeof e&&new e("启动学习时出错，请重试。",3e3)}finally{W=!1}}async function Q(e){var t;try{bi(D).find(t=>t.id===e);const n=await a().getCards({deckId:e}),i=Dee(n);_e.debug("[DeckStudyPage] 📚 牌组卡片（提前学习）:",{deckId:e,totalCards:n.length,afterFilterRecycled:i.length,sampleCardIds:i.slice(0,5).map(e=>e.uuid.slice(0,8)),cardTypes:i.slice(0,5).map(e=>e.type),parentCards:i.filter(e=>"progressive-parent"===e.type).length,childCards:i.filter(e=>"progressive-child"===e.type).length});const r=wie(i,20,s().settings.maxAdvanceDays||7);if(0===r.length)return void new ge.Notice("暂无可提前学习的卡片");_e.debug(`[DeckStudyPage] 🆕 提前学习: ${r.length} 张卡片`,{cardCount:r.length,cardIds:r.map(e=>e.uuid.slice(0,8)),cardTypes:r.map(e=>e.type),sampleCard:{uuid:r[0].uuid.slice(0,8),type:r[0].type,isProgressiveParent:"progressive-parent"===r[0].type,isProgressiveChild:"progressive-child"===r[0].type,hasFsrs:!!r[0].fsrs,fsrsState:null==(t=r[0].fsrs)?void 0:t.state}});const o=r.map(e=>e.uuid);_e.debug("[DeckStudyPage] 📤 传递给openStudySession:",{deckId:e,mode:"advance",cardIdsCount:o.length,cardIds:o.map(e=>e.slice(0,8))}),await s().openStudySession({deckId:e,mode:"advance",cardIds:o}),new ge.Notice(`开始提前学习（${r.length} 张未到期卡片）`)}catch(n){_e.error("[DeckStudyPage] 启动提前学习失败:",n),new ge.Notice("启动提前学习失败")}}function K(){$n(f,!1),$n(y,null)}function Z(){$n(b,!1)}async function Y(){$n(b,!1),bi(x)&&await Q(bi(x))}function X(){$n(b,!1),bi(x)&&se(bi(x))}function J(e){const t=new Date,n=e.getTime()-t.getTime(),i=Math.floor(n/36e5),a=Math.floor(i/24);if(a>1){return`${`${e.getMonth()+1}/${e.getDate()}`} ${`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}`}if(1===a){return`明天 ${`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}`}if(i>0)return`${i} 小时后`;return`${Math.floor(n/6e4)} 分钟后`}async function ee(e){const t=bi(D).find(t=>t.id===e);t&&($n(h,t,!0),$n(u,!0))}async function te(e){try{const t=await die(()=>{var e;return null==(e=s())?void 0:e.deckHierarchy},"deckHierarchy",5e3),n=(await t.getChildren(e),await t.getDescendants(e));let i="确定要删除该牌组及其所有卡片吗？";n.length>0&&(i=`该牌组包含 ${n.length} 个子牌组，将一并删除。\n\n子牌组列表：\n${n.map(e=>`• ${e.name}`).slice(0,5).join("\n")}`+(n.length>5?`\n...还有 ${n.length-5} 个`:"")+"\n\n确定要删除吗？");if(!confirm(i))return;new ge.Notice("🗑️ 正在删除牌组..."),await t.deleteDeckWithChildren(e),$n(D,await a().getDecks(),!0),await F();const r=n.length+1;new ge.Notice(`✅ 成功删除 ${r} 个牌组`)}catch(t){_e.error("[DeckStudyPage] 删除牌组失败:",t),new ge.Notice(`❌ 删除失败: ${t instanceof Error?t.message:"未知错误"}`)}}function ne(e){$n(p,e,!0),$n(l,!0)}function ie(e){const t=bi(D).find(t=>t.id===e);t&&($n(v,t,!0),$n(g,!0))}async function ae(e){if(bi(v))try{new ge.Notice("🔄 正在移动牌组...");const t=await die(()=>{var e;return null==(e=s())?void 0:e.deckHierarchy},"deckHierarchy",5e3);await t.moveDeck(bi(v).id,e),await F(),new ge.Notice("✅ 牌组移动成功")}catch(t){_e.error("[DeckStudyPage] 移动牌组失败:",t),new ge.Notice(`❌ 移动失败: ${t instanceof Error?t.message:"未知错误"}`)}finally{$n(g,!1),$n(v,null)}}function re(){$n(g,!1),$n(v,null)}async function se(e){try{const t=bi(A).filter(t=>t.deckId===e);$n(C,e,!0),$n(I,t,!0),$n(_,!0),_e.debug("[DeckStudyPage] 打开牌组分析:",{deckId:e,cardCount:t.length})}catch(t){_e.error("[DeckStudyPage] 打开牌组分析失败:",t),new ge.Notice("打开牌组分析失败")}}function oe(){$n(_,!1),$n(C,void 0),$n(I,[],!0)}function le(){try{const e=localStorage.getItem("tuanki-deck-expanded-state");if(e){const t=JSON.parse(e);$n(M,new Set(t),!0)}}catch(e){_e.error("Failed to load expanded state:",e),$n(M,new Set,!0)}}Ti(()=>{(async()=>{try{$n(d,!0),await F()}catch(e){_e.error("[DeckStudyPage] ❌ 初始化失败:",e)}finally{$n(d,!1)}})()}),Ti(()=>{const e=()=>{$n(l,!0)},t=e=>{var t;const n=null==(t=e.detail)?void 0:t.event;n&&function(e){const t=new ge.Menu;t.addItem(e=>{e.setTitle("旧版APKG格式导入").setIcon("package").onClick(()=>{$n(c,!0)})}),t.addItem(e=>{e.setTitle("导入CSV文件").setIcon("file-text").onClick(U)}),t.addItem(e=>{e.setTitle("导出JSON数据").setIcon("download").setDisabled(0===bi(D).length).onClick(H)}),t.showAtMouseEvent(e)}(n)};return document.addEventListener("create-deck",e),document.addEventListener("more-actions",t),()=>{document.removeEventListener("create-deck",e),document.removeEventListener("more-actions",t)}});var ce={get dataStorage(){return a()},set dataStorage(e){a(e),hn()},get fsrs(){return r()},set fsrs(e){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},de=_se(),ue=Qt(de),he=Gt(ue),pe=e=>{var t=Sse();Qg(Gt(t),{message:"正在加载牌组数据..."}),zt(t),pa(e,t)},ve=e=>{var t=xse(),n=Gt(t),i=e=>{Ere(e,{get deckTree(){return bi(T)},get deckStats(){return bi(E)},get studySessions(){return bi(z)},get plugin(){return s()},onStartStudy:G,onContinueStudy:B,onAdvanceStudy:Q,onOpenDeckAnalytics:se,onCreateSubdeck:ne,onMoveDeck:ie,onEditDeck:ee,onDeleteDeck:te,onRefreshData:F})},r=e=>{var t=ha(),n=Qt(t),i=e=>{eae(e,{get deckTree(){return bi(T)},get deckStats(){return bi(E)},get dataStorage(){return a()},get plugin(){return s()},onStartStudy:G,onDeckUpdate:F,onEditDeck:ee,onDeleteDeck:te,onCreateSubdeck:ne,onMoveDeck:ie})};xa(n,e=>{"kanban"===bi(P)&&e(i)},!0),pa(e,t)};xa(n,e=>{"grid"===bi(P)?e(i):e(r,!1)}),zt(t),pa(e,t)};xa(he,e=>{bi(d)?e(pe):e(ve,!1)}),zt(ue);var fe=Kt(ue,2),me=e=>{Jte(e,{get open(){return bi(u)},get plugin(){return s()},get dataStorage(){return a()},mode:"edit",get initialDeck(){return bi(h)},onClose:()=>{$n(u,!1),$n(h,null)},onUpdated:()=>{$n(u,!1),$n(h,null),F()}})};xa(fe,e=>{bi(u)&&bi(h)&&e(me)});var ye=Kt(fe,2),be=e=>{Jte(e,{get open(){return bi(l)},get plugin(){return s()},get dataStorage(){return a()},get parentDeckId(){return bi(p)},onClose:()=>{$n(l,!1),$n(p,null)},onCreated:async()=>{$n(l,!1),$n(p,null),await F()}})};xa(ye,e=>{bi(l)&&e(be)});var we=Kt(ye,2),ke=e=>{Wne(e,{get show(){return bi(c)},get plugin(){return s()},get dataStorage(){return a()},wasmUrl:"https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.wasm",onClose:()=>{$n(c,!1)},onImportComplete:j})};xa(we,e=>{bi(c)&&e(ke)});var Se=Kt(we,2),xe=e=>{cie(e,{get open(){return bi(g)},get currentDeck(){return bi(v)},get deckTree(){return bi(T)},onconfirm:ae,oncancel:re})};xa(Se,e=>{bi(g)&&bi(v)&&e(xe)});var Ce=Kt(Se,2),Ie=e=>{Qre(e,{get deckName(){return bi(m)},get stats(){return bi(y)},soundEnabled:!0,onClose:K})};xa(Ce,e=>{bi(f)&&bi(y)&&e(Ie)});var De=Kt(Ce,2),Te=e=>{rse(e,{get deckName(){return bi(w)},get reason(){return bi(k)},get stats(){return bi(S)},onClose:Z,onAdvanceStudy:Y,onViewStats:X})};xa(De,e=>{bi(b)&&e(Te)});var Me=Kt(De,2),Ae=e=>{kse(e,{get open(){return bi(_)},get plugin(){return s()},get deckId(){return bi(C)},get cards(){return bi(I)},onClose:oe})};xa(Me,e=>{bi(_)&&e(Ae)}),s3(Kt(Me,2),{get featureId(){return bi(N)},get visible(){return bi(L)},onClose:()=>$n(L,!1)}),pa(e,de);var Ee=St(ce);return i(),Ee}ia(["contextmenu","click"]);var Ise=(e,t,n)=>t(bi(n)),Dse=(e,t,n)=>t(e,bi(n)),Tse=la('<span class="tuanki-tab-badge svelte-hzfimg"> </span>'),Mse=la('<div class="tuanki-tab-icon svelte-hzfimg"><!> <!></div>'),Ase=la('<span class="tuanki-tab-badge tuanki-tab-badge-standalone svelte-hzfimg"> </span>'),Ese=la('<button role="tab"><!> <span class="tuanki-tab-label svelte-hzfimg"> </span> <!></button>'),zse=la('<div class="tuanki-tab-indicator svelte-hzfimg"></div>'),Pse=la('<div class="tuanki-tabs-spacer svelte-hzfimg"></div>'),Rse=la('<div role="tablist"><!> <!> <!></div>');function $se(e,t){if(new.target)return Er({component:$se,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"items",7),s=Ar(t,"activeId",7),o=Ar(t,"onChange",7),l=Ar(t,"variant",7,"default"),c=Ar(t,"size",7,"md"),d=Ar(t,"orientation",7,"horizontal"),u=Ar(t,"fullWidth",7,!1),h=Ar(t,"animated",7,!0),p=In(n),g=In(()=>r().findIndex(e=>e.id===s())),v=In(()=>{if(!h()||-1===bi(g))return"";if("horizontal"===d()){const e=100/r().length;return`transform: translateX(${100*bi(g)}%); width: ${e}%;`}{const e=100/r().length;return`transform: translateY(${100*bi(g)}%); height: ${e}%;`}});function f(e){e.disabled||o()(e.id)}function m(e,t){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),f(t))}var y={get items(){return r()},set items(e){r(e),hn()},get activeId(){return s()},set activeId(e){s(e),hn()},get onChange(){return o()},set onChange(e){o(e),hn()},get variant(){return l()},set variant(e="default"){l(e),hn()},get size(){return c()},set size(e="md"){c(e),hn()},get orientation(){return d()},set orientation(e="horizontal"){d(e),hn()},get fullWidth(){return u()},set fullWidth(e=!1){u(e),hn()},get animated(){return h()},set animated(e=!0){h(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},b=Rse();let w;var k=Gt(b);Ca(k,17,r,_a,(e,t)=>{var n=Ese();let i;n.__click=[Ise,f,t],n.__keydown=[Dse,m,t];var a=Gt(n),r=e=>{var n=Mse(),i=Gt(n);{let e=In(()=>"sm"===c()?14:"lg"===c()?18:16);Ng(i,{get name(){return bi(t).icon},get size(){return bi(e)}})}var a=Kt(i,2),r=e=>{var n=Tse(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t).badge)),pa(e,n)};xa(a,e=>{bi(t).badge&&e(r)}),zt(n),pa(e,n)};xa(a,e=>{bi(t).icon&&e(r)});var o=Kt(a,2),l=Gt(o,!0);zt(o);var d=Kt(o,2),u=e=>{var n=Ase(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t).badge)),pa(e,n)};xa(d,e=>{bi(t).badge&&!bi(t).icon&&e(u)}),zt(n),zi((e,a)=>{er(n,"tabindex",bi(t).disabled?void 0:0),er(n,"aria-selected",s()===bi(t).id),er(n,"aria-disabled",bi(t).disabled),i=Fa(n,1,"tuanki-tab svelte-hzfimg",null,i,e),er(n,"title",bi(t).tooltip),va(l,a)},[()=>({active:s()===bi(t).id,disabled:bi(t).disabled}),()=>bi(p)(bi(t).label)]),pa(e,n)});var S=Kt(k,2),x=e=>{var t=zse();zi(()=>ja(t,bi(v))),pa(e,t)};xa(S,e=>{h()&&"underline"===l()&&e(x)});var _=Kt(S,2),C=e=>{pa(e,Pse())};xa(_,e=>{u()||"horizontal"!==d()||e(C)}),zt(b),zi(e=>{var t,n,i;w=Fa(b,1,`tuanki-tabs tuanki-tabs-${null!=(t=l())?t:""} tuanki-tabs-${null!=(n=c())?n:""} tuanki-tabs-${null!=(i=d())?i:""}`,"svelte-hzfimg",w,e),er(b,"aria-orientation",d())},[()=>({"tuanki-tabs-full":u(),"tuanki-tabs-animated":h()})]),pa(e,b);var I=St(y);return a(),I}function Ose(e,t,n,i){bi(t).enabled=e.target.checked,n(),bi(t).enabled&&ao("ADD_NOTIFICATION",{id:`sibling-dispersion-enabled-${Date.now()}`,type:"info",message:bi(i)("settings.siblingDispersion.enabledNotice")||"兄弟卡片智能分散已启用",duration:3e3,timestamp:Date.now()})}function Lse(e,t,n){const i=parseInt(e.target.value,10);!isNaN(i)&&i>=3&&i<=10&&(bi(t).minSpacing=i,n())}function Nse(e,t,n){const i=parseFloat(e.target.value);!isNaN(i)&&i>=.03&&i<=.1&&(bi(t).spacingPercentage=i,n())}function Fse(e,t,n){bi(t).filterInQueue=e.target.checked,n()}function Bse(e,t,n){bi(t).autoAdjustAfterReview=e.target.checked,n()}function jse(e,t,n){bi(t).respectFuzzRange=e.target.checked,n()}function Use(e,t,n,i,a){$n(t,{...n},!0),i(),ao("ADD_NOTIFICATION",{id:`sibling-dispersion-reset-${Date.now()}`,type:"success",message:bi(a)("settings.siblingDispersion.resetToDefaults")||"已重置为推荐配置",duration:2e3,timestamp:Date.now()})}ia(["click","keydown"]);var Vse=la('<div class="row svelte-113fqho"><div class="setting-label-group svelte-113fqho"><label for="filter-queue" class="setting-label svelte-113fqho"> </label> <span class="setting-description svelte-113fqho"> </span></div> <label class="modern-switch"><input id="filter-queue" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row svelte-113fqho"><div class="setting-label-group svelte-113fqho"><label for="auto-adjust" class="setting-label svelte-113fqho"> </label> <span class="setting-description svelte-113fqho"> </span></div> <label class="modern-switch"><input id="auto-adjust" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row svelte-113fqho"><div class="setting-label-group svelte-113fqho"><label for="respect-fuzz" class="setting-label svelte-113fqho"> </label> <span class="setting-description svelte-113fqho"> </span></div> <label class="modern-switch"><input id="respect-fuzz" type="checkbox"/> <span class="switch-slider"></span></label></div>',1),qse=la('<div class="settings-group"><h4 class="group-title with-accent-bar accent-blue"> </h4> <div class="group-content"><div class="row svelte-113fqho"><div class="setting-label-group svelte-113fqho"><label for="min-spacing" class="setting-label svelte-113fqho"> </label> <span class="setting-description svelte-113fqho"> </span></div> <div class="setting-control-group svelte-113fqho"><input id="min-spacing" type="range" min="3" max="10" step="1" class="modern-slider svelte-113fqho"/> <span class="setting-value svelte-113fqho"> </span></div></div> <div class="row svelte-113fqho"><div class="setting-label-group svelte-113fqho"><label for="spacing-percentage" class="setting-label svelte-113fqho"> </label> <span class="setting-description svelte-113fqho"> </span></div> <div class="setting-control-group svelte-113fqho"><input id="spacing-percentage" type="range" min="0.03" max="0.10" step="0.01" class="modern-slider svelte-113fqho"/> <span class="setting-value svelte-113fqho"> </span></div></div></div></div>'),Hse=la('<div class="tuanki-settings settings-section sibling-dispersion-settings svelte-113fqho"><div class="settings-group"><h4 class="group-title with-accent-bar accent-purple"> </h4> <div class="group-content"><div class="row svelte-113fqho"><div class="setting-label-group svelte-113fqho"><label for="sibling-enabled" class="setting-label svelte-113fqho"> </label> <span class="setting-description svelte-113fqho"> </span></div> <div class="title-controls svelte-113fqho"><button class="icon-button reset-button svelte-113fqho"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-113fqho"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path></svg></button> <label class="modern-switch"><input id="sibling-enabled" type="checkbox"/> <span class="switch-slider"></span></label></div></div> <!></div></div> <!></div>');function Wse(e,t){var n,i,a,r,s,o,l,c,d,u,h,p,g,v,f,m,y,b;if(new.target)return Er({component:Wse,...e});kt(t,!0);const w=()=>Ir(Vp,"$tr",k),[k,S]=Dr();let x=Ar(t,"plugin",7),_=x().settings,C=In(w);const I={enabled:!0,minSpacing:5,spacingPercentage:.05,filterInQueue:!0,autoAdjustAfterReview:!0,respectFuzzRange:!0};let D=Pn(Ot({enabled:null!=(a=null==(i=null==(n=_.studyConfig)?void 0:n.siblingDispersion)?void 0:i.enabled)?a:I.enabled,minSpacing:null!=(o=null==(s=null==(r=_.studyConfig)?void 0:r.siblingDispersion)?void 0:s.minSpacing)?o:I.minSpacing,spacingPercentage:null!=(d=null==(c=null==(l=_.studyConfig)?void 0:l.siblingDispersion)?void 0:c.spacingPercentage)?d:I.spacingPercentage,filterInQueue:null!=(p=null==(h=null==(u=_.studyConfig)?void 0:u.siblingDispersion)?void 0:h.filterInQueue)?p:I.filterInQueue,autoAdjustAfterReview:null!=(f=null==(v=null==(g=_.studyConfig)?void 0:g.siblingDispersion)?void 0:v.autoAdjustAfterReview)?f:I.autoAdjustAfterReview,respectFuzzRange:null!=(b=null==(y=null==(m=_.studyConfig)?void 0:m.siblingDispersion)?void 0:y.respectFuzzRange)?b:I.respectFuzzRange}));async function T(){try{_.studyConfig||(_.studyConfig={}),_.studyConfig.siblingDispersion={...bi(D)},x().settings=_,await x().saveSettings(),ao("ADD_NOTIFICATION",{id:`sibling-dispersion-saved-${Date.now()}`,type:"success",message:bi(C)("settings.siblingDispersion.saved")||"兄弟卡片分散设置已保存",duration:2e3,timestamp:Date.now()}),_e.info("[兄弟分散设置] ✅ 配置已保存:",bi(D))}catch(e){_e.error("[兄弟分散设置] ❌ 保存失败:",e),ao("ADD_NOTIFICATION",{id:`sibling-dispersion-error-${Date.now()}`,type:"error",message:bi(C)("settings.siblingDispersion.saveFailed")||"保存失败，请重试",duration:5e3,timestamp:Date.now()})}}var M={get plugin(){return x()},set plugin(e){x(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},A=Hse(),E=Gt(A),z=Gt(E),P=Gt(z,!0);zt(z);var R=Kt(z,2),$=Gt(R),O=Gt($),L=Gt(O),N=Gt(L,!0);zt(L);var F=Kt(L,2),B=Gt(F,!0);zt(F),zt(O);var j=Kt(O,2),U=Gt(j);U.__click=[Use,D,I,T,C];var V=Kt(U,2),q=Gt(V);Za(q),q.__change=[Ose,D,T,C],Pt(2),zt(V),zt(j),zt($);var H=Kt($,2),W=e=>{var t=Vse(),n=Qt(t),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var s=Kt(a,2),o=Gt(s,!0);zt(s),zt(i);var l=Kt(i,2),c=Gt(l);Za(c),c.__change=[Fse,D,T],Pt(2),zt(l),zt(n);var d=Kt(n,2),u=Gt(d),h=Gt(u),p=Gt(h,!0);zt(h);var g=Kt(h,2),v=Gt(g,!0);zt(g),zt(u);var f=Kt(u,2),m=Gt(f);Za(m),m.__change=[Bse,D,T],Pt(2),zt(f),zt(d);var y=Kt(d,2),b=Gt(y),w=Gt(b),k=Gt(w,!0);zt(w);var S=Kt(w,2),x=Gt(S,!0);zt(S),zt(b);var _=Kt(b,2),I=Gt(_);Za(I),I.__change=[jse,D,T],Pt(2),zt(_),zt(y),zi((e,t,n,i,a,s)=>{va(r,e),va(o,t),Xa(c,bi(D).filterInQueue),c.disabled=!bi(D).enabled,va(p,n),va(v,i),Xa(m,bi(D).autoAdjustAfterReview),m.disabled=!bi(D).enabled,va(k,a),va(x,s),Xa(I,bi(D).respectFuzzRange),I.disabled=!bi(D).enabled},[()=>bi(C)("settings.siblingDispersion.filterInQueue.label")||"队列生成时过滤",()=>bi(C)("settings.siblingDispersion.filterInQueue.description")||"避免同一学习会话中出现兄弟卡片（立即生效）",()=>bi(C)("settings.siblingDispersion.autoAdjustAfterReview.label")||"复习后动态调整",()=>bi(C)("settings.siblingDispersion.autoAdjustAfterReview.description")||"复习后自动调整冲突的兄弟卡片due日期",()=>bi(C)("settings.siblingDispersion.respectFuzzRange.label")||"遵守FSRS的fuzz范围",()=>bi(C)("settings.siblingDispersion.respectFuzzRange.description")||"仅在FSRS的fuzz范围内调整，不破坏最优复习间隔"]),pa(e,t)};xa(H,e=>{bi(D).enabled&&e(W)}),zt(R),zt(E);var G=Kt(E,2),Q=e=>{var t=qse(),n=Gt(t),i=Gt(n,!0);zt(n);var a=Kt(n,2),r=Gt(a),s=Gt(r),o=Gt(s),l=Gt(o,!0);zt(o);var c=Kt(o,2),d=Gt(c,!0);zt(c),zt(s);var u=Kt(s,2),h=Gt(u);Za(h),h.__input=[Lse,D,T];var p=Kt(h,2),g=Gt(p);zt(p),zt(u),zt(r);var v=Kt(r,2),f=Gt(v),m=Gt(f),y=Gt(m,!0);zt(m);var b=Kt(m,2),w=Gt(b,!0);zt(b),zt(f);var k=Kt(f,2),S=Gt(k);Za(S),S.__input=[Nse,D,T];var x=Kt(S,2),_=Gt(x,!0);zt(x),zt(k),zt(v),zt(a),zt(t),zi((e,t,n,a,r,s,o)=>{var c;va(i,e),va(l,t),va(d,n),Ya(h,bi(D).minSpacing),h.disabled=!bi(D).enabled,va(g,`${null!=(c=bi(D).minSpacing)?c:""} ${null!=a?a:""}`),va(y,r),va(w,s),Ya(S,bi(D).spacingPercentage),S.disabled=!bi(D).enabled,va(_,o)},[()=>bi(C)("settings.siblingDispersion.parameters.title")||"核心参数",()=>bi(C)("settings.siblingDispersion.minSpacing.label")||"最小间隔天数",()=>bi(C)("settings.siblingDispersion.minSpacing.description")||"兄弟卡片之间的最小时间间隔（推荐：5天）",()=>bi(C)("common.timeUnits.days")||"天",()=>bi(C)("settings.siblingDispersion.spacingPercentage.label")||"动态分散比例",()=>bi(C)("settings.siblingDispersion.spacingPercentage.description")||"基于复习间隔的动态调整比例（推荐：5%）",()=>{return void 0===(e=bi(D).spacingPercentage)?"5%":`${(100*e).toFixed(0)}%`;var e}]),pa(e,t)};xa(G,e=>{bi(D).enabled&&e(Q)}),zt(A),zi((e,t,n,i)=>{va(P,e),va(N,t),va(B,n),U.disabled=!bi(D).enabled,er(U,"title",i),Xa(q,bi(D).enabled)},[()=>bi(C)("settings.siblingDispersion.title")||"兄弟卡片智能分散",()=>bi(C)("settings.siblingDispersion.enable.label")||"启用智能分散",()=>bi(C)("settings.siblingDispersion.enable.description")||"自动管理兄弟卡片的学习日期，避免在同一学习会话或相近日期出现",()=>bi(C)("settings.siblingDispersion.resetButton")||"重置为推荐配置"]),pa(e,A);var K=St(M);return S(),K}async function Gse(e,t,n){const i=e.target.value;bi(t).language=i,Up.setLanguage(i),Fp.set(i),await n()}function Qse(e,t,n){const i=e.target.value.trim();i.length>0&&(bi(t).defaultDeck=i,n())}function Kse(e,t,n){bi(t).enableNotifications=e.target.checked,n()}function Zse(e,t,n,i){const a=e.target.checked;bi(t).showFloatingCreateButton=a,n(),i().toggleFloatingButton(a)}function Yse(e,t,n){const i=e.target.value;bi(t).progressiveCloze||(bi(t).progressiveCloze={enableAutoSplit:!0}),bi(t).progressiveCloze.historyInheritance=i,n(),ao("ADD_NOTIFICATION",{id:`progressive-cloze-history-${Date.now()}`,type:"success",message:"渐进式挖空历史继承策略已更新",duration:2e3,timestamp:Date.now()})}function Xse(e,t,n){bi(t).editorModalSize||(bi(t).editorModalSize={preset:"large",customWidth:800,customHeight:600,rememberLastSize:!0,enableResize:!0}),bi(t).editorModalSize.enableResize=e.target.checked,n()}function Jse(e,t,n){bi(t).showSettingsButton=e.target.checked,n()}async function eoe(e,t,n,i){bi(t).enableDebugMode=e.target.checked;const{logger:a}=await Promise.resolve().then(()=>Ie);a.setDebugMode(bi(t).enableDebugMode),n(),bi(t).enableDebugMode?ao("ADD_NOTIFICATION",{id:`debug-mode-enabled-${Date.now()}`,type:"info",message:bi(i)("settings.basic.debugMode.enabled"),duration:3e3,timestamp:Date.now()}):ao("ADD_NOTIFICATION",{id:`debug-mode-disabled-${Date.now()}`,type:"info",message:bi(i)("settings.basic.debugMode.disabled"),duration:2e3,timestamp:Date.now()})}function toe(e,t,n,i,a){const r=e.target.checked;bi(t).showPerformanceSettings=r,n().settings.showPerformanceSettings=r,i()&&i()(r),a(),ao("ADD_NOTIFICATION",r?{id:`performance-settings-shown-${Date.now()}`,type:"info",message:"性能优化界面已显示",duration:2e3,timestamp:Date.now()}:{id:`performance-settings-hidden-${Date.now()}`,type:"info",message:"性能优化界面已隐藏",duration:2e3,timestamp:Date.now()})}function noe(e,t,n){const i=parseInt(e.target.value,10);!isNaN(i)&&i>=1&&i<=200&&(bi(t).reviewsPerDay=i,n())}function ioe(e,t,n){const i=parseInt(e.target.value,10);!isNaN(i)&&i>=0&&i<=100&&(bi(t).newCardsPerDay=i,n())}function aoe(e,t,n){const i=parseInt(e.target.value,10);!isNaN(i)&&i>=0&&i<=10&&(bi(t).autoShowAnswerSeconds=i,n())}function roe(e,t,n){const i=e.target.value.split(/\s+/).map(e=>parseInt(e,10)).filter(e=>!isNaN(e)&&e>=0);bi(t).learningSteps=i.length?i:[1,10],n()}function soe(e,t,n){const i=parseInt(e.target.value,10);!isNaN(i)&&i>=1&&i<=30&&(bi(t).graduatingInterval=i,n())}function ooe(e,t,n){const i=parseInt(e.target.value,10);!isNaN(i)&&i>=1&&i<=7&&(bi(t).maxAdvanceDays=i,n())}ia(["click","change","input"]);var loe=la('<div class="tuanki-settings settings-section basic-settings"><div class="settings-group"><h4 class="group-title with-accent-bar accent-blue"> </h4> <div class="group-content"><div class="setting-item"><div class="setting-label-group"><label for="language" class="setting-label"> </label></div> <select id="language" class="setting-control"><option> </option><option> </option></select></div> <div class="row"><label for="defaultDeck"> </label> <input id="defaultDeck" type="text" class="modern-input"/></div> <div class="row"><label for="enableNotifications"> </label> <label class="modern-switch"><input id="enableNotifications" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row"><label for="showFloatingCreateButton"> </label> <label class="modern-switch"><input id="showFloatingCreateButton" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row"><label for="enableDebugMode"> </label> <label class="modern-switch"><input id="enableDebugMode" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row"><label for="showPerformanceSettings">性能优化界面</label> <label class="modern-switch"><input id="showPerformanceSettings" type="checkbox"/> <span class="switch-slider"></span></label></div></div></div> <div class="settings-group"><h4 class="group-title with-accent-bar accent-cyan"> </h4> <div class="group-content"><div class="row"><label for="enable-resize-switch"> </label> <label class="modern-switch"><input id="enable-resize-switch" type="checkbox"/> <span class="switch-slider"></span></label></div></div></div> <div class="settings-group"><h4 class="group-title with-accent-bar accent-green">渐进式挖空</h4> <div class="group-content"><div class="row"><div class="label-with-desc"><label for="progressive-cloze-history">历史数据继承</label> <p class="desc">当卡片转换为渐进式挖空时，如何处理原有的学习历史</p></div> <select id="progressive-cloze-history"><option>第一个子挖空继承（推荐）</option><option>所有子挖空按比例继承</option><option>全部重置为新卡片</option><option>每次提示我选择</option></select></div></div></div> <div class="settings-group"><h4 class="group-title with-accent-bar accent-purple"> </h4> <div class="group-content"><div class="row"><label for="navDeckStudy"> </label> <label class="modern-switch"><input id="navDeckStudy" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row"><label for="navCardManagement"> </label> <label class="modern-switch"><input id="navCardManagement" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row"><label for="navAiAssistant"> </label> <label class="modern-switch"><input id="navAiAssistant" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row"><label for="navStatistics"> </label> <label class="modern-switch"><input id="navStatistics" type="checkbox"/> <span class="switch-slider"></span></label></div> <div class="row"><label for="showSettingsButton"> </label> <label class="modern-switch"><input id="showSettingsButton" type="checkbox"/> <span class="switch-slider"></span></label></div></div></div> <div class="settings-group"><h4 class="group-title with-accent-bar accent-orange"> </h4> <div class="group-content"><div class="row"><label for="reviewsPerDay"> </label> <div class="slider-container"><input id="reviewsPerDay" type="range" min="1" max="200" step="5" class="modern-slider"/> <span class="slider-value"> </span></div></div> <div class="row"><label for="newCardsPerDay"> </label> <div class="slider-container"><input id="newCardsPerDay" type="range" min="0" max="100" step="5" class="modern-slider"/> <span class="slider-value"> </span></div></div> <div class="row"><label for="autoShowAnswer"> </label> <div class="slider-container"><input id="autoShowAnswer" type="range" min="0" max="10" step="1" class="modern-slider"/> <span class="slider-value"> </span></div></div> <div class="row"><label for="learningSteps">学习步骤（分钟）</label> <input id="learningSteps" type="text" placeholder="1 10" class="modern-input"/> <span class="learning-help-text svelte-nqmq6n">用空格分隔多个时间间隔</span></div> <div class="row"><label for="graduatingInterval">毕业间隔（天）</label> <div class="slider-container"><input id="graduatingInterval" type="range" min="1" max="30" step="1" class="modern-slider"/> <span class="slider-value"> </span></div></div> <div class="row"><label for="maxAdvanceDays">提前学习天数限制</label> <div class="slider-container"><input id="maxAdvanceDays" type="range" min="1" max="7" step="1" class="modern-slider"/> <span class="slider-value"> </span></div></div></div></div> <!></div>');function coe(e,t){if(new.target)return Er({component:coe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"plugin",7),s=Ar(t,"onPerformanceSettingsToggle",7),o=Pn(Ot(r().settings)),l=In(n);async function c(){try{r().settings=bi(o),await r().saveSettings(),ao("ADD_NOTIFICATION",{id:`settings-saved-${Date.now()}`,type:"success",message:bi(l)("settings.actions.saved"),duration:2e3,timestamp:Date.now()})}catch(e){_e.error("保存设置失败:",e),ao("ADD_NOTIFICATION",{id:`settings-error-${Date.now()}`,type:"error",message:bi(l)("settings.actions.saveFailed"),duration:5e3,timestamp:Date.now()})}}function d(e){return t=>{bi(o).navigationVisibility||(bi(o).navigationVisibility={}),bi(o).navigationVisibility[e]=t.target.checked,r().settings.navigationVisibility={...bi(o).navigationVisibility},window.dispatchEvent(new CustomEvent("tuanki:navigation-visibility-update",{detail:r().settings.navigationVisibility})),c()}}var u={get plugin(){return r()},set plugin(e){r(e),hn()},get onPerformanceSettingsToggle(){return s()},set onPerformanceSettingsToggle(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},h=loe(),p=Gt(h),g=Gt(p),v=Gt(g,!0);zt(g);var f=Kt(g,2),m=Gt(f),y=Gt(m),b=Gt(y),w=Gt(b,!0);zt(b),zt(y);var k=Kt(y,2);k.__change=[Gse,o,c];var S=Gt(k),x=Gt(S,!0);zt(S),S.value=S.__value="zh-CN";var _,C=Kt(S),I=Gt(C,!0);zt(C),C.value=C.__value="en-US",zt(k),Va(k),zt(m);var D=Kt(m,2),T=Gt(D),M=Gt(T,!0);zt(T);var A=Kt(T,2);Za(A),A.__input=[Qse,o,c],zt(D);var E=Kt(D,2),z=Gt(E),P=Gt(z,!0);zt(z);var R=Kt(z,2),$=Gt(R);Za($),$.__change=[Kse,o,c],Pt(2),zt(R),zt(E);var O=Kt(E,2),L=Gt(O),N=Gt(L,!0);zt(L);var F=Kt(L,2),B=Gt(F);Za(B),B.__change=[Zse,o,c,r],Pt(2),zt(F),zt(O);var j=Kt(O,2),U=Gt(j),V=Gt(U,!0);zt(U);var q=Kt(U,2),H=Gt(q);Za(H),H.__change=[eoe,o,c,l],Pt(2),zt(q),zt(j);var W=Kt(j,2),G=Kt(Gt(W),2),Q=Gt(G);Za(Q),Q.__change=[toe,o,r,s,c],Pt(2),zt(G),zt(W),zt(f),zt(p);var K=Kt(p,2),Z=Gt(K),Y=Gt(Z,!0);zt(Z);var X=Kt(Z,2),J=Gt(X),ee=Gt(J),te=Gt(ee,!0);zt(ee);var ne=Kt(ee,2),ie=Gt(ne);Za(ie),ie.__change=[Xse,o,c],Pt(2),zt(ne),zt(J),zt(X),zt(K);var ae=Kt(K,2),re=Kt(Gt(ae),2),se=Gt(re),oe=Kt(Gt(se),2);oe.__change=[Yse,o,c];var le=Gt(oe);le.value=le.__value="first";var ce=Kt(le);ce.value=ce.__value="proportional";var de=Kt(ce);de.value=de.__value="reset";var ue,he=Kt(de);he.value=he.__value="prompt",zt(oe),Va(oe),zt(se),zt(re),zt(ae);var pe=Kt(ae,2),ge=Gt(pe),ve=Gt(ge,!0);zt(ge);var fe=Kt(ge,2),me=Gt(fe),ye=Gt(me),be=Gt(ye,!0);zt(ye);var we=Kt(ye,2),ke=Gt(we);Za(ke);var Se=In(()=>d("deckStudy"));ke.__change=function(...e){var t;null==(t=bi(Se))||t.apply(this,e)},Pt(2),zt(we),zt(me);var xe=Kt(me,2),Ce=Gt(xe),Ie=Gt(Ce,!0);zt(Ce);var De=Kt(Ce,2),Te=Gt(De);Za(Te);var Me=In(()=>d("cardManagement"));Te.__change=function(...e){var t;null==(t=bi(Me))||t.apply(this,e)},Pt(2),zt(De),zt(xe);var Ae=Kt(xe,2),Ee=Gt(Ae),ze=Gt(Ee,!0);zt(Ee);var Pe=Kt(Ee,2),Re=Gt(Pe);Za(Re);var $e=In(()=>d("aiAssistant"));Re.__change=function(...e){var t;null==(t=bi($e))||t.apply(this,e)},Pt(2),zt(Pe),zt(Ae);var Oe=Kt(Ae,2),Le=Gt(Oe),Ne=Gt(Le,!0);zt(Le);var Fe=Kt(Le,2),Be=Gt(Fe);Za(Be);var je=In(()=>d("statistics"));Be.__change=function(...e){var t;null==(t=bi(je))||t.apply(this,e)},Pt(2),zt(Fe),zt(Oe);var Ue=Kt(Oe,2),Ve=Gt(Ue),qe=Gt(Ve,!0);zt(Ve);var He=Kt(Ve,2),We=Gt(He);Za(We),We.__change=[Jse,o,c],Pt(2),zt(He),zt(Ue),zt(fe),zt(pe);var Ge=Kt(pe,2),Qe=Gt(Ge),Ke=Gt(Qe,!0);zt(Qe);var Ze=Kt(Qe,2),Ye=Gt(Ze),Xe=Gt(Ye),Je=Gt(Xe,!0);zt(Xe);var et=Kt(Xe,2),tt=Gt(et);Za(tt),tt.__input=[noe,o,c];var nt=Kt(tt,2),it=Gt(nt,!0);zt(nt),zt(et),zt(Ye);var at=Kt(Ye,2),rt=Gt(at),st=Gt(rt,!0);zt(rt);var ot=Kt(rt,2),lt=Gt(ot);Za(lt),lt.__input=[ioe,o,c];var ct=Kt(lt,2),dt=Gt(ct,!0);zt(ct),zt(ot),zt(at);var ut=Kt(at,2),ht=Gt(ut),pt=Gt(ht,!0);zt(ht);var gt=Kt(ht,2),vt=Gt(gt);Za(vt),vt.__input=[aoe,o,c];var ft=Kt(vt,2),mt=Gt(ft,!0);zt(ft),zt(gt),zt(ut);var yt=Kt(ut,2),bt=Kt(Gt(yt),2);Za(bt),bt.__input=[roe,o,c],Pt(2),zt(yt);var wt=Kt(yt,2),xt=Kt(Gt(wt),2),_t=Gt(xt);Za(_t),_t.__input=[soe,o,c];var Ct=Kt(_t,2),It=Gt(Ct);zt(Ct),zt(xt),zt(wt);var Dt=Kt(wt,2),Tt=Kt(Gt(Dt),2),Mt=Gt(Tt);Za(Mt),Mt.__input=[ooe,o,c];var At=Kt(Mt,2),Et=Gt(At);zt(At),zt(Tt),zt(Dt),zt(Ze),zt(Ge),Wse(Kt(Ge,2),{get plugin(){return r()}}),zt(h),zi((e,t,n,i,a,r,s,l,c,d,u,h,p,g,f,m,y,b,S,C,D,T,E)=>{var z,R,O,L,F,j,U,q,W,G,K,Z,X,J,ee,ne,ae,re;va(v,e),va(w,t),va(x,n),va(I,i),_!==(_=bi(o).language||"zh-CN")&&(k.value=null!=(z=k.__value=bi(o).language||"zh-CN")?z:"",Ua(k,bi(o).language||"zh-CN")),va(M,a),Ya(A,bi(o).defaultDeck),er(A,"placeholder",r),va(P,s),Xa($,bi(o).enableNotifications),va(N,l),Xa(B,bi(o).showFloatingCreateButton),va(V,c),Xa(H,null!=(R=bi(o).enableDebugMode)&&R),Xa(Q,null!=(O=bi(o).showPerformanceSettings)&&O),va(Y,d),va(te,u),Xa(ie,null==(F=null==(L=bi(o).editorModalSize)?void 0:L.enableResize)||F),ue!==(ue=null!=(U=null==(j=bi(o).progressiveCloze)?void 0:j.historyInheritance)?U:"first")&&(oe.value=null!=(G=oe.__value=null!=(W=null==(q=bi(o).progressiveCloze)?void 0:q.historyInheritance)?W:"first")?G:"",Ua(oe,null!=(Z=null==(K=bi(o).progressiveCloze)?void 0:K.historyInheritance)?Z:"first")),va(ve,h),va(be,p),Xa(ke,!1!==(null==(X=bi(o).navigationVisibility)?void 0:X.deckStudy)),va(Ie,g),Xa(Te,!1!==(null==(J=bi(o).navigationVisibility)?void 0:J.cardManagement)),va(ze,f),Xa(Re,!1!==(null==(ee=bi(o).navigationVisibility)?void 0:ee.aiAssistant)),va(Ne,m),Xa(Be,!1!==(null==(ne=bi(o).navigationVisibility)?void 0:ne.statistics)),va(qe,y),Xa(We,!1!==bi(o).showSettingsButton),va(Ke,b),va(Je,S),Ya(tt,bi(o).reviewsPerDay),va(it,bi(o).reviewsPerDay),va(st,C),Ya(lt,bi(o).newCardsPerDay||20),va(dt,bi(o).newCardsPerDay||20),va(pt,D),Ya(vt,bi(o).autoShowAnswerSeconds),va(mt,T),Ya(bt,E),Ya(_t,bi(o).graduatingInterval),va(It,`${null!=(ae=bi(o).graduatingInterval)?ae:""}天`),Ya(Mt,bi(o).maxAdvanceDays||7),va(Et,`${null!=(re=bi(o).maxAdvanceDays||7)?re:""}天`)},[()=>bi(l)("settings.basic.title"),()=>bi(l)("settings.basic.language.label"),()=>bi(l)("settings.basic.language.chinese"),()=>bi(l)("settings.basic.language.english"),()=>bi(l)("settings.basic.defaultDeck.label"),()=>bi(l)("settings.basic.defaultDeck.placeholder"),()=>bi(l)("settings.basic.notifications.label"),()=>bi(l)("settings.basic.floatingButton.label"),()=>bi(l)("settings.basic.debugMode.label"),()=>bi(l)("settings.editor.title"),()=>bi(l)("settings.editor.enableResize.label"),()=>bi(l)("settings.navigation.title"),()=>bi(l)("navigation.deckStudy"),()=>bi(l)("navigation.cardManagement"),()=>bi(l)("navigation.aiAssistant"),()=>bi(l)("navigation.analytics"),()=>bi(l)("common.settings"),()=>bi(l)("settings.learning.title"),()=>bi(l)("settings.learning.reviewsPerDay.label"),()=>bi(l)("settings.learning.newCardsPerDay.label"),()=>bi(l)("settings.learning.autoAdvance.label"),()=>{return 0===(e=bi(o).autoShowAnswerSeconds)?bi(l)("common.time.manual"):bi(l)("common.time.seconds",{count:e});var e},()=>bi(o).learningSteps.join(" ")]),pa(e,h);var Rt=St(u);return a(),Rt}function doe(e,t){const n=e.target;t()(parseFloat(n.value))}function uoe(e,t){const n=e.target;t()(parseInt(n.value))}ia(["change","input"]);var hoe=la("<!> ",1),poe=la('<div class="basic-parameters-panel svelte-1dqvv57"><div class="row svelte-1dqvv57"><div class="row-label-section svelte-1dqvv57"><label for="fsrs6-retention" class="svelte-1dqvv57"> </label> <span class="param-hint svelte-1dqvv57"> </span></div> <div class="slider-container svelte-1dqvv57"><input id="fsrs6-retention" type="range" min="0.5" max="0.99" step="0.01" class="modern-slider svelte-1dqvv57"/> <span class="slider-value svelte-1dqvv57"> </span></div></div> <div class="row svelte-1dqvv57"><div class="row-label-section svelte-1dqvv57"><label for="fsrs6-max-interval" class="svelte-1dqvv57"> </label> <span class="param-hint svelte-1dqvv57"> </span></div> <div class="slider-container svelte-1dqvv57"><input id="fsrs6-max-interval" type="range" min="30" max="36500" step="1" class="modern-slider svelte-1dqvv57"/> <span class="slider-value svelte-1dqvv57"> </span></div></div> <div class="row svelte-1dqvv57"><div class="row-label-section svelte-1dqvv57"><label for="fsrs6-fuzz" class="svelte-1dqvv57"> </label> <span class="param-hint svelte-1dqvv57"> </span></div> <label class="modern-switch svelte-1dqvv57"><input id="fsrs6-fuzz" type="checkbox" class="svelte-1dqvv57"/> <span class="switch-slider svelte-1dqvv57"></span></label></div> <div class="action-row svelte-1dqvv57"><!></div></div>');function goe(e,t){if(new.target)return Er({component:goe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=In(n),s=Ar(t,"parameters",7),o=Ar(t,"onRetentionChange",7),l=Ar(t,"onMaxIntervalChange",7),c=Ar(t,"onFuzzToggle",7),d=Ar(t,"onReset",7);var u={get parameters(){return s()},set parameters(e){s(e),hn()},get onRetentionChange(){return o()},set onRetentionChange(e){o(e),hn()},get onMaxIntervalChange(){return l()},set onMaxIntervalChange(e){l(e),hn()},get onFuzzToggle(){return c()},set onFuzzToggle(e){c(e),hn()},get onReset(){return d()},set onReset(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},h=poe(),p=Gt(h),g=Gt(p),v=Gt(g),f=Gt(v,!0);zt(v);var m=Kt(v,2),y=Gt(m,!0);zt(m),zt(g);var b=Kt(g,2),w=Gt(b);Za(w),w.__change=[doe,o];var k=Kt(w,2),S=Gt(k,!0);zt(k),zt(b),zt(p);var x=Kt(p,2),_=Gt(x),C=Gt(_),I=Gt(C,!0);zt(C);var D=Kt(C,2),T=Gt(D,!0);zt(D),zt(_);var M=Kt(_,2),A=Gt(M);Za(A),A.__change=[uoe,l];var E=Kt(A,2),z=Gt(E,!0);zt(E),zt(M),zt(x);var P=Kt(x,2),R=Gt(P),$=Gt(R),O=Gt($,!0);zt($);var L=Kt($,2),N=Gt(L,!0);zt(L),zt(R);var F=Kt(R,2),B=Gt(F);Za(B),B.__change=function(...e){var t;null==(t=c())||t.apply(this,e)},Pt(2),zt(F),zt(P);var j=Kt(P,2);Hg(Gt(j),{variant:"ghost",size:"sm",get onclick(){return d()},children:(e,t)=>{var n=hoe(),i=Qt(n);Ng(i,{name:"refresh-cw",size:"16"});var a=Kt(i);zi(e=>va(a,` ${null!=e?e:""}`),[()=>bi(r)("fsrs.advancedSettings.weights.reset")]),pa(e,n)},$$slots:{default:!0}}),zt(j),zt(h),zi((e,t,n,i,a,r,o,l)=>{va(f,e),va(y,t),Ya(w,s().retention),va(S,n),va(I,i),va(T,a),Ya(A,s().maxInterval),va(z,r),va(O,o),va(N,l),Xa(B,s().enableFuzz)},[()=>bi(r)("fsrs.basicParams.retention.label"),()=>bi(r)("fsrs.basicParams.retention.description"),()=>`${(100*s().retention).toFixed(0)}%`,()=>bi(r)("fsrs.basicParams.maxInterval.label"),()=>bi(r)("fsrs.basicParams.maxInterval.description"),()=>function(e){if(e>=365)return`${(e/365).toFixed(1)} ${bi(r)("common.timeUnits.years").replace("{n}","").trim()}`;return`${e} ${bi(r)("common.timeUnits.days").replace("{n}","").trim()}`}(s().maxInterval),()=>bi(r)("fsrs.basicParams.enableFuzz.label"),()=>bi(r)("fsrs.basicParams.enableFuzz.description")]),pa(e,h);var U=St(u);return a(),U}ia(["change"]);var voe=la('<div class="metrics-comparison svelte-1hbi0sg"><h3 class="section-title svelte-1hbi0sg"><!> 性能指标对比</h3> <div class="comparison-grid svelte-1hbi0sg"><div class="metric-row svelte-1hbi0sg"><span class="metric-name svelte-1hbi0sg">预测准确性</span> <div class="metric-values svelte-1hbi0sg"><span class="old-value svelte-1hbi0sg"> </span> <!> <span class="new-value svelte-1hbi0sg"> </span></div> <span class="metric-change positive svelte-1hbi0sg"> </span></div></div></div>'),foe=la('<tr class="svelte-1hbi0sg"><td class="param-name svelte-1hbi0sg"> </td><td class="old-val svelte-1hbi0sg"> </td><td class="new-val svelte-1hbi0sg"> </td><td class="change-val svelte-1hbi0sg"><span> </span></td></tr>'),moe=la('<div class="table-footer svelte-1hbi0sg"> </div>'),yoe=la('<div class="params-changes svelte-1hbi0sg"><h3 class="section-title svelte-1hbi0sg"><!> 参数变化详情 <span class="params-count svelte-1hbi0sg"> </span></h3> <div class="changes-table-container svelte-1hbi0sg"><table class="changes-table svelte-1hbi0sg"><thead class="svelte-1hbi0sg"><tr><th class="svelte-1hbi0sg">参数</th><th class="svelte-1hbi0sg">优化前</th><th class="svelte-1hbi0sg">优化后</th><th class="svelte-1hbi0sg">变化幅度</th></tr></thead><tbody class="svelte-1hbi0sg"></tbody></table> <!></div></div>'),boe=la("<!> 拒绝优化",1),woe=la("<!> 接受并应用",1),koe=la('<div class="optimization-result-modal svelte-1hbi0sg"><div class="modal-header svelte-1hbi0sg"><div class="header-icon success svelte-1hbi0sg"><!></div> <div class="header-text svelte-1hbi0sg"><h2 class="modal-title svelte-1hbi0sg"> </h2> <p class="modal-subtitle svelte-1hbi0sg"> </p></div></div> <div class="optimization-summary svelte-1hbi0sg"><div class="summary-card svelte-1hbi0sg"><div class="card-icon svelte-1hbi0sg"><!></div> <div class="card-content svelte-1hbi0sg"><span class="card-label svelte-1hbi0sg">优化阶段</span> <span class="card-value svelte-1hbi0sg"> </span></div></div> <div class="summary-card svelte-1hbi0sg"><div class="card-icon svelte-1hbi0sg"><!></div> <div class="card-content svelte-1hbi0sg"><span class="card-label svelte-1hbi0sg">参数调整</span> <span class="card-value svelte-1hbi0sg"> </span></div></div> <div class="summary-card highlight svelte-1hbi0sg"><div class="card-icon svelte-1hbi0sg"><!></div> <div class="card-content svelte-1hbi0sg"><span class="card-label svelte-1hbi0sg">预计改进</span> <span class="card-value improvement svelte-1hbi0sg"><!></span></div></div></div> <!> <!> <div class="explanation-box svelte-1hbi0sg"><!> <div class="explanation-text svelte-1hbi0sg"><p class="svelte-1hbi0sg"><strong class="svelte-1hbi0sg">优化说明：</strong></p> <ul class="svelte-1hbi0sg"><li class="svelte-1hbi0sg">优化基于您的实际复习历史，参数已针对您的记忆模式进行调整</li> <li class="svelte-1hbi0sg">接受优化后，新参数将立即生效，影响后续的复习间隔计算</li> <li class="svelte-1hbi0sg">拒绝优化将保持当前参数不变，优化结果将保存到历史记录</li></ul></div></div> <div class="modal-actions svelte-1hbi0sg"><!> <!></div></div>');function Soe(e,t){if(new.target)return Er({component:Soe,...e});kt(t,!0);let n=Ar(t,"app",7),i=Ar(t,"title",7,"参数优化结果"),a=Ar(t,"optimizationResult",7),r=Ar(t,"onAccept",7),s=Ar(t,"onReject",7);const o=In(()=>()=>{let e=[];for(let t=0;t<a().oldWeights.length;t++){const n=a().oldWeights[t],i=a().newWeights[t],r=i-n,s=0!==n?r/n*100:0;Math.abs(r)>.01&&e.push({index:t,name:`w${t}`,oldValue:n,newValue:i,difference:r,differencePercent:s})}return e});var l={get app(){return n()},set app(e){n(e),hn()},get title(){return i()},set title(e="参数优化结果"){i(e),hn()},get optimizationResult(){return a()},set optimizationResult(e){a(e),hn()},get onAccept(){return r()},set onAccept(e){r(e),hn()},get onReject(){return s()},set onReject(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=koe(),d=Gt(c),u=Gt(d);Ng(Gt(u),{name:"check-circle",size:"24"}),zt(u);var h=Kt(u,2),p=Gt(h),g=Gt(p,!0);zt(p);var v=Kt(p,2),f=Gt(v);zt(v),zt(h),zt(d);var m=Kt(d,2),y=Gt(m),b=Gt(y);Ng(Gt(b),{name:"trending-up",size:"20"}),zt(b);var w=Kt(b,2),k=Kt(Gt(w),2),S=Gt(k,!0);zt(k),zt(w),zt(y);var x=Kt(y,2),_=Gt(x);Ng(Gt(_),{name:"activity",size:"20"}),zt(_);var C=Kt(_,2),I=Kt(Gt(C),2),D=Gt(I);zt(I),zt(C),zt(x);var T=Kt(x,2),M=Gt(T);Ng(Gt(M),{name:"zap",size:"20"}),zt(M);var A=Kt(M,2),E=Kt(Gt(A),2),z=Gt(E),P=e=>{var t=ua();zi(e=>va(t,`+${null!=e?e:""}%`),[()=>a().metrics.improvement.toFixed(1)]),pa(e,t)},R=e=>{pa(e,ua("计算中"))};xa(z,e=>{void 0!==a().metrics.improvement?e(P):e(R,!1)}),zt(E),zt(A),zt(T),zt(m);var $=Kt(m,2),O=e=>{var t=voe(),n=Gt(t);Ng(Gt(n),{name:"bar-chart-2",size:"16"}),Pt(),zt(n);var i=Kt(n,2),r=Gt(i),s=Kt(Gt(r),2),o=Gt(s),l=Gt(o);zt(o);var c=Kt(o,2);Ng(c,{name:"arrow-right",size:"14"});var d=Kt(c,2),u=Gt(d);zt(d),zt(s);var h=Kt(s,2),p=Gt(h);zt(h),zt(r),zt(i),zt(t),zi((e,t,n)=>{va(l,`${null!=e?e:""}%`),va(u,`${null!=t?t:""}%`),va(p,`+${null!=n?n:""}%`)},[()=>a().metrics.oldAccuracy.toFixed(1),()=>a().metrics.newAccuracy.toFixed(1),()=>(a().metrics.newAccuracy-a().metrics.oldAccuracy).toFixed(1)]),pa(e,t)};xa($,e=>{void 0!==a().metrics.oldAccuracy&&void 0!==a().metrics.newAccuracy&&e(O)});var L=Kt($,2),N=e=>{var t=yoe(),n=Gt(t),i=Gt(n);Ng(i,{name:"sliders",size:"16"});var a=Kt(i,2),r=Gt(a);zt(a),zt(n);var s=Kt(n,2),l=Gt(s),c=Kt(Gt(l));Ca(c,21,()=>bi(o)().slice(0,10),_a,(e,t)=>{var n=foe(),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i),s=Gt(r,!0);zt(r);var o=Kt(r),l=Gt(o,!0);zt(o);var c=Kt(o),d=Gt(c);let u;var h=Gt(d);zt(d),zt(c),zt(n),zi((e,n,i,r)=>{va(a,bi(t).name),va(s,e),va(l,n),u=Fa(d,1,"svelte-1hbi0sg",null,u,i),va(h,`${bi(t).difference>0?"+":""}${null!=r?r:""}%`)},[()=>bi(t).oldValue.toFixed(4),()=>bi(t).newValue.toFixed(4),()=>({positive:bi(t).difference>0,negative:bi(t).difference<0}),()=>bi(t).differencePercent.toFixed(1)]),pa(e,n)}),zt(c),zt(l);var d=Kt(l,2),u=e=>{var t=moe(),n=Gt(t);zt(t),zi(e=>va(n,`还有 ${null!=e?e:""} 个参数发生变化...`),[()=>bi(o)().length-10]),pa(e,t)};xa(d,e=>{bi(o)().length>10&&e(u)}),zt(s),zt(t),zi(e=>va(r,`(${null!=e?e:""} 个参数已调整)`),[()=>bi(o)().length]),pa(e,t)};xa(L,e=>{bi(o)().length>0&&e(N)});var F=Kt(L,2);Ng(Gt(F),{name:"info",size:"16"}),Pt(2),zt(F);var B=Kt(F,2),j=Gt(B);return Hg(j,{variant:"ghost",onclick:function(){s()()},children:(e,t)=>{var n=boe();Ng(Qt(n),{name:"x",size:"16"}),Pt(),pa(e,n)},$$slots:{default:!0}}),Hg(Kt(j,2),{variant:"primary",onclick:function(){r()()},children:(e,t)=>{var n=woe();Ng(Qt(n),{name:"check",size:"16"}),Pt(),pa(e,n)},$$slots:{default:!0}}),zt(B),zt(c),zi((e,t)=>{var n;va(g,i()),va(f,`基于 ${null!=(n=a().reviewCount)?n:""} 次复习记录分析`),va(S,e),va(D,`${null!=t?t:""} 个参数`)},[()=>{return{baseline:"基准收集",phase1:"阶段1优化",phase2:"阶段2优化",optimized:"完全优化"}[e=a().phase]||e;var e},()=>bi(o)().length]),pa(e,c),St(l)}var xoe=(e,t)=>{const n=e.target;bi(t).enableWeightEditing=n.checked},_oe=la('<div class="weight-item svelte-14sgw6b"><label class="weight-label svelte-14sgw6b"></label> <input type="number" min="0" max="100" step="0.01"/></div>'),Coe=la('<div class="weight-edit-notice svelte-14sgw6b"><!> <span> </span></div>'),Ioe=la('<div class="weight-edit-warning svelte-14sgw6b"><!> <span> </span></div>'),Doe=la('<div class="optimization-loading svelte-14sgw6b"><!> <span>加载优化数据中...</span></div>'),Toe=la('<div class="optimization-status svelte-14sgw6b"><div class="status-item svelte-14sgw6b"><span class="status-label svelte-14sgw6b"> </span> <span class="status-value svelte-14sgw6b"> </span></div> <div class="status-item svelte-14sgw6b"><span class="status-label svelte-14sgw6b"> </span> <span class="status-value svelte-14sgw6b"> </span></div> <div class="status-item svelte-14sgw6b"><span class="status-label svelte-14sgw6b"> </span> <span> </span></div></div>'),Moe=la('<span class="accuracy-value svelte-14sgw6b"> </span>'),Aoe=la('<span class="na-text svelte-14sgw6b">—</span>'),Eoe=la('<span class="changes-count clickable svelte-14sgw6b"> </span>'),zoe=la('<span class="na-text svelte-14sgw6b">无变化</span>'),Poe=la('<span class="note-text svelte-14sgw6b"> </span>'),Roe=la('<span class="na-text svelte-14sgw6b">—</span>'),$oe=la('<tr class="svelte-14sgw6b"><td class="td-status svelte-14sgw6b"><span> </span></td><td class="td-time svelte-14sgw6b"><span class="time-text svelte-14sgw6b"> </span></td><td class="td-phase svelte-14sgw6b"><span class="phase-text svelte-14sgw6b"><!></span></td><td class="td-reviews svelte-14sgw6b"><span class="review-count svelte-14sgw6b"> </span></td><td class="td-accuracy svelte-14sgw6b"><!></td><td class="td-changes svelte-14sgw6b"></td><td class="td-note svelte-14sgw6b"><!></td></tr>'),Ooe=la('<div class="history-section svelte-14sgw6b"><h4 class="history-title with-accent-bar accent-purple svelte-14sgw6b">优化历史记录 <span class="history-count-badge svelte-14sgw6b"> </span></h4> <div class="history-table-container svelte-14sgw6b"><table class="history-table svelte-14sgw6b"><thead class="svelte-14sgw6b"><tr><th class="th-status svelte-14sgw6b">状态</th><th class="th-time svelte-14sgw6b">优化时间</th><th class="th-phase svelte-14sgw6b">阶段</th><th class="th-reviews svelte-14sgw6b">复习记录</th><th class="th-accuracy svelte-14sgw6b">准确性</th><th class="th-changes svelte-14sgw6b">参数变化</th><th class="th-note svelte-14sgw6b">备注</th></tr></thead><tbody class="svelte-14sgw6b"></tbody></table></div></div>'),Loe=la('<div class="tuanki-settings settings-section fsrs6-settings"><div class="settings-group"><div class="group-title-row svelte-14sgw6b"><h4 class="group-title with-accent-bar accent-blue svelte-14sgw6b"> </h4> <span class="version-badge svelte-14sgw6b">v6.1.1</span></div> <div class="group-content"><!></div></div> <div class="settings-group"><div class="weights-panel section-panel"><div class="panel-header svelte-14sgw6b"><div class="panel-info svelte-14sgw6b"><div class="panel-text svelte-14sgw6b"><h5 class="panel-title with-accent-bar accent-purple svelte-14sgw6b"> </h5> <p class="panel-subtitle svelte-14sgw6b"> </p></div></div> <div class="panel-controls svelte-14sgw6b"><div class="weight-edit-toggle svelte-14sgw6b"><label class="toggle-label svelte-14sgw6b" for="weight-edit-switch"><span class="toggle-text svelte-14sgw6b"> </span> <div class="modern-switch"><input id="weight-edit-switch" type="checkbox"/> <span class="switch-slider"></span></div></label></div></div></div> <div class="weights-grid svelte-14sgw6b"></div> <!></div></div> <div class="settings-group"><div class="group-title-row svelte-14sgw6b"><div><h4 class="group-title with-accent-bar accent-green svelte-14sgw6b"> </h4> <p class="group-description svelte-14sgw6b"> </p></div> <!></div> <div class="optimization-content svelte-14sgw6b"><!> <!></div></div></div>');function Noe(e,t){var n;if(new.target)return Er({component:Noe,...e});kt(t,!0);const i=()=>Ir(Vp,"$tr",a),[a,r]=Dr();let s=Ar(t,"plugin",7),o=s().settings,l=Pn(Ot(o.fsrsParams.optimizationHistory||[])),c=In(i),d=Pn(null),u=Pn(Ot({dataPoints:0,accuracy:0,state:"baseline",isLoading:!0})),h=Pn(Ot({retention:o.fsrsParams.requestRetention||xs.REQUEST_RETENTION,maxInterval:o.fsrsParams.maximumInterval||xs.MAXIMUM_INTERVAL,enableFuzz:null!=(n=o.fsrsParams.enableFuzz)?n:xs.ENABLE_FUZZ,weights:Array.from(o.fsrsParams.w||xs.DEFAULT_WEIGHTS),isOptimizing:!1,enableWeightEditing:!1})),p=Pn(!1);async function g(){try{o.fsrsParams.requestRetention=bi(h).retention,o.fsrsParams.maximumInterval=bi(h).maxInterval,o.fsrsParams.enableFuzz=bi(h).enableFuzz,o.fsrsParams.w=[...bi(h).weights],await s().saveSettings(),ao("ADD_NOTIFICATION",{id:`fsrs6-saved-${Date.now()}`,type:"success",message:bi(c)("fsrs.savedMessage"),duration:2e3,timestamp:Date.now()})}catch(e){_e.error("保存FSRS6设置失败:",e),ao("ADD_NOTIFICATION",{id:`fsrs6-error-${Date.now()}`,type:"error",message:bi(c)("fsrs.saveFailed"),duration:5e3,timestamp:Date.now()})}}Ti(()=>{if(s()&&s().dataStorage&&!bi(p)){$n(p,!0);try{$n(d,new X9(s().dataStorage),!0),setTimeout(()=>async function(){var e;if(!bi(d))return;try{bi(u).isLoading=!0;const t=await bi(d).loadPersonalizationData(),n=await s().dataStorage.getStudySessions();let i=0;for(const e of n)e.cardReviews&&(i+=e.cardReviews.length);bi(u).dataPoints=i,bi(u).accuracy=(null==(e=t.baseline)?void 0:e.accuracy)||0,bi(u).state=t.state}catch(t){_e.error("❌ 加载优化数据失败:",t)}finally{bi(u).isLoading=!1}}(),100)}catch(e){_e.error("❌ PersonalizationManager 初始化失败:",e),$n(p,!1)}}});var v={get plugin(){return s()},set plugin(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},f=Loe(),m=Gt(f),y=Gt(m),b=Gt(y),w=Gt(b,!0);zt(b),Pt(2),zt(y);var k=Kt(y,2),S=Gt(k);{let e=In(()=>({retention:bi(h).retention,maxInterval:bi(h).maxInterval,enableFuzz:bi(h).enableFuzz}));goe(S,{get parameters(){return bi(e)},onRetentionChange:function(e){!isNaN(e)&&e>=.5&&e<=.99&&(bi(h).retention=e,g())},onMaxIntervalChange:function(e){!isNaN(e)&&e>=30&&e<=36500&&(bi(h).maxInterval=e,g())},onFuzzToggle:function(){bi(h).enableFuzz=!bi(h).enableFuzz,g()},onReset:function(){bi(h).retention=xs.REQUEST_RETENTION,bi(h).maxInterval=xs.MAXIMUM_INTERVAL,bi(h).enableFuzz=xs.ENABLE_FUZZ,bi(h).weights=Array.from(xs.DEFAULT_WEIGHTS),g()}})}zt(k),zt(m);var x=Kt(m,2),_=Gt(x),C=Gt(_),I=Gt(C),D=Gt(I),T=Gt(D),M=Gt(T,!0);zt(T);var A=Kt(T,2),E=Gt(A,!0);zt(A),zt(D),zt(I);var z=Kt(I,2),P=Gt(z),R=Gt(P),$=Gt(R),O=Gt($,!0);zt($);var L=Kt($,2),N=Gt(L);Za(N),N.__change=[xoe,h],Pt(2),zt(L),zt(R),zt(P),zt(z),zt(C);var F=Kt(C,2);Ca(F,21,()=>bi(h).weights,_a,(e,t,n)=>{var i=_oe(),a=Gt(i);er(a,"for",`weight-${n}`),a.textContent=`w${n}`;var r=Kt(a,2);let s;Za(r),er(r,"id",`weight-${n}`),r.__change=e=>function(e,t){const n=t.target,i=parseFloat(n.value);!isNaN(i)&&i>=0&&i<=100&&(bi(h).weights[e]=i,g())}(n,e),zt(i),zi((e,t)=>{Ya(r,e),s=Fa(r,1,"weight-input svelte-14sgw6b",null,s,t),r.disabled=!bi(h).enableWeightEditing,r.readOnly=!bi(h).enableWeightEditing},[()=>bi(t).toFixed(4),()=>({disabled:!bi(h).enableWeightEditing})]),pa(e,i)}),zt(F);var B=Kt(F,2),j=e=>{var t=Coe(),n=Gt(t);Ng(n,{name:"info",size:"14"});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(e=>va(a,e),[()=>bi(c)("fsrs.advancedSettings.weights.locked")]),pa(e,t)},U=e=>{var t=Ioe(),n=Gt(t);Ng(n,{name:"alert-triangle",size:"14"});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(e=>va(a,e),[()=>bi(c)("fsrs.advancedSettings.weights.warning")]),pa(e,t)};xa(B,e=>{bi(h).enableWeightEditing?e(U,!1):e(j)}),zt(_),zt(x);var V=Kt(x,2),q=Gt(V),H=Gt(q),W=Gt(H),G=Gt(W,!0);zt(W);var Q=Kt(W,2),K=Gt(Q,!0);zt(Q),zt(H),Hg(Kt(H,2),{variant:"primary",onclick:async function(){if(bi(d)){bi(h).isOptimizing=!0;try{const e=await s().dataStorage.getStudySessions(),t=[];for(const r of e)r.cardReviews&&Array.isArray(r.cardReviews)&&t.push(...r.cardReviews);if(t.length<50)return new ge.Notice(`数据量不足，需要至少50次复习记录才能优化参数，当前只有 ${t.length} 次复习`,8e3),void(bi(h).isOptimizing=!1);await bi(d).updateAfterReview(t[t.length-1],t);const n=await bi(d).loadOptimizedWeights(),i=await bi(d).getOptimizationComparison(t),a={reviewCount:t.length,phase:bi(u).state,oldWeights:[...xs.DEFAULT_WEIGHTS],newWeights:n,metrics:{oldAccuracy:i.baselineAccuracy,newAccuracy:i.optimizedAccuracy,improvement:i.improvement},timestamp:Date.now()};o.fsrsParams.pendingOptimization={suggestedWeights:n,timestamp:a.timestamp,reviewCount:t.length,phase:bi(u).state,metrics:{improvement:i.improvement}},await s().saveSettings(),function(e){const t=new ge.Modal(s().app);t.titleEl.remove(),fa(Soe,{target:t.contentEl,props:{app:s().app,optimizationResult:e,onAccept:async()=>{await async function(){if(!o.fsrsParams.pendingOptimization)return;const{suggestedWeights:e,timestamp:t,reviewCount:n,phase:i,metrics:a}=o.fsrsParams.pendingOptimization;o.fsrsParams.optimizationHistory||(o.fsrsParams.optimizationHistory=[]);o.fsrsParams.optimizationHistory.push({timestamp:t,reviewCount:n,phase:i,oldWeights:[...xs.DEFAULT_WEIGHTS],newWeights:e,metrics:a,accepted:!0}),o.fsrsParams.optimizationHistory.length>50&&(o.fsrsParams.optimizationHistory=o.fsrsParams.optimizationHistory.slice(-50));bi(h).weights=e,o.fsrsParams.w=e,o.fsrsParams.pendingOptimization=void 0,await s().saveSettings(),$n(l,[...o.fsrsParams.optimizationHistory],!0),new ge.Notice("优化参数已应用",3e3)}(),t.close()},onReject:async()=>{await async function(){if(!o.fsrsParams.pendingOptimization)return;const{suggestedWeights:e,timestamp:t,reviewCount:n,phase:i,metrics:a}=o.fsrsParams.pendingOptimization;o.fsrsParams.optimizationHistory||(o.fsrsParams.optimizationHistory=[]);o.fsrsParams.optimizationHistory.push({timestamp:t,reviewCount:n,phase:i,oldWeights:[...xs.DEFAULT_WEIGHTS],newWeights:e,metrics:a,accepted:!1,note:"用户拒绝"}),o.fsrsParams.optimizationHistory.length>50&&(o.fsrsParams.optimizationHistory=o.fsrsParams.optimizationHistory.slice(-50));o.fsrsParams.pendingOptimization=void 0,await s().saveSettings(),$n(l,[...o.fsrsParams.optimizationHistory],!0),new ge.Notice("已拒绝优化建议，保持当前参数",3e3)}(),t.close()}}}),t.open()}(a)}catch(e){_e.error("参数优化失败:",e);const t=e instanceof Error?e.message:String(e);new ge.Notice(`参数优化失败: ${t}`,6e3)}finally{bi(h).isOptimizing=!1}}else new ge.Notice("优化服务未初始化，请稍后再试或重新加载插件",4e3)},get disabled(){return bi(h).isOptimizing},children:(e,t)=>{var n=ha(),i=Qt(n),a=e=>{var t=ua();zi(e=>va(t,e),[()=>bi(c)("fsrs.optimization.optimizingButton")]),pa(e,t)},r=e=>{var t=ua();zi(e=>va(t,e),[()=>bi(c)("fsrs.optimization.startButton")]),pa(e,t)};xa(i,e=>{bi(h).isOptimizing?e(a):e(r,!1)}),pa(e,n)},$$slots:{default:!0}}),zt(q);var Z=Kt(q,2),Y=Gt(Z),X=e=>{var t=Doe();Ng(Gt(t),{name:"loader",size:"20"}),Pt(2),zt(t),pa(e,t)},J=e=>{var t=Toe(),n=Gt(t),i=Gt(n),a=Gt(i);zt(i);var r=Kt(i,2),s=Gt(r,!0);zt(r),zt(n);var o=Kt(n,2),l=Gt(o),d=Gt(l);zt(l);var p=Kt(l,2),g=Gt(p,!0);zt(p),zt(o);var v=Kt(o,2),f=Gt(v),m=Gt(f);zt(f);var y=Kt(f,2);let b;var w=Gt(y,!0);zt(y),zt(v),zt(t),zi((e,t,n,i,r,o)=>{va(a,`${null!=e?e:""}:`),va(s,bi(u).dataPoints),va(d,`${null!=t?t:""}:`),va(g,n),va(m,`${null!=i?i:""}:`),b=Fa(y,1,"status-value svelte-14sgw6b",null,b,r),va(w,o)},[()=>bi(c)("fsrs.optimization.dataPoints"),()=>bi(c)("fsrs.optimization.accuracy"),()=>bi(u).accuracy>0?`${(100*bi(u).accuracy).toFixed(1)}%`:"--",()=>bi(c)("fsrs.optimization.status"),()=>({optimizing:bi(h).isOptimizing}),()=>bi(h).isOptimizing?bi(c)("fsrs.optimization.statusOptimizing"):bi(c)("fsrs.optimization.statusReady")]),pa(e,t)};xa(Y,e=>{bi(u).isLoading?e(X):e(J,!1)});var ee=Kt(Y,2),te=e=>{var t=Ooe(),n=Gt(t),i=Kt(Gt(n)),a=Gt(i);zt(i),zt(n);var r=Kt(n,2),s=Gt(r),o=Kt(Gt(s));Ca(o,21,()=>bi(l).slice().reverse(),_a,(e,t)=>{var n=$oe(),i=Gt(n),a=Gt(i);let r;var s=Gt(a,!0);zt(a),zt(i);var o=Kt(i),l=Gt(o),c=Gt(l,!0);zt(l),zt(o);var d=Kt(o),u=Gt(d),h=Gt(u),p=e=>{pa(e,ua("基准收集"))},g=e=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ua("阶段1"))},r=e=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ua("阶段2"))},r=e=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ua("已优化"))},r=e=>{var n=ua();zi(()=>va(n,bi(t).phase)),pa(e,n)};xa(i,e=>{"optimized"===bi(t).phase?e(a):e(r,!1)},!0),pa(e,n)};xa(i,e=>{"phase2"===bi(t).phase?e(a):e(r,!1)},!0),pa(e,n)};xa(i,e=>{"phase1"===bi(t).phase?e(a):e(r,!1)},!0),pa(e,n)};xa(h,e=>{"baseline"===bi(t).phase?e(p):e(g,!1)}),zt(u),zt(d);var v=Kt(d),f=Gt(v),m=Gt(f);zt(f),zt(v);var y=Kt(v),b=Gt(y),w=e=>{var n=Moe(),i=Gt(n);zt(n),zi(e=>va(i,`${null!=e?e:""}%`),[()=>bi(t).metrics.accuracy.toFixed(1)]),pa(e,n)},k=e=>{pa(e,Aoe())};xa(b,e=>{bi(t).metrics.accuracy?e(w):e(k,!1)}),zt(y);var S=Kt(y);Ca(S,21,()=>[bi(t).newWeights.map((e,n)=>({index:n,old:bi(t).oldWeights[n],new:e,diff:e-bi(t).oldWeights[n]})).filter(e=>Math.abs(e.diff)>.01)],_a,(e,t)=>{var n=ha(),i=Qt(n),a=e=>{var n=Eoe(),i=Gt(n);zt(n),zi(e=>{var a;er(n,"title",e),va(i,`${null!=(a=bi(t).length)?a:""} 个参数`)},[()=>bi(t).map(e=>`w${e.index}: ${e.old.toFixed(4)} → ${e.new.toFixed(4)} (${e.diff>0?"+":""}${e.diff.toFixed(4)})`).join("\n")]),pa(e,n)},r=e=>{pa(e,zoe())};xa(i,e=>{bi(t).length>0?e(a):e(r,!1)}),pa(e,n)}),zt(S);var x=Kt(S),_=Gt(x),C=e=>{var n=Poe(),i=Gt(n,!0);zt(n),zi(()=>{er(n,"title",bi(t).note),va(i,bi(t).note)}),pa(e,n)},I=e=>{pa(e,Roe())};xa(_,e=>{bi(t).note?e(C):e(I,!1)}),zt(x),zt(n),zi((e,n)=>{var i;r=Fa(a,1,"status-badge svelte-14sgw6b",null,r,e),va(s,bi(t).accepted?"已接受":"已拒绝"),va(c,n),va(m,`${null!=(i=bi(t).reviewCount)?i:""} 次`)},[()=>({success:bi(t).accepted,muted:!bi(t).accepted}),()=>new Date(bi(t).timestamp).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})]),pa(e,n)}),zt(o),zt(s),zt(r),zt(t),zi(()=>{var e;return va(a,`${null!=(e=bi(l).length)?e:""} 条`)}),pa(e,t)};xa(ee,e=>{bi(l)&&bi(l).length>0&&e(te)}),zt(Z),zt(V),zt(f),zi((e,t,n,i,a,r)=>{va(w,e),va(M,t),va(E,n),va(O,i),Xa(N,bi(h).enableWeightEditing),va(G,a),va(K,r)},[()=>bi(c)("fsrs.basicParams.title"),()=>bi(c)("fsrs.advancedSettings.weights.title"),()=>bi(c)("fsrs.advancedSettings.weights.description"),()=>bi(c)("fsrs.advancedSettings.weights.allowEdit"),()=>bi(c)("fsrs.optimization.title"),()=>bi(c)("fsrs.optimization.description")]),pa(e,f);var ne=St(v);return r(),ne}function Foe(e){const{message:t,type:n="info",duration:i}=e,a=window.Notice;if(!a)return void _e.warn("Notice constructor not available");new a(t,null!=i?i:"error"===n?HS:WS)}function Boe(e,t,n,i){t()||n()||!i()||i()()}ia(["change"]);var joe=la('<span class="loading-spinner svelte-8fudgo" aria-hidden="true"></span>'),Uoe=la('<button type="button"><!> <span><!></span></button>');function Voe(e,t){if(new.target)return Er({component:Voe,...e});kt(t,!0);const n=Ar(t,"variant",7,"primary"),i=Ar(t,"size",7,"md"),a=Ar(t,"disabled",7,!1),r=Ar(t,"loading",7,!1),s=Ar(t,"fullWidth",7,!1),o=Ar(t,"onclick",7);let l;const c=In(()=>function(e){switch(e){case"primary":default:return"variant-primary";case"secondary":return"variant-secondary";case"outline":return"variant-outline";case"ghost":return"variant-ghost";case"danger":return"variant-danger"}}(n())),d=In(()=>function(e){switch(e){case"sm":return"size-sm";case"md":default:return"size-md";case"lg":return"size-lg"}}(i())),u=In(()=>["cursor-button",bi(c),bi(d),s()&&"full-width",a()&&"disabled",r()&&"loading"].filter(Boolean).join(" "));var h={get variant(){return n()},set variant(e="primary"){n(e),hn()},get size(){return i()},set size(e="md"){i(e),hn()},get disabled(){return a()},set disabled(e=!1){a(e),hn()},get loading(){return r()},set loading(e=!1){r(e),hn()},get fullWidth(){return s()},set fullWidth(e=!1){s(e),hn()},get onclick(){return o()},set onclick(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=Uoe();p.__click=[Boe,a,r,o];var g=Gt(p),v=e=>{pa(e,joe())};xa(g,e=>{r()&&e(v)});var f=Kt(g,2);let m;return function(e,t,n,i){var a;Tt&&Et();var r=null==(a=t.$$slots)?void 0:a[n],s=!1;!0===r&&(r=t.children,s=!0),void 0===r||r(e,s?()=>i:i)}(Gt(f),t,"default",{}),zt(f),zt(p),kr(p,e=>l=e,()=>l),zi(e=>{Fa(p,1,$a(bi(u)),"svelte-8fudgo"),p.disabled=a(),m=Fa(f,1,"button-content svelte-8fudgo",null,m,e)},[()=>({loading:r()})]),pa(e,p),St(h)}ia(["click"]);var qoe=la('<div class="current-file svelte-kwefc7"> </div>'),Hoe=la('<div class="progress-section svelte-kwefc7"><div class="progress-bar svelte-kwefc7"><div class="progress-fill svelte-kwefc7"></div></div> <span class="progress-text svelte-kwefc7"> </span> <!></div>'),Woe=la("<!> 同步所有文件",1),Goe=la('<div class="annotation-status-panel svelte-kwefc7"><!> <div class="action-stats-section svelte-kwefc7"><!> <div class="stats-inline svelte-kwefc7"><div class="stat-item svelte-kwefc7"><!> <span class="svelte-kwefc7"> </span></div> <div class="stat-item svelte-kwefc7"><!> <span class="svelte-kwefc7"> </span></div> <div class="stat-item svelte-kwefc7"><!> <span class="svelte-kwefc7"> </span></div> <div class="stat-item svelte-kwefc7"><!> <span class="svelte-kwefc7"> </span></div></div></div></div>');function Qoe(e,t){if(new.target)return Er({component:Qoe,...e});kt(t,!0);let n=Ar(t,"plugin",7),i=Ar(t,"isVisible",7,!1);let a,r=Pn(Ot({status:Xo.IDLE,isProcessing:!1,detectedAnnotations:[],processingQueue:[],completedTasks:[],errorLog:[],stats:{totalDetected:0,totalProcessed:0,totalErrors:0,successRate:0}})),s=Pn(""),o=Pn(0),l=[];async function c(){var e,t;try{const i=n().app.vault.getMarkdownFiles().map(e=>e.path),r=await a.syncMultipleFiles(i);r.success?n().app.workspace.trigger("tuanki:show-notice",`批量同步完成: 成功 ${(null==(e=r.data)?void 0:e.successCount)||0} 个，失败 ${(null==(t=r.data)?void 0:t.failureCount)||0} 个`):n().app.workspace.trigger("tuanki:show-notice",`批量同步失败: ${r.error}`)}catch(i){const e=i instanceof Error?i.message:"未知错误";n().app.workspace.trigger("tuanki:show-notice",`批量同步错误: ${e}`)}}Pr(()=>{!async function(){try{a=zh.getInstance();const e=()=>{const e=a.getSystemState();e&&e.stats&&($n(r,e,!0),function(){if(!bi(r)||!bi(r).stats)return void $n(o,0);const e=bi(r).stats.totalDetected,t=bi(r).stats.totalProcessed;$n(o,e>0?t/e*100:0,!0)}())},t=e=>{!function(e){var t;"annotation_detected"===e.type&&(null==(t=e.data)?void 0:t.filePath)&&$n(s,e.data.filePath,!0)}(e)};a.addEventListener(t);const n=setInterval(e,2e3);l.push(()=>a.removeEventListener(t),()=>clearInterval(n)),e()}catch(e){_e.error("标注状态面板初始化失败:",e)}}()}),Rr(()=>{l.forEach(e=>e()),l=[]});var d={get plugin(){return n()},set plugin(e){n(e),hn()},get isVisible(){return i()},set isVisible(e=!1){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},u=ha(),h=Qt(u),p=e=>{var t=Goe(),n=Gt(t),i=e=>{var t=Hoe(),n=Gt(t),i=Gt(n);zt(n);var a=Kt(n,2),r=Gt(a);zt(a);var l=Kt(a,2),c=e=>{var t=qoe(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`正在处理: ${null!=(e=bi(s))?e:""}`)}),pa(e,t)};xa(l,e=>{bi(s)&&e(c)}),zt(t),zi(e=>{var t;ja(i,`width: ${null!=(t=bi(o))?t:""}%`),va(r,`${null!=e?e:""}%`)},[()=>Math.round(bi(o))]),pa(e,t)};xa(n,e=>{bi(r).isProcessing&&e(i)});var a=Kt(n,2),l=Gt(a);Voe(l,{variant:"primary",size:"sm",get disabled(){return bi(r).isProcessing},onclick:c,children:(e,t)=>{var n=Woe(),i=Qt(n),a=e=>{Ng(e,{name:"loader",size:14,animation:"spin"})},s=e=>{Ng(e,{name:"refresh-cw",size:14})};xa(i,e=>{bi(r).isProcessing?e(a):e(s,!1)}),Pt(),pa(e,n)},$$slots:{default:!0}});var d=Kt(l,2),u=Gt(d),h=Gt(u);Ng(h,{name:"eye",size:14,variant:"secondary"});var p=Kt(h,2),g=Gt(p);zt(p),zt(u);var v=Kt(u,2),f=Gt(v);Ng(f,{name:"check-circle",size:14,variant:"success"});var m=Kt(f,2),y=Gt(m);zt(m),zt(v);var b=Kt(v,2),w=Gt(b);Ng(w,{name:"x-circle",size:14,variant:"error"});var k=Kt(w,2),S=Gt(k);zt(k),zt(b);var x=Kt(b,2),_=Gt(x);Ng(_,{name:"trending-up",size:14,variant:"primary"});var C=Kt(_,2),I=Gt(C);zt(C),zt(x),zt(d),zt(a),zt(t),zi(e=>{var t,n,i;va(g,`检测到: ${null!=(t=bi(r).stats.totalDetected)?t:""}`),va(y,`已处理: ${null!=(n=bi(r).stats.totalProcessed)?n:""}`),va(S,`错误: ${null!=(i=bi(r).stats.totalErrors)?i:""}`),va(I,`成功率: ${null!=e?e:""}%`)},[()=>Math.round(bi(r).stats.successRate)]),pa(e,t)};return xa(h,e=>{i()&&bi(r)&&bi(r).stats&&e(p)}),pa(e,u),St(d)}function Koe(e,t,n){const i=e.target;t().settings.annotation||(t().settings.annotation={autoDetectionEnabled:!0,detectionInterval:1e3,autoCreateDecks:!0,defaultDeckId:"",defaultTemplateId:"",showNotifications:!0,maxConcurrentTasks:3,debounceDelay:1e3,debugMode:!1}),t().settings.annotation.autoDetectionEnabled=i.checked,n()}function Zoe(e,t,n){const i=e.target;t().settings.annotation&&(t().settings.annotation.autoCreateDecks=i.checked,n())}function Yoe(e,t,n){const i=e.target,a=parseInt(i.value);!isNaN(a)&&a>=100&&t().settings.annotation&&(t().settings.annotation.debounceDelay=a,n())}function Xoe(e,t,n){const i=e.target,a=parseInt(i.value);!isNaN(a)&&a>0&&a<=10&&t().settings.annotation&&(t().settings.annotation.maxConcurrentTasks=a,n())}function Joe(e,t,n,i){const a=e.target.checked;t().settings.annotation&&(t().settings.annotation.bidirectionalSyncEnabled=a,n(),Foe({message:a?bi(i)("annotation.bidirectionalSync.enabled"):bi(i)("annotation.bidirectionalSync.disabled")}))}function ele(e,t,n,i){const a=e.target.checked;t().settings.annotation&&(t().settings.annotation.onlyActiveFileAutoSync=a,n(),Foe({message:a?bi(i)("annotation.onlyActiveFile.enabled"):bi(i)("annotation.onlyActiveFile.disabled")}))}var tle=e=>{e.stopPropagation(),e.preventDefault(),new ge.Notice('请在Obsidian设置中找到"Tuanki插件设置"，然后点击"许可证"标签页进行激活。',5e3)},nle=la('<section class="settings-group"><div class="premium-locked-section svelte-ha6dg4"><div class="premium-locked-header svelte-ha6dg4"><span class="feature-icon svelte-ha6dg4">✍️</span> <h2 class="svelte-ha6dg4"> </h2> <!></div> <p class="premium-desc svelte-ha6dg4"> </p> <p class="premium-hint svelte-ha6dg4"> </p> <div class="premium-features-list svelte-ha6dg4"><h3 class="svelte-ha6dg4"> </h3> <ul class="svelte-ha6dg4"><li class="svelte-ha6dg4"> </li> <li class="svelte-ha6dg4"> </li> <li class="svelte-ha6dg4"> </li> <li class="svelte-ha6dg4"> </li> <li class="svelte-ha6dg4"> </li> <li class="svelte-ha6dg4"> </li> <li class="svelte-ha6dg4"> </li> <li class="svelte-ha6dg4"> </li></ul></div> <button class="activate-button-large svelte-ha6dg4"> </button></div></section>'),ile=la('<div class="tuanki-settings settings-section annotation-settings"><div class="settings-group"><h4 class="group-title with-accent-bar accent-purple"> </h4> <!> <div class="setting-item svelte-ha6dg4"><div class="setting-info svelte-ha6dg4"><label class="setting-label svelte-ha6dg4" for="annotationAutoDetection"> </label> <div class="setting-description svelte-ha6dg4"> </div></div> <div class="setting-control svelte-ha6dg4"><label class="toggle-switch svelte-ha6dg4"><input id="annotationAutoDetection" type="checkbox" class="svelte-ha6dg4"/> <span class="toggle-slider svelte-ha6dg4"></span></label></div></div> <div class="setting-item svelte-ha6dg4"><div class="setting-info svelte-ha6dg4"><label class="setting-label svelte-ha6dg4" for="annotationAutoCreateDecks">自动创建牌组</label> <div class="setting-description svelte-ha6dg4">当指定的牌组不存在时，自动创建新牌组</div></div> <div class="setting-control svelte-ha6dg4"><label class="toggle-switch svelte-ha6dg4"><input id="annotationAutoCreateDecks" type="checkbox" class="svelte-ha6dg4"/> <span class="toggle-slider svelte-ha6dg4"></span></label></div></div> <div class="setting-item svelte-ha6dg4"><div class="setting-info svelte-ha6dg4"><label class="setting-label svelte-ha6dg4" for="annotationDebounceDelay"> </label> <div class="setting-description svelte-ha6dg4"> </div></div> <div class="setting-control svelte-ha6dg4"><input id="annotationDebounceDelay" type="number" class="number-input svelte-ha6dg4" min="100" max="5000" step="100"/></div></div> <div class="setting-item svelte-ha6dg4"><div class="setting-info svelte-ha6dg4"><label class="setting-label svelte-ha6dg4" for="annotationMaxConcurrentTasks"> </label> <div class="setting-description svelte-ha6dg4"> </div></div> <div class="setting-control svelte-ha6dg4"><input id="annotationMaxConcurrentTasks" type="number" class="number-input svelte-ha6dg4" min="1" max="10"/></div></div> <div class="setting-item svelte-ha6dg4"><div class="setting-info svelte-ha6dg4"><label class="setting-label svelte-ha6dg4" for="annotationBidirectionalSync"> </label> <div class="setting-description svelte-ha6dg4"> </div></div> <div class="setting-control svelte-ha6dg4"><label class="toggle-switch svelte-ha6dg4"><input id="annotationBidirectionalSync" type="checkbox" class="svelte-ha6dg4"/> <span class="toggle-slider svelte-ha6dg4"></span></label></div></div> <div class="setting-item svelte-ha6dg4"><div class="setting-info svelte-ha6dg4"><label class="setting-label svelte-ha6dg4" for="annotationOnlyActiveFile"> </label> <div class="setting-description svelte-ha6dg4"> </div></div> <div class="setting-control svelte-ha6dg4"><label class="toggle-switch svelte-ha6dg4"><input id="annotationOnlyActiveFile" type="checkbox" class="svelte-ha6dg4"/> <span class="toggle-slider svelte-ha6dg4"></span></label></div></div></div></div>');function ale(e,t){if(new.target)return Er({component:ale,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"plugin",7),s=In(n);const o=Qh.getInstance();let l=Pn(!1);Ti(()=>o.isPremiumActive.subscribe(e=>{$n(l,e,!0)}));let c=null;async function d(){c&&clearTimeout(c),c=setTimeout(async()=>{try{await r().saveSettings(),Foe({message:bi(s)("annotation.settings.saved"),type:"success"})}catch(e){_e.error("保存设置失败:",e),Foe({message:bi(s)("annotation.settings.failed"),type:"error"})}},300)}function u(){var e,t;return null==(t=null==(e=r().settings.annotation)?void 0:e.onlyActiveFileAutoSync)||t}var h={get plugin(){return r()},set plugin(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=ha(),g=Qt(p),v=e=>{var t=nle(),n=Gt(t),i=Gt(n),a=Kt(Gt(i),2),r=Gt(a,!0);zt(a),d3(Kt(a,2),{variant:"lock",size:"medium"}),zt(i);var o=Kt(i,2),l=Gt(o,!0);zt(o);var c=Kt(o,2),d=Gt(c,!0);zt(c);var u=Kt(c,2),h=Gt(u),p=Gt(h,!0);zt(h);var g=Kt(h,2),v=Gt(g),f=Gt(v,!0);zt(v);var m=Kt(v,2),y=Gt(m,!0);zt(m);var b=Kt(m,2),w=Gt(b,!0);zt(b);var k=Kt(b,2),S=Gt(k,!0);zt(k);var x=Kt(k,2),_=Gt(x,!0);zt(x);var C=Kt(x,2),I=Gt(C,!0);zt(C);var D=Kt(C,2),T=Gt(D,!0);zt(D);var M=Kt(D,2),A=Gt(M,!0);zt(M),zt(g),zt(u);var E=Kt(u,2);E.__click=[tle];var z=Gt(E,!0);zt(E),zt(n),zt(t),zi((e,t,n,i,a,s,o,c,u,h,g,v,m)=>{va(r,e),va(l,t),va(d,n),va(p,i),va(f,a),va(y,s),va(w,o),va(S,c),va(_,u),va(I,h),va(T,g),va(A,v),va(z,m)},[()=>bi(s)("annotation.title"),()=>bi(s)("annotation.description"),()=>bi(s)("annotation.requireLicense"),()=>bi(s)("annotation.features.title"),()=>bi(s)("annotation.features.feature1"),()=>bi(s)("annotation.features.feature2"),()=>bi(s)("annotation.features.feature3"),()=>bi(s)("annotation.features.feature4"),()=>bi(s)("annotation.features.feature5"),()=>bi(s)("annotation.features.feature6"),()=>bi(s)("annotation.features.feature7"),()=>bi(s)("annotation.features.feature8"),()=>bi(s)("annotation.activateButton")]),pa(e,t)},f=e=>{var t=ile(),n=Gt(t),i=Gt(n),a=Gt(i,!0);zt(i);var o=Kt(i,2);Qoe(o,{get plugin(){return r()},isVisible:!0});var l=Kt(o,2),c=Gt(l),h=Gt(c),p=Gt(h,!0);zt(h);var g=Kt(h,2),v=Gt(g,!0);zt(g),zt(c);var f=Kt(c,2),m=Gt(f),y=Gt(m);Za(y),y.__change=[Koe,r,d],Pt(2),zt(m),zt(f),zt(l);var b=Kt(l,2),w=Kt(Gt(b),2),k=Gt(w),S=Gt(k);Za(S),S.__change=[Zoe,r,d],Pt(2),zt(k),zt(w),zt(b);var x=Kt(b,2),_=Gt(x),C=Gt(_),I=Gt(C);zt(C);var D=Kt(C,2),T=Gt(D,!0);zt(D),zt(_);var M=Kt(_,2),A=Gt(M);Za(A),A.__input=[Yoe,r,d],zt(M),zt(x);var E=Kt(x,2),z=Gt(E),P=Gt(z),R=Gt(P,!0);zt(P);var $=Kt(P,2),O=Gt($,!0);zt($),zt(z);var L=Kt(z,2),N=Gt(L);Za(N),N.__input=[Xoe,r,d],zt(L),zt(E);var F=Kt(E,2),B=Gt(F),j=Gt(B),U=Gt(j,!0);zt(j);var V=Kt(j,2),q=Gt(V,!0);zt(V),zt(B);var H=Kt(B,2),W=Gt(H),G=Gt(W);Za(G),G.__change=[Joe,r,d,s],Pt(2),zt(W),zt(H),zt(F);var Q=Kt(F,2),K=Gt(Q),Z=Gt(K),Y=Gt(Z,!0);zt(Z);var X=Kt(Z,2),J=Gt(X,!0);zt(X),zt(K);var ee=Kt(K,2),te=Gt(ee),ne=Gt(te);Za(ne),ne.__change=[ele,r,d,s],Pt(2),zt(te),zt(ee),zt(Q),zt(n),zt(t),zi((e,t,n,i,s,o,l,c,d,u,h,g,f)=>{var m,b,w,k,x,_,C,D,M,E;va(a,e),va(p,t),va(v,n),Xa(y,null==(b=null==(m=r().settings.annotation)?void 0:m.autoDetectionEnabled)||b),Xa(S,null==(k=null==(w=r().settings.annotation)?void 0:w.autoCreateDecks)||k),va(I,`${null!=i?i:""} (${null!=s?s:""})`),va(T,o),Ya(A,null!=(_=null==(x=r().settings.annotation)?void 0:x.debounceDelay)?_:1e3),va(R,l),va(O,c),Ya(N,null!=(D=null==(C=r().settings.annotation)?void 0:C.maxConcurrentTasks)?D:3),va(U,d),va(q,u),Xa(G,null==(E=null==(M=r().settings.annotation)?void 0:M.bidirectionalSyncEnabled)||E),va(Y,h),va(J,g),Xa(ne,f)},[()=>bi(s)("annotation.sectionTitle"),()=>bi(s)("annotation.autoDetection.label"),()=>bi(s)("annotation.autoDetection.description"),()=>bi(s)("annotation.debounceDelay.label"),()=>bi(s)("annotation.debounceDelay.unit"),()=>bi(s)("annotation.debounceDelay.description"),()=>bi(s)("annotation.maxConcurrent.label"),()=>bi(s)("annotation.maxConcurrent.description"),()=>bi(s)("annotation.bidirectionalSync.label"),()=>bi(s)("annotation.bidirectionalSync.description"),()=>bi(s)("annotation.onlyActiveFile.label"),()=>bi(s)("annotation.onlyActiveFile.description"),u]),pa(e,t)};xa(g,e=>{bi(l)?e(f,!1):e(v)}),pa(e,p);var m=St(h);return a(),m}ia(["click","change","input"]);var rle=(e=>(e.CARD="card",e.DECK="deck",e.GLOBAL="global",e))(rle||{});class sle{constructor(e){oe(this,"progressCallbacks",[]),this.plugin=e}onProgress(e){this.progressCallbacks.push(e)}emitProgress(e,t){this.progressCallbacks.forEach(n=>n({percentage:e,message:t}))}getBackupsPath(){return gs()}async createBackup(e={}){var t;const n={...{level:rle.GLOBAL,trigger:"manual",data:null},...e};this.emitProgress(0,"准备创建备份...");try{const i=this.plugin.dataStorage;if(!i)throw new Error("DataStorage not available");const a=(new Date).toISOString().replace(/[:.]/g,"-"),r=this.getBackupsPath(),s=`${r}/${a}`;this.emitProgress(10,"创建备份文件夹...");const o=this.plugin.app.vault.adapter;await o.exists(r)||await o.mkdir(r),await o.mkdir(s),this.emitProgress(30,"备份牌组数据...");const l=await i.getDecks();await o.write(`${s}/decks.json`,JSON.stringify(l,null,2)),this.emitProgress(50,"备份卡片数据...");const c=await i.getCards();await o.write(`${s}/cards.json`,JSON.stringify(c,null,2)),this.emitProgress(60,"创建备份元数据...");const d=await this.createBackupMetadata(s,n);this.emitProgress(80,"验证备份完整性...");const u=await this.validateBackup(d.id);if(!u.passed)throw new Error(`备份验证失败: ${(null==(t=u.issues)?void 0:t[0])||"未知错误"}`);return this.emitProgress(90,"保存元数据..."),await this.saveMetadata(d),e.autoCleanup&&(this.emitProgress(95,"清理旧备份..."),await this.cleanupOldBackups()),this.emitProgress(100,"备份完成"),d}catch(i){throw _e.error("创建备份失败:",i),i}}async listBackups(){const e=this.getBackupsPath(),t=this.plugin.app.vault.adapter;if(!(await t.exists(e)))return await t.mkdir(e),[];const n=await t.list(e),i=[];for(const r of n.folders||[])try{const e=await this.loadMetadata(r);if(e)i.push(e);else{const e=this.inferBackupMetadata(r);(await this.validateBackup(e.id)).passed?(await this.saveMetadata(e),i.push(e)):(e.isValid=!1,i.push(e))}}catch(a){_e.warn(`加载备份失败: ${r}`,a)}return i.sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())}async validateBackup(e){try{const n=`${this.getBackupsPath()}/${e}`,i=this.plugin.app.vault.adapter;if(!(await i.exists(n)))return{success:!1,timestamp:(new Date).toISOString(),passed:!1,issues:["备份文件夹不存在"]};const a=["decks.json","cards.json"],r=[];for(const e of a){const a=`${n}/${e}`;if(await i.exists(a))try{const e=await i.read(a);JSON.parse(e)}catch(t){r.push(`文件损坏: ${e}`)}else r.push(`缺少文件: ${e}`)}return{success:0===r.length,timestamp:(new Date).toISOString(),passed:0===r.length,issues:r.length>0?r:void 0}}catch(n){return _e.error("验证备份失败:",n),{success:!1,timestamp:(new Date).toISOString(),passed:!1,issues:[n instanceof Error?n.message:"验证失败"]}}}async autoRepair(e){try{const t=await this.validateBackup(e);if(t.passed)return{success:!0,timestamp:(new Date).toISOString(),repairedCount:0};const n=[],i=`${this.getBackupsPath()}/${e}`,a=this.plugin.app.vault.adapter;for(const e of t.issues||[]){const t="string"==typeof e?e:e.description;if(t.includes("缺少文件")){const e=t.split(": ")[1],r=`${i}/${e}`,s=(e.includes("deck"),"[]");await a.write(r,s),n.push(`已修复: ${e}`)}}if(n.length>0){const e=await this.loadMetadata(i);return e&&(e.isValid=!0,e.description=`${e.description||""} (已修复)`,await this.saveMetadata(e)),{success:!0,timestamp:(new Date).toISOString(),repairedCount:n.length,repairs:n}}return{success:!1,timestamp:(new Date).toISOString(),error:"无法自动修复此备份",repairedCount:0}}catch(t){return _e.error("自动修复失败:",t),{success:!1,timestamp:(new Date).toISOString(),error:t instanceof Error?t.message:"修复失败",repairedCount:0}}}async deleteBackup(e){const t=`${this.getBackupsPath()}/${e}`,n=this.plugin.app.vault.adapter;await n.exists(t)&&await this.deleteRecursively(t)}async deleteRecursively(e){const t=this.plugin.app.vault.adapter,n=await t.list(e);for(const i of n.files||[])await t.remove(i);for(const i of n.folders||[])await this.deleteRecursively(i);await t.rmdir(e,!1)}async cleanupOldBackups(){const e=await this.listBackups(),t=e.filter(e=>"auto"===e.type),n=e.filter(e=>"manual"===e.type);if(t.length>3){const e=t.slice(3);for(const t of e)try{await this.deleteBackup(t.id),_e.debug(`已清理旧自动备份: ${t.id}`)}catch(i){_e.warn(`清理自动备份失败: ${t.id}`,i)}}if(n.length>3){const e=n.slice(3);for(const t of e)try{await this.deleteBackup(t.id),_e.debug(`已清理旧手动备份: ${t.id}`)}catch(i){_e.warn(`清理手动备份失败: ${t.id}`,i)}}}async createBackupMetadata(e,t){const n=this.plugin.app.vault.adapter,i=(new Date).toISOString(),a=e.split("/").pop()||i;let r=0;try{const t=await n.list(e);for(const e of t.files||[]){const t=await n.stat(e);r+=(null==t?void 0:t.size)||0}}catch(s){_e.warn("计算备份大小失败:",s)}return{id:a,timestamp:i,type:"auto"===t.type?Bo.AUTO:Bo.MANUAL,size:r,description:t.reason||"智能备份",trigger:t.trigger,path:e,isValid:!0,dataTypes:["decks","cards","sessions","profile"]}}async saveMetadata(e){const t=this.plugin.app.vault.adapter,n=`${e.path}/.backup-info.json`;try{await t.write(n,JSON.stringify(e,null,2))}catch(i){_e.warn("保存备份元数据失败:",i)}}async loadMetadata(e){const t=this.plugin.app.vault.adapter,n=`${e}/.backup-info.json`;try{if(await t.exists(n)){const e=await t.read(n);return JSON.parse(e)}}catch(i){_e.warn(`加载元数据失败: ${e}`,i)}return null}inferBackupMetadata(e){var t;const n=e.split("/").pop()||"";let i;try{if(n.includes("T"))i=n.replace(/T(\d{2})-(\d{2})-(\d{2})/,"T$1:$2:$3").replace(/-(\d{3})Z$/,".$1Z");else if(n.includes("_")){const e=n.split("_"),a=e[0];i=`${a}T${(null==(t=e[1])?void 0:t.replace(/-/g,":"))||"00:00:00"}Z`}else i=/^\d{14}$/.test(n)?`${n.slice(0,4)}-${n.slice(4,6)}-${n.slice(6,8)}T${n.slice(8,10)}:${n.slice(10,12)}:${n.slice(12,14)}Z`:(new Date).toISOString();const e=new Date(i);Number.isNaN(e.getTime())&&(i=(new Date).toISOString())}catch(a){i=(new Date).toISOString()}return{id:n,timestamp:i,type:Bo.AUTO,size:0,path:e,isValid:!1,dataTypes:["decks","cards"],description:"(推断的备份信息)"}}async cleanupInvalidBackups(){const e=await this.listBackups();let t=0,n=0;for(const a of e)if(!a.isValid)try{await this.deleteBackup(a.id),t++,_e.debug(`✅ 已删除无效备份: ${a.id}`)}catch(i){_e.error(`❌ 删除无效备份失败: ${a.id}`,i),n++}return{deleted:t,failed:n}}async previewBackup(e){var t;const n=`${this.getBackupsPath()}/${e}`,i=this.plugin.app.vault.adapter;try{const a=await this.validateBackup(e);if(!a.passed){const e=(null==(t=a.issues)?void 0:t.join(", "))||"未知错误";throw new Error(`备份无效或已损坏: ${e}`)}const r=`${n}/decks.json`,s=await i.read(r),o=JSON.parse(s),l=`${n}/cards.json`,c=await i.read(l),d=JSON.parse(c);return{decks:Array.isArray(o)?o:[],cards:Array.isArray(d)?d:[],deckCount:Array.isArray(o)?o.length:0,cardCount:Array.isArray(d)?d.length:0}}catch(a){if(_e.error("预览备份失败:",a),a instanceof Error&&a.message.includes("备份无效"))throw a;throw new Error("无法读取备份内容")}}}class ole{constructor(e){oe(this,"backups",[]),oe(this,"isLoading",!1),oe(this,"error",null),oe(this,"currentOperation",null),oe(this,"engine"),oe(this,"onStateChange",null),this.plugin=e,this.engine=new sle(e)}subscribe(e){this.onStateChange=e}notifyStateChange(){this.onStateChange&&this.onStateChange()}get stats(){const e=this.backups.length,t=this.backups.reduce((e,t)=>e+t.size,0),n=this.backups.filter(e=>e.isValid).length;return{total:e,totalSize:t,validCount:n,invalidCount:e-n,invalidBackups:this.backups.filter(e=>!e.isValid),needsCleanup:e>3,oldestBackup:this.backups[this.backups.length-1],newestBackup:this.backups[0]}}async loadBackups(){this.isLoading=!0,this.error=null,this.notifyStateChange();try{const e=await this.engine.listBackups();this.backups=e.filter(e=>!1!==e.isValid)}catch(e){_e.error("加载备份列表失败:",e),this.error=e instanceof Error?e.message:"加载失败",this.backups=[]}finally{this.isLoading=!1,this.notifyStateChange()}}async createBackup(e){this.currentOperation={type:"backup",progress:0,status:"准备创建备份..."},this.error=null,this.notifyStateChange();try{this.engine.onProgress(e=>{this.currentOperation&&(this.currentOperation={...this.currentOperation,progress:e.percentage,status:e.message},this.notifyStateChange())});const t=await this.engine.createBackup({reason:e,autoCleanup:!0,type:"manual"});return this.backups=[t,...this.backups],this.currentOperation=null,this.notifyStateChange(),t}catch(t){return _e.error("创建备份失败:",t),this.error=t instanceof Error?t.message:"创建备份失败",this.currentOperation=null,this.notifyStateChange(),null}}async deleteBackup(e){this.error=null;try{return await this.engine.deleteBackup(e),this.backups=this.backups.filter(t=>t.id!==e),this.notifyStateChange(),!0}catch(t){return _e.error("删除备份失败:",t),this.error=t instanceof Error?t.message:"删除备份失败",this.notifyStateChange(),!1}}async autoRepairBackup(e){this.error=null;try{const t=await this.engine.autoRepair(e);if(t.success){const t=this.backups.findIndex(t=>t.id===e);return-1!==t&&(this.backups[t]={...this.backups[t],isValid:!0},this.backups=[...this.backups],this.notifyStateChange()),!0}return this.error=t.error||"修复失败",this.notifyStateChange(),!1}catch(t){return _e.error("自动修复失败:",t),this.error=t instanceof Error?t.message:"修复失败",this.notifyStateChange(),!1}}async autoRepairAll(){const e=this.backups.filter(e=>!e.isValid);let t=0,n=0;for(const i of e){await this.autoRepairBackup(i.id)?t++:n++}return{success:t,failed:n}}async refreshBackupValidation(e){try{const t=await this.engine.validateBackup(e),n=this.backups.findIndex(t=>t.id===e);-1!==n&&(this.backups[n]={...this.backups[n],isValid:t.passed},this.backups=[...this.backups],this.notifyStateChange())}catch(t){_e.error("刷新验证状态失败:",t)}}async cleanupInvalidBackups(){this.currentOperation={type:"cleanup",progress:0,status:"正在清理无效备份..."},this.error=null,this.notifyStateChange();try{const e=await this.engine.cleanupInvalidBackups();return await this.loadBackups(),this.currentOperation=null,this.notifyStateChange(),e}catch(e){return _e.error("清理无效备份失败:",e),this.error=e instanceof Error?e.message:"清理无效备份失败",this.currentOperation=null,this.notifyStateChange(),null}}async previewBackup(e){try{return await this.engine.previewBackup(e)}catch(t){return _e.error("预览备份失败:",t),this.error=t instanceof Error?t.message:"预览备份失败",this.notifyStateChange(),null}}clearError(){this.error=null,this.notifyStateChange()}reset(){this.backups=[],this.isLoading=!1,this.error=null,this.currentOperation=null,this.notifyStateChange()}}function lle(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/1024**t).toFixed(2))} ${["B","KB","MB","GB","TB"][t]}`}function cle(e){return e.toLocaleString()}async function dle(e,t,n,i){if(!t())try{n()&&await n()(),i("refresh")}catch(a){_e.error("刷新数据概览失败:",a)}}async function ule(e,t,n){try{t()&&await t()(),n("openFolder")}catch(i){_e.error("打开文件夹失败:",i)}}async function hle(e,t,n){try{t()&&await t()(),n("createBackup")}catch(i){_e.error("创建备份失败:",i)}}var ple=la('<div class="loading-overlay svelte-1sx3ccu"><div class="loading-spinner svelte-1sx3ccu"></div> <div class="loading-text svelte-1sx3ccu"> </div></div>'),gle=la('<div><div class="group-title-row svelte-1sx3ccu"><div class="title-container svelte-1sx3ccu"><h4 class="group-title with-accent-bar accent-blue"> </h4> <p class="last-updated svelte-1sx3ccu"> </p></div> <div class="header-actions svelte-1sx3ccu"><button class="icon-button svelte-1sx3ccu"><!></button> <button class="icon-button refresh-button svelte-1sx3ccu"><!></button> <button class="backup-button svelte-1sx3ccu"><!> <span> </span></button></div></div> <div class="stats-grid svelte-1sx3ccu"><div class="stat-item folder-info svelte-1sx3ccu"><div class="stat-content svelte-1sx3ccu"><div class="stat-label svelte-1sx3ccu"> </div> <div class="stat-value folder-path svelte-1sx3ccu"> </div></div></div> <div class="stat-item svelte-1sx3ccu"><div class="stat-content svelte-1sx3ccu"><div class="stat-label svelte-1sx3ccu"> </div> <div class="stat-value svelte-1sx3ccu"> </div></div></div> <div class="stat-item svelte-1sx3ccu"><div class="stat-content svelte-1sx3ccu"><div class="stat-label svelte-1sx3ccu"> </div> <div class="stat-value svelte-1sx3ccu"> </div></div></div> <div class="stat-item svelte-1sx3ccu"><div class="stat-content svelte-1sx3ccu"><div class="stat-label svelte-1sx3ccu"> </div> <div class="stat-value svelte-1sx3ccu"> </div></div></div> <div class="stat-item svelte-1sx3ccu"><div class="stat-content svelte-1sx3ccu"><div class="stat-label svelte-1sx3ccu"> </div> <div class="stat-value svelte-1sx3ccu"> </div></div></div></div> <!></div>');function vle(e,t){if(new.target)return Er({component:vle,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=In(n),s=Ar(t,"overview",7),o=Ar(t,"isLoading",7,!1),l=Ar(t,"onRefresh",7),c=Ar(t,"onOpenFolder",7),d=Ar(t,"onCreateBackup",7);const u=$r();let h=In(()=>s()?lle(s().totalSize):bi(r)("common.loading")),p=In(()=>s()?cle(s().totalCards):"0"),g=In(()=>s()?cle(s().totalDecks):"0"),v=In(()=>s()?cle(s().totalSessions):"0"),f=In(()=>{var e;if(!(null==(e=s())?void 0:e.lastUpdated))return bi(r)("common.unknown");const t=new Date(s().lastUpdated),n=(new Date).getTime()-t.getTime(),i=Math.floor(n/6e4);if(i<1)return bi(r)("dataManagement.backup.latest.justNow");if(i<60)return`${i} ${bi(r)("common.timeUnits.minutes").replace("{n}","").trim()}`;const a=Math.floor(i/60);if(a<24)return`${a} ${bi(r)("common.timeUnits.hours").replace("{n}","").trim()}`;return`${Math.floor(a/24)} ${bi(r)("common.timeUnits.days").replace("{n}","").trim()}`});var m={get overview(){return s()},set overview(e){s(e),hn()},get isLoading(){return o()},set isLoading(e=!1){o(e),hn()},get onRefresh(){return l()},set onRefresh(e){l(e),hn()},get onOpenFolder(){return c()},set onOpenFolder(e){c(e),hn()},get onCreateBackup(){return d()},set onCreateBackup(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=gle();let b;var w=Gt(y),k=Gt(w),S=Gt(k),x=Gt(S,!0);zt(S);var _=Kt(S,2),C=Gt(_);zt(_),zt(k);var I=Kt(k,2),D=Gt(I);D.__click=[ule,c,u],m5(Gt(D),{name:"folder-open",size:16}),zt(D);var T=Kt(D,2);T.__click=[dle,o,l,u];var M=Gt(T);{let e=In(()=>o()?"spinning":"");m5(M,{name:"refresh-cw",size:16,get class(){return bi(e)}})}zt(T);var A=Kt(T,2);A.__click=[hle,d,u];var E=Gt(A);m5(E,{name:"archive",size:16});var z=Kt(E,2),P=Gt(z,!0);zt(z),zt(A),zt(I),zt(w);var R=Kt(w,2),$=Gt(R),O=Gt($),L=Gt(O),N=Gt(L,!0);zt(L);var F=Kt(L,2),B=Gt(F,!0);zt(F),zt(O),zt($);var j=Kt($,2),U=Gt(j),V=Gt(U),q=Gt(V,!0);zt(V);var H=Kt(V,2),W=Gt(H,!0);zt(H),zt(U),zt(j);var G=Kt(j,2),Q=Gt(G),K=Gt(Q),Z=Gt(K,!0);zt(K);var Y=Kt(K,2),X=Gt(Y,!0);zt(Y),zt(Q),zt(G);var J=Kt(G,2),ee=Gt(J),te=Gt(ee),ne=Gt(te,!0);zt(te);var ie=Kt(te,2),ae=Gt(ie,!0);zt(ie),zt(ee),zt(J);var re=Kt(J,2),se=Gt(re),oe=Gt(se),le=Gt(oe,!0);zt(oe);var ce=Kt(oe,2),de=Gt(ce,!0);zt(ce),zt(se),zt(re),zt(R);var ue=Kt(R,2),he=e=>{var t=ple(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n),zt(t),zi(e=>va(i,e),[()=>bi(r)("common.loading")]),pa(e,t)};xa(ue,e=>{o()&&e(he)}),zt(y),zi((e,t,n,i,a,r,l,c,d,u,m,w,k,S,_,I)=>{var M,E;b=Fa(y,1,"tuanki-settings settings-group data-overview-card svelte-1sx3ccu",null,b,e),va(x,t),va(C,`${null!=n?n:""}: ${null!=(M=bi(f))?M:""}`),er(D,"title",i),er(D,"aria-label",a),T.disabled=o(),er(T,"title",r),er(T,"aria-label",l),A.disabled=o(),er(A,"title",c),er(A,"aria-label",d),va(P,u),va(N,m),er(F,"title",null==(E=s())?void 0:E.dataFolderPath),va(B,w),va(q,k),va(W,bi(h)),va(Z,S),va(X,bi(g)),va(ne,_),va(ae,bi(p)),va(le,I),va(de,bi(v))},[()=>({loading:o()}),()=>bi(r)("dataManagement.backup.latest.title"),()=>bi(r)("dataManagement.backup.latest.lastGenerated"),()=>bi(r)("dataManagement.openFolder"),()=>bi(r)("dataManagement.openFolder"),()=>bi(r)("common.refresh"),()=>bi(r)("common.refresh"),()=>bi(r)("dataManagement.backup.operations.createBackup"),()=>bi(r)("dataManagement.backup.operations.createBackup"),()=>bi(r)("dataManagement.backup.operations.createBackup"),()=>bi(r)("dataManagement.backup.latest.dataFolder"),()=>{var e;return(null==(e=s())?void 0:e.dataFolderPath)||bi(r)("common.notSet")},()=>bi(r)("dataManagement.backup.latest.stats.totalSize"),()=>bi(r)("dataManagement.backup.latest.stats.deckCount"),()=>bi(r)("dataManagement.backup.latest.stats.cardTotal"),()=>bi(r)("dataManagement.backup.latest.stats.backupCount")]),pa(e,y);var pe=St(m);return a(),pe}ia(["click"]);var fle=(e,t,n)=>t(bi(n)),mle=la('<div class="loading-spinner svelte-1a1r1hv"></div>'),yle=la('<div class="progress-bar svelte-1a1r1hv"><div class="progress-fill svelte-1a1r1hv"></div></div>'),ble=la('<button><div class="button-content svelte-1a1r1hv"><!> <div class="button-label svelte-1a1r1hv"> </div></div> <!></button>'),wle=la('<div class="status-indicator svelte-1a1r1hv"><div class="status-text svelte-1a1r1hv"> </div></div>'),kle=la('<div><div class="toolbar-header svelte-1a1r1hv"><h3 class="section-title with-accent-bar accent-green svelte-1a1r1hv">数据管理操作</h3></div> <div class="operations-grid svelte-1a1r1hv"></div> <!></div>');function Sle(e,t){if(new.target)return Er({component:Sle,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"disabled",7,!1),s=Ar(t,"operationInProgress",7,null),o=Ar(t,"onExport",7),l=Ar(t,"onImport",7),c=Ar(t,"onReset",7),d=Ar(t,"onOpenFolder",7),u=Ar(t,"onCheckIntegrity",7),h=In(n);const p=$r();let g=In(()=>[{id:"checkIntegrity",label:bi(h)("dataManagement.backup.operations.integrityCheck"),variant:"info",handler:u(),event:"checkIntegrity"},{id:"export",label:bi(h)("dataManagement.backup.operations.exportData"),variant:"primary",handler:o(),event:"export"},{id:"import",label:bi(h)("dataManagement.backup.operations.importData"),variant:"primary",handler:l(),event:"import"},{id:"reset",label:bi(h)("dataManagement.backup.operations.clearAll"),variant:"danger",handler:c(),event:"reset"}]);async function v(e){if(!r()&&!s())try{e.handler&&await e.handler(),p(e.event)}catch(t){_e.error(`操作失败: ${e.label}`,t)}}function f(e){return s()===e}var m={get disabled(){return r()},set disabled(e=!1){r(e),hn()},get operationInProgress(){return s()},set operationInProgress(e=null){s(e),hn()},get onExport(){return o()},set onExport(e){o(e),hn()},get onImport(){return l()},set onImport(e){l(e),hn()},get onReset(){return c()},set onReset(e){c(e),hn()},get onOpenFolder(){return d()},set onOpenFolder(e){d(e),hn()},get onCheckIntegrity(){return u()},set onCheckIntegrity(e){u(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=kle();let b;var w=Kt(Gt(y),2);Ca(w,21,()=>bi(g),_a,(e,t)=>{var n=ble();n.__click=[fle,v,t];var i=Gt(n),a=Gt(i),o=e=>{pa(e,mle())};xa(a,e=>{f(bi(t).id)&&e(o)});var l=Kt(a,2),c=Gt(l,!0);zt(l),zt(i);var d=Kt(i,2),u=e=>{pa(e,yle())};xa(d,e=>{f(bi(t).id)&&e(u)}),zt(n),zi((e,i)=>{Fa(n,1,e,"svelte-1a1r1hv"),n.disabled=i,er(n,"title",bi(t).label),va(c,bi(t).label)},[()=>$a(function(e){const t="operation-button";return`${t} ${t}--${e}`}(bi(t).variant)),()=>{return e=bi(t).id,r()||null!==s()&&s()!==e;var e}]),pa(e,n)}),zt(w);var k=Kt(w,2),S=e=>{var t=wle(),n=Gt(t),i=Gt(n);zt(n),zt(t),zi(e=>va(i,`正在执行: ${null!=e?e:""}`),[()=>{var e;return null==(e=bi(g).find(e=>e.id===s()))?void 0:e.label}]),pa(e,t)};xa(k,e=>{s()&&e(S)}),zt(y),zi(e=>b=Fa(y,1,"data-operation-toolbar svelte-1a1r1hv",null,b,e),[()=>({disabled:r()})]),pa(e,y);var x=St(m);return a(),x}function xle(e,t){e.target===e.currentTarget&&t()}ia(["click"]);var _le=(e,t)=>"Escape"===e.key&&t(),Cle=la('<li class="svelte-i8ujzm"> </li>'),Ile=la('<div class="details-section svelte-i8ujzm"><h4 class="svelte-i8ujzm">操作详情:</h4> <ul class="details-list svelte-i8ujzm"></ul></div>'),Dle=la('<li class="svelte-i8ujzm"> </li>'),Tle=la('<div class="warning-section svelte-i8ujzm"><h4 class="svelte-i8ujzm">⚠️ 注意事项:</h4> <ul class="warning-list svelte-i8ujzm"></ul></div>'),Mle=la('<div class="input-error svelte-i8ujzm">输入的文本不匹配</div>'),Ale=la('<div class="text-confirmation svelte-i8ujzm"><label for="confirmation-input" class="confirmation-label svelte-i8ujzm">请输入 "<strong> </strong>" 以确认操作:</label> <input id="confirmation-input" type="text" autocomplete="off"/> <!></div>'),Ele=la('<div class="button-spinner svelte-i8ujzm"></div> 处理中...',1),zle=la('<div class="processing-overlay svelte-i8ujzm"><div class="processing-spinner svelte-i8ujzm"></div> <div class="processing-text svelte-i8ujzm">正在处理操作...</div></div>'),Ple=la('<div class="confirmation-overlay svelte-i8ujzm" role="dialog" aria-modal="true" tabindex="-1"><div class="confirmation-dialog svelte-i8ujzm"><div class="dialog-header svelte-i8ujzm"><div class="header-icon svelte-i8ujzm"> </div> <div class="header-content svelte-i8ujzm"><h2 class="dialog-title svelte-i8ujzm"> </h2> <div> </div></div></div> <div class="dialog-content svelte-i8ujzm"><div class="main-message svelte-i8ujzm"> </div> <!> <!> <!></div> <div class="dialog-actions svelte-i8ujzm"><button class="action-button cancel-button svelte-i8ujzm"> </button> <button><!></button></div> <!></div></div>');function Rle(e,t){if(new.target)return Er({component:Rle,...e});kt(t,!0);let n=Ar(t,"isOpen",7,!1),i=Ar(t,"title",7),a=Ar(t,"message",7),r=Ar(t,"securityLevel",7),s=Ar(t,"confirmText",7,"确认"),o=Ar(t,"cancelText",7,"取消"),l=Ar(t,"requireTextConfirmation",7,!1),c=Ar(t,"confirmationPhrase",7,"确认操作"),d=Ar(t,"details",23,()=>[]),u=Ar(t,"warningItems",23,()=>[]),h=Ar(t,"onConfirm",7),p=Ar(t,"onCancel",7);const g=$r();let v=Pn(""),f=Pn(!1);const m={safe:{icon:"✅",color:"var(--text-success)",bgColor:"color-mix(in oklab, var(--text-success), transparent 95%)",borderColor:"var(--text-success)"},caution:{icon:"⚠️",color:"var(--text-warning)",bgColor:"color-mix(in oklab, var(--text-warning), transparent 95%)",borderColor:"var(--text-warning)"},danger:{icon:"🚨",color:"var(--text-error)",bgColor:"color-mix(in oklab, var(--text-error), transparent 95%)",borderColor:"var(--text-error)"}};let y=In(()=>m[r()]),b=In(()=>()=>!l()||bi(v).trim()===c());async function w(){if(bi(b)()&&!bi(f))try{$n(f,!0),h()&&await h()(),g("confirm"),S()}catch(e){_e.error("确认操作失败:",e)}finally{$n(f,!1)}}function k(){bi(f)||(p()&&p()(),g("cancel"),S())}function S(){$n(v,""),$n(f,!1)}var x={get isOpen(){return n()},set isOpen(e=!1){n(e),hn()},get title(){return i()},set title(e){i(e),hn()},get message(){return a()},set message(e){a(e),hn()},get securityLevel(){return r()},set securityLevel(e){r(e),hn()},get confirmText(){return s()},set confirmText(e="确认"){s(e),hn()},get cancelText(){return o()},set cancelText(e="取消"){o(e),hn()},get requireTextConfirmation(){return l()},set requireTextConfirmation(e=!1){l(e),hn()},get confirmationPhrase(){return c()},set confirmationPhrase(e="确认操作"){c(e),hn()},get details(){return d()},set details(e=[]){d(e),hn()},get warningItems(){return u()},set warningItems(e=[]){u(e),hn()},get onConfirm(){return h()},set onConfirm(e){h(e),hn()},get onCancel(){return p()},set onCancel(e){p(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},_=ha();na("keydown",Ft,function(e){n()&&("Escape"===e.key?(e.preventDefault(),k()):"Enter"===e.key&&bi(b)()&&(e.preventDefault(),w()))});var C=Qt(_),I=e=>{var t=Ple();t.__click=[xle,k],t.__keydown=[_le,k];var n=Gt(t),h=Gt(n),p=Gt(h),g=Gt(p,!0);zt(p);var m=Kt(p,2),S=Gt(m),x=Gt(S,!0);zt(S);var _=Kt(S,2),C=Gt(_,!0);zt(_),zt(m),zt(h);var I=Kt(h,2),D=Gt(I),T=Gt(D,!0);zt(D);var M=Kt(D,2),A=e=>{var t=Ile(),n=Kt(Gt(t),2);Ca(n,21,d,_a,(e,t)=>{var n=Cle(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(M,e=>{d().length>0&&e(A)});var E=Kt(M,2),z=e=>{var t=Tle(),n=Kt(Gt(t),2);Ca(n,21,u,_a,(e,t)=>{var n=Dle(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(E,e=>{u().length>0&&e(z)});var P=Kt(E,2),R=e=>{var t=Ale(),n=Gt(t),i=Kt(Gt(n)),a=Gt(i,!0);zt(i),Pt(),zt(n);var r=Kt(n,2);let s;Za(r);var o=Kt(r,2),l=e=>{pa(e,Mle())};xa(o,e=>{bi(v)&&!bi(b)()&&e(l)}),zt(t),zi(e=>{va(a,c()),er(r,"placeholder",c()),s=Fa(r,1,"confirmation-input svelte-i8ujzm",null,s,e),r.disabled=bi(f)},[()=>({valid:bi(b)()})]),pr(r,()=>bi(v),e=>$n(v,e)),pa(e,t)};xa(P,e=>{l()&&e(R)}),zt(I);var $=Kt(I,2),O=Gt($);O.__click=k;var L=Gt(O,!0);zt(O);var N=Kt(O,2);N.__click=w;var F=Gt(N),B=e=>{var t=Ele();Pt(),pa(e,t)},j=e=>{var t=ua();zi(()=>va(t,s())),pa(e,t)};xa(F,e=>{bi(f)?e(B):e(j,!1)}),zt(N),zt($);var U=Kt($,2),V=e=>{pa(e,zle())};xa(U,e=>{bi(f)&&e(V)}),zt(n),zt(t),zi(e=>{var t,s,l,c,d;ja(n,`--security-color: ${null!=(t=bi(y).color)?t:""}; --security-bg: ${null!=(s=bi(y).bgColor)?s:""}; --security-border: ${null!=(l=bi(y).borderColor)?l:""}`),va(g,bi(y).icon),va(x,i()),Fa(_,1,`security-badge security-${null!=(c=r())?c:""}`,"svelte-i8ujzm"),va(C,"safe"===r()?"安全操作":"caution"===r()?"谨慎操作":"危险操作"),va(T,a()),O.disabled=bi(f),va(L,o()),Fa(N,1,`action-button confirm-button security-${null!=(d=r())?d:""}`,"svelte-i8ujzm"),N.disabled=e},[()=>!bi(b)()||bi(f)]),pa(e,t)};return xa(C,e=>{n()&&e(I)}),pa(e,_),St(x)}function $le(e,t,n,i){var a;(null==(a=t())?void 0:a.cancellable)&&(n()&&n()(),i("cancel"))}ia(["click","keydown"]);var Ole=la('<button class="cancel-button svelte-1j1pa3z" title="取消操作"><span class="cancel-icon svelte-1j1pa3z">✕</span></button>'),Lle=la('<div class="detail-item svelte-1j1pa3z"><span class="detail-label svelte-1j1pa3z">剩余时间:</span> <span class="detail-value svelte-1j1pa3z"> </span></div>'),Nle=la('<div class="progress-indicator svelte-1j1pa3z"><div class="progress-header svelte-1j1pa3z"><div class="operation-info svelte-1j1pa3z"><div class="operation-icon svelte-1j1pa3z"> </div> <div class="operation-details svelte-1j1pa3z"><div class="operation-title svelte-1j1pa3z"> </div> <div class="operation-status svelte-1j1pa3z"> </div></div></div> <!></div> <div class="progress-bar-container svelte-1j1pa3z"><div class="progress-bar svelte-1j1pa3z"><div class="progress-fill svelte-1j1pa3z"></div></div> <div class="progress-percentage svelte-1j1pa3z"> </div></div> <div class="progress-details svelte-1j1pa3z"><div class="detail-item svelte-1j1pa3z"><span class="detail-label svelte-1j1pa3z">进度:</span> <span class="detail-value svelte-1j1pa3z"> </span></div> <div class="detail-item svelte-1j1pa3z"><span class="detail-label svelte-1j1pa3z">已用时间:</span> <span class="detail-value svelte-1j1pa3z"> </span></div> <!></div> <div class="activity-indicator svelte-1j1pa3z"><div class="activity-dots svelte-1j1pa3z"><div class="dot svelte-1j1pa3z"></div> <div class="dot svelte-1j1pa3z"></div> <div class="dot svelte-1j1pa3z"></div></div></div></div>');function Fle(e,t){if(new.target)return Er({component:Fle,...e});kt(t,!0);let n=Ar(t,"progress",7),i=Ar(t,"isVisible",7,!1),a=Ar(t,"allowCancel",7,!0),r=Ar(t,"onCancel",7);const s=$r(),o={export:"📤",import:"📥",backup:"💾",restore:"🔄",reset:"🗑️",refresh:"🔄",open_folder:"📁",delete_backup:"🗑️"};let l=In(()=>n()?Math.min(100,Math.max(0,n().progress)):0),c=In(()=>n()?`${Math.round(bi(l))}%`:""),d=In(()=>n()?`${n().processedCount} / ${n().totalCount}`:""),u=In(()=>{var e;return(null==(e=n())?void 0:e.startTime)?Date.now()-new Date(n().startTime).getTime():0}),h=In(()=>function(e){if(e<1e3)return`${e}ms`;const t=Math.floor(e/1e3);if(t<60)return`${t}s`;const n=Math.floor(t/60),i=t%60;if(n<60)return i>0?`${n}m ${i}s`:`${n}m`;const a=Math.floor(n/60),r=n%60;return r>0?`${a}h ${r}m`:`${a}h`}(bi(u))),p=In(()=>{var e;return(null==(e=n())?void 0:e.estimatedTimeRemaining)?function(e){if(e<=0)return"未知";const t=Math.ceil(e/1e3);if(t<60)return`约 ${t} 秒`;const n=Math.ceil(t/60);return n<60?`约 ${n} 分钟`:`约 ${Math.ceil(n/60)} 小时`}(n().estimatedTimeRemaining):"计算中..."});function g(){return n()?bi(l)<30?"var(--text-error)":bi(l)<70?"var(--text-warning)":"var(--text-success)":"var(--interactive-accent)"}let v=In(()=>{var e;return a()&&(null==(e=n())?void 0:e.cancellable)});var f={get progress(){return n()},set progress(e){n(e),hn()},get isVisible(){return i()},set isVisible(e=!1){i(e),hn()},get allowCancel(){return a()},set allowCancel(e=!0){a(e),hn()},get onCancel(){return r()},set onCancel(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},m=ha(),y=Qt(m),b=e=>{var t=Nle(),i=Gt(t),a=Gt(i),u=Gt(a),f=Gt(u,!0);zt(u);var m=Kt(u,2),y=Gt(m),b=Gt(y,!0);zt(y);var w=Kt(y,2),k=Gt(w,!0);zt(w),zt(m),zt(a);var S=Kt(a,2),x=e=>{var t=Ole();t.__click=[$le,n,r,s],pa(e,t)};xa(S,e=>{bi(v)&&e(x)}),zt(i);var _=Kt(i,2),C=Gt(_),I=Gt(C);zt(C);var D=Kt(C,2),T=Gt(D,!0);zt(D),zt(_);var M=Kt(_,2),A=Gt(M),E=Kt(Gt(A),2),z=Gt(E,!0);zt(E),zt(A);var P=Kt(A,2),R=Kt(Gt(P),2),$=Gt(R,!0);zt(R),zt(P);var O=Kt(P,2),L=e=>{var t=Lle(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n),zt(t),zi(()=>va(i,bi(p))),pa(e,t)};xa(O,e=>{void 0!==n().estimatedTimeRemaining&&e(L)}),zt(M),Pt(2),zt(t),zi((e,t,i)=>{var a;va(f,e),va(b,t),va(k,n().status),ja(I,`width: ${null!=(a=bi(l))?a:""}%; background-color: ${null!=i?i:""}`),va(T,bi(c)),va(z,bi(d)),va($,bi(h))},[()=>{return e=n().operation,o[e]||"⚙️";var e},()=>{return{export:"导出",import:"导入",backup:"备份",restore:"恢复",reset:"重置",refresh:"刷新",open_folder:"打开文件夹",delete_backup:"删除备份"}[e=n().operation]||e;var e},g]),pa(e,t)};return xa(y,e=>{i()&&n()&&e(b)}),pa(e,m),St(f)}async function Ble(e,t,n){bi(t).enabled=!bi(t).enabled,await n()}ia(["click"]);var jle=(e,t,n)=>t(bi(n).intervalHours),Ule=(e,t,n)=>t(bi(n).triggers.cardThresholdCount),Vle=la('<div class="setting-item nested svelte-1veqk4o"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><input type="number" min="1" max="10000" class="modern-input number-input"/> <span class="unit-label"> </span></div></div>'),qle=la('<div class="tuanki-settings auto-backup-config svelte-1veqk4o"><div class="settings-group"><h4 class="group-title with-accent-bar accent-red"> </h4> <p class="group-description"> </p> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox"/> <span class="toggle-slider"></span></label></div></div> <div><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><input type="number" min="1" max="168" class="modern-input number-input"/> <span class="unit-label"> </span></div></div></div> <div><h4 class="group-title with-accent-bar accent-blue"> </h4> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox"/> <span class="toggle-slider"></span></label></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch"><input type="checkbox"/> <span class="toggle-slider"></span></label></div></div> <!></div></div>');function Hle(e,t){var n,i,a,r,s,o,l,c,d,u,h,p,g,v,f;if(new.target)return Er({component:Hle,...e});kt(t,!0);const m=()=>Ir(Vp,"$tr",y),[y,b]=Dr();let w=In(m),k=Ar(t,"plugin",7),S=Pn(Ot({enabled:null==(i=null==(n=k().settings.autoBackupConfig)?void 0:n.enabled)||i,intervalHours:null!=(r=null==(a=k().settings.autoBackupConfig)?void 0:a.intervalHours)?r:24,triggers:{onStartup:null==(o=null==(s=k().settings.autoBackupConfig)?void 0:s.triggers.onStartup)||o,onCardThreshold:null==(c=null==(l=k().settings.autoBackupConfig)?void 0:l.triggers.onCardThreshold)||c,cardThresholdCount:null!=(u=null==(d=k().settings.autoBackupConfig)?void 0:d.triggers.cardThresholdCount)?u:100},notifications:null!=(p=null==(h=k().settings.autoBackupConfig)?void 0:h.notifications)?p:{onSuccess:!0,onFailure:!0},lastAutoBackupTime:null==(g=k().settings.autoBackupConfig)?void 0:g.lastAutoBackupTime,autoBackupCount:null!=(f=null==(v=k().settings.autoBackupConfig)?void 0:v.autoBackupCount)?f:0}));async function x(){k().settings.autoBackupConfig={...bi(S)},await k().saveSettings();const e=k().autoBackupScheduler;e&&e.restart()}async function _(e){const t=Math.max(1,Math.min(1e4,e));bi(S).triggers.cardThresholdCount=t,await x()}var C={get plugin(){return k()},set plugin(e){k(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},I=qle(),D=Gt(I),T=Gt(D),M=Gt(T,!0);zt(T);var A=Kt(T,2),E=Gt(A,!0);zt(A);var z=Kt(A,2),P=Gt(z),R=Gt(P),$=Gt(R,!0);zt(R);var O=Kt(R,2),L=Gt(O,!0);zt(O),zt(P);var N=Kt(P,2),F=Gt(N),B=Gt(F);Za(B),B.__change=[Ble,S,x],Pt(2),zt(F),zt(N),zt(z);var j=Kt(z,2);let U;var V=Gt(j),q=Gt(V),H=Gt(q,!0);zt(q);var W=Kt(q,2),G=Gt(W,!0);zt(W),zt(V);var Q=Kt(V,2),K=Gt(Q);Za(K),K.__change=[jle,async function(e){const t=Math.max(1,Math.min(168,e));bi(S).intervalHours=t,await x()},S];var Z=Kt(K,2),Y=Gt(Z,!0);zt(Z),zt(Q),zt(j),zt(D);var X=Kt(D,2);let J;var ee=Gt(X),te=Gt(ee,!0);zt(ee);var ne=Kt(ee,2),ie=Gt(ne),ae=Gt(ie),re=Gt(ae,!0);zt(ae);var se=Kt(ae,2),oe=Gt(se,!0);zt(se),zt(ie);var le=Kt(ie,2),ce=Gt(le),de=Gt(ce);Za(de),de.__change=x,Pt(2),zt(ce),zt(le),zt(ne);var ue=Kt(ne,2),he=Gt(ue),pe=Gt(he),ge=Gt(pe,!0);zt(pe);var ve=Kt(pe,2),fe=Gt(ve,!0);zt(ve),zt(he);var me=Kt(he,2),ye=Gt(me),be=Gt(ye);Za(be),be.__change=x,Pt(2),zt(ye),zt(me),zt(ue);var we=Kt(ue,2),ke=e=>{var t=Vle(),n=Gt(t),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r,!0);zt(r),zt(n);var o=Kt(n,2),l=Gt(o);Za(l),l.__change=[Ule,_,S];var c=Kt(l,2),d=Gt(c,!0);zt(c),zt(o),zt(t),zi((e,t,n)=>{va(a,e),va(s,t),l.disabled=!bi(S).enabled,va(d,n)},[()=>bi(w)("dataManagement.backup.auto.triggers.thresholdCount"),()=>bi(w)("dataManagement.backup.auto.triggers.thresholdCountDesc"),()=>bi(w)("dataManagement.backup.auto.triggers.thresholdUnit")]),pr(l,()=>bi(S).triggers.cardThresholdCount,e=>bi(S).triggers.cardThresholdCount=e),pa(e,t)};xa(we,e=>{bi(S).triggers.onCardThreshold&&e(ke)}),zt(X),zt(I),zi((e,t,n,i,a,r,s,o,l,c,d,u,h,p)=>{va(M,e),va(E,t),va($,n),va(L,i),Xa(B,bi(S).enabled),U=Fa(j,1,"setting-item svelte-1veqk4o",null,U,a),va(H,r),va(G,s),K.disabled=!bi(S).enabled,va(Y,o),J=Fa(X,1,"settings-group svelte-1veqk4o",null,J,l),va(te,c),va(re,d),va(oe,u),de.disabled=!bi(S).enabled,va(ge,h),va(fe,p),be.disabled=!bi(S).enabled},[()=>bi(w)("dataManagement.backup.auto.title"),()=>bi(w)("dataManagement.backup.auto.description"),()=>bi(w)("dataManagement.backup.auto.enable"),()=>bi(w)("dataManagement.backup.auto.enableDesc"),()=>({disabled:!bi(S).enabled}),()=>bi(w)("dataManagement.backup.auto.interval"),()=>bi(w)("dataManagement.backup.auto.intervalDesc"),()=>bi(w)("dataManagement.backup.auto.intervalUnit"),()=>({disabled:!bi(S).enabled}),()=>bi(w)("dataManagement.backup.auto.triggers.title"),()=>bi(w)("dataManagement.backup.auto.triggers.onStartup"),()=>bi(w)("dataManagement.backup.auto.triggers.onStartupDesc"),()=>bi(w)("dataManagement.backup.auto.triggers.onCardThreshold"),()=>bi(w)("dataManagement.backup.auto.triggers.onCardThresholdDesc")]),pr(K,()=>bi(S).intervalHours,e=>bi(S).intervalHours=e),fr(de,()=>bi(S).triggers.onStartup,e=>bi(S).triggers.onStartup=e),fr(be,()=>bi(S).triggers.onCardThreshold,e=>bi(S).triggers.onCardThreshold=e),pa(e,I);var Se=St(C);return b(),Se}ia(["change"]);var Wle=(e,t)=>$n(t,null),Gle=la('<div class="error-banner svelte-1y5hgf2"><div class="error-icon svelte-1y5hgf2">❌</div> <div class="error-message svelte-1y5hgf2"> </div> <button class="error-dismiss svelte-1y5hgf2">✕</button></div>'),Qle=la('<div class="repair-suggestion-banner svelte-1y5hgf2"><div class="repair-icon svelte-1y5hgf2">🔧</div> <div class="repair-content svelte-1y5hgf2"><div class="repair-title svelte-1y5hgf2"> </div> <div class="repair-description svelte-1y5hgf2">这些备份可能缺少必要文件或元数据损坏，建议尝试自动修复或直接清理</div></div> <div class="repair-actions svelte-1y5hgf2"><button class="repair-button svelte-1y5hgf2">自动修复全部</button> <button class="cleanup-button svelte-1y5hgf2">清理无效备份</button></div> <button class="repair-dismiss svelte-1y5hgf2">✕</button></div>'),Kle=(e,t,n)=>t(e,bi(n)),Zle=la('<tr><td class="time-cell svelte-1y5hgf2"> </td><td class="type-cell svelte-1y5hgf2"><span> </span></td><td class="size-cell svelte-1y5hgf2"> </td><td class="action-cell svelte-1y5hgf2"><button class="menu-button svelte-1y5hgf2" title="更多操作" aria-label="更多操作"><!></button></td></tr>'),Yle=la('<div class="more-backups-hint svelte-1y5hgf2"> </div>'),Xle=la('<div class="backup-table-wrapper svelte-1y5hgf2"><table class="backup-table svelte-1y5hgf2"><thead class="svelte-1y5hgf2"><tr><th class="svelte-1y5hgf2"> </th><th class="svelte-1y5hgf2"> </th><th class="svelte-1y5hgf2"> </th><th class="svelte-1y5hgf2"> </th></tr></thead><tbody class="svelte-1y5hgf2"></tbody></table></div> <!>',1),Jle=la('<div class="no-backups svelte-1y5hgf2"><!> <p class="svelte-1y5hgf2">暂无备份记录</p></div>'),ece=async(e,t,n)=>{t().settings.dataFolderVisibility?(t().settings.dataFolderVisibility.hideInFileExplorer=bi(n),t().settings.dataFolderVisibility.folderName="tuanki"):t().settings.dataFolderVisibility={hideInFileExplorer:bi(n),folderName:"tuanki",userAcknowledgedRisk:!1},await t().saveSettings(),t().dataFolderHider&&(bi(n)?(t().dataFolderHider.enable("tuanki"),new ge.Notice("✅ 已启用数据文件夹CSS隐藏")):(t().dataFolderHider.disable(),new ge.Notice("✅ 已禁用数据文件夹CSS隐藏")))},tce=la('<div class="tuanki-settings data-management-panel svelte-1y5hgf2"><!> <!> <!> <!> <div class="tuanki-settings settings-group backup-history"><h4 class="group-title with-accent-bar accent-purple"> </h4> <!></div> <!> <div class="tuanki-settings settings-group folder-path-config svelte-1y5hgf2"><div class="group-title-with-toggle svelte-1y5hgf2"><h4 class="group-title with-accent-bar accent-cyan">📁 Tuanki 文件夹位置</h4> <div class="data-folder-visibility-section svelte-1y5hgf2"><div class="data-folder-visibility-toggle svelte-1y5hgf2"><span class="toggle-text svelte-1y5hgf2">隐藏数据文件夹</span> <label class="modern-switch svelte-1y5hgf2"><input type="checkbox" class="svelte-1y5hgf2"/> <span class="switch-slider svelte-1y5hgf2"></span></label></div> <div class="toggle-description svelte-1y5hgf2">通过CSS隐藏 <code class="svelte-1y5hgf2">tuanki/</code> 文件夹，保持文件列表清洁</div></div></div></div>  <!> <!></div>');function nce(e,t){var n,i;if(new.target)return Er({component:nce,...e});kt(t,!0);const a=()=>Ir(Vp,"$tr",r),[r,s]=Dr();let o,l=Ar(t,"plugin",7),c=In(a),d=null,u=Pn(Ot(null==(i=null==(n=l().settings.dataFolderVisibility)?void 0:n.hideInFileExplorer)||i)),h=Pn(null),p=Pn(null),g=Pn(0),v=In(()=>(bi(g),(null==d?void 0:d.backups)||[])),f=In(()=>(bi(g),(null==d?void 0:d.isLoading)||!1)),m=In(()=>(bi(g),(null==d?void 0:d.currentOperation)?{operation:d.currentOperation.type,progress:d.currentOperation.progress,status:d.currentOperation.status,processedCount:0,totalCount:100,startTime:(new Date).toISOString(),cancellable:!1}:null)),y=In(()=>{var e;return bi(g),(null==(e=null==d?void 0:d.currentOperation)?void 0:e.type)||null}),b=In(()=>{if(bi(g),!d)return{show:!1,count:0,backups:[]};const e=d.stats;return e&&e.invalidBackups&&e.invalidBackups.length>0?{show:!0,count:e.invalidBackups.length,backups:e.invalidBackups}:{show:!1,count:0,backups:[]}}),w=Pn(Ot({isOpen:!1,title:"",message:"",securityLevel:"safe",requireTextConfirmation:!1,confirmationPhrase:"",details:[],warningItems:[],onConfirm:null}));async function k(){$n(p,null);try{await Promise.all([S(),null==d?void 0:d.loadBackups()])}catch(e){_e.error("加载数据失败:",e),$n(p,"数据加载失败，请重试")}}async function S(){try{$n(h,await o.getDataOverview(),!0)}catch(e){_e.error("获取数据概览失败:",e)}}async function x(){try{await o.openDataFolder()}catch(e){_e.error("打开文件夹失败:",e),$n(p,"无法打开文件夹")}}function _(e,t){const n=new ge.Menu;n.addItem(e=>{e.setTitle("预览").setIcon("eye").onClick(async()=>{await async function(e){if(!d)return;try{const t=await d.previewBackup(e);if(t){const n=bi(v).find(t=>t.id===e);D({title:"备份预览",message:`备份时间: ${n?new Date(n.timestamp).toLocaleString():"未知"}`,securityLevel:"safe",confirmText:"关闭",details:[`牌组数量: ${t.deckCount} 个`,`卡片数量: ${t.cardCount} 个`,`备份ID: ${e}`],onConfirm:()=>{T()}})}}catch(t){_e.error("预览备份失败:",t),$n(p,"预览备份失败")}}(t.id)})}),n.addItem(e=>{e.setTitle("恢复").setIcon("rotate-ccw").onClick(async()=>{await async function(e){var t;if(!e&&0===bi(v).length)return void $n(p,"没有可用的备份");const n=e||(null==(t=bi(v)[0])?void 0:t.id),i=bi(v).find(e=>e.id===n);i?D({title:"恢复备份",message:"确定要从备份恢复数据吗？",securityLevel:"caution",details:[`备份时间: ${new Date(i.timestamp).toLocaleString()}`,`备份大小: ${(i.size/1024/1024).toFixed(2)} MB`,`备份类型: ${i.type}`],warningItems:["当前数据将被覆盖","恢复前将自动创建备份","此操作不可撤销"],onConfirm:async()=>{try{const e=Hs(Bs.BACKUP_MANAGEMENT_SERVICE),t=await e.restoreFromBackup(n,{dataTypes:["decks","cards","sessions","profile"],createPreRestoreBackup:!0,conflictStrategy:"overwrite"});if(!t.success)throw new Error(t.error||"恢复失败");await k(),new ge.Notice(`✅ 数据恢复成功\n恢复文件数: ${t.restoredFileCount}`),T()}catch(e){_e.error("恢复失败:",e);const t=e instanceof Error?e.message:"恢复失败";new ge.Notice(`❌ 恢复失败: ${t}`,5e3),$n(p,t,!0),T()}}}):$n(p,"备份不存在")}(t.id)})}),n.addSeparator(),n.addItem(e=>{e.setTitle("删除").setIcon("trash").onClick(async()=>{await async function(e){const t=bi(v).find(t=>t.id===e);if(!t)return;D({title:"删除备份",message:"确定要删除此备份吗？",securityLevel:"caution",details:[`备份时间: ${new Date(t.timestamp).toLocaleString()}`,`备份大小: ${(t.size/1024/1024).toFixed(2)} MB`],warningItems:["删除后无法恢复","建议保留重要备份"],onConfirm:async()=>{try{await(null==d?void 0:d.deleteBackup(e)),new ge.Notice("✅ 备份已删除"),T()}catch(t){_e.error("删除备份失败:",t),new ge.Notice("❌ 删除备份失败",5e3),$n(p,"删除备份失败"),T()}}})}(t.id)})}),n.showAtMouseEvent(e)}async function C(){if(d)try{const e=await d.autoRepairAll();if(e.success>0&&new ge.Notice(`✅ 成功修复 ${e.success} 个备份`),e.failed>0){const t=`⚠️ 修复了 ${e.success} 个备份，${e.failed} 个修复失败`;new ge.Notice(t,5e3),$n(p,t)}}catch(e){_e.error("批量修复失败:",e),new ge.Notice("❌ 批量修复失败",5e3),$n(p,"批量修复失败")}}async function I(){d&&D({title:"清理无效备份",message:"确定要删除所有无效的备份吗？",securityLevel:"warning",details:["将删除所有损坏或数据为空的备份","此操作不可撤销"],warningItems:["请确保已有其他有效备份","建议先检查备份列表"],onConfirm:async()=>{if(d)try{const e=await d.cleanupInvalidBackups();if(e){const t=`✅ 成功删除 ${e.deleted} 个无效备份${e.failed>0?`，失败 ${e.failed} 个`:""}`;new ge.Notice(t)}}catch(e){_e.error("清理无效备份失败:",e),new ge.Notice("❌ 清理无效备份失败",5e3),$n(p,"清理无效备份失败")}}})}function D(e){$n(w,{isOpen:!0,title:e.title,message:e.message,securityLevel:e.securityLevel,requireTextConfirmation:e.requireTextConfirmation||!1,confirmationPhrase:e.confirmationPhrase||bi(c)("dataManagement.confirmPhrase"),details:e.details||[],warningItems:e.warningItems||[],onConfirm:e.onConfirm},!0)}function T(){bi(w).isOpen=!1}Pr(async()=>{try{if(!l())throw new Error("Plugin实例不可用");d=new ole(l()),d.subscribe(()=>{Ln(g)}),o=Hs(Bs.DATA_MANAGEMENT_SERVICE),await k()}catch(e){_e.error("初始化数据管理服务失败:",e),$n(p,`${bi(c)("dataManagement.initFailed")}: ${e instanceof Error?e.message:String(e)}`)}}),Rr(()=>{d&&d.reset()});var M={get plugin(){return l()},set plugin(e){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},A=tce(),E=Gt(A),z=e=>{var t=Gle(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n),Kt(n,2).__click=[Wle,p],zt(t),zi(()=>va(i,bi(p))),pa(e,t)};xa(E,e=>{bi(p)&&e(z)});var P=Kt(E,2),R=e=>{var t=Qle(),n=Kt(Gt(t),2),i=Gt(n),a=Gt(i);zt(i),Pt(2),zt(n);var r=Kt(n,2),s=Gt(r);s.__click=C,Kt(s,2).__click=I,zt(r),Kt(r,2).__click=()=>null==d?void 0:d.clearError(),zt(t),zi(()=>{var e;return va(a,`发现 ${null!=(e=bi(b).count)?e:""} 个损坏的备份`)}),pa(e,t)};xa(P,e=>{bi(b).show&&e(R)});var $=Kt(P,2);{let e=In(()=>null!==bi(m));Fle($,{get progress(){return bi(m)},get isVisible(){return bi(e)},allowCancel:!1})}var O=Kt($,2);vle(O,{get overview(){return bi(h)},get isLoading(){return bi(f)},onRefresh:async function(){try{$n(h,await o.getDataOverview(),!0)}catch(e){_e.error("刷新数据概览失败:",e),$n(p,"刷新失败，请重试")}},onOpenFolder:x,onCreateBackup:async function(){try{const e=await(null==d?void 0:d.createBackup(bi(c)("dataManagement.backup.manual.label")));if(!e)throw new Error(bi(c)("dataManagement.backup.manual.failed"));new ge.Notice(`✅ ${bi(c)("dataManagement.backup.manual.success")}\n${bi(c)("dataManagement.backup.manual.successDetail").replace("{size}",(e.size/1024/1024).toFixed(2))}`)}catch(e){_e.error("创建备份失败:",e);const t=e instanceof Error?e.message:bi(c)("dataManagement.backup.manual.failed");new ge.Notice(`❌ ${bi(c)("dataManagement.backup.manual.failed")}: ${t}`,5e3),$n(p,t,!0)}}});var L=Kt(O,2),N=Gt(L),F=Gt(N,!0);zt(N);var B=Kt(N,2),j=e=>{var t=Xle(),n=Qt(t),i=Gt(n),a=Gt(i),r=Gt(a),s=Gt(r),o=Gt(s,!0);zt(s);var l=Kt(s),d=Gt(l,!0);zt(l);var u=Kt(l),h=Gt(u,!0);zt(u);var p=Kt(u),g=Gt(p,!0);zt(p),zt(r),zt(a);var f=Kt(a);Ca(f,21,()=>bi(v).slice(0,5),e=>e.id,(e,t)=>{var n=Zle();let i;var a=Gt(n),r=Gt(a,!0);zt(a);var s=Kt(a),o=Gt(s);let l;var d=Gt(o,!0);zt(o),zt(s);var u=Kt(s),h=Gt(u,!0);zt(u);var p=Kt(u),g=Gt(p);g.__click=[Kle,_,t],m5(Gt(g),{name:"more-horizontal",size:16}),zt(g),zt(p),zt(n),zi((e,t,a,s,c)=>{i=Fa(n,1,"svelte-1y5hgf2",null,i,e),va(r,t),l=Fa(o,1,"type-badge svelte-1y5hgf2",null,l,a),va(d,s),va(h,c)},[()=>({invalid:!bi(t).isValid}),()=>{return e=bi(t).timestamp,new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});var e},()=>({auto:"auto"===bi(t).type,manual:"manual"===bi(t).type}),()=>{return"auto"===(e=bi(t).type)?bi(c)("dataManagement.backup.history.type.auto"):"manual"===e?bi(c)("dataManagement.backup.history.type.manual"):e;var e},()=>lle(bi(t).size)]),pa(e,n)}),zt(f),zt(i),zt(n);var m=Kt(n,2),y=e=>{var t=Yle(),n=Gt(t);zt(t),zi(()=>va(n,`还有 ${bi(v).length-5} 个备份未显示`)),pa(e,t)};xa(m,e=>{bi(v).length>5&&e(y)}),zi((e,t,n,i)=>{va(o,e),va(d,t),va(h,n),va(g,i)},[()=>bi(c)("dataManagement.backup.history.tableHeaders.backupTime"),()=>bi(c)("dataManagement.backup.history.tableHeaders.backupType"),()=>bi(c)("dataManagement.backup.history.tableHeaders.backupSize"),()=>bi(c)("dataManagement.backup.history.tableHeaders.actions")]),pa(e,t)},U=e=>{var t=Jle();m5(Gt(t),{name:"archive",size:24}),Pt(2),zt(t),pa(e,t)};xa(B,e=>{bi(v).length>0?e(j):e(U,!1)}),zt(L);var V=Kt(L,2);Hle(V,{get plugin(){return l()}});var q=Kt(V,2),H=Gt(q),W=Kt(Gt(H),2),G=Gt(W),Q=Kt(Gt(G),2),K=Gt(Q);Za(K),K.__change=[ece,l,u],Pt(2),zt(Q),zt(G),Pt(2),zt(W),zt(H),zt(q);var Z=Kt(q,2);{let e=In(()=>bi(f)||null!==bi(y));Sle(Z,{get disabled(){return bi(e)},get operationInProgress(){return bi(y)},onCheckIntegrity:async function(){try{const e=await o.checkDataIntegrity();if(e.passed)new ge.Notice(`✅ 数据完整性检查通过\n得分: ${e.score}/100`);else{const t=e.issues.filter(e=>"critical"===e.severity||"error"===e.severity);new ge.Notice(`⚠️ 发现 ${t.length} 个严重问题\n得分: ${e.score}/100`,5e3)}e.issues.length>0&&D({title:"数据完整性检查结果",message:`检查得分: ${e.score}/100`,securityLevel:e.passed?"safe":"caution",details:e.issues.map(e=>`[${e.severity.toUpperCase()}] ${e.description}`),warningItems:e.issues.filter(e=>e.fixSuggestion).map(e=>e.fixSuggestion),confirmText:"关闭",onConfirm:()=>{T()}})}catch(e){_e.error("完整性检查失败:",e),new ge.Notice("❌ 完整性检查失败",5e3),$n(p,e instanceof Error?e.message:"完整性检查失败",!0)}},onExport:async function(){D({title:bi(c)("dataManagement.importExport.export.title"),message:bi(c)("dataManagement.importExport.export.confirm"),securityLevel:"safe",details:[bi(c)("dataManagement.importExport.export.details.all"),bi(c)("dataManagement.importExport.export.details.records"),bi(c)("dataManagement.importExport.export.details.format")],onConfirm:async()=>{try{const e=await o.exportData({dataTypes:["decks","cards","sessions","profile","templates"],includeMedia:!0,compress:!1,format:"json"});if(!e.success)throw new Error(e.error||bi(c)("dataManagement.importExport.export.failed"));new ge.Notice(`✅ ${bi(c)("dataManagement.importExport.export.success")}\n${bi(c)("dataManagement.importExport.export.successDetail").replace("{path}",e.filePath)}`)}catch(e){_e.error("导出失败:",e);const t=e instanceof Error?e.message:bi(c)("dataManagement.importExport.export.failed");new ge.Notice(`❌ ${bi(c)("dataManagement.importExport.export.failed")}: ${t}`,5e3),$n(p,t,!0)}}})},onImport:async function(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];n&&D({title:bi(c)("dataManagement.importExport.import.title"),message:bi(c)("dataManagement.importExport.import.confirm"),securityLevel:"caution",details:[bi(c)("dataManagement.importExport.import.details.fileName").replace("{name}",n.name),bi(c)("dataManagement.importExport.import.details.fileSize").replace("{size}",(n.size/1024/1024).toFixed(2)),bi(c)("dataManagement.importExport.import.details.autoBackup")],warningItems:[bi(c)("dataManagement.importExport.import.warnings.override"),bi(c)("dataManagement.importExport.import.warnings.format"),bi(c)("dataManagement.importExport.import.warnings.backup")],onConfirm:async()=>{try{const e=await o.importData(n,{conflictStrategy:"ask",createBackup:!0,validateData:!0,batchSize:100});if(!e.success)throw new Error(e.error||bi(c)("dataManagement.importExport.import.failed"));await k(),new ge.Notice(`✅ ${bi(c)("dataManagement.importExport.import.success")}\n${bi(c)("dataManagement.importExport.import.successDetail").replace("{imported}",String(e.importedCount)).replace("{skipped}",String(e.skippedCount))}`)}catch(e){_e.error("导入失败:",e);const t=e instanceof Error?e.message:bi(c)("dataManagement.importExport.import.failed");new ge.Notice(`❌ ${bi(c)("dataManagement.importExport.import.failed")}: ${t}`,5e3),$n(p,t,!0)}}})},e.click()},onReset:async function(){var e,t,n;D({title:"重置所有数据",message:"此操作将永久删除所有数据！",securityLevel:"danger",requireTextConfirmation:!0,confirmationPhrase:bi(c)("dataManagement.resetConfirmPhrase"),details:[`将删除 ${(null==(e=bi(h))?void 0:e.totalCards)||0} 张卡片`,`将删除 ${(null==(t=bi(h))?void 0:t.totalDecks)||0} 个牌组`,`将删除 ${(null==(n=bi(h))?void 0:n.totalSessions)||0} 次学习记录`,"将清空所有用户设置"],warningItems:["此操作不可撤销！","重置前将自动创建备份","请确保您真的要执行此操作"],onConfirm:async()=>{try{const e=await o.resetData(bi(c)("dataManagement.resetConfirmPhrase"));if(!e.success)throw new Error(e.error||"重置失败");await k(),new ge.Notice(`✅ 数据重置成功\n已清理 ${e.clearedRecordCount} 条记录`),T()}catch(e){_e.error("重置失败:",e);const t=e instanceof Error?e.message:"重置失败";new ge.Notice(`❌ 重置失败: ${t}`,5e3),$n(p,t,!0),T()}}})},onOpenFolder:()=>x()})}var Y=Kt(Z,2);{let e=In(()=>bi(w).onConfirm||void 0);Rle(Y,{get isOpen(){return bi(w).isOpen},get title(){return bi(w).title},get message(){return bi(w).message},get securityLevel(){return bi(w).securityLevel},get requireTextConfirmation(){return bi(w).requireTextConfirmation},get confirmationPhrase(){return bi(w).confirmationPhrase},get details(){return bi(w).details},get warningItems(){return bi(w).warningItems},get onConfirm(){return bi(e)},onCancel:T})}zt(A),zi(e=>va(F,e),[()=>bi(c)("dataManagement.backup.history.title")]),fr(K,()=>bi(u),e=>$n(u,e)),pa(e,A);var X=St(M);return s(),X}ia(["click","change"]);var ice=(e=>(e.NOT_RUNNING="not_running",e.PERMISSION="permission",e.NETWORK="network",e.VERSION_MISMATCH="version_mismatch",e.UNKNOWN="unknown",e))(ice||{}),ace=(e=>(e.IDLE="idle",e.PREPARING="preparing",e.SYNCING="syncing",e.COMPLETED="completed",e.FAILED="failed",e.CANCELLED="cancelled",e))(ace||{});class rce extends Error{constructor(e,t="unknown",n){super(e),this.type=t,this.suggestion=n,this.name="AnkiConnectError"}}var sce=(e=>(e[e.FILE_NOT_FOUND=1001]="FILE_NOT_FOUND",e[e.FILE_ALREADY_EXISTS=1002]="FILE_ALREADY_EXISTS",e[e.FILE_READ_ERROR=1003]="FILE_READ_ERROR",e[e.FILE_WRITE_ERROR=1004]="FILE_WRITE_ERROR",e[e.FILE_DELETE_ERROR=1005]="FILE_DELETE_ERROR",e[e.FOLDER_CREATE_ERROR=1006]="FOLDER_CREATE_ERROR",e[e.FOLDER_NOT_FOUND=1007]="FOLDER_NOT_FOUND",e[e.STORAGE_INIT_ERROR=2001]="STORAGE_INIT_ERROR",e[e.STORAGE_READ_ERROR=2002]="STORAGE_READ_ERROR",e[e.STORAGE_WRITE_ERROR=2003]="STORAGE_WRITE_ERROR",e[e.STORAGE_PARSE_ERROR=2004]="STORAGE_PARSE_ERROR",e[e.STORAGE_BACKUP_ERROR=2005]="STORAGE_BACKUP_ERROR",e[e.CARD_NOT_FOUND=3001]="CARD_NOT_FOUND",e[e.CARD_CREATE_ERROR=3002]="CARD_CREATE_ERROR",e[e.CARD_UPDATE_ERROR=3003]="CARD_UPDATE_ERROR",e[e.CARD_DELETE_ERROR=3004]="CARD_DELETE_ERROR",e[e.CARD_PARSE_ERROR=3005]="CARD_PARSE_ERROR",e[e.DECK_NOT_FOUND=4001]="DECK_NOT_FOUND",e[e.DECK_CREATE_ERROR=4002]="DECK_CREATE_ERROR",e[e.DECK_UPDATE_ERROR=4003]="DECK_UPDATE_ERROR",e[e.DECK_DELETE_ERROR=4004]="DECK_DELETE_ERROR",e[e.ANKICONNECT_CONNECTION_ERROR=5001]="ANKICONNECT_CONNECTION_ERROR",e[e.ANKICONNECT_API_ERROR=5002]="ANKICONNECT_API_ERROR",e[e.ANKICONNECT_SYNC_ERROR=5003]="ANKICONNECT_SYNC_ERROR",e[e.EDITOR_INIT_ERROR=6001]="EDITOR_INIT_ERROR",e[e.EDITOR_OPEN_ERROR=6002]="EDITOR_OPEN_ERROR",e[e.EDITOR_SAVE_ERROR=6003]="EDITOR_SAVE_ERROR",e[e.EDITOR_CLOSE_ERROR=6004]="EDITOR_CLOSE_ERROR",e[e.TEMPLATE_NOT_FOUND=7001]="TEMPLATE_NOT_FOUND",e[e.TEMPLATE_PARSE_ERROR=7002]="TEMPLATE_PARSE_ERROR",e[e.TEMPLATE_RENDER_ERROR=7003]="TEMPLATE_RENDER_ERROR",e[e.FSRS_CALCULATION_ERROR=8001]="FSRS_CALCULATION_ERROR",e[e.FSRS_PARAMETER_ERROR=8002]="FSRS_PARAMETER_ERROR",e[e.UNKNOWN_ERROR=9999]="UNKNOWN_ERROR",e))(sce||{});class oce{static createFileSystemError(e,t,n,i,a){return{code:e,message:t,severity:"error",path:n,operation:i,originalError:a,timestamp:(new Date).toISOString(),stack:(new Error).stack}}static createStorageError(e,t,n,i,a){return{code:e,message:t,severity:"error",operation:n,dataType:i,originalError:a,timestamp:(new Date).toISOString(),stack:(new Error).stack}}static createCardError(e,t,n,i,a){return{code:e,message:t,severity:"error",cardId:n,deckId:i,originalError:a,timestamp:(new Date).toISOString(),stack:(new Error).stack}}static createAnkiConnectError(e,t,n,i,a,r){return{code:e,message:t,severity:"error",action:n,params:i,response:a,originalError:r,timestamp:(new Date).toISOString(),stack:(new Error).stack}}}class lce{constructor(e="http://localhost:8765"){oe(this,"endpoint"),oe(this,"apiVersion",6),oe(this,"requestTimeout",5e3),this.endpoint=e}async invoke(e,t){const n={action:e,version:this.apiVersion,params:t||{}};try{const e=new AbortController,t=setTimeout(()=>e.abort(),this.requestTimeout),i=await fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),signal:e.signal});if(clearTimeout(t),!i.ok)throw new rce(`HTTP 错误: ${i.status} ${i.statusText}`,ice.NETWORK,"请检查网络连接和 AnkiConnect 插件状态");const a=await i.json();if(a.error)throw new rce(a.error,ice.UNKNOWN,"请查看 Anki 错误日志获取详细信息");return a.result}catch(i){if(i instanceof Error&&"AbortError"===i.name)throw oce.createAnkiConnectError(sce.ANKICONNECT_CONNECTION_ERROR,"请求超时",e,t,void 0,i);if(i instanceof rce)throw i;const n=function(e){return"string"==typeof e?e:function(e){return"object"==typeof e&&null!==e&&"message"in e&&"string"==typeof e.message}(e)||function(e){return"object"==typeof e&&null!==e&&"code"in e&&"message"in e&&"severity"in e}(e)?e.message:"未知错误"}(i);if(n.includes("fetch")||n.includes("Failed to fetch")||n.includes("CONNECTION_REFUSED")||n.includes("ERR_CONNECTION_REFUSED")||n.includes("ECONNREFUSED"))throw oce.createAnkiConnectError(sce.ANKICONNECT_CONNECTION_ERROR,"请检查Anki软件是否正常启动且运行，并确认已安装AnkiConnect插件",e,t,void 0,i instanceof Error?i:void 0);throw oce.createAnkiConnectError(sce.ANKICONNECT_API_ERROR,n||"未知错误",e,t,void 0,i instanceof Error?i:void 0)}}async testConnection(){try{return await this.invoke("version"),!0}catch(e){return!1}}async getVersion(){return await this.invoke("version")}async getDeckNames(){return await this.invoke("deckNames")}async getModelNames(){return await this.invoke("modelNames")}async getModelFieldNames(e){return await this.invoke("modelFieldNames",{modelName:e})}async getModelInfo(e){try{const n=(await this.invoke("modelNamesAndIds"))[e];if(void 0===n)throw new rce(`模型 "${e}" 不存在`,ice.UNKNOWN,"请在 Anki 中确认该模型是否存在");const i=await this.invoke("modelFieldNames",{modelName:e});let a=[];try{const t=await this.invoke("modelTemplates",{modelName:e});t&&"object"==typeof t&&(a=Object.entries(t).map(([e,t])=>({Name:e,Front:t.qfmt||t.Front||"",Back:t.afmt||t.Back||""}))),_e.debug(`✓ 成功获取模型 "${e}" 的 ${a.length} 个模板`)}catch(t){_e.warn(`获取模型 "${e}" 的模板列表失败，可能API不支持:`,t)}let r="";try{r=(await this.invoke("modelStyling",{modelName:e})).css||""}catch(t){_e.debug(`获取模型 "${e}" 的样式失败，可能API不支持:`,t)}return{id:n,name:e,fields:i,templates:a,css:r}}catch(t){if(t instanceof rce)throw t;throw new rce(`获取模型 "${e}" 信息失败: ${t.message}`,ice.UNKNOWN)}}async getDeckStats(e){const t=await this.invoke("getDeck",{deck:e});return{id:t.deck_id,name:e,cardCount:t.total_in_deck||0,newCount:t.new_count||0,learnCount:t.learn_count||0,reviewCount:t.review_count||0}}async addNote(e){return await this.invoke("addNote",{note:e})}async updateNoteFields(e,t){await this.invoke("updateNoteFields",{note:{id:e,fields:t}})}async updateNoteTags(e,t){await this.invoke("clearUnusedTags"),await this.invoke("updateNoteTags",{note:e,tags:t.join(" ")})}async getNotesInfo(e){return await this.invoke("notesInfo",{notes:e})}async findNotes(e){return await this.invoke("findNotes",{query:e})}async findNotesByDeck(e){return await this.findNotes(`deck:"${e}"`)}async deleteNotes(e){await this.invoke("deleteNotes",{notes:e})}async storeMediaFile(e,t){await this.invoke("storeMediaFile",{filename:e,data:t})}async retrieveMediaFile(e){return await this.invoke("retrieveMediaFile",{filename:e})}async getMediaFilesNames(e="*"){return await this.invoke("getMediaFilesNames",{pattern:e})}async deleteMediaFile(e){await this.invoke("deleteMediaFile",{filename:e})}async multi(e){return await this.invoke("multi",{actions:e})}async sync(){await this.invoke("sync")}async createDeck(e){return await this.invoke("createDeck",{deck:e})}async changeDeck(e,t){await this.invoke("changeDeck",{cards:e,deck:t})}async getDeckConfig(e){return await this.invoke("getDeckConfig",{deck:e})}setRequestTimeout(e){this.requestTimeout=e}}class cce{constructor(e){oe(this,"metadata"),this.metadata=new Map,e&&Object.entries(e).forEach(([e,t])=>{this.metadata.set(e,t)})}calculateContentHash(e){var t,n,i,a;const r=JSON.stringify({front:(null==(t=e.fields)?void 0:t.front)||(null==(n=e.fields)?void 0:n.question)||"",back:(null==(i=e.fields)?void 0:i.back)||(null==(a=e.fields)?void 0:a.answer)||"",extra:e.extra||"",tags:e.tags||[]});return this.hash(r)}calculateMediaHash(e){var t,n,i,a;const r=[(null==(t=e.fields)?void 0:t.front)||(null==(n=e.fields)?void 0:n.question)||"",(null==(i=e.fields)?void 0:i.back)||(null==(a=e.fields)?void 0:a.answer)||"",e.extra||""].filter(Boolean).flatMap(e=>this.extractMediaReferences(e)).sort().join("|");return r?this.hash(r):void 0}extractMediaReferences(e){const t=[],n=e.match(/!\[.*?\]\((.*?)\)/g)||[];t.push(...n.map(e=>{var t;return(null==(t=e.match(/\((.*?)\)/))?void 0:t[1])||""}));const i=e.match(/!\[\[(.*?)\]\]/g)||[];t.push(...i.map(e=>{var t;return(null==(t=e.match(/\[\[(.*?)\]\]/))?void 0:t[1])||""}));const a=e.match(/<img[^>]+src="([^">]+)"/g)||[];t.push(...a.map(e=>{var t;return(null==(t=e.match(/src="([^">]+)"/))?void 0:t[1])||""}));const r=e.match(/<(audio|video)[^>]+src="([^">]+)"/g)||[];return t.push(...r.map(e=>{var t;return(null==(t=e.match(/src="([^">]+)"/))?void 0:t[1])||""})),t.filter(Boolean)}hash(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(36)}initializeMetadata(e,t,n=!1){const i=(new Date).toISOString(),a=this.calculateContentHash(e),r=this.calculateMediaHash(e),s={cardId:e.id,uuid:e.uuid||this.generateUUID(),lastSyncTime:i,lastModifiedInTuanki:e.lastModified||i,syncVersion:1,contentHash:a,mediaHash:r,ankiNoteId:t,isBidirectional:n};return this.metadata.set(e.id,s),s}updateAfterSync(e,t,n){const i=this.metadata.get(e);if(!i)throw new Error(`卡片 ${e} 的同步元数据不存在`);i.lastSyncTime=(new Date).toISOString(),i.syncVersion+=1,void 0!==t&&(i.ankiNoteId=t),n&&(i.lastModifiedInAnki=n),this.metadata.set(e,i)}detectChanges(e){const t=this.metadata.get(e.id);if(!t)return{cardId:e.id,changeType:"both",hasConflict:!1};const n=this.calculateContentHash(e),i=this.calculateMediaHash(e),a=n!==t.contentHash,r=i!==t.mediaHash;return a||r?{cardId:e.id,changeType:a&&r?"both":a?"content":"media",hasConflict:!1}:null}detectBatchChanges(e){return e.map(e=>this.detectChanges(e)).filter(e=>null!==e)}getCardsToSync(e,t){const n=this.detectBatchChanges(e),i=e.filter(e=>n.some(t=>t.cardId===e.id));return i.sort((e,t)=>{const n=new Date(e.lastModified||0).getTime();return new Date(t.lastModified||0).getTime()-n}),t?i.slice(0,t):i}getMetadata(e){return this.metadata.get(e)}getAllMetadata(){const e={};return this.metadata.forEach((t,n)=>{e[n]=t}),e}removeMetadata(e){this.metadata.delete(e)}clearAllMetadata(){this.metadata.clear()}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}getStatistics(){const e=Array.from(this.metadata.values());return{totalCards:e.length,bidirectionalCards:e.filter(e=>e.isBidirectional).length,withAnkiId:e.filter(e=>void 0!==e.ankiNoteId).length,averageSyncVersion:e.length>0?e.reduce((e,t)=>e+t.syncVersion,0)/e.length:0}}}class dce{constructor(){oe(this,"TUANKI_SIGNATURES",["tuanki-template","tuanki_template","TUANKI","tuanki-exclusive"]),oe(this,"TUANKI_PREFIXES",["Tuanki:","Tuanki-","T:","[Tuanki]"])}identify(e){var t;const n=[];let i=0,a=!1,r=!1;if(e.syncCapability&&e.syncCapability.isTuankiExclusive)return i+=100,a=!0,r=e.syncCapability.supportsBidirectional,n.push("模板已显式标记为 Tuanki 专属"),{isTuankiExclusive:a,supportsBidirectional:r,confidence:i,reason:n};if(e.tuankiMetadata){const t=e.tuankiMetadata;"tuanki_created"===t.source?(i+=80,a=!0,r=!0,n.push("模板在 Tuanki 中创建")):"official"===t.source&&t.createdInTuanki?(i+=90,a=!0,r=!0,n.push("Tuanki 官方模板")):t.editedInTuanki&&t.createdInTuanki?(i+=70,a=!0,r=!0,n.push("模板在 Tuanki 中创建并编辑")):"anki_imported"===t.source&&(i=10,a=!1,r=!1,n.push("模板从 Anki 导入")),t.signature&&this.containsTuankiSignature(t.signature)&&(i+=20,a=!0,n.push("包含 Tuanki 签名"))}const s=this.checkTemplateName(e.name);return s.isTuanki&&(i+=60,a=!0,r=!0,n.push(`模板名称包含 Tuanki 标识: ${s.matchedPattern}`)),e.isOfficial&&(i+=50,a=!0,r=!0,n.push("Tuanki 官方模板")),e.description&&this.containsTuankiSignature(e.description)&&(i+=30,a=!0,n.push("描述中包含 Tuanki 标识")),e.createdAt&&!(null==(t=e.syncCapability)?void 0:t.ankiModelMapping)&&(i+=10,a=!0,n.push("在 Tuanki 中首次创建")),i>=50&&(a=!0,r=!0),0===n.length&&n.push("未找到 Tuanki 专属标识，判定为通用模板"),{isTuankiExclusive:a,supportsBidirectional:r,confidence:i,reason:n}}checkTemplateName(e){for(const t of this.TUANKI_PREFIXES)if(e.startsWith(t))return{isTuanki:!0,matchedPattern:t};for(const t of this.TUANKI_SIGNATURES)if(e.toLowerCase().includes(t.toLowerCase()))return{isTuanki:!0,matchedPattern:t};return{isTuanki:!1}}containsTuankiSignature(e){const t=e.toLowerCase();return this.TUANKI_SIGNATURES.some(e=>t.includes(e.toLowerCase()))}generateTuankiSignature(e,t="1.0"){return`tuanki-template-${e}-v${t}-${Date.now()}`}markAsTuankiExclusive(e,t=!0){const n=(new Date).toISOString();return{...e,syncCapability:{supportsBidirectional:t,isTuankiExclusive:!0,ankiModelMapping:void 0},tuankiMetadata:{signature:this.generateTuankiSignature(e.id,"1.0"),version:"1.0",ankiCompatible:!1,source:e.isOfficial?"official":"tuanki_created",createdInTuanki:!0,editedInTuanki:!1},createdAt:e.createdAt||n,updatedAt:n}}markAsAnkiImported(e,t,n){const i=(new Date).toISOString();return{...e,syncCapability:{supportsBidirectional:!1,isTuankiExclusive:!1,ankiModelMapping:{modelId:t,modelName:n,lastSyncVersion:"1.0"}},tuankiMetadata:{signature:"",version:"1.0",ankiCompatible:!0,source:"anki_imported",createdInTuanki:!1,editedInTuanki:!1},createdAt:e.createdAt||i,updatedAt:i}}identifyBatch(e){const t=new Map;for(const n of e){const e=this.identify(n);t.set(n.id,e)}return t}getStatistics(e){const t=this.identifyBatch(e),n=Array.from(t.values());return{total:e.length,tuankiExclusive:n.filter(e=>e.isTuankiExclusive).length,bidirectional:n.filter(e=>e.supportsBidirectional).length,ankiImported:e.filter(e=>{var t;return"anki_imported"===(null==(t=e.tuankiMetadata)?void 0:t.source)}).length,generic:n.filter(e=>!e.isTuankiExclusive).length}}}class uce{constructor(e,t,n){oe(this,"SUPPORTED_MEDIA_TYPES",["png","jpg","jpeg","gif","svg","webp","bmp","mp3","wav","ogg","m4a","flac","mp4","webm","ogv","mov","avi"]),this.app=e,this.client=t,this.options=n}async syncMediaToAnki(e,t){const n=this.extractMediaReferences(e),i=[];let a=e;for(const s of n)try{const e=await this.syncSingleMedia(s,t);i.push(e),e.isBacklink&&e.backlinkUrl&&(a=this.replaceMediaReference(a,s,e.backlinkUrl))}catch(r){i.push({success:!1,filename:s.filename,size:0,isBacklink:!1,error:r.message})}return{updatedContent:a,results:i}}async syncSingleMedia(e,t){const n=this.resolveFilePath(e.path,t),i=this.app.vault.getAbstractFileByPath(n);if(!(i&&i instanceof ge.TFile))throw new Error(`文件不存在: ${n}`);if(!this.isSupportedMediaType(i.extension))throw new Error(`不支持的媒体类型: ${i.extension}`);const a=i.stat.size;if(a/1048576>this.options.largeFileThresholdMB&&this.options.createBacklinks){const e=this.generateObsidianBacklink(i);return{success:!0,filename:i.name,size:a,isBacklink:!0,backlinkUrl:e}}{const e=await this.app.vault.readBinary(i),t=this.arrayBufferToBase64(e);return await this.client.storeMediaFile(i.name,t),{success:!0,filename:i.name,size:a,isBacklink:!1}}}async downloadMediaFromAnki(e,t){try{const n=await this.client.retrieveMediaFile(e);if(!n)return!1;const i=this.base64ToArrayBuffer(n),a=`${t}/${e}`;return await this.ensureDirectoryExists(t),await this.app.vault.adapter.writeBinary(a,i),!0}catch(n){return _e.error(`下载媒体文件失败: ${e}`,n),!1}}extractMediaReferences(e){const t=[],n=e.matchAll(/!\[([^\]]*)\]\(([^)]+)\)/g);for(const r of n)t.push({type:"markdown",alt:r[1],path:r[2],filename:this.extractFilename(r[2]),fullMatch:r[0]});const i=e.matchAll(/!\[\[([^\]]+)\]\]/g);for(const r of i)t.push({type:"obsidian",path:r[1],filename:this.extractFilename(r[1]),fullMatch:r[0]});const a=e.matchAll(/<img[^>]+src="([^"]+)"[^>]*>/g);for(const r of a)t.push({type:"html",path:r[1],filename:this.extractFilename(r[1]),fullMatch:r[0]});return t}replaceMediaReference(e,t,n){const i=this.createBacklinkHtml(t.filename,n);return e.replace(t.fullMatch,i)}createBacklinkHtml(e,t){return`<a href="${t}" class="obsidian-backlink" style="display: inline-block; padding: 8px 12px; background: #4A5568; color: #E2E8F0; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.2s;">\n  <span style="margin-right: 6px;">📎</span>\n  <span>${e}</span>\n  <span style="margin-left: 6px; font-size: 12px; opacity: 0.7;">(在 Obsidian 中打开)</span>\n</a>`}generateObsidianBacklink(e,t){const n=this.app.vault.getName(),i=encodeURIComponent(e.path);let a=`obsidian://open?vault=${encodeURIComponent(n)}&file=${i}`;return t&&(a+=t),a}async uploadMediaFilesToAnki(e){const t=new Map;_e.debug(`[MediaSyncService] 开始批量上传 ${e.length} 个文件`);for(const a of e)try{const e=await this.app.vault.readBinary(a),n=this.arrayBufferToBase64(e);await this.client.storeMediaFile(a.name,n),t.set(a.name,!0),_e.debug(`[MediaSyncService] ✅ 上传成功: ${a.name}`)}catch(i){_e.error(`[MediaSyncService] ❌ 上传失败: ${a.name}`,i),t.set(a.name,!1)}const n=Array.from(t.values()).filter(e=>e).length;return _e.debug(`[MediaSyncService] 批量上传完成: ${n}/${e.length}`),t}async uploadSingleMediaToAnki(e){try{const t=await this.app.vault.readBinary(e),n=this.arrayBufferToBase64(t);return await this.client.storeMediaFile(e.name,n),_e.debug(`[MediaSyncService] ✅ 上传成功: ${e.name}`),!0}catch(t){return _e.error(`[MediaSyncService] ❌ 上传失败: ${e.name}`,t),!1}}resolveFilePath(e,t){let n=e.replace(/^\[\[|\]\]$/g,"");if(n.includes("|")&&(n=n.split("|")[0]),n.startsWith("/"))return n.slice(1);if(n.startsWith("./")||n.startsWith("../")){const e=t.split("/").slice(0,-1).join("/");return this.resolvePath(e,n)}const i=this.app.metadataCache.getFirstLinkpathDest(n,t);return i?i.path:n}resolvePath(e,t){const n=e.split("/"),i=t.split("/");for(const a of i)"."===a||(".."===a?n.pop():n.push(a));return n.join("/")}extractFilename(e){const t=e.replace(/^\[\[|\]\]$/g,"").split("|")[0];return t.split("/").pop()||t}isSupportedMediaType(e){const t=e.toLowerCase();return this.SUPPORTED_MEDIA_TYPES.includes(t)||this.options.supportedTypes.includes(t)}arrayBufferToBase64(e){const t=new Uint8Array(e);let n="";for(let i=0;i<t.byteLength;i++)n+=String.fromCharCode(t[i]);return btoa(n)}base64ToArrayBuffer(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}async ensureDirectoryExists(e){await this.app.vault.adapter.exists(e)||await this.app.vault.createFolder(e)}updateOptions(e){Object.assign(this.options,e)}}class hce{constructor(e){oe(this,"plugin"),oe(this,"FIELD_TYPE_PATTERNS",{question:["front","question","问题","q","prompt","题目"],answer:["back","answer","答案","a","response","回答"],tags:["tags","标签","tag"],extra:["extra","note","remark","备注","注释","additional"],cloze:["text","content","内容","正文"]}),this.plugin=e}convertModelToTemplate(e){var t;const n=[],i=this.generateTemplateId(e.id),a=this.inferFieldTypes(e.fields),r=this.detectCardType(e.fields,e.templates),s=null==(t=e.templates)?void 0:t[0];s&&(s.Front||s.Back)&&n.push("Anki 模板包含 HTML 格式，可能需要手动调整");return{template:{id:i,name:`[来自Anki] ${e.name}`,description:`从 Anki 导入的模板：${e.name}`,type:"single-field",cardType:r,fields:a,regex:"",scenarios:["newCard","study","edit"],isOfficial:!1,isDefault:!1,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),tuankiMetadata:{signature:"",version:"1.0",ankiCompatible:!0,source:"anki_imported",createdInTuanki:!1,editedInTuanki:!1},syncCapability:{supportsBidirectional:!1,isTuankiExclusive:!1,ankiModelMapping:{modelId:e.id,modelName:e.name,lastSyncVersion:"1.0"}}},warnings:n}}inferFieldTypes(e){const t=[];for(const n of e){const e=n.toLowerCase().trim();let i=null;for(const[t,n]of Object.entries(this.FIELD_TYPE_PATTERNS))if(n.some(t=>e.includes(t))){i=t;break}i||(i="custom"),t.push({name:"custom"===i?n:i,pattern:n,isRegex:!1,required:"question"===i||"answer"===i,description:`Anki 字段: ${n}`})}return t}detectCardType(e,t){var n,i,a,r;const s=e.map(e=>e.toLowerCase());if(s.some(e=>e.includes("text")||e.includes("内容"))&&((null==(i=null==(n=null==t?void 0:t[0])?void 0:n.Front)?void 0:i.includes("{{c"))||(null==(r=null==(a=null==t?void 0:t[0])?void 0:a.Back)?void 0:r.includes("{{c"))))return"cloze-deletion";if(s.some(e=>e.includes("choice")||e.includes("option")||e.includes("选项")))return"multiple-choice";const o=s.some(e=>this.FIELD_TYPE_PATTERNS.question.some(t=>e.includes(t))),l=s.some(e=>this.FIELD_TYPE_PATTERNS.answer.some(t=>e.includes(t)));return o&&l?"basic-qa":"other"}convertHtmlToMarkdown(e){if(!e)return"";let t=e;return t=t.replace(/<br\s*\/?>/gi,"\n"),t=t.replace(/<\/p>/gi,"\n\n"),t=t.replace(/<p[^>]*>/gi,""),t=t.replace(/<b>(.*?)<\/b>/gi,"**$1**"),t=t.replace(/<strong>(.*?)<\/strong>/gi,"**$1**"),t=t.replace(/<i>(.*?)<\/i>/gi,"*$1*"),t=t.replace(/<em>(.*?)<\/em>/gi,"*$1*"),t=t.replace(/<u>(.*?)<\/u>/gi,"==$1=="),t=t.replace(/<code>(.*?)<\/code>/gi,"`$1`"),t=t.replace(/<[^>]+>/g,""),t=t.replace(/\n{3,}/g,"\n\n"),t=t.trim(),t}generateTemplateId(e){return`anki-${e}-${Date.now()}`}convertMultipleModels(e){const t=new Map;for(const i of e)try{const e=this.convertModelToTemplate(i);t.set(i.name,e)}catch(n){_e.error(`转换模板 ${i.name} 失败:`,n)}return t}isTemplateAlreadyImported(e){const t=this.plugin.settings.simplifiedParsing;return!!(null==t?void 0:t.templates)&&t.templates.some(t=>{var n,i;return(null==(i=null==(n=t.syncCapability)?void 0:n.ankiModelMapping)?void 0:i.modelId)===e})}findImportedTemplate(e){const t=this.plugin.settings.simplifiedParsing;return(null==t?void 0:t.templates)&&t.templates.find(t=>{var n,i;return(null==(i=null==(n=t.syncCapability)?void 0:n.ankiModelMapping)?void 0:i.modelId)===e})||null}}const pce=[{id:"tuanki-native-qa",name:"【Tuanki】问答题",displayName:"Tuanki 问答题",cardType:"qa",fields:["front","back","hint","explanation","tuanki_template_id","tuanki_card_id","source","tags"],frontTemplate:'<div class="tuanki-card">\n  <div class="card-content">\n    {{front}}\n  </div>\n  {{#hint}}\n  <div class="hint-section">\n    <div class="hint-label">💡 提示</div>\n    <div class="hint-content">{{hint}}</div>\n  </div>\n  {{/hint}}\n</div>',backTemplate:'<div class="tuanki-card">\n  <div class="card-content question">\n    {{front}}\n  </div>\n  \n  <hr class="divider">\n  \n  <div class="card-content answer">\n    {{back}}\n  </div>\n  \n  {{#explanation}}\n  <div class="explanation-section">\n    <div class="explanation-label">📖 解析</div>\n    <div class="explanation-content">{{explanation}}</div>\n  </div>\n  {{/explanation}}\n  \n  {{#source}}\n  <div class="source-section">\n    {{source}}\n  </div>\n  {{/source}}\n</div>',css:'/* Tuanki 问答题样式 */\n.tuanki-card {\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n  font-size: 18px;\n  line-height: 1.6;\n  color: #2c3e50;\n  padding: 20px;\n}\n\n.card-content {\n  margin-bottom: 16px;\n}\n\n.card-content.question {\n  font-size: 20px;\n  font-weight: 500;\n  color: #34495e;\n}\n\n.card-content.answer {\n  font-size: 18px;\n  color: #2c3e50;\n}\n\n.divider {\n  border: none;\n  border-top: 2px solid #e0e0e0;\n  margin: 20px 0;\n}\n\n.hint-section {\n  background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);\n  padding: 12px 16px;\n  border-radius: 8px;\n  margin-top: 16px;\n  border-left: 4px solid #FBC02D;\n}\n\n.hint-label {\n  font-size: 14px;\n  font-weight: 600;\n  color: #F57F17;\n  margin-bottom: 6px;\n}\n\n.hint-content {\n  font-size: 16px;\n  color: #5D4037;\n}\n\n.explanation-section {\n  background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);\n  padding: 12px 16px;\n  border-radius: 8px;\n  margin-top: 16px;\n  border-left: 4px solid #1976D2;\n}\n\n.explanation-label {\n  font-size: 14px;\n  font-weight: 600;\n  color: #0D47A1;\n  margin-bottom: 6px;\n}\n\n.explanation-content {\n  font-size: 16px;\n  color: #37474F;\n}\n\n.source-section {\n  margin-top: 20px;\n  padding-top: 16px;\n  border-top: 1px solid #e0e0e0;\n}\n\nimg {\n  max-width: 100%;\n  height: auto;\n  border-radius: 4px;\n  margin: 8px 0;\n}\n\ncode {\n  background: #f5f5f5;\n  padding: 2px 6px;\n  border-radius: 3px;\n  font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;\n  font-size: 0.9em;\n}\n\npre {\n  background: #f5f5f5;\n  padding: 12px;\n  border-radius: 6px;\n  overflow-x: auto;\n}\n\npre code {\n  background: transparent;\n  padding: 0;\n}'},{id:"tuanki-native-choice",name:"【Tuanki】选择题",displayName:"Tuanki 选择题",cardType:"choice",fields:["front","options","back","explanation","tuanki_template_id","tuanki_card_id","source","tags"],frontTemplate:'<div class="tuanki-card choice-card">\n  <div class="question-section">\n    {{front}}\n  </div>\n  \n  <div class="options-section">\n    {{options}}\n  </div>\n</div>',backTemplate:'<div class="tuanki-card choice-card">\n  <div class="question-section">\n    {{front}}\n  </div>\n  \n  <div class="options-section">\n    {{options}}\n  </div>\n  \n  <hr class="divider">\n  \n  <div class="answer-section">\n    <div class="answer-label">✓ 答案</div>\n    <div class="answer-content">{{back}}</div>\n  </div>\n  \n  {{#explanation}}\n  <div class="explanation-section">\n    <div class="explanation-label">📖 解析</div>\n    <div class="explanation-content">{{explanation}}</div>\n  </div>\n  {{/explanation}}\n  \n  {{#source}}\n  <div class="source-section">\n    {{source}}\n  </div>\n  {{/source}}\n</div>',css:'/* Tuanki 选择题样式 */\n.tuanki-card {\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n  font-size: 18px;\n  line-height: 1.6;\n  color: #2c3e50;\n  padding: 20px;\n}\n\n.choice-card .question-section {\n  font-size: 19px;\n  font-weight: 500;\n  color: #34495e;\n  margin-bottom: 20px;\n}\n\n.options-section {\n  margin: 16px 0;\n}\n\n.choice-option {\n  background: #f8f9fa;\n  padding: 12px 16px;\n  margin: 8px 0;\n  border-radius: 8px;\n  border-left: 4px solid #dee2e6;\n  transition: all 0.2s ease;\n}\n\n.choice-option:hover {\n  background: #e9ecef;\n  border-left-color: #adb5bd;\n}\n\n.choice-option.correct {\n  background: linear-gradient(135deg, #D4EDDA 0%, #C3E6CB 100%);\n  border-left-color: #28A745;\n}\n\n.choice-option.incorrect {\n  background: linear-gradient(135deg, #F8D7DA 0%, #F5C6CB 100%);\n  border-left-color: #DC3545;\n}\n\n.divider {\n  border: none;\n  border-top: 2px solid #e0e0e0;\n  margin: 20px 0;\n}\n\n.answer-section {\n  background: linear-gradient(135deg, #D4EDDA 0%, #C3E6CB 100%);\n  padding: 12px 16px;\n  border-radius: 8px;\n  margin-top: 16px;\n  border-left: 4px solid #28A745;\n}\n\n.answer-label {\n  font-size: 14px;\n  font-weight: 600;\n  color: #155724;\n  margin-bottom: 6px;\n}\n\n.answer-content {\n  font-size: 17px;\n  color: #1E4620;\n  font-weight: 500;\n}\n\n.explanation-section {\n  background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);\n  padding: 12px 16px;\n  border-radius: 8px;\n  margin-top: 16px;\n  border-left: 4px solid #1976D2;\n}\n\n.explanation-label {\n  font-size: 14px;\n  font-weight: 600;\n  color: #0D47A1;\n  margin-bottom: 6px;\n}\n\n.explanation-content {\n  font-size: 16px;\n  color: #37474F;\n}\n\n.source-section {\n  margin-top: 20px;\n  padding-top: 16px;\n  border-top: 1px solid #e0e0e0;\n}\n\nimg {\n  max-width: 100%;\n  height: auto;\n  border-radius: 4px;\n  margin: 8px 0;\n}'},{id:"tuanki-native-cloze",name:"【Tuanki】填空题",displayName:"Tuanki 填空题",cardType:"cloze",fields:["text","hint","explanation","tuanki_template_id","tuanki_card_id","source","tags"],frontTemplate:'<div class="tuanki-card cloze-card">\n  <div class="cloze-content">\n    {{cloze:text}}\n  </div>\n  \n  {{#hint}}\n  <div class="hint-section">\n    <div class="hint-label">💡 提示</div>\n    <div class="hint-content">{{hint}}</div>\n  </div>\n  {{/hint}}\n</div>',backTemplate:'<div class="tuanki-card cloze-card">\n  <div class="cloze-content">\n    {{cloze:text}}\n  </div>\n  \n  {{#explanation}}\n  <div class="explanation-section">\n    <div class="explanation-label">📖 解析</div>\n    <div class="explanation-content">{{explanation}}</div>\n  </div>\n  {{/explanation}}\n  \n  {{#source}}\n  <div class="source-section">\n    {{source}}\n  </div>\n  {{/source}}\n</div>',css:'/* Tuanki 填空题样式 */\n.tuanki-card {\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n  font-size: 18px;\n  line-height: 1.8;\n  color: #2c3e50;\n  padding: 20px;\n}\n\n.cloze-card .cloze-content {\n  font-size: 19px;\n  color: #34495e;\n  min-height: 60px;\n}\n\n.cloze {\n  background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);\n  color: #F57F17;\n  font-weight: 600;\n  padding: 2px 8px;\n  border-radius: 4px;\n  border-bottom: 2px solid #FBC02D;\n}\n\n.hint-section {\n  background: linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%);\n  padding: 12px 16px;\n  border-radius: 8px;\n  margin-top: 16px;\n  border-left: 4px solid #039BE5;\n}\n\n.hint-label {\n  font-size: 14px;\n  font-weight: 600;\n  color: #01579B;\n  margin-bottom: 6px;\n}\n\n.hint-content {\n  font-size: 16px;\n  color: #263238;\n}\n\n.explanation-section {\n  background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);\n  padding: 12px 16px;\n  border-radius: 8px;\n  margin-top: 16px;\n  border-left: 4px solid #1976D2;\n}\n\n.explanation-label {\n  font-size: 14px;\n  font-weight: 600;\n  color: #0D47A1;\n  margin-bottom: 6px;\n}\n\n.explanation-content {\n  font-size: 16px;\n  color: #37474F;\n}\n\n.source-section {\n  margin-top: 20px;\n  padding-top: 16px;\n  border-top: 1px solid #e0e0e0;\n}\n\nimg {\n  max-width: 100%;\n  height: auto;\n  border-radius: 4px;\n  margin: 8px 0;\n}'}];class gce{constructor(e,t){oe(this,"plugin"),oe(this,"ankiConnect"),oe(this,"DEFAULT_CARD_CSS",'\n/* === 基础样式 === */\n.card {\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n  font-size: 18px;\n  color: #2c3e50;\n  background: #ffffff;\n  padding: 30px 20px;\n  line-height: 1.8;\n  max-width: 700px;\n  margin: 0 auto;\n}\n\n/* === 问题区域 === */\n.question {\n  font-size: 20px;\n  font-weight: 600;\n  color: #1a202c;\n  margin-bottom: 24px;\n  text-align: left;\n  line-height: 1.6;\n}\n\n/* === 答案区域 === */\n.answer {\n  font-size: 17px;\n  color: #374151;\n  text-align: left;\n  margin-top: 20px;\n  padding: 20px;\n  background: #f8fafc;\n  border-radius: 8px;\n  border-left: 4px solid #3b82f6;\n}\n\n/* === 选择题样式 - 现代扁平化田园风 === */\n.options {\n  margin: 24px 0;\n  text-align: left;\n  white-space: pre-line;\n}\n\n/* 普通选项 - 柔和米白色 */\n.option-item {\n  display: block;\n  padding: 16px 20px;\n  margin: 12px 0;\n  background: #fafaf9;\n  border-radius: 12px;\n  font-size: 16px;\n  line-height: 1.7;\n  color: #57534e;\n  transition: all 0.2s ease;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);\n}\n\n/* 正确答案 - 清新绿色田园风 */\n.option-correct {\n  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);\n  color: #14532d;\n  font-weight: 500;\n  box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);\n}\n\n/* ✓ 标记样式 */\n.check-mark {\n  display: inline-block;\n  margin-right: 10px;\n  color: #22c55e;\n  font-weight: 600;\n  font-size: 18px;\n}\n\n/* === 挖空样式 === */\n.cloze {\n  color: #2563eb;\n  font-weight: 600;\n  background: #dbeafe;\n  padding: 2px 6px;\n  border-radius: 4px;\n}\n\n/* === 回链样式 === */\n.obsidian-link {\n  display: inline-block;\n  margin-top: 20px;\n  padding: 8px 16px;\n  font-size: 13px;\n  color: #64748b;\n  background: #f1f5f9;\n  border-radius: 6px;\n  text-decoration: none;\n  transition: all 0.2s;\n  border: 1px solid #e2e8f0;\n}\n\n.obsidian-link:hover {\n  background: #e2e8f0;\n  color: #475569;\n  transform: translateY(-1px);\n}\n\n.obsidian-link::before {\n  content: "📝 ";\n}\n\n/* === 提示和额外信息 === */\n.hint {\n  margin: 16px 0;\n  padding: 12px 16px;\n  background: #fef3c7;\n  border-left: 3px solid #f59e0b;\n  border-radius: 6px;\n  font-size: 15px;\n  color: #92400e;\n}\n\n.hint::before {\n  content: "💡 提示: ";\n  font-weight: 600;\n}\n\n/* === 移除多余分隔线 === */\nhr {\n  display: none;\n}\n\n/* === 夜间模式适配 === */\n.night_mode .card {\n  background: #1e293b;\n  color: #e2e8f0;\n}\n\n.night_mode .question {\n  color: #f1f5f9;\n}\n\n.night_mode .answer {\n  background: #334155;\n  border-left-color: #60a5fa;\n  color: #e2e8f0;\n}\n\n.night_mode .option-item {\n  background: #334155;\n  color: #e2e8f0;\n}\n\n.night_mode .option-item:hover {\n  background: #475569;\n}\n\n.night_mode .option-correct {\n  background: #064e3b;\n  border-color: #10b981;\n}\n'.trim()),this.plugin=e,this.ankiConnect=t}async createNativeModel(e){try{const t=e.name;if(await this.checkModelExists(t))return _e.debug(`原生模板 ${t} 已存在，跳过创建`),{success:!0,modelInfo:await this.ankiConnect.getModelInfo(t)};const n={modelName:t,inOrderFields:e.fields,css:e.css,isCloze:"cloze"===e.cardType,cardTemplates:[{Name:"Card 1",Front:e.frontTemplate,Back:e.backTemplate}]};_e.debug("创建原生 Anki 模板:",n),await this.ankiConnect.invoke("createModel",n);const i=await this.ankiConnect.getModelInfo(t);return _e.debug(`✅ 原生模板创建成功: ${t}`),{success:!0,modelInfo:i}}catch(t){return _e.error("创建原生 Anki 模板失败:",t),{success:!1,error:t.message}}}async checkModelExists(e){try{return(await this.ankiConnect.getModelNames()).includes(e)}catch(t){return _e.error("检查模型是否存在失败:",t),!1}}async ensureNativeModelByCardType(e){const t=function(e){const t=e.toLowerCase();return["basic-qa","qa","basic","basic-reverse"].includes(t)?pce.find(e=>"tuanki-native-qa"===e.id)||null:["single-choice","multiple-choice","choice"].includes(t)?pce.find(e=>"tuanki-native-choice"===e.id)||null:["cloze-deletion","cloze"].includes(t)?pce.find(e=>"tuanki-native-cloze"===e.id)||null:pce.find(e=>"tuanki-native-qa"===e.id)||null}(e);if(!t)throw new Error(`未找到卡片类型 ${e} 对应的原生模板`);try{const e=await this.ankiConnect.getModelInfo(t.name);return _e.debug(`✅ 使用现有原生模板: ${t.name}`),e}catch(i){_e.debug(`📦 创建原生模板: ${t.name}`)}const n=await this.createNativeModel(t);if(!n.success||!n.modelInfo)throw new Error(`创建原生模板失败: ${n.error}`);return n.modelInfo}}const vce={preserveComplexTables:!0,convertSimpleTables:!0,mediaFormat:"wikilink",clozeFormat:"==",preserveStyles:!1,tableComplexityThreshold:{maxColumns:3,maxRows:5,allowMergedCells:!1}};class fce{constructor(e){oe(this,"plugin"),oe(this,"mappings"),oe(this,"ankiNoteIndex"),oe(this,"tuankiCardIndex"),this.plugin=e,this.mappings=new Map,this.ankiNoteIndex=new Map,this.tuankiCardIndex=new Map,this.loadFromStorage()}async recordMapping(e,t,n,i="",a,r){const s=(new Date).toISOString(),o={id:n,tuankiCardId:e,ankiNoteId:t,uuid:n,lastSyncTime:s,lastModifiedInTuanki:s,lastModifiedInAnki:s,syncVersion:1,contentHash:i||"",isBidirectional:!1,ankiModelId:a,ankiModelName:r,syncStatus:"synced"};this.mappings.set(n,o),this.ankiNoteIndex.set(t,n),this.tuankiCardIndex.set(e,n),await this.saveToStorage(),_e.debug(`✓ 记录导入映射: Anki Note ${t} -> Tuanki Card ${e} (UUID: ${n})`)}async updateMapping(e,t){const n=this.mappings.get(e);if(!n)throw new Error(`映射不存在: ${e}`);const i={...n,...t,uuid:e,id:e};this.mappings.set(e,i),await this.saveToStorage(),_e.debug(`✓ 更新映射: ${e}`)}findByAnkiNoteId(e){const t=this.ankiNoteIndex.get(e);if(t)return this.mappings.get(t)}findByTuankiCardId(e){const t=this.tuankiCardIndex.get(e);if(t)return this.mappings.get(t)}findByUUID(e){return this.mappings.get(e)}async removeMapping(e){const t=this.mappings.get(e);t&&(this.mappings.delete(e),this.ankiNoteIndex.delete(t.ankiNoteId),this.tuankiCardIndex.delete(t.tuankiCardId),await this.saveToStorage(),_e.debug(`✓ 删除映射: ${e}`))}getAllMappings(){return Array.from(this.mappings.values())}getMappingsByDeck(e){return this.getAllMappings()}static calculateContentHash(e){return ke.createHash("sha256").update(e).digest("hex")}async cleanup(){const e=this.plugin.dataStorage;if(!e)return 0;let t=0;const n=new Map,i=await e.getAllDecks(),a=new Set;for(const r of i){(await e.getCardsByDeck(r.id)).forEach(e=>a.add(e.id))}for(const[r,s]of this.mappings)a.has(s.tuankiCardId)?n.set(r,s):(t++,_e.debug(`清理无效映射: ${r} (卡片 ${s.tuankiCardId} 不存在)`));return this.mappings=n,this.rebuildIndices(),await this.saveToStorage(),_e.debug(`✓ 清理完成: 移除 ${t} 个无效映射`),t}rebuildIndices(){this.ankiNoteIndex.clear(),this.tuankiCardIndex.clear();for(const e of this.mappings.values())this.ankiNoteIndex.set(e.ankiNoteId,e.uuid),this.tuankiCardIndex.set(e.tuankiCardId,e.uuid)}async saveToStorage(){try{const e=Array.from(this.mappings.values()),t={version:"1.0",lastUpdated:(new Date).toISOString(),mappings:e},n=`${this.plugin.manifest.dir}/importMappings.json`;await this.plugin.app.vault.adapter.write(n,JSON.stringify(t,null,2)),_e.debug(`✓ 导入映射已保存: ${e.length} 条记录`)}catch(e){throw _e.error("❌ 保存导入映射失败:",e),e}}async loadFromStorage(){try{const e=`${this.plugin.manifest.dir}/importMappings.json`;if(!(await this.plugin.app.vault.adapter.exists(e)))return void _e.debug("导入映射文件不存在，创建新映射");const t=await this.plugin.app.vault.adapter.read(e),n=JSON.parse(t);if(n.mappings&&Array.isArray(n.mappings)){for(const e of n.mappings)this.mappings.set(e.uuid,e);this.rebuildIndices(),_e.debug(`✓ 已加载 ${this.mappings.size} 条导入映射`)}}catch(e){_e.error("❌ 加载导入映射失败:",e)}}getStats(){const e=Array.from(this.mappings.values());return{totalMappings:e.length,syncedMappings:e.filter(e=>"synced"===e.syncStatus).length,conflictMappings:e.filter(e=>"conflict"===e.syncStatus).length,bidirectionalMappings:e.filter(e=>e.isBidirectional).length}}}class mce{constructor(e,t,n){oe(this,"cardBuilder"),oe(this,"fieldResolver"),oe(this,"contentConverter"),oe(this,"mappingManager"),oe(this,"client"),oe(this,"plugin"),this.cardBuilder=new Sne,this.fieldResolver=new bne,this.contentConverter=new wne,this.mappingManager=e,this.client=t,this.plugin=n}async adaptAnkiNote(e,t,n,i){try{const a=this.adaptAnkiNoteInfo(e),r=this.adaptAnkiModelInfo(n);a.mid=r.id;const s=this.fieldResolver.resolveSingle(r),o=this.extractMediaFilenames(e.fields),l=await this.downloadMediaFiles(o,n.name),c=this.cardBuilder.build({note:a,model:r,deckId:i,templateId:t.id,fieldSideMap:s,mediaPathMap:l,conversionConfig:vce});if(!c.success||!c.card)throw new Error(`卡片构建失败: ${c.warnings.join(", ")}`);const d=c.card,u=this.mappingManager.findByAnkiNoteId(e.noteId);return d.uuid=(null==u?void 0:u.uuid)||this.generateUUID(),d.source="anki",d.customFields={...d.customFields,importedFrom:"ankiconnect",importedAt:(new Date).toISOString()},d.tags=e.tags||[],d}catch(a){throw _e.error("[AnkiImportAdapter] 转换失败:",a),new Error(`适配Anki Note失败: ${(null==a?void 0:a.message)||String(a)}`)}}adaptAnkiNoteInfo(e){const t=Object.values(e.fields).map(e=>"object"==typeof e&&null!==e&&"value"in e?e.value||"":String(e||""));return{id:e.noteId,guid:"",mid:0,mod:Math.floor(e.mod/1e3),tags:(e.tags||[]).join(" "),flds:t.join(""),sfld:t[0]||""}}adaptAnkiModelInfo(e){return{id:e.id,name:e.name,type:0,flds:e.fields.map((e,t)=>({name:e,ord:t,sticky:!1,rtl:!1,font:"Arial",size:20})),tmpls:(e.templates||[]).map((e,t)=>({name:e.Name,ord:t,qfmt:e.Front||"",afmt:e.Back||"",bqfmt:"",bafmt:""})),css:e.css||""}}extractAnkiOriginalFields(e){const t={};for(const[n,i]of Object.entries(e.fields)){let e;e="object"==typeof i&&null!==i&&"value"in i?i.value||"":String(i||""),e.trim()&&(t[n]=e)}return t}extractTuankiFieldsFromContent(e){const t={},n=e.indexOf("---div---");if(-1===n){const n=this.stripFieldNamePrefix(e.trim());n&&(t.front=n)}else if(0===n){const n=e.substring(9).trim(),i=this.stripFieldNamePrefix(n);i&&(t.front=i)}else{const i=e.substring(0,n).trim(),a=e.substring(n+9).trim(),r=this.stripFieldNamePrefix(i);r&&(t.front=r);const s=this.stripFieldNamePrefix(a);s&&(t.back=s)}return t}stripFieldNamePrefix(e){if(!e||!e.trim())return"";const t=/^\*\*([^*]+)\*\*:\s*/;return e.split(/\n\n+/).map(e=>{const n=e.trim();if(!n)return"";return n.replace(t,"")}).filter(e=>e.length>0).join("\n\n")}generateUUID(){return Vu()}extractMediaFilenames(e){const t=new Set;for(const n of Object.values(e)){const e="object"==typeof n&&null!==n&&"value"in n?n.value:String(n||"");if(!e)continue;const i=e.matchAll(/<img[^>]+src=["']([^"']+)["']/gi);for(const n of i){const e=n[1].trim();!e||e.startsWith("http://")||e.startsWith("https://")||t.add(e)}const a=e.matchAll(/\[sound:([^\]]+)\]/gi);for(const n of a)t.add(n[1].trim());const r=e.matchAll(/<video[^>]+src=["']([^"']+)["']/gi);for(const n of r){const e=n[1].trim();!e||e.startsWith("http://")||e.startsWith("https://")||t.add(e)}}return Array.from(t)}async downloadMediaFiles(e,t){const n=new Map;if(0===e.length)return n;try{const i=ps(),a=`${i}/[AnkiConnect] ${this.sanitizeFilename(t)}`;await this.ensureFolder(a);const r=e.map(async e=>{try{const t=await this.client.retrieveMediaFile(e);if(!t)return;const i=this.base64ToArrayBuffer(t),r=`${a}/${e}`;await this.plugin.app.vault.adapter.writeBinary(r,i),n.set(e,r)}catch(t){_e.error(`媒体文件下载失败: ${e}`,t)}});await Promise.allSettled(r),_e.debug(`媒体下载完成: ${n.size}/${e.length}`)}catch(i){_e.error("媒体处理失败:",i)}return n}async ensureFolder(e){await this.plugin.app.vault.adapter.exists(e)||await this.plugin.app.vault.createFolder(e)}sanitizeFilename(e){return e.replace(/[\\/:*?"<>|]/g,"_")}base64ToArrayBuffer(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}calculateContentHash(e){return fce.calculateContentHash(e)}}class yce{constructor(e){oe(this,"plugin"),this.plugin=e}getDataPath(e){var t;const n=(null==(t=this.plugin.settings)?void 0:t.dataFolder)||"tuanki";return e?`${n}/${e}`:n}getBackupPath(e){const t=".obsidian/plugins/tuanki/backups";return e?`${t}/${e}`:t}getDeviceBackupPath(e){return this.getBackupPath(`devices/${e}`)}getImportBackupPath(){return this.getBackupPath("import")}getScheduledBackupPath(){return this.getBackupPath("scheduled")}getManualBackupPath(){return this.getBackupPath("manual")}getBackupIndexPath(){return this.getBackupPath(".index.json")}getCachePath(e){const t=`${this.plugin.manifest.dir}/cache`;return e?`${t}/${e}`:t}getTempPath(e){const t=`${this.plugin.manifest.dir}/temp`;return e?`${t}/${e}`:t}getLogPath(e){const t=`${this.plugin.manifest.dir}/logs`;return e?`${t}/${e}`:t}getPluginDirPath(){return`${this.plugin.app.vault.configDir}/plugins/${this.plugin.manifest.id}`}isPathSynced(e){const t=this.plugin.app.vault.configDir;return!e.startsWith(".obsidian/")&&!e.startsWith(t)}async ensureFolder(e){var t;try{await this.plugin.app.vault.adapter.exists(e)||(await this.plugin.app.vault.createFolder(e),_e.debug(`✅ 创建目录: ${e}`))}catch(n){if(!(null==(t=n.message)?void 0:t.includes("already exists")))throw _e.error(`❌ 创建目录失败: ${e}`,n),n}}async ensureBackupFolders(){const e=[this.getBackupPath(),this.getBackupPath("devices"),this.getImportBackupPath(),this.getScheduledBackupPath(),this.getManualBackupPath()];for(const t of e)await this.ensureFolder(t)}async ensureCacheFolders(){const e=[this.getCachePath(),this.getCachePath("card-snapshots"),this.getTempPath(),this.getLogPath()];for(const t of e)await this.ensureFolder(t)}async initialize(){_e.debug("📁 初始化存储目录..."),await this.ensureBackupFolders(),await this.ensureCacheFolders(),_e.debug("✅ 存储目录初始化完成")}}function bce(e){let t=e.length;for(;--t>=0;)e[t]=0}const wce=256,kce=286,Sce=30,xce=15,_ce=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Cce=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Ice=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Dce=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Tce=new Array(576);bce(Tce);const Mce=new Array(60);bce(Mce);const Ace=new Array(512);bce(Ace);const Ece=new Array(256);bce(Ece);const zce=new Array(29);bce(zce);const Pce=new Array(Sce);function Rce(e,t,n,i,a){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=a,this.has_stree=e&&e.length}let $ce,Oce,Lce;function Nce(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}bce(Pce);const Fce=e=>e<256?Ace[e]:Ace[256+(e>>>7)],Bce=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},jce=(e,t,n)=>{e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,Bce(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},Uce=(e,t,n)=>{jce(e,n[2*t],n[2*t+1])},Vce=(e,t)=>{let n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1},qce=(e,t,n)=>{const i=new Array(16);let a,r,s=0;for(a=1;a<=xce;a++)s=s+n[a-1]<<1,i[a]=s;for(r=0;r<=t;r++){let t=e[2*r+1];0!==t&&(e[2*r]=Vce(i[t]++,t))}},Hce=e=>{let t;for(t=0;t<kce;t++)e.dyn_ltree[2*t]=0;for(t=0;t<Sce;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},Wce=e=>{e.bi_valid>8?Bce(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},Gce=(e,t,n,i)=>{const a=2*t,r=2*n;return e[a]<e[r]||e[a]===e[r]&&i[t]<=i[n]},Qce=(e,t,n)=>{const i=e.heap[n];let a=n<<1;for(;a<=e.heap_len&&(a<e.heap_len&&Gce(t,e.heap[a+1],e.heap[a],e.depth)&&a++,!Gce(t,i,e.heap[a],e.depth));)e.heap[n]=e.heap[a],n=a,a<<=1;e.heap[n]=i},Kce=(e,t,n)=>{let i,a,r,s,o=0;if(0!==e.sym_next)do{i=255&e.pending_buf[e.sym_buf+o++],i+=(255&e.pending_buf[e.sym_buf+o++])<<8,a=e.pending_buf[e.sym_buf+o++],0===i?Uce(e,a,t):(r=Ece[a],Uce(e,r+wce+1,t),s=_ce[r],0!==s&&(a-=zce[r],jce(e,a,s)),i--,r=Fce(i),Uce(e,r,n),s=Cce[r],0!==s&&(i-=Pce[r],jce(e,i,s)))}while(o<e.sym_next);Uce(e,256,t)},Zce=(e,t)=>{const n=t.dyn_tree,i=t.stat_desc.static_tree,a=t.stat_desc.has_stree,r=t.stat_desc.elems;let s,o,l,c=-1;for(e.heap_len=0,e.heap_max=573,s=0;s<r;s++)0!==n[2*s]?(e.heap[++e.heap_len]=c=s,e.depth[s]=0):n[2*s+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=c<2?++c:0,n[2*l]=1,e.depth[l]=0,e.opt_len--,a&&(e.static_len-=i[2*l+1]);for(t.max_code=c,s=e.heap_len>>1;s>=1;s--)Qce(e,n,s);l=r;do{s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Qce(e,n,1),o=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=o,n[2*l]=n[2*s]+n[2*o],e.depth[l]=(e.depth[s]>=e.depth[o]?e.depth[s]:e.depth[o])+1,n[2*s+1]=n[2*o+1]=l,e.heap[1]=l++,Qce(e,n,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const n=t.dyn_tree,i=t.max_code,a=t.stat_desc.static_tree,r=t.stat_desc.has_stree,s=t.stat_desc.extra_bits,o=t.stat_desc.extra_base,l=t.stat_desc.max_length;let c,d,u,h,p,g,v=0;for(h=0;h<=xce;h++)e.bl_count[h]=0;for(n[2*e.heap[e.heap_max]+1]=0,c=e.heap_max+1;c<573;c++)d=e.heap[c],h=n[2*n[2*d+1]+1]+1,h>l&&(h=l,v++),n[2*d+1]=h,d>i||(e.bl_count[h]++,p=0,d>=o&&(p=s[d-o]),g=n[2*d],e.opt_len+=g*(h+p),r&&(e.static_len+=g*(a[2*d+1]+p)));if(0!==v){do{for(h=l-1;0===e.bl_count[h];)h--;e.bl_count[h]--,e.bl_count[h+1]+=2,e.bl_count[l]--,v-=2}while(v>0);for(h=l;0!==h;h--)for(d=e.bl_count[h];0!==d;)u=e.heap[--c],u>i||(n[2*u+1]!==h&&(e.opt_len+=(h-n[2*u+1])*n[2*u],n[2*u+1]=h),d--)}})(e,t),qce(n,c,e.bl_count)},Yce=(e,t,n)=>{let i,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),t[2*(n+1)+1]=65535,i=0;i<=n;i++)a=s,s=t[2*(i+1)+1],++o<l&&a===s||(o<c?e.bl_tree[2*a]+=o:0!==a?(a!==r&&e.bl_tree[2*a]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,r=a,0===s?(l=138,c=3):a===s?(l=6,c=3):(l=7,c=4))},Xce=(e,t,n)=>{let i,a,r=-1,s=t[1],o=0,l=7,c=4;for(0===s&&(l=138,c=3),i=0;i<=n;i++)if(a=s,s=t[2*(i+1)+1],!(++o<l&&a===s)){if(o<c)do{Uce(e,a,e.bl_tree)}while(0!==--o);else 0!==a?(a!==r&&(Uce(e,a,e.bl_tree),o--),Uce(e,16,e.bl_tree),jce(e,o-3,2)):o<=10?(Uce(e,17,e.bl_tree),jce(e,o-3,3)):(Uce(e,18,e.bl_tree),jce(e,o-11,7));o=0,r=a,0===s?(l=138,c=3):a===s?(l=6,c=3):(l=7,c=4)}};let Jce=!1;const ede=(e,t,n,i)=>{jce(e,0+(i?1:0),3),Wce(e),Bce(e,n),Bce(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n};var tde=e=>{Jce||((()=>{let e,t,n,i,a;const r=new Array(16);for(n=0,i=0;i<28;i++)for(zce[i]=n,e=0;e<1<<_ce[i];e++)Ece[n++]=i;for(Ece[n-1]=i,a=0,i=0;i<16;i++)for(Pce[i]=a,e=0;e<1<<Cce[i];e++)Ace[a++]=i;for(a>>=7;i<Sce;i++)for(Pce[i]=a<<7,e=0;e<1<<Cce[i]-7;e++)Ace[256+a++]=i;for(t=0;t<=xce;t++)r[t]=0;for(e=0;e<=143;)Tce[2*e+1]=8,e++,r[8]++;for(;e<=255;)Tce[2*e+1]=9,e++,r[9]++;for(;e<=279;)Tce[2*e+1]=7,e++,r[7]++;for(;e<=287;)Tce[2*e+1]=8,e++,r[8]++;for(qce(Tce,287,r),e=0;e<Sce;e++)Mce[2*e+1]=5,Mce[2*e]=Vce(e,5);$ce=new Rce(Tce,_ce,257,kce,xce),Oce=new Rce(Mce,Cce,0,Sce,xce),Lce=new Rce(new Array(0),Ice,0,19,7)})(),Jce=!0),e.l_desc=new Nce(e.dyn_ltree,$ce),e.d_desc=new Nce(e.dyn_dtree,Oce),e.bl_desc=new Nce(e.bl_tree,Lce),e.bi_buf=0,e.bi_valid=0,Hce(e)},nde={_tr_init:tde,_tr_stored_block:ede,_tr_flush_block:(e,t,n,i)=>{let a,r,s=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<wce;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),Zce(e,e.l_desc),Zce(e,e.d_desc),s=(e=>{let t;for(Yce(e,e.dyn_ltree,e.l_desc.max_code),Yce(e,e.dyn_dtree,e.d_desc.max_code),Zce(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*Dce[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),a=e.opt_len+3+7>>>3,r=e.static_len+3+7>>>3,r<=a&&(a=r)):a=r=n+5,n+4<=a&&-1!==t?ede(e,t,n,i):4===e.strategy||r===a?(jce(e,2+(i?1:0),3),Kce(e,Tce,Mce)):(jce(e,4+(i?1:0),3),((e,t,n,i)=>{let a;for(jce(e,t-257,5),jce(e,n-1,5),jce(e,i-4,4),a=0;a<i;a++)jce(e,e.bl_tree[2*Dce[a]+1],3);Xce(e,e.dyn_ltree,t-1),Xce(e,e.dyn_dtree,n-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),Kce(e,e.dyn_ltree,e.dyn_dtree)),Hce(e),i&&Wce(e)},_tr_tally:(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(Ece[n]+wce+1)]++,e.dyn_dtree[2*Fce(t)]++),e.sym_next===e.sym_end),_tr_align:e=>{jce(e,2,3),Uce(e,256,Tce),(e=>{16===e.bi_valid?(Bce(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}};var ide=(e,t,n,i)=>{let a=65535&e,r=e>>>16&65535,s=0;for(;0!==n;){s=n>2e3?2e3:n,n-=s;do{a=a+t[i++]|0,r=r+a|0}while(--s);a%=65521,r%=65521}return a|r<<16};const ade=new Uint32Array((()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t})());var rde=(e,t,n,i)=>{const a=ade,r=i+n;e^=-1;for(let s=i;s<r;s++)e=e>>>8^a[255&(e^t[s])];return-1^e},sde={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ode={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:lde,_tr_stored_block:cde,_tr_flush_block:dde,_tr_tally:ude,_tr_align:hde}=nde,{Z_NO_FLUSH:pde,Z_PARTIAL_FLUSH:gde,Z_FULL_FLUSH:vde,Z_FINISH:fde,Z_BLOCK:mde,Z_OK:yde,Z_STREAM_END:bde,Z_STREAM_ERROR:wde,Z_DATA_ERROR:kde,Z_BUF_ERROR:Sde,Z_DEFAULT_COMPRESSION:xde,Z_FILTERED:_de,Z_HUFFMAN_ONLY:Cde,Z_RLE:Ide,Z_FIXED:Dde,Z_DEFAULT_STRATEGY:Tde,Z_UNKNOWN:Mde,Z_DEFLATED:Ade}=ode,Ede=258,zde=262,Pde=42,Rde=113,$de=666,Ode=(e,t)=>(e.msg=sde[t],t),Lde=e=>2*e-(e>4?9:0),Nde=e=>{let t=e.length;for(;--t>=0;)e[t]=0},Fde=e=>{let t,n,i,a=e.w_size;t=e.hash_size,i=t;do{n=e.head[--i],e.head[i]=n>=a?n-a:0}while(--t);t=a,i=t;do{n=e.prev[--i],e.prev[i]=n>=a?n-a:0}while(--t)};let Bde=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask;const jde=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))},Ude=(e,t)=>{dde(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,jde(e.strm)},Vde=(e,t)=>{e.pending_buf[e.pending++]=t},qde=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},Hde=(e,t,n,i)=>{let a=e.avail_in;return a>i&&(a=i),0===a?0:(e.avail_in-=a,t.set(e.input.subarray(e.next_in,e.next_in+a),n),1===e.state.wrap?e.adler=ide(e.adler,t,a,n):2===e.state.wrap&&(e.adler=rde(e.adler,t,a,n)),e.next_in+=a,e.total_in+=a,a)},Wde=(e,t)=>{let n,i,a=e.max_chain_length,r=e.strstart,s=e.prev_length,o=e.nice_match;const l=e.strstart>e.w_size-zde?e.strstart-(e.w_size-zde):0,c=e.window,d=e.w_mask,u=e.prev,h=e.strstart+Ede;let p=c[r+s-1],g=c[r+s];e.prev_length>=e.good_match&&(a>>=2),o>e.lookahead&&(o=e.lookahead);do{if(n=t,c[n+s]===g&&c[n+s-1]===p&&c[n]===c[r]&&c[++n]===c[r+1]){r+=2,n++;do{}while(c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&c[++r]===c[++n]&&r<h);if(i=Ede-(h-r),r=h-Ede,i>s){if(e.match_start=t,s=i,i>=o)break;p=c[r+s-1],g=c[r+s]}}}while((t=u[t&d])>l&&0!==--a);return s<=e.lookahead?s:e.lookahead},Gde=e=>{const t=e.w_size;let n,i,a;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-zde)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),Fde(e),i+=t),0===e.strm.avail_in)break;if(n=Hde(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=n,e.lookahead+e.insert>=3)for(a=e.strstart-e.insert,e.ins_h=e.window[a],e.ins_h=Bde(e,e.ins_h,e.window[a+1]);e.insert&&(e.ins_h=Bde(e,e.ins_h,e.window[a+3-1]),e.prev[a&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=a,a++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<zde&&0!==e.strm.avail_in)},Qde=(e,t)=>{let n,i,a,r=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,s=0,o=e.strm.avail_in;do{if(n=65535,a=e.bi_valid+42>>3,e.strm.avail_out<a)break;if(a=e.strm.avail_out-a,i=e.strstart-e.block_start,n>i+e.strm.avail_in&&(n=i+e.strm.avail_in),n>a&&(n=a),n<r&&(0===n&&t!==fde||t===pde||n!==i+e.strm.avail_in))break;s=t===fde&&n===i+e.strm.avail_in?1:0,cde(e,0,0,s),e.pending_buf[e.pending-4]=n,e.pending_buf[e.pending-3]=n>>8,e.pending_buf[e.pending-2]=~n,e.pending_buf[e.pending-1]=~n>>8,jde(e.strm),i&&(i>n&&(i=n),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,n-=i),n&&(Hde(e.strm,e.strm.output,e.strm.next_out,n),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n)}while(0===s);return o-=e.strm.avail_in,o&&(o>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=o&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-o,e.strm.next_in),e.strstart),e.strstart+=o,e.insert+=o>e.w_size-e.insert?e.w_size-e.insert:o),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),s?4:t!==pde&&t!==fde&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(a=e.window_size-e.strstart,e.strm.avail_in>a&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,a+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),a>e.strm.avail_in&&(a=e.strm.avail_in),a&&(Hde(e.strm,e.window,e.strstart,a),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.high_water<e.strstart&&(e.high_water=e.strstart),a=e.bi_valid+42>>3,a=e.pending_buf_size-a>65535?65535:e.pending_buf_size-a,r=a>e.w_size?e.w_size:a,i=e.strstart-e.block_start,(i>=r||(i||t===fde)&&t!==pde&&0===e.strm.avail_in&&i<=a)&&(n=i>a?a:i,s=t===fde&&0===e.strm.avail_in&&n===i?1:0,cde(e,e.block_start,n,s),e.block_start+=n,jde(e.strm)),s?3:1)},Kde=(e,t)=>{let n,i;for(;;){if(e.lookahead<zde){if(Gde(e),e.lookahead<zde&&t===pde)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=Bde(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-zde&&(e.match_length=Wde(e,n)),e.match_length>=3)if(i=ude(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=Bde(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!==--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Bde(e,e.ins_h,e.window[e.strstart+1]);else i=ude(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(Ude(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===fde?(Ude(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Ude(e,!1),0===e.strm.avail_out)?1:2},Zde=(e,t)=>{let n,i,a;for(;;){if(e.lookahead<zde){if(Gde(e),e.lookahead<zde&&t===pde)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=Bde(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-zde&&(e.match_length=Wde(e,n),e.match_length<=5&&(e.strategy===_de||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){a=e.strstart+e.lookahead-3,i=ude(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=a&&(e.ins_h=Bde(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!==--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(Ude(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(i=ude(e,0,e.window[e.strstart-1]),i&&Ude(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=ude(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===fde?(Ude(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Ude(e,!1),0===e.strm.avail_out)?1:2};function Yde(e,t,n,i,a){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=a}const Xde=[new Yde(0,0,0,0,Qde),new Yde(4,4,8,4,Kde),new Yde(4,5,16,8,Kde),new Yde(4,6,32,32,Kde),new Yde(4,4,16,16,Zde),new Yde(8,16,32,32,Zde),new Yde(8,16,128,128,Zde),new Yde(8,32,128,256,Zde),new Yde(32,128,258,1024,Zde),new Yde(32,258,258,4096,Zde)];function Jde(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Ade,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Nde(this.dyn_ltree),Nde(this.dyn_dtree),Nde(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Nde(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Nde(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const eue=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Pde&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==Rde&&t.status!==$de?1:0},tue=e=>{if(eue(e))return Ode(e,wde);e.total_in=e.total_out=0,e.data_type=Mde;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?Pde:Rde,e.adler=2===t.wrap?0:1,t.last_flush=-2,lde(t),yde},nue=e=>{const t=tue(e);var n;return t===yde&&((n=e.state).window_size=2*n.w_size,Nde(n.head),n.max_lazy_match=Xde[n.level].max_lazy,n.good_match=Xde[n.level].good_length,n.nice_match=Xde[n.level].nice_length,n.max_chain_length=Xde[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0),t},iue=(e,t,n,i,a,r)=>{if(!e)return wde;let s=1;if(t===xde&&(t=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),a<1||a>9||n!==Ade||i<8||i>15||t<0||t>9||r<0||r>Dde||8===i&&1!==s)return Ode(e,wde);8===i&&(i=9);const o=new Jde;return e.state=o,o.strm=e,o.status=Pde,o.wrap=s,o.gzhead=null,o.w_bits=i,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=a+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+3-1)/3),o.window=new Uint8Array(2*o.w_size),o.head=new Uint16Array(o.hash_size),o.prev=new Uint16Array(o.w_size),o.lit_bufsize=1<<a+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new Uint8Array(o.pending_buf_size),o.sym_buf=o.lit_bufsize,o.sym_end=3*(o.lit_bufsize-1),o.level=t,o.strategy=r,o.method=n,nue(e)};var aue={deflateInit:(e,t)=>iue(e,t,Ade,15,8,Tde),deflateInit2:iue,deflateReset:nue,deflateResetKeep:tue,deflateSetHeader:(e,t)=>eue(e)||2!==e.state.wrap?wde:(e.state.gzhead=t,yde),deflate:(e,t)=>{if(eue(e)||t>mde||t<0)return e?Ode(e,wde):wde;const n=e.state;if(!e.output||0!==e.avail_in&&!e.input||n.status===$de&&t!==fde)return Ode(e,0===e.avail_out?Sde:wde);const i=n.last_flush;if(n.last_flush=t,0!==n.pending){if(jde(e),0===e.avail_out)return n.last_flush=-1,yde}else if(0===e.avail_in&&Lde(t)<=Lde(i)&&t!==fde)return Ode(e,Sde);if(n.status===$de&&0!==e.avail_in)return Ode(e,Sde);if(n.status===Pde&&0===n.wrap&&(n.status=Rde),n.status===Pde){let t=Ade+(n.w_bits-8<<4)<<8,i=-1;if(i=n.strategy>=Cde||n.level<2?0:n.level<6?1:6===n.level?2:3,t|=i<<6,0!==n.strstart&&(t|=32),t+=31-t%31,qde(n,t),0!==n.strstart&&(qde(n,e.adler>>>16),qde(n,65535&e.adler)),e.adler=1,n.status=Rde,jde(e),0!==n.pending)return n.last_flush=-1,yde}if(57===n.status)if(e.adler=0,Vde(n,31),Vde(n,139),Vde(n,8),n.gzhead)Vde(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Vde(n,255&n.gzhead.time),Vde(n,n.gzhead.time>>8&255),Vde(n,n.gzhead.time>>16&255),Vde(n,n.gzhead.time>>24&255),Vde(n,9===n.level?2:n.strategy>=Cde||n.level<2?4:0),Vde(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Vde(n,255&n.gzhead.extra.length),Vde(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=rde(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(Vde(n,0),Vde(n,0),Vde(n,0),Vde(n,0),Vde(n,0),Vde(n,9===n.level?2:n.strategy>=Cde||n.level<2?4:0),Vde(n,3),n.status=Rde,jde(e),0!==n.pending)return n.last_flush=-1,yde;if(69===n.status){if(n.gzhead.extra){let t=n.pending,i=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+i>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>t&&(e.adler=rde(e.adler,n.pending_buf,n.pending-t,t)),n.gzindex+=a,jde(e),0!==n.pending)return n.last_flush=-1,yde;t=0,i-=a}let a=new Uint8Array(n.gzhead.extra);n.pending_buf.set(a.subarray(n.gzindex,n.gzindex+i),n.pending),n.pending+=i,n.gzhead.hcrc&&n.pending>t&&(e.adler=rde(e.adler,n.pending_buf,n.pending-t,t)),n.gzindex=0}n.status=73}if(73===n.status){if(n.gzhead.name){let t,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=rde(e.adler,n.pending_buf,n.pending-i,i)),jde(e),0!==n.pending)return n.last_flush=-1,yde;i=0}t=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Vde(n,t)}while(0!==t);n.gzhead.hcrc&&n.pending>i&&(e.adler=rde(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=91}if(91===n.status){if(n.gzhead.comment){let t,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=rde(e.adler,n.pending_buf,n.pending-i,i)),jde(e),0!==n.pending)return n.last_flush=-1,yde;i=0}t=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Vde(n,t)}while(0!==t);n.gzhead.hcrc&&n.pending>i&&(e.adler=rde(e.adler,n.pending_buf,n.pending-i,i))}n.status=103}if(103===n.status){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(jde(e),0!==n.pending))return n.last_flush=-1,yde;Vde(n,255&e.adler),Vde(n,e.adler>>8&255),e.adler=0}if(n.status=Rde,jde(e),0!==n.pending)return n.last_flush=-1,yde}if(0!==e.avail_in||0!==n.lookahead||t!==pde&&n.status!==$de){let i=0===n.level?Qde(n,t):n.strategy===Cde?((e,t)=>{let n;for(;;){if(0===e.lookahead&&(Gde(e),0===e.lookahead)){if(t===pde)return 1;break}if(e.match_length=0,n=ude(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(Ude(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===fde?(Ude(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Ude(e,!1),0===e.strm.avail_out)?1:2})(n,t):n.strategy===Ide?((e,t)=>{let n,i,a,r;const s=e.window;for(;;){if(e.lookahead<=Ede){if(Gde(e),e.lookahead<=Ede&&t===pde)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(a=e.strstart-1,i=s[a],i===s[++a]&&i===s[++a]&&i===s[++a])){r=e.strstart+Ede;do{}while(i===s[++a]&&i===s[++a]&&i===s[++a]&&i===s[++a]&&i===s[++a]&&i===s[++a]&&i===s[++a]&&i===s[++a]&&a<r);e.match_length=Ede-(r-a),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=ude(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=ude(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(Ude(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===fde?(Ude(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(Ude(e,!1),0===e.strm.avail_out)?1:2})(n,t):Xde[n.level].func(n,t);if(3!==i&&4!==i||(n.status=$de),1===i||3===i)return 0===e.avail_out&&(n.last_flush=-1),yde;if(2===i&&(t===gde?hde(n):t!==mde&&(cde(n,0,0,!1),t===vde&&(Nde(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),jde(e),0===e.avail_out))return n.last_flush=-1,yde}return t!==fde?yde:n.wrap<=0?bde:(2===n.wrap?(Vde(n,255&e.adler),Vde(n,e.adler>>8&255),Vde(n,e.adler>>16&255),Vde(n,e.adler>>24&255),Vde(n,255&e.total_in),Vde(n,e.total_in>>8&255),Vde(n,e.total_in>>16&255),Vde(n,e.total_in>>24&255)):(qde(n,e.adler>>>16),qde(n,65535&e.adler)),jde(e),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?yde:bde)},deflateEnd:e=>{if(eue(e))return wde;const t=e.state.status;return e.state=null,t===Rde?Ode(e,kde):yde},deflateSetDictionary:(e,t)=>{let n=t.length;if(eue(e))return wde;const i=e.state,a=i.wrap;if(2===a||1===a&&i.status!==Pde||i.lookahead)return wde;if(1===a&&(e.adler=ide(e.adler,t,n,0)),i.wrap=0,n>=i.w_size){0===a&&(Nde(i.head),i.strstart=0,i.block_start=0,i.insert=0);let e=new Uint8Array(i.w_size);e.set(t.subarray(n-i.w_size,n),0),t=e,n=i.w_size}const r=e.avail_in,s=e.next_in,o=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,Gde(i);i.lookahead>=3;){let e=i.strstart,t=i.lookahead-2;do{i.ins_h=Bde(i,i.ins_h,i.window[e+3-1]),i.prev[e&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=e,e++}while(--t);i.strstart=e,i.lookahead=2,Gde(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=s,e.input=o,e.avail_in=r,i.wrap=a,yde},deflateInfo:"pako deflate (from Nodeca project)"};const rue=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var sue=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(const t in n)rue(n,t)&&(e[t]=n[t])}}return e},oue=e=>{let t=0;for(let i=0,a=e.length;i<a;i++)t+=e[i].length;const n=new Uint8Array(t);for(let i=0,a=0,r=e.length;i<r;i++){let t=e[i];n.set(t,a),a+=t.length}return n};let lue=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(vIe){lue=!1}const cue=new Uint8Array(256);for(let wx=0;wx<256;wx++)cue[wx]=wx>=252?6:wx>=248?5:wx>=240?4:wx>=224?3:wx>=192?2:1;cue[254]=cue[254]=1;var due=e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,n,i,a,r,s=e.length,o=0;for(a=0;a<s;a++)n=e.charCodeAt(a),55296==(64512&n)&&a+1<s&&(i=e.charCodeAt(a+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),a++)),o+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(o),r=0,a=0;r<o;a++)n=e.charCodeAt(a),55296==(64512&n)&&a+1<s&&(i=e.charCodeAt(a+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),a++)),n<128?t[r++]=n:n<2048?(t[r++]=192|n>>>6,t[r++]=128|63&n):n<65536?(t[r++]=224|n>>>12,t[r++]=128|n>>>6&63,t[r++]=128|63&n):(t[r++]=240|n>>>18,t[r++]=128|n>>>12&63,t[r++]=128|n>>>6&63,t[r++]=128|63&n);return t},uue=(e,t)=>{const n=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let i,a;const r=new Array(2*n);for(a=0,i=0;i<n;){let t=e[i++];if(t<128){r[a++]=t;continue}let s=cue[t];if(s>4)r[a++]=65533,i+=s-1;else{for(t&=2===s?31:3===s?15:7;s>1&&i<n;)t=t<<6|63&e[i++],s--;s>1?r[a++]=65533:t<65536?r[a++]=t:(t-=65536,r[a++]=55296|t>>10&1023,r[a++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&lue)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(e[i]);return n})(r,a)},hue=(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let n=t-1;for(;n>=0&&128==(192&e[n]);)n--;return n<0||0===n?t:n+cue[e[n]]>t?n:t};var pue=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const gue=Object.prototype.toString,{Z_NO_FLUSH:vue,Z_SYNC_FLUSH:fue,Z_FULL_FLUSH:mue,Z_FINISH:yue,Z_OK:bue,Z_STREAM_END:wue,Z_DEFAULT_COMPRESSION:kue,Z_DEFAULT_STRATEGY:Sue,Z_DEFLATED:xue}=ode;function _ue(e){this.options=sue({level:kue,method:xue,chunkSize:16384,windowBits:15,memLevel:8,strategy:Sue},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new pue,this.strm.avail_out=0;let n=aue.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==bue)throw new Error(sde[n]);if(t.header&&aue.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?due(t.dictionary):"[object ArrayBuffer]"===gue.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,n=aue.deflateSetDictionary(this.strm,e),n!==bue)throw new Error(sde[n]);this._dict_set=!0}}_ue.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize;let a,r;if(this.ended)return!1;for(r=t===~~t?t:!0===t?yue:vue,"string"==typeof e?n.input=due(e):"[object ArrayBuffer]"===gue.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(r===fue||r===mue)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(a=aue.deflate(n,r),a===wue)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),a=aue.deflateEnd(this.strm),this.onEnd(a),this.ended=!0,a===bue;if(0!==n.avail_out){if(r>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},_ue.prototype.onData=function(e){this.chunks.push(e)},_ue.prototype.onEnd=function(e){e===bue&&(this.result=oue(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Cue={gzip:function(e,t){return(t=t||{}).gzip=!0,function(e,t){const n=new _ue(t);if(n.push(e,!0),n.err)throw n.msg||sde[n.err];return n.result}(e,t)}};const Iue=16209;var Due=function(e,t){let n,i,a,r,s,o,l,c,d,u,h,p,g,v,f,m,y,b,w,k,S,x,_,C;const I=e.state;n=e.next_in,_=e.input,i=n+(e.avail_in-5),a=e.next_out,C=e.output,r=a-(t-e.avail_out),s=a+(e.avail_out-257),o=I.dmax,l=I.wsize,c=I.whave,d=I.wnext,u=I.window,h=I.hold,p=I.bits,g=I.lencode,v=I.distcode,f=(1<<I.lenbits)-1,m=(1<<I.distbits)-1;e:do{p<15&&(h+=_[n++]<<p,p+=8,h+=_[n++]<<p,p+=8),y=g[h&f];t:for(;;){if(b=y>>>24,h>>>=b,p-=b,b=y>>>16&255,0===b)C[a++]=65535&y;else{if(!(16&b)){if(64&b){if(32&b){I.mode=16191;break e}e.msg="invalid literal/length code",I.mode=Iue;break e}y=g[(65535&y)+(h&(1<<b)-1)];continue t}for(w=65535&y,b&=15,b&&(p<b&&(h+=_[n++]<<p,p+=8),w+=h&(1<<b)-1,h>>>=b,p-=b),p<15&&(h+=_[n++]<<p,p+=8,h+=_[n++]<<p,p+=8),y=v[h&m];;){if(b=y>>>24,h>>>=b,p-=b,b=y>>>16&255,16&b){if(k=65535&y,b&=15,p<b&&(h+=_[n++]<<p,p+=8,p<b&&(h+=_[n++]<<p,p+=8)),k+=h&(1<<b)-1,k>o){e.msg="invalid distance too far back",I.mode=Iue;break e}if(h>>>=b,p-=b,b=a-r,k>b){if(b=k-b,b>c&&I.sane){e.msg="invalid distance too far back",I.mode=Iue;break e}if(S=0,x=u,0===d){if(S+=l-b,b<w){w-=b;do{C[a++]=u[S++]}while(--b);S=a-k,x=C}}else if(d<b){if(S+=l+d-b,b-=d,b<w){w-=b;do{C[a++]=u[S++]}while(--b);if(S=0,d<w){b=d,w-=b;do{C[a++]=u[S++]}while(--b);S=a-k,x=C}}}else if(S+=d-b,b<w){w-=b;do{C[a++]=u[S++]}while(--b);S=a-k,x=C}for(;w>2;)C[a++]=x[S++],C[a++]=x[S++],C[a++]=x[S++],w-=3;w&&(C[a++]=x[S++],w>1&&(C[a++]=x[S++]))}else{S=a-k;do{C[a++]=C[S++],C[a++]=C[S++],C[a++]=C[S++],w-=3}while(w>2);w&&(C[a++]=C[S++],w>1&&(C[a++]=C[S++]))}break}if(64&b){e.msg="invalid distance code",I.mode=Iue;break e}y=v[(65535&y)+(h&(1<<b)-1)]}}break}}while(n<i&&a<s);w=p>>3,n-=w,p-=w<<3,h&=(1<<p)-1,e.next_in=n,e.next_out=a,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=a<s?s-a+257:257-(a-s),I.hold=h,I.bits=p};const Tue=15,Mue=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Aue=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Eue=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),zue=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Pue=(e,t,n,i,a,r,s,o)=>{const l=o.bits;let c,d,u,h,p,g,v=0,f=0,m=0,y=0,b=0,w=0,k=0,S=0,x=0,_=0,C=null;const I=new Uint16Array(16),D=new Uint16Array(16);let T,M,A,E=null;for(v=0;v<=Tue;v++)I[v]=0;for(f=0;f<i;f++)I[t[n+f]]++;for(b=l,y=Tue;y>=1&&0===I[y];y--);if(b>y&&(b=y),0===y)return a[r++]=20971520,a[r++]=20971520,o.bits=1,0;for(m=1;m<y&&0===I[m];m++);for(b<m&&(b=m),S=1,v=1;v<=Tue;v++)if(S<<=1,S-=I[v],S<0)return-1;if(S>0&&(0===e||1!==y))return-1;for(D[1]=0,v=1;v<Tue;v++)D[v+1]=D[v]+I[v];for(f=0;f<i;f++)0!==t[n+f]&&(s[D[t[n+f]]++]=f);if(0===e?(C=E=s,g=20):1===e?(C=Mue,E=Aue,g=257):(C=Eue,E=zue,g=0),_=0,f=0,v=m,p=r,w=b,k=0,u=-1,x=1<<b,h=x-1,1===e&&x>852||2===e&&x>592)return 1;for(;;){T=v-k,s[f]+1<g?(M=0,A=s[f]):s[f]>=g?(M=E[s[f]-g],A=C[s[f]-g]):(M=96,A=0),c=1<<v-k,d=1<<w,m=d;do{d-=c,a[p+(_>>k)+d]=T<<24|M<<16|A}while(0!==d);for(c=1<<v-1;_&c;)c>>=1;if(0!==c?(_&=c-1,_+=c):_=0,f++,0===--I[v]){if(v===y)break;v=t[n+s[f]]}if(v>b&&(_&h)!==u){for(0===k&&(k=b),p+=m,w=v-k,S=1<<w;w+k<y&&(S-=I[w+k],!(S<=0));)w++,S<<=1;if(x+=1<<w,1===e&&x>852||2===e&&x>592)return 1;u=_&h,a[u]=b<<24|w<<16|p-r}}return 0!==_&&(a[p+_]=v-k<<24|64<<16),o.bits=b,0};const{Z_FINISH:Rue,Z_BLOCK:$ue,Z_TREES:Oue,Z_OK:Lue,Z_STREAM_END:Nue,Z_NEED_DICT:Fue,Z_STREAM_ERROR:Bue,Z_DATA_ERROR:jue,Z_MEM_ERROR:Uue,Z_BUF_ERROR:Vue,Z_DEFLATED:que}=ode,Hue=16180,Wue=16190,Gue=16191,Que=16192,Kue=16194,Zue=16199,Yue=16200,Xue=16206,Jue=16209,ehe=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function the(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const nhe=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<Hue||t.mode>16211?1:0},ihe=e=>{if(nhe(e))return Bue;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=Hue,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,Lue},ahe=e=>{if(nhe(e))return Bue;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,ihe(e)},rhe=(e,t)=>{let n;if(nhe(e))return Bue;const i=e.state;return t<0?(n=0,t=-t):(n=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Bue:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,ahe(e))},she=(e,t)=>{if(!e)return Bue;const n=new the;e.state=n,n.strm=e,n.window=null,n.mode=Hue;const i=rhe(e,t);return i!==Lue&&(e.state=null),i};let ohe,lhe,che=!0;const dhe=e=>{if(che){ohe=new Int32Array(512),lhe=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Pue(1,e.lens,0,288,ohe,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Pue(2,e.lens,0,32,lhe,0,e.work,{bits:5}),che=!1}e.lencode=ohe,e.lenbits=9,e.distcode=lhe,e.distbits=5},uhe=(e,t,n,i)=>{let a;const r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new Uint8Array(r.wsize)),i>=r.wsize?(r.window.set(t.subarray(n-r.wsize,n),0),r.wnext=0,r.whave=r.wsize):(a=r.wsize-r.wnext,a>i&&(a=i),r.window.set(t.subarray(n-i,n-i+a),r.wnext),(i-=a)?(r.window.set(t.subarray(n-i,n),0),r.wnext=i,r.whave=r.wsize):(r.wnext+=a,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=a))),0};var hhe={inflateReset:ahe,inflateReset2:rhe,inflateResetKeep:ihe,inflateInit:e=>she(e,15),inflateInit2:she,inflate:(e,t)=>{let n,i,a,r,s,o,l,c,d,u,h,p,g,v,f,m,y,b,w,k,S,x,_=0;const C=new Uint8Array(4);let I,D;const T=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(nhe(e)||!e.output||!e.input&&0!==e.avail_in)return Bue;n=e.state,n.mode===Gue&&(n.mode=Que),s=e.next_out,a=e.output,l=e.avail_out,r=e.next_in,i=e.input,o=e.avail_in,c=n.hold,d=n.bits,u=o,h=l,x=Lue;e:for(;;)switch(n.mode){case Hue:if(0===n.wrap){n.mode=Que;break}for(;d<16;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(2&n.wrap&&35615===c){0===n.wbits&&(n.wbits=15),n.check=0,C[0]=255&c,C[1]=c>>>8&255,n.check=rde(n.check,C,2,0),c=0,d=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&c)<<8)+(c>>8))%31){e.msg="incorrect header check",n.mode=Jue;break}if((15&c)!==que){e.msg="unknown compression method",n.mode=Jue;break}if(c>>>=4,d-=4,S=8+(15&c),0===n.wbits&&(n.wbits=S),S>15||S>n.wbits){e.msg="invalid window size",n.mode=Jue;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=512&c?16189:Gue,c=0,d=0;break;case 16181:for(;d<16;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(n.flags=c,(255&n.flags)!==que){e.msg="unknown compression method",n.mode=Jue;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=Jue;break}n.head&&(n.head.text=c>>8&1),512&n.flags&&4&n.wrap&&(C[0]=255&c,C[1]=c>>>8&255,n.check=rde(n.check,C,2,0)),c=0,d=0,n.mode=16182;case 16182:for(;d<32;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}n.head&&(n.head.time=c),512&n.flags&&4&n.wrap&&(C[0]=255&c,C[1]=c>>>8&255,C[2]=c>>>16&255,C[3]=c>>>24&255,n.check=rde(n.check,C,4,0)),c=0,d=0,n.mode=16183;case 16183:for(;d<16;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}n.head&&(n.head.xflags=255&c,n.head.os=c>>8),512&n.flags&&4&n.wrap&&(C[0]=255&c,C[1]=c>>>8&255,n.check=rde(n.check,C,2,0)),c=0,d=0,n.mode=16184;case 16184:if(1024&n.flags){for(;d<16;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}n.length=c,n.head&&(n.head.extra_len=c),512&n.flags&&4&n.wrap&&(C[0]=255&c,C[1]=c>>>8&255,n.check=rde(n.check,C,2,0)),c=0,d=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&n.flags&&(p=n.length,p>o&&(p=o),p&&(n.head&&(S=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(r,r+p),S)),512&n.flags&&4&n.wrap&&(n.check=rde(n.check,i,p,r)),o-=p,r+=p,n.length-=p),n.length))break e;n.length=0,n.mode=16186;case 16186:if(2048&n.flags){if(0===o)break e;p=0;do{S=i[r+p++],n.head&&S&&n.length<65536&&(n.head.name+=String.fromCharCode(S))}while(S&&p<o);if(512&n.flags&&4&n.wrap&&(n.check=rde(n.check,i,p,r)),o-=p,r+=p,S)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&n.flags){if(0===o)break e;p=0;do{S=i[r+p++],n.head&&S&&n.length<65536&&(n.head.comment+=String.fromCharCode(S))}while(S&&p<o);if(512&n.flags&&4&n.wrap&&(n.check=rde(n.check,i,p,r)),o-=p,r+=p,S)break e}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&n.flags){for(;d<16;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(4&n.wrap&&c!==(65535&n.check)){e.msg="header crc mismatch",n.mode=Jue;break}c=0,d=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=Gue;break;case 16189:for(;d<32;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}e.adler=n.check=ehe(c),c=0,d=0,n.mode=Wue;case Wue:if(0===n.havedict)return e.next_out=s,e.avail_out=l,e.next_in=r,e.avail_in=o,n.hold=c,n.bits=d,Fue;e.adler=n.check=1,n.mode=Gue;case Gue:if(t===$ue||t===Oue)break e;case Que:if(n.last){c>>>=7&d,d-=7&d,n.mode=Xue;break}for(;d<3;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}switch(n.last=1&c,c>>>=1,d-=1,3&c){case 0:n.mode=16193;break;case 1:if(dhe(n),n.mode=Zue,t===Oue){c>>>=2,d-=2;break e}break;case 2:n.mode=16196;break;case 3:e.msg="invalid block type",n.mode=Jue}c>>>=2,d-=2;break;case 16193:for(c>>>=7&d,d-=7&d;d<32;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if((65535&c)!=(c>>>16^65535)){e.msg="invalid stored block lengths",n.mode=Jue;break}if(n.length=65535&c,c=0,d=0,n.mode=Kue,t===Oue)break e;case Kue:n.mode=16195;case 16195:if(p=n.length,p){if(p>o&&(p=o),p>l&&(p=l),0===p)break e;a.set(i.subarray(r,r+p),s),o-=p,r+=p,l-=p,s+=p,n.length-=p;break}n.mode=Gue;break;case 16196:for(;d<14;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(n.nlen=257+(31&c),c>>>=5,d-=5,n.ndist=1+(31&c),c>>>=5,d-=5,n.ncode=4+(15&c),c>>>=4,d-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=Jue;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;d<3;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}n.lens[T[n.have++]]=7&c,c>>>=3,d-=3}for(;n.have<19;)n.lens[T[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,I={bits:n.lenbits},x=Pue(0,n.lens,0,19,n.lencode,0,n.work,I),n.lenbits=I.bits,x){e.msg="invalid code lengths set",n.mode=Jue;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;_=n.lencode[c&(1<<n.lenbits)-1],f=_>>>24,m=_>>>16&255,y=65535&_,!(f<=d);){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(y<16)c>>>=f,d-=f,n.lens[n.have++]=y;else{if(16===y){for(D=f+2;d<D;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(c>>>=f,d-=f,0===n.have){e.msg="invalid bit length repeat",n.mode=Jue;break}S=n.lens[n.have-1],p=3+(3&c),c>>>=2,d-=2}else if(17===y){for(D=f+3;d<D;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}c>>>=f,d-=f,S=0,p=3+(7&c),c>>>=3,d-=3}else{for(D=f+7;d<D;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}c>>>=f,d-=f,S=0,p=11+(127&c),c>>>=7,d-=7}if(n.have+p>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=Jue;break}for(;p--;)n.lens[n.have++]=S}}if(n.mode===Jue)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=Jue;break}if(n.lenbits=9,I={bits:n.lenbits},x=Pue(1,n.lens,0,n.nlen,n.lencode,0,n.work,I),n.lenbits=I.bits,x){e.msg="invalid literal/lengths set",n.mode=Jue;break}if(n.distbits=6,n.distcode=n.distdyn,I={bits:n.distbits},x=Pue(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,I),n.distbits=I.bits,x){e.msg="invalid distances set",n.mode=Jue;break}if(n.mode=Zue,t===Oue)break e;case Zue:n.mode=Yue;case Yue:if(o>=6&&l>=258){e.next_out=s,e.avail_out=l,e.next_in=r,e.avail_in=o,n.hold=c,n.bits=d,Due(e,h),s=e.next_out,a=e.output,l=e.avail_out,r=e.next_in,i=e.input,o=e.avail_in,c=n.hold,d=n.bits,n.mode===Gue&&(n.back=-1);break}for(n.back=0;_=n.lencode[c&(1<<n.lenbits)-1],f=_>>>24,m=_>>>16&255,y=65535&_,!(f<=d);){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(m&&!(240&m)){for(b=f,w=m,k=y;_=n.lencode[k+((c&(1<<b+w)-1)>>b)],f=_>>>24,m=_>>>16&255,y=65535&_,!(b+f<=d);){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}c>>>=b,d-=b,n.back+=b}if(c>>>=f,d-=f,n.back+=f,n.length=y,0===m){n.mode=16205;break}if(32&m){n.back=-1,n.mode=Gue;break}if(64&m){e.msg="invalid literal/length code",n.mode=Jue;break}n.extra=15&m,n.mode=16201;case 16201:if(n.extra){for(D=n.extra;d<D;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}n.length+=c&(1<<n.extra)-1,c>>>=n.extra,d-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;_=n.distcode[c&(1<<n.distbits)-1],f=_>>>24,m=_>>>16&255,y=65535&_,!(f<=d);){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(!(240&m)){for(b=f,w=m,k=y;_=n.distcode[k+((c&(1<<b+w)-1)>>b)],f=_>>>24,m=_>>>16&255,y=65535&_,!(b+f<=d);){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}c>>>=b,d-=b,n.back+=b}if(c>>>=f,d-=f,n.back+=f,64&m){e.msg="invalid distance code",n.mode=Jue;break}n.offset=y,n.extra=15&m,n.mode=16203;case 16203:if(n.extra){for(D=n.extra;d<D;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}n.offset+=c&(1<<n.extra)-1,c>>>=n.extra,d-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=Jue;break}n.mode=16204;case 16204:if(0===l)break e;if(p=h-l,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=Jue;break}p>n.wnext?(p-=n.wnext,g=n.wsize-p):g=n.wnext-p,p>n.length&&(p=n.length),v=n.window}else v=a,g=s-n.offset,p=n.length;p>l&&(p=l),l-=p,n.length-=p;do{a[s++]=v[g++]}while(--p);0===n.length&&(n.mode=Yue);break;case 16205:if(0===l)break e;a[s++]=n.length,l--,n.mode=Yue;break;case Xue:if(n.wrap){for(;d<32;){if(0===o)break e;o--,c|=i[r++]<<d,d+=8}if(h-=l,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=n.flags?rde(n.check,a,h,s-h):ide(n.check,a,h,s-h)),h=l,4&n.wrap&&(n.flags?c:ehe(c))!==n.check){e.msg="incorrect data check",n.mode=Jue;break}c=0,d=0}n.mode=16207;case 16207:if(n.wrap&&n.flags){for(;d<32;){if(0===o)break e;o--,c+=i[r++]<<d,d+=8}if(4&n.wrap&&c!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=Jue;break}c=0,d=0}n.mode=16208;case 16208:x=Nue;break e;case Jue:x=jue;break e;case 16210:return Uue;default:return Bue}return e.next_out=s,e.avail_out=l,e.next_in=r,e.avail_in=o,n.hold=c,n.bits=d,(n.wsize||h!==e.avail_out&&n.mode<Jue&&(n.mode<Xue||t!==Rue))&&uhe(e,e.output,e.next_out,h-e.avail_out),u-=e.avail_in,h-=e.avail_out,e.total_in+=u,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=n.flags?rde(n.check,a,h,e.next_out-h):ide(n.check,a,h,e.next_out-h)),e.data_type=n.bits+(n.last?64:0)+(n.mode===Gue?128:0)+(n.mode===Zue||n.mode===Kue?256:0),(0===u&&0===h||t===Rue)&&x===Lue&&(x=Vue),x},inflateEnd:e=>{if(nhe(e))return Bue;let t=e.state;return t.window&&(t.window=null),e.state=null,Lue},inflateGetHeader:(e,t)=>{if(nhe(e))return Bue;const n=e.state;return 2&n.wrap?(n.head=t,t.done=!1,Lue):Bue},inflateSetDictionary:(e,t)=>{const n=t.length;let i,a,r;return nhe(e)?Bue:(i=e.state,0!==i.wrap&&i.mode!==Wue?Bue:i.mode===Wue&&(a=1,a=ide(a,t,n,0),a!==i.check)?jue:(r=uhe(e,t,n,n),r?(i.mode=16210,Uue):(i.havedict=1,Lue)))},inflateInfo:"pako inflate (from Nodeca project)"};var phe=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const ghe=Object.prototype.toString,{Z_NO_FLUSH:vhe,Z_FINISH:fhe,Z_OK:mhe,Z_STREAM_END:yhe,Z_NEED_DICT:bhe,Z_STREAM_ERROR:whe,Z_DATA_ERROR:khe,Z_MEM_ERROR:She}=ode;function xhe(e){this.options=sue({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(15&t.windowBits||(t.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new pue,this.strm.avail_out=0;let n=hhe.inflateInit2(this.strm,t.windowBits);if(n!==mhe)throw new Error(sde[n]);if(this.header=new phe,hhe.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=due(t.dictionary):"[object ArrayBuffer]"===ghe.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=hhe.inflateSetDictionary(this.strm,t.dictionary),n!==mhe)))throw new Error(sde[n])}xhe.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize,a=this.options.dictionary;let r,s,o;if(this.ended)return!1;for(s=t===~~t?t:!0===t?fhe:vhe,"[object ArrayBuffer]"===ghe.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),r=hhe.inflate(n,s),r===bhe&&a&&(r=hhe.inflateSetDictionary(n,a),r===mhe?r=hhe.inflate(n,s):r===khe&&(r=bhe));n.avail_in>0&&r===yhe&&n.state.wrap>0&&0!==e[n.next_in];)hhe.inflateReset(n),r=hhe.inflate(n,s);switch(r){case whe:case khe:case bhe:case She:return this.onEnd(r),this.ended=!0,!1}if(o=n.avail_out,n.next_out&&(0===n.avail_out||r===yhe))if("string"===this.options.to){let e=hue(n.output,n.next_out),t=n.next_out-e,a=uue(n.output,e);n.next_out=t,n.avail_out=i-t,t&&n.output.set(n.output.subarray(e,e+t),0),this.onData(a)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(r!==mhe||0!==o){if(r===yhe)return r=hhe.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,!0;if(0===n.avail_in)break}}return!0},xhe.prototype.onData=function(e){this.chunks.push(e)},xhe.prototype.onEnd=function(e){e===mhe&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=oue(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var _he={ungzip:function(e,t){const n=new xhe(t);if(n.push(e),n.err)throw n.msg||sde[n.err];return n.result}};const{gzip:Che}=Cue,{ungzip:Ihe}=_he;var Dhe=Che,The=Ihe;class Mhe{constructor(){oe(this,"SMALL_DATA_THRESHOLD",1048576),oe(this,"LARGE_DATA_THRESHOLD",10485760)}async createCompressedBackup(e,t){const n=this.calculateSize(e);if(_e.debug(`📦 备份数据大小: ${this.formatSize(n)}`),n<this.SMALL_DATA_THRESHOLD)return _e.debug("  → 策略: 不压缩（小数据）"),{type:CompressionType.NONE,data:JSON.stringify(e,null,2),size:n};if(n<this.LARGE_DATA_THRESHOLD){_e.debug("  → 策略: Gzip 压缩（中等数据）");const t=await this.gzipCompress(e),i=100*(1-t.byteLength/n);return _e.debug(`  ✓ 压缩完成: ${this.formatSize(t.byteLength)} (节省 ${i.toFixed(1)}%)`),{type:CompressionType.GZIP,data:t,size:t.byteLength,originalSize:n,compressionRatio:i}}if(_e.debug("  → 策略: 增量备份 + Gzip 压缩（大数据）"),!t){_e.debug("  ⚠️ 无基础备份，创建完整备份");const t=await this.gzipCompress(e);return{type:CompressionType.GZIP,data:t,size:t.byteLength,originalSize:n,compressionRatio:100*(1-t.byteLength/n)}}const i=await this.createIncrementalBackup(e,t),a=i.size,r=100*(1-a/n);return _e.debug(`  ✓ 增量备份完成: ${this.formatSize(a)} (节省 ${r.toFixed(1)}%)`),{type:CompressionType.GZIP,data:i.data,size:a,originalSize:n,compressionRatio:r}}async gzipCompress(e){const t=JSON.stringify(e),n=(new TextEncoder).encode(t);return Dhe(n)}async gzipDecompress(e){const t=The(e),n=(new TextDecoder).decode(t);return JSON.parse(n)}async createIncrementalBackup(e,t){const n=this.computeDiff([],e.cards),i={type:"incremental",baseBackupId:t,timestamp:Date.now(),changes:{added:n.addedCards,modified:n.modifiedCards,deleted:n.deletedCardIds},cardCount:{total:e.cards.length,changed:n.addedCards.length+n.modifiedCards.length}},a=await this.gzipCompress(i);return{type:"incremental",baseBackupId:t,data:a,size:a.byteLength,metadata:i}}computeDiff(e,t){const n=new Map(e.map(e=>[e.id,e])),i=new Map(t.map(e=>[e.id,e])),a=[],r=[],s=[];for(const[o,l]of i){const e=n.get(o);e?this.hasCardChanged(e,l)&&r.push(l):a.push(l)}for(const[o]of n)i.has(o)||s.push(o);return{addedCards:a,modifiedCards:r,deletedCardIds:s}}hasCardChanged(e,t){if(e.lastModified!==t.lastModified)return!0;return this.hashCard(e)!==this.hashCard(t)}hashCard(e){const t=JSON.stringify({fields:e.fields,tags:e.tags,templateId:e.templateId});return this.hashString(t)}hashString(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t.toString(36)}async restoreIncrementalBackup(e,t){const n=await t(e.baseBackupId),i=e.changes,a=[...n.cards];for(const r of i.deleted){const e=a.findIndex(e=>e.id===r);-1!==e&&a.splice(e,1)}for(const r of i.modified){const e=a.findIndex(e=>e.id===r.id);-1!==e&&(a[e]=r)}return a.push(...i.added),{...n,cards:a}}calculateSize(e){const t=JSON.stringify(e);return(new TextEncoder).encode(t).byteLength}formatSize(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(2)} KB`:e<1073741824?`${(e/1048576).toFixed(2)} MB`:`${(e/1073741824).toFixed(2)} GB`}}class Ahe{constructor(e){oe(this,"plugin"),oe(this,"pathManager"),oe(this,"compression"),this.plugin=e,this.pathManager=new yce(e),this.compression=new Mhe}getDeviceId(){const e=[this.plugin.app.appId,navigator.platform].join("-");return this.hashString(e).substring(0,8)}getDeviceName(){const e=navigator.platform,t=navigator.userAgent;return e.includes("Win")?"Windows PC":e.includes("Mac")?"Mac":e.includes("Linux")?"Linux":t.includes("Android")?"Android":t.includes("iPhone")?"iPhone":t.includes("iPad")?"iPad":"Unknown Device"}async createBackup(e){var t,n,i,a;const r=this.getDeviceId(),s=this.getDeviceName(),o=Date.now(),l=`${e.level}-${r}-${o}`;_e.debug(`📱 创建设备备份: ${s} (${r})`);try{const c={id:l,timestamp:o,level:e.level,trigger:e.trigger,deviceId:r,deviceName:s,obsidianVersion:this.plugin.app.appVersion||"unknown",pluginVersion:this.plugin.manifest.version,vaultName:this.plugin.app.vault.getName(),summary:{deckId:e.targetId,deckName:(null==(n=null==(t=e.data)?void 0:t.info)?void 0:n.deckName)||"Unknown",cardCount:(null==(a=null==(i=e.data)?void 0:i.cards)?void 0:a.length)||0},storagePath:"",size:0,compressed:!1,compressionType:"none",encrypted:!1,type:"full",isHealthy:!0,canDelete:!0,tags:[s,e.level,e.trigger],description:e.reason},d=(e.data,this.convertToRelativePaths(e.data),await this.compression.createCompressedBackup(e.data));let u;switch(c.compressed="none"!==d.type,c.compressionType=d.type,c.size=d.size,c.originalSize=d.originalSize,c.compressionRatio=d.compressionRatio,e.trigger){case"auto_import":u=this.pathManager.getImportBackupPath();break;case"scheduled":u=this.pathManager.getScheduledBackupPath();break;case"manual":u=this.pathManager.getManualBackupPath();break;default:u=this.pathManager.getDeviceBackupPath(r)}await this.pathManager.ensureFolder(u);const h=`${u}/${l}${"gzip"===d.type?".json.gz":".json"}`;return c.storagePath=h,"gzip"===d.type?await this.plugin.app.vault.adapter.writeBinary(h,d.data):await this.plugin.app.vault.adapter.write(h,d.data),_e.debug(`✅ 备份创建成功: ${h}`),_e.debug(`   大小: ${this.compression.formatSize(d.size)}`),d.compressionRatio&&_e.debug(`   节省: ${d.compressionRatio.toFixed(1)}%`),{success:!0,backupId:l,filePath:h,deviceId:r,metadata:c}}catch(c){return _e.error("❌ 创建备份失败:",c),{success:!1,backupId:l,filePath:"",error:c instanceof Error?c.message:String(c)}}}async findDeviceBackups(e){const t=e||this.getDeviceId(),n=this.pathManager.getDeviceBackupPath(t);try{const e=await this.plugin.app.vault.adapter.list(n),t=[];for(const n of e.files)if(n.endsWith(".json")||n.endsWith(".json.gz"))try{const e=await this.loadBackup(n);t.push(e)}catch(i){_e.warn(`⚠️ 加载备份失败: ${n}`,i)}return t.sort((e,t)=>t.metadata.timestamp-e.metadata.timestamp)}catch(a){return[]}}async findAllDeviceBackups(){const e=this.pathManager.getBackupPath("devices"),t=new Map;try{const n=await this.plugin.app.vault.adapter.list(e);for(const e of n.folders){const n=e.split("/").pop();if(!n)continue;const i=await this.findDeviceBackups(n);if(i.length>0){const e=i[0],a=i.reduce((e,t)=>e+(t.metadata.size||0),0);t.set(n,{deviceId:n,deviceName:e.metadata.deviceName,backupCount:i.length,latestBackup:e.metadata.timestamp,totalSize:a,isCurrent:n===this.getDeviceId()})}}}catch(n){_e.error("查找设备备份失败:",n)}return t}async loadBackup(e){if(e.endsWith(".gz")){const t=await this.plugin.app.vault.adapter.readBinary(e);return await this.compression.gzipDecompress(t)}{const t=await this.plugin.app.vault.adapter.read(e);return JSON.parse(t)}}convertToRelativePaths(e){const t=this.plugin.app.vault.getName(),n=e=>{if("string"==typeof e){if(e.includes(t)){const n=e.split(t);if(n.length>1)return`{{vault}}${n[1]}`}return e}if(Array.isArray(e))return e.map(n);if(e&&"object"==typeof e){const t={};for(const[i,a]of Object.entries(e))t[i]=n(a);return t}return e};return n(e)}restoreDevicePaths(e){const t=this.plugin.app.vault.getName(),n=e=>{if("string"==typeof e&&e.includes("{{vault}}"))return e.replace("{{vault}}",t);if(Array.isArray(e))return e.map(n);if(e&&"object"==typeof e){const t={};for(const[i,a]of Object.entries(e))t[i]=n(a);return t}return e};return n(e)}hashString(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(36)}}class Ehe{constructor(e){oe(this,"plugin"),oe(this,"pathManager"),oe(this,"index",new Map),oe(this,"indexLoaded",!1),this.plugin=e,this.pathManager=new yce(e)}async loadIndex(){if(this.indexLoaded)return;const e=this.pathManager.getBackupIndexPath();try{if(!(await this.plugin.app.vault.adapter.exists(e)))return _e.debug("📊 元数据索引不存在，创建新索引"),await this.saveIndex(),void(this.indexLoaded=!0);const t=await this.plugin.app.vault.adapter.read(e),n=JSON.parse(t);for(const[e,i]of Object.entries(n.backups))this.index.set(e,i);_e.debug(`📊 已加载 ${this.index.size} 个备份元数据`),this.indexLoaded=!0}catch(t){_e.error("加载元数据索引失败:",t),this.indexLoaded=!0}}async saveIndex(){const e=this.pathManager.getBackupIndexPath(),t={version:1,lastUpdated:Date.now(),backups:Object.fromEntries(this.index),devices:this.collectDeviceInfo()};try{await this.pathManager.ensureFolder(this.pathManager.getBackupPath()),await this.plugin.app.vault.adapter.write(e,JSON.stringify(t,null,2)),_e.debug(`💾 已保存元数据索引: ${this.index.size} 项`)}catch(n){_e.error("保存元数据索引失败:",n)}}async addOrUpdate(e){await this.loadIndex(),this.index.set(e.id,e),await this.saveIndex()}async get(e){return await this.loadIndex(),this.index.get(e)}async remove(e){await this.loadIndex(),this.index.delete(e),await this.saveIndex()}async listAll(){return await this.loadIndex(),Array.from(this.index.values())}async assessDeletability(e){await this.loadIndex();const t=this.index.get(e);if(!t)return{canDelete:!1,reason:"备份不存在"};const n=Array.from(this.index.values()),i=n.filter(e=>e.deviceId===t.deviceId);if(n.some(t=>t.baseBackupId===e))return{canDelete:!1,reason:"此备份是其他增量备份的基础",dependentBackups:n.filter(t=>t.baseBackupId===e).map(e=>e.id)};const a=Date.now()-t.timestamp;if(a<2592e5)return{canDelete:!0,reason:"最近的备份，建议保留",confidence:"low"};const r=i.filter(e=>e.timestamp>t.timestamp&&e.level===t.level&&e.summary.deckId===t.summary.deckId);if(r.length>=2)return{canDelete:!0,reason:`同设备有 ${r.length} 个更新的备份`,confidence:"high",recommendDelete:!0};if(!t.isHealthy)return{canDelete:!0,reason:"备份数据已损坏或不完整",confidence:"high",recommendDelete:!0};return"auto_import"===t.trigger&&a>2592e6?{canDelete:!0,reason:"自动备份已超过30天",confidence:"medium",recommendDelete:!0}:{canDelete:!0,reason:"可以安全删除",confidence:"medium"}}async recommendCleanup(){await this.loadIndex();const e=Array.from(this.index.values()),t=e.reduce((e,t)=>e+t.size,0),n=[];for(const a of e){const e=await this.assessDeletability(a.id);e.recommendDelete&&n.push({backupId:a.id,metadata:a,assessment:e,potentialSavings:a.size})}n.sort((e,t)=>t.potentialSavings-e.potentialSavings);const i=n.reduce((e,t)=>e+t.potentialSavings,0);return{totalBackups:e.length,totalSize:t,recommendedDeletions:n,potentialSavings:i,savingsPercentage:t>0?i/t*100:0}}collectDeviceInfo(){const e={};for(const t of this.index.values()){const n=t.deviceId;e[n]||(e[n]={deviceId:n,deviceName:t.deviceName,lastSeen:t.timestamp,backupCount:0}),e[n].backupCount++,t.timestamp>e[n].lastSeen&&(e[n].lastSeen=t.timestamp)}return e}async getStats(){await this.loadIndex();const e=Array.from(this.index.values()),t=e.reduce((e,t)=>e+t.size,0),n={},i={};for(const o of e)n[o.level]=(n[o.level]||0)+1,i[o.deviceId]=(i[o.deviceId]||0)+1;const a=e.map(e=>e.timestamp),r=a.length>0?Math.min(...a):0,s=a.length>0?Math.max(...a):0;return{totalBackups:e.length,totalSize:t,byLevel:n,byDevice:i,oldest:r,newest:s}}}class zhe{constructor(e){oe(this,"plugin"),oe(this,"pathManager"),oe(this,"compression"),oe(this,"deviceManager"),oe(this,"metadataManager"),this.plugin=e,this.pathManager=new yce(e),this.compression=new Mhe,this.deviceManager=new Ahe(e),this.metadataManager=new Ehe(e)}async initialize(){_e.debug("🔧 初始化统一备份服务..."),await this.pathManager.initialize(),await this.metadataManager.loadIndex(),_e.debug("✅ 统一备份服务初始化完成")}async createBackup(e){_e.debug("📦 创建备份:",{level:e.level,trigger:e.trigger,targetId:e.targetId,reason:e.reason});try{const t=await this.deviceManager.createBackup(e);return t.success?(t.metadata&&await this.metadataManager.addOrUpdate(t.metadata),await this.autoCleanupIfNeeded(),t):t}catch(t){return _e.error("❌ 创建备份失败:",t),{success:!1,backupId:"",filePath:"",error:t instanceof Error?t.message:String(t)}}}async restoreBackup(e){var t,n;_e.debug("🔄 恢复备份:",e);try{const i=await this.metadataManager.get(e);if(!i)return{success:!1,error:"备份不存在"};_e.debug("📸 恢复前创建安全备份..."),await this.createBackup({level:i.level,trigger:"pre_update",data:{},reason:`恢复前备份: 准备恢复 ${e}`});const a=await this.deviceManager.loadBackup(i.storagePath);this.deviceManager.restoreDevicePaths(a.data);return _e.debug("✅ 备份恢复成功"),{success:!0,restoredItems:(null==(n=null==(t=a.data)?void 0:t.cards)?void 0:n.length)||0}}catch(i){return _e.error("❌ 恢复备份失败:",i),{success:!1,error:i instanceof Error?i.message:String(i)}}}async listBackups(){return await this.metadataManager.listAll()}async getBackup(e){return await this.metadataManager.get(e)}async deleteBackup(e){try{_e.debug("🗑️ 删除备份:",e);const n=await this.metadataManager.get(e);if(!n)return _e.warn("备份不存在:",e),!1;const i=await this.metadataManager.assessDeletability(e);if(!i.canDelete)throw _e.error("无法删除备份:",i.reason),new Error(i.reason);try{await this.plugin.app.vault.adapter.remove(n.storagePath)}catch(t){_e.warn("删除备份文件失败:",t)}return await this.metadataManager.remove(e),_e.debug("✅ 备份已删除"),!0}catch(t){return _e.error("❌ 删除备份失败:",t),!1}}async getCleanupRecommendation(){return await this.metadataManager.recommendCleanup()}async executeCleanup(e){let t=0,n=0,i=0;for(const a of e){const e=await this.metadataManager.get(a);if(e){await this.deleteBackup(a)?(t++,i+=e.size):n++}else n++}return _e.debug("🧹 清理完成:",{"成功":t,"失败":n,"节省空间":this.compression.formatSize(i)}),{success:t,failed:n,totalSaved:i}}async autoCleanupIfNeeded(){try{const e=await this.metadataManager.getStats(),t=50;if(e.totalBackups>t){_e.debug(`⚠️ 备份数量 (${e.totalBackups}) 超过限制 (${t})，执行自动清理...`);const n=(await this.getCleanupRecommendation()).recommendedDeletions.filter(e=>"high"===e.assessment.confidence).slice(0,10).map(e=>e.backupId);n.length>0&&await this.executeCleanup(n)}}catch(e){_e.error("自动清理失败:",e)}}async getStats(){return await this.metadataManager.getStats()}async findAllDeviceBackups(){return await this.deviceManager.findAllDeviceBackups()}getDeviceId(){return this.deviceManager.getDeviceId()}getDeviceName(){return this.deviceManager.getDeviceName()}}class Phe{constructor(e){oe(this,"plugin"),oe(this,"backupService"),this.plugin=e,this.backupService=new zhe(e)}async needsMigration(){const e=this.plugin.settings.ankiConnect;if(!(null==e?void 0:e.backups))return!1;const t=Object.keys(e.backups).length;return 0!==t&&(_e.debug(`📦 检测到 ${t} 个旧备份需要迁移`),!0)}async migrateBackupsFromSettings(){var e;const t=this.plugin.settings.ankiConnect;if(!(null==t?void 0:t.backups)||0===Object.keys(t.backups).length)return{success:!0,migratedCount:0,message:"无需迁移，未找到旧备份数据"};_e.debug("🚀 开始迁移备份数据...");const n=Date.now(),i=[],a=[];await this.backupService.initialize();const r=t.backups,s=Object.keys(r).length;_e.debug(`📊 准备迁移 ${s} 个备份...`);for(const[d,u]of Object.entries(r))try{_e.debug(`  迁移备份 ${i.length+1}/${s}: ${d}`);const t=await this.backupService.createBackup({level:"deck",trigger:"manual",data:u,targetId:null==(e=u.info)?void 0:e.deckId,reason:`从旧版本迁移 (原ID: ${d})`});t.success?(i.push(d),_e.debug(`    ✅ 迁移成功 → ${t.backupId}`)):(a.push(d),_e.error("    ❌ 迁移失败:",t.error))}catch(c){_e.error(`  ❌ 迁移备份 ${d} 失败:`,c),a.push(d)}for(const d of i)delete t.backups[d];0===a.length&&(t.backups=void 0),await this.plugin.saveSettings();const o=Date.now()-n,l=`\n✅ 备份迁移完成\n━━━━━━━━━━━━━━━━━━\n✓ 成功迁移: ${i.length} 个\n${a.length>0?`✗ 失败: ${a.length} 个`:""}\n⏱ 耗时: ${(o/1e3).toFixed(2)} 秒\n━━━━━━━━━━━━━━━━━━\n新备份位置: .obsidian/plugins/tuanki/backups/\n    `.trim();return _e.debug(l),new ge.Notice(0===a.length?`✅ 成功迁移 ${i.length} 个备份到新位置`:`⚠️ 迁移完成：成功 ${i.length}，失败 ${a.length}`,5e3),{success:0===a.length,migratedCount:i.length,failedCount:a.length,message:l}}async autoMigrate(){try{if(!(await this.needsMigration()))return;_e.debug("🔄 检测到旧版本备份，开始自动迁移..."),setTimeout(async()=>{(await this.migrateBackupsFromSettings()).success?_e.debug("✅ 自动迁移成功"):_e.warn("⚠️ 自动迁移部分失败，部分备份可能需要手动处理")},2e3)}catch(e){_e.error("❌ 自动迁移失败:",e)}}}class Rhe{constructor(e){oe(this,"plugin"),oe(this,"maxBackups",3),oe(this,"unifiedService"),oe(this,"migrationService"),oe(this,"initialized",!1),this.plugin=e,this.unifiedService=new zhe(e),this.migrationService=new Phe(e)}async ensureInitialized(){this.initialized||(await this.unifiedService.initialize(),await this.migrationService.autoMigrate(),this.initialized=!0)}async createBackup(e,t,n,i="import"){await this.ensureInitialized();const a={info:{id:"",timestamp:(new Date).toISOString(),deckId:e,deckName:t,cardCount:n.length,reason:i},cards:[...n]},r=await this.unifiedService.createBackup({level:"deck",trigger:"import"===i?"auto_import":"manual",data:a,targetId:e,reason:`${"import"===i?"导入前自动备份":"手动备份"}: ${t}`});if(!r.success)throw new Error(r.error||"创建备份失败");return _e.debug(`✅ 创建备份 ${r.backupId}:`,{deckName:t,cardCount:n.length,reason:i,path:r.filePath}),r.backupId}async restoreBackup(e){await this.ensureInitialized();const t=await this.unifiedService.restoreBackup(e);if(!t.success)throw new Error(t.error||"恢复备份失败");return[]}async listBackups(e){await this.ensureInitialized();let t=await this.unifiedService.listBackups();return e&&(t=t.filter(t=>{var n;return(null==(n=t.summary)?void 0:n.deckId)===e})),t.map(e=>{var t,n,i;return{id:e.id,timestamp:new Date(e.timestamp).toISOString(),deckId:(null==(t=e.summary)?void 0:t.deckId)||"",deckName:(null==(n=e.summary)?void 0:n.deckName)||"Unknown",cardCount:(null==(i=e.summary)?void 0:i.cardCount)||0,reason:"auto_import"===e.trigger?"import":"manual"}}).sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())}async deleteBackup(e){await this.ensureInitialized();if(!(await this.unifiedService.deleteBackup(e)))throw new Error("删除备份失败");_e.debug(`✅ 删除备份 ${e}`)}async getStats(){await this.ensureInitialized();const e=await this.unifiedService.getStats();return{totalBackups:e.totalBackups,totalCards:0,oldestBackup:e.oldest?new Date(e.oldest).toISOString():void 0,newestBackup:e.newest?new Date(e.newest).toISOString():void 0}}async getCleanupRecommendation(){return await this.ensureInitialized(),await this.unifiedService.getCleanupRecommendation()}async executeCleanup(e){return await this.ensureInitialized(),await this.unifiedService.executeCleanup(e)}getUnifiedService(){return this.unifiedService}}class $he{constructor(e,t,n){oe(this,"plugin"),oe(this,"ankiConnect"),oe(this,"templateConverter"),oe(this,"mappingManager"),oe(this,"importAdapter"),oe(this,"backupManager"),this.plugin=e,this.ankiConnect=t,this.templateConverter=n,this.mappingManager=new fce(e),this.importAdapter=new mce(this.mappingManager,this.ankiConnect,this.plugin),this.backupManager=new Rhe(e)}async importDeck(e,t,n){const i=[],a=[],r=[];let s=0,o=null;const l=this.plugin.dataStorage;try{if(null==n||n(0,100,"正在创建备份..."),l)try{const e=(await l.getAllDecks()).find(e=>e.id===t);if(e){const n=await l.getCardsByDeck(t);n&&n.length>0&&(o=await this.backupManager.createBackup(t,e.name,n,"import"),_e.debug(`✓ 已创建导入前备份: ${o}，包含 ${n.length} 张卡片`))}}catch(c){_e.warn("备份失败，但继续导入:",c),i.push({type:"storage",message:`备份失败: ${c.message}`})}null==n||n(5,100,"正在获取 Anki 牌组数据...");const u=await this.ankiConnect.findNotesByDeck(e);if(0===u.length)return{success:!0,importedCards:0,importedTemplates:0,skippedCards:0,errors:[],templates:[],cards:[]};null==n||n(10,100,`找到 ${u.length} 张卡片`);const h=await this.ankiConnect.getNotesInfo(u);null==n||n(20,100,"正在分析模板...");const p=[...new Set(h.map(e=>e.modelName))],g=new Map;for(let e=0;e<p.length;e++){const t=p[e];try{const r=await this.ankiConnect.getModelInfo(t);if(this.templateConverter.isTemplateAlreadyImported(r.id)){const e=this.templateConverter.findImportedTemplate(r.id);if(e){g.set(t,e),_e.debug(`模板 ${t} 已存在，跳过创建`);continue}}const{template:s,warnings:o}=this.templateConverter.convertModelToTemplate(r);await this.saveTemplate(s),g.set(t,s),a.push(s),o.length>0&&i.push({type:"template_conversion",message:`模板 ${t} 转换警告: ${o.join(", ")}`,templateName:t}),null==n||n(20+(e+1)/p.length*20,100,`已转换模板 ${e+1}/${p.length}`)}catch(d){i.push({type:"template_conversion",message:`无法转换模板 ${t}: ${d.message}`,templateName:t})}}null==n||n(40,100,"正在转换卡片...");for(let e=0;e<h.length;e++){const a=h[e];try{const o=g.get(a.modelName);if(!o){s++,i.push({type:"card_conversion",message:`卡片 ${a.noteId} 的模板不可用`,ankiNoteId:a.noteId});continue}const l=await this.ankiConnect.getModelInfo(a.modelName),c=await this.importAdapter.adaptAnkiNote(a,o,l,t);r.push(c),(e+1)%10!=0&&e!==h.length-1||null==n||n(40+(e+1)/h.length*40,100,`已转换 ${e+1}/${h.length} 张卡片`)}catch(d){s++,i.push({type:"card_conversion",message:`转换卡片失败: ${d.message}`,ankiNoteId:a.noteId})}}null==n||n(80,100,"正在保存到 Tuanki..."),r.length>0&&await this.saveCardsToTuanki(r,t),null==n||n(90,100,"正在记录导入映射...");const v={success:!0,timestamp:(new Date).toISOString(),summary:{totalCards:h.length,importedCards:r.length,skippedCards:s,importedTemplates:a.length,errorCount:i.length,backupId:o||void 0},details:{deckName:e,targetDeckId:t,templates:a.map(e=>{var t;return{id:e.id,name:e.name,fields:(null==(t=e.fields)?void 0:t.length)||0}}),errors:i.map(e=>({type:e.type,message:e.message,cardId:e.ankiNoteId||e.templateName}))}};return null==n||n(100,100,"导入完成！"),_e.debug("📊 导入报告:",v),{success:!0,importedCards:r.length,importedTemplates:a.length,skippedCards:s,errors:i,templates:a,cards:r}}catch(d){if(_e.error("❌ 导入牌组失败:",d),null==n||n(0,100,"导入失败，正在回滚..."),o)try{const e=await this.backupManager.restoreBackup(o);l&&(await l.saveDeckCards(t,e),_e.debug(`✓ 已回滚到备份: ${o}，恢复 ${e.length} 张卡片`))}catch(u){_e.error("❌ 回滚失败:",u),i.push({type:"storage",message:`回滚失败: ${u.message}`})}return{success:!1,importedCards:r.length,importedTemplates:a.length,skippedCards:s,errors:[...i,{type:"storage",message:`导入失败: ${d.message}`}],templates:a,cards:r}}}async saveCardsToTuanki(e,t){var n;const i=this.plugin.dataStorage;if(!i)throw new Error("DataStorage 未初始化");try{let a=0;for(const t of e){const e=await i.saveCard(t);e.success&&(a++,_e.debug(`✅ 卡片已保存: ${null==(n=e.data)?void 0:n.uuid}`))}_e.info(`✅ 成功保存 ${a}/${e.length} 张卡片到牌组 ${t}`)}catch(a){throw _e.error("❌ 保存卡片失败:",a),a}}async saveTemplate(e){const t=this.plugin.settings.simplifiedParsing;if(!t)throw new Error("SimplifiedParsing 设置未初始化");const n=t.templates.findIndex(t=>t.id===e.id);n>=0?t.templates[n]=e:t.templates.push(e),await this.plugin.saveSettings()}}class Ohe{constructor(){oe(this,"layers",[])}registerLayer(e){this.layers.push(e),this.layers.sort((e,t)=>t.priority-e.priority)}convert(e,t){let n=e;const i=[],a=[],r={};_e.debug("[ContentFormatConverter] 开始格式转换"),_e.debug("[ContentFormatConverter] 原始内容长度:",e.length);for(const o of this.layers)if(o.enabled)try{const e=n,s=o.convert(n,t);n=s.content,i.push(o.name),r[o.name]={changed:e!==n,changeCount:s.changeCount||0,warnings:s.warnings||[]},s.warnings&&s.warnings.length>0&&a.push(...s.warnings.map(e=>`[${o.name}] ${e}`)),_e.debug(`[ContentFormatConverter] ✓ 应用层: ${o.name}`,{changed:e!==n,changeCount:s.changeCount||0})}catch(s){_e.error(`[ContentFormatConverter] ✗ 转换层失败: ${o.name}`,s),a.push(`转换层 ${o.name} 处理失败: ${s instanceof Error?s.message:"未知错误"}`)}else _e.debug(`[ContentFormatConverter] 跳过禁用的层: ${o.name}`);return _e.debug("[ContentFormatConverter] 转换完成:",{"原始长度":e.length,"转换后长度":n.length,"应用层数":i.length,"警告数":a.length}),{content:n,appliedLayers:i,warnings:a,conversionDetails:r}}getLayers(){return[...this.layers]}enableLayer(e){const t=this.layers.find(t=>t.name===e);t&&(t.enabled=!0)}disableLayer(e){const t=this.layers.find(t=>t.name===e);t&&(t.enabled=!1)}}class Lhe{constructor(){oe(this,"enabled",!0)}createResult(e,t=0,n=[]){return{content:e,changeCount:t,warnings:n}}safeReplace(e,t,n,i="替换操作"){try{let i=0;return{content:e.replace(t,(...e)=>(i++,"function"==typeof n?n(...e):n)),count:i}}catch(a){return _e.error(`[${this.name}] ${i}失败:`,a),{content:e,count:0,error:a instanceof Error?a.message:"未知错误"}}}countMatches(e,t){const n=e.match(t);return n?n.length:0}containsPattern(e,t){return t.test(e)}debug(e,t){_e.debug(`[${this.name}] ${e}`,t||"")}}const Nhe=/\$([^\$\n]+?)\$/g,Fhe=/\$\$\s*\n?([\s\S]+?)\n?\s*\$\$/g,Bhe=/\\\(([^)]+?)\\\)/g,jhe=/\\\[([\s\S]+?)\\\]/g,Uhe=/!\[\[([^\]]+)\]\]/g,Vhe=/^>\s*\[!(\w+)\]([^\n]*)\n((?:>.*(?:\n|$))*)/gm,qhe=/==([^=]+)==/g,Hhe=/~~([^~]+)~~/g,Whe={note:{icon:"📘",color:"#4A9EFF",label:"笔记"},info:{icon:"ℹ️",color:"#4A9EFF",label:"信息"},tip:{icon:"💡",color:"#10B981",label:"提示"},success:{icon:"✅",color:"#10B981",label:"成功"},warning:{icon:"⚠️",color:"#F59E0B",label:"警告"},danger:{icon:"❌",color:"#EF4444",label:"危险"},error:{icon:"❗",color:"#EF4444",label:"错误"},question:{icon:"❓",color:"#8B5CF6",label:"问题"},quote:{icon:"💬",color:"#6B7280",label:"引用"},abstract:{icon:"📋",color:"#06B6D4",label:"摘要"},summary:{icon:"📝",color:"#06B6D4",label:"总结"}};class Ghe{static escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}static escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,e=>t[e])}static trimLines(e){return e.split("\n").map(e=>e.trim()).join("\n")}static isBlank(e){return!e||/^\s*$/.test(e)}}class Qhe{static isInCodeBlock(e,t){return(e.substring(0,t).match(/```/g)||[]).length%2==1}static isInInlineCode(e,t){const n=e.substring(0,t),i=n.lastIndexOf("\n");return(n.substring(i+1).match(/`/g)||[]).length%2==1}static shouldSkipMatch(e,t){return this.isInCodeBlock(e,t)||this.isInInlineCode(e,t)}static isCurrencyAmount(e,t){if(/\$\s*(\d+(?:\.\d{1,2})?)/.test(e)){const n=t.substring(t.indexOf(e)+e.length);if(/^[\s,，。.)]|$/.test(n))return!0}return!1}}class Khe{static createObsidianUrl(e,t,n){let i=`obsidian://open?vault=${encodeURIComponent(e)}&file=${encodeURIComponent(t)}`;if(n){i+=`#${encodeURIComponent(n)}`}return i}static parseWikiLink(e){let t,n,i,a=e.replace(/^\[\[|\]\]$/g,"");if(a.includes("|")){const e=a.split("|");a=e[0],t=e[1]}if(a.includes("#")){const e=a.split("#");n=e[0],i=e[1]}else n=a;return{path:n,heading:i,text:t}}}class Zhe{static createLink(e,t,n){return`<a href="${e}"${n?` style="${Object.entries(n).map(([e,t])=>`${e}:${t}`).join(";")}"`:""}>${t}</a>`}static createDiv(e,t,n){return`<div${t?` class="${t}"`:""}${n?` style="${Object.entries(n).map(([e,t])=>`${e}:${t}`).join(";")}"`:""}>${e}</div>`}static createInlineStyles(e){return Object.entries(e).map(([e,t])=>`${e}:${t}`).join(";")}}class Yhe extends Lhe{constructor(){super(...arguments),oe(this,"name","MathFormulaLayer"),oe(this,"priority",100),oe(this,"description","数学公式格式转换（$ → \\( 和 $$ → \\[）")}convert(e,t){const n=t.options.mathConversion;if(!n.enabled||"keep-dollar"===n.targetFormat)return this.debug("公式转换已禁用或设置为保持原格式"),this.createResult(e,0);this.debug("开始公式转换",{targetFormat:n.targetFormat,detectCurrency:n.detectCurrencySymbol});const i=[];let a=e,r=0;const s=this.convertBlockMath(a,n.detectCurrencySymbol);a=s.content,r+=s.count,i.push(...s.warnings),this.debug("块级公式转换完成",{changeCount:s.count});const o=this.convertInlineMath(a,n.detectCurrencySymbol);return a=o.content,r+=o.count,i.push(...o.warnings),this.debug("行内公式转换完成",{changeCount:o.count}),this.debug("公式转换总结",{totalChanges:r,warningCount:i.length}),this.createResult(a,r,i)}convertBlockMath(e,t){let n=0;return{content:e.replace(Fhe,(t,i,a)=>{if(Qhe.shouldSkipMatch(e,a))return this.debug("跳过代码块中的匹配",{match:t.substring(0,30)}),t;if(this.isAlreadyLatexFormat(i))return this.debug("已经是 LaTeX 格式，跳过",{formula:i.substring(0,30)}),t;n++;return`\\[\n${i.trim()}\n\\]`}),count:n,warnings:[]}}convertInlineMath(e,t){const n=[];let i=0;return{content:e.replace(Nhe,(a,r,s)=>Qhe.shouldSkipMatch(e,s)?(this.debug("跳过代码块/行内代码中的匹配",{match:a}),a):this.isAlreadyLatexFormat(r)?(this.debug("已经是 LaTeX 格式，跳过",{formula:r}),a):t&&this.isCurrencySymbol(a,e,s)?(this.debug("检测到货币符号，跳过转换",{match:a}),n.push(`跳过货币符号: ${a}`),a):(i++,`\\(${r}\\)`)),count:i,warnings:n}}isAlreadyLatexFormat(e){return/\\[\(\[]/.test(e)}isCurrencySymbol(e,t,n){const i=e+t.substring(n+e.length,n+e.length+20);return Qhe.isCurrencyAmount(e,i)}countFormulas(e){return{blockMath:this.countMatches(e,Fhe),inlineMath:this.countMatches(e,Nhe),latexBlock:this.countMatches(e,jhe),latexInline:this.countMatches(e,Bhe)}}}class Xhe extends Lhe{constructor(){super(...arguments),oe(this,"name","WikiLinkLayer"),oe(this,"priority",80),oe(this,"description","Wikilink 双链转换（[[link]] → 链接或文本）")}convert(e,t){const n=t.options.wikiLinkConversion;if(!n.enabled)return this.debug("Wikilink 转换已禁用"),this.createResult(e,0);this.debug("开始 Wikilink 转换",{mode:n.mode});const i=[];let a=e,r=0;if(a=this.excludeMediaEmbeds(a),"text-only"===n.mode){const e=this.convertToText(a);a=e.content,r=e.count}else{const e=this.convertToObsidianLink(a,t.vaultName);a=e.content,r=e.count,i.push(...e.warnings)}return this.debug("Wikilink 转换完成",{changeCount:r}),this.createResult(a,r,i)}excludeMediaEmbeds(e){const t=[],n="___MEDIA_EMBED___",i=e.replace(Uhe,e=>(t.push(e),`${n}${t.length-1}${n}`));return this._mediaEmbeds=t,i}restoreMediaEmbeds(e){const t=this._mediaEmbeds||[],n="___MEDIA_EMBED___";return e.replace(new RegExp(`${n}(\\d+)${n}`,"g"),(e,n)=>t[parseInt(n)]||"")}convertToText(e){let t=0;const n=e.replace(/\[\[([^\]]+)\]\]/g,(n,i,a)=>{if(Qhe.shouldSkipMatch(e,a))return n;t++;const r=Khe.parseWikiLink(n);return r.text||r.path});return{content:this.restoreMediaEmbeds(n),count:t}}convertToObsidianLink(e,t){let n=0;const i=[],a=e.replace(/\[\[([^\]]+)\]\]/g,(a,r,s)=>{if(Qhe.shouldSkipMatch(e,s))return a;try{n++;const e=Khe.parseWikiLink(a),i=Khe.createObsidianUrl(t,e.path,e.heading),r=e.text||(e.heading?`${e.path}#${e.heading}`:e.path);return Zhe.createLink(i,r,{color:"#667eea","text-decoration":"none"})}catch(o){return i.push(`无法转换双链: ${a}`),a}});return{content:this.restoreMediaEmbeds(a),count:n,warnings:i}}countWikilinks(e){const t=e.match(/\[\[([^\]]+)\]\]/g)||[],n=t.filter(e=>e.includes("|")),i=t.filter(e=>e.includes("#")&&!e.includes("|"));return{total:t.length,withText:n.length,withHeading:i.length}}}class Jhe extends Lhe{constructor(){super(...arguments),oe(this,"name","CalloutLayer"),oe(this,"priority",70),oe(this,"description","Callout 标注框转换（> [!type] → styled div）")}convert(e,t){if(!t.options.calloutConversion.enabled)return this.debug("Callout 转换已禁用"),this.createResult(e,0);this.debug("开始 Callout 转换");const n=[];let i=e,a=0;const r=this.convertCallouts(i);return i=r.content,a=r.count,n.push(...r.warnings),this.debug("Callout 转换完成",{changeCount:a}),this.createResult(i,a,n)}convertCallouts(e){let t=0;const n=[];return{content:e.replace(Vhe,(e,i,a,r)=>{try{t++;const e=Whe[i.toLowerCase()]||{icon:"📝",color:"#6B7280",label:i},n=a.trim()||e.label,s=this.parseCalloutContent(r);return this.generateCalloutHtml(i,e,n,s)}catch(s){return n.push(`转换 Callout 失败: ${i}`),e}}),count:t,warnings:n}}parseCalloutContent(e){return e.split("\n").map(e=>e.replace(/^>\s?/,"")).filter(e=>!Ghe.isBlank(e)).join("<br>")}generateCalloutHtml(e,t,n,i){const a={padding:"12px 16px",margin:"8px 0","border-left":`4px solid ${t.color}`,background:this.hexToRgba(t.color,.1),"border-radius":"4px"},r={"font-weight":"600","margin-bottom":"4px",color:t.color},s=Zhe.createDiv(`${t.icon} ${Ghe.escapeHtml(n)}`,"callout-title",r),o=Zhe.createDiv(i,"callout-content");return Zhe.createDiv(s+o,`obsidian-callout callout-${e.toLowerCase()}`,a)}hexToRgba(e,t){e=e.replace(/^#/,"");return`rgba(${parseInt(e.substring(0,2),16)}, ${parseInt(e.substring(2,4),16)}, ${parseInt(e.substring(4,6),16)}, ${t})`}countCallouts(e){const t=e.matchAll(Vhe),n={};let i=0;for(const a of t){i++;const e=a[1].toLowerCase();n[e]=(n[e]||0)+1}return{total:i,byType:n}}}class epe extends Lhe{constructor(){super(...arguments),oe(this,"name","HighlightLayer"),oe(this,"priority",60),oe(this,"description","高亮和样式转换（==highlight== 和 ~~strikethrough~~）")}convert(e,t){if(!t.options.highlightConversion.enabled)return this.debug("高亮转换已禁用"),this.createResult(e,0);this.debug("开始高亮和样式转换");let n=e,i=0;const a=this.convertHighlight(n);n=a.content,i+=a.count,this.debug("高亮转换完成",{changeCount:a.count});const r=this.convertStrikethrough(n);return n=r.content,i+=r.count,this.debug("删除线转换完成",{changeCount:r.count}),this.debug("高亮和样式转换总结",{totalChanges:i}),this.createResult(n,i,[])}convertHighlight(e){let t=0;return{content:e.replace(qhe,(n,i,a)=>Qhe.shouldSkipMatch(e,a)?n:(t++,`<mark style="background-color:#FEF08A;padding:2px 4px;border-radius:2px;">${Ghe.escapeHtml(i)}</mark>`)),count:t}}convertStrikethrough(e){let t=0;return{content:e.replace(Hhe,(n,i,a)=>Qhe.shouldSkipMatch(e,a)?n:(t++,`<del>${Ghe.escapeHtml(i)}</del>`)),count:t}}}class tpe{constructor(){oe(this,"name","MarkdownLayer"),oe(this,"description","基础 Markdown 格式转换为 HTML"),oe(this,"priority",50),oe(this,"enabled",!0)}convert(e,t){let n=e,i=0;const a=[];try{n=n.replace(/^(#{1,6})\s+(.+)$/gm,(e,t,n)=>{const a=t.length;return i++,`<h${a}>${n.trim()}</h${a}>`}),n=n.replace(/\*\*(.+?)\*\*/g,(e,t)=>(i++,`<strong>${t}</strong>`)),n=n.replace(/__(.+?)__/g,(e,t)=>(i++,`<strong>${t}</strong>`)),n=n.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g,(e,t)=>(i++,`<em>${t}</em>`)),n=n.replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g,(e,t)=>(i++,`<em>${t}</em>`)),n=n.replace(/`([^`]+?)`/g,(e,t)=>(i++,`<code>${t}</code>`)),n=n.replace(/~~(.+?)~~/g,(e,t)=>(i++,`<del>${t}</del>`)),n=n.replace(/([^\n])\n(?!\n)/g,"$1<br>\n");const e=(n.match(/<br>/g)||[]).length;e>0&&(i+=e);const t=n.split(/\n\n+/);t.length>1&&(n=t.map(e=>e.trim()).filter(e=>e.length>0).map(e=>e.startsWith("<h")?e:`<p>${e}</p>`).join("\n"),i++),_e.debug(`[MarkdownLayer] 转换完成: ${i} 处修改`)}catch(r){_e.error("[MarkdownLayer] 转换失败:",r),a.push(`Markdown 转换失败: ${r instanceof Error?r.message:"未知错误"}`)}return{content:n,changeCount:i,warnings:a}}}class npe{constructor(e,t){oe(this,"IMAGE_EXTENSIONS",["png","jpg","jpeg","gif","svg","webp","bmp"]),oe(this,"AUDIO_EXTENSIONS",["mp3","wav","ogg","m4a","flac","aac"]),oe(this,"VIDEO_EXTENSIONS",["mp4","webm","ogv","mov","avi","mkv"]),oe(this,"formatConverter"),this.app=e,this.ankiConnect=t,this.formatConverter=new Ohe,this.formatConverter.registerLayer(new Yhe),this.formatConverter.registerLayer(new Xhe),this.formatConverter.registerLayer(new Jhe),this.formatConverter.registerLayer(new epe),this.formatConverter.registerLayer(new tpe)}async convertContent(e,t,n){var i;_e.debug("[ObsidianToAnkiConverter] 开始转换内容");const a={convertedContent:e,mediaFiles:[],backlinks:[],warnings:[]},r=this.extractMediaReferences(e);_e.debug(`[ObsidianToAnkiConverter] 提取到 ${r.length} 个媒体引用`);for(const o of r){const e=await this.processMediaReference(o,t.sourceFile||"");a.mediaFiles.push(e);if(e.fileExists||this.isNetworkUrl(o.path)){_e.debug("[ObsidianToAnkiConverter] 替换媒体引用:",{"原始":o.fullMatch.substring(0,80),"转换":e.ankiFormat.substring(0,80),"文件名":e.filename,"类型":e.fileExists?"本地文件":"网络URL"});const t=a.convertedContent;a.convertedContent=a.convertedContent.replace(o.fullMatch,e.ankiFormat),t===a.convertedContent?_e.warn("[ObsidianToAnkiConverter] ⚠️ 替换失败！未找到匹配项:",o.fullMatch.substring(0,100)):_e.debug("[ObsidianToAnkiConverter] ✅ 替换成功")}else a.warnings.push(`媒体文件不存在: ${e.filename}`)}if(null==(i=n.formatConversion)?void 0:i.enabled)try{const e={vaultName:n.vaultName,sourceFile:t.sourceFile,options:n.formatConversion},i=this.formatConverter.convert(a.convertedContent,e);a.convertedContent=i.content,a.warnings.push(...i.warnings),_e.debug("[ObsidianToAnkiConverter] 格式转换完成:",{"应用层":i.appliedLayers.join(", "),"警告数":i.warnings.length})}catch(s){_e.error("[ObsidianToAnkiConverter] 格式转换失败:",s),a.warnings.push(`格式转换失败: ${s instanceof Error?s.message:"未知错误"}`)}if(n.uploadMedia&&await this.uploadMediaFiles(a.mediaFiles),n.generateBacklinks){const e=this.generateBacklinks(t,n.vaultName);if(a.backlinks=e,"append"===n.backlinkPosition&&e.length>0){const t=e.map(e=>e.html).join("\n");a.convertedContent+=`\n\n${t}`}}return _e.debug("[ObsidianToAnkiConverter] 转换完成:",{"媒体文件":a.mediaFiles.length,"回链":a.backlinks.length,"警告":a.warnings.length}),a}extractMediaReferences(e){const t=[],n=e.matchAll(/!\[\[((?:(?!\]\]).)+)\]\]/g);for(const a of n)t.push({type:"obsidian",path:a[1],fullMatch:a[0]});const i=e.matchAll(/!\[([^\]]*)\]\(([^)]+)\)/g);for(const a of i)t.push({type:"markdown",alt:a[1],path:a[2],fullMatch:a[0]});return t}async processMediaReference(e,t){const n=this.isNetworkUrl(e.path);let i,a,r;if(n)i=e.path,a=e.path,r=!1;else{a=this.resolveFilePath(e.path,t),i=this.extractFilename(e.path);r=this.app.vault.getAbstractFileByPath(a)instanceof ge.TFile}const s=this.getFileExtension(i).toLowerCase(),o=this.getMediaType(s),l=this.convertToAnkiFormat(n?e.path:i,o,e.alt||"");return{type:o,originalRef:e.fullMatch,filename:i,vaultPath:a,ankiFormat:l,fileExists:r}}convertToAnkiFormat(e,t,n){switch(t){case"image":return n?`<img src="${e}" alt="${n}">`:`<img src="${e}">`;case"audio":case"video":return`[sound:${e}]`;default:return`<img src="${e}">`}}async uploadMediaFiles(e){_e.debug(`[ObsidianToAnkiConverter] 开始上传 ${e.length} 个媒体文件`);for(const i of e)if(i.fileExists)try{const e=this.app.vault.getAbstractFileByPath(i.vaultPath);if(!(e instanceof ge.TFile)){i.uploaded=!1;continue}const t=await this.app.vault.readBinary(e),n=this.arrayBufferToBase64(t);await this.ankiConnect.storeMediaFile(i.filename,n),i.uploaded=!0,_e.debug(`[ObsidianToAnkiConverter] ✅ 上传成功: ${i.filename}`)}catch(n){_e.error(`[ObsidianToAnkiConverter] ❌ 上传失败: ${i.filename}`,n),i.uploaded=!1}else _e.warn(`[ObsidianToAnkiConverter] 跳过不存在的文件: ${i.filename}`),i.uploaded=!1;const t=e.filter(e=>e.uploaded).length;_e.debug(`[ObsidianToAnkiConverter] 上传完成: ${t}/${e.length}`)}generateBacklinks(e,t){const n=[];if(e.sourceFile){const i=this.generateSourceFileBacklink(e.sourceFile,t);i&&n.push(i)}if(e.sourceFile&&e.sourceBlock){const i=this.generateBlockBacklink(e.sourceFile,e.sourceBlock,t);i&&n.push(i)}return n}generateSourceFileBacklink(e,t){const n=`obsidian://open?vault=${encodeURIComponent(t)}&file=${encodeURIComponent(e)}`;return{type:"source_file",label:"查看源文档",url:n,html:`<div class="obsidian-backlink" style="margin-top: 12px; padding: 10px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">\n  <a href="${n}" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">\n    <span style="font-size: 18px;">📄</span>\n    <span>查看源文档</span>\n    <span style="opacity: 0.8; font-size: 12px; margin-left: auto;">(Obsidian)</span>\n  </a>\n</div>`}}generateBlockBacklink(e,t,n){const i=`obsidian://open?vault=${encodeURIComponent(n)}&file=${encodeURIComponent(e)}${t}`;return{type:"source_block",label:"定位到块",url:i,html:`<div class="obsidian-backlink" style="margin-top: 8px; padding: 8px 12px; background: #f0f4f8; border-left: 4px solid #667eea; border-radius: 4px;">\n  <a href="${i}" style="color: #667eea; text-decoration: none; display: flex; align-items: center; gap: 6px; font-size: 13px;">\n    <span>🔗</span>\n    <span>定位到块</span>\n    <span style="opacity: 0.6; font-size: 11px; font-family: monospace;">${t}</span>\n  </a>\n</div>`}}resolveFilePath(e,t){let n=e.replace(/^\[\[|\]\]$/g,"");if(n.includes("|")&&(n=n.split("|")[0]),n.startsWith("/"))return n.slice(1);const i=this.app.metadataCache.getFirstLinkpathDest(n,t);return i?i.path:n}extractFilename(e){let t=e.replace(/^\[\[|\]\]$/g,"").split("|")[0].trim();return t=t.replace(/!+$/,""),t.split("/").pop()||t}getFileExtension(e){let t=e;e.includes("@")&&(t=e.split("@")[0]),t.includes("?")&&(t=t.split("?")[0]);const n=t.split(".");return n.length>1?n[n.length-1]:""}getMediaType(e){const t=e.toLowerCase();return this.IMAGE_EXTENSIONS.includes(t)?"image":this.AUDIO_EXTENSIONS.includes(t)?"audio":this.VIDEO_EXTENSIONS.includes(t)?"video":"image"}isNetworkUrl(e){return e.startsWith("http://")||e.startsWith("https://")}arrayBufferToBase64(e){const t=new Uint8Array(e);let n="";for(let i=0;i<t.byteLength;i++)n+=String.fromCharCode(t[i]);return btoa(n)}}const ipe={front:["question","Front","Q","问题","题目","Question"],back:["answer","Back","A","答案","解答","Answer"],question:["front","Front","question","Question","Q","问题","题目"],answer:["back","Back","answer","Answer","A","答案","解答"],options:["choices","Choices","Options","选项"],correctAnswers:["correctanswers","CorrectAnswers","正确答案"],text:["content","Content","Text","内容"],cloze:["Cloze","挖空"],hint:["Hint","Extra","提示","额外"]};class ape{constructor(e,t,n){oe(this,"plugin"),oe(this,"ankiConnect"),oe(this,"templateExporter"),oe(this,"converter"),this.plugin=e,this.ankiConnect=t,this.templateExporter=n,this.converter=new npe(e.app,t)}async exportDeck(e,t,n){_e.debug("📤 开始导出牌组:",e,"→",t);const i=[];let a=0,r=0,s=0;try{null==n||n(0,100,"正在读取 Tuanki 牌组...");const l=await this.getTuankiDeckCards(e);if(_e.debug("📊 找到",l.length,"张卡片"),0===l.length)return _e.debug("✅ 牌组为空，无需导出"),{success:!0,exportedCards:0,createdModels:0,skippedCards:0,errors:[]};null==n||n(10,100,`找到 ${l.length} 张卡片`);const c=this.groupCardsByTemplate(l),d=Array.from(c.keys());_e.debug("📋 卡片分属",d.length,"个模板"),null==n||n(20,100,"正在准备 Anki 模板...");const u=new Map;for(let e=0;e<d.length;e++){const t=d[e];_e.debug("🔧 准备模板",e+1,"/",d.length,":",t);const a=this.getTemplateById(t);if(a)try{const i=a.type||"basic-qa",r=await this.templateExporter.ensureNativeModelByCardType(i);u.set(t,r),_e.debug("✓ 原生模板就绪:",r.name,"(卡片类型:",i,")"),r&&s++,null==n||n(20+(e+1)/d.length*20,100,`已准备模板 ${e+1}/${d.length}`)}catch(o){i.push({type:"model_creation",message:`创建/获取模板失败: ${o.message}`,templateId:t})}else i.push({type:"model_creation",message:`找不到模板 ID: ${t}`,templateId:t})}null==n||n(40,100,"正在导出卡片...");for(let e=0;e<l.length;e++){const s=l[e];e%10!=0&&e!==l.length-1||_e.debug("📤 上传进度:",e+1,"/",l.length);try{const o=this.getTemplateIdForExport(s),c=this.getTemplateById(o);if(!c){r++,i.push({type:"template_not_found",message:`未找到模板: ${o}`,cardId:s.uuid});continue}const d=u.get(o);if(!d){r++,i.push({type:"note_creation",message:`卡片 ${s.uuid} 的 Anki 模型不可用`,cardId:s.uuid});continue}await this.convertAndUploadCard(s,c,d,t),a++,(e+1)%10!=0&&e!==l.length-1||null==n||n(40+(e+1)/l.length*60,100,`已导出 ${a}/${l.length} 张卡片`)}catch(o){r++,i.push({type:"upload",message:`上传卡片失败: ${o.message}`,cardId:s.uuid})}}return null==n||n(100,100,"导出完成！"),_e.debug("✅ 导出完成 ━","成功:",a,"跳过:",r,"错误:",i.length),{success:!0,exportedCards:a,createdModels:s,skippedCards:r,errors:i}}catch(o){return _e.error("导出牌组失败:",o),{success:!1,exportedCards:a,createdModels:s,skippedCards:r,errors:[...i,{type:"upload",message:`导出失败: ${o.message}`}]}}}async convertAndUploadCard(e,t,n,i){const a=await this.convertCardToAnkiNote(e,t,n);await this.uploadNoteToAnki(a,i)}async convertCardToAnkiNote(e,t,n){var i;_e.debug("🔍 转换卡片",e.uuid,"使用模板",t.name);const a={vaultName:this.plugin.app.vault.getName(),uploadMedia:!0,generateBacklinks:!0,backlinkPosition:"append",mediaPosition:"inline",formatConversion:{enabled:!0,mathConversion:{enabled:!0,targetFormat:"latex-parens",detectCurrencySymbol:!0},wikiLinkConversion:{enabled:!0,mode:"obsidian-link"},calloutConversion:{enabled:!0,injectStyles:!1},highlightConversion:{enabled:!0}}},r={},s=n.fields.map(e=>e.toLowerCase());_e.debug("  📋 Anki 模型字段:",s.join(", "));const o=t.fields||[];for(const c of o){const t=c.name.toLowerCase();let n=t;if(!s.includes(t)){const e=ipe[t]||[];for(const i of e)if(s.includes(i.toLowerCase())){n=i.toLowerCase(),_e.debug(`  🔄 字段映射: "${t}" → "${n}"`);break}}let i="",o="";const d=[];if(c.name){d.push(c.name),d.push(c.name.toLowerCase());const e=c.name.charAt(0).toUpperCase()+c.name.slice(1);d.push(e)}const u=c.name.toLowerCase();ipe[u]&&d.push(...ipe[u]);const h=[...new Set(d)],{getCardFields:p}=await Promise.resolve().then(()=>V6),g=p(e);for(const e of h)if(g[e]&&""!==g[e].trim()){i=g[e],o=e,_e.debug(`  ✓ 字段匹配: "${n}" ← "${o}" = "${i.slice(0,30)}${i.length>30?"...":""}"`);break}if(!i&&"tags"===n&&e.tags&&e.tags.length>0&&(i=e.tags.join(" "),_e.debug(`  ✓ 字段匹配: "tags" ← card.tags = "${i}"`)),!i){let e=!1;for(const t of h)if(t in g){e=!0,_e.warn(`  ⚠️ 字段为空: "${n}" (存在于 parsedFields 但值为空)`);break}e||"tuanki_template_id"===n||"tuanki_card_id"===n||"source"===n||(_e.warn(`  ⚠️ 字段未匹配: "${n}"`),_e.warn(`     尝试了: ${h.join(", ")}`),_e.warn(`     可用字段: ${Object.keys(g).join(", ")}`))}if(null==i?void 0:i.trim())try{if("options"===c.name)i=this.formatOptionsToHTML(i);else{const t={...a,generateBacklinks:!1},r=await this.converter.convertContent(i,e,t);i=r.convertedContent,(r.mediaFiles.length>0||r.backlinks.length>0)&&_e.debug(`  🔄 转换字段 "${n}":`,{"媒体文件":r.mediaFiles.length,"回链":r.backlinks.length,"警告":r.warnings.length})}}catch(l){_e.error(`  ❌ 转换字段失败 "${n}":`,l)}r[n]=i}if(s.includes("tuanki_template_id")&&(r.tuanki_template_id=t.id),s.includes("tuanki_card_id")&&(r.tuanki_card_id=e.uuid),s.includes("source")){const t=e.sourceFile||(null==(i=e.customFields)?void 0:i.sourceFile);if(t){const e=this.plugin.app.vault.getName(),n=`obsidian://open?vault=${encodeURIComponent(e)}&file=${encodeURIComponent(t)}`;r.source=`<div style="margin-top: 8px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">\n  <a href="${n}" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500;">\n    <span style="font-size: 16px;">📄</span>\n    <span>查看源文档</span>\n    <span style="opacity: 0.8; font-size: 11px; margin-left: auto;">Obsidian</span>\n  </a>\n</div>`,_e.debug(`  🔗 生成源文档链接: ${t}`)}else _e.warn(`  ⚠️ 卡片 ${e.uuid} 缺少 sourceFile 信息，无法生成回链`)}return{modelName:n.name,fields:r,tags:e.tags||[]}}async uploadNoteToAnki(e,t){var n;try{const n={deckName:t,modelName:e.modelName||"",fields:e.fields||{},tags:e.tags||[],options:{allowDuplicate:!1,duplicateScope:"deck"}};return await this.ankiConnect.addNote(n)}catch(i){if(null==(n=i.message)?void 0:n.includes("duplicate"))return _e.warn("⚠️ 卡片已存在于 Anki，跳过重复卡片:",{modelName:e.modelName,fields:e.fields,tags:e.tags}),-1;throw _e.error("❌ 上传卡片到 Anki 失败:",{error:i.message,modelName:e.modelName,fields:e.fields}),i}}async getTuankiDeckCards(e){const t=this.plugin.dataStorage;if(!t)throw new Error("DataStorage 未初始化");return await t.getCardsByDeck(e)}groupCardsByTemplate(e){const t=new Map;for(const n of e){const e=this.getTemplateIdForExport(n);t.has(e)||t.set(e,[]),t.get(e).push(n)}return t}formatOptionsToHTML(e){return e.split("\n").filter(e=>e.trim()).map(e=>{const t=e.includes("{✓}")||e.includes("{√}"),n=e.replace(/\{[✓√]\}/g,"").trim();return t?`<div class="option-item option-correct"><span class="check-mark">✓</span>${n}</div>`:`<div class="option-item">${n}</div>`}).join("\n")}getTemplateIdForExport(e){var t;if(e.templateId)return e.templateId;const n={basic:"official-qa","basic-qa":"official-qa","basic-reverse":"official-qa",qa:"official-qa","single-choice":"official-choice","multiple-choice":"official-choice",choice:"official-choice",cloze:"official-cloze","cloze-deletion":"official-cloze"}[(null==(t=e.type)?void 0:t.toLowerCase())||"basic-qa"];return n||(_e.warn(`⚠️ 未知卡片类型: ${e.type}，降级使用 official-qa`),"official-qa")}getTemplateById(e){if(_e.debug("🔍 查找模板:",e),!e||""===e.trim()){_e.warn("⚠️ 模板ID为空，降级使用官方问答题模板");const e=xf.find(e=>"official-qa"===e.id);return e?{...e}:null}const t=xf.find(t=>t.id===e);if(t)return _e.debug("✓ 找到官方模板:",t.name,`(${t.id})`),{...t};const n=this.plugin.settings.simplifiedParsing;if(n){const t=n.templates.find(t=>t.id===e);if(t)return _e.debug("✓ 找到用户模板:",t.name,`(${t.id})`),t}const i=xf.map(e=>e.id),a=(null==n?void 0:n.templates.map(e=>e.id))||[];_e.warn("⚠️ 模板不存在:",e),_e.warn("   可用的官方模板:",i.join(", ")),a.length>0&&_e.warn("   可用的用户模板:",a.join(", ")),_e.warn("   降级使用官方问答题模板 (official-qa)");const r=xf.find(e=>"official-qa"===e.id);return r?{...r}:null}}class rpe{constructor(e){oe(this,"plugin"),this.plugin=e}async saveTemplate(e){const t=this.plugin.settings.simplifiedParsing;if(!t)throw new Error("SimplifiedParsing 设置未初始化");const n=t.templates.findIndex(t=>t.id===e.id);n>=0?t.templates[n]={...e,updatedAt:(new Date).toISOString()}:t.templates.push(e),await this.plugin.saveSettings()}async getTemplateByAnkiModel(e){const t=this.plugin.settings.simplifiedParsing;return t&&t.templates.find(t=>{var n,i;return(null==(i=null==(n=t.syncCapability)?void 0:n.ankiModelMapping)?void 0:i.modelId)===e})||null}async getTemplateByAnkiModelName(e){const t=this.plugin.settings.simplifiedParsing;return t&&t.templates.find(t=>{var n,i;return(null==(i=null==(n=t.syncCapability)?void 0:n.ankiModelMapping)?void 0:i.modelName)===e})||null}getTemplateById(e){const t=this.plugin.settings.simplifiedParsing;return t&&t.templates.find(t=>t.id===e)||null}async convertToTuankiExclusive(e){var t;const n=this.getTemplateById(e);if(!n)throw new Error(`找不到模板: ${e}`);const i={...n,name:n.name.replace(/^\[来自Anki\]\s*/,""),tuankiMetadata:{...n.tuankiMetadata,signature:this.generateTuankiSignature(e),version:"1.0",ankiCompatible:!1,source:"user_custom",createdInTuanki:!1,editedInTuanki:!0},syncCapability:{supportsBidirectional:!0,isTuankiExclusive:!0,ankiModelMapping:null==(t=n.syncCapability)?void 0:t.ankiModelMapping},updatedAt:(new Date).toISOString()};return await this.saveTemplate(i),i}async deleteTemplate(e){const t=this.plugin.settings.simplifiedParsing;if(!t)throw new Error("SimplifiedParsing 设置未初始化");const n=t.templates.findIndex(t=>t.id===e);if(n<0)throw new Error(`找不到模板: ${e}`);if(t.templates[n].isOfficial)throw new Error("不能删除官方模板");const i=await this.getCardsUsingTemplate(e);if(i>0)throw new Error(`有 ${i} 张卡片正在使用此模板，无法删除`);t.templates.splice(n,1),await this.plugin.saveSettings()}getTemplatesBySource(e){const t=this.plugin.settings.simplifiedParsing;return t?t.templates.filter(t=>{var n;return"official"===e?!0===t.isOfficial:(null==(n=t.tuankiMetadata)?void 0:n.source)===e}):[]}getBidirectionalTemplates(){const e=this.plugin.settings.simplifiedParsing;return e?e.templates.filter(e=>{var t;return!0===(null==(t=e.syncCapability)?void 0:t.supportsBidirectional)}):[]}getAnkiImportedTemplates(){return this.getTemplatesBySource("anki_imported")}getTemplateStatistics(){const e=this.plugin.settings.simplifiedParsing;if(!e)return{total:0,official:0,ankiImported:0,tuankiCreated:0,userCustom:0,bidirectional:0};const t=e.templates;return{total:t.length,official:t.filter(e=>e.isOfficial).length,ankiImported:t.filter(e=>{var t;return"anki_imported"===(null==(t=e.tuankiMetadata)?void 0:t.source)}).length,tuankiCreated:t.filter(e=>{var t;return"tuanki_created"===(null==(t=e.tuankiMetadata)?void 0:t.source)}).length,userCustom:t.filter(e=>{var t;return"user_custom"===(null==(t=e.tuankiMetadata)?void 0:t.source)}).length,bidirectional:t.filter(e=>{var t;return null==(t=e.syncCapability)?void 0:t.supportsBidirectional}).length}}generateTuankiSignature(e){return`tuanki-template-${e}-${Date.now()}`}async getCardsUsingTemplate(e){const t=this.plugin.dataStorage;if(!t)return 0;try{return(await t.getAllCards()).filter(t=>t.template===e).length}catch(n){return _e.error("获取卡片数量失败:",n),0}}async saveMultipleTemplates(e){const t=this.plugin.settings.simplifiedParsing;if(!t)throw new Error("SimplifiedParsing 设置未初始化");for(const n of e){const e=t.templates.findIndex(e=>e.id===n.id);e>=0?t.templates[e]={...n,updatedAt:(new Date).toISOString()}:t.templates.push(n)}await this.plugin.saveSettings()}async updateAnkiModelMapping(e,t,n){var i,a,r,s;const o=this.getTemplateById(e);if(!o)throw new Error(`找不到模板: ${e}`);const l={...o,syncCapability:{...o.syncCapability,supportsBidirectional:null!=(a=null==(i=o.syncCapability)?void 0:i.supportsBidirectional)&&a,isTuankiExclusive:null!=(s=null==(r=o.syncCapability)?void 0:r.isTuankiExclusive)&&s,ankiModelMapping:{modelId:t,modelName:n,lastSyncVersion:"1.0"}},updatedAt:(new Date).toISOString()};await this.saveTemplate(l)}}class spe{constructor(e,t={}){var n,i,a;oe(this,"state",{status:"disconnected",lastHeartbeat:0,reconnectAttempts:0}),oe(this,"heartbeatTimer",null),oe(this,"reconnectTimer",null),oe(this,"callbacks",new Set),oe(this,"heartbeatInterval"),oe(this,"maxReconnectAttempts"),oe(this,"reconnectDelays"),this.client=e,this.heartbeatInterval=null!=(n=t.heartbeatInterval)?n:3e4,this.maxReconnectAttempts=null!=(i=t.maxReconnectAttempts)?i:3,this.reconnectDelays=null!=(a=t.reconnectDelays)?a:[1e3,2e3,4e3]}startHeartbeat(){_e.debug("[AnkiConnect] 启动心跳检测，间隔:",this.heartbeatInterval/1e3,"秒"),this.stopHeartbeat(),this.performHeartbeat(),this.heartbeatTimer=window.setInterval(()=>{this.performHeartbeat()},this.heartbeatInterval)}stopHeartbeat(){null!==this.heartbeatTimer&&(window.clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,_e.debug("[AnkiConnect] 心跳检测已停止")),null!==this.reconnectTimer&&(window.clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}async performHeartbeat(){try{if(await this.client.testConnection()){const e=Date.now(),t="connected"!==this.state.status;this.state={status:"connected",lastHeartbeat:e,reconnectAttempts:0,error:void 0},t&&_e.debug("[AnkiConnect] ✅ 连接已恢复"),this.notifyStateChange()}else this.handleConnectionLost("心跳检测失败")}catch(e){this.handleConnectionLost(e instanceof Error?e.message:"未知错误")}}handleConnectionLost(e){"connected"===this.state.status&&_e.warn("[AnkiConnect] ⚠️ 连接丢失:",e),this.state={status:"disconnected",lastHeartbeat:this.state.lastHeartbeat,reconnectAttempts:this.state.reconnectAttempts,error:e},this.notifyStateChange(),this.attemptReconnect()}attemptReconnect(){if(this.state.reconnectAttempts>=this.maxReconnectAttempts)return void _e.warn(`[AnkiConnect] 连接失败，已尝试 ${this.maxReconnectAttempts} 次。请检查Anki软件是否正常启动且运行。`);const e=Math.min(this.state.reconnectAttempts,this.reconnectDelays.length-1),t=this.reconnectDelays[e];_e.debug(`[AnkiConnect] 🔄 将在 ${t/1e3} 秒后尝试第 ${this.state.reconnectAttempts+1} 次重连...`),this.state.status="reconnecting",this.state.reconnectAttempts++,this.notifyStateChange(),null!==this.reconnectTimer&&window.clearTimeout(this.reconnectTimer),this.reconnectTimer=window.setTimeout(async()=>{_e.debug(`[AnkiConnect] 正在尝试重连 (${this.state.reconnectAttempts}/${this.maxReconnectAttempts})...`);try{await this.client.testConnection()?(_e.debug("[AnkiConnect] ✅ 重连成功！"),this.state={status:"connected",lastHeartbeat:Date.now(),reconnectAttempts:0,error:void 0},this.notifyStateChange()):this.handleConnectionLost("重连失败")}catch(e){this.handleConnectionLost(e instanceof Error?e.message:"重连出错")}},t)}manualReconnect(){_e.debug("[AnkiConnect] 手动触发重连"),this.state.reconnectAttempts=0,this.attemptReconnect()}getState(){return{...this.state}}onStateChange(e){return this.callbacks.add(e),e(this.getState()),()=>{this.callbacks.delete(e)}}notifyStateChange(){const e=this.getState();this.callbacks.forEach(t=>{try{t(e)}catch(n){_e.error("[AnkiConnect] 状态回调执行错误:",n)}})}destroy(){this.stopHeartbeat(),this.callbacks.clear(),_e.debug("[AnkiConnect] 连接管理器已销毁")}}class ope{constructor(e){oe(this,"state",{timestamps:{},lastFullSync:0}),this.plugin=e,this.load()}load(){var e;const t=null==(e=this.plugin.settings.ankiConnect)?void 0:e.incrementalSyncState;t?(this.state=t,_e.debug("[IncrementalSyncTracker] 已加载同步状态，共",Object.keys(this.state.timestamps).length,"条记录")):_e.debug("[IncrementalSyncTracker] 无已保存的同步状态，使用空状态")}async persist(){this.plugin.settings.ankiConnect?(this.plugin.settings.ankiConnect.incrementalSyncState=this.state,await this.plugin.saveSettings(),_e.debug("[IncrementalSyncTracker] 已保存同步状态，共",Object.keys(this.state.timestamps).length,"条记录")):_e.error("[IncrementalSyncTracker] AnkiConnect 配置不存在，无法保存")}getChangedCards(e,t){const n=[];for(const i of e)this.shouldSync(i,null==t?void 0:t.get(i.uuid))&&n.push(i);return _e.debug("[IncrementalSyncTracker] 筛选结果:",n.length,"/",e.length,"张卡片需要同步"),n}shouldSync(e,t){const n=this.state.timestamps[e.uuid];if(!n)return!0;const i=n.lastSyncTime;return(e.lastModified||e.createdAt||0)>i||void 0!==t&&t>i}updateSyncTimestamp(e,t){const n=t.syncTime||Date.now();this.state.timestamps[e]={cardId:e,lastSyncTime:n,ankiNoteId:t.ankiNoteId,direction:t.direction}}updateBatchTimestamps(e,t){var n;const i=Date.now();for(const a of e)this.updateSyncTimestamp(a.uuid,{ankiNoteId:null==(n=t.ankiNoteIdMap)?void 0:n.get(a.uuid),direction:t.direction,syncTime:i});_e.debug("[IncrementalSyncTracker] 已更新",e.length,"张卡片的同步时间戳")}getSyncInfo(e){return this.state.timestamps[e]}markFullSync(){this.state.lastFullSync=Date.now(),_e.debug("[IncrementalSyncTracker] 已标记全量同步时间")}getLastFullSyncTime(){return this.state.lastFullSync}cleanupOldRecords(e=7776e6){const t=Date.now()-e;let n=0;const i={};for(const[a,r]of Object.entries(this.state.timestamps))r.lastSyncTime>=t?i[a]=r:n++;return this.state.timestamps=i,n>0&&_e.debug("[IncrementalSyncTracker] 已清理",n,"条过期记录"),n}reset(){this.state={timestamps:{},lastFullSync:0},_e.debug("[IncrementalSyncTracker] 同步状态已重置")}getStats(){const e=Object.values(this.state.timestamps);return{totalRecords:e.length,lastFullSync:this.state.lastFullSync,importCount:e.filter(e=>"import"===e.direction).length,exportCount:e.filter(e=>"export"===e.direction).length,bothCount:e.filter(e=>"both"===e.direction).length}}}class lpe{constructor(e,t,n,i){oe(this,"intervalTimer",null),oe(this,"debounceTimer",null),oe(this,"isRunning",!1),oe(this,"isSyncing",!1),oe(this,"fileModifyRef",null),this.app=e,this.plugin=t,this.ankiService=n,this.config=i}start(){this.isRunning?_e.warn("[AutoSyncScheduler] 调度器已在运行中"):(_e.debug("[AutoSyncScheduler] 启动自动同步调度器",{"定时间隔":`${this.config.intervalMinutes}分钟`,"启动时同步":this.config.syncOnStartup,"文件监听":this.config.enableFileWatcher}),this.isRunning=!0,this.config.syncOnStartup&&(_e.debug("[AutoSyncScheduler] 执行启动时同步..."),this.scheduleSyncTask("scheduled",2e3)),this.startScheduledSync(),this.config.enableFileWatcher&&this.startFileWatcher())}stop(){this.isRunning&&(_e.debug("[AutoSyncScheduler] 停止自动同步调度器"),null!==this.intervalTimer&&(window.clearInterval(this.intervalTimer),this.intervalTimer=null),null!==this.debounceTimer&&(window.clearTimeout(this.debounceTimer),this.debounceTimer=null),this.fileModifyRef&&(this.app.vault.offref(this.fileModifyRef),this.fileModifyRef=null),this.isRunning=!1)}startScheduledSync(){const e=60*this.config.intervalMinutes*1e3;_e.debug(`[AutoSyncScheduler] 启动定时同步，间隔: ${this.config.intervalMinutes} 分钟`),this.intervalTimer=window.setInterval(()=>{_e.debug("[AutoSyncScheduler] 触发定时同步"),this.scheduleSyncTask("scheduled")},e)}startFileWatcher(){_e.debug("[AutoSyncScheduler] 启动文件变更监听"),this.fileModifyRef=this.app.vault.on("modify",e=>{this.onFileChange(e)})}onFileChange(e){this.isTuankiCardFile(e)&&(_e.debug("[AutoSyncScheduler] 检测到卡片文件变更:",e.path),null!==this.debounceTimer&&window.clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{_e.debug("[AutoSyncScheduler] 触发变更检测同步"),this.scheduleSyncTask("on_change",0,e.path)},this.config.debounceDelay))}isTuankiCardFile(e){var t;const n=(null==(t=this.plugin.settings.tuanki)?void 0:t.dataFolder)||"tuanki";return!!e.path.startsWith(n)&&("md"===e.extension&&(!e.path.includes("template")&&!e.path.includes("settings")))}scheduleSyncTask(e,t=0,n){const i={type:e,timestamp:Date.now(),triggeredBy:n};t>0?setTimeout(()=>this.executeSync(i),t):this.executeSync(i)}async executeSync(e){var t;if(this.isSyncing)_e.debug("[AutoSyncScheduler] 同步正在进行中，跳过本次任务");else{if(this.config.onlyWhenAnkiRunning){if("connected"!==this.ankiService.getConnectionState().status)return void _e.debug("[AutoSyncScheduler] Anki 未连接，跳过同步")}this.isSyncing=!0;try{_e.debug("[AutoSyncScheduler] 🔄 开始执行同步:",{"类型":e.type,"触发源":e.triggeredBy||"无"});const t=await this.ankiService.performIncrementalSync();_e.debug("[AutoSyncScheduler] ✅ 同步完成:",{"总卡片数":t.totalCards,"变更数":t.changedCards,"导入数":t.importedCards,"导出数":t.exportedCards,"跳过数":t.skippedCards,"错误数":t.errors.length}),"scheduled"!==e.type&&"manual"!==e.type||this.showCompletionNotice(t)}catch(n){if(_e.error("[AutoSyncScheduler] ❌ 同步失败:",n),null==(t=this.plugin.app)?void 0:t.workspace){const{Notice:e}=be.default||be;new e(`同步失败: ${n instanceof Error?n.message:"未知错误"}`)}}finally{this.isSyncing=!1}}}showCompletionNotice(e){if(!this.plugin.app||!this.plugin.app.workspace)return;const{Notice:t}=be.default||be;if(0===e.changedCards)new t("同步完成：无需更新");else{new t(`同步完成：导入 ${e.importedCards} 张，导出 ${e.exportedCards} 张`)}}manualSync(){_e.debug("[AutoSyncScheduler] 手动触发同步"),this.scheduleSyncTask("manual")}getStatus(){return{isRunning:this.isRunning,isSyncing:this.isSyncing}}}class cpe{constructor(e,t,n){oe(this,"client"),oe(this,"stateTracker"),oe(this,"templateIdentifier"),oe(this,"mediaService"),oe(this,"templateConverter"),oe(this,"templateExporter"),oe(this,"cardImporter"),oe(this,"cardExporter"),oe(this,"templateManager"),oe(this,"connectionManager"),oe(this,"incrementalTracker"),oe(this,"autoSyncScheduler",null),oe(this,"connectionStatus",{isConnected:!1,lastCheckTime:(new Date).toISOString()}),oe(this,"syncProgress",{status:ace.IDLE,current:0,total:0,percentage:0}),oe(this,"syncCancelled",!1),this.plugin=e,this.app=t,this.settings=n,this.client=new lce(n.endpoint),this.stateTracker=new cce({}),this.templateIdentifier=new dce,this.mediaService=new uce(t,this.client,n.mediaSync),this.templateConverter=new hce(e),this.templateExporter=new gce(e,this.client),this.cardImporter=new $he(e,this.client,this.templateConverter),this.cardExporter=new ape(e,this.client,this.templateExporter),this.templateManager=new rpe(e),this.connectionManager=new spe(this.client),this.incrementalTracker=new ope(e),this.connectionManager.onStateChange(e=>{this.connectionStatus={isConnected:"connected"===e.status,lastCheckTime:new Date(e.lastHeartbeat).toISOString(),error:e.error?{type:ice.UNKNOWN,message:e.error,suggestion:"请检查 Anki 是否正在运行"}:void 0}})}async testConnection(){try{const e=await this.client.getVersion();this.connectionStatus={isConnected:!0,lastCheckTime:(new Date).toISOString(),apiVersion:e,ankiVersion:e.toString()}}catch(e){this.connectionStatus={isConnected:!1,lastCheckTime:(new Date).toISOString(),error:{type:e.type||ice.UNKNOWN,message:e.message,suggestion:e.suggestion||"请检查 Anki 是否正在运行"}}}return this.connectionStatus}async getAnkiDecks(){const e=await this.client.getDeckNames(),t=[];for(const i of e)try{const e=await this.client.getDeckStats(i);t.push(e)}catch(n){t.push({id:0,name:i,cardCount:0,newCount:0,learnCount:0,reviewCount:0})}return t}async getAnkiModels(e){const t=await this.client.getModelNames(),n=[],i=[];for(let a=0;a<t.length;a+=3){const r=t.slice(a,a+3),s=await Promise.allSettled(r.map(async e=>{try{return await this.client.getModelInfo(e)}catch(t){return i.push({name:e,error:t.message}),null}}));for(const e of s)"fulfilled"===e.status&&e.value&&n.push(e.value);if(e){e(Math.min(a+3,t.length),t.length)}}return i.length>0&&_e.warn(`获取 ${i.length} 个模型信息失败:`,i),n}async syncDeckToAnki(e,t,n){var i,a,r,s,o,l,c,d;const u=Date.now(),h={id:this.generateLogId(),timestamp:(new Date).toISOString(),direction:"to_anki",summary:{totalCards:t.length,successCount:0,failedCount:0,skippedCount:0},duration:0,errors:[],details:[]};try{this.updateProgress(ace.PREPARING,0,t.length);const d=this.settings.autoSync.prioritizeRecent?this.stateTracker.getCardsToSync(t,this.settings.autoSync.maxCardsPerSync):t;if(h.summary.totalCards=d.length,this.updateProgress(ace.SYNCING,0,d.length),this.settings.bidirectionalSync.enabled){const e=await this.detectConflicts(d);if(e.length>0){const t=await this.resolveConflicts(e);for(const e of t)if(e.mergedCard){const t=d.findIndex(t=>{var n;return t.id===(null==(n=e.mergedCard)?void 0:n.id)});-1!==t&&(d[t]=e.mergedCard)}}}for(let t=0;t<d.length;t++){const u=d[t];try{await this.syncSingleCard(u,e,n),h.summary.successCount++,null==(r=h.details)||r.push({cardId:u.id,cardTitle:((null==(i=u.fields)?void 0:i.front)||(null==(a=u.fields)?void 0:a.question)||"").substring(0,50),status:"success"})}catch(p){h.summary.failedCount++,null==(s=h.errors)||s.push(`卡片 ${u.id}: ${p.message}`),null==(c=h.details)||c.push({cardId:u.id,cardTitle:((null==(o=u.fields)?void 0:o.front)||(null==(l=u.fields)?void 0:l.question)||"").substring(0,50),status:"failed",reason:p.message})}this.updateProgress(ace.SYNCING,t+1,d.length)}this.updateProgress(ace.COMPLETED,d.length,d.length)}catch(p){this.updateProgress(ace.FAILED,0,0,p.message),null==(d=h.errors)||d.push(`同步失败: ${p.message}`)}return h.duration=Date.now()-u,h}async syncSingleCard(e,t,n){var i,a,r,s,o,l,c,d,u,h;let p=(null==(i=e.fields)?void 0:i.front)||(null==(a=e.fields)?void 0:a.question)||"",g=(null==(r=e.fields)?void 0:r.back)||(null==(s=e.fields)?void 0:s.answer)||"";if(this.settings.mediaSync.enabled){const e=(null==(o=t.metadata)?void 0:o.path)||"";p=(await this.mediaService.syncMediaToAnki(p,e)).updatedContent;g=(await this.mediaService.syncMediaToAnki(g,e)).updatedContent}if(this.settings.mediaSync.createBacklinks){const n=this.generateCardBacklink(e,t);this.settings.mediaSync.createBacklinks&&(g+=`\n\n<hr>\n${n}`)}const v=this.getAnkiDeckName(t),f=this.stateTracker.getMetadata(e.id);if(null==f?void 0:f.ankiNoteId)await this.client.updateNoteFields(f.ankiNoteId,{Front:p,Back:g,Extra:(null==(l=e.fields)?void 0:l.extra)||(null==(c=e.customFields)?void 0:c.extra)||""}),e.tags&&e.tags.length>0&&await this.client.updateNoteTags(f.ankiNoteId,e.tags),this.stateTracker.updateAfterSync(e.id,f.ankiNoteId);else{const{getCardFields:t}=await Promise.resolve().then(()=>V6),i=t(e),a={deckName:v,modelName:(null==(u=null==(d=n.syncCapability)?void 0:d.ankiModelMapping)?void 0:u.modelName)||"Basic",fields:{Front:i.front||p,Back:i.back||g,Extra:(null==(h=e.customFields)?void 0:h.extra)||""},tags:e.tags||[]},r=await this.client.addNote(a);this.stateTracker.initializeMetadata(e,r,this.settings.bidirectionalSync.enabled)}}async importDeckFromAnki(e,t,n){var i,a;const r=Date.now(),s={id:this.generateLogId(),timestamp:(new Date).toISOString(),direction:"from_anki",summary:{totalCards:0,successCount:0,failedCount:0,skippedCount:0},duration:0,errors:[],details:[]};try{this.updateProgress(ace.PREPARING,0,0);const a=await this.client.findNotesByDeck(e);s.summary.totalCards=a.length,this.updateProgress(ace.SYNCING,0,a.length);const r=50;for(let e=0;e<a.length;e+=r){const l=a.slice(e,e+r),c=await this.client.getNotesInfo(l);for(const e of c)try{await this.importSingleNote(e,t,n),s.summary.successCount++}catch(o){s.summary.failedCount++,null==(i=s.errors)||i.push(`笔记 ${e.noteId}: ${o.message}`)}this.updateProgress(ace.SYNCING,Math.min(e+r,a.length),a.length)}this.updateProgress(ace.COMPLETED,a.length,a.length)}catch(o){this.updateProgress(ace.FAILED,0,0,o.message),null==(a=s.errors)||a.push(`导入失败: ${o.message}`)}return s.duration=Date.now()-r,s}async importSingleNote(e,t,n){_e.debug("导入笔记:",e,t,n)}async detectConflicts(e){return[]}async resolveConflicts(e){return[]}updateProgress(e,t,n,i){this.syncProgress={status:e,current:t,total:n,percentage:n>0?Math.round(t/n*100):0,message:i}}generateCardBacklink(e,t){var n;const i=this.app.vault.getName(),a=(null==(n=t.metadata)?void 0:n.path)||"",r=encodeURIComponent(a);return`<a href="${`obsidian://open?vault=${encodeURIComponent(i)}&file=${r}`}" class="obsidian-backlink" style="display: inline-block; padding: 6px 10px; background: #4A5568; color: #E2E8F0; text-decoration: none; border-radius: 3px; font-size: 12px;">\n  <span style="margin-right: 4px;">🔗</span>\n  <span>在 Obsidian 中打开</span>\n</a>`}getAnkiDeckName(e){const t=this.settings.deckMappings[e.id];return(null==t?void 0:t.ankiDeckName)||e.name}generateLogId(){return`sync-${Date.now()}-${Math.random().toString(36).substring(7)}`}getConnectionStatus(){return this.connectionStatus}getSyncProgress(){return this.syncProgress}getSyncStatistics(){return this.stateTracker.getStatistics()}updateSettings(e){Object.assign(this.settings,e),e.endpoint&&(this.client=new lce(e.endpoint)),e.mediaSync&&this.mediaService.updateOptions(e.mediaSync)}exportSyncMetadata(){return this.stateTracker.getAllMetadata()}async getTuankiDecks(){return[]}async getDeckCardCount(e){return 0}validateDeckMapping(e){const t=[];return e.tuankiDeckId||t.push("Tuanki 牌组 ID 不能为空"),e.ankiDeckName||t.push("Anki 牌组名称不能为空"),["to_anki","from_anki","bidirectional"].includes(e.syncDirection)||t.push("无效的同步方向"),{isValid:0===t.length,errors:t}}async batchSyncDecks(e,t){return _e.warn("batchSyncDecks 方法已废弃，请使用 UI 层的批量同步逻辑"),[]}cancelCurrentSync(){this.syncCancelled=!0,this.updateProgress(ace.CANCELLED,0,0,"同步已取消")}exportLogsToJson(e){return JSON.stringify(e,null,2)}async importDeckWithTemplates(e,t,n){try{return await this.cardImporter.importDeck(e,t,n)}catch(i){throw _e.error("导入牌组失败:",i),new rce(`导入牌组失败: ${i.message}`,ice.UNKNOWN)}}async exportDeckToAnki(e,t,n){try{return await this.cardExporter.exportDeck(e,t,n)}catch(i){throw _e.error("导出牌组失败:",i),new rce(`导出牌组失败: ${i.message}`,ice.UNKNOWN)}}getTemplateManager(){return this.templateManager}getTemplateConverter(){return this.templateConverter}async importAnkiModels(e,t){const n=[],i=[];for(let r=0;r<e.length;r++)try{const a=e[r],s=await this.client.getModelInfo(a);if(this.templateConverter.isTemplateAlreadyImported(s.id)){_e.debug(`模板 ${a} 已存在，跳过`);continue}const{template:o,warnings:l}=this.templateConverter.convertModelToTemplate(s);await this.templateManager.saveTemplate(o),n.push(o),l.length>0&&i.push(`${a}: ${l.join(", ")}`),null==t||t(r+1,e.length)}catch(a){i.push(`${e[r]}: ${a.message}`)}return{imported:n,errors:i}}async convertToTuankiExclusive(e){return await this.templateManager.convertToTuankiExclusive(e)}getTemplateStatistics(){return this.templateManager.getTemplateStatistics()}getTemplatesBySource(e){return this.templateManager.getTemplatesBySource(e)}getBidirectionalTemplates(){return this.templateManager.getBidirectionalTemplates()}startConnectionMonitoring(){_e.debug("[AnkiConnectService] 启动连接监控"),this.connectionManager.startHeartbeat()}stopConnectionMonitoring(){_e.debug("[AnkiConnectService] 停止连接监控"),this.connectionManager.stopHeartbeat()}startAutoSync(){var e;this.settings.autoSync.enabled?this.autoSyncScheduler?_e.warn("[AnkiConnectService] 自动同步调度器已在运行"):(_e.debug("[AnkiConnectService] 启动自动同步调度器"),this.autoSyncScheduler=new lpe(this.app,this.plugin,this,{intervalMinutes:this.settings.autoSync.intervalMinutes,syncOnStartup:this.settings.autoSync.syncOnStartup,onlyWhenAnkiRunning:this.settings.autoSync.onlyWhenAnkiRunning,enableFileWatcher:null!=(e=this.settings.autoSync.enableFileWatcher)&&e,debounceDelay:5e3}),this.autoSyncScheduler.start()):_e.debug("[AnkiConnectService] 自动同步未启用，跳过")}stopAutoSync(){this.autoSyncScheduler&&(_e.debug("[AnkiConnectService] 停止自动同步调度器"),this.autoSyncScheduler.stop(),this.autoSyncScheduler=null)}manualSync(){this.autoSyncScheduler?this.autoSyncScheduler.manualSync():_e.warn("[AnkiConnectService] 自动同步调度器未启动")}getConnectionState(){return this.connectionManager.getState()}async performIncrementalSync(){const e=Date.now();_e.debug("[AnkiConnectService] 🔄 开始增量同步...");try{const n=Object.values(this.settings.deckMappings||{});if(0===n.length)return _e.debug("[AnkiConnectService] 无牌组映射，跳过同步"),{totalCards:0,changedCards:0,skippedCards:0,importedCards:0,exportedCards:0,errors:[],duration:Date.now()-e};let i=0,a=0,r=0,s=0;const o=[];for(const e of n)if(e.enabled)try{if("from_anki"===e.syncDirection||"bidirectional"===e.syncDirection){const t=await this.cardImporter.importDeck(e.ankiDeckName,e.tuankiDeckId);r+=t.importedCards,i+=t.importedCards+t.skippedCards,t.errors.length>0&&o.push(...t.errors.map(e=>e.message))}if("to_anki"===e.syncDirection||"bidirectional"===e.syncDirection){const t=await this.cardExporter.exportDeck(e.tuankiDeckId,e.ankiDeckName);s+=t.exportedCards,t.errors.length>0&&o.push(...t.errors.map(e=>e.message))}}catch(t){o.push(`牌组 ${e.ankiDeckName}: ${t instanceof Error?t.message:"未知错误"}`)}a=r+s;const l={totalCards:i,changedCards:a,skippedCards:i-a,importedCards:r,exportedCards:s,errors:o,duration:Date.now()-e};return _e.debug("[AnkiConnectService] ✅ 增量同步完成:",l),await this.incrementalTracker.persist(),l}catch(t){return _e.error("[AnkiConnectService] ❌ 增量同步失败:",t),{totalCards:0,changedCards:0,skippedCards:0,importedCards:0,exportedCards:0,errors:[t instanceof Error?t.message:"未知错误"],duration:Date.now()-e}}}getIncrementalSyncStats(){return this.incrementalTracker.getStats()}resetIncrementalSync(){this.incrementalTracker.reset(),_e.debug("[AnkiConnectService] 增量同步状态已重置")}cleanupOldSyncRecords(e=90){const t=24*e*60*60*1e3;return this.incrementalTracker.cleanupOldRecords(t)}}const dpe=Object.freeze(Object.defineProperty({__proto__:null,AnkiConnectService:cpe},Symbol.toStringTag,{value:"Module"}));function upe(e,t,n,i,a,r){if(!bi(t)||!bi(n))return;const s=i().find(e=>e.id===bi(t));s&&(a()({tuankiDeckId:bi(t),tuankiDeckName:s.name,ankiDeckName:bi(n),syncDirection:bi(r),enabled:!1,lastSyncTime:void 0}),$n(t,""),$n(n,""),$n(r,"to_anki"))}var hpe=la("<option> </option>"),ppe=la("<option> </option>"),gpe=la('<div class="add-mapping-form svelte-g6pukb"><h5 class="svelte-g6pukb">➕ 添加新的牌组映射</h5> <div class="form-row svelte-g6pukb"><div class="form-field svelte-g6pukb"><label for="tuanki-deck-select" class="svelte-g6pukb">Tuanki 牌组</label> <select id="tuanki-deck-select" class="modern-select svelte-g6pukb"><option>请选择 Tuanki 牌组...</option><!></select></div> <div class="form-field svelte-g6pukb"><label for="anki-deck-select" class="svelte-g6pukb">Anki 牌组</label> <select id="anki-deck-select" class="modern-select svelte-g6pukb"><option>请选择 Anki 牌组...</option><!></select></div> <div class="form-field svelte-g6pukb"><label for="sync-direction-select" class="svelte-g6pukb">同步方向</label> <select id="sync-direction-select" class="modern-select svelte-g6pukb"><option>→ 到 Anki</option><option>← 从 Anki</option></select></div> <div class="form-actions svelte-g6pukb"><button class="btn btn-primary svelte-g6pukb">✓ 添加</button></div></div></div>');function vpe(e,t){if(new.target)return Er({component:vpe,...e});kt(t,!0);let n=Ar(t,"isVisible",7),i=Ar(t,"ankiDecks",7),a=Ar(t,"tuankiDecks",7),r=Ar(t,"isPremium",7),s=Ar(t,"onAdd",7),o=Pn(""),l=Pn(""),c=Pn("to_anki");var d={get isVisible(){return n()},set isVisible(e){n(e),hn()},get ankiDecks(){return i()},set ankiDecks(e){i(e),hn()},get tuankiDecks(){return a()},set tuankiDecks(e){a(e),hn()},get isPremium(){return r()},set isPremium(e){r(e),hn()},get onAdd(){return s()},set onAdd(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},u=ha(),h=Qt(u),p=e=>{var t=gpe(),n=Kt(Gt(t),2),r=Gt(n),d=Kt(Gt(r),2),u=Gt(d);u.value=u.__value="",Ca(Kt(u),17,a,_a,(e,t)=>{var n=hpe(),i=Gt(n,!0);zt(n);var a={};zi(()=>{var e;va(i,bi(t).name),a!==(a=bi(t).id)&&(n.value=null!=(e=n.__value=bi(t).id)?e:"")}),pa(e,n)}),zt(d),zt(r);var h=Kt(r,2),p=Kt(Gt(h),2),g=Gt(p);g.value=g.__value="",Ca(Kt(g),17,i,_a,(e,t)=>{var n=ppe(),i=Gt(n,!0);zt(n);var a={};zi(()=>{var e;va(i,bi(t).name),a!==(a=bi(t).name)&&(n.value=null!=(e=n.__value=bi(t).name)?e:"")}),pa(e,n)}),zt(p),zt(h);var v=Kt(h,2),f=Kt(Gt(v),2),m=Gt(f);m.value=m.__value="to_anki";var y=Kt(m);y.value=y.__value="from_anki",zt(f),zt(v);var b=Kt(v,2),w=Gt(b);w.__click=[upe,o,l,a,s,c],zt(b),zt(n),zt(t),zi(()=>w.disabled=!bi(o)||!bi(l)),qa(d,()=>bi(o),e=>$n(o,e)),qa(p,()=>bi(l),e=>$n(l,e)),qa(f,()=>bi(c),e=>$n(c,e)),pa(e,t)};return xa(h,e=>{n()&&e(p)}),pa(e,u),St(d)}ia(["click"]);var fpe=la('<span class="deck-count svelte-1ash55w"> </span>'),mpe=la('<div class="toolbar svelte-1ash55w"><button class="btn btn-primary svelte-1ash55w"> </button> <!> <button class="btn btn-success svelte-1ash55w"> </button></div>');function ype(e,t){if(new.target)return Er({component:ype,...e});kt(t,!0);let n=Ar(t,"ankiDecks",7),i=Ar(t,"tuankiDecks",7),a=Ar(t,"isFetchingDecks",7),r=Ar(t,"showAddModal",7),s=Ar(t,"onFetchDecks",7),o=Ar(t,"onToggleAddModal",7);var l={get ankiDecks(){return n()},set ankiDecks(e){n(e),hn()},get tuankiDecks(){return i()},set tuankiDecks(e){i(e),hn()},get isFetchingDecks(){return a()},set isFetchingDecks(e){a(e),hn()},get showAddModal(){return r()},set showAddModal(e){r(e),hn()},get onFetchDecks(){return s()},set onFetchDecks(e){s(e),hn()},get onToggleAddModal(){return o()},set onToggleAddModal(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=mpe(),d=Gt(c);d.__click=function(...e){var t;null==(t=s())||t.apply(this,e)};var u=Gt(d,!0);zt(d);var h=Kt(d,2),p=e=>{var t=fpe(),i=Gt(t);zt(t),zi(()=>{var e;return va(i,`已发现 ${null!=(e=n().length)?e:""} 个 Anki 牌组`)}),pa(e,t)};xa(h,e=>{n().length>0&&e(p)});var g=Kt(h,2);g.__click=function(...e){var t;null==(t=o())||t.apply(this,e)};var v=Gt(g,!0);return zt(g),zt(c),zi(()=>{d.disabled=a(),va(u,a()?"获取中...":"获取 Anki 牌组列表"),g.disabled=0===i().length||0===n().length,er(g,"title",0===i().length?"请先创建 Tuanki 牌组":0===n().length?"请先获取 Anki 牌组列表":""),va(v,r()?"取消添加":"➕ 添加映射")}),pa(e,c),St(l)}function bpe(e,t,n,i){const a=new ge.Menu,r=Object.values(t()).filter(e=>e.enabled).length;Object.keys(t()).length,a.addItem(e=>{var t;e.setTitle("批量导出到 Anki").setIcon("arrow-right").setDisabled(0===r).onClick(async()=>{0!==r?await n()("to_anki"):new ge.Notice("⚠️ 没有启用的牌组映射")}),r>0&&(null==(t=e.setSection)||t.call(e,`${r} 个已启用`))}),a.addItem(e=>{var t;e.setTitle("批量从 Anki 导入").setIcon("arrow-left").setDisabled(0===r).onClick(async()=>{0!==r?await n()("from_anki"):new ge.Notice("⚠️ 没有启用的牌组映射")}),r>0&&(null==(t=e.setSection)||t.call(e,`${r} 个已启用`))}),a.addItem(e=>{var t;e.setTitle("批量双向同步").setIcon("repeat").setDisabled(0===r||!i().bidirectionalSync.enabled).onClick(async()=>{0!==r?i().bidirectionalSync.enabled?await n()("bidirectional"):new ge.Notice("⚠️ 双向同步未启用，请在高级设置中启用"):new ge.Notice("⚠️ 没有启用的牌组映射")}),r>0&&i().bidirectionalSync.enabled&&(null==(t=e.setSection)||t.call(e,`${r} 个已启用`))}),a.showAtMouseEvent(e)}ia(["click"]);var wpe=(e,t)=>$n(t,!0),kpe=la('<button class="header-action-btn help-btn svelte-11ffg0i"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-11ffg0i"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></button>'),Spe=la('<div class="info-banner warning svelte-11ffg0i"><span class="banner-icon svelte-11ffg0i">⚠️</span> <div class="banner-text svelte-11ffg0i"><strong class="svelte-11ffg0i">未找到 Tuanki 牌组</strong><br/> 请先在"牌组学习"界面中创建至少一个牌组，然后刷新此页面。</div></div>'),xpe=(e,t,n)=>{t()(bi(n)._id,{enabled:!bi(n).enabled})},_pe=(e,t,n)=>t(bi(n),e),Cpe=la('<tr><td class="truncate svelte-11ffg0i"><strong> </strong></td><td class="truncate svelte-11ffg0i"> </td><td class="svelte-11ffg0i"><span> </span></td><td class="svelte-11ffg0i"><label class="modern-switch"><input type="checkbox"/> <span class="switch-slider"></span></label></td><td class="last-sync-time truncate svelte-11ffg0i"> </td><td class="actions-cell svelte-11ffg0i"><button class="mapping-menu-btn svelte-11ffg0i" aria-label="操作菜单" title="更多操作"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-11ffg0i"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button></td></tr>'),Ipe=la('<div class="mapping-table-container svelte-11ffg0i"><table class="anki-table svelte-11ffg0i"><thead><tr><th class="svelte-11ffg0i">Tuanki 牌组</th><th class="svelte-11ffg0i">Anki 牌组</th><th class="svelte-11ffg0i">同步方向</th><th class="svelte-11ffg0i">状态</th><th class="svelte-11ffg0i">上次同步</th><th class="svelte-11ffg0i">操作</th></tr></thead><tbody></tbody></table></div>'),Dpe=(e,t)=>$n(t,!1),Tpe=(e,t)=>"Escape"===e.key&&$n(t,!1),Mpe=e=>e.stopPropagation(),Ape=e=>e.stopPropagation(),Epe=(e,t)=>$n(t,!1),zpe=(e,t)=>$n(t,!1),Ppe=la('<div class="modal-overlay svelte-11ffg0i" role="dialog" aria-modal="true" aria-labelledby="help-modal-title" tabindex="-1"><div class="help-modal svelte-11ffg0i" role="document" tabindex="-1"><div class="help-modal-header svelte-11ffg0i"><h3 id="help-modal-title" class="svelte-11ffg0i">💡 使用说明</h3> <button class="close-btn svelte-11ffg0i" aria-label="关闭帮助">×</button></div> <div class="help-modal-content svelte-11ffg0i"><div class="help-item svelte-11ffg0i"><div class="help-item-title svelte-11ffg0i"> </div> <p class="help-item-desc svelte-11ffg0i">打开开关即可启用同步，点击同步按钮执行数据同步</p></div> <div class="help-item svelte-11ffg0i"><div class="help-item-title svelte-11ffg0i">🔄 如何使用</div> <ul class="help-list svelte-11ffg0i"><li class="svelte-11ffg0i"><strong class="svelte-11ffg0i">启用同步</strong>：点击表格中的开关启用或禁用该映射</li> <li class="svelte-11ffg0i"><strong class="svelte-11ffg0i">单个同步</strong>：点击操作菜单（•••）选择同步方向</li> <li class="svelte-11ffg0i"><strong class="svelte-11ffg0i">批量同步</strong>：点击右上角菜单（•••）批量操作所有启用的映射</li></ul></div> <div class="help-item svelte-11ffg0i"><div class="help-item-title svelte-11ffg0i">⚙️ 同步方向说明</div> <ul class="help-list svelte-11ffg0i"><li class="svelte-11ffg0i"><strong class="svelte-11ffg0i">→ 到 Anki</strong>：将 Tuanki 卡片导出到 Anki</li> <li class="svelte-11ffg0i"><strong class="svelte-11ffg0i">← 从 Anki</strong>：从 Anki 导入卡片到 Tuanki</li> <li class="svelte-11ffg0i"><strong class="svelte-11ffg0i">⇄ 双向</strong>：智能双向同步（需要激活高级功能）</li></ul></div></div> <div class="help-modal-footer svelte-11ffg0i"><button class="btn btn-primary svelte-11ffg0i">知道了</button></div></div></div>'),Rpe=la('<div class="deck-mapping-section settings-group"><div class="group-header svelte-11ffg0i"><div class="header-content svelte-11ffg0i"><h4 class="section-title with-accent-bar accent-purple svelte-11ffg0i"> </h4> <p> </p></div> <div class="header-actions svelte-11ffg0i"><!> <button class="header-action-btn svelte-11ffg0i"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-11ffg0i"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button></div></div> <!> <!> <!> <!></div> <!>',1);function $pe(e,t){if(new.target)return Er({component:$pe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=In(n),s=Ar(t,"ankiDecks",23,()=>[]),o=Ar(t,"tuankiDecks",23,()=>[]),l=Ar(t,"isFetchingDecks",7,!1),c=Ar(t,"mappings",23,()=>({})),d=Ar(t,"settings",7),u=Ar(t,"onFetchDecks",7),h=Ar(t,"onAddMapping",7),p=Ar(t,"onUpdateMapping",7),g=Ar(t,"onRemoveMapping",7),v=Ar(t,"onSync",7),f=Ar(t,"onImport",7),m=Ar(t,"onBidirectionalSync",7),y=Ar(t,"onBatchSync",7),b=Pn(!1),w=Pn(null),k=Pn(!1);const S=Qh.getInstance();let x=Pn(!1);Ti(()=>S.isPremiumActive.subscribe(e=>{$n(x,e,!0)}));let _=In(()=>Object.entries(c()).map(([e,t])=>({_id:e,...t})));function C(e){if(!e)return"从未同步";const t=new Date(e),n=(new Date).getTime()-t.getTime(),i=Math.floor(n/6e4);if(i<1)return"刚刚";if(i<60)return`${i}分钟前`;const a=Math.floor(i/60);if(a<24)return`${a}小时前`;const r=Math.floor(a/24);return r<7?`${r}天前`:t.toLocaleDateString()}function I(e,t){const n=new ge.Menu,i=bi(w)===e._id||bi(w)===e.ankiDeckName;"from_anki"!==e.syncDirection&&"bidirectional"!==e.syncDirection||n.addItem(t=>{t.setTitle("从 Anki 导入").setIcon("download").setDisabled(!e.enabled||i).onClick(()=>async function(e,t){$n(w,e,!0);try{await f()(e,t)}finally{$n(w,null)}}(e.ankiDeckName,e.tuankiDeckId))}),"to_anki"!==e.syncDirection&&"bidirectional"!==e.syncDirection||n.addItem(t=>{t.setTitle("导出到 Anki").setIcon("upload").setDisabled(!e.enabled||i).onClick(()=>async function(e){$n(w,e,!0);try{await v()(e)}finally{$n(w,null)}}(e._id))}),"bidirectional"===e.syncDirection&&n.addItem(t=>{t.setTitle("双向智能同步").setIcon("repeat").setDisabled(!e.enabled||i).onClick(()=>async function(e){$n(w,e,!0);try{await m()(e)}finally{$n(w,null)}}(e._id))}),n.addSeparator(),n.addItem(t=>{t.setTitle("删除映射").setIcon("trash").onClick(()=>g()(e._id))}),n.showAtMouseEvent(t)}var D={get ankiDecks(){return s()},set ankiDecks(e=[]){s(e),hn()},get tuankiDecks(){return o()},set tuankiDecks(e=[]){o(e),hn()},get isFetchingDecks(){return l()},set isFetchingDecks(e=!1){l(e),hn()},get mappings(){return c()},set mappings(e={}){c(e),hn()},get settings(){return d()},set settings(e){d(e),hn()},get onFetchDecks(){return u()},set onFetchDecks(e){u(e),hn()},get onAddMapping(){return h()},set onAddMapping(e){h(e),hn()},get onUpdateMapping(){return p()},set onUpdateMapping(e){p(e),hn()},get onRemoveMapping(){return g()},set onRemoveMapping(e){g(e),hn()},get onSync(){return v()},set onSync(e){v(e),hn()},get onImport(){return f()},set onImport(e){f(e),hn()},get onBidirectionalSync(){return m()},set onBidirectionalSync(e){m(e),hn()},get onBatchSync(){return y()},set onBatchSync(e){y(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},T=Rpe(),M=Qt(T),A=Gt(M),E=Gt(A),z=Gt(E),P=Gt(z,!0);zt(z);var R=Kt(z,2),$=Gt(R,!0);zt(R),zt(E);var O=Kt(E,2),L=Gt(O),N=e=>{var t=kpe();t.__click=[wpe,k],zi((e,n)=>{er(t,"aria-label",e),er(t,"title",n)},[()=>bi(r)("common.help"),()=>bi(r)("common.help")]),pa(e,t)};xa(L,e=>{bi(_).length>0&&e(N)});var F=Kt(L,2);F.__click=[bpe,c,y,d],zt(O),zt(A);var B=Kt(A,2),j=e=>{pa(e,Spe())};xa(B,e=>{0===o().length&&e(j)});var U=Kt(B,2);ype(U,{get ankiDecks(){return s()},get tuankiDecks(){return o()},get isFetchingDecks(){return l()},get showAddModal(){return bi(b)},onFetchDecks:async function(){await u()()},onToggleAddModal:()=>$n(b,!bi(b))});var V=Kt(U,2);vpe(V,{get isVisible(){return bi(b)},get ankiDecks(){return s()},get tuankiDecks(){return o()},get isPremium(){return bi(x)},onAdd:function(e){h()(e),$n(b,!1)}});var q=Kt(V,2),H=e=>{},W=e=>{var t=Ipe(),n=Gt(t),i=Kt(Gt(n));Ca(i,21,()=>bi(_),_a,(e,t)=>{var n=Cpe(),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a),zt(i);var s=Kt(i),o=Gt(s,!0);zt(s);var l=Kt(s),c=Gt(l),d=Gt(c);zt(c),zt(l);var u=Kt(l),h=Gt(u),g=Gt(h);Za(g),g.__change=[xpe,p,t],Pt(2),zt(h),zt(u);var v=Kt(u),f=Gt(v,!0);zt(v);var m=Kt(v);Gt(m).__click=[_pe,I,t],zt(m),zt(n),zi((e,n,a,l)=>{er(i,"title",bi(t).tuankiDeckName),va(r,bi(t).tuankiDeckName),er(s,"title",bi(t).ankiDeckName),va(o,bi(t).ankiDeckName),Fa(c,1,`sync-direction ${null!=e?e:""}`,"svelte-11ffg0i"),va(d,`${null!=n?n:""} \n                  ${"to_anki"===bi(t).syncDirection?"到 Anki":"from_anki"===bi(t).syncDirection?"从 Anki":"双向"}`),er(h,"title",bi(t).enabled?"点击禁用同步":"点击启用同步"),Xa(g,bi(t).enabled),er(v,"title",a),va(f,l)},[()=>function(e){switch(e){case"to_anki":default:return"to-anki";case"from_anki":return"from-anki";case"bidirectional":return"bidirectional"}}(bi(t).syncDirection),()=>function(e){switch(e){case"to_anki":default:return"→";case"from_anki":return"←";case"bidirectional":return"⇄"}}(bi(t).syncDirection),()=>C(bi(t).lastSyncTime),()=>C(bi(t).lastSyncTime)]),pa(e,n)}),zt(i),zt(n),zt(t),pa(e,t)};xa(q,e=>{0===bi(_).length?e(H):e(W,!1)}),zt(M);var G=Kt(M,2),Q=e=>{var t=Ppe();t.__click=[Dpe,k],t.__keydown=[Tpe,k];var n=Gt(t);n.__click=[Mpe],n.__keydown=[Ape];var i=Gt(n);Kt(Gt(i),2).__click=[Epe,k],zt(i);var a=Kt(i,2),r=Gt(a),s=Gt(r),o=Gt(s);zt(s),Pt(2),zt(r),Pt(4),zt(a);var l=Kt(a,2);Gt(l).__click=[zpe,k],zt(l),zt(n),zt(t),zi(()=>{var e;return va(o,`📊 已配置 ${null!=(e=bi(_).length)?e:""} 个映射关系`)}),pa(e,t)};xa(G,e=>{bi(k)&&e(Q)}),zi((e,t,n,i)=>{va(P,e),va($,t),er(F,"aria-label",n),er(F,"title",i)},[()=>bi(r)("ankiConnect.deckSync.title"),()=>bi(r)("ankiConnect.deckSync.description"),()=>bi(r)("common.batchOperations"),()=>bi(r)("common.batchOperations")]),pa(e,T);var K=St(D);return a(),K}ia(["click","change","keydown"]);var Ope=la('<tr><td> </td><td><span class="direction-badge svelte-7r6dxn"> </span></td><td class="success-count svelte-7r6dxn"> </td><td class="failed-count svelte-7r6dxn"> </td><td class="skipped-count svelte-7r6dxn"> </td><td> </td></tr>'),Lpe=(e,t,n)=>t(bi(n)-1),Npe=(e,t,n)=>t(bi(n)+1),Fpe=la('<div class="pagination svelte-7r6dxn"><button class="btn btn-small">← 上一页</button> <span class="page-info svelte-7r6dxn"> </span> <button class="btn btn-small">下一页 →</button></div>'),Bpe=la('<div class="log-table-container svelte-7r6dxn"><table class="anki-table"><thead><tr><th>时间</th><th>方向</th><th>成功</th><th>失败</th><th>跳过</th><th>耗时</th></tr></thead><tbody></tbody></table></div> <div class="footer-actions svelte-7r6dxn"><!> <button class="btn btn-danger btn-small">清空日志</button></div>',1),jpe=la('<div class="sync-log-dashboard settings-group"><div class="group-header"><h4 class="section-title with-accent-bar accent-orange svelte-7r6dxn">同步日志</h4> <p>最近的同步记录</p></div> <div class="stats-summary svelte-7r6dxn"><div class="stat-card svelte-7r6dxn"><div class="stat-value svelte-7r6dxn"> </div> <div class="stat-label svelte-7r6dxn">总同步</div></div> <div class="stat-card success svelte-7r6dxn"><div class="stat-value svelte-7r6dxn"> </div> <div class="stat-label svelte-7r6dxn">成功</div></div> <div class="stat-card error svelte-7r6dxn"><div class="stat-value svelte-7r6dxn"> </div> <div class="stat-label svelte-7r6dxn">失败</div></div> <div class="stat-card svelte-7r6dxn"><div class="stat-value svelte-7r6dxn"> </div> <div class="stat-label svelte-7r6dxn">成功率</div></div></div> <!></div>');function Upe(e,t){if(new.target)return Er({component:Upe,...e});kt(t,!0);let n=Ar(t,"logs",23,()=>[]),i=Ar(t,"onClearLogs",7),a=Pn(1),r=In(()=>Math.ceil(n().length/10)),s=In(()=>n().slice(10*(bi(a)-1),10*bi(a))),o=In(()=>({totalSyncs:n().length,totalSuccess:n().reduce((e,t)=>e+t.summary.successCount,0),totalFailed:n().reduce((e,t)=>e+t.summary.failedCount,0),totalSkipped:n().reduce((e,t)=>e+t.summary.skippedCount,0),successRate:n().length>0?Math.round(n().reduce((e,t)=>e+(0===t.summary.failedCount?1:0),0)/n().length*100):0}));function l(e){$n(a,e,!0)}var c={get logs(){return n()},set logs(e=[]){n(e),hn()},get onClearLogs(){return i()},set onClearLogs(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},d=jpe(),u=Kt(Gt(d),2),h=Gt(u),p=Gt(h),g=Gt(p,!0);zt(p),Pt(2),zt(h);var v=Kt(h,2),f=Gt(v),m=Gt(f,!0);zt(f),Pt(2),zt(v);var y=Kt(v,2),b=Gt(y),w=Gt(b,!0);zt(b),Pt(2),zt(y);var k=Kt(y,2),S=Gt(k),x=Gt(S);zt(S),Pt(2),zt(k),zt(u);var _=Kt(u,2),C=e=>{var t=Bpe(),n=Qt(t),o=Gt(n),c=Kt(Gt(o));Ca(c,21,()=>bi(s),_a,(e,t)=>{var n=Ope(),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i),s=Gt(r),o=Gt(s,!0);zt(s),zt(r);var l=Kt(r),c=Gt(l,!0);zt(l);var d=Kt(l),u=Gt(d,!0);zt(d);var h=Kt(d),p=Gt(h,!0);zt(h);var g=Kt(h),v=Gt(g,!0);zt(g),zt(n),zi((e,n,i)=>{va(a,e),va(o,n),va(c,bi(t).summary.successCount),va(u,bi(t).summary.failedCount),va(p,bi(t).summary.skippedCount),va(v,i)},[()=>function(e){const t=new Date(e),n=new Date;if(t.toDateString()===n.toDateString())return t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});const i=new Date(n);return i.setDate(i.getDate()-1),t.toDateString()===i.toDateString()?"昨天 "+t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}(bi(t).timestamp),()=>"to_anki"===bi(t).direction?"→":"←",()=>function(e){const t=Math.floor(e/1e3);return t<60?`${t}秒`:`${Math.floor(t/60)}分${t%60}秒`}(bi(t).duration)]),pa(e,n)}),zt(c),zt(o),zt(n);var d=Kt(n,2),u=Gt(d),h=e=>{var t=Fpe(),n=Gt(t);n.__click=[Lpe,l,a];var i=Kt(n,2),s=Gt(i);zt(i);var o=Kt(i,2);o.__click=[Npe,l,a],zt(t),zi(()=>{var e,t;n.disabled=1===bi(a),va(s,`第 ${null!=(e=bi(a))?e:""} / ${null!=(t=bi(r))?t:""} 页`),o.disabled=bi(a)===bi(r)}),pa(e,t)};xa(u,e=>{bi(r)>1&&e(h)}),Kt(u,2).__click=function(...e){var t;null==(t=i())||t.apply(this,e)},zt(d),pa(e,t)};return xa(_,e=>{n().length>0&&e(C)}),zt(d),zi(()=>{var e;va(g,bi(o).totalSyncs),va(m,bi(o).totalSuccess),va(w,bi(o).totalFailed),va(x,`${null!=(e=bi(o).successRate)?e:""}%`)}),pa(e,d),St(c)}ia(["click"]);var Vpe=la('<div class="current-item svelte-wf4jud"><span class="label svelte-wf4jud">正在处理：</span> <span class="value svelte-wf4jud"> </span></div>'),qpe=la('<div class="deck-progress svelte-wf4jud"><span class="label svelte-wf4jud">牌组进度：</span> <span class="value svelte-wf4jud"> </span></div>'),Hpe=la('<span class="status svelte-wf4jud"> </span>'),Wpe=la('<div class="modal-footer svelte-wf4jud"><button class="btn-cancel svelte-wf4jud" aria-label="取消操作">取消</button></div>'),Gpe=la('<div class="sync-progress-modal-overlay svelte-wf4jud" role="presentation"><div class="sync-progress-modal svelte-wf4jud" role="dialog" aria-modal="true" aria-labelledby="progress-modal-title" tabindex="-1"><div class="modal-header svelte-wf4jud"><div class="operation-icon svelte-wf4jud"> </div> <h3 id="progress-modal-title" class="modal-title svelte-wf4jud"> </h3></div> <div class="modal-body svelte-wf4jud"><!> <!> <div class="progress-bar-wrapper svelte-wf4jud"><div class="progress-bar-container svelte-wf4jud"><div class="progress-bar-fill svelte-wf4jud"></div></div> <div class="progress-percentage svelte-wf4jud"> </div></div> <div class="progress-text svelte-wf4jud"> <!></div> <div class="activity-indicator svelte-wf4jud"><div class="dot svelte-wf4jud"></div> <div class="dot svelte-wf4jud"></div> <div class="dot svelte-wf4jud"></div></div></div> <!></div></div>');function Qpe(e,t){if(new.target)return Er({component:Qpe,...e});kt(t,!0);let n=Ar(t,"open",7,!1),i=Ar(t,"operation",7),a=Ar(t,"title",7),r=Ar(t,"current",7,0),s=Ar(t,"total",7,0),o=Ar(t,"status",7,""),l=Ar(t,"currentItem",7,""),c=Ar(t,"deckIndex",7,0),d=Ar(t,"totalDecks",7,0),u=Ar(t,"allowCancel",7,!1),h=Ar(t,"onCancel",7),p=Ar(t,"onClose",7);const g={fetch_models:"📋",sync_to_anki:"→",sync_from_anki:"←",batch_sync:"⇄"};let v=In(()=>s()>0?Math.min(100,Math.max(0,r()/s()*100)):0),f=In(()=>`${r()} / ${s()}`),m=In(()=>`${Math.round(bi(v))}%`);function y(){return g[i()]||"⚙️"}function b(e){"Escape"===e.key&&u()&&h()&&w()}function w(){h()&&h()(),p()&&p()()}Pr(()=>{u()&&window.addEventListener("keydown",b)}),Rr(()=>{window.removeEventListener("keydown",b)});var k={get open(){return n()},set open(e=!1){n(e),hn()},get operation(){return i()},set operation(e){i(e),hn()},get title(){return a()},set title(e){a(e),hn()},get current(){return r()},set current(e=0){r(e),hn()},get total(){return s()},set total(e=0){s(e),hn()},get status(){return o()},set status(e=""){o(e),hn()},get currentItem(){return l()},set currentItem(e=""){l(e),hn()},get deckIndex(){return c()},set deckIndex(e=0){c(e),hn()},get totalDecks(){return d()},set totalDecks(e=0){d(e),hn()},get allowCancel(){return u()},set allowCancel(e=!1){u(e),hn()},get onCancel(){return h()},set onCancel(e){h(e),hn()},get onClose(){return p()},set onClose(e){p(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},S=ha(),x=Qt(S),_=e=>{var t=Gpe(),n=Gt(t),i=Gt(n),r=Gt(i),s=Gt(r,!0);zt(r);var p=Kt(r,2),g=Gt(p,!0);zt(p),zt(i);var b=Kt(i,2),k=Gt(b),S=e=>{var t=Vpe(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n),zt(t),zi(()=>va(i,l())),pa(e,t)};xa(k,e=>{l()&&e(S)});var x=Kt(k,2),_=e=>{var t=qpe(),n=Kt(Gt(t),2),i=Gt(n);zt(n),zt(t),zi(()=>{var e,t;return va(i,`${null!=(e=c())?e:""} / ${null!=(t=d())?t:""}`)}),pa(e,t)};xa(x,e=>{d()>0&&e(_)});var C=Kt(x,2),I=Gt(C),D=Gt(I);zt(I);var T=Kt(I,2),M=Gt(T,!0);zt(T),zt(C);var A=Kt(C,2),E=Gt(A),z=Kt(E),P=e=>{var t=Hpe(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`· ${null!=(e=o())?e:""}`)}),pa(e,t)};xa(z,e=>{o()&&e(P)}),zt(A),Pt(2),zt(b);var R=Kt(b,2),$=e=>{var t=Wpe();Gt(t).__click=w,zt(t),pa(e,t)};xa(R,e=>{u()&&h()&&e($)}),zt(n),zt(t),zi(e=>{var t,n;va(s,e),va(g,a()),ja(D,`width: ${null!=(t=bi(v))?t:""}%`),va(M,bi(m)),va(E,`${null!=(n=bi(f))?n:""} `)},[y]),ur(3,t,()=>w7,()=>({duration:250})),pa(e,t)};return xa(x,e=>{n()&&e(_)}),pa(e,S),St(k)}async function Kpe(e,t,n,i,a,r,s,o){var l;$n(t,!0);try{if(n().ankiConnectService||(await n().initializeAnkiConnect(),$n(i,n().ankiConnectService,!0)),!bi(i))throw new Error("AnkiConnect 服务初始化失败");const e=await bi(i).testConnection();$n(a,e,!0),e.isConnected&&(bi(i).startConnectionMonitoring(),$n(r,bi(i).getConnectionState(),!0)),bi(s).uiCache?bi(s).uiCache.lastConnectionStatus=e:bi(s).uiCache={ankiDecks:[],ankiModels:[],lastFetchTime:"",lastConnectionStatus:e},o(!1).catch(e=>{_e.error("保存连接状态失败:",e)}),e.isConnected?(new ge.Notice("✅ 连接成功！Anki 正在运行"),setTimeout(()=>{new ge.Notice('💡 点击"获取 Anki 牌组列表"开始配置',3e3)},500)):new ge.Notice("❌ 连接失败："+((null==(l=e.error)?void 0:l.message)||"未知错误"))}catch(c){$n(a,{isConnected:!1,lastCheckTime:(new Date).toISOString(),error:{type:ice.UNKNOWN,message:c.message,suggestion:"请确保 Anki 正在运行且已安装 AnkiConnect 插件"}},!0),new ge.Notice("❌ 连接测试失败："+c.message)}finally{$n(t,!1)}}function Zpe(e,t){t(!1).catch(e=>{_e.error("保存设置失败:",e),new ge.Notice("⚠️ 保存设置失败")})}ia(["click"]),ia(["click"]),ia(["change"]),ia(["change"]);var Ype=la('<span style="opacity: 0.7;"> </span>'),Xpe=la("✅ 已连接 <!>",1),Jpe=la('<div class="error-suggestion svelte-12u73yx"> </div>'),ege=la('<div class="error-banner svelte-12u73yx"><div class="error-text svelte-12u73yx"> </div> <!></div>'),tge=(e,t,n,i)=>{bi(t).autoSync.enabled&&bi(n)?bi(n).startAutoSync():bi(n)&&bi(n).stopAutoSync(),i()},nge=(e,t)=>t(),ige=(e,t)=>t(),age=la('<div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><input type="number" class="number-input svelte-12u73yx" min="5" max="1440"/></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-12u73yx"><input type="checkbox" class="svelte-12u73yx"/> <span class="toggle-slider"></span></label></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-12u73yx"><input type="checkbox" class="svelte-12u73yx"/> <span class="toggle-slider"></span></label></div></div>',1),rge=(e,t)=>t(),sge=la("<!> <!>",1),oge=la('<div class="settings-group"><h4 class="group-title with-accent-bar accent-green"> </h4> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"><!></div></div> <div class="setting-control"><button class="btn-primary svelte-12u73yx"> </button></div></div> <!> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><input type="text" class="text-input svelte-12u73yx" placeholder="http://localhost:8765"/></div></div></div> <div class="settings-group"><h4 class="group-title with-accent-bar accent-purple"> </h4> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-12u73yx"><input type="checkbox" class="svelte-12u73yx"/> <span class="toggle-slider"></span></label></div></div> <!></div> <div class="settings-group"><h4 class="group-title with-accent-bar accent-orange"> </h4> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-12u73yx"><input type="checkbox" class="svelte-12u73yx"/> <span class="toggle-slider"></span></label></div></div></div> <!>',1),lge=la('<div class="tuanki-settings settings-section anki-connect-section svelte-12u73yx"><div class="section-header"><h3 class="section-title with-accent-bar accent-red"> </h3> <p class="section-description"> </p></div> <div class="settings-group"><div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-12u73yx"><input type="checkbox" class="svelte-12u73yx"/> <span class="toggle-slider"></span></label></div></div></div> <!> <!> <!></div>');function cge(e,t){if(new.target)return Er({component:cge,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"plugin",7),s=In(n);r().settings.ankiConnect||(r().settings.ankiConnect={enabled:!1,endpoint:"http://localhost:8765",mediaSync:{enabled:!0,largeFileThresholdMB:10,supportedTypes:["png","jpg","jpeg","gif","mp3","mp4"],createBacklinks:!0},autoSync:{enabled:!1,intervalMinutes:30,syncOnStartup:!1,onlyWhenAnkiRunning:!0,prioritizeRecent:!0},bidirectionalSync:{enabled:!1,conflictResolution:"tuanki_wins"},deckMappings:{},templateMappings:{},syncLogs:[],maxLogEntries:100,tutorialCompleted:!1,tutorialStep:0});let o=Pn(Ot(r().settings.ankiConnect)),l=Pn(Ot(r().ankiConnectService)),c=Pn(null),d=Pn(Ot([])),u=Pn(Ot([])),h=Pn(Ot([])),p=Pn(null),g=In(()=>{var e,t;return null!=(t=null==(e=bi(c))?void 0:e.isConnected)&&t}),v=Pn(!1),f=Pn(!1),m=Pn(null),y=Pn(Ot({open:!1,operation:"fetch_models",title:"",current:0,total:0,status:"",currentItem:"",deckIndex:0,totalDecks:0}));const b=Qh.getInstance();let w=Pn(!1),k=Pn(!1),S=Pn("");async function x(){if(bi(l)){$n(f,!0);try{const e=await bi(l).getAnkiDecks();$n(d,e,!0),bi(o).uiCache||(bi(o).uiCache={ankiDecks:[],ankiModels:[],lastFetchTime:(new Date).toISOString()}),bi(o).uiCache.ankiDecks=e,bi(o).uiCache.lastFetchTime=(new Date).toISOString(),await R(!1),new ge.Notice(`✅ 已获取 ${e.length} 个 Anki 牌组，请手动添加映射`)}catch(e){throw _e.error("获取 Anki 牌组失败:",e),new ge.Notice(`❌ 获取牌组失败：${e.message}`),e}finally{$n(f,!1)}}}function _(e){const t=e.ankiDeckName;bi(o).deckMappings[t]?new ge.Notice(`⚠️ 映射已存在: ${e.ankiDeckName}`):(bi(o).deckMappings={...bi(o).deckMappings,[t]:e},R(),new ge.Notice(`✅ 已添加映射: ${e.tuankiDeckName} ⇄ ${e.ankiDeckName}`))}function C(e,t){const n=bi(o).deckMappings[e];n?(bi(o).deckMappings={...bi(o).deckMappings,[e]:{...n,...t}},R()):_e.warn(`未找到映射: ${e}`)}function I(e){const{[e]:t,...n}=bi(o).deckMappings;bi(o).deckMappings=n,R()}async function D(e){var t,n,i,a;if(!bi(l))return void new ge.Notice('⚠️ 请点击"测试连接"进行初始化');const r=bi(o).deckMappings[e];if(!r)return void new ge.Notice("❌ 牌组映射不存在");const s=Date.now();try{$n(y,{open:!0,operation:"sync_to_anki",title:"导出到 Anki",current:0,total:0,status:"正在准备...",currentItem:r.tuankiDeckName,deckIndex:1,totalDecks:1},!0);const e=await bi(l).exportDeckToAnki(r.tuankiDeckId,r.ankiDeckName,(e,t,n)=>{bi(y).current=e,bi(y).total=t,bi(y).status=n||"正在同步卡片"});if(bi(y).open=!1,!e.success)throw new Error("同步失败");{r.lastSyncTime=(new Date).toISOString(),await R(!1);const t=z("to_anki",{totalCards:e.exportedCards+e.skippedCards,successCount:e.exportedCards,failedCount:0,skippedCount:e.skippedCards},Date.now()-s,e.errors.map(e=>e.message));bi(o).syncLogs.unshift(t),P(),await R(!1),new ge.Notice(`✅ "${r.tuankiDeckName}" 同步完成！\n导出: ${e.exportedCards} 张 | 跳过: ${e.skippedCards} 张`,5e3),e.errors.length>0&&_e.warn("同步过程中出现警告:",e.errors)}}catch(c){bi(y).open=!1,_e.error("同步牌组失败:",c);let e="同步失败";(null==(t=c.message)?void 0:t.includes("not running"))||(null==(n=c.message)?void 0:n.includes("未运行"))?e="Anki 未运行，请先启动 Anki":(null==(i=c.message)?void 0:i.includes("deck"))||(null==(a=c.message)?void 0:a.includes("牌组"))?e="牌组不存在或无法访问":c.message&&(e=c.message),new ge.Notice(`❌ ${e}`,5e3);const r=z("to_anki",{totalCards:0,successCount:0,failedCount:1,skippedCount:0},Date.now()-s,[c.message]);bi(o).syncLogs.unshift(r),P(),await R(!1)}}async function T(e){var t,n;if(!bi(l))return void new ge.Notice('⚠️ 请点击"测试连接"进行初始化');const i=bi(o).deckMappings[e];if(!i)return void new ge.Notice("❌ 牌组映射不存在");const a=Date.now();try{$n(y,{open:!0,operation:"batch_sync",title:"双向智能同步",current:0,total:0,status:"正在准备...",currentItem:i.tuankiDeckName,deckIndex:1,totalDecks:1},!0),new ge.Notice(`⏳ 正在双向同步 "${i.tuankiDeckName}"...`),bi(y).status="正在从 Anki 导入...";const e=await bi(l).importDeckWithTemplates(i.ankiDeckName,i.tuankiDeckId,(e,t,n)=>{bi(y).current=e,bi(y).total=t,bi(y).status=`导入: ${n||"正在导入卡片"}`});bi(y).status="正在导出到 Anki...";const t=await bi(l).exportDeckToAnki(i.tuankiDeckId,i.ankiDeckName,(e,t,n)=>{bi(y).current=e,bi(y).total=t,bi(y).status=`导出: ${n||"正在同步卡片"}`});if(bi(y).open=!1,!e.success||!t.success)throw new Error("双向同步失败");{i.lastSyncTime=(new Date).toISOString(),await R(!1);const n=z("to_anki",{totalCards:e.importedCards+t.exportedCards,successCount:e.importedCards+t.exportedCards,failedCount:0,skippedCount:e.skippedCards+t.skippedCards},Date.now()-a,[...e.errors.map(e=>e.message),...t.errors.map(e=>e.message)]);bi(o).syncLogs.unshift(n),P(),await R(!1),new ge.Notice(`✅ "${i.tuankiDeckName}" 双向同步完成！\n📥 导入: ${e.importedCards} 张 | 📤 导出: ${t.exportedCards} 张\n⏭️ 跳过: ${e.skippedCards+t.skippedCards} 张`,6e3),(e.errors.length>0||t.errors.length>0)&&_e.warn("双向同步过程中出现警告:",[...e.errors,...t.errors])}}catch(r){bi(y).open=!1,_e.error("双向同步失败:",r);let e="双向同步失败";(null==(t=r.message)?void 0:t.includes("not running"))||(null==(n=r.message)?void 0:n.includes("未运行"))?e="Anki 未运行，请先启动 Anki":r.message&&(e=r.message),new ge.Notice(`❌ ${e}`,5e3);const i=z("to_anki",{totalCards:0,successCount:0,failedCount:1,skippedCount:0},Date.now()-a,[r.message]);bi(o).syncLogs.unshift(i),P(),await R(!1)}}async function M(e,t){if(bi(l))try{$n(y,{open:!0,operation:"sync_from_anki",title:"从 Anki 导入",current:0,total:0,status:"正在准备...",currentItem:e,deckIndex:1,totalDecks:1},!0);const n=await bi(l).importDeckWithTemplates(e,t,(e,t,n)=>{bi(y).current=e,bi(y).total=t,bi(y).status=n||"正在导入卡片"});if(bi(y).open=!1,!n.success)throw new Error("导入失败");{const i=Object.values(bi(o).deckMappings).find(n=>n.ankiDeckName===e&&n.tuankiDeckId===t);if(i){const e=Object.keys(bi(o).deckMappings).find(e=>bi(o).deckMappings[e]===i);e&&C(e,{lastSyncTime:(new Date).toISOString()})}new ge.Notice(`✅ 导入完成！\n📄 卡片: ${n.importedCards} 张\n📋 模板: ${n.importedTemplates} 个\n⏭️ 跳过: ${n.skippedCards} 张`,8e3),n.errors.length>0&&(_e.warn("导入过程中出现错误:",n.errors),new ge.Notice(`⚠️ 有 ${n.errors.length} 个警告，请查看控制台`,5e3))}}catch(n){bi(y).open=!1,_e.error("导入牌组失败:",n),new ge.Notice(`❌ 导入失败：${n.message}`,8e3)}else new ge.Notice('⚠️ 请点击"测试连接"进行初始化')}async function A(e){if(!bi(l))return void new ge.Notice('⚠️ 请点击"测试连接"进行初始化');let t=Object.values(bi(o).deckMappings).filter(e=>e.enabled);if("to_anki"===e?t=t.filter(e=>"from_anki"!==e.syncDirection):"from_anki"===e&&(t=t.filter(e=>"to_anki"!==e.syncDirection)),0===t.length)return void new ge.Notice("⚠️ 没有启用的牌组映射");const n=Date.now(),i={totalDecks:t.length,successDecks:0,failedDecks:0,totalCards:0,successCards:0,skippedCards:0,errors:[]};try{$n(y,{open:!0,operation:"to_anki"===e?"sync_to_anki":"from_anki"===e?"sync_from_anki":"batch_sync",title:"to_anki"===e?"批量导出到 Anki":"from_anki"===e?"批量从 Anki 导入":"批量双向同步",current:0,total:0,status:"正在准备...",currentItem:"",deckIndex:0,totalDecks:t.length},!0);for(let n=0;n<t.length;n++){const r=t[n];bi(y).currentItem=r.tuankiDeckName,bi(y).deckIndex=n+1,bi(y).current=0,bi(y).total=0,bi(y).status="正在处理...";try{if("to_anki"===e){const e=await bi(l).exportDeckToAnki(r.tuankiDeckId,r.ankiDeckName,(e,t,n)=>{bi(y).current=e,bi(y).total=t,bi(y).status=n||"正在同步卡片"});if(!e.success)throw new Error("导出失败");i.successDecks++,i.totalCards+=e.exportedCards+e.skippedCards,i.successCards+=e.exportedCards,i.skippedCards+=e.skippedCards,r.lastSyncTime=(new Date).toISOString(),e.errors.length>0&&i.errors.push(`${r.tuankiDeckName}: ${e.errors.map(e=>e.message).join(", ")}`)}else if("from_anki"===e){const e=await bi(l).importDeckWithTemplates(r.ankiDeckName,r.tuankiDeckId,(e,t,n)=>{bi(y).current=e,bi(y).total=t,bi(y).status=n||"正在导入卡片"});if(!e.success)throw new Error("导入失败");i.successDecks++,i.totalCards+=e.importedCards+e.skippedCards,i.successCards+=e.importedCards,i.skippedCards+=e.skippedCards,r.lastSyncTime=(new Date).toISOString(),e.errors.length>0&&i.errors.push(`${r.ankiDeckName}: ${e.errors.map(e=>e.message).join(", ")}`)}}catch(a){i.failedDecks++,i.errors.push(`${r.tuankiDeckName}: ${a.message}`),_e.error(`处理牌组 "${r.tuankiDeckName}" 失败:`,a)}}bi(y).open=!1,await R(!1);const r=z("to_anki"===e?"to_anki":"from_anki",{totalCards:i.totalCards,successCount:i.successCards,failedCount:0,skippedCount:i.skippedCards},Date.now()-n,i.errors);bi(o).syncLogs.unshift(r),P(),await R(!1),0===i.failedDecks?new ge.Notice(`✅ 批量处理完成！\n成功: ${i.successDecks}/${i.totalDecks} 个牌组 | 总卡片: ${i.successCards} 张`,6e3):new ge.Notice(`⚠️ 批量处理完成（有错误）\n成功: ${i.successDecks} | 失败: ${i.failedDecks}\n详情请查看同步日志`,8e3),i.errors.length>0&&_e.warn("批量同步错误详情:",i.errors)}catch(a){bi(y).open=!1,_e.error("批量处理失败:",a),new ge.Notice(`❌ 批量处理失败：${a.message}`,5e3)}}function E(){confirm("确定要清空所有同步日志吗？")&&(bi(o).syncLogs=[],R(),new ge.Notice("✅ 日志已清空"))}function z(e,t,n,i){return{id:`sync-${Date.now()}-${Math.random().toString(36).substring(7)}`,timestamp:(new Date).toISOString(),direction:e,summary:t,duration:n,errors:i.length>0?i:void 0}}function P(){bi(o).syncLogs.length>bi(o).maxLogEntries&&(bi(o).syncLogs=bi(o).syncLogs.slice(0,bi(o).maxLogEntries))}async function R(e=!0){const t=r().settings.ankiConnect;r().settings.ankiConnect=bi(o),await r().saveSettings();const n=(null==t?void 0:t.enabled)!==bi(o).enabled,i=(null==t?void 0:t.endpoint)!==bi(o).endpoint;n?(await r().toggleAnkiConnect(bi(o).enabled),$n(l,r().ankiConnectService,!0)):i&&bi(o).enabled&&(await r().updateAnkiConnectEndpoint(bi(o).endpoint),$n(l,r().ankiConnectService,!0)),e&&new ge.Notice("✅ AnkiConnect 设置已保存")}Ti(()=>b.isPremiumActive.subscribe(e=>{$n(w,e,!0)})),Ti(()=>{const e=bi(o).enabled,t=!(!bi(l)&&!r().ankiConnectService);e&&!t?async function(){var e;try{bi(l)||$n(l,new cpe(r(),r().app,bi(o)),!0),bi(l).startConnectionMonitoring(),(null==(e=bi(o).autoSync)?void 0:e.enabled)&&bi(l).startAutoSync(),r().ankiConnectService=bi(l),new ge.Notice("✅ AnkiConnect 服务已启动")}catch(t){_e.error("[AnkiConnect] 服务启动失败:",t),new ge.Notice(`❌ 启动失败: ${t.message}`)}}():!e&&t&&async function(){try{const t=bi(l)||r().ankiConnectService;if(t){try{t.stopAutoSync()}catch(e){_e.warn("[AnkiConnect] 停止自动同步失败:",e)}try{t.stopConnectionMonitoring()}catch(e){_e.warn("[AnkiConnect] 停止连接监控失败:",e)}}$n(c,null),$n(l,null),r().ankiConnectService=null,new ge.Notice("⚠️ AnkiConnect 服务已停止")}catch(e){_e.error("[AnkiConnect] 服务停止失败:",e)}}()}),Pr(async()=>{if($n(p,new zhe(r()),!0),await bi(p).initialize().catch(e=>{_e.error("初始化备份服务失败:",e)}),bi(o).uiCache&&($n(d,bi(o).uiCache.ankiDecks||[],!0),$n(u,bi(o).uiCache.ankiModels||[],!0),bi(o).uiCache.lastConnectionStatus&&$n(c,bi(o).uiCache.lastConnectionStatus,!0),bi(o).uiCache.lastFetchTime)){const e=new Date(bi(o).uiCache.lastFetchTime);((new Date).getTime()-e.getTime())/36e5>1&&bi(d).length>0&&setTimeout(()=>{new ge.Notice("💡 牌组数据可能已过期，建议重新获取",5e3)},2e3)}(async function(){try{if(r().dataStorage){const e=await r().dataStorage.getDecks();$n(h,e,!0)}else _e.warn("⚠️ DataStorage 未初始化"),$n(h,[],!0)}catch(e){_e.error("❌ 加载 Tuanki 牌组失败:",e),$n(h,[],!0)}})().catch(e=>{_e.error("加载 Tuanki 牌组失败:",e)})});var $={get plugin(){return r()},set plugin(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},O=lge(),L=Gt(O),N=Gt(L),F=Gt(N,!0);zt(N);var B=Kt(N,2),j=Gt(B,!0);zt(B),zt(L);var U=Kt(L,2),V=Gt(U),q=Gt(V),H=Gt(q),W=Gt(H,!0);zt(H);var G=Kt(H,2),Q=Gt(G,!0);zt(G),zt(q);var K=Kt(q,2),Z=Gt(K),Y=Gt(Z);Za(Y),Y.__change=[Zpe,R],Pt(2),zt(Z),zt(K),zt(V),zt(U);var X=Kt(U,2),J=e=>{var t=oge(),n=Qt(t),i=Gt(n),a=Gt(i,!0);zt(i);var u=Kt(i,2),p=Gt(u),y=Gt(p),b=Gt(y,!0);zt(y);var w=Kt(y,2),k=Gt(w),S=e=>{pa(e,ua("⏳ 测试中..."))},z=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,ua("⚪ 未测试"))},a=e=>{var t=ha(),n=Qt(t),i=e=>{var t=Xpe(),n=Kt(Qt(t)),i=e=>{var t=Ype(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`· API v${null!=(e=bi(c).apiVersion)?e:""}`)}),pa(e,t)};xa(n,e=>{bi(c).apiVersion&&e(i)}),pa(e,t)},a=e=>{pa(e,ua("❌ 未连接"))};xa(n,e=>{bi(c).isConnected?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{null===bi(c)?e(i):e(a,!1)},!0),pa(e,t)};xa(k,e=>{bi(v)?e(S):e(z,!1)}),zt(w),zt(p);var P=Kt(p,2),$=Gt(P);$.__click=[Kpe,v,r,l,c,m,o,R];var O=Gt($,!0);zt($),zt(P),zt(u);var L=Kt(u,2),N=e=>{var t=ege(),n=Gt(t),i=Gt(n,!0);zt(n);var a=Kt(n,2),r=e=>{var t=Jpe(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`💡 ${null!=(e=bi(c).error.suggestion)?e:""}`)}),pa(e,t)};xa(a,e=>{bi(c).error.suggestion&&e(r)}),zt(t),zi(()=>va(i,bi(c).error.message)),pa(e,t)};xa(L,e=>{var t;(null==(t=bi(c))?void 0:t.error)&&e(N)});var F=Kt(L,2),B=Gt(F),j=Gt(B),U=Gt(j,!0);zt(j);var V=Kt(j,2),q=Gt(V,!0);zt(V),zt(B);var H=Kt(B,2),W=Gt(H);Za(W),zt(H),zt(F),zt(n);var G=Kt(n,2),Q=Gt(G),K=Gt(Q,!0);zt(Q);var Z=Kt(Q,2),Y=Gt(Z),X=Gt(Y),J=Gt(X,!0);zt(X);var ee=Kt(X,2),te=Gt(ee,!0);zt(ee),zt(Y);var ne=Kt(Y,2),ie=Gt(ne),ae=Gt(ie);Za(ae),ae.__change=[tge,o,l,R],Pt(2),zt(ie),zt(ne),zt(Z);var re=Kt(Z,2),se=e=>{var t=age(),n=Qt(t),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var l=Kt(a,2),c=Gt(l,!0);zt(l),zt(i);var d=Kt(i,2),u=Gt(d);Za(u),zt(d),zt(n);var h=Kt(n,2),p=Gt(h),g=Gt(p),v=Gt(g,!0);zt(g);var f=Kt(g,2),m=Gt(f,!0);zt(f),zt(p);var y=Kt(p,2),b=Gt(y),w=Gt(b);Za(w),w.__change=[nge,R],Pt(2),zt(b),zt(y),zt(h);var k=Kt(h,2),S=Gt(k),x=Gt(S),_=Gt(x,!0);zt(x);var C=Kt(x,2),I=Gt(C,!0);zt(C),zt(S);var D=Kt(S,2),T=Gt(D),M=Gt(T);Za(M),M.__change=[ige,R],Pt(2),zt(T),zt(D),zt(k),zi((e,t,n,i,a,s)=>{va(r,e),va(c,t),va(v,n),va(m,i),va(_,a),va(I,s)},[()=>bi(s)("annotation.sync.syncInterval.label"),()=>bi(s)("annotation.sync.syncInterval.description"),()=>bi(s)("dataManagement.backup.auto.triggers.onStartup"),()=>bi(s)("dataManagement.backup.auto.triggers.onStartupDesc"),()=>bi(s)("annotation.monitoring.title"),()=>bi(s)("annotation.sync.autoSync.description")]),na("blur",u,()=>R()),pr(u,()=>bi(o).autoSync.intervalMinutes,e=>bi(o).autoSync.intervalMinutes=e),fr(w,()=>bi(o).autoSync.syncOnStartup,e=>bi(o).autoSync.syncOnStartup=e),fr(M,()=>bi(o).autoSync.enableFileWatcher,e=>bi(o).autoSync.enableFileWatcher=e),pa(e,t)};xa(re,e=>{bi(o).autoSync.enabled&&e(se)}),zt(G);var oe=Kt(G,2),le=Gt(oe),ce=Gt(le,!0);zt(le);var de=Kt(le,2),ue=Gt(de),he=Gt(ue),pe=Gt(he,!0);zt(he);var ge=Kt(he,2),ve=Gt(ge,!0);zt(ge),zt(ue);var fe=Kt(ue,2),me=Gt(fe),ye=Gt(me);Za(ye),ye.__change=[rge,R],Pt(2),zt(me),zt(fe),zt(de),zt(oe);var be=Kt(oe,2),we=e=>{var t=sge(),n=Qt(t);$pe(n,{get ankiDecks(){return bi(d)},get tuankiDecks(){return bi(h)},get isFetchingDecks(){return bi(f)},get settings(){return bi(o)},get mappings(){return bi(o).deckMappings},onFetchDecks:x,onAddMapping:_,onUpdateMapping:C,onRemoveMapping:I,onSync:D,onImport:M,onBidirectionalSync:T,onBatchSync:A}),Upe(Kt(n,2),{get logs(){return bi(o).syncLogs},onClearLogs:E}),pa(e,t)};xa(be,e=>{bi(g)&&e(we)}),zi((e,t,n,i,r,s,o,l,c,d,u)=>{va(a,e),va(b,t),$.disabled=bi(v),va(O,n),va(U,i),va(q,r),va(K,s),va(J,o),va(te,l),va(ce,c),va(pe,d),va(ve,u)},[()=>bi(s)("ankiConnect.connection.title"),()=>bi(s)("ankiConnect.connection.status"),()=>bi(v)?bi(s)("ankiConnect.connection.statusLabel.testing"):bi(s)("ankiConnect.connection.testConnection"),()=>bi(s)("ankiConnect.connection.address.label"),()=>bi(s)("ankiConnect.connection.address.description"),()=>bi(s)("ankiConnect.autoSync.title"),()=>bi(s)("ankiConnect.autoSync.enable"),()=>bi(s)("ankiConnect.autoSync.enableDesc"),()=>bi(s)("ankiConnect.sectionSync.title"),()=>bi(s)("ankiConnect.sectionSync.enable"),()=>bi(s)("ankiConnect.sectionSync.enableDesc")]),na("blur",W,()=>R()),pr(W,()=>bi(o).endpoint,e=>bi(o).endpoint=e),fr(ae,()=>bi(o).autoSync.enabled,e=>bi(o).autoSync.enabled=e),fr(ye,()=>bi(o).mediaSync.enabled,e=>bi(o).mediaSync.enabled=e),pa(e,t)};xa(X,e=>{bi(o).enabled&&e(J)});var ee=Kt(X,2);Qpe(ee,{get open(){return bi(y).open},get operation(){return bi(y).operation},get title(){return bi(y).title},get current(){return bi(y).current},get total(){return bi(y).total},get status(){return bi(y).status},get currentItem(){return bi(y).currentItem},get deckIndex(){return bi(y).deckIndex},get totalDecks(){return bi(y).totalDecks}}),s3(Kt(ee,2),{featureId:bi(S),get visible(){return bi(k)},onClose:()=>$n(k,!1)}),zt(O),zi((e,t,n,i)=>{va(F,e),va(j,t),va(W,n),va(Q,i)},[()=>bi(s)("ankiConnect.title"),()=>bi(s)("ankiConnect.description"),()=>bi(s)("ankiConnect.enable.label"),()=>bi(s)("ankiConnect.enable.description")]),fr(Y,()=>bi(o).enabled,e=>bi(o).enabled=e),pa(e,O);var te=St($);return a(),te}ia(["change","click"]);var dge=(e=>(e.INVALID_FORMAT="INVALID_FORMAT",e.INCOMPLETE_DATA="INCOMPLETE_DATA",e.MALFORMED_STRUCTURE="MALFORMED_STRUCTURE",e.SIGNATURE_VERIFICATION_FAILED="SIGNATURE_VERIFICATION_FAILED",e.EXPIRED_CODE="EXPIRED_CODE",e.PRODUCT_ID_MISMATCH="PRODUCT_ID_MISMATCH",e.UNSUPPORTED_VERSION="UNSUPPORTED_VERSION",e.DEVICE_FINGERPRINT_MISMATCH="DEVICE_FINGERPRINT_MISMATCH",e.DEVICE_LIMIT_EXCEEDED="DEVICE_LIMIT_EXCEEDED",e.ATTEMPT_LIMIT_EXCEEDED="ATTEMPT_LIMIT_EXCEEDED",e.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",e.CRYPTO_ERROR="CRYPTO_ERROR",e.STORAGE_ERROR="STORAGE_ERROR",e.NETWORK_ERROR="NETWORK_ERROR",e.UNKNOWN_ERROR="UNKNOWN_ERROR",e))(dge||{});const uge={MIN_LENGTH:200,MAX_LENGTH:2e3,OPTIMAL_LENGTH_RANGE:[500,800],FULL_PATTERN:/^[A-Za-z0-9+/=]+\.[A-Za-z0-9+/=]+$/,WHITESPACE_PATTERN:/\s+/g},hge={PLACEHOLDER:"请粘贴完整的激活码（约500-800字符）",TEXTAREA_ROWS:4,MAX_LENGTH_ATTR:2500},pge={DEBOUNCE_MS:300};dge.INVALID_FORMAT,dge.INCOMPLETE_DATA,dge.SIGNATURE_VERIFICATION_FAILED,dge.EXPIRED_CODE,dge.PRODUCT_ID_MISMATCH,dge.DEVICE_FINGERPRINT_MISMATCH,dge.ATTEMPT_LIMIT_EXCEEDED,dge.CRYPTO_ERROR,dge.STORAGE_ERROR,dge.UNKNOWN_ERROR,dge.MALFORMED_STRUCTURE,dge.UNSUPPORTED_VERSION,dge.DEVICE_LIMIT_EXCEEDED,dge.RATE_LIMIT_EXCEEDED,dge.NETWORK_ERROR;const gge="激活码是一个长字符串，通常包含500-800个字符，由两部分组成并用点号分隔",vge=["请完整复制激活码，包括所有字符","激活码区分大小写，请确保准确输入","如果激活码很长，建议使用粘贴功能","激活码只能在授权设备上使用"],fge=["如果提示格式错误，请检查是否完整复制了激活码","如果提示已过期，请联系客服获取新的激活码","如果提示设备不匹配，可能需要进行设备迁移","如果多次尝试失败，请等待15分钟后重试"],mge={email:"tutaoyuan8@outlook.com",subject:"Tuanki插件激活问题咨询",github:"https://github.com/zhuzhige123/obsidian---Tuanki"};function yge(e){return e.replace(uge.WHITESPACE_PATTERN,"").trim()}const bge={bolt:"M349.4 44.6c5.9-13.7 1.5-29.7-10.6-38.5s-28.6-8-39.9 1.8l-256 224c-10 8.8-13.6 22.9-8.9 35.3S50.7 288 64 288H175.5L98.6 467.4c-5.9 13.7-1.5 29.7 10.6 38.5s28.6 8 39.9-1.8l256-224c10-8.8 13.6-22.9 8.9-35.3s-16.6-20.7-30-20.7H272.5L349.4 44.6z",brain:"M184 0c30.9 0 56 25.1 56 56V456c0 30.9-25.1 56-56 56c-28.9 0-52.7-21.9-55.7-50.1c-5.2 1.4-10.7 2.1-16.3 2.1c-35.3 0-64-28.7-64-64c0-7.4 1.3-14.6 3.6-21.2C21.4 367.4 0 338.2 0 304c0-31.9 18.7-59.5 45.8-72.3C37.1 220.8 32 207 32 192c0-30.7 21.6-56.3 50.4-62.6C80.8 123.9 80 118 80 112c0-29.9 20.6-55.1 48.3-62.1C131.3 21.9 155.1 0 184 0zM328 0c28.9 0 52.6 21.9 55.7 49.9c27.8 7 48.3 32.1 48.3 62.1c0 6-.8 11.9-2.4 17.4c28.8 6.2 50.4 31.9 50.4 62.6c0 15-5.1 28.8-13.8 39.7C493.3 244.5 512 272.1 512 304c0 34.2-21.4 63.4-51.6 74.8c2.3 6.6 3.6 13.8 3.6 21.2c0 35.3-28.7 64-64 64c-5.6 0-11.1-.7-16.3-2.1c-3 28.2-26.8 50.1-55.7 50.1c-30.9 0-56-25.1-56-56V56c0-30.9 25.1-56 56-56z",play:"M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z",pause:"M48 64C21.5 64 0 85.5 0 112V400c0 26.5 21.5 48 48 48H80c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H48zm192 0c-26.5 0-48 21.5-48 48V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H240z",cog:"M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336c44.2 0 80-35.8 80-80s-35.8-80-80-80s-80 35.8-80 80s35.8 80 80 80z",check:"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z",arrowLeft:"M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z",refresh:"M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160H336c-17.7 0-32 14.3-32 32s14.3 32 32 32H463.5c0 0 0 0 0 0h.4c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v51.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.3c-5 1.5-9.8 4.2-13.7 8.2c-4 4-6.7 8.8-8.1 14c-.3 1.2-.6 2.5-.8 3.8c-.3 1.7-.4 3.4-.4 5.1V448c0 17.7 14.3 32 32 32s32-14.3 32-32V396.9l17.6 17.5 0 0c87.5 87.4 229.3 87.4 316.7 0c24.4-24.4 42.1-53.1 52.9-83.7c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0L125.7 352H176c17.7 0 32-14.3 32-32s-14.3-32-32-32H48.4c-2.2 0-4.2 .9-5.7 2.4S40.2 297.1 39 289.3z",chartBar:"M32 32c17.7 0 32 14.3 32 32V400c0 8.8 7.2 16 16 16H560c17.7 0 32 14.3 32 32s-14.3 32-32 32H80c-44.2 0-80-35.8-80-80V64C0 46.3 14.3 32 32 32zM160 224c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V256c0-17.7 14.3-32 32-32zm128-64V320c0 17.7-14.3 32-32 32s-32-14.3-32-32V160c0-17.7 14.3-32 32-32s32 14.3 32 32zm64 32c17.7 0 32 14.3 32 32v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32zM480 96V320c0 17.7-14.3 32-32 32s-32-14.3-32-32V96c0-17.7 14.3-32 32-32s32 14.3 32 32z",chartLine:"M64 64c0-17.7-14.3-32-32-32S0 46.3 0 64V400c0 44.2 35.8 80 80 80H576c17.7 0 32-14.3 32-32s-14.3-32-32-32H80c-8.8 0-16-7.2-16-16V64zm406.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L320 210.7l-57.4-57.4c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L240 221.3l57.4 57.4c12.5 12.5 32.8 12.5 45.3 0L470.6 150.6z",eye:"M288 80c-65.2 0-118.8 29.6-159.9 67.7C89.6 183.5 63 226 49.4 256c13.6 30 40.2 72.5 78.6 108.3C169.2 402.4 222.8 432 288 432s118.8-29.6 159.9-67.7C486.4 328.5 513 286 526.6 256c-13.6-30-40.2-72.5-78.6-108.3C406.8 109.6 353.2 80 288 80zM95.4 112.6C142.5 68.8 207.2 32 288 32s145.5 36.8 192.6 80.6c46.8 43.5 78.1 95.4 93 131.1c3.3 7.9 3.3 16.7 0 24.6c-14.9 35.7-46.2 87.7-93 131.1C433.5 443.2 368.8 480 288 480s-145.5-36.8-192.6-80.6C48.6 355.9 17.3 303.9 2.4 268.3c-3.3-7.9-3.3-16.7 0-24.6C17.3 208.1 48.6 156.1 95.4 112.6zM288 336c44.2 0 80-35.8 80-80s-35.8-80-80-80c-.7 0-1.3 0-2 .1c1.3 5.1 2 10.5 2 16.1c0 35.3-28.7 64-64 64c-5.6 0-11.1-.7-16.1-2c-.1 .7-.1 1.3-.1 2c0 44.2 35.8 80 80 80z",eyeSlash:"M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c8.4-19.3 10.6-41.4 4.8-63.3c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zM373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.5-32.5L373 389.9z",copy:"M224 0c-35.3 0-64 28.7-64 64V288c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V64c0-35.3-28.7-64-64-64H224zM64 160c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64H288c35.3 0 64-28.7 64-64V416H288v32H64V224H96V160H64z",file:"M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z"};function wge(e,t={}){const{size:n=16,className:i="",color:a="currentColor"}=t;return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="${n}" height="${n}" fill="${a}" ${i?`class="${i}"`:""}>\n    <path d="${bge[e]}" fill="${a}"/>\n  </svg>`}function kge(e,t,n,i){$n(t,e.target.value,!0),bi(n)&&$n(n,null),i()}async function Sge(e,t,n,i,a,r,s,o,l,c,d,u,h,p,g,v,f,m){if(!bi(t))return;const y=await As.canAttemptActivation();if(!y.canAttempt)return $n(n,y.error||"激活尝试次数过多",!0),void $n(i,"invalid");$n(a,!0),$n(n,null),$n(r,!1);try{const e=await Es.activateLicense(bi(s),bi(o));e.cloudInfo&&$n(l,e.cloudInfo,!0),await As.recordAttempt(e.success),e.success&&e.licenseInfo?(c().settings.license=e.licenseInfo,await d()(),$n(r,!0),$n(u,""),$n(o,""),$n(h,""),$n(i,"idle"),$n(p,"idle"),g()&&g()(e.licenseInfo),v()):($n(n,e.error||"激活失败",!0),$n(i,"invalid"),f()&&f()(e.error),await m())}catch(b){$n(n,b instanceof Error?b.message:"激活过程中发生未知错误",!0),$n(i,"invalid"),await As.recordAttempt(!1)}finally{$n(a,!1)}}function xge(e,t){$n(t,!bi(t))}function _ge(e,t,n,i,a,r,s){$n(t,""),$n(n,""),$n(i,""),$n(a,"idle"),$n(r,"idle"),$n(s,null)}function Cge(e,t,n,i){bi(t)?$n(n,bi(i)?"valid":"invalid",!0):$n(n,"idle")}async function Ige(e,t){var n;if(null==(n=bi(t))?void 0:n.activationCode)try{await navigator.clipboard.writeText(bi(t).activationCode),ih("激活码已复制到剪贴板","success")}catch(i){_e.error("复制失败:",i);try{const e=document.createElement("textarea");e.value=bi(t).activationCode,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),ih("激活码已复制到剪贴板","success")}catch(a){_e.error("复制失败（回退方式也失败）:",a),ih("复制失败，请手动复制","error")}}}var Dge=la('<p class="success-details svelte-1qv5zid"> </p>'),Tge=la('<p class="success-details svelte-1qv5zid"> </p>'),Mge=(e,t)=>$n(t,!bi(t)),Age=la('<div class="activation-code-section svelte-1qv5zid"><div class="activation-code-header svelte-1qv5zid"><span class="code-label svelte-1qv5zid">激活码</span> <div class="code-actions svelte-1qv5zid"><button class="action-button svelte-1qv5zid"><!></button> <button class="action-button svelte-1qv5zid" title="复制激活码"><!></button></div></div> <div class="activation-code-display svelte-1qv5zid"><code> </code></div></div>'),Ege=la('<p class="success-details svelte-1qv5zid"> </p> <p class="success-details svelte-1qv5zid"> </p> <!> <!> <!>',1),zge=la('<div class="activation-success-state svelte-1qv5zid"><div class="success-content svelte-1qv5zid"><h4 class="success-title svelte-1qv5zid">许可证已激活</h4> <!></div></div>'),Pge=la('<span class="indicator validating">验证中...</span>'),Rge=la('<span class="indicator valid">格式正确</span>'),$ge=la('<span class="indicator invalid">格式错误</span>'),Oge=la('<button class="clear-button svelte-1qv5zid" title="清除输入">清除</button>'),Lge=la('<span class="format-hint svelte-1qv5zid"><!></span>'),Nge=la('<div class="input-feedback svelte-1qv5zid"><span> </span> <!></div>'),Fge=la('<span class="hint-valid svelte-1qv5zid">邮箱格式正确</span>'),Bge=la('<span class="hint-invalid svelte-1qv5zid">请输入有效的邮箱地址</span>'),jge=la('<p class="email-hint svelte-1qv5zid"><!></p>'),Uge=la('<span class="hint-valid svelte-1qv5zid">邮箱匹配</span>'),Vge=la('<span class="hint-invalid svelte-1qv5zid">两次输入的邮箱不一致</span>'),qge=la('<p class="email-hint svelte-1qv5zid"><!></p>'),Hge=la('<span class="loading-spinner svelte-1qv5zid"></span> 激活中...',1),Wge=la('<div class="activation-form svelte-1qv5zid"><div class="input-section svelte-1qv5zid"><label for="activation-code" class="input-label svelte-1qv5zid">激活码 <span class="input-hint svelte-1qv5zid">请粘贴完整的激活码</span></label> <div><textarea id="activation-code" class="activation-textarea svelte-1qv5zid"></textarea> <div class="validation-indicator svelte-1qv5zid"><!></div> <!></div> <!></div> <div class="input-section svelte-1qv5zid"><label for="email" class="input-label svelte-1qv5zid">邮箱地址 <span class="input-hint svelte-1qv5zid">此邮箱将永久绑定到激活码</span></label> <input id="email" type="email" placeholder="请输入您的邮箱" autocomplete="email"/> <!></div> <div class="input-section svelte-1qv5zid"><label for="email-confirm" class="input-label svelte-1qv5zid">确认邮箱 <span class="input-hint svelte-1qv5zid">请再次输入邮箱</span></label> <input id="email-confirm" type="email" placeholder="请再次输入邮箱" autocomplete="email"/> <!></div> <div class="action-section svelte-1qv5zid"><button><!></button> <button class="help-button svelte-1qv5zid"> </button></div></div>'),Gge=la('<li class="svelte-1qv5zid"> </li>'),Qge=la('<li class="svelte-1qv5zid"> </li>'),Kge=la('<div class="help-section svelte-1qv5zid"><div class="help-content svelte-1qv5zid"><h4 class="svelte-1qv5zid">激活码格式说明</h4> <p class="svelte-1qv5zid"> </p> <h4 class="svelte-1qv5zid">输入提示</h4> <ul class="svelte-1qv5zid"></ul> <h4 class="svelte-1qv5zid">故障排除</h4> <ul class="svelte-1qv5zid"></ul> <h4 class="svelte-1qv5zid">联系支持</h4> <p class="svelte-1qv5zid">如需帮助，请联系： <a class="svelte-1qv5zid"> </a></p></div></div>'),Zge=la('<div class="remaining-attempts svelte-1qv5zid"> </div>'),Yge=la('<div class="error-section svelte-1qv5zid"><div class="error-header svelte-1qv5zid"><span class="error-title svelte-1qv5zid">激活失败</span></div> <div class="error-message svelte-1qv5zid"> </div> <!></div>'),Xge=la('<div class="cloud-notice svelte-1qv5zid">由于设备数量已满，已自动移除最久未使用的设备</div>'),Jge=la('<div class="cloud-notice svelte-1qv5zid"> </div>'),eve=la('<div class="success-section svelte-1qv5zid"><div class="success-header svelte-1qv5zid"><span class="success-title svelte-1qv5zid">激活成功</span></div> <div class="success-message svelte-1qv5zid">许可证已成功激活，高级功能已启用</div> <!> <!></div>'),tve=la('<div><div class="form-header svelte-1qv5zid"><h3 class="form-title svelte-1qv5zid">许可证激活</h3> <p class="form-description svelte-1qv5zid">输入激活码和邮箱以解锁高级功能</p></div> <!> <!> <!> <!></div>');function nve(e,t){if(new.target)return Er({component:nve,...e});kt(t,!0);let n=Ar(t,"plugin",7),i=Ar(t,"onSave",7),a=Ar(t,"onActivationSuccess",7),r=Ar(t,"onActivationError",7),s=Ar(t,"standalone",7,!0),o=Pn(""),l=Pn(""),c=Pn(""),d=Pn(!1),u=Pn("idle"),h=Pn("idle"),p=Pn(null),g=Pn(!1),v=Pn(!1),f=Pn(null),m=Pn(null),y=Pn(!1),b=In(()=>yge(bi(o))),w=In(()=>!!bi(b)&&function(e){const t=e.trim().length;return t>=uge.MIN_LENGTH&&t<=uge.MAX_LENGTH}(bi(b))),k=In(()=>!!bi(b)&&function(e){return uge.FULL_PATTERN.test(e.trim())}(bi(b))),S=In(()=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(bi(l))),x=In(()=>bi(l)&&bi(c)&&bi(l).toLowerCase().trim()===bi(c).toLowerCase().trim()),_=In(()=>bi(w)&&bi(k)&&bi(S)&&bi(x)&&!bi(d)),C=In(()=>bi(b).length),I=In(()=>{const[e,t]=uge.OPTIMAL_LENGTH_RANGE;return bi(C)>=e&&bi(C)<=t}),D=In(()=>{var e;return(null==(e=n().settings)?void 0:e.license)||null}),T=In(()=>{var e;return(null==(e=bi(D))?void 0:e.isActivated)||!1});function M(e){setTimeout(()=>{$n(o,yge(bi(o)),!0),A()},0)}function A(){bi(b)?($n(u,"validating"),setTimeout(()=>{bi(w)&&bi(k)?$n(u,"valid"):$n(u,"invalid")},pge.DEBOUNCE_MS)):$n(u,"idle")}function E(){}async function z(){try{const e=await As.canAttemptActivation();$n(f,e.canAttempt?5:0,!0)}catch(e){_e.warn("无法获取剩余尝试次数:",e),$n(f,null)}}Ti(()=>{z()});var P={get plugin(){return n()},set plugin(e){n(e),hn()},get onSave(){return i()},set onSave(e){i(e),hn()},get onActivationSuccess(){return a()},set onActivationSuccess(e){a(e),hn()},get onActivationError(){return r()},set onActivationError(e){r(e),hn()},get standalone(){return s()},set standalone(e=!0){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},R=tve();let $;var O=Kt(Gt(R),2),L=e=>{var t=zge(),n=Gt(t),i=Kt(Gt(n),2),a=e=>{var t=Ege(),n=Qt(t),i=Gt(n);zt(n);var a=Kt(n,2),r=Gt(a);zt(a);var s=Kt(a,2),o=e=>{var t=Dge(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`绑定邮箱: ${null!=(e=bi(D).boundEmail)?e:""}`)}),pa(e,t)};xa(s,e=>{bi(D).boundEmail&&e(o)});var l=Kt(s,2),c=e=>{var t=Tge(),n=Gt(t);zt(t),zi(()=>{var e,t;return va(n,`已激活设备: ${null!=(e=bi(D).cloudSync.devicesUsed)?e:""}/${null!=(t=bi(D).cloudSync.devicesMax||5)?t:""}`)}),pa(e,t)};xa(l,e=>{var t;(null==(t=bi(D).cloudSync)?void 0:t.devicesUsed)&&e(c)});var d=Kt(l,2),u=e=>{var t=Age(),n=Gt(t),i=Kt(Gt(n),2),a=Gt(i);a.__click=[Mge,y],Aa(Gt(a),()=>bi(y)?wge("file",{size:14}):wge("eye",{size:14})),zt(a);var r=Kt(a,2);r.__click=[Ige,D],Aa(Gt(r),()=>wge("copy",{size:14})),zt(r),zt(i),zt(n);var s=Kt(n,2),o=Gt(s);let l;var c=Gt(o,!0);zt(o),zt(s),zt(t),zi((e,t)=>{er(a,"title",bi(y)?"收起":"查看激活码"),l=Fa(o,1,"activation-code-text svelte-1qv5zid",null,l,e),va(c,t)},[()=>({full:bi(y)}),()=>function(e,t=!1){var n;return e?t?(null==(n=e.match(/.{1,64}/g))?void 0:n.join("\n"))||e:e.length>20?`${e.substring(0,20)}...`:e:""}(bi(D).activationCode,bi(y))]),pa(e,t)};xa(d,e=>{bi(D).activationCode&&e(u)}),zi(e=>{va(i,`激活时间: ${null!=e?e:""}`),va(r,"许可证类型: "+("lifetime"===bi(D).licenseType?"终身许可":"订阅许可"))},[()=>new Date(bi(D).activatedAt).toLocaleString()]),pa(e,t)};xa(i,e=>{bi(D)&&e(a)}),zt(n),zt(t),pa(e,t)},N=e=>{var t=Wge(),s=Gt(t),f=Kt(Gt(s),2);let y;var D=Gt(f);jn(D),D.__input=[kge,o,p,A];var T=Kt(D,2),P=Gt(T),R=e=>{pa(e,Pge())},$=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,Rge())},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,$ge())};xa(n,e=>{"invalid"===bi(u)&&e(i)},!0),pa(e,t)};xa(n,e=>{"valid"===bi(u)?e(i):e(a,!1)},!0),pa(e,t)};xa(P,e=>{"validating"===bi(u)?e(R):e($,!1)}),zt(T);var O=Kt(T,2),L=e=>{var t=Oge();t.__click=[_ge,o,l,c,u,h,p],zi(()=>t.disabled=bi(d)),pa(e,t)};xa(O,e=>{bi(o)&&e(L)}),zt(f);var N=Kt(f,2),F=e=>{var t=Nge(),n=Gt(t);let i;var a=Gt(n);zt(n);var r=Kt(n,2),s=e=>{var t=Lge(),n=Gt(t),i=e=>{pa(e,ua("格式正确"))},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,ua("长度不符合要求"))},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,ua("格式不正确"))};xa(n,e=>{bi(k)||e(i)},!0),pa(e,t)};xa(n,e=>{bi(w)?e(a,!1):e(i)},!0),pa(e,t)};xa(n,e=>{bi(w)&&bi(k)?e(i):e(a,!1)}),zt(t),pa(e,t)};xa(r,e=>{bi(b)&&e(s)}),zt(t),zi(e=>{var t;i=Fa(n,1,"character-count svelte-1qv5zid",null,i,e),va(a,`${null!=(t=bi(C))?t:""} / ${uge.MAX_LENGTH} 字符`)},[()=>({optimal:bi(I)})]),pa(e,t)};xa(N,e=>{e(F)}),zt(s);var B=Kt(s,2),j=Kt(Gt(B),2);let U;Za(j),j.__input=[Cge,l,h,S];var V=Kt(j,2),q=e=>{var t=jge(),n=Gt(t),i=e=>{pa(e,Fge())},a=e=>{pa(e,Bge())};xa(n,e=>{bi(S)?e(i):e(a,!1)}),zt(t),pa(e,t)};xa(V,e=>{bi(l)&&e(q)}),zt(B);var H=Kt(B,2),W=Kt(Gt(H),2);let G;Za(W);var Q=Kt(W,2),K=e=>{var t=qge(),n=Gt(t),i=e=>{pa(e,Uge())},a=e=>{pa(e,Vge())};xa(n,e=>{bi(x)?e(i):e(a,!1)}),zt(t),pa(e,t)};xa(Q,e=>{bi(c)&&e(K)}),zt(H);var Z=Kt(H,2),Y=Gt(Z);let X;Y.__click=[Sge,_,p,u,d,g,b,l,m,n,i,o,c,h,a,E,r,z];var J=Gt(Y),ee=e=>{var t=Hge();Pt(),pa(e,t)},te=e=>{pa(e,ua("激活许可证"))};xa(J,e=>{bi(d)?e(ee):e(te,!1)}),zt(Y);var ne=Kt(Y,2);ne.__click=[xge,v];var ie=Gt(ne,!0);zt(ne),zt(Z),zt(t),zi((e,t,n,i)=>{y=Fa(f,1,"input-container svelte-1qv5zid",null,y,e),er(D,"placeholder",hge.PLACEHOLDER),er(D,"rows",hge.TEXTAREA_ROWS),er(D,"maxlength",hge.MAX_LENGTH_ATTR),D.disabled=bi(d),U=Fa(j,1,"email-input svelte-1qv5zid",null,U,t),j.disabled=bi(d),G=Fa(W,1,"email-input svelte-1qv5zid",null,G,n),W.disabled=bi(d),X=Fa(Y,1,"activate-button svelte-1qv5zid",null,X,i),Y.disabled=!bi(_),ne.disabled=bi(d),va(ie,bi(v)?"隐藏帮助":"显示帮助")},[()=>({valid:"valid"===bi(u),invalid:"invalid"===bi(u),validating:"validating"===bi(u)}),()=>({valid:"valid"===bi(h),invalid:"invalid"===bi(h)}),()=>({valid:bi(x),invalid:bi(c)&&!bi(x)}),()=>({loading:bi(d)})]),na("paste",D,M),pr(D,()=>bi(o),e=>$n(o,e)),pr(j,()=>bi(l),e=>$n(l,e)),pr(W,()=>bi(c),e=>$n(c,e)),pa(e,t)};xa(O,e=>{bi(T)?e(L):e(N,!1)});var F=Kt(O,2),B=e=>{var t=Kge(),n=Gt(t),i=Kt(Gt(n),2),a=Gt(i,!0);zt(i);var r=Kt(i,4);Ca(r,21,()=>vge,_a,(e,t)=>{var n=Gge(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(r);var s=Kt(r,4);Ca(s,21,()=>fge,_a,(e,t)=>{var n=Qge(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(s);var o=Kt(s,4),l=Kt(Gt(o)),c=Gt(l,!0);zt(l),zt(o),zt(n),zt(t),zi(()=>{va(a,gge),er(l,"href",`mailto:${mge.email}?subject=${mge.subject}`),va(c,mge.email)}),pa(e,t)};xa(F,e=>{bi(v)&&e(B)});var j=Kt(F,2),U=e=>{var t=Yge(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n);var a=Kt(n,2),r=e=>{var t=Zge(),n=Gt(t);zt(t),zi(()=>{var e;return va(n,`剩余尝试次数：${null!=(e=bi(f))?e:""}`)}),pa(e,t)};xa(a,e=>{null!==bi(f)&&bi(f)>0&&e(r)}),zt(t),zi(()=>va(i,bi(p))),pa(e,t)};xa(j,e=>{bi(p)&&e(U)});var V=Kt(j,2),q=e=>{var t=eve(),n=Kt(Gt(t),4),i=e=>{pa(e,Xge())};xa(n,e=>{var t;(null==(t=bi(m))?void 0:t.replacedOldDevice)&&e(i)});var a=Kt(n,2),r=e=>{var t=Jge(),n=Gt(t);zt(t),zi(()=>{var e,t;return va(n,`当前已激活设备：${null!=(e=bi(m).devicesUsed)?e:""}/${null!=(t=bi(m).devicesMax||5)?t:""}`)}),pa(e,t)};xa(a,e=>{var t;void 0!==(null==(t=bi(m))?void 0:t.devicesUsed)&&e(r)}),zt(t),pa(e,t)};return xa(V,e=>{bi(g)&&e(q)}),zt(R),zi(e=>$=Fa(R,1,"enhanced-activation-form svelte-1qv5zid",null,$,e),[()=>({standalone:s()})]),pa(e,R),St(P)}ia(["click","input"]);class ive extends ge.Modal{constructor(e,t,n){super(e),oe(this,"plugin"),oe(this,"onSave"),oe(this,"component"),this.plugin=t,this.onSave=n}onOpen(){const{contentEl:e}=this;e.empty(),this.modalEl.addClass("tuanki-activation-modal"),this.component=new nve({target:e,props:{plugin:this.plugin,onSave:this.onSave,standalone:!1,onActivationSuccess:e=>{setTimeout(()=>{this.close()},2e3)}}})}onClose(){const{contentEl:e}=this;this.component&&this.component.$destroy(),e.empty()}}function ave(e,t,n){new ive(t().app,t(),n()).open()}var rve=la('<div class="activation-status-card activated svelte-kutsao"><div class="status-left svelte-kutsao"><div class="status-content svelte-kutsao"><h4 class="status-title svelte-kutsao"> </h4> <p class="status-description svelte-kutsao"><!> <!></p></div></div> <div class="status-right svelte-kutsao"><button class="manage-button svelte-kutsao"> </button></div></div>'),sve=la('<div class="activation-status-card inactive svelte-kutsao"><div class="status-left svelte-kutsao"><div class="status-content svelte-kutsao"><h4 class="status-title svelte-kutsao"> </h4> <p class="status-description svelte-kutsao"> </p> <a class="get-code-link svelte-kutsao" target="_blank" rel="noopener noreferrer"> </a></div></div> <div class="status-right svelte-kutsao"><button class="activate-trigger-button svelte-kutsao"> </button></div></div>'),ove=la('<div class="activation-modal-wrapper svelte-kutsao"><!></div>');function lve(e,t){if(new.target)return Er({component:lve,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"plugin",7),s=Ar(t,"onSave",7),o=Ar(t,"purchaseUrl",7,"https://pay.ldxp.cn/item/ned9pw"),l=In(n),c=In(()=>{var e,t;return null==(t=null==(e=r())?void 0:e.settings)?void 0:t.license}),d=In(()=>{var e,t;return(null==(e=bi(c))?void 0:e.isActivated)&&(null==(t=bi(c))?void 0:t.activationCode)});var u={get plugin(){return r()},set plugin(e){r(e),hn()},get onSave(){return s()},set onSave(e){s(e),hn()},get purchaseUrl(){return o()},set purchaseUrl(e="https://pay.ldxp.cn/item/ned9pw"){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},h=ove(),p=Gt(h),g=e=>{var t=rve(),n=Gt(t),i=Gt(n),a=Gt(i),o=Gt(a,!0);zt(a);var d=Kt(a,2),u=Gt(d),h=e=>{var t=ua();zi(e=>{var n;return va(t,`${null!=e?e:""}: ${null!=(n=bi(c).boundEmail)?n:""}`)},[()=>bi(l)("license.boundEmail")]),pa(e,t)};xa(u,e=>{bi(c).boundEmail&&e(h)});var p=Kt(u,2),g=e=>{var t=ua();zi(e=>{var n,i;return va(t,`· ${null!=e?e:""}: ${null!=(n=bi(c).cloudSync.devicesUsed)?n:""}/${null!=(i=bi(c).cloudSync.devicesMax||5)?i:""}`)},[()=>bi(l)("license.activatedDevices")]),pa(e,t)};xa(p,e=>{var t;(null==(t=bi(c).cloudSync)?void 0:t.devicesUsed)&&e(g)}),zt(d),zt(i),zt(n);var v=Kt(n,2),f=Gt(v);f.__click=[ave,r,s];var m=Gt(f,!0);zt(f),zt(v),zt(t),zi((e,t)=>{va(o,e),va(m,t)},[()=>bi(l)("about.license.statusActive"),()=>bi(l)("about.license.manage")]),pa(e,t)},v=e=>{var t=sve(),n=Gt(t),i=Gt(n),a=Gt(i),c=Gt(a,!0);zt(a);var d=Kt(a,2),u=Gt(d,!0);zt(d);var h=Kt(d,2),p=Gt(h);zt(h),zt(i),zt(n);var g=Kt(n,2),v=Gt(g);v.__click=[ave,r,s];var f=Gt(v,!0);zt(v),zt(g),zt(t),zi((e,t,n,i)=>{va(c,e),va(u,t),er(h,"href",o()),va(p,`${null!=n?n:""} →`),va(f,i)},[()=>bi(l)("about.license.statusInactive"),()=>bi(l)("license.activationPrompt"),()=>bi(l)("license.getActivationCode"),()=>bi(l)("license.activatePremium")]),pa(e,t)};xa(p,e=>{bi(d)?e(g):e(v,!1)}),zt(h),pa(e,h);var f=St(u);return a(),f}ia(["click"]);var cve=la('<div class="info-item svelte-1y9os7b"><div class="item-icon svelte-1y9os7b"> </div> <div class="item-content svelte-1y9os7b"><div class="item-label svelte-1y9os7b"> </div> <div class="item-value svelte-1y9os7b"> </div></div></div>'),dve=la('<a target="_blank" rel="noopener noreferrer" class="acknowledgment-link svelte-1y9os7b"><span class="ack-icon svelte-1y9os7b"> </span> <span class="ack-name svelte-1y9os7b"> </span></a>'),uve=la('<div><div class="section-header svelte-1y9os7b"><div class="header-content svelte-1y9os7b"><div class="product-logo svelte-1y9os7b"><div class="logo-icon svelte-1y9os7b">🎴</div> <div class="logo-text svelte-1y9os7b"><h2 class="product-title svelte-1y9os7b">Tuanki</h2> <p class="product-tagline svelte-1y9os7b"> </p></div></div></div></div> <div class="info-grid svelte-1y9os7b"></div> <div class="quick-links svelte-1y9os7b"><a href="https://github.com/zhuzhige123/obsidian---Tuanki" target="_blank" class="quick-link opensource-link svelte-1y9os7b"><span class="link-icon svelte-1y9os7b">🔓</span> <span class="link-text svelte-1y9os7b"> </span></a> <a target="_blank" class="quick-link svelte-1y9os7b"><span class="link-icon svelte-1y9os7b">📖</span> <span class="link-text svelte-1y9os7b"> </span></a> <a target="_blank" class="quick-link svelte-1y9os7b"><span class="link-icon svelte-1y9os7b">🚀</span> <span class="link-text svelte-1y9os7b"> </span></a> <a class="quick-link svelte-1y9os7b"><span class="link-icon svelte-1y9os7b">💬</span> <span class="link-text svelte-1y9os7b"> </span></a></div> <div class="acknowledgments-section svelte-1y9os7b"><h3 class="section-title svelte-1y9os7b"> </h3> <div class="acknowledgments-grid svelte-1y9os7b"></div></div> <!></div>');function hve(e,t){if(new.target)return Er({component:hve,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"compact",7,!1),s=Ar(t,"plugin",7),o=Ar(t,"onSave",7),l=In(n),c=In(()=>[{label:bi(l)("about.product.productName"),value:XS,icon:"🎯"},{label:bi(l)("about.product.version"),value:JS,icon:"🏷️"},{label:bi(l)("about.product.algorithm"),value:bi(l)("about.product.algorithmValue"),icon:"🧠"},{label:bi(l)("about.product.platform"),value:bi(l)("about.product.platformValue"),icon:"💻"},{label:bi(l)("about.product.developer"),value:bi(l)("about.product.developerValue"),icon:"👥"},{label:bi(l)("about.product.licenseMode"),value:bi(l)("about.product.licenseModeValue"),icon:"📄"}]);var d={get compact(){return r()},set compact(e=!1){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},get onSave(){return o()},set onSave(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},u=uve();let h;var p=Gt(u),g=Gt(p),v=Gt(g),f=Kt(Gt(v),2),m=Kt(Gt(f),2),y=Gt(m,!0);zt(m),zt(f),zt(v),zt(g),zt(p);var b=Kt(p,2);Ca(b,21,()=>bi(c),_a,(e,t)=>{var n=cve(),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r),o=Gt(s,!0);zt(s);var l=Kt(s,2),c=Gt(l,!0);zt(l),zt(r),zt(n),zi(()=>{va(a,bi(t).icon),va(o,bi(t).label),va(c,bi(t).value)}),pa(e,n)}),zt(b);var w=Kt(b,2),k=Gt(w),S=Kt(Gt(k),2),x=Gt(S,!0);zt(S),zt(k);var _=Kt(k,2),C=Kt(Gt(_),2),I=Gt(C,!0);zt(C),zt(_);var D=Kt(_,2),T=Kt(Gt(D),2),M=Gt(T,!0);zt(T),zt(D);var A=Kt(D,2),E=Kt(Gt(A),2),z=Gt(E,!0);zt(E),zt(A),zt(w);var P=Kt(w,2),R=Gt(P),$=Gt(R,!0);zt(R);var O=Kt(R,2);Ca(O,21,()=>ax,_a,(e,t)=>{var n=dve(),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r,!0);zt(r),zt(n),zi(()=>{er(n,"href",bi(t).url),er(n,"title",bi(t).description),va(a,bi(t).icon),va(s,bi(t).name)}),pa(e,n)}),zt(O),zt(P);var L=Kt(P,2),N=e=>{lve(e,{get plugin(){return s()},get onSave(){return o()}})};xa(L,e=>{s()&&o()&&e(N)}),zt(u),zi((e,t,n,i,a,r,s)=>{h=Fa(u,1,"product-info-section svelte-1y9os7b",null,h,e),va(y,t),va(x,n),er(_,"href",mge.github),va(I,i),er(D,"href",`${mge.github}/releases`),va(M,a),er(A,"href",`mailto:${mge.email}?subject=${mge.subject}`),va(z,r),va($,s)},[()=>({compact:r()}),()=>bi(l)("about.product.description"),()=>bi(l)("about.quickLinks.openSource"),()=>bi(l)("about.quickLinks.documentation"),()=>bi(l)("about.quickLinks.changelog"),()=>bi(l)("about.quickLinks.support"),()=>bi(l)("about.acknowledgments.title")]),pa(e,u);var F=St(d);return a(),F}var pve=(e,t)=>t(e.currentTarget.value),gve=la('<div class="symbol-config-panel svelte-k20ngq"><div class="config-header svelte-k20ngq"><div class="config-header-left svelte-k20ngq"><h4 class="group-title with-accent-bar accent-purple"> </h4></div></div> <div class="config-grid svelte-k20ngq"><div class="config-item svelte-k20ngq"><label for="systemExcludeTags" class="config-label svelte-k20ngq"> <span class="readonly-badge svelte-k20ngq">官方标准</span></label> <input type="text" id="systemExcludeTags" class="config-input readonly-input svelte-k20ngq" readonly=""/> <small class="help-text svelte-k20ngq"> </small></div> <div class="config-item config-item-wide svelte-k20ngq"><label for="excludeTags" class="config-label svelte-k20ngq"> </label> <input type="text" id="excludeTags" class="config-input svelte-k20ngq"/> <small class="help-text svelte-k20ngq"> </small></div></div></div>');function vve(e,t){if(new.target)return Er({component:vve,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"settings",7),s=Ar(t,"onSettingsChange",7),o=In(n);var l={get settings(){return r()},set settings(e){r(e),hn()},get onSettingsChange(){return s()},set onSettingsChange(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=gve(),d=Gt(c),u=Gt(d),h=Gt(u),p=Gt(h,!0);zt(h),zt(u),zt(d);var g=Kt(d,2),v=Gt(g),f=Gt(v),m=Gt(f);Pt(),zt(f);var y=Kt(f,2);Za(y);var b=Kt(y,2),w=Gt(b,!0);zt(b),zt(v);var k=Kt(v,2),S=Gt(k),x=Gt(S,!0);zt(S);var _=Kt(S,2);Za(_),_.__input=[pve,function(e){!function(e,t){r({...r(),batchParsing:{...r().batchParsing,[e]:t}}),s()(r())}("excludeTags",e.split(",").map(e=>e.trim()).map(e=>e.startsWith("#")?e.substring(1):e).filter(e=>e.length>0))}];var C=Kt(_,2),I=Gt(C,!0);zt(C),zt(k),zt(g),zt(c),zi((e,t,n,i,a,r,s,o)=>{va(p,e),va(m,`${null!=t?t:""} `),Ya(y,n),va(w,i),va(x,a),Ya(_,r),er(_,"placeholder",s),va(I,o)},[()=>bi(o)("settings.cardParsing.dividerConfig.title"),()=>bi(o)("settings.cardParsing.systemExcludeTags.label"),()=>bi(o)("settings.cardParsing.systemExcludeTags.value"),()=>bi(o)("settings.cardParsing.systemExcludeTags.desc"),()=>bi(o)("settings.cardParsing.excludeTags.label"),()=>{var e;return(null==(e=r().batchParsing.excludeTags)?void 0:e.join(", "))||""},()=>bi(o)("settings.cardParsing.excludeTags.placeholder"),()=>bi(o)("settings.cardParsing.excludeTags.desc")]),pa(e,c);var D=St(l);return a(),D}ia(["input"]);class fve extends ge.AbstractInputSuggest{constructor(e,t){super(e,t),oe(this,"inputElement"),this.inputElement=t}getSuggestions(e){const t=this.app.vault.getAllLoadedFiles(),n=[],i=e.toLowerCase();return t.forEach(e=>{e instanceof ge.TFolder&&e.path.toLowerCase().contains(i)&&n.push(e)}),n}renderSuggestion(e,t){t.setText(e.path)}selectSuggestion(e){this.inputElement&&(this.inputElement.value=e.path,this.inputElement.trigger("input")),this.close()}}class mve extends ge.AbstractInputSuggest{constructor(e,t){super(e,t),oe(this,"inputElement"),this.inputElement=t}getSuggestions(e){const t=this.app.vault.getAllLoadedFiles(),n=[],i=e.toLowerCase();return t.forEach(e=>{e instanceof ge.TFile&&"md"===e.extension&&e.path.toLowerCase().contains(i)&&n.push(e)}),n}renderSuggestion(e,t){t.setText(e.path)}selectSuggestion(e){this.inputElement&&(this.inputElement.value=e.path,this.inputElement.trigger("input")),this.close()}}var yve=la('<div class="stat-item svelte-15cn9r4"><!> <span class="svelte-15cn9r4">新增: <strong class="svelte-15cn9r4"> </strong></span></div>'),bve=la('<div class="stat-item svelte-15cn9r4"><!> <span class="svelte-15cn9r4">更新: <strong class="svelte-15cn9r4"> </strong></span></div>'),wve=la('<div class="stat-item svelte-15cn9r4"><!> <span class="svelte-15cn9r4">错误: <strong class="svelte-15cn9r4"> </strong></span></div>'),kve=la('<div class="batch-scan-stats svelte-15cn9r4"><div class="stat-item svelte-15cn9r4"><!> <span class="svelte-15cn9r4">检测到: <strong class="svelte-15cn9r4"> </strong></span></div> <!> <!> <!> <div class="stat-item success-rate svelte-15cn9r4"><!> <span class="svelte-15cn9r4">成功率: <strong class="svelte-15cn9r4"> </strong></span></div></div>');function Sve(e,t){if(new.target)return Er({component:Sve,...e});kt(t,!0);let n=Ar(t,"results",7),i=In(()=>{var e,t,i,a,r,s;return{totalCards:(null==(e=n())?void 0:e.totalCards)||0,newCards:(null==(t=n())?void 0:t.newCards)||0,updatedCards:(null==(i=n())?void 0:i.updatedCards)||0,failedCards:(null==(a=n())?void 0:a.failedCards)||0,errors:(null==(s=null==(r=n())?void 0:r.errors)?void 0:s.length)||0,successRate:(()=>{if(!n()||0===n().totalCards)return 0;const e=(n().newCards||0)+(n().updatedCards||0);return Math.round(e/n().totalCards*100)})()}});var a={get results(){return n()},set results(e){n(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},r=ha(),s=Qt(r),o=e=>{var t=kve(),n=Gt(t),a=Gt(n);Ng(a,{name:"check-circle",size:14,variant:"success"});var r=Kt(a,2),s=Kt(Gt(r)),o=Gt(s,!0);zt(s),zt(r),zt(n);var l=Kt(n,2),c=e=>{var t=yve(),n=Gt(t);Ng(n,{name:"plus-circle",size:14,variant:"primary"});var a=Kt(n,2),r=Kt(Gt(a)),s=Gt(r,!0);zt(r),zt(a),zt(t),zi(()=>va(s,bi(i).newCards)),pa(e,t)};xa(l,e=>{bi(i).newCards>0&&e(c)});var d=Kt(l,2),u=e=>{var t=bve(),n=Gt(t);Ng(n,{name:"refresh-cw",size:14,variant:"primary"});var a=Kt(n,2),r=Kt(Gt(a)),s=Gt(r,!0);zt(r),zt(a),zt(t),zi(()=>va(s,bi(i).updatedCards)),pa(e,t)};xa(d,e=>{bi(i).updatedCards>0&&e(u)});var h=Kt(d,2),p=e=>{var t=wve(),n=Gt(t);Ng(n,{name:"x-circle",size:14,variant:"error"});var a=Kt(n,2),r=Kt(Gt(a)),s=Gt(r,!0);zt(r),zt(a),zt(t),zi(()=>va(s,bi(i).failedCards+bi(i).errors)),pa(e,t)};xa(h,e=>{(bi(i).failedCards>0||bi(i).errors>0)&&e(p)});var g=Kt(h,2),v=Gt(g);Ng(v,{name:"trending-up",size:14,variant:"success"});var f=Kt(v,2),m=Kt(Gt(f)),y=Gt(m);zt(m),zt(f),zt(g),zt(t),zi(()=>{var e;va(o,bi(i).totalCards),va(y,`${null!=(e=bi(i).successRate)?e:""}%`)}),pa(e,t)};return xa(s,e=>{n()&&n().totalCards>0&&e(o)}),pa(e,r),St(a)}const xve={default:{id:"default",name:"默认格式（插件原生）",description:"使用 <-> 分隔卡片，使用 ---div--- 分隔正反面",example:"<->\n这是问题内容\n---div---\n这是答案内容\n<->",config:{name:"默认格式",mode:"separator",separatorMode:{cardSeparator:"<->",frontBackSeparator:"---div---",multiline:!0,emptyLineSeparator:{enabled:!1,lineCount:2}},uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",excludeTags:["禁止同步"],autoAddUUID:!0,syncMethod:"tag-based"}},"qa-format":{id:"qa-format",name:"Q&A 格式",description:"使用 Q: 和 A: 标记问题和答案",example:"Q: 什么是间隔重复？\nA: 间隔重复是一种学习技术，通过逐渐增加复习间隔来优化记忆效果。\n\nQ: FSRS 算法的全称是什么？\nA: Free Spaced Repetition Scheduler（自由间隔重复调度器）",config:{name:"Q&A 格式",mode:"pattern",patternMode:{cardPattern:"Q:\\s*(.+?)\\s*A:\\s*(.+?)(?=\\n\\s*Q:|$)",flags:"gs",captureGroups:{front:1,back:2}},uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",excludeTags:["禁止同步"],autoAddUUID:!0,syncMethod:"tag-based"}},"heading-based":{id:"heading-based",name:"标题分隔格式",description:"使用 Markdown 二级标题（##）分隔卡片，标题作为问题",example:"## 什么是卡片？\n卡片是学习的基本单位，包含问题和答案两部分。\n\n## 什么是牌组？\n牌组是卡片的集合，用于组织和管理学习内容。",config:{name:"标题分隔格式",mode:"separator",separatorMode:{cardSeparator:"^##\\s+",frontBackSeparator:void 0,multiline:!0},uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",excludeTags:["禁止同步"],autoAddUUID:!0,syncMethod:"tag-based"}},"list-format":{id:"list-format",name:"列表格式",description:"使用 Markdown 列表，列表项作为问题，缩进项作为答案",example:"- 什么是间隔重复？\n  - 间隔重复是一种学习技术\n  - 通过逐渐增加复习间隔来优化记忆效果\n\n- FSRS 算法的优势？\n  - 更准确的记忆预测\n  - 自适应学习曲线",config:{name:"列表格式",mode:"pattern",patternMode:{cardPattern:"^-\\s+([^\\n]+)\\n((?:\\s+-\\s+[^\\n]+\\n?)+)",flags:"gm",captureGroups:{front:1,back:2}},uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",excludeTags:["禁止同步"],autoAddUUID:!0,syncMethod:"tag-based"}},"anki-style":{id:"anki-style",name:"Anki 导出格式",description:"兼容 Anki 的导出格式（每行一张卡片，制表符分隔）",example:"问题1\t答案1\n问题2\t答案2\n问题3\t答案3",config:{name:"Anki 导出格式",mode:"pattern",patternMode:{cardPattern:"^(.+?)\\t(.+?)$",flags:"gm",captureGroups:{front:1,back:2}},uuidLocation:"none",excludeTags:["禁止同步"],autoAddUUID:!0,syncMethod:"full-sync"}}};function _ve(e,t,n,i){var a;t().emptyLineSeparator={enabled:!1,lineCount:bi(n).lineCount},null==(a=i())||a(t())}function Cve(e,t,n,i){var a;t().emptyLineSeparator={enabled:!0,lineCount:bi(n).lineCount},null==(a=i())||a(t())}var Ive=(e,t)=>t(parseInt(e.currentTarget.value)||2),Dve=la('<div class="form-group svelte-qx4k62"><label for="empty-line-count" class="svelte-qx4k62">空行数量</label> <input type="number" id="empty-line-count" min="1" max="10" placeholder="例如：2" class="svelte-qx4k62"/> <small class="help-text svelte-qx4k62">连续的空行数量（默认2行）</small></div>'),Tve=(e,t)=>t(e.currentTarget.value),Mve=la('<div class="form-group svelte-qx4k62"><label for="card-separator" class="svelte-qx4k62">卡片范围分隔符</label> <input type="text" id="card-separator" placeholder="例如：%%&lt;->%%" class="svelte-qx4k62"/> <small class="help-text svelte-qx4k62">用于分隔卡片范围</small></div>'),Ave=la('<div class="range-separator-config svelte-qx4k62"><div class="form-group svelte-qx4k62"><div class="form-label svelte-qx4k62">卡片分隔方式</div> <div class="separator-type-switch svelte-qx4k62"><label class="switch-option svelte-qx4k62"><input type="radio" class="svelte-qx4k62"/> <span>使用自定义分隔符</span></label> <label class="switch-option svelte-qx4k62"><input type="radio" class="svelte-qx4k62"/> <span>使用空行分隔</span></label></div></div> <!></div>');function Eve(e,t){if(new.target)return Er({component:Eve,...e});kt(t,!0);let n=Ar(t,"config",7),i=Ar(t,"name",7,"separator-type"),a=Ar(t,"onChange",7);const r=In(()=>n().emptyLineSeparator||{enabled:!1,lineCount:2}),s=In(()=>n().cardSeparator||"<->");function o(e){var t;n().emptyLineSeparator&&(n().emptyLineSeparator.lineCount=e,null==(t=a())||t(n()))}function l(e){var t;n().cardSeparator=e,null==(t=a())||t(n())}var c={get config(){return n()},set config(e){n(e),hn()},get name(){return i()},set name(e="separator-type"){i(e),hn()},get onChange(){return a()},set onChange(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},d=Ave(),u=Gt(d),h=Kt(Gt(u),2),p=Gt(h),g=Gt(p);Za(g),g.__change=[_ve,n,r,a],Pt(2),zt(p);var v=Kt(p,2),f=Gt(v);Za(f),f.__change=[Cve,n,r,a],Pt(2),zt(v),zt(h),zt(u);var m=Kt(u,2),y=e=>{var t=Dve(),n=Kt(Gt(t),2);Za(n),n.__change=[Ive,o],Pt(2),zt(t),zi(()=>Ya(n,bi(r).lineCount)),pa(e,t)},b=e=>{var t=Mve(),n=Kt(Gt(t),2);Za(n),n.__input=[Tve,l],Pt(2),zt(t),zi(()=>Ya(n,bi(s))),pa(e,t)};return xa(m,e=>{bi(r).enabled?e(y):e(b,!1)}),zt(d),zi(()=>{er(g,"name",i()),Xa(g,!bi(r).enabled),er(f,"name",i()),Xa(f,bi(r).enabled)}),pa(e,d),St(c)}function zve(e,t,n,i){$n(t,n(),!0),$n(i,!0)}function Pve(e,t,n,i,a,r){if(!bi(t))return;if(!bi(t).name||!bi(t).name.trim())return void new ge.Notice("预设名称不能为空");const s={...bi(t),uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",autoAddUUID:void 0===bi(t).autoAddUUID||bi(t).autoAddUUID,excludeTags:bi(t).excludeTags||[],separatorMode:bi(t).separatorMode?{...bi(t).separatorMode,multiline:void 0===bi(t).separatorMode.multiline||bi(t).separatorMode.multiline}:void 0};if(bi(n)){const e=i(),t={...s,id:e};a()([...r(),t]),new ge.Notice("✅ 预设已创建")}else{const e=r().map(e=>e.name===s.name?s:e);a()(e),new ge.Notice("✅ 预设已保存")}$n(t,null),$n(n,!1)}ia(["change","input"]);var Rve=(e,t,n)=>t(bi(n)),$ve=la('<button class="preset-chip svelte-16tgtn"> </button>'),Ove=(e,t,n)=>t(bi(n)),Lve=(e,t,n)=>t(bi(n).name),Nve=la('<div class="preset-item svelte-16tgtn"><div class="preset-info svelte-16tgtn"><div class="preset-name svelte-16tgtn"> </div> <div class="preset-meta svelte-16tgtn"> </div></div> <div class="preset-actions svelte-16tgtn"><button class="action-btn edit svelte-16tgtn">编辑</button> <button class="action-btn delete svelte-16tgtn">删除</button></div></div>'),Fve=la('<div class="preset-list svelte-16tgtn"></div>'),Bve=(e,t)=>"Escape"===e.key&&t(),jve=e=>e.stopPropagation(),Uve=(e,t)=>{bi(t)&&(bi(t).name=e.currentTarget.value)},Vve=(e,t,n,i)=>{const a=e.currentTarget.value;bi(t)&&(bi(t).mode=a,"pattern"!==a||bi(t).patternMode?"separator"!==a||bi(t).separatorMode||(bi(t).separatorMode={...i}):bi(t).patternMode={...n})},qve=(e,t,n)=>{var i;(null==(i=bi(t))?void 0:i.patternMode)||(bi(t).patternMode={...n}),bi(t).patternMode.cardPattern=e.currentTarget.value},Hve=(e,t,n)=>{var i;(null==(i=bi(t))?void 0:i.patternMode)||(bi(t).patternMode={...n}),bi(t).patternMode.flags=e.currentTarget.value},Wve=la('<div class="form-group svelte-16tgtn"><label for="card-pattern" class="svelte-16tgtn">卡片匹配正则表达式</label> <textarea id="card-pattern" placeholder="例如：Q:\\s*(.+?)\\s*A:\\s*(.+?)" rows="3" class="svelte-16tgtn"></textarea> <small class="help-text svelte-16tgtn">✅ 直接在全文中匹配所有卡片，通过捕获组（括号）提取问题和答案</small></div> <div class="form-group svelte-16tgtn"><label for="regex-flags" class="svelte-16tgtn">正则标志</label> <input type="text" id="regex-flags" placeholder="例如：gs" class="svelte-16tgtn"/> <small class="help-text svelte-16tgtn">g=全局匹配，s=允许.匹配换行，i=忽略大小写，m=多行模式</small></div>',1),Gve=(e,t)=>{bi(t)&&(bi(t).syncMethod=e.currentTarget.value)},Qve=la('<div class="preset-editor-overlay svelte-16tgtn" role="dialog" aria-modal="true" aria-labelledby="preset-editor-title" tabindex="-1"><div class="preset-editor svelte-16tgtn" role="document"><div class="editor-header svelte-16tgtn"><h3 id="preset-editor-title" class="svelte-16tgtn"> </h3> <button class="close-btn svelte-16tgtn" aria-label="关闭">×</button></div> <div class="editor-body svelte-16tgtn"><div class="form-group svelte-16tgtn"><label for="preset-name" class="svelte-16tgtn">预设名称</label> <input type="text" id="preset-name" placeholder="例如：默认Tuanki格式" class="svelte-16tgtn"/></div> <div class="form-group svelte-16tgtn"><label for="parsing-mode" class="svelte-16tgtn">解析模式</label> <select id="parsing-mode" class="svelte-16tgtn"><option>分隔符模式（简单）</option><option>完整正则模式（灵活）</option></select></div> <!> <!> <div class="form-group svelte-16tgtn"><label for="sync-method" class="svelte-16tgtn">同步方法</label> <select id="sync-method" class="svelte-16tgtn"><option>标签判断模式</option><option>完全同步模式</option></select></div></div> <div class="editor-footer svelte-16tgtn"><button class="btn-cancel svelte-16tgtn">取消</button> <button class="btn-save svelte-16tgtn">保存</button></div></div></div>'),Kve=la('<div class="regex-preset-manager"><div class="preset-header svelte-16tgtn"><div class="preset-header-left svelte-16tgtn"><h4 class="group-title with-accent-bar accent-red">正则预设管理</h4> <span class="preset-count svelte-16tgtn"> </span></div> <div class="preset-header-right svelte-16tgtn"><button class="add-preset-btn svelte-16tgtn">+ 新建预设</button></div></div> <div class="preset-content svelte-16tgtn"><div class="official-presets svelte-16tgtn"><div class="section-label svelte-16tgtn">官方预设（快速导入）</div> <div class="preset-chips svelte-16tgtn"></div></div> <div class="custom-presets svelte-16tgtn"><div class="section-label svelte-16tgtn">自定义预设</div> <!></div> <!></div></div>');function Zve(e,t){if(new.target)return Er({component:Zve,...e});kt(t,!0);let n=Ar(t,"presets",23,()=>[]),i=Ar(t,"onPresetsChange",7),a=Pn(null),r=Pn(!1);const s={cardSeparator:"<->",frontBackSeparator:"---div---",multiline:!0,emptyLineSeparator:{enabled:!1,lineCount:2}},o={cardPattern:"",flags:"gs",captureGroups:{front:1,back:2}},l=In(()=>{var e;return"pattern"===(null==(e=bi(a))?void 0:e.mode)&&bi(a).patternMode||o}),c=In(()=>{var e;return"separator"===(null==(e=bi(a))?void 0:e.mode)&&bi(a).separatorMode||s});function d(){return`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function u(e){$n(a,{...e,uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",autoAddUUID:void 0===e.autoAddUUID||e.autoAddUUID,excludeTags:e.excludeTags||[]},!0),"separator"===bi(a).mode?function(e){e.separatorMode?e.separatorMode={...s,...e.separatorMode,emptyLineSeparator:e.separatorMode.emptyLineSeparator||s.emptyLineSeparator}:e.separatorMode={...s}}(bi(a)):"pattern"===bi(a).mode&&function(e){e.patternMode?e.patternMode={...o,...e.patternMode,captureGroups:e.patternMode.captureGroups||o.captureGroups}:e.patternMode={...o}}(bi(a)),$n(r,!1)}function h(e){confirm(`确定要删除预设 "${e}" 吗？`)&&(i()(n().filter(t=>t.name!==e)),new ge.Notice("✅ 预设已删除"))}function p(){$n(a,null),$n(r,!1)}function g(e){const t=xve[e];if(!t)return;const a={...t.config,excludeTags:t.config.excludeTags||[]};n().some(e=>e.name===a.name)?new ge.Notice(`预设 "${a.name}" 已存在`):(i()([...n(),a]),new ge.Notice(`✅ 已导入预设 "${a.name}"`))}var v={get presets(){return n()},set presets(e=[]){n(e),hn()},get onPresetsChange(){return i()},set onPresetsChange(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},f=Kve(),m=Gt(f),y=Gt(m),b=Kt(Gt(y),2),w=Gt(b);zt(b),zt(y);var k=Kt(y,2);Gt(k).__click=[zve,a,function(){return{name:"新预设",description:"",mode:"separator",separatorMode:{...s},uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",excludeTags:[],autoAddUUID:!0,syncMethod:"tag-based"}},r],zt(k),zt(m);var S=Kt(m,2),x=Gt(S),_=Kt(Gt(x),2);Ca(_,21,()=>Object.keys(xve),_a,(e,t)=>{const n=In(()=>xve[bi(t)]);var i=$ve();i.__click=[Rve,g,t];var a=Gt(i,!0);zt(i),zi(()=>{er(i,"title",bi(n).description),va(a,bi(n).name)}),pa(e,i)}),zt(_),zt(x);var C=Kt(x,2),I=Kt(Gt(C),2),D=e=>{var t=Fve();Ca(t,21,n,_a,(e,t)=>{var n=Nve(),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var s=Kt(a,2),o=Gt(s);zt(s),zt(i);var l=Kt(i,2),c=Gt(l);c.__click=[Ove,u,t],Kt(c,2).__click=[Lve,h,t],zt(l),zt(n),zi(()=>{va(r,bi(t).name),va(o,`模式: ${"separator"===bi(t).mode?"分隔符":"完整正则"} | \n                  同步: ${"tag-based"===bi(t).syncMethod?"标签判断":"完全同步"}`)}),pa(e,n)}),zt(t),pa(e,t)};xa(I,e=>{n().length>0&&e(D)}),zt(C);var T=Kt(C,2),M=e=>{var t=Qve();t.__click=p,t.__keydown=[Bve,p];var u=Gt(t);u.__click=[jve];var h=Gt(u),g=Gt(h),v=Gt(g,!0);zt(g),Kt(g,2).__click=p,zt(h);var f=Kt(h,2),m=Gt(f),y=Kt(Gt(m),2);Za(y),y.__input=[Uve,a],zt(m);var b=Kt(m,2),w=Kt(Gt(b),2);w.__change=[Vve,a,o,s];var k=Gt(w);k.value=k.__value="separator";var S,x=Kt(k);x.value=x.__value="pattern",zt(w),Va(w),zt(b);var _=Kt(b,2),C=e=>{Eve(e,{get config(){return bi(c)},name:"separator-type",onChange:()=>{var e;(null==(e=bi(a))?void 0:e.separatorMode)||(bi(a).separatorMode={...s})}})};xa(_,e=>{var t;"separator"===(null==(t=bi(a))?void 0:t.mode)&&e(C)});var I=Kt(_,2),D=e=>{var t=Wve(),n=Qt(t),i=Kt(Gt(n),2);jn(i),i.__input=[qve,a,o],Pt(2),zt(n);var r=Kt(n,2),s=Kt(Gt(r),2);Za(s),s.__input=[Hve,a,o],Pt(2),zt(r),zi(()=>{Ya(i,bi(l).cardPattern),Ya(s,bi(l).flags)}),pa(e,t)};xa(I,e=>{var t;"pattern"===(null==(t=bi(a))?void 0:t.mode)&&e(D)});var T=Kt(I,2),M=Kt(Gt(T),2);M.__change=[Gve,a];var A=Gt(M);A.value=A.__value="tag-based";var E,z=Kt(A);z.value=z.__value="full-sync",zt(M),Va(M),zt(T),zt(f);var P=Kt(f,2),R=Gt(P);R.__click=p,Kt(R,2).__click=[Pve,a,r,d,i,n],zt(P),zt(u),zt(t),zi(()=>{var e,t,n,i,s,o,l,c,d;va(v,bi(r)?"新建正则预设":"编辑正则预设"),Ya(y,(null==(e=bi(a))?void 0:e.name)||""),S!==(S=(null==(t=bi(a))?void 0:t.mode)||"separator")&&(w.value=null!=(i=w.__value=(null==(n=bi(a))?void 0:n.mode)||"separator")?i:"",Ua(w,(null==(s=bi(a))?void 0:s.mode)||"separator")),E!==(E=(null==(o=bi(a))?void 0:o.syncMethod)||"tag-based")&&(M.value=null!=(c=M.__value=(null==(l=bi(a))?void 0:l.syncMethod)||"tag-based")?c:"",Ua(M,(null==(d=bi(a))?void 0:d.syncMethod)||"tag-based"))}),pa(e,t)};return xa(T,e=>{bi(a)&&e(M)}),zt(S),zt(f),zi(()=>{var e;return va(w,`(${null!=(e=n().length)?e:""})`)}),pa(e,f),St(v)}function Yve(e,t,n,i){const a={id:t(),type:"folder",path:"",folderPath:"",targetDeckId:"",targetDeckName:"",includeSubfolders:!0,enabled:!0,autoCreateDeck:!1,fileMode:"single-card",singleCardConfig:{contentStructure:"front-back-split",frontBackSeparator:"---div---",uuidLocation:"frontmatter",syncMethod:"mtime-compare",excludeTags:["禁止同步"]}};n()([...i(),a])}ia(["click","keydown","input","change"]);var Xve=(e,t,n)=>t(bi(n)),Jve=da('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-196nv9b"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>'),efe=da('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-196nv9b"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>'),tfe=la('<svg class="folder-icon svelte-196nv9b" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> <input type="text" class="folder-input svelte-196nv9b" placeholder="选择或输入文件路径..."/>',1),nfe=la('<svg class="folder-icon svelte-196nv9b" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg> <input type="text" class="folder-input svelte-196nv9b" placeholder="选择或输入文件夹路径..."/>',1),ife=(e,t,n)=>{const i=e.currentTarget.value;t(bi(n).id,"single-card"===i?{fileMode:i,singleCardConfig:{contentStructure:"front-back-split",frontBackSeparator:"---div---",uuidLocation:"frontmatter",syncMethod:"mtime-compare",excludeTags:["禁止同步"]},multiCardsConfig:void 0}:{fileMode:i,multiCardsConfig:{usePreset:"default",parsingConfig:{name:"默认格式",mode:"separator",separatorMode:{cardSeparator:"<->",frontBackSeparator:"---div---",multiline:!0,emptyLineSeparator:{enabled:!1,lineCount:2}},uuidLocation:"inline",uuidPattern:"\x3c!-- (tk-[a-z0-9]{12}) --\x3e",excludeTags:["禁止同步"],autoAddUUID:!0,syncMethod:"tag-based"}},singleCardConfig:void 0})},afe=(e,t,n,i)=>{const a=e.currentTarget.value,r=bi(t).find(e=>e.name===a);r?n(bi(i).id,{multiCardsConfig:{...bi(i).multiCardsConfig||{},selectedPresetName:a,parsingConfig:{...r}}}):""===a&&n(bi(i).id,{multiCardsConfig:{...bi(i).multiCardsConfig||{},selectedPresetName:"",parsingConfig:void 0}})},rfe=la('<option class="svelte-196nv9b"> </option>'),sfe=la('<select class="regex-config-select svelte-196nv9b"><option class="svelte-196nv9b"> </option><!></select>'),ofe=la('<span class="na-text svelte-196nv9b">—</span>'),lfe=(e,t,n)=>t(bi(n),e),cfe=la('<svg class="deck-icon svelte-196nv9b" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg> <span class="deck-name svelte-196nv9b"> </span>',1),dfe=la('<span class="placeholder svelte-196nv9b">选择牌组...</span>'),ufe=(e,t,n)=>t(bi(n).id,{includeSubfolders:e.currentTarget.checked}),hfe=la('<label class="checkbox-label svelte-196nv9b"><input type="checkbox" class="svelte-196nv9b"/> <span> </span></label>'),pfe=la('<span class="na-text svelte-196nv9b">—</span>'),gfe=la('<span class="card-count svelte-196nv9b"> </span>'),vfe=la('<span class="card-count-placeholder svelte-196nv9b">未统计</span>'),ffe=(e,t,n)=>t(bi(n).id,{enabled:e.currentTarget.checked}),mfe=(e,t,n)=>t(bi(n),e),yfe=la('<tr><td class="type-cell svelte-196nv9b"><button><!></button></td><td class="folder-cell svelte-196nv9b"><div class="folder-input-wrapper svelte-196nv9b"><!></div></td><td class="file-mode-cell svelte-196nv9b"><select class="file-mode-select svelte-196nv9b" title="选择文件解析模式"><option>单文件单卡片</option><option>单文件多卡片</option></select></td><td class="regex-config-cell svelte-196nv9b"><!></td><td class="deck-cell svelte-196nv9b"><button><!> <svg class="chevron-icon svelte-196nv9b" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button></td><td class="subfolder-cell svelte-196nv9b"><!></td><td class="card-count-cell svelte-196nv9b"><!></td><td class="enable-cell svelte-196nv9b"><label class="modern-switch svelte-196nv9b"><input type="checkbox" class="svelte-196nv9b"/> <span class="switch-slider svelte-196nv9b"></span></label></td><td class="actions-cell svelte-196nv9b"><button class="menu-btn svelte-196nv9b" aria-label="操作菜单" title="更多操作"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button></td></tr>'),bfe=la('<div class="mapping-table-container svelte-196nv9b"><table class="mapping-table svelte-196nv9b"><thead class="svelte-196nv9b"><tr><th class="svelte-196nv9b">类型</th><th class="svelte-196nv9b">路径</th><th class="svelte-196nv9b">文件模式</th><th class="svelte-196nv9b">正则配置</th><th class="svelte-196nv9b">目标牌组</th><th class="svelte-196nv9b">子文件夹</th><th class="svelte-196nv9b">卡片数量</th><th class="svelte-196nv9b">启用</th><th class="svelte-196nv9b">操作</th></tr></thead><tbody class="svelte-196nv9b"></tbody></table></div>'),wfe=la('<div class="tuanki-settings settings-group svelte-196nv9b"><!></div> <div class="tuanki-settings settings-group svelte-196nv9b"><div class="mapping-header svelte-196nv9b"><div class="header-content svelte-196nv9b"><h4 class="group-title with-accent-bar accent-cyan svelte-196nv9b"> </h4> <p class="header-desc svelte-196nv9b"> </p></div> <div class="header-actions svelte-196nv9b"><!> <button class="add-mapping-btn svelte-196nv9b"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> </button></div></div> <!></div>',1);function kfe(e,t){if(new.target)return Er({component:kfe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"mappings",23,()=>[]),s=Ar(t,"decks",23,()=>[]),o=Ar(t,"app",7),l=Ar(t,"plugin",7),c=Ar(t,"onMappingsChange",7),d=In(n),u=Pn(Ot(new Map)),h=Pn(Ot(new Map)),p=Pn(null),g=Pn(Ot([]));function v(e,t){const n=r().map(n=>n.id===e?{...n,...t}:n);c()(n)}function f(e,t){const n=new ge.Menu;n.addItem(t=>{t.setTitle("开始扫描").setIcon("refresh-cw").setDisabled(!e.folderPath||!e.targetDeckId).onClick(()=>async function(e){var t;const n=e.path||e.folderPath,i=e.type||"folder";if(!n)return void new ge.Notice("⚠️ 请先选择"+("file"===i?"文件":"文件夹"));if(!e.targetDeckId)return void new ge.Notice("⚠️ 请先选择目标牌组");const a="file"===i?"文件":"文件夹",r=`确认要解析${a}"${n}"中的卡片到牌组"${e.targetDeckName}"吗？\n\n这将执行实际的卡片解析和保存操作。`;if(confirm(r)){new ge.Notice(`🔍 开始解析${a}: ${n}`);try{const n=null==(t=l())?void 0:t.batchParsingManager;if(!n)throw new Error("批量解析服务未初始化");const i=await n.scanSingleMapping(e);if($n(p,i,!0),i.parsedCards&&i.parsedCards.length>0){new ge.Notice(`🔄 开始保存 ${i.parsedCards.length} 张卡片...`);try{await l().addCardsToDB(i.parsedCards),v(e.id,{fileCount:i.totalCards,lastScanned:(new Date).toISOString()}),new ge.Notice(`✅ 成功保存 ${i.totalCards} 张卡片到牌组"${e.targetDeckName}"！`)}catch(s){const e=s instanceof Error?s.message:String(s);_e.error("[FolderDeckMappingTable] 保存卡片失败:",s),new ge.Notice(`保存卡片失败: ${e}`)}}else new ge.Notice("ℹ️ 扫描完成，未找到符合条件的卡片。\n请检查文件中是否包含有效的 <-> 卡片分隔符。")}catch(o){const e=o instanceof Error?o.message:String(o);_e.error("[FolderDeckMappingTable] 扫描失败:",o),new ge.Notice(`扫描失败: ${e}`)}}else new ge.Notice("已取消操作")}(e))}),n.addSeparator(),n.addItem(t=>{t.setTitle("删除映射").setIcon("trash").onClick(()=>{return t=e.id,null==(n=bi(u).get(t))||n.close(),bi(u).delete(t),null==(i=bi(h).get(t))||i.close(),bi(h).delete(t),c()(r().filter(e=>e.id!==t)),void new ge.Notice("已删除映射");var t,n,i})}),n.showAtMouseEvent(t)}function m(e,t){if(e&&o()){const n=new fve(o(),e);bi(u).set(t,n)}}function y(e,t){if(e&&o()){const n=new mve(o(),e);bi(h).set(t,n)}}function b(e){const t="file"===e.type?"folder":"file";v(e.id,{type:t,path:"",folderPath:""})}function w(e,t){if(!s()||0===s().length)return void new ge.Notice('⚠️ 暂无可用牌组，请先在"牌组学习"界面创建牌组');const n=new ge.Menu;s().forEach(t=>{n.addItem(n=>{n.setTitle(t.name).setChecked(e.targetDeckId===t.id).onClick(()=>{v(e.id,{targetDeckId:t.id,targetDeckName:t.name})})})}),n.showAtMouseEvent(t)}Pr(()=>{var e,t,n;(null==(n=null==(t=null==(e=l())?void 0:e.settings)?void 0:t.simplifiedParsing)?void 0:n.regexPresets)&&$n(g,l().settings.simplifiedParsing.regexPresets,!0)});var k={get mappings(){return r()},set mappings(e=[]){r(e),hn()},get decks(){return s()},set decks(e=[]){s(e),hn()},get app(){return o()},set app(e){o(e),hn()},get plugin(){return l()},set plugin(e){l(e),hn()},get onMappingsChange(){return c()},set onMappingsChange(e){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},S=wfe(),x=Qt(S);Zve(Gt(x),{get presets(){return bi(g)},onPresetsChange:async function(e){var t,n;$n(g,e,!0),(null==(n=null==(t=l())?void 0:t.settings)?void 0:n.simplifiedParsing)&&(l().settings.simplifiedParsing.regexPresets=e,await l().saveSettings(),new ge.Notice("✅ 正则预设已保存"))}}),zt(x);var _=Kt(x,2),C=Gt(_),I=Gt(C),D=Gt(I),T=Gt(D,!0);zt(D);var M=Kt(D,2),A=Gt(M,!0);zt(M),zt(I);var E=Kt(I,2),z=Gt(E);Sve(z,{get results(){return bi(p)}});var P=Kt(z,2);P.__click=[Yve,function(){return`mapping-${Date.now()}-${Math.random().toString(36).substr(2,9)}`},c,r];var R=Kt(Gt(P));zt(P),zt(E),zt(C);var $=Kt(C,2),O=e=>{var t=bfe(),n=Gt(t),i=Kt(Gt(n));Ca(i,21,r,e=>e.id,(e,t)=>{const n=In(()=>bi(t).type||"folder"),i=In(()=>bi(t).path||bi(t).folderPath||"");var a=yfe();let r;var s=Gt(a),o=Gt(s);let l;o.__click=[Xve,b,t];var c=Gt(o),d=e=>{pa(e,Jve())},u=e=>{pa(e,efe())};xa(c,e=>{"file"===bi(n)?e(d):e(u,!1)}),zt(o),zt(s);var h=Kt(s),p=Gt(h),k=Gt(p),S=e=>{var n=tfe(),a=Kt(Qt(n),2);Za(a),a.__input=e=>{const n=e.currentTarget.value;v(bi(t).id,{path:n,folderPath:n}),e.currentTarget.title=n||"选择或输入文件路径..."},za(a,(e,t)=>null==y?void 0:y(e,t),()=>bi(t).id),zi(()=>{Ya(a,bi(i)),er(a,"title",bi(i)||"选择或输入文件路径...")}),pa(e,n)},x=e=>{var n=nfe(),a=Kt(Qt(n),2);Za(a),a.__input=e=>{const n=e.currentTarget.value;v(bi(t).id,{path:n,folderPath:n}),e.currentTarget.title=n||"选择或输入文件夹路径..."},za(a,(e,t)=>null==m?void 0:m(e,t),()=>bi(t).id),zi(()=>{Ya(a,bi(i)),er(a,"title",bi(i)||"选择或输入文件夹路径...")}),pa(e,n)};xa(k,e=>{"file"===bi(n)?e(S):e(x,!1)}),zt(p),zt(h);var _=Kt(h),C=Gt(_);C.__change=[ife,v,t];var I=Gt(C);I.value=I.__value="single-card";var D,T=Kt(I);T.value=T.__value="multi-cards",zt(C),Va(C),zt(_);var M=Kt(_),A=Gt(M),E=e=>{var n=sfe();n.__change=[afe,g,v,t];var i,a=Gt(n),r=Gt(a,!0);zt(a),a.value=a.__value="",Ca(Kt(a),17,()=>bi(g),_a,(e,t)=>{var n=rfe(),i=Gt(n,!0);zt(n);var a={};zi(()=>{var e;va(i,bi(t).name),a!==(a=bi(t).name)&&(n.value=null!=(e=n.__value=bi(t).name)?e:"")}),pa(e,n)}),zt(n),Va(n),zi(()=>{var e,a,s,o;er(n,"title",0===bi(g).length?"请先在正则预设管理中创建预设":"选择正则解析预设"),va(r,0===bi(g).length?"暂无预设（请先创建）":"选择预设..."),i!==(i=(null==(e=bi(t).multiCardsConfig)?void 0:e.selectedPresetName)||"")&&(n.value=null!=(s=n.__value=(null==(a=bi(t).multiCardsConfig)?void 0:a.selectedPresetName)||"")?s:"",Ua(n,(null==(o=bi(t).multiCardsConfig)?void 0:o.selectedPresetName)||""))}),pa(e,n)},z=e=>{pa(e,ofe())};xa(A,e=>{"multi-cards"===bi(t).fileMode?e(E):e(z,!1)}),zt(M);var P=Kt(M),R=Gt(P);let $;R.__click=[lfe,w,t];var O=Gt(R),L=e=>{var n=cfe(),i=Kt(Qt(n),2),a=Gt(i,!0);zt(i),zi(()=>va(a,bi(t).targetDeckName)),pa(e,n)},N=e=>{pa(e,dfe())};xa(O,e=>{bi(t).targetDeckId&&bi(t).targetDeckName?e(L):e(N,!1)}),Pt(2),zt(R),zt(P);var F=Kt(P),B=Gt(F),j=e=>{var n=hfe(),i=Gt(n);Za(i),i.__change=[ufe,v,t];var a=Kt(i,2),r=Gt(a,!0);zt(a),zt(n),zi(()=>{Xa(i,bi(t).includeSubfolders),va(r,bi(t).includeSubfolders?"包含":"排除")}),pa(e,n)},U=e=>{pa(e,pfe())};xa(B,e=>{"folder"===bi(n)?e(j):e(U,!1)}),zt(F);var V=Kt(F),q=Gt(V),H=e=>{var n=gfe(),i=Gt(n);zt(n),zi(()=>{var e;return va(i,`${null!=(e=bi(t).fileCount)?e:""} 张`)}),pa(e,n)},W=e=>{pa(e,vfe())};xa(q,e=>{void 0!==bi(t).fileCount?e(H):e(W,!1)}),zt(V);var G=Kt(V),Q=Gt(G),K=Gt(Q);Za(K),K.__change=[ffe,v,t],Pt(2),zt(Q),zt(G);var Z=Kt(G);Gt(Z).__click=[mfe,f,t],zt(Z),zt(a),zi((e,i,s)=>{var c;r=Fa(a,1,"svelte-196nv9b",null,r,e),l=Fa(o,1,"type-toggle-btn svelte-196nv9b",null,l,i),er(o,"title","file"===bi(n)?"文件（点击切换到文件夹）":"文件夹（点击切换到文件）"),D!==(D=bi(t).fileMode||"single-card")&&(C.value=null!=(c=C.__value=bi(t).fileMode||"single-card")?c:"",Ua(C,bi(t).fileMode||"single-card")),$=Fa(R,1,"deck-selector-btn svelte-196nv9b",null,$,s),er(R,"title",bi(t).targetDeckName||"点击选择牌组"),Xa(K,bi(t).enabled)},[()=>({disabled:!bi(t).enabled}),()=>({"is-file":"file"===bi(n)}),()=>({empty:!bi(t).targetDeckId})]),pa(e,a)}),zt(i),zt(n),zt(t),pa(e,t)};xa($,e=>{r().length>0&&e(O)}),zt(_),zi((e,t,n)=>{va(T,e),va(A,t),va(R,` ${null!=n?n:""}`)},[()=>bi(d)("settings.cardParsing.fileMappings.title"),()=>bi(d)("settings.cardParsing.fileMappings.desc"),()=>bi(d)("settings.cardParsing.fileMappings.addMapping")]),pa(e,S);var L=St(k);return a(),L}ia(["click","input","change"]);var Sfe=la('<div class="simple-batch-parsing-panel svelte-pgssh8"><section class="config-section svelte-pgssh8"><!></section></div>');function xfe(e,t){if(new.target)return Er({component:xfe,...e});kt(t,!0);let n=Ar(t,"config",7),i=Ar(t,"onConfigChange",7),a=Ar(t,"app",7),r=Ar(t,"plugin",7),s=Pn(Ot([]));const o=Qh.getInstance();let l=Pn(!1);Ti(()=>o.isPremiumActive.subscribe(e=>{$n(l,e,!0)})),Pr(async()=>{await async function(){var e;if(null==(e=r())?void 0:e.dataStorage)try{const e=await r().dataStorage.getAllDecks();$n(s,e||[],!0)}catch(t){_e.error("[SimpleBatchParsingPanel] 获取牌组列表失败:",t),$n(s,[],!0)}else $n(s,[],!0)}()});var c={get config(){return n()},set config(e){n(e),hn()},get onConfigChange(){return i()},set onConfigChange(e){i(e),hn()},get app(){return a()},set app(e){a(e),hn()},get plugin(){return r()},set plugin(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},d=Sfe(),u=Gt(d),h=Gt(u);{let e=In(()=>n().folderDeckMappings||[]);kfe(h,{get mappings(){return bi(e)},get decks(){return bi(s)},get app(){return a()},get plugin(){return r()},onMappingsChange:function(e){!function(e){const t={...n(),...e};i()(t)}({folderDeckMappings:e})}})}return zt(u),zt(d),pa(e,d),St(c)}var _fe=la('<div class="tuanki-settings"><section class="settings-group"><div class="premium-guard"><!> <div class="guard-content"><h4> </h4> <p> </p></div></div></section></div>'),Cfe=la('<div class="simplified-parsing-settings svelte-kai7cv"><div class="tuanki-settings"><div class="settings-group"><!></div></div> <!></div>');function Ife(e,t){if(new.target)return Er({component:Ife,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"settings",23,()=>({...Ph})),s=Ar(t,"onSettingsChange",7,()=>{}),o=Ar(t,"plugin",7),l=In(n),c=Pn(void 0);const d=Qh.getInstance();let u=Pn(!1);Ti(()=>d.isPremiumActive.subscribe(e=>{$n(u,e,!0)})),Pr(()=>{var e;(null==(e=o())?void 0:e.batchParsingManager)?$n(c,o().batchParsingManager.getConfig(),!0):_e.warn("[SimplifiedParsingSettings] ⚠️ batchParsingManager 未初始化")});var h={get settings(){return r()},set settings(e={...Ph}){r(e),hn()},get onSettingsChange(){return s()},set onSettingsChange(e=()=>{}){s(e),hn()},get plugin(){return o()},set plugin(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=Cfe(),g=Gt(p),v=Gt(g);vve(Gt(v),{get settings(){return r()},get onSettingsChange(){return s()}}),zt(v),zt(g);var f=Kt(g,2),m=e=>{var t=_fe(),n=Gt(t),i=Gt(n),a=Gt(i);d3(a,{});var r=Kt(a,2),s=Gt(r),o=Gt(s);zt(s);var c=Kt(s,2),d=Gt(c,!0);zt(c),zt(r),zt(i),zt(n),zt(t),zi((e,t,n)=>{va(o,`${null!=e?e:""} (${null!=t?t:""})`),va(d,n)},[()=>bi(l)("settings.cardParsing.title"),()=>bi(l)("common.premiumFeature"),()=>bi(l)("settings.cardParsing.premiumPrompt")]),pa(e,t)},y=e=>{var t=ha(),n=Qt(t),i=e=>{{let t=In(()=>{var e;return null==(e=o())?void 0:e.app});xfe(e,{get config(){return bi(c)},onConfigChange:async e=>{var t;if($n(c,e,!0),null==(t=o())?void 0:t.batchParsingManager)try{await o().batchParsingManager.updateConfig(e)}catch(n){_e.error("[SimplifiedParsingSettings] 配置保存失败:",n)}},get app(){return bi(t)},get plugin(){return o()}})}};xa(n,e=>{void 0!==bi(c)&&e(i)}),pa(e,t)};xa(f,e=>{bi(u)?e(y,!1):e(m)}),zt(p),pa(e,p);var b=St(h);return a(),b}var Dfe=la('<span class="badge badge-success svelte-un4je"> </span>'),Tfe=(e,t,n)=>t(bi(n),e),Mfe=(e,t,n)=>{if("Enter"===e.key||" "===e.key){e.preventDefault();const i=e.currentTarget.getBoundingClientRect(),a=new MouseEvent("click",{clientX:i.left,clientY:i.bottom,bubbles:!0});t(bi(n),a)}},Afe=(e,t,n)=>t(bi(n)),Efe=la("<option> </option>"),zfe=(e,t,n)=>t(bi(n)),Pfe=la("<!> <span> </span>",1),Rfe=la("<!> <span> </span>",1),$fe=la("<div><!> <span> </span></div>"),Ofe=la('<div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><div class="input-with-button svelte-un4je"><input placeholder="sk-..." class="text-input svelte-un4je"/> <button class="btn-icon svelte-un4je"><!></button></div></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><select class="dropdown svelte-un4je"></select></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div></div> <div class="setting-control"><div class="test-control-group svelte-un4je"><button class="test-btn svelte-un4je"><!></button> <!></div></div></div>',1),Lfe=la('<div class="settings-group"><div class="group-header-with-menu svelte-un4je"><h4 class="group-title svelte-un4je"><!> <span> </span> <!></h4> <button type="button" class="provider-menu-btn svelte-un4je"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button></div> <!></div>'),Nfe=la('<div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><input type="number" min="0" max="10" class="number-input svelte-un4je"/></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><input type="number" min="50" max="1000" step="50" class="number-input svelte-un4je"/></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><input type="number" min="1000" max="10000" step="500" class="number-input svelte-un4je"/></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-un4je"><input type="checkbox" class="svelte-un4je"/> <span class="toggle-slider svelte-un4je"></span></label></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-un4je"><input type="checkbox" class="svelte-un4je"/> <span class="toggle-slider svelte-un4je"></span></label></div></div> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-un4je"><input type="checkbox" class="svelte-un4je"/> <span class="toggle-slider svelte-un4je"></span></label></div></div>',1),Ffe=(e,t)=>{e.target===e.currentTarget&&t()},Bfe=(e,t)=>"Escape"===e.key&&t(),jfe=la("<small> </small>"),Ufe=la('<div class="modal-overlay svelte-un4je" role="dialog" aria-modal="true" tabindex="-1"><div class="custom-model-modal svelte-un4je" aria-labelledby="custom-model-title"><div class="modal-header svelte-un4je"><h3 id="custom-model-title" class="svelte-un4je">新增自定义AI模型</h3> <button class="btn-close svelte-un4je"><!></button></div> <div class="modal-content svelte-un4je"><div class="provider-info svelte-un4je"><span class="provider-name svelte-un4je"> </span></div> <div class="input-group svelte-un4je"><label for="custom-model-input" class="svelte-un4je">模型名称</label> <input id="custom-model-input" type="text" placeholder="输入自定义模型名称 (如: gpt-4o-2024-05-13)" class="text-input svelte-un4je"/> <!></div></div> <div class="modal-actions svelte-un4je"><button class="btn btn-secondary svelte-un4je">取消</button> <button class="btn btn-primary svelte-un4je">保存</button></div></div></div>'),Vfe=(e,t)=>{e.target===e.currentTarget&&t()},qfe=(e,t)=>"Escape"===e.key&&t(),Hfe=(e,t,n)=>{"Enter"===e.key?t():"Escape"===e.key&&n()},Wfe=la('<div class="modal-overlay svelte-un4je" role="dialog" aria-modal="true" tabindex="-1"><div class="custom-url-modal svelte-un4je" aria-labelledby="custom-url-title"><div class="modal-header svelte-un4je"><h3 id="custom-url-title" class="svelte-un4je"> </h3> <button class="btn-close svelte-un4je"><!></button></div> <div class="modal-content svelte-un4je"><div class="input-group svelte-un4je"><label for="custom-url-input" class="svelte-un4je">API基础地址</label> <input id="custom-url-input" type="text" class="text-input url-input svelte-un4je"/> <small class="input-hint svelte-un4je"><!> 输入完整的API基础地址，例如：<code class="svelte-un4je">https://api.example.com/v1</code></small></div> <div class="url-examples svelte-un4je"><h4 class="svelte-un4je">常用中转示例</h4> <div class="example-list svelte-un4je"><div class="example-item svelte-un4je"><span class="example-label svelte-un4je">Cloudflare Worker:</span> <code class="example-url svelte-un4je">https://your-worker.workers.dev</code></div> <div class="example-item svelte-un4je"><span class="example-label svelte-un4je">Vercel代理:</span> <code class="example-url svelte-un4je">https://your-project.vercel.app</code></div> <div class="example-item svelte-un4je"><span class="example-label svelte-un4je">自建代理:</span> <code class="example-url svelte-un4je">https://proxy.example.com/api</code></div></div></div> <div class="url-notes svelte-un4je"><h4 class="svelte-un4je">⚠️ 注意事项</h4> <ul class="svelte-un4je"><li class="svelte-un4je">确保中转服务与官方API接口兼容</li> <li class="svelte-un4je">自定义地址后需要重新测试连接</li> <li class="svelte-un4je">某些功能可能因中转服务限制而不可用</li> <li class="svelte-un4je">请勿使用不可信的第三方服务，以保护API密钥安全</li></ul></div></div> <div class="modal-actions svelte-un4je"><button class="btn btn-secondary svelte-un4je">取消</button> <button class="btn btn-primary svelte-un4je">保存</button></div></div></div>'),Gfe=la('<div class="tuanki-settings settings-section ai-config-section"><!> <div class="settings-group"><h4 class="group-title svelte-un4je"><!> <span> </span></h4> <div class="setting-item"><div class="setting-info"><div class="setting-label"> </div> <div class="setting-description"> </div></div> <div class="setting-control"><label class="toggle-switch svelte-un4je"><input type="checkbox" class="svelte-un4je"/> <span class="toggle-slider svelte-un4je"></span></label></div></div> <!></div></div> <!> <!>',1);function Qfe(e,t){if(new.target)return Er({component:Qfe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"plugin",7),s=In(n);let o=Pn(Ot(function(){const e=JSON.parse(JSON.stringify(tx));if(!r().settings.aiConfig)return e;const t=r().settings.aiConfig;return{...e,...t,apiKeys:{...e.apiKeys,...t.apiKeys},globalParams:{...e.globalParams,...t.globalParams},cardSplitting:{...e.cardSplitting,...t.cardSplitting||{}}}}())),l=Pn(Ot({openai:!1,gemini:!1,anthropic:!1,deepseek:!1,zhipu:!1,siliconflow:!1,xai:!1})),c=Pn(null),d=Pn(Ot({openai:null,gemini:null,anthropic:null,deepseek:null,zhipu:null,siliconflow:null,xai:null})),u=Pn(!1),h=Pn(null),p=Pn(""),g=Pn(!1),v=Pn(null),f=Pn(""),m=null;function y(e){bi(l)[e]=!bi(l)[e]}async function b(e){$n(c,e,!0),bi(d)[e]=null;try{await new Promise(e=>setTimeout(e,1500));const t=bi(o).apiKeys[e];if(!(null==t?void 0:t.apiKey))throw new Error(bi(s)("aiConfig.apiKeys.testFailed"));bi(d)[e]={success:!0,message:bi(s)("aiConfig.apiKeys.testSuccess")},t.verified=!0,t.lastVerified=(new Date).toISOString()}catch(t){bi(d)[e]={success:!1,message:t instanceof Error?t.message:"连接失败"};const n=bi(o).apiKeys[e];n&&(n.verified=!1)}finally{$n(c,null)}}function w(e,t){const n=new ge.Menu,i=!!bi(o).apiKeys[e].baseUrl;n.addItem(t=>{t.setTitle(i?"修改API地址":"自定义API地址").setIcon("link").onClick(()=>{!function(e){$n(v,e,!0);const t=bi(o).apiKeys[e].baseUrl;$n(f,t||ex[e]||"",!0),$n(g,!0)}(e)})}),i&&n.addItem(t=>{t.setTitle("重置为默认地址").setIcon("rotate-ccw").onClick(async()=>{await async function(e){const t=bi(o).apiKeys[e];t&&(t.baseUrl=void 0,t.verified=!1);await r().saveSettings(),new ge.Notice(`✅ ${ix[e]} 已重置为默认地址`,2e3)}(e)})}),n.addSeparator(),n.addItem(t=>{t.setTitle("新增自定义AI模型").setIcon("plus").onClick(()=>{!function(e){$n(h,e,!0),$n(p,""),$n(u,!0)}(e)})}),n.showAtMouseEvent(t)}function k(){$n(u,!1),$n(h,null),$n(p,"")}function S(e,t){if(!t.trim())return{valid:!1,message:"模型名称不能为空"};return/^[a-zA-Z0-9\-._/]+$/.test(t)?t.length>100?{valid:!1,message:"模型名称过长，最多100个字符"}:{valid:!0,message:"模型名称格式正确"}:{valid:!1,message:"模型名称包含无效字符，只允许字母、数字、连字符、点和斜杠"}}async function x(){if(!bi(h)||!bi(p).trim())return;const e=S(bi(h),bi(p));if(!e.valid)return void _e.error("模型名称验证失败:",e.message);const t=bi(o).apiKeys[bi(h)];t&&(t.model=bi(p)),await r().saveSettings(),k()}function _(){$n(g,!1),$n(v,null),$n(f,"")}async function C(){if(!bi(v)||!bi(f).trim())return;const e=function(e){if(!e.trim())return{valid:!1,message:"URL不能为空"};try{const t=new URL(e);return["http:","https:"].includes(t.protocol)?t.search||t.hash?{valid:!1,message:"基础URL不应包含查询参数或锚点"}:{valid:!0,message:"URL格式正确"}:{valid:!1,message:"只支持HTTP或HTTPS协议"}}catch(t){return{valid:!1,message:"无效的URL格式"}}}(bi(f));if(!e.valid)return void new ge.Notice(`❌ ${e.message}`,3e3);const t=bi(f).trim().replace(/\/+$/,""),n=bi(o).apiKeys[bi(v)];n&&(n.baseUrl=t,n.verified=!1),await r().saveSettings(),new ge.Notice(`✅ ${ix[bi(v)]} API地址已更新`,2e3),_()}Ti(()=>{bi(o)&&(m&&clearTimeout(m),m=setTimeout(async()=>{r().settings.aiConfig=bi(o),await r().saveSettings()},500))});const I=["openai","gemini","anthropic","deepseek","zhipu","siliconflow","xai"];var D={get plugin(){return r()},set plugin(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},T=Gfe(),M=Qt(T),A=Gt(M);Ca(A,17,()=>I,_a,(e,t)=>{const n=In(()=>bi(o).apiKeys[bi(t)]),i=In(()=>{var e;return(null==(e=bi(n))?void 0:e.verified)||!1}),a=In(()=>bi(c)===bi(t)),r=In(()=>bi(d)[bi(t)]);var u=Lfe(),h=Gt(u),p=Gt(h),g=Gt(p);m5(g,{name:"brain",size:20});var v=Kt(g,2),f=Gt(v,!0);zt(v);var m=Kt(v,2),k=e=>{var t=Dfe(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>bi(s)("aiConfig.apiKeys.verified")]),pa(e,t)};xa(m,e=>{bi(i)&&e(k)}),zt(p);var S=Kt(p,2);S.__click=[Tfe,w,t],S.__keydown=[Mfe,w,t],zt(h);var x=Kt(h,2),_=e=>{var i=Ofe(),o=Qt(i),c=Gt(o),d=Gt(c),u=Gt(d,!0);zt(d);var h=Kt(d,2),p=Gt(h,!0);zt(h),zt(c);var g=Kt(c,2),v=Gt(g),f=Gt(v);Za(f);var m=Kt(f,2);m.__click=[Afe,y,t];var w=Gt(m);{let e=In(()=>bi(l)[bi(t)]?"eye-off":"eye");m5(w,{get name(){return bi(e)},size:16})}zt(m),zt(v),zt(g),zt(o);var k=Kt(o,2),S=Gt(k),x=Gt(S),_=Gt(x,!0);zt(x);var C=Kt(x,2),I=Gt(C,!0);zt(C),zt(S);var D=Kt(S,2),T=Gt(D);Ca(T,21,()=>function(e){return nx[e]||[]}(bi(t)),_a,(e,t)=>{var n=Efe(),i=Gt(n);zt(n);var a={};zi(()=>{var e,r,s;va(i,`${null!=(e=bi(t).label)?e:""} - ${null!=(r=bi(t).description)?r:""}`),a!==(a=bi(t).id)&&(n.value=null!=(s=n.__value=bi(t).id)?s:"")}),pa(e,n)}),zt(T),zt(D),zt(k);var M=Kt(k,2),A=Gt(M),E=Gt(A),z=Gt(E,!0);zt(E),zt(A);var P=Kt(A,2),R=Gt(P),$=Gt(R);$.__click=[zfe,b,t];var O=Gt($),L=e=>{var t=Pfe(),n=Qt(t);m5(n,{name:"loader",size:14});var i=Kt(n,2),a=Gt(i,!0);zt(i),zi(e=>va(a,e),[()=>bi(s)("aiConfig.apiKeys.testing")]),pa(e,t)},N=e=>{var t=Rfe(),n=Qt(t);m5(n,{name:"zap",size:14});var i=Kt(n,2),a=Gt(i,!0);zt(i),zi(e=>va(a,e),[()=>bi(s)("aiConfig.apiKeys.testConnection")]),pa(e,t)};xa(O,e=>{bi(a)?e(L):e(N,!1)}),zt($);var F=Kt($,2),B=e=>{var t=$fe();let n;var i=Gt(t);{let e=In(()=>bi(r).success?"check-circle":"x-circle");m5(i,{get name(){return bi(e)},size:14})}var a=Kt(i,2),s=Gt(a,!0);zt(a),zt(t),zi(e=>{n=Fa(t,1,"test-result svelte-un4je",null,n,e),va(s,bi(r).message)},[()=>({success:bi(r).success,error:!bi(r).success})]),pa(e,t)};xa(F,e=>{bi(r)&&e(B)}),zt(R),zt(P),zt(M),zi((e,i,r,s,o,c)=>{var d;va(u,e),va(p,i),er(f,"type",bi(l)[bi(t)]?"text":"password"),er(m,"title",r),va(_,s),va(I,o),va(z,c),$.disabled=!(null==(d=bi(n))?void 0:d.apiKey)||bi(a)},[()=>bi(s)("aiConfig.apiKeys.apiKeyLabel"),()=>bi(s)("aiConfig.apiKeys.apiKeyDescription").replace("{provider}",ix[bi(t)]),()=>bi(l)[bi(t)]?bi(s)("aiConfig.apiKeys.hide"):bi(s)("aiConfig.apiKeys.show"),()=>bi(s)("aiConfig.apiKeys.modelLabel"),()=>bi(s)("aiConfig.apiKeys.modelDescription"),()=>bi(s)("aiConfig.apiKeys.testConnection")]),pr(f,()=>bi(n).apiKey,e=>bi(n).apiKey=e),qa(T,()=>bi(n).model,e=>bi(n).model=e),pa(e,i)};xa(x,e=>{bi(n)&&e(_)}),zt(u),zi((e,n)=>{va(f,ix[bi(t)]),er(S,"aria-label",e),er(S,"title",n)},[()=>bi(s)("aiConfig.apiKeys.menuLabel"),()=>bi(s)("aiConfig.apiKeys.configOptions")]),pa(e,u)});var E=Kt(A,2),z=Gt(E),P=Gt(z);m5(P,{name:"split",size:20});var R=Kt(P,2),$=Gt(R,!0);zt(R),zt(z);var O=Kt(z,2),L=Gt(O),N=Gt(L),F=Gt(N,!0);zt(N);var B=Kt(N,2),j=Gt(B,!0);zt(B),zt(L);var U=Kt(L,2),V=Gt(U),q=Gt(V);Za(q),Pt(2),zt(V),zt(U),zt(O);var H=Kt(O,2),W=e=>{var t=Nfe(),n=Qt(t),i=Gt(n),a=Gt(i),r=Gt(a,!0);zt(a);var l=Kt(a,2),c=Gt(l,!0);zt(l),zt(i);var d=Kt(i,2),u=Gt(d);Za(u),zt(d),zt(n);var h=Kt(n,2),p=Gt(h),g=Gt(p),v=Gt(g,!0);zt(g);var f=Kt(g,2),m=Gt(f,!0);zt(f),zt(p);var y=Kt(p,2),b=Gt(y);Za(b),zt(y),zt(h);var w=Kt(h,2),k=Gt(w),S=Gt(k),x=Gt(S,!0);zt(S);var _=Kt(S,2),C=Gt(_,!0);zt(_),zt(k);var I=Kt(k,2),D=Gt(I);Za(D),zt(I),zt(w);var T=Kt(w,2),M=Gt(T),A=Gt(M),E=Gt(A,!0);zt(A);var z=Kt(A,2),P=Gt(z,!0);zt(z),zt(M);var R=Kt(M,2),$=Gt(R),O=Gt($);Za(O),Pt(2),zt($),zt(R),zt(T);var L=Kt(T,2),N=Gt(L),F=Gt(N),B=Gt(F,!0);zt(F);var j=Kt(F,2),U=Gt(j,!0);zt(j),zt(N);var V=Kt(N,2),q=Gt(V),H=Gt(q);Za(H),Pt(2),zt(q),zt(V),zt(L);var W=Kt(L,2),G=Gt(W),Q=Gt(G),K=Gt(Q,!0);zt(Q);var Z=Kt(Q,2),Y=Gt(Z,!0);zt(Z),zt(G);var X=Kt(G,2),J=Gt(X),ee=Gt(J);Za(ee),Pt(2),zt(J),zt(X),zt(W),zi((e,t,n,i,a,s,o,l,d,u,h,p)=>{va(r,e),va(c,t),va(v,n),va(m,i),va(x,a),va(C,s),va(E,o),va(P,l),va(B,d),va(U,u),va(K,h),va(Y,p)},[()=>bi(s)("aiConfig.cardSplitting.defaultTargetCount.label"),()=>bi(s)("aiConfig.cardSplitting.defaultTargetCount.description"),()=>bi(s)("aiConfig.cardSplitting.minContentLength.label"),()=>bi(s)("aiConfig.cardSplitting.minContentLength.description"),()=>bi(s)("aiConfig.cardSplitting.maxContentLength.label"),()=>bi(s)("aiConfig.cardSplitting.maxContentLength.description"),()=>bi(s)("aiConfig.cardSplitting.autoInheritTags.label"),()=>bi(s)("aiConfig.cardSplitting.autoInheritTags.description"),()=>bi(s)("aiConfig.cardSplitting.autoInheritSource.label"),()=>bi(s)("aiConfig.cardSplitting.autoInheritSource.description"),()=>bi(s)("aiConfig.cardSplitting.requireConfirmation.label"),()=>bi(s)("aiConfig.cardSplitting.requireConfirmation.description")]),pr(u,()=>bi(o).cardSplitting.defaultTargetCount,e=>bi(o).cardSplitting.defaultTargetCount=e),pr(b,()=>bi(o).cardSplitting.minContentLength,e=>bi(o).cardSplitting.minContentLength=e),pr(D,()=>bi(o).cardSplitting.maxContentLength,e=>bi(o).cardSplitting.maxContentLength=e),fr(O,()=>bi(o).cardSplitting.autoInheritTags,e=>bi(o).cardSplitting.autoInheritTags=e),fr(H,()=>bi(o).cardSplitting.autoInheritSource,e=>bi(o).cardSplitting.autoInheritSource=e),fr(ee,()=>bi(o).cardSplitting.requireConfirmation,e=>bi(o).cardSplitting.requireConfirmation=e),pa(e,t)};xa(H,e=>{bi(o).cardSplitting.enabled&&e(W)}),zt(E),zt(M);var G=Kt(M,2),Q=e=>{var t=Ufe();t.__click=[Ffe,k],t.__keydown=[Bfe,k];var n=Gt(t),i=Gt(n),a=Kt(Gt(i),2);a.__click=k,m5(Gt(a),{name:"x",size:16}),zt(a),zt(i);var r=Kt(i,2),s=Gt(r),o=Gt(s),l=Gt(o,!0);zt(o),zt(s);var c=Kt(s,2),d=Kt(Gt(c),2);Za(d);var u=Kt(d,2),g=e=>{const t=In(()=>S(bi(h),bi(p)));var n=jfe();let i;var a=Gt(n,!0);zt(n),zi(e=>{i=Fa(n,1,"input-hint svelte-un4je",null,i,e),va(a,bi(t).message)},[()=>({error:!bi(t).valid})]),pa(e,n)};xa(u,e=>{bi(p)&&e(g)}),zt(c),zt(r);var v=Kt(r,2),f=Gt(v);f.__click=k;var m=Kt(f,2);m.__click=x,zt(v),zt(n),zt(t),zi(e=>{va(l,ix[bi(h)]),m.disabled=e},[()=>!bi(p).trim()||!S(bi(h),bi(p)).valid]),pr(d,()=>bi(p),e=>$n(p,e)),pa(e,t)};xa(G,e=>{bi(u)&&bi(h)&&e(Q)});var K=Kt(G,2),Z=e=>{var t=Wfe();t.__click=[Vfe,_],t.__keydown=[qfe,_];var n=Gt(t),i=Gt(n),a=Gt(i),r=Gt(a);zt(a);var s=Kt(a,2);s.__click=_,m5(Gt(s),{name:"x",size:16}),zt(s),zt(i);var o=Kt(i,2),l=Gt(o),c=Kt(Gt(l),2);Za(c),c.__keydown=[Hfe,C,_];var d=Kt(c,2);m5(Gt(d),{name:"info",size:14}),Pt(2),zt(d),zt(l),Pt(4),zt(o);var u=Kt(o,2),h=Gt(u);h.__click=_,Kt(h,2).__click=C,zt(u),zt(n),zt(t),zi(()=>{var e;va(r,`自定义 ${null!=(e=ix[bi(v)])?e:""} API地址`),er(c,"placeholder",`默认: ${ex[bi(v)]||"官方地址"}`)}),pr(c,()=>bi(f),e=>$n(f,e)),pa(e,t)};xa(K,e=>{bi(g)&&bi(v)&&e(Z)}),zi((e,t,n)=>{va($,e),va(F,t),va(j,n)},[()=>bi(s)("aiConfig.cardSplitting.title"),()=>bi(s)("aiConfig.cardSplitting.enabled.label"),()=>bi(s)("aiConfig.cardSplitting.enabled.description")]),fr(q,()=>bi(o).cardSplitting.enabled,e=>bi(o).cardSplitting.enabled=e),pa(e,T);var Y=St(D);return a(),Y}function Kfe(e,t,n,i,a){confirm(bi(t)("virtualization.resetConfirm"))&&(tb.resetToDefaults(),$n(n,tb.getKanbanConfig(),!0),$n(i,tb.getTableConfig(),!0),a())}ia(["click","keydown"]);var Zfe=(e,t,n,i)=>{bi(t).estimatedItemSize=bi(n).estimatedItemSize,i()},Yfe=la('<div class="tuanki-settings settings-section virtualization-settings"><div class="section-header svelte-70mca6"><h3 class="section-title with-accent-bar accent-pink svelte-70mca6"> </h3> <p class="section-description svelte-70mca6"> </p></div> <div class="settings-group svelte-70mca6"><h4 class="group-title with-accent-bar accent-blue svelte-70mca6"> </h4> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><label class="toggle-switch svelte-70mca6"><input type="checkbox" class="svelte-70mca6"/> <span class="toggle-slider svelte-70mca6"></span></label></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><label class="toggle-switch svelte-70mca6"><input type="checkbox" class="svelte-70mca6"/> <span class="toggle-slider svelte-70mca6"></span></label></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><input type="number" min="0" max="20" class="number-input svelte-70mca6"/></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><input type="number" min="10" max="100" class="number-input svelte-70mca6"/></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><input type="number" min="10" max="50" class="number-input svelte-70mca6"/></div></div></div> <div class="settings-group svelte-70mca6"><h4 class="group-title with-accent-bar accent-cyan svelte-70mca6"> </h4> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><label class="toggle-switch svelte-70mca6"><input type="checkbox" class="svelte-70mca6"/> <span class="toggle-slider svelte-70mca6"></span></label></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><label class="toggle-switch svelte-70mca6"><input type="checkbox" class="svelte-70mca6"/> <span class="toggle-slider svelte-70mca6"></span></label></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><input type="number" min="100" max="2000" step="100" class="number-input svelte-70mca6"/></div></div></div> <div class="settings-group svelte-70mca6"><h4 class="group-title with-accent-bar accent-purple svelte-70mca6"> </h4> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><label class="toggle-switch svelte-70mca6"><input type="checkbox" class="svelte-70mca6"/> <span class="toggle-slider svelte-70mca6"></span></label></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><input type="number" min="100" max="500" step="10" class="number-input svelte-70mca6"/></div></div> <div class="setting-item svelte-70mca6"><div class="setting-info svelte-70mca6"><div class="setting-label svelte-70mca6"> </div> <div class="setting-description svelte-70mca6"> </div></div> <div class="setting-control svelte-70mca6"><button class="reset-btn svelte-70mca6"><!> </button></div></div></div> <div class="performance-tips svelte-70mca6"><div class="tip-header svelte-70mca6"><!> <span> </span></div> <ul class="tip-list svelte-70mca6"><li class="svelte-70mca6"> </li> <li class="svelte-70mca6"> </li> <li class="svelte-70mca6"> </li> <li class="svelte-70mca6"> </li></ul></div></div>');function Xfe(e,t){if(new.target)return Er({component:Xfe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"onSave",7),s=In(n),o=Pn(Ot(tb.getKanbanConfig())),l=Pn(Ot(tb.getTableConfig()));function c(){tb.updateKanbanConfig(bi(o)),tb.updateTableConfig(bi(l)),r()&&r()()}var d={get onSave(){return r()},set onSave(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},u=Yfe(),h=Gt(u),p=Gt(h),g=Gt(p,!0);zt(p);var v=Kt(p,2),f=Gt(v,!0);zt(v),zt(h);var m=Kt(h,2),y=Gt(m),b=Gt(y,!0);zt(y);var w=Kt(y,2),k=Gt(w),S=Gt(k),x=Gt(S,!0);zt(S);var _=Kt(S,2),C=Gt(_,!0);zt(_),zt(k);var I=Kt(k,2),D=Gt(I),T=Gt(D);Za(T),T.__change=c,Pt(2),zt(D),zt(I),zt(w);var M=Kt(w,2),A=Gt(M),E=Gt(A),z=Gt(E,!0);zt(E);var P=Kt(E,2),R=Gt(P,!0);zt(P),zt(A);var $=Kt(A,2),O=Gt($),L=Gt(O);Za(L),L.__change=c,Pt(2),zt(O),zt($),zt(M);var N=Kt(M,2),F=Gt(N),B=Gt(F),j=Gt(B,!0);zt(B);var U=Kt(B,2),V=Gt(U,!0);zt(U),zt(F);var q=Kt(F,2),H=Gt(q);Za(H),H.__change=c,zt(q),zt(N);var W=Kt(N,2),G=Gt(W),Q=Gt(G),K=Gt(Q,!0);zt(Q);var Z=Kt(Q,2),Y=Gt(Z,!0);zt(Z),zt(G);var X=Kt(G,2),J=Gt(X);Za(J),J.__change=c,zt(X),zt(W);var ee=Kt(W,2),te=Gt(ee),ne=Gt(te),ie=Gt(ne,!0);zt(ne);var ae=Kt(ne,2),re=Gt(ae,!0);zt(ae),zt(te);var se=Kt(te,2),oe=Gt(se);Za(oe),oe.__change=c,zt(se),zt(ee),zt(m);var le=Kt(m,2),ce=Gt(le),de=Gt(ce,!0);zt(ce);var ue=Kt(ce,2),he=Gt(ue),pe=Gt(he),ge=Gt(pe,!0);zt(pe);var ve=Kt(pe,2),fe=Gt(ve,!0);zt(ve),zt(he);var me=Kt(he,2),ye=Gt(me),be=Gt(ye);Za(be),be.__change=c,Pt(2),zt(ye),zt(me),zt(ue);var we=Kt(ue,2),ke=Gt(we),Se=Gt(ke),xe=Gt(Se,!0);zt(Se);var _e=Kt(Se,2),Ce=Gt(_e,!0);zt(_e),zt(ke);var Ie=Kt(ke,2),De=Gt(Ie),Te=Gt(De);Za(Te),Te.__change=c,Pt(2),zt(De),zt(Ie),zt(we);var Me=Kt(we,2),Ae=Gt(Me),Ee=Gt(Ae),ze=Gt(Ee,!0);zt(Ee);var Pe=Kt(Ee,2),Re=Gt(Pe,!0);zt(Pe),zt(Ae);var $e=Kt(Ae,2),Oe=Gt($e);Za(Oe),Oe.__change=c,zt($e),zt(Me),zt(le);var Le=Kt(le,2),Ne=Gt(Le),Fe=Gt(Ne,!0);zt(Ne);var Be=Kt(Ne,2),je=Gt(Be),Ue=Gt(je),Ve=Gt(Ue,!0);zt(Ue);var qe=Kt(Ue,2),He=Gt(qe,!0);zt(qe),zt(je);var We=Kt(je,2),Ge=Gt(We),Qe=Gt(Ge);Za(Qe),Qe.__change=c,Pt(2),zt(Ge),zt(We),zt(Be);var Ke=Kt(Be,2),Ze=Gt(Ke),Ye=Gt(Ze),Xe=Gt(Ye,!0);zt(Ye);var Je=Kt(Ye,2),et=Gt(Je,!0);zt(Je),zt(Ze);var tt=Kt(Ze,2),nt=Gt(tt);Za(nt),nt.__change=[Zfe,l,o,c],zt(tt),zt(Ke);var it=Kt(Ke,2),at=Gt(it),rt=Gt(at),st=Gt(rt,!0);zt(rt);var ot=Kt(rt,2),lt=Gt(ot,!0);zt(ot),zt(at);var ct=Kt(at,2),dt=Gt(ct);dt.__click=[Kfe,s,o,l,c];var ut=Gt(dt);Ng(ut,{name:"rotate-ccw",size:14});var ht=Kt(ut);zt(dt),zt(ct),zt(it),zt(Le);var pt=Kt(Le,2),gt=Gt(pt),vt=Gt(gt);Ng(vt,{name:"info",size:16});var ft=Kt(vt,2),mt=Gt(ft,!0);zt(ft),zt(gt);var yt=Kt(gt,2),bt=Gt(yt),wt=Gt(bt,!0);zt(bt);var xt=Kt(bt,2),_t=Gt(xt,!0);zt(xt);var Ct=Kt(xt,2),It=Gt(Ct,!0);zt(Ct);var Dt=Kt(Ct,2),Tt=Gt(Dt,!0);zt(Dt),zt(yt),zt(pt),zt(u),zi((e,t,n,i,a,r,s,c,d,u,h,p,v,m,y,w,k,S,_,I,D,T,M,A,E,P,$,O,N,F,B,U,q)=>{va(g,e),va(f,t),va(b,n),va(x,i),va(C,a),va(z,r),va(R,s),L.disabled=!bi(o).enabled,va(j,c),va(V,d),va(K,u),va(Y,h),va(ie,p),va(re,v),va(de,m),va(ge,y),va(fe,w),va(xe,k),va(Ce,S),Te.disabled=!bi(l).enabled,va(ze,_),va(Re,I),va(Fe,D),va(Ve,T),va(He,M),va(Xe,A),va(et,E),va(st,P),va(lt,$),va(ht,` ${null!=O?O:""}`),va(mt,N),va(wt,F),va(_t,B),va(It,U),va(Tt,q)},[()=>bi(s)("virtualization.title"),()=>bi(s)("virtualization.description"),()=>bi(s)("virtualization.kanban.title"),()=>bi(s)("virtualization.kanban.enableVirtualScroll.label"),()=>bi(s)("virtualization.kanban.enableVirtualScroll.description"),()=>bi(s)("virtualization.kanban.enableColumnVirtualization.label"),()=>bi(s)("virtualization.kanban.enableColumnVirtualization.description"),()=>bi(s)("virtualization.kanban.overscan.label"),()=>bi(s)("virtualization.kanban.overscan.description"),()=>bi(s)("virtualization.kanban.initialBatchSize.label"),()=>bi(s)("virtualization.kanban.initialBatchSize.description"),()=>bi(s)("virtualization.kanban.loadMoreBatchSize.label"),()=>bi(s)("virtualization.kanban.loadMoreBatchSize.description"),()=>bi(s)("virtualization.table.title"),()=>bi(s)("virtualization.table.enableVirtualScroll.label"),()=>bi(s)("virtualization.table.enableVirtualScroll.description"),()=>bi(s)("virtualization.table.enableTableVirtualization.label"),()=>bi(s)("virtualization.table.enableTableVirtualization.description"),()=>bi(s)("virtualization.table.paginationThreshold.label"),()=>bi(s)("virtualization.table.paginationThreshold.description"),()=>bi(s)("virtualization.advanced.title"),()=>bi(s)("virtualization.advanced.cacheItemHeight.label"),()=>bi(s)("virtualization.advanced.cacheItemHeight.description"),()=>bi(s)("virtualization.advanced.estimatedItemHeight.label"),()=>bi(s)("virtualization.advanced.estimatedItemHeight.description"),()=>bi(s)("virtualization.advanced.resetSettings.label"),()=>bi(s)("virtualization.advanced.resetSettings.description"),()=>bi(s)("virtualization.resetButton"),()=>bi(s)("virtualization.tips.title"),()=>bi(s)("virtualization.tips.tip1"),()=>bi(s)("virtualization.tips.tip2"),()=>bi(s)("virtualization.tips.tip3"),()=>bi(s)("virtualization.tips.tip4")]),fr(T,()=>bi(o).enabled,e=>bi(o).enabled=e),fr(L,()=>bi(o).enableColumnVirtualization,e=>bi(o).enableColumnVirtualization=e),pr(H,()=>bi(o).overscan,e=>bi(o).overscan=e),pr(J,()=>bi(o).initialCardsPerColumn,e=>bi(o).initialCardsPerColumn=e),pr(oe,()=>bi(o).batchSize,e=>bi(o).batchSize=e),fr(be,()=>bi(l).enabled,e=>bi(l).enabled=e),fr(Te,()=>bi(l).enableVirtualScroll,e=>bi(l).enableVirtualScroll=e),pr(Oe,()=>bi(l).paginationThreshold,e=>bi(l).paginationThreshold=e),fr(Qe,()=>bi(o).measurementCache,e=>bi(o).measurementCache=e),pr(nt,()=>bi(o).estimatedItemSize,e=>bi(o).estimatedItemSize=e),pa(e,u);var Mt=St(d);return a(),Mt}ia(["change","click"]);var Jfe=la('<div class="about-container svelte-1eg1vkl"><!></div>'),eme=la('<div class="anki-app settings-root svelte-1eg1vkl"><div class="header svelte-1eg1vkl"><h1 class="title svelte-1eg1vkl"> </h1></div> <div class="tabs svelte-1eg1vkl"><!></div> <!> <!> <!> <!> <!> <!> <!> <!> <!></div>');function tme(e,t){var n;if(new.target)return Er({component:tme,...e});kt(t,!0);const i=()=>Ir(Vp,"$tr",a),[a,r]=Dr();let s=Ar(t,"plugin",7),o=In(i),l=Pn(Ot(qS)),c=Pn(Ot(null!=(n=s().settings.showPerformanceSettings)&&n));function d(e){$n(c,e,!0),"virtualization"!==bi(l)||e||$n(l,qS,!0)}let u=In(()=>VS.filter(e=>"virtualization"!==e.id||bi(c)));Pr(()=>{ao("SET_CURRENT_PAGE","settings")});let h=null;async function p(){h&&clearTimeout(h),h=setTimeout(async()=>{try{await s().saveSettings()}catch(e){_e.error("保存设置失败:",e),Foe({message:"设置保存失败，请重试",type:"error"})}},300)}var g={get plugin(){return s()},set plugin(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},v=eme(),f=Gt(v),m=Gt(f),y=Gt(m,!0);zt(m),zt(f);var b=Kt(f,2);$se(Gt(b),{get items(){return bi(u)},get activeId(){return bi(l)},onChange:e=>$n(l,e,!0)}),zt(b);var w=Kt(b,2),k=e=>{var t=Jfe();hve(Gt(t),{get plugin(){return s()},onSave:p}),zt(t),pa(e,t)};xa(w,e=>{"about"===bi(l)&&e(k)});var S=Kt(w,2),x=e=>{coe(e,{get plugin(){return s()},onPerformanceSettingsToggle:d})};xa(S,e=>{"basic"===bi(l)&&e(x)});var _=Kt(S,2),C=e=>{Noe(e,{get plugin(){return s()}})};xa(_,e=>{"fsrs6"===bi(l)&&e(C)});var I=Kt(_,2),D=e=>{ale(e,{get plugin(){return s()}})};xa(I,e=>{"annotation"===bi(l)&&e(D)});var T=Kt(I,2),M=e=>{Ife(e,{get settings(){return s().settings.simplifiedParsing},onSettingsChange:e=>{s().settings.simplifiedParsing=e,s().saveSettings()},get plugin(){return s()}})};xa(T,e=>{"card-parsing"===bi(l)&&e(M)});var A=Kt(T,2),E=e=>{Qfe(e,{get plugin(){return s()}})};xa(A,e=>{"ai-config"===bi(l)&&e(E)});var z=Kt(A,2),P=e=>{Xfe(e,{onSave:p})};xa(z,e=>{"virtualization"===bi(l)&&bi(c)&&e(P)});var R=Kt(z,2),$=e=>{nce(e,{get plugin(){return s()},onSave:p})};xa(R,e=>{"data-management"===bi(l)&&e($)});var O=Kt(R,2),L=e=>{cge(e,{get plugin(){return s()}})};xa(O,e=>{"anki-connect"===bi(l)&&e(L)}),zt(v),zi(e=>va(y,e),[()=>bi(o)("settings.title")]),pa(e,v);var N=St(g);return r(),N}const nme=Object.freeze(Object.defineProperty({__proto__:null,default:tme},Symbol.toStringTag,{value:"Module"}));function ime(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${(e/1024**t).toFixed(2)} ${["B","KB","MB","GB"][t]}`}function ame(e){return{path:e.path,name:e.name,size:e.stat.size,file:e,extension:e.extension}}function rme(e,t,n,i,a,r,s){$n(t,!bi(t)),bi(t)?(n(),setTimeout(()=>{var e;null==(e=bi(i))||e.focus()},50)):($n(a,""),$n(r,bi(s),!0))}function sme(e,t,n,i){$n(t,e.target.value,!0),bi(t).trim()?$n(n,function(e,t){const n=t.toLowerCase();return e.filter(e=>e.name.toLowerCase().includes(n)||e.path.toLowerCase().includes(n))}(bi(i),bi(t)),!0):$n(n,bi(i),!0)}var ome=(e,t,n,i,a)=>{var r;$n(t,""),$n(n,bi(i),!0),null==(r=bi(a))||r.focus()},lme=la('<button class="clear-search-btn svelte-1s7rutb" title="清除搜索"><!></button>'),cme=la('<div class="empty-state svelte-1s7rutb"><!> <p class="svelte-1s7rutb">没有找到匹配的文件</p></div>'),dme=(e,t,n)=>t(bi(n)),ume=la('<button><div class="file-name svelte-1s7rutb"> </div> <div class="file-size svelte-1s7rutb"> </div></button>'),hme=la('<div class="file-dropdown svelte-1s7rutb"><div class="dropdown-search svelte-1s7rutb"><!> <input type="search" placeholder="搜索文件名或路径..." class="search-input svelte-1s7rutb"/> <!></div> <div class="file-list svelte-1s7rutb"><!></div></div>'),pme=la('<div class="file-selector-wrapper svelte-1s7rutb"><button><!> <span class="file-selector-text svelte-1s7rutb"> </span> <!></button> <!></div>');function gme(e,t){if(new.target)return Er({component:gme,...e});kt(t,!0);let n=Ar(t,"plugin",7),i=Ar(t,"selectedFile",15),a=Ar(t,"onFileSelect",7),r=Pn(!1),s=Pn(Ot([])),o=Pn(Ot([])),l=Pn(""),c=Pn(void 0);function d(){const e=function(e){return e.filter(e=>"md"===e.extension)}(n().app.vault.getMarkdownFiles()),t=e.map(ame);$n(s,function(e){return[...e].sort((e,t)=>e.path.localeCompare(t.path))}(t),!0),$n(o,bi(s),!0)}function u(e){i(e),a()(e),$n(r,!1),$n(l,""),$n(o,bi(s),!0)}Pr(()=>{d()}),Ti(()=>{if(bi(r)){const e=e=>{!function(e){e.target.closest(".file-selector-wrapper")||($n(r,!1),$n(l,""),$n(o,bi(s),!0))}(e)},t=setTimeout(()=>{document.addEventListener("click",e)},0);return()=>{clearTimeout(t),document.removeEventListener("click",e)}}});var h={get plugin(){return n()},set plugin(e){n(e),hn()},get selectedFile(){return i()},set selectedFile(e){i(e),hn()},get onFileSelect(){return a()},set onFileSelect(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=pme(),g=Gt(p);let v;g.__click=[rme,r,d,c,l,o,s];var f=Gt(g);m5(f,{name:"folder",size:16});var m=Kt(f,2),y=Gt(m,!0);zt(m),m5(Kt(m,2),{name:"chevron-down",size:14}),zt(g);var b=Kt(g,2),w=e=>{var t=hme(),n=Gt(t),a=Gt(n);m5(a,{name:"search",size:14});var r=Kt(a,2);Za(r),r.__input=[sme,l,o,s],kr(r,e=>$n(c,e),()=>bi(c));var d=Kt(r,2),h=e=>{var t=lme();t.__click=[ome,l,o,s,c],m5(Gt(t),{name:"x",size:12}),zt(t),pa(e,t)};xa(d,e=>{bi(l)&&e(h)}),zt(n);var p=Kt(n,2),g=Gt(p),v=e=>{var t=cme();m5(Gt(t),{name:"file-x",size:32}),Pt(2),zt(t),pa(e,t)},f=e=>{var t=ha();Ca(Qt(t),17,()=>bi(o),_a,(e,t)=>{var n=ume();let a;n.__click=[dme,u,t];var r=Gt(n),s=Gt(r,!0);zt(r);var o=Kt(r,2),l=Gt(o,!0);zt(o),zt(n),zi((e,i)=>{a=Fa(n,1,"file-item svelte-1s7rutb",null,a,e),er(n,"title",bi(t).path),va(s,bi(t).name),va(l,i)},[()=>{var e;return{selected:(null==(e=i())?void 0:e.path)===bi(t).path}},()=>ime(bi(t).size)]),pa(e,n)}),pa(e,t)};xa(g,e=>{0===bi(o).length?e(v):e(f,!1)}),zt(p),zt(t),zi(()=>Ya(r,bi(l))),pa(e,t)};return xa(b,e=>{bi(r)&&e(w)}),zt(p),zi(e=>{v=Fa(g,1,"file-selector-btn svelte-1s7rutb",null,v,e),va(y,i()?i().name:"选择Obsidian文件")},[()=>({active:bi(r)})]),pa(e,p),St(h)}ia(["click","input"]);var vme=la('<div class="file-info-bar svelte-1q1on0"><div class="file-meta svelte-1q1on0"><!> <span class="file-name svelte-1q1on0"> </span> <span class="file-stats svelte-1q1on0"> </span></div> <div class="editor-actions svelte-1q1on0"><button class="action-btn svelte-1q1on0" title="重新加载文件"><!></button> <button class="action-btn svelte-1q1on0" title="清空内容"><!></button></div></div>'),fme=la('<div class="content-editor-container svelte-1q1on0"><!> <textarea class="content-editor svelte-1q1on0"></textarea></div>');function mme(e,t){if(new.target)return Er({component:mme,...e});kt(t,!0);let n=Ar(t,"content",15),i=Ar(t,"selectedFile",7),a=Ar(t,"onClear",7),r=Ar(t,"onReload",7),s=In(()=>n().length),o=In(()=>n().split("\n").length);var l={get content(){return n()},set content(e){n(e),hn()},get selectedFile(){return i()},set selectedFile(e){i(e),hn()},get onClear(){return a()},set onClear(e){a(e),hn()},get onReload(){return r()},set onReload(e){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=fme(),d=Gt(c),u=e=>{var t=vme(),n=Gt(t),l=Gt(n);m5(l,{name:"file-text",size:14});var c=Kt(l,2),d=Gt(c,!0);zt(c);var u=Kt(c,2),h=Gt(u);zt(u),zt(n);var p=Kt(n,2),g=Gt(p);g.__click=function(...e){var t;null==(t=r())||t.apply(this,e)},m5(Gt(g),{name:"refresh-cw",size:14}),zt(g);var v=Kt(g,2);v.__click=function(...e){var t;null==(t=a())||t.apply(this,e)},m5(Gt(v),{name:"trash-2",size:14}),zt(v),zt(p),zt(t),zi(e=>{var t,n;va(d,i().name),va(h,`${null!=e?e:""} · ${null!=(t=bi(s))?t:""} 字符 · ${null!=(n=bi(o))?n:""} 行`)},[()=>ime(i().size)]),pa(e,t)};xa(d,e=>{i()&&e(u)});var h=Kt(d,2);return jn(h),zt(c),zi(()=>er(h,"placeholder",i()?"在此编辑内容，AI将基于此内容生成卡片...":"请先选择文件，或直接在此输入内容...")),pr(h,n),pa(e,c),St(l)}function yme(e,t,n,i,a){const r=new ge.Menu;e.target,bi(t).length>0&&bi(t).forEach(e=>{r.addItem(t=>{var a;t.setTitle(e.name).setIcon("message-square").setChecked((null==(a=n())?void 0:a.id)===e.id).onClick(()=>{n(e),i()(e)})})}),bi(t).length>0&&bi(a).length>0&&r.addSeparator(),bi(a).length>0&&bi(a).forEach(e=>{r.addItem(t=>{var a;t.setTitle(e.name).setIcon("file-text").setChecked((null==(a=n())?void 0:a.id)===e.id).onClick(()=>{n(e),i()(e)})})}),0===bi(t).length&&0===bi(a).length&&r.addItem(e=>{e.setTitle("暂无可用模板").setDisabled(!0)}),r.showAtMouseEvent(e)}function bme(e,t,n,i){const a=new ge.Menu;Object.entries(nx).forEach(([r,s])=>{const o=r;a.addItem(a=>{a.setTitle(ix[o]).setIcon(t()===o?"check":"").onClick(()=>{const t=new ge.Menu;s.forEach(e=>{t.addItem(t=>{t.setTitle(e.label).setIcon(n()===e.id?"check":"").onClick(()=>{i()(o,e.id)})})}),t.showAtMouseEvent(e)})})}),a.showAtMouseEvent(e)}function wme(e,t,n,i,a,r){const s=e.target;t(s.value),n()(s.value),s.value&&i()&&(i(null),a()(null)),r()}function kme(e,t,n,i){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),t()||n()||i()())}ia(["click"]);var Sme=la("<!> <span>生成中...</span>",1),xme=la("<!> <span>点击生成</span>",1),_me=la('<div class="prompt-footer svelte-1a1ot71"><button class="prompt-selector-btn svelte-1a1ot71" title="选择提示词模板"><!> <span class="prompt-selector-text svelte-1a1ot71"> </span> <!></button> <button class="ai-provider-selector-btn svelte-1a1ot71" title="选择AI服务商和模型"><!> <span class="provider-text svelte-1a1ot71"> </span> <!></button> <textarea class="prompt-textarea svelte-1a1ot71" placeholder="或输入自定义提示词..."></textarea> <button class="generate-btn svelte-1a1ot71"><!></button></div>');function Cme(e,t){if(new.target)return Er({component:Cme,...e});kt(t,!0);let n=Ar(t,"plugin",7),i=Ar(t,"selectedPrompt",15),a=Ar(t,"customPrompt",15),r=Ar(t,"selectedProvider",7),s=Ar(t,"selectedModel",7),o=Ar(t,"onPromptSelect",7),l=Ar(t,"onCustomPromptChange",7),c=Ar(t,"onProviderModelChange",7),d=Ar(t,"onGenerate",7),u=Ar(t,"isGenerating",7),h=Ar(t,"disabled",7),p=Ar(t,"refreshKey",7,0),g=Pn(void 0),v=In(()=>{return p(),((null==(e=n().settings.aiConfig)?void 0:e.promptTemplates.official)||[]).map(e=>({...e,category:"official",useBuiltinSystemPrompt:!0}));var e}),f=In(()=>{return p(),((null==(e=n().settings.aiConfig)?void 0:e.promptTemplates.custom)||[]).map(e=>({...e,category:"custom",useBuiltinSystemPrompt:!0}));var e});function m(){if(!bi(g))return;bi(g).style.height="36px";const e=Math.min(Math.max(bi(g).scrollHeight,36),120);bi(g).style.height=`${e}px`}Ti(()=>{void 0!==a()&&m()});var y={get plugin(){return n()},set plugin(e){n(e),hn()},get selectedPrompt(){return i()},set selectedPrompt(e){i(e),hn()},get customPrompt(){return a()},set customPrompt(e){a(e),hn()},get selectedProvider(){return r()},set selectedProvider(e){r(e),hn()},get selectedModel(){return s()},set selectedModel(e){s(e),hn()},get onPromptSelect(){return o()},set onPromptSelect(e){o(e),hn()},get onCustomPromptChange(){return l()},set onCustomPromptChange(e){l(e),hn()},get onProviderModelChange(){return c()},set onProviderModelChange(e){c(e),hn()},get onGenerate(){return d()},set onGenerate(e){d(e),hn()},get isGenerating(){return u()},set isGenerating(e){u(e),hn()},get disabled(){return h()},set disabled(e){h(e),hn()},get refreshKey(){return p()},set refreshKey(e=0){p(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},b=_me(),w=Gt(b);w.__click=[yme,v,i,o,f];var k=Gt(w);m5(k,{name:"message-square",size:14});var S=Kt(k,2),x=Gt(S,!0);zt(S),m5(Kt(S,2),{name:"chevron-down",size:12}),zt(w);var _=Kt(w,2);_.__click=[bme,r,s,c];var C=Gt(_);m5(C,{name:"cpu",size:14});var I=Kt(C,2),D=Gt(I);zt(I),m5(Kt(I,2),{name:"chevron-down",size:12}),zt(_);var T=Kt(_,2);jn(T),T.__input=[wme,a,l,i,o,m],T.__keydown=[kme,h,u,d],kr(T,e=>$n(g,e),()=>bi(g));var M=Kt(T,2);M.__click=function(...e){var t;null==(t=d())||t.apply(this,e)};var A=Gt(M),E=e=>{var t=Sme();m5(Qt(t),{name:"loader",size:16}),Pt(2),pa(e,t)},z=e=>{var t=xme();m5(Qt(t),{name:"sparkles",size:16}),Pt(2),pa(e,t)};return xa(A,e=>{u()?e(E):e(z,!1)}),zt(M),zt(b),zi(()=>{var e,t;va(x,i()?i().name:"选择提示词"),va(D,`${null!=(e=ix[r()])?e:""} · ${null!=(t=s())?t:""}`),Ya(T,a()),M.disabled=h()||u(),er(M,"title",h()?"请先输入内容":"生成AI卡片")}),pa(e,b),St(y)}ia(["click","input","keydown"]);var Ime=la('<div class="progress-details svelte-64wjc4"> </div>'),Dme=la('<button class="preview-btn svelte-64wjc4" title="查看生成的卡片"><!> <span>查看</span></button>'),Tme=la('<div><div class="progress-header svelte-64wjc4"><div><!></div> <div class="progress-info svelte-64wjc4"><div class="progress-message svelte-64wjc4"> </div> <!></div> <!></div> <div class="progress-bar-container svelte-64wjc4"><div class="progress-bar svelte-64wjc4"></div></div> <div class="progress-percent svelte-64wjc4"> </div></div>');function Mme(e,t){if(new.target)return Er({component:Mme,...e});kt(t,!0);let n=Ar(t,"progress",7),i=Ar(t,"onOpenPreview",7),a=In(()=>{switch(n().status){case"preparing":return"settings";case"generating":return"cpu";case"parsing":return"file-search";case"completed":return"check-circle";case"failed":return"x-circle";default:return"loader"}}),r=In(()=>{switch(n().status){case"completed":return"success";case"failed":return"error";default:return"normal"}});var s={get progress(){return n()},set progress(e){n(e),hn()},get onOpenPreview(){return i()},set onOpenPreview(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=Tme();let l;var c=Gt(o),d=Gt(c);m5(Gt(d),{get name(){return bi(a)},size:20}),zt(d);var u=Kt(d,2),h=Gt(u),p=Gt(h,!0);zt(h);var g=Kt(h,2),v=e=>{var t=Ime(),i=Gt(t);zt(t),zi(()=>{var e,t;return va(i,`生成进度：${null!=(e=n().currentCard)?e:""} / ${null!=(t=n().totalCards)?t:""}`)}),pa(e,t)};xa(g,e=>{n().currentCard&&n().totalCards&&e(v)}),zt(u);var f=Kt(u,2),m=e=>{var t=Dme();t.__click=function(...e){var t;null==(t=i())||t.apply(this,e)},m5(Gt(t),{name:"eye",size:18}),Pt(2),zt(t),pa(e,t)};xa(f,e=>{"completed"===n().status&&i()&&e(m)}),zt(c);var y=Kt(c,2),b=Gt(y);zt(y);var w=Kt(y,2),k=Gt(w);return zt(w),zt(o),zi((e,t)=>{var i,a;l=Fa(o,1,"progress-indicator svelte-64wjc4",null,l,e),Fa(d,1,`progress-icon ${null!=(i=bi(r))?i:""}`,"svelte-64wjc4"),va(p,n().message),ja(b,`width: ${null!=(a=n().progress)?a:""}%`),va(k,`${null!=t?t:""}%`)},[()=>({completed:"completed"===n().status,failed:"failed"===n().status}),()=>Math.round(n().progress)]),pa(e,o),St(s)}function Ame(e,t){$n(t,{...bi(t),cardCount:10,difficulty:"medium",provider:"openai",model:"gpt-4o",temperature:.7,maxTokens:4e3,typeDistribution:{qa:50,cloze:30,choice:20},autoTags:[],enableHints:!0},!0)}function Eme(e,t,n,i,a,r){if(bi(t).length>=5)return void new ge.Notice("最多只能创建5个自定义系统提示词");const s={id:`custom-system-prompt-${Date.now()}`,name:"新系统提示词",content:D8.getBuiltinSystemPrompt(bi(n)),description:"",createdAt:(new Date).toISOString()};$n(t,[...bi(t),s],!0),$n(i,s.id,!0),$n(a,s.id,!0),r()}function zme(e,t,n,i,a){if(bi(t)){const e=bi(n).find(e=>e.id===bi(t));!e||e.updatedAt||"新系统提示词"!==e.name||e.content.trim()||($n(n,bi(n).filter(e=>e.id!==bi(t)),!0),bi(i)===bi(t)&&$n(i,null),a())}$n(t,null)}function Pme(e,t){const n=bi(t)();navigator.clipboard.writeText(n).then(()=>{new ge.Notice("已复制到剪贴板")}).catch(()=>{new ge.Notice("复制失败")})}function Rme(e,t,n,i,a){const r={id:`custom-prompt-${Date.now()}`,name:"新提示词",prompt:"请根据以下内容生成学习卡片",variables:["count","difficulty"],useBuiltinSystemPrompt:!0,category:"custom",createdAt:(new Date).toISOString()};$n(t,[...bi(t),r],!0),$n(n,r.id,!0),$n(i,r.id,!0),a()}function $me(e,t,n,i,a){if(bi(t)){const e=bi(n).find(e=>e.id===bi(t));!e||e.updatedAt||"新提示词"!==e.name||e.prompt.trim()||($n(n,bi(n).filter(e=>e.id!==bi(t)),!0),bi(i)===bi(t)&&$n(i,null),a())}$n(t,null)}ia(["click"]);var Ome=e=>e.stopPropagation(),Lme=(e,t)=>$n(t,"system-prompt"),Nme=(e,t)=>$n(t,"ai-config"),Fme=(e,t)=>$n(t,"user-prompt"),Bme=la('<div class="error-item svelte-cgm1nj"> </div>'),jme=la('<div class="validation-errors svelte-cgm1nj"></div>'),Ume=(e,t)=>t(null),Vme=la('<span class="default-badge svelte-cgm1nj">默认</span>'),qme=(e,t)=>{e.stopPropagation(),t(null)},Hme=la('<button class="action-btn svelte-cgm1nj" title="设为默认"><!></button>'),Wme=(e,t,n)=>t(bi(n).id),Gme=la('<span class="default-badge svelte-cgm1nj">默认</span>'),Qme=la('<div class="item-desc svelte-cgm1nj"> </div>'),Kme=(e,t,n)=>{e.stopPropagation(),t(bi(n).id)},Zme=la('<button class="action-btn svelte-cgm1nj" title="设为默认"><!></button>'),Yme=(e,t,n)=>{e.stopPropagation(),t(bi(n).id)},Xme=(e,t,n)=>{e.stopPropagation(),t(bi(n).id)},Jme=la('<div role="button" tabindex="0"><!> <div class="item-content svelte-cgm1nj"><div class="item-title svelte-cgm1nj"> <!></div> <!></div> <div class="item-actions svelte-cgm1nj"><!> <button class="action-btn svelte-cgm1nj" title="编辑"><!></button> <button class="action-btn svelte-cgm1nj" title="删除"><!></button></div></div>'),eye=(e,t,n)=>t(bi(n).id,{name:e.target.value}),tye=(e,t,n)=>t(bi(n).id,{description:e.target.value}),nye=(e,t,n)=>t(bi(n).id,{content:e.target.value}),iye=la('<div class="edit-form svelte-cgm1nj"><div class="edit-header svelte-cgm1nj"><h4 class="svelte-cgm1nj">编辑系统提示词</h4> <div class="instant-save-badge svelte-cgm1nj"><!> <span class="svelte-cgm1nj">更改即时保存</span></div></div> <div class="form-group svelte-cgm1nj"><label class="form-label svelte-cgm1nj" for="system-prompt-name">名称</label> <input id="system-prompt-name" type="text" placeholder="请输入提示词名称" class="form-input svelte-cgm1nj"/></div> <div class="form-group svelte-cgm1nj"><label class="form-label svelte-cgm1nj" for="system-prompt-desc">描述（可选）</label> <input id="system-prompt-desc" type="text" placeholder="简要说明用途" class="form-input svelte-cgm1nj"/></div> <div class="form-group svelte-cgm1nj"><label class="form-label svelte-cgm1nj" for="system-prompt-content">内容</label> <textarea id="system-prompt-content" placeholder="请输入系统提示词内容..." class="form-textarea svelte-cgm1nj" rows="15"></textarea></div> <div class="form-actions svelte-cgm1nj"><button class="btn btn-secondary svelte-cgm1nj">完成编辑</button></div></div>'),aye=la('<div class="preview-mode svelte-cgm1nj"><div class="preview-header svelte-cgm1nj"><h4 class="svelte-cgm1nj"> </h4> <button class="copy-btn svelte-cgm1nj"><!> 复制</button></div> <pre class="preview-content svelte-cgm1nj"> </pre></div>'),rye=la('<div class="tab-panel system-prompt-panel svelte-cgm1nj"><div class="panel-layout svelte-cgm1nj"><div class="sidebar-list svelte-cgm1nj"><div class="list-header svelte-cgm1nj"><h4 class="svelte-cgm1nj">系统提示词</h4></div> <div class="list-content svelte-cgm1nj"><div role="button" tabindex="0"><!> <div class="item-content svelte-cgm1nj"><div class="item-title svelte-cgm1nj">内置系统提示词 <!></div> <div class="item-desc svelte-cgm1nj">使用默认的系统提示词</div></div> <div class="item-actions svelte-cgm1nj"><!></div></div> <!> <div class="new-prompt-section svelte-cgm1nj"><button class="new-prompt-btn svelte-cgm1nj"><!> <span class="svelte-cgm1nj">新建系统提示词</span></button></div></div></div> <div class="content-area svelte-cgm1nj"><!></div></div></div>'),sye=(e,t)=>t("qa",parseInt(e.target.value)),oye=(e,t)=>t("cloze",parseInt(e.target.value)),lye=(e,t)=>t("choice",parseInt(e.target.value)),cye=(e,t)=>{const n=e.target.value;bi(t).autoTags=n.split(",").map(e=>e.trim()).filter(e=>e)},dye=la('<div class="tab-panel ai-config-panel svelte-cgm1nj"><section class="config-section difficulty svelte-cgm1nj"><div class="section-header svelte-cgm1nj"><h3 class="section-title svelte-cgm1nj">难度级别</h3></div> <div class="config-item svelte-cgm1nj"><fieldset class="config-fieldset svelte-cgm1nj"><legend class="visually-hidden svelte-cgm1nj">难度级别</legend> <div class="radio-group svelte-cgm1nj"><label class="radio-item svelte-cgm1nj"><input type="radio" name="difficulty" class="svelte-cgm1nj"/> <span class="svelte-cgm1nj">简单</span></label> <label class="radio-item svelte-cgm1nj"><input type="radio" name="difficulty" class="svelte-cgm1nj"/> <span class="svelte-cgm1nj">中等</span></label> <label class="radio-item svelte-cgm1nj"><input type="radio" name="difficulty" class="svelte-cgm1nj"/> <span class="svelte-cgm1nj">困难</span></label> <label class="radio-item svelte-cgm1nj"><input type="radio" name="difficulty" class="svelte-cgm1nj"/> <span class="svelte-cgm1nj">混合</span></label></div></fieldset></div></section> <section class="config-section card-count svelte-cgm1nj"><div class="section-header svelte-cgm1nj"><h3 class="section-title svelte-cgm1nj">生成数量</h3></div> <div class="config-item svelte-cgm1nj"><label class="config-label visually-hidden svelte-cgm1nj" for="card-count-slider"> </label> <div class="slider-container svelte-cgm1nj"><input id="card-count-slider" type="range" min="1" max="50" class="config-slider svelte-cgm1nj"/> <span class="slider-value svelte-cgm1nj"> </span></div></div></section> <section class="config-section type-distribution svelte-cgm1nj"><div class="section-header svelte-cgm1nj"><h3 class="section-title svelte-cgm1nj">题型分布</h3></div> <div class="config-item svelte-cgm1nj"><fieldset class="config-fieldset svelte-cgm1nj"><legend class="visually-hidden svelte-cgm1nj">题型分布</legend> <div class="distribution-item svelte-cgm1nj"><label class="distribution-label svelte-cgm1nj" for="qa-distribution-slider">问答题</label> <div class="slider-container svelte-cgm1nj"><input id="qa-distribution-slider" type="range" min="0" max="100" class="config-slider svelte-cgm1nj"/> <span class="slider-value svelte-cgm1nj"> </span></div></div> <div class="distribution-item svelte-cgm1nj"><label class="distribution-label svelte-cgm1nj" for="cloze-distribution-slider">挖空题</label> <div class="slider-container svelte-cgm1nj"><input id="cloze-distribution-slider" type="range" min="0" max="100" class="config-slider svelte-cgm1nj"/> <span class="slider-value svelte-cgm1nj"> </span></div></div> <div class="distribution-item svelte-cgm1nj"><label class="distribution-label svelte-cgm1nj" for="choice-distribution-slider">选择题</label> <div class="slider-container svelte-cgm1nj"><input id="choice-distribution-slider" type="range" min="0" max="100" class="config-slider svelte-cgm1nj"/> <span class="slider-value svelte-cgm1nj"> </span></div></div></fieldset></div></section> <section class="config-section advanced-options svelte-cgm1nj"><div class="section-header svelte-cgm1nj"><h3 class="section-title svelte-cgm1nj">高级选项</h3></div> <div class="config-item svelte-cgm1nj"><label class="config-label svelte-cgm1nj" for="auto-tags-input">自动添加标签</label> <input id="auto-tags-input" type="text" placeholder="标签1, 标签2, ..." class="config-input svelte-cgm1nj"/></div> <div class="config-item svelte-cgm1nj"><label class="config-label switch-label svelte-cgm1nj"><span class="svelte-cgm1nj">启用提示/批注</span> <input type="checkbox" class="config-switch svelte-cgm1nj"/></label></div></section></div>'),uye=(e,t,n)=>t(bi(n).id),hye=la('<div role="button" tabindex="0"><!> <div class="item-content svelte-cgm1nj"><div class="item-title svelte-cgm1nj"> </div></div> <span class="official-badge svelte-cgm1nj">官方</span></div>'),pye=la('<div class="section-divider official-section svelte-cgm1nj"><div class="section-header svelte-cgm1nj"><h4 class="section-title svelte-cgm1nj">官方提示词</h4></div></div> <!>',1),gye=(e,t,n)=>t(bi(n).id),vye=(e,t,n)=>{e.stopPropagation(),t(bi(n).id)},fye=(e,t,n)=>{e.stopPropagation(),t(bi(n).id)},mye=la('<div role="button" tabindex="0"><!> <div class="item-content svelte-cgm1nj"><div class="item-title svelte-cgm1nj"> </div></div> <div class="item-actions svelte-cgm1nj"><button class="action-btn svelte-cgm1nj" title="编辑"><!></button> <button class="action-btn svelte-cgm1nj" title="删除"><!></button></div></div>'),yye=la('<div class="section-divider custom-section svelte-cgm1nj"><div class="section-header svelte-cgm1nj"><h4 class="section-title svelte-cgm1nj">自定义提示词</h4></div></div> <!>',1),bye=(e,t,n)=>t(bi(n).id,{name:e.target.value}),wye=(e,t,n)=>t(bi(n).id,{prompt:e.target.value}),kye=la('<div class="edit-form svelte-cgm1nj"><div class="edit-header svelte-cgm1nj"><h4 class="svelte-cgm1nj">编辑提示词</h4> <div class="instant-save-badge svelte-cgm1nj"><!> <span class="svelte-cgm1nj">更改即时保存</span></div></div> <div class="form-group svelte-cgm1nj"><label class="form-label svelte-cgm1nj" for="user-prompt-name">名称</label> <input id="user-prompt-name" type="text" placeholder="请输入提示词名称" class="form-input svelte-cgm1nj"/></div> <div class="form-group svelte-cgm1nj"><label class="form-label svelte-cgm1nj" for="user-prompt-content">提示词内容</label> <textarea id="user-prompt-content" placeholder="请输入提示词内容..." class="form-textarea svelte-cgm1nj" rows="10"></textarea> <div class="form-hint svelte-cgm1nj"></div></div> <div class="form-actions svelte-cgm1nj"><button class="btn btn-secondary svelte-cgm1nj">完成编辑</button></div></div>'),Sye=(e,t,n)=>t(bi(n)()),xye=()=>{new ge.Notice("使用此提示词")},_ye=la('<div class="preview-mode svelte-cgm1nj"><div class="preview-header svelte-cgm1nj"><h4 class="svelte-cgm1nj"> </h4> <div class="header-actions svelte-cgm1nj"><button class="copy-btn secondary svelte-cgm1nj"><!> 复制</button> <button class="use-btn svelte-cgm1nj"><!> 使用此提示词</button></div></div> <pre class="preview-content svelte-cgm1nj"> </pre></div>'),Cye=la('<div class="empty-preview svelte-cgm1nj"><!> <p class="svelte-cgm1nj">请从左侧选择一个提示词</p> <p class="hint-text svelte-cgm1nj">或点击"新建"按钮创建新提示词</p></div>'),Iye=la('<div class="tab-panel user-prompt-panel svelte-cgm1nj"><div class="panel-layout svelte-cgm1nj"><div class="sidebar-list svelte-cgm1nj"><div class="list-content svelte-cgm1nj"><!> <!> <div class="new-prompt-section svelte-cgm1nj"><button class="new-prompt-btn svelte-cgm1nj" title="新建自定义提示词"><!> <span class="svelte-cgm1nj">新建提示词</span></button></div></div></div> <div class="content-area svelte-cgm1nj"><!></div></div></div>'),Dye=la('<div class="modal-overlay svelte-cgm1nj" role="presentation"><div class="ai-config-modal svelte-cgm1nj" role="dialog" tabindex="-1"><div class="modal-header svelte-cgm1nj"><h2 class="modal-title svelte-cgm1nj"><!> AI制卡配置</h2> <button class="close-btn svelte-cgm1nj" title="关闭"><!></button></div> <div class="tab-header svelte-cgm1nj"><button><!> <span class="svelte-cgm1nj">系统提示词</span> <span class="tab-badge svelte-cgm1nj"> </span></button> <button><!> <span class="svelte-cgm1nj">卡片生成设置</span></button> <button><!> <span class="svelte-cgm1nj">用户提示词</span></button></div> <div class="tab-content-wrapper svelte-cgm1nj"><!> <!> <!> <!></div> <div class="modal-footer svelte-cgm1nj"><button class="reset-btn svelte-cgm1nj"><!> 重置默认</button> <div class="footer-actions svelte-cgm1nj"><button class="cancel-btn svelte-cgm1nj">取消</button> <button class="save-btn svelte-cgm1nj"><!> 保存并应用</button></div></div></div></div>');function Tye(e,t){if(new.target)return Er({component:Tye,...e});kt(t,!0);const n=[];let i=Ar(t,"plugin",7),a=Ar(t,"config",7),r=Ar(t,"isOpen",7),s=Ar(t,"onClose",7),o=Ar(t,"onSave",7),l=Pn("ai-config"),c=Pn(Ot([])),d=Pn(null),u=Pn(null),h=Pn(Ot([])),p=Pn(Ot([])),g=Pn(null),v=Pn(null);function f(e){var t;const n=JSON.parse(JSON.stringify(e));return n.provider||(n.provider=(null==(t=i().settings.aiConfig)?void 0:t.defaultProvider)||"zhipu"),n.model||(n.model=a().model||"gpt-4"),n.temperature||(n.temperature=.7),n.maxTokens||(n.maxTokens=4e3),n}let m=Pn(Ot(f(a()))),y=Pn(Ot([]));function b(e,t){const n={...bi(m).typeDistribution};n[e]=t;const i=["qa","cloze","choice"].filter(t=>t!==e),a=100-t,r=i.reduce((e,t)=>e+n[t],0);r>0?i.forEach(e=>{n[e]=Math.round(n[e]/r*a)}):(n[i[0]]=Math.floor(a/2),n[i[1]]=a-n[i[0]]),bi(m).typeDistribution=n}function w(){(function(){const e=[];(bi(m).cardCount<1||bi(m).cardCount>50)&&e.push("卡片数量必须在 1-50 之间");const t=Object.values(bi(m).typeDistribution).reduce((e,t)=>e+t,0);return Math.abs(t-100)>1&&e.push(`题型分布总和必须为 100%（当前: ${t}%）`),$n(y,e,!0),0===e.length})()&&o()(bi(m))}function k(){$n(m,f(a()),!0),$n(y,[],!0),s()()}Ti(()=>{var e,t,n,a,s;if(r()){const r=null==(e=i().settings.aiConfig)?void 0:e.systemPromptConfig;$n(c,(null==r?void 0:r.customSystemPrompts)||[],!0),$n(d,(null==r?void 0:r.selectedSystemPromptId)||null,!0),$n(h,((null==(n=null==(t=i().settings.aiConfig)?void 0:t.promptTemplates)?void 0:n.official)||[]).map(e=>{var t;return{...e,category:"official",useBuiltinSystemPrompt:null==(t=e.useBuiltinSystemPrompt)||t}}),!0),$n(p,(null==(s=null==(a=i().settings.aiConfig)?void 0:a.promptTemplates)?void 0:s.custom)||[],!0),$n(u,null),$n(v,null)}});const S=In(()=>()=>{if(bi(d)){const e=bi(c).find(e=>e.id===bi(d));if(e)return e.content}return D8.getBuiltinSystemPrompt(bi(m))}),x=In(()=>()=>{if(bi(d)){const e=bi(c).find(e=>e.id===bi(d));if(e)return e.name}return"内置系统提示词"});function _(e){$n(d,e,!0),$n(u,e,!0)}function C(e){var t;const n=(null==(t=bi(c).find(t=>t.id===e))?void 0:t.name)||"此提示词";confirm(`确定要删除“${n}”吗？`)&&($n(c,bi(c).filter(t=>t.id!==e),!0),bi(d)===e&&$n(d,null),bi(u)===e&&$n(u,null),T(),new ge.Notice(`🗑️ 已删除“${n}”`))}function I(e){$n(d,e,!0),T()}function D(e,t){const n=bi(c).findIndex(t=>t.id===e);n>=0&&(bi(c)[n]={...bi(c)[n],...t,updatedAt:(new Date).toISOString()},$n(c,[...bi(c)],!0),T())}async function T(){i().settings.aiConfig&&(i().settings.aiConfig.systemPromptConfig||(i().settings.aiConfig.systemPromptConfig={useBuiltin:!0,customPrompt:""}),i().settings.aiConfig.systemPromptConfig.customSystemPrompts=bi(c),i().settings.aiConfig.systemPromptConfig.selectedSystemPromptId=bi(d)||void 0,await i().saveSettings())}function M(e){var t;if(!i().settings.aiConfig)return;i().settings.aiConfig.systemPromptConfig||(i().settings.aiConfig.systemPromptConfig={useBuiltin:!0,customPrompt:""}),i().settings.aiConfig.systemPromptConfig.selectedSystemPromptId=e||void 0,$n(d,e,!0),i().saveSettings();const n=e?(null==(t=bi(c).find(t=>t.id===e))?void 0:t.name)||"未知":"内置系统提示词";new ge.Notice(`已设为默认: ${n}`)}const A=In(()=>[...bi(h),...bi(p)]),E=In(()=>()=>bi(g)&&bi(A).find(e=>e.id===bi(g))||null);function z(e){const t=bi(A).find(t=>t.id===e);"official"!==(null==t?void 0:t.category)?($n(g,e,!0),$n(v,e,!0)):new ge.Notice("官方提示词不可编辑")}function P(e){$n(g,e,!0),$n(v,null)}function R(e){const t=bi(A).find(t=>t.id===e);if("official"===(null==t?void 0:t.category))return void new ge.Notice("官方提示词不可删除");const n=(null==t?void 0:t.name)||"此提示词";confirm(`确定要删除“${n}”吗？`)&&($n(p,bi(p).filter(t=>t.id!==e),!0),bi(g)===e&&$n(g,null),bi(v)===e&&$n(v,null),O(),new ge.Notice(`🗑️ 已删除“${n}”`))}function $(e,t){const n=bi(p).findIndex(t=>t.id===e);n>=0&&(bi(p)[n]={...bi(p)[n],...t,updatedAt:(new Date).toISOString()},$n(p,[...bi(p)],!0),O())}async function O(){i().settings.aiConfig&&(i().settings.aiConfig.promptTemplates||(i().settings.aiConfig.promptTemplates={official:[],custom:[]}),i().settings.aiConfig.promptTemplates.custom=bi(p),await i().saveSettings())}function L(e){navigator.clipboard.writeText(e.prompt).then(()=>{new ge.Notice("已复制到剪贴板")}).catch(()=>{new ge.Notice("复制失败")})}var N={get plugin(){return i()},set plugin(e){i(e),hn()},get config(){return a()},set config(e){a(e),hn()},get isOpen(){return r()},set isOpen(e){r(e),hn()},get onClose(){return s()},set onClose(e){s(e),hn()},get onSave(){return o()},set onSave(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},F=ha();na("keydown",Ft,function(e){r()&&("Escape"===e.key?k():"Enter"===e.key&&(e.ctrlKey||e.metaKey)?w():(e.ctrlKey||e.metaKey)&&"1"===e.key?(e.preventDefault(),$n(l,"system-prompt")):(e.ctrlKey||e.metaKey)&&"2"===e.key?(e.preventDefault(),$n(l,"ai-config")):(e.ctrlKey||e.metaKey)&&"3"===e.key&&(e.preventDefault(),$n(l,"user-prompt")))});var B=Qt(F),j=e=>{var t=Dye();t.__click=k;var a=Gt(t);a.__click=[Ome];var r=Gt(a),s=Gt(r);m5(Gt(s),{name:"sliders",size:20}),Pt(),zt(s);var o=Kt(s,2);o.__click=k,m5(Gt(o),{name:"x",size:18}),zt(o),zt(r);var f=Kt(r,2),A=Gt(f);let N;A.__click=[Lme,l];var F=Gt(A);m5(F,{name:"file-text",size:16});var B=Kt(F,4),j=Gt(B);zt(B),zt(A);var U=Kt(A,2);let V;U.__click=[Nme,l],m5(Gt(U),{name:"settings",size:16}),Pt(2),zt(U);var q=Kt(U,2);let H;q.__click=[Fme,l],m5(Gt(q),{name:"message-square",size:16}),Pt(2),zt(q),zt(f);var W=Kt(f,2),G=Gt(W),Q=e=>{var t=jme();Ca(t,21,()=>bi(y),_a,(e,t)=>{var n=Bme(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(t),pa(e,t)};xa(G,e=>{bi(y).length>0&&e(Q)});var K=Kt(G,2),Z=e=>{var t=rye(),n=Gt(t),a=Gt(n),r=Kt(Gt(a),2),s=Gt(r);let o;s.__click=[Ume,I];var l=Gt(s);m5(l,{name:"sparkles",size:16});var h=Kt(l,2),p=Gt(h),g=Kt(Gt(p)),v=e=>{pa(e,Vme())};xa(g,e=>{var t,n,a,r;void 0!==(null==(n=null==(t=i().settings.aiConfig)?void 0:t.systemPromptConfig)?void 0:n.selectedSystemPromptId)&&null!==(null==(r=null==(a=i().settings.aiConfig)?void 0:a.systemPromptConfig)?void 0:r.selectedSystemPromptId)||e(v)}),zt(p),Pt(2),zt(h);var f=Kt(h,2),y=Gt(f),b=e=>{var t=Hme();t.__click=[qme,M],m5(Gt(t),{name:"star",size:12}),zt(t),pa(e,t)};xa(y,e=>{var t,n,a,r;void 0!==(null==(n=null==(t=i().settings.aiConfig)?void 0:t.systemPromptConfig)?void 0:n.selectedSystemPromptId)&&null!==(null==(r=null==(a=i().settings.aiConfig)?void 0:a.systemPromptConfig)?void 0:r.selectedSystemPromptId)&&e(b)}),zt(f),zt(s);var w=Kt(s,2);Ca(w,17,()=>bi(c),e=>e.id,(e,t)=>{var n=Jme();let a;n.__click=[Wme,I,t];var r=Gt(n);m5(r,{name:"file-text",size:16});var s=Kt(r,2),o=Gt(s),l=Gt(o),c=Kt(l),u=e=>{pa(e,Gme())};xa(c,e=>{var n,a;(null==(a=null==(n=i().settings.aiConfig)?void 0:n.systemPromptConfig)?void 0:a.selectedSystemPromptId)===bi(t).id&&e(u)}),zt(o);var h=Kt(o,2),p=e=>{var n=Qme(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t).description)),pa(e,n)};xa(h,e=>{bi(t).description&&e(p)}),zt(s);var g=Kt(s,2),v=Gt(g),f=e=>{var n=Zme();n.__click=[Kme,M,t],m5(Gt(n),{name:"star",size:12}),zt(n),pa(e,n)};xa(v,e=>{var n,a;(null==(a=null==(n=i().settings.aiConfig)?void 0:n.systemPromptConfig)?void 0:a.selectedSystemPromptId)!==bi(t).id&&e(f)});var m=Kt(v,2);m.__click=[Yme,_,t],m5(Gt(m),{name:"edit",size:12}),zt(m);var y=Kt(m,2);y.__click=[Xme,C,t],m5(Gt(y),{name:"trash",size:12}),zt(y),zt(g),zt(n),zi(e=>{var i;a=Fa(n,1,"list-item svelte-cgm1nj",null,a,e),va(l,`${null!=(i=bi(t).name)?i:""} `)},[()=>({active:bi(d)===bi(t).id})]),pa(e,n)});var k=Kt(w,2),A=Gt(k);A.__click=[Eme,c,m,d,u,T],m5(Gt(A),{name:"plus",size:16}),Pt(2),zt(A),zt(k),zt(r),zt(a);var E=Kt(a,2),z=Gt(E),P=e=>{const t=In(()=>bi(c).find(e=>e.id===bi(u)));var n=ha(),i=Qt(n),a=e=>{var n=iye(),i=Gt(n),a=Kt(Gt(i),2);m5(Gt(a),{name:"zap",size:12}),Pt(2),zt(a),zt(i);var r=Kt(i,2),s=Kt(Gt(r),2);Za(s),s.__input=[eye,D,t],zt(r);var o=Kt(r,2),l=Kt(Gt(o),2);Za(l),l.__input=[tye,D,t],zt(o);var h=Kt(o,2),p=Kt(Gt(h),2);jn(p),p.__input=[nye,D,t],zt(h);var g=Kt(h,2);Gt(g).__click=[zme,u,c,d,T],zt(g),zt(n),zi(()=>{Ya(s,bi(t).name),Ya(l,bi(t).description||""),Ya(p,bi(t).content)}),pa(e,n)};xa(i,e=>{bi(t)&&e(a)}),pa(e,n)},R=e=>{var t=aye(),n=Gt(t),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2);r.__click=[Pme,S],m5(Gt(r),{name:"copy",size:14}),Pt(),zt(r),zt(n);var s=Kt(n,2),o=Gt(s,!0);zt(s),zt(t),zi((e,t)=>{va(a,e),va(o,t)},[()=>bi(x)(),()=>bi(S)()]),pa(e,t)};xa(z,e=>{bi(u)?e(P):e(R,!1)}),zt(E),zt(n),zt(t),zi(e=>{o=Fa(s,1,"list-item svelte-cgm1nj",null,o,e),A.disabled=bi(c).length>=5,er(A,"title",bi(c).length>=5?"最多创建5个自定义系统提示词":"新建系统提示词")},[()=>({active:null===bi(d)})]),pa(e,t)};xa(K,e=>{"system-prompt"===bi(l)&&e(Z)});var Y=Kt(K,2),X=e=>{var t=dye(),i=Gt(t),a=Kt(Gt(i),2),r=Gt(a),s=Kt(Gt(r),2),o=Gt(s),l=Gt(o);Za(l),l.value=l.__value="easy",Pt(2),zt(o);var c=Kt(o,2),d=Gt(c);Za(d),d.value=d.__value="medium",Pt(2),zt(c);var u=Kt(c,2),h=Gt(u);Za(h),h.value=h.__value="hard",Pt(2),zt(u);var p=Kt(u,2),g=Gt(p);Za(g),g.value=g.__value="mixed",Pt(2),zt(p),zt(s),zt(r),zt(a),zt(i);var v=Kt(i,2),f=Kt(Gt(v),2),y=Gt(f),w=Gt(y);zt(y);var k=Kt(y,2),S=Gt(k);Za(S);var x=Kt(S,2),_=Gt(x);zt(x),zt(k),zt(f),zt(v);var C=Kt(v,2),I=Kt(Gt(C),2),D=Gt(I),T=Kt(Gt(D),2),M=Kt(Gt(T),2),A=Gt(M);Za(A),A.__input=[sye,b];var E=Kt(A,2),z=Gt(E);zt(E),zt(M),zt(T);var P=Kt(T,2),R=Kt(Gt(P),2),$=Gt(R);Za($),$.__input=[oye,b];var O=Kt($,2),L=Gt(O);zt(O),zt(R),zt(P);var N=Kt(P,2),F=Kt(Gt(N),2),B=Gt(F);Za(B),B.__input=[lye,b];var j=Kt(B,2),U=Gt(j);zt(j),zt(F),zt(N),zt(D),zt(I),zt(C);var V=Kt(C,2),q=Kt(Gt(V),2),H=Kt(Gt(q),2);Za(H),H.__input=[cye,m],zt(q);var W=Kt(q,2),G=Gt(W),Q=Kt(Gt(G),2);Za(Q),zt(G),zt(W),zt(V),zt(t),zi(e=>{var t,n,i,a,r;va(w,`生成数量 (${null!=(t=bi(m).cardCount)?t:""} 张)`),va(_,`${null!=(n=bi(m).cardCount)?n:""} 张`),Ya(A,bi(m).typeDistribution.qa),va(z,`${null!=(i=bi(m).typeDistribution.qa)?i:""}%`),Ya($,bi(m).typeDistribution.cloze),va(L,`${null!=(a=bi(m).typeDistribution.cloze)?a:""}%`),Ya(B,bi(m).typeDistribution.choice),va(U,`${null!=(r=bi(m).typeDistribution.choice)?r:""}%`),Ya(H,e)},[()=>bi(m).autoTags.join(", ")]),vr(n,[],l,()=>bi(m).difficulty,e=>bi(m).difficulty=e),vr(n,[],d,()=>bi(m).difficulty,e=>bi(m).difficulty=e),vr(n,[],h,()=>bi(m).difficulty,e=>bi(m).difficulty=e),vr(n,[],g,()=>bi(m).difficulty,e=>bi(m).difficulty=e),pr(S,()=>bi(m).cardCount,e=>bi(m).cardCount=e),fr(Q,()=>bi(m).enableHints,e=>bi(m).enableHints=e),pa(e,t)};xa(Y,e=>{"ai-config"===bi(l)&&e(X)});var J=Kt(Y,2),ee=e=>{var t=Iye(),n=Gt(t),i=Gt(n),a=Gt(i),r=Gt(a),s=e=>{var t=pye();Ca(Kt(Qt(t),2),17,()=>bi(h),e=>e.id,(e,t)=>{var n=hye();let i;n.__click=[uye,P,t];var a=Gt(n);m5(a,{name:"sparkles",size:16});var r=Kt(a,2),s=Gt(r),o=Gt(s,!0);zt(s),zt(r),Pt(2),zt(n),zi(e=>{i=Fa(n,1,"list-item official svelte-cgm1nj",null,i,e),va(o,bi(t).name)},[()=>({active:bi(g)===bi(t).id&&!bi(v)})]),pa(e,n)}),pa(e,t)};xa(r,e=>{bi(h).length>0&&e(s)});var o=Kt(r,2),l=e=>{var t=yye();Ca(Kt(Qt(t),2),17,()=>bi(p),e=>e.id,(e,t)=>{var n=mye();let i;n.__click=[gye,P,t];var a=Gt(n);m5(a,{name:"message-square",size:12});var r=Kt(a,2),s=Gt(r),o=Gt(s,!0);zt(s),zt(r);var l=Kt(r,2),c=Gt(l);c.__click=[vye,z,t],m5(Gt(c),{name:"edit",size:12}),zt(c);var d=Kt(c,2);d.__click=[fye,R,t],m5(Gt(d),{name:"trash",size:12}),zt(d),zt(l),zt(n),zi(e=>{i=Fa(n,1,"list-item svelte-cgm1nj",null,i,e),va(o,bi(t).name)},[()=>({active:bi(g)===bi(t).id&&!bi(v)})]),pa(e,n)}),pa(e,t)};xa(o,e=>{bi(p).length>0&&e(l)});var c=Kt(o,2),d=Gt(c);d.__click=[Rme,p,g,v,O],m5(Gt(d),{name:"plus",size:16}),Pt(2),zt(d),zt(c),zt(a),zt(i);var u=Kt(i,2),f=Gt(u),m=e=>{const t=In(()=>bi(p).find(e=>e.id===bi(v)));var n=ha(),i=Qt(n),a=e=>{var n=kye(),i=Gt(n),a=Kt(Gt(i),2);m5(Gt(a),{name:"zap",size:12}),Pt(2),zt(a),zt(i);var r=Kt(i,2),s=Kt(Gt(r),2);Za(s),s.__input=[bye,$,t],zt(r);var o=Kt(r,2),l=Kt(Gt(o),2);jn(l),l.__input=[wye,$,t],Kt(l,2).textContent="可以使用变量：{count}（卡片数量）、{difficulty}（难度）等",zt(o);var c=Kt(o,2);Gt(c).__click=[$me,v,p,g,O],zt(c),zt(n),zi(()=>{Ya(s,bi(t).name),Ya(l,bi(t).prompt)}),pa(e,n)};xa(i,e=>{bi(t)&&e(a)}),pa(e,n)},y=e=>{var t=ha(),n=Qt(t),i=e=>{var t=_ye(),n=Gt(t),i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r);s.__click=[Sye,L,E],m5(Gt(s),{name:"copy",size:14}),Pt(),zt(s);var o=Kt(s,2);o.__click=[xye],m5(Gt(o),{name:"check",size:14}),Pt(),zt(o),zt(r),zt(n);var l=Kt(n,2),c=Gt(l,!0);zt(l),zt(t),zi((e,t)=>{va(a,e),va(c,t)},[()=>bi(E)().name,()=>bi(E)().prompt]),pa(e,t)},a=e=>{var t=Cye();m5(Gt(t),{name:"file-text",size:48}),Pt(4),zt(t),pa(e,t)};xa(n,e=>{bi(E)()?e(i):e(a,!1)},!0),pa(e,t)};xa(f,e=>{bi(v)?e(m):e(y,!1)}),zt(u),zt(n),zt(t),pa(e,t)};xa(J,e=>{"user-prompt"===bi(l)&&e(ee)}),zt(W);var te=Kt(W,2),ne=Gt(te);ne.__click=[Ame,m],m5(Gt(ne),{name:"rotate-ccw",size:14}),Pt(),zt(ne);var ie=Kt(ne,2),ae=Gt(ie);ae.__click=k;var re=Kt(ae,2);re.__click=w,m5(Gt(re),{name:"check",size:16}),Pt(),zt(re),zt(ie),zt(te),zt(a),zt(t),zi((e,t,n)=>{var i;N=Fa(A,1,"tab-button svelte-cgm1nj",null,N,e),va(j,`${null!=(i=bi(c).length)?i:""}/5`),V=Fa(U,1,"tab-button svelte-cgm1nj",null,V,t),H=Fa(q,1,"tab-button svelte-cgm1nj",null,H,n)},[()=>({active:"system-prompt"===bi(l)}),()=>({active:"ai-config"===bi(l)}),()=>({active:"user-prompt"===bi(l)})]),pa(e,t)};return xa(B,e=>{r()&&e(j)}),pa(e,F),St(N)}function Mye(e,t){"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),t())}function Aye(e,t){$n(t,[],!0)}ia(["click","input"]);var Eye=la('<div><div class="message-header svelte-k3prr6"><span class="message-role svelte-k3prr6"> </span> <span class="message-time svelte-k3prr6"> </span></div> <div class="message-content svelte-k3prr6"> </div></div>'),zye=la('<div class="dialog-history svelte-k3prr6"><div class="history-header svelte-k3prr6"><span class="history-title svelte-k3prr6">对话历史</span> <button class="clear-history-btn svelte-k3prr6" title="清空历史"><!></button></div> <div class="messages svelte-k3prr6"></div></div>'),Pye=la('<div class="regenerate-dialog svelte-k3prr6"><!> <div class="dialog-input svelte-k3prr6"><div class="input-header svelte-k3prr6"><!> <span>输入修改要求</span></div> <textarea placeholder="例如：请增加更多细节；答案太简单，请扩展；问题需要更具体..." rows="4" class="svelte-k3prr6"></textarea> <div class="input-footer svelte-k3prr6"><span class="hint svelte-k3prr6">Ctrl+Enter 提交</span> <button class="submit-btn svelte-k3prr6"><!> <span> </span></button></div></div></div>');function Rye(e,t){if(new.target)return Er({component:Rye,...e});kt(t,!0);let n=Ar(t,"currentCard",7),i=Ar(t,"onRegenerate",7),a=Pn(""),r=Pn(Ot([])),s=Pn(!1);async function o(){const e=bi(a).trim();if(!e)return;const t={role:"user",content:e,timestamp:(new Date).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})};$n(r,[...bi(r),t],!0);const n=e;$n(a,"");try{$n(s,!0),await i()(n);const e={role:"assistant",content:"已根据您的要求重新生成卡片，请查看更新后的内容。",timestamp:(new Date).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})};$n(r,[...bi(r),e],!0)}catch(o){const e={role:"assistant",content:`重新生成失败：${o instanceof Error?o.message:"未知错误"}`,timestamp:(new Date).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})};$n(r,[...bi(r),e],!0)}finally{$n(s,!1)}}var l={get currentCard(){return n()},set currentCard(e){n(e),hn()},get onRegenerate(){return i()},set onRegenerate(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=Pye(),d=Gt(c),u=e=>{var t=zye(),n=Gt(t),i=Kt(Gt(n),2);i.__click=[Aye,r],m5(Gt(i),{name:"trash-2",size:14}),zt(i),zt(n);var a=Kt(n,2);Ca(a,21,()=>bi(r),_a,(e,t)=>{var n=Eye();let i;var a=Gt(n),r=Gt(a),s=Gt(r,!0);zt(r);var o=Kt(r,2),l=Gt(o,!0);zt(o),zt(a);var c=Kt(a,2),d=Gt(c,!0);zt(c),zt(n),zi(e=>{i=Fa(n,1,"message svelte-k3prr6",null,i,e),va(s,"user"===bi(t).role?"你":"AI助手"),va(l,bi(t).timestamp),va(d,bi(t).content)},[()=>({user:"user"===bi(t).role})]),pa(e,n)}),zt(a),zt(t),pa(e,t)};xa(d,e=>{bi(r).length>0&&e(u)});var h=Kt(d,2),p=Gt(h);m5(Gt(p),{name:"edit-3",size:14}),Pt(2),zt(p);var g=Kt(p,2);jn(g),g.__keydown=[Mye,o];var v=Kt(g,2),f=Kt(Gt(v),2);f.__click=o;var m=Gt(f);m5(m,{name:"send",size:14});var y=Kt(m,2),b=Gt(y,!0);return zt(y),zt(f),zt(v),zt(h),zt(c),zi(e=>{g.disabled=bi(s),f.disabled=e,va(b,bi(s)?"生成中...":"重新生成")},[()=>!bi(a).trim()||bi(s)]),pr(g,()=>bi(a),e=>$n(a,e)),pa(e,c),St(l)}ia(["click","keydown"]);class $ye{static convert(e,t,n,i,a){try{const r=(new Date).toISOString(),s=Vu();let o;if(e.content)o=e.content;else if(e.front||e.back){const t=e.front||"",n=e.back||"";o=n?`${t}\n\n---div---\n\n${n}`:t}else o="";const l=this.getTemplateId(e.type,i),c=this.parseCardContent(o,e.type);let d,u;c.success?(d=c.fields,u=c.metadata):(_e.warn("[CardConverter] 解析失败，使用降级方案:",c.error),d=this.mapFieldsFromGeneratedCard(e),u=void 0);return{success:!0,card:{id:s,uuid:s,deckId:t,templateId:l,type:this.mapCardType(e.type),content:o,fields:d,parsedMetadata:u,sourceFile:n,sourceExists:!!n,fsrs:a?a.createCard():{due:new Date(Date.now()-1e3).toISOString(),stability:0,difficulty:5,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,state:0,lastReview:void 0,retrievability:1},reviewHistory:[],stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},created:r,modified:r,tags:e.tags||[],priority:0,metadata:{aiGenerated:!0,provider:e.metadata.provider,model:e.metadata.model,generatedAt:e.metadata.generatedAt}}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"卡片转换失败"}}}static convertBatch(e,t,n,i,a){const r=[],s=[];for(const o of e){const e=this.convert(o,t,n,i,a);e.success&&e.card?r.push(e.card):e.error&&s.push(e.error)}return{cards:r,errors:s}}static mapCardType(e){switch(e){case"qa":default:return Kr.Basic;case"cloze":return Kr.Cloze;case"choice":return Kr.Multiple}}static getTemplateId(e,t){if(t)switch(e){case"qa":return t.qa||"official-qa";case"choice":return t.choice||"official-choice";case"cloze":return t.cloze||"official-cloze"}switch(e){case"qa":default:return"official-qa";case"choice":return"official-choice";case"cloze":return"official-cloze"}}static mapFieldsFromGeneratedCard(e){const t=e.front||"",n=e.back||"";switch(e.type){case"qa":default:return{front:t,back:n};case"choice":{const e={front:t,back:n};if(t){const n=t.match(/[A-D]\)[^\n]+/g);if(n){e.options=n.join("\n");const t=n.filter(e=>e.includes("{✓}")||e.includes("{√}"));t.length>0&&(e.correctAnswers=t.map(e=>e.charAt(0)).join(","))}}return e}case"cloze":return{text:t,hint:n||""}}}static convertForPreview(e){var t,n,i;const a=(new Date).toISOString(),r=Vu();let s;if(e.content)s=e.content;else if(e.front||e.back){const t=e.front||"",n=e.back||"";s=n?`${t}\n\n---div---\n\n${n}`:t}else s="";const o=this.parseCardContent(s,e.type);let l,c;o.success?(l=o.fields,c=o.metadata):(_e.warn("[CardConverter] 预览解析失败，使用降级方案:",o.error),l=this.mapFieldsFromGeneratedCard(e),c=void 0);return{id:r,uuid:r,deckId:"preview-deck",templateId:this.getDefaultTemplateId(e.type),type:this.mapCardType(e.type),content:s,fields:l,parsedMetadata:c,sourceFile:void 0,sourceExists:!1,created:a,modified:a,fsrs:{state:0,difficulty:0,stability:0,due:a,lastReview:void 0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,retrievability:1},tags:[],metadata:{aiGenerated:!0,provider:(null==(t=e.metadata)?void 0:t.provider)||"unknown",model:(null==(n=e.metadata)?void 0:n.model)||"unknown",generatedAt:(null==(i=e.metadata)?void 0:i.generatedAt)||a},stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},priority:0,reviewHistory:[]}}static parseCardContent(e,t){const n=this.mapToParserCardType(t);try{switch(t){case"qa":return(new mh).parseMarkdownToFields(e,n);case"choice":return(new yh).parseMarkdownToFields(e,n);case"cloze":return(new wh).parseMarkdownToFields(e,n);default:return{success:!1,fields:{},rawContent:e,error:{type:"unknown_card_type",message:`未知的卡片类型: ${t}`}}}}catch(i){return _e.error("[CardConverter] 解析失败:",i),{success:!1,fields:{},rawContent:e,error:{type:"invalid_format",message:i instanceof Error?i.message:"解析失败"}}}}static mapToParserCardType(e){switch(e){case"qa":default:return"basic-qa";case"choice":return"single-choice";case"cloze":return"cloze-deletion"}}static getDefaultTemplateId(e){switch(e){case"qa":return"official-qa";case"cloze":return"official-cloze";case"choice":return"official-choice";default:return"basic"}}}const Oye=Object.freeze(Object.defineProperty({__proto__:null,CardConverter:$ye},Symbol.toStringTag,{value:"Module"}));function Lye(e,t,n,i,a){bi(t)===n().length&&n().length>0?i():a()}function Nye(e,t){$n(t,!bi(t))}async function Fye(e,t,n,i,a,r,s,o,l){if(0===bi(t))return void new ge.Notice("请至少选择一张卡片");if(!bi(n))return void new ge.Notice("请选择目标牌组");const c=i().filter(e=>bi(a).has(e.uuid)),d=bi(r).find(e=>e.id===bi(n)),u=(null==d?void 0:d.name)||bi(n);try{$n(s,!0),await o()(c,bi(n)),new ge.Notice(`成功导入 ${bi(t)} 张卡片到 ${u}`),l()()}catch(h){_e.error("Import failed:",h),new ge.Notice(h instanceof Error?h.message:"导入失败")}finally{$n(s,!1)}}var Bye=e=>e.stopPropagation(),jye=(e,t)=>"Escape"===e.key&&t()(),Uye=la('<span class="generation-status svelte-xjbo47"><!> <span class="svelte-xjbo47"> </span></span>'),Vye=la('<span class="difficulty-badge svelte-xjbo47"> </span>'),qye=la('<div class="card-preview-wrapper svelte-xjbo47"><!></div>'),Hye=la('<div class="card-section svelte-xjbo47"><div class="no-preview-warning svelte-xjbo47">⚠️ 卡片预览加载失败</div></div>'),Wye=la('<div class="card-display svelte-xjbo47"><div class="card-meta svelte-xjbo47"><div class="card-meta-left svelte-xjbo47"><span class="template-badge svelte-xjbo47"> </span> <!></div> <label class="card-select-checkbox svelte-xjbo47"><input type="checkbox" class="svelte-xjbo47"/> <span class="svelte-xjbo47"> </span></label></div> <!> <button><!> <span class="svelte-xjbo47"> </span></button></div> <!>',1),Gye=la('<div class="thumbnail-check svelte-xjbo47"><!></div>'),Qye=la('<div role="button" tabindex="0"><div class="thumbnail-number svelte-xjbo47"></div> <!></div>'),Kye=la('<div class="thumbnail skeleton svelte-xjbo47"><div class="skeleton-loader svelte-xjbo47"></div></div>'),Zye=la('<option class="svelte-xjbo47"> </option>'),Yye=la('<div class="card-preview-overlay svelte-xjbo47" role="presentation"><div class="card-preview-modal svelte-xjbo47" role="dialog" tabindex="-1"><div class="preview-header svelte-xjbo47"><button class="back-btn svelte-xjbo47"><!> <span class="svelte-xjbo47"> </span></button> <div class="preview-title svelte-xjbo47"><h3 class="svelte-xjbo47"> </h3> <div class="card-counter svelte-xjbo47"><span class="current-num svelte-xjbo47"> </span> <span class="separator svelte-xjbo47">/</span> <span class="total-num svelte-xjbo47"> </span> <!></div></div> <button class="preview-close svelte-xjbo47"><!></button></div> <div class="preview-body svelte-xjbo47"><div class="preview-main-content svelte-xjbo47"><!></div></div> <div class="preview-footer svelte-xjbo47"><div class="card-navigation svelte-xjbo47"><button class="nav-btn svelte-xjbo47"><!> <span class="svelte-xjbo47"> </span></button> <div class="thumbnail-strip svelte-xjbo47"><!> <!></div> <button class="nav-btn svelte-xjbo47"><span class="svelte-xjbo47"> </span> <!></button></div> <div class="preview-actions svelte-xjbo47"><div class="batch-actions svelte-xjbo47"><button class="action-btn svelte-xjbo47"><!> <span class="svelte-xjbo47"> </span></button></div> <div class="selection-info svelte-xjbo47"><div class="selection-stats svelte-xjbo47"><span class="selection-count svelte-xjbo47"> <strong class="svelte-xjbo47"> </strong> </span> <div class="deck-selector svelte-xjbo47"><label for="target-deck" class="svelte-xjbo47"> </label> <select id="target-deck" class="svelte-xjbo47"></select></div></div> <button class="import-btn svelte-xjbo47"><!> <span class="svelte-xjbo47"> </span></button></div></div></div></div></div>');function Xye(e,t){if(new.target)return Er({component:Xye,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"plugin",7),s=Ar(t,"cards",7),o=Ar(t,"config",7),l=Ar(t,"isOpen",7),c=Ar(t,"isGenerating",7,!1),d=Ar(t,"totalCards",7,0),u=Ar(t,"mode",7,"test"),h=Ar(t,"onClose",7),p=Ar(t,"onImport",7),g=In(n),v=Pn(0),f=Pn(Ot(new Set)),m=Pn(!1),y=Pn(!1),b=Pn(Ot([])),w=Pn(""),k=Pn(null),S=Pn(!0);Ti(()=>{if(bi(x))try{$n(k,$ye.convertForPreview(bi(x)),!0)}catch(e){_e.error("[CardPreviewModal] 卡片转换失败:",e),$n(k,null)}else $n(k,null)});let x=In(()=>s()[bi(v)]),_=In(()=>bi(f).size),C=In(()=>!!bi(x)&&bi(f).has(bi(x).uuid)),I=In(()=>bi(_)===s().length&&s().length>0),D=In(()=>bi(v)>0),T=In(()=>bi(v)<s().length-1);function M(){bi(D)&&(Ln(v,-1),$n(m,!1))}function A(){bi(T)&&(Ln(v),$n(m,!1))}function E(e){e>=0&&e<s().length&&($n(v,e,!0),$n(m,!1))}function z(){if(!bi(x))return;const e=new Set(bi(f));e.has(bi(x).uuid)?e.delete(bi(x).uuid):e.add(bi(x).uuid),$n(f,e,!0)}function P(){$n(f,new Set(s().map(e=>e.uuid)),!0)}function R(){$n(f,new Set,!0)}async function $(e){var t;if(bi(x))try{new ge.Notice("正在重新生成卡片...");const{AIServiceFactory:n}=await Promise.resolve().then(()=>O8),i=n.getDefaultService(r());let a="",l={qa:0,cloze:0,choice:0};"cloze"===bi(x).type?(l.cloze=100,a=`\n原始内容：${bi(x).front}\n卡片类型：挖空题（cloze）\n\n用户修改要求：${e}\n\n请根据用户的修改要求重新生成这张挖空题卡片。\n\n返回JSON数组，格式如下：\n[\n  {\n    "type": "cloze",\n    "front": "完整原文（用==文本==标记需要挖空的部分）",\n    "back": ""\n  }\n]\n\n注意：\n1. 使用==文本==语法标记挖空部分（不是{{c1::}}）\n2. back字段留空或重复front内容\n3. 返回的必须是包含1个对象的JSON数组`):"choice"===bi(x).type?(l.choice=100,a=`\n原始问题：${bi(x).front}\n原始选项：${JSON.stringify(bi(x).choices)}\n正确答案索引：${bi(x).correctAnswer}\n卡片类型：选择题（choice）\n\n用户修改要求：${e}\n\n请根据用户的修改要求重新生成这张选择题卡片。\n\n返回JSON数组，格式如下：\n[\n  {\n    "type": "choice",\n    "front": "问题内容",\n    "back": "正确答案文本",\n    "choices": ["选项A", "选项B", "选项C", "选项D"],\n    "correctAnswer": 0\n  }\n]\n\n注意：\n1. choices必须是包含4个选项的字符串数组\n2. correctAnswer是正确答案的索引（0-3）\n3. 返回的必须是包含1个对象的JSON数组`):(l.qa=100,a=`\n原始问题：${bi(x).front}\n原始答案：${bi(x).back}\n卡片类型：问答题（qa）\n\n用户修改要求：${e}\n\n请根据用户的修改要求重新生成这张问答题卡片。\n\n返回JSON数组，格式如下：\n[\n  {\n    "type": "qa",\n    "front": "修改后的问题",\n    "back": "修改后的答案"\n  }\n]\n\n注意：返回的必须是包含1个对象的JSON数组`);const c=r().settings.aiConfig,d=o().provider,u=o().model,h=null==(t=c.apiKeys)?void 0:t[d];if(!h||!h.apiKey)throw new Error(`${d} API密钥未配置`);const p=await i.generateCards(a,{templateId:"regenerate",promptTemplate:a,cardCount:1,difficulty:bi(x).metadata.difficulty||"medium",typeDistribution:l,provider:d,model:u,temperature:o().temperature,maxTokens:o().maxTokens,imageGeneration:{enabled:!1,strategy:"none",imagesPerCard:0,placement:"question"},autoTags:[],enableHints:!1},()=>{});if(!(p.success&&p.cards&&p.cards.length>0))throw new Error(p.error||"生成失败");{const e=p.cards[0],t={...bi(x),front:e.front,back:e.back,..."choice"===bi(x).type&&{choices:e.choices,correctAnswer:e.correctAnswer}},n=[...s()];n[bi(v)]=t,s(n),new ge.Notice("卡片已重新生成"),$n(m,!1)}}catch(n){_e.error("Regenerate failed:",n),new ge.Notice(n instanceof Error?n.message:"重新生成失败")}}function O(e){if(l())switch(e.key){case"Escape":h()();break;case"ArrowLeft":M();break;case"ArrowRight":A();break;case" ":e.preventDefault(),z()}}Ti(()=>(l()&&(window.addEventListener("keydown",O),async function(){try{_e.debug("[CardPreviewModal] 开始加载牌组列表, mode:",u());const e=await r().dataStorage.getDecks();_e.debug("[CardPreviewModal] 获取到所有牌组:",e.length),"split"===u()?($n(b,e.filter(e=>"test"!==e.purpose).map(e=>({id:e.id,name:e.name})),!0),_e.debug("[CardPreviewModal] 拆分模式，过滤后牌组:",bi(b).length)):($n(b,e.filter(e=>"test"===e.purpose).map(e=>({id:e.id,name:e.name})),!0),_e.debug("[CardPreviewModal] 测试题模式，过滤后牌组:",bi(b).length)),0===bi(b).length&&(_e.warn("[CardPreviewModal] 没有匹配的牌组，显示所有牌组"),$n(b,e.map(e=>({id:e.id,name:e.name})),!0));const t=o().targetDeck;if(t){const e=bi(b).find(e=>e.id===t||e.name===t);e?$n(w,e.id,!0):bi(b).length>0&&$n(w,bi(b)[0].id,!0)}else bi(b).length>0&&$n(w,bi(b)[0].id,!0);_e.debug("[CardPreviewModal] 最终可用牌组:",bi(b).length,"选中:",bi(w))}catch(e){_e.error("[CardPreviewModal] Load decks failed:",e);const t="split"===u()?"默认记忆牌组":"默认题库牌组";$n(b,[{id:"default",name:t}],!0),$n(w,"default")}}()),()=>{l()&&window.removeEventListener("keydown",O)})),Ti(()=>{l()&&($n(v,0),$n(f,new Set(s().map(e=>e.uuid)),!0),$n(m,!1))});var L={get plugin(){return r()},set plugin(e){r(e),hn()},get cards(){return s()},set cards(e){s(e),hn()},get config(){return o()},set config(e){o(e),hn()},get isOpen(){return l()},set isOpen(e){l(e),hn()},get isGenerating(){return c()},set isGenerating(e=!1){c(e),hn()},get totalCards(){return d()},set totalCards(e=0){d(e),hn()},get mode(){return u()},set mode(e="test"){u(e),hn()},get onClose(){return h()},set onClose(e){h(e),hn()},get onImport(){return p()},set onImport(e){p(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},N=ha(),F=Qt(N),B=e=>{var t=Yye();t.__click=function(...e){var t;null==(t=h())||t.apply(this,e)};var n=Gt(t);n.__click=[Bye],n.__keydown=[jye,h];var i=Gt(n),a=Gt(i);a.__click=function(...e){var t;null==(t=h())||t.apply(this,e)};var o=Gt(a);m5(o,{name:"arrow-left",size:18});var l=Kt(o,2),O=Gt(l,!0);zt(l),zt(a);var L=Kt(a,2),N=Gt(L),F=Gt(N,!0);zt(N);var B=Kt(N,2),j=Gt(B),U=Gt(j,!0);zt(j);var V=Kt(j,4),q=Gt(V,!0);zt(V);var H=Kt(V,2),W=e=>{var t=Uye(),n=Gt(t);m5(n,{name:"loader",size:14});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(e=>va(a,e),[()=>bi(g)("modals.cardPreview.generatingProgress",{current:s().length,total:d()})]),pa(e,t)};xa(H,e=>{c()&&e(W)}),zt(B),zt(L);var G=Kt(L,2);G.__click=function(...e){var t;null==(t=h())||t.apply(this,e)},m5(Gt(G),{name:"x",size:20}),zt(G),zt(i);var Q=Kt(i,2),K=Gt(Q),Z=Gt(K),Y=e=>{var t=Wye(),n=Qt(t),i=Gt(n),a=Gt(i),s=Gt(a),o=Gt(s,!0);zt(s);var l=Kt(s,2),c=e=>{var t=Vye(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(x).metadata.difficulty)),pa(e,t)};xa(l,e=>{bi(x).metadata.difficulty&&e(c)}),zt(a);var d=Kt(a,2),u=Gt(d);Za(u),u.__change=z;var h=Kt(u,2),p=Gt(h,!0);zt(h),zt(d),zt(i);var v=Kt(i,2),f=e=>{var t=qye();f8(Gt(t),{get card(){return bi(k)},get plugin(){return r()},enableAnimations:!0,enableAnswerControls:!0,get showAnswer(){return bi(S)},set showAnswer(e){$n(S,e,!0)}}),zt(t),pa(e,t)},y=e=>{pa(e,Hye())};xa(v,e=>{bi(k)?e(f):e(y,!1)});var b=Kt(v,2);let w;b.__click=[Nye,m];var _=Gt(b);m5(_,{name:"message-square",size:16});var I=Kt(_,2),D=Gt(I,!0);zt(I),zt(b),zt(n);var T=Kt(n,2),M=e=>{Rye(e,{get currentCard(){return bi(x)},onRegenerate:$})};xa(T,e=>{bi(m)&&e(M)}),zi((e,t,n)=>{va(o,bi(x).type),Xa(u,bi(C)),va(p,e),w=Fa(b,1,"regenerate-toggle-btn svelte-xjbo47",null,w,t),va(D,n)},[()=>bi(g)("modals.cardPreview.selectCard"),()=>({active:bi(m)}),()=>bi(g)(bi(m)?"modals.cardPreview.collapseDialog":"modals.cardPreview.modifyRequirement")]),pa(e,t)};xa(Z,e=>{bi(x)&&e(Y)}),zt(K),zt(Q);var X=Kt(Q,2),J=Gt(X),ee=Gt(J);ee.__click=M;var te=Gt(ee);m5(te,{name:"chevron-left",size:20});var ne=Kt(te,2),ie=Gt(ne,!0);zt(ne),zt(ee);var ae=Kt(ee,2),re=Gt(ae);Ca(re,17,s,_a,(e,t,n)=>{var i=Qye();let a;i.__click=()=>E(n),i.__keydown=e=>("Enter"===e.key||" "===e.key)&&E(n);var r=Gt(i);r.textContent=n+1;var s=Kt(r,2),o=e=>{var t=Gye();m5(Gt(t),{name:"check",size:12}),zt(t),pa(e,t)};xa(s,e=>{bi(f).has(bi(t).uuid)&&e(o)}),zt(i),zi((e,t)=>{a=Fa(i,1,"thumbnail svelte-xjbo47",null,a,e),er(i,"title",t)},[()=>({active:n===bi(v),selected:bi(f).has(bi(t).uuid),new:bi(t).isNew}),()=>`${bi(g)("modals.cardPreview.title")} ${n+1}`]),pa(e,i)});var se=Kt(re,2),oe=e=>{var t=ha();Ca(Qt(t),17,()=>Array(d()-s().length),_a,(e,t,n)=>{var i=Kye();zi(e=>er(i,"title",e),[()=>`${bi(g)("modals.cardPreview.generating")} ${s().length+n+1}`]),pa(e,i)}),pa(e,t)};xa(se,e=>{c()&&d()>s().length&&e(oe)}),zt(ae);var le=Kt(ae,2);le.__click=A;var ce=Gt(le),de=Gt(ce,!0);zt(ce),m5(Kt(ce,2),{name:"chevron-right",size:20}),zt(le),zt(J);var ue=Kt(J,2),he=Gt(ue),pe=Gt(he);pe.__click=[Lye,_,s,R,P];var ge=Gt(pe);{let e=In(()=>bi(I)?"square":"check-square");m5(ge,{get name(){return bi(e)},size:16})}var ve=Kt(ge,2),fe=Gt(ve,!0);zt(ve),zt(pe),zt(he);var me=Kt(he,2),ye=Gt(me),be=Gt(ye),we=Gt(be),ke=Kt(we),Se=Gt(ke,!0);zt(ke);var xe=Kt(ke);zt(be);var _e=Kt(be,2),Ce=Gt(_e),Ie=Gt(Ce);zt(Ce);var De=Kt(Ce,2);Ca(De,21,()=>bi(b),_a,(e,t)=>{var n=Zye(),i=Gt(n,!0);zt(n);var a={};zi(e=>{var r;va(i,e),a!==(a=bi(t).id)&&(n.value=null!=(r=n.__value=bi(t).id)?r:"")},[()=>function(e,t=30){return e.length<=t?e:e.substring(0,t-3)+"..."}(bi(t).name)]),pa(e,n)}),zt(De),zt(_e),zt(ye);var Te=Kt(ye,2);Te.__click=[Fye,_,w,s,f,b,y,p,h];var Me=Gt(Te);m5(Me,{name:"download",size:16});var Ae=Kt(Me,2),Ee=Gt(Ae,!0);zt(Ae),zt(Te),zt(me),zt(ue),zt(X),zt(n),zt(t),zi((e,t,n,i,r,o,l,c,d,u,h,p,g,f,m)=>{var b;er(a,"title",e),va(O,t),va(F,n),va(U,bi(v)+1),va(q,s().length),er(G,"title",i),ee.disabled=!bi(D),er(ee,"title",r),va(ie,o),le.disabled=!bi(T),er(le,"title",l),va(de,c),er(pe,"title",d),va(fe,u),va(we,`${null!=h?h:""} `),va(Se,bi(_)),va(xe,` / ${null!=(b=s().length)?b:""} ${null!=p?p:""}`),va(Ie,`${null!=g?g:""}：`),De.disabled=bi(y),er(De,"title",f),Te.disabled=0===bi(_)||bi(y)||!bi(w),va(Ee,m)},[()=>bi(g)("modals.cardPreview.back"),()=>bi(g)("modals.cardPreview.back"),()=>bi(g)("modals.cardPreview.title"),()=>bi(g)("modals.cardPreview.close"),()=>`${bi(g)("modals.cardPreview.prevCard")} (←)`,()=>bi(g)("modals.cardPreview.prevCard"),()=>`${bi(g)("modals.cardPreview.nextCard")} (→)`,()=>bi(g)("modals.cardPreview.nextCard"),()=>bi(g)(bi(I)?"modals.cardPreview.deselectAll":"modals.cardPreview.selectAll"),()=>bi(g)(bi(I)?"modals.cardPreview.deselectAll":"modals.cardPreview.selectAll"),()=>bi(g)("modals.cardPreview.selected"),()=>bi(g)("modals.cardPreview.cardsUnit"),()=>"split"===u()?"导入到记忆牌组":bi(g)("modals.cardPreview.importTo"),()=>{var e;return(null==(e=bi(b).find(e=>e.id===bi(w)))?void 0:e.name)||""},()=>bi(g)(bi(y)?"modals.cardPreview.importing":"modals.cardPreview.importCards",{count:bi(_)})]),qa(De,()=>bi(w),e=>$n(w,e)),pa(e,t)};xa(F,e=>{l()&&e(B)}),pa(e,N);var j=St(L);return a(),j}function Jye(e,t="fast-first"){if(e<=0)return[];if(1===e)return[1];switch(t){case"fast-first":default:return ebe(e);case"balanced":return function(e){const t=3,n=Math.ceil(e/t),i=[];let a=e;for(let r=0;r<n;r++){const e=Math.ceil(a/(n-r));i.push(e),a-=e}return i}(e);case"adaptive":return function(e){if(e<=5)return[e];if(e<=15)return ebe(e);const t=2,n=[t];let i=e-t;const a=e<=30?3:5;for(;i>0;){const e=Math.min(a,i);n.push(e),i-=e}return n}(e)}}function ebe(e){if(e<=2)return[e];const t=[2];let n=e-2;const i=Math.ceil(n/2);for(let a=0;a<i;a++){const e=Math.ceil(n/(i-a));t.push(e),n-=e}return t}function tbe(e,t){$n(t,!0)}ia(["click","keydown","change"]);var nbe=la('<div class="progress-wrapper svelte-pwqb1y"><!></div>'),ibe=la('<div class="ai-assistant-page svelte-pwqb1y"><header class="ai-header svelte-pwqb1y"><div class="header-left svelte-pwqb1y"><!></div> <div class="header-right svelte-pwqb1y"><!> <button class="config-btn svelte-pwqb1y" title="配置"><!> <span>配置</span></button></div></header> <main class="ai-main-content svelte-pwqb1y"><div class="editor-wrapper svelte-pwqb1y"><!></div> <!></main> <!></div> <!> <!>',1);function abe(e,t){var n,i,a;if(new.target)return Er({component:abe,...e});kt(t,!0);const[r,s]=Dr();let o=Ar(t,"plugin",7),l=Ar(t,"dataStorage",7),c=Ar(t,"fsrs",7),d=Pn(null),u=Pn(""),h=Pn(null),p=Pn(""),g=Pn(!1),v=Pn(null),f=Pn(Ot([])),m=Pn(!1),y=Pn(!1),b=Pn(Ot({templateId:"",promptTemplate:"",cardCount:10,difficulty:"medium",typeDistribution:{qa:50,cloze:30,choice:20},provider:(null==(n=o().settings.aiConfig)?void 0:n.lastUsedProvider)||(null==(i=o().settings.aiConfig)?void 0:i.defaultProvider)||"openai",model:(null==(a=o().settings.aiConfig)?void 0:a.lastUsedModel)||"",temperature:.7,maxTokens:2e3,imageGeneration:{enabled:!1,strategy:"none",imagesPerCard:0,placement:"question"},templates:{qa:"official-qa",choice:"official-choice",cloze:"official-cloze"},autoTags:[],enableHints:!0}));Pr(()=>{_e.debug("AI Assistant Page mounted")});var w={get plugin(){return o()},set plugin(e){o(e),hn()},get dataStorage(){return l()},set dataStorage(e){l(e),hn()},get fsrs(){return c()},set fsrs(e){c(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},k=ibe(),S=Qt(k),x=Gt(S),_=Gt(x);m5(Gt(_),{name:"bot",size:28}),zt(_);var C=Kt(_,2),I=Gt(C);gme(I,{get plugin(){return o()},onFileSelect:async function(e){$n(d,e,!0);try{const t=await o().app.vault.read(e.file);$n(u,t,!0)}catch(t){new ge.Notice("读取文件失败"),_e.error("Failed to read file:",t)}},get selectedFile(){return bi(d)},set selectedFile(e){$n(d,e,!0)}});var D=Kt(I,2);D.__click=[tbe,m],m5(Gt(D),{name:"settings",size:16}),Pt(2),zt(D),zt(C),zt(x);var T=Kt(x,2),M=Gt(T);mme(Gt(M),{get selectedFile(){return bi(d)},onClear:function(){$n(u,"")},onReload:async function(){if(bi(d))try{const e=await o().app.vault.read(bi(d).file);$n(u,e,!0),new ge.Notice("文件已重新加载")}catch(e){new ge.Notice("重新加载文件失败"),_e.error("Failed to reload file:",e)}},get content(){return bi(u)},set content(e){$n(u,e,!0)}}),zt(M);var A=Kt(M,2),E=e=>{var t=nbe();Mme(Gt(t),{get progress(){return bi(v)},onOpenPreview:()=>{$n(y,!0)}}),zt(t),pa(e,t)};xa(A,e=>{bi(v)&&e(E)}),zt(T);var z=Kt(T,2);{let e=In(()=>!bi(u).trim()||bi(g));Cme(z,{get plugin(){return o()},get selectedProvider(){return bi(b).provider},get selectedModel(){return bi(b).model},onPromptSelect:function(e){$n(h,e,!0),e&&$n(p,"")},onCustomPromptChange:function(e){$n(p,e,!0)},onProviderModelChange:async function(e,t){$n(b,{...bi(b),provider:e,model:t},!0),o().settings.aiConfig&&(o().settings.aiConfig.lastUsedProvider=e,o().settings.aiConfig.lastUsedModel=t,await o().saveSettings()),new ge.Notice(`已切换到 ${e} · ${t}`)},onGenerate:async function(){var e;const t=function(e){const t=1e5;return e.trim().length<50?{valid:!1,message:"内容太短（少于50字符），请提供更多内容"}:e.length>t?{valid:!1,message:"内容太长（超过100000字符），请减少内容或分段生成"}:{valid:!0}}(bi(u));if(!t.valid)return void new ge.Notice(t.message||"内容验证失败");if(!o().settings.aiConfig)return void new ge.Notice("请先在设置中配置AI服务");const n=bi(h)?bi(h).prompt:bi(p)||"请根据以下内容生成学习卡片";try{$n(g,!0),$n(f,[],!0);const t=bi(b).cardCount;$n(y,!0),$n(v,{status:"preparing",progress:0,message:"准备生成卡片...",currentCard:0,totalCards:t},!0);const a=o().settings.aiConfig;if(!a)throw new Error("AI配置未初始化");const r=bi(b).provider,s=bi(b).model,l=a.apiKeys,c=null==l?void 0:l[r],d=$8.createService(r,o());if(!c||!c.apiKey)throw new Error(`${r} API密钥未配置`);const m=function(e,t){let n=e;for(const[i,a]of Object.entries(t)){const e=new RegExp(`\\{${i}\\}`,"g");n=n.replace(e,String(a))}return n}(n,{count:(i=bi(b)).cardCount,difficulty:i.difficulty,template:i.templateId,qaPercent:i.typeDistribution.qa,clozePercent:i.typeDistribution.cloze,choicePercent:i.typeDistribution.choice}),w=Jye(t,"fast-first");_e.debug(`分批生成策略: ${w.join(" + ")} = ${t}张卡片`);for(let n=0;n<w.length;n++){const i=w[n],a=n+1;_e.debug(`开始生成第${a}批 (${i}张)`);const o={...bi(b),cardCount:i,templateId:(null==(e=bi(h))?void 0:e.id)||"custom",promptTemplate:m,customPrompt:bi(p)||void 0,provider:r,model:s,temperature:bi(b).temperature,maxTokens:bi(b).maxTokens};$n(v,{status:"generating",progress:Math.round(n/w.length*100),message:`正在生成第${a}/${w.length}批 (${i}张)...`,currentCard:bi(f).length,totalCards:t},!0);const l=await d.generateCards(bi(u),o,e=>{$n(v,{...e,currentCard:bi(f).length,totalCards:t},!0)});if(l.success&&l.cards){const e=l.cards.map(e=>({...e,isNew:!0}));$n(f,[...bi(f),...e],!0),_e.debug(`第${a}批完成: 新增${e.length}张，累计${bi(f).length}/${t}张`),await new Promise(e=>setTimeout(e,100)),$n(f,bi(f).map(e=>({...e,isNew:!1})),!0)}else _e.error(`第${a}批生成失败:`,l.error)}$n(v,{status:"completed",progress:100,message:`成功生成${bi(f).length}张卡片`,currentCard:bi(f).length,totalCards:t},!0),_e.debug("所有批次生成完成:",bi(f)),setTimeout(()=>{$n(v,null)},1e3)}catch(a){_e.error("Generation failed:",a),new ge.Notice(a instanceof Error?a.message:"AI生成失败"),bi(v)&&$n(v,{status:"failed",progress:0,message:a instanceof Error?a.message:"生成失败"},!0)}finally{$n(g,!1)}var i},get isGenerating(){return bi(g)},get disabled(){return bi(e)},get selectedPrompt(){return bi(h)},set selectedPrompt(e){$n(h,e,!0)},get customPrompt(){return bi(p)},set customPrompt(e){$n(p,e,!0)}})}zt(S);var P=Kt(S,2);Tye(P,{get plugin(){return o()},get config(){return bi(b)},get isOpen(){return bi(m)},onClose:function(){$n(m,!1)},onSave:function(e){$n(b,e,!0),$n(m,!1),new ge.Notice("配置已保存")}}),Xye(Kt(P,2),{get plugin(){return o()},get cards(){return bi(f)},get config(){return bi(b)},get isOpen(){return bi(y)},get isGenerating(){return bi(g)},get totalCards(){return bi(b).cardCount},onClose:function(){$n(y,!1)},onImport:async function(e,t){var n;try{const a=await l().getDeck(t);if(!a)throw new Error("牌组不存在");_e.debug("Starting import to deck:",a.name,e);const{CardConverter:r}=await Promise.resolve().then(()=>Oye),{cards:s,errors:c}=r.convertBatch(e,t,null==(n=bi(d))?void 0:n.path,bi(b).templates,o().fsrs);_e.debug("Converted cards:",s.length,"Errors:",c.length),c.length>0&&_e.warn("Card conversion errors:",c);let u=0,h=0;for(const e of s)try{await l().saveCard(e),u++,_e.debug("Saved card:",e.uuid)}catch(i){h++,_e.error("Failed to save card:",e.uuid,i)}if(_e.debug(`Import completed: ${u} success, ${h} failed`),u>0&&new ge.Notice(`成功导入 ${u} 张卡片到 ${a.name}`),(h>0||c.length>0)&&new ge.Notice(`导入失败 ${h+c.length} 张卡片`,5e3),0===u)throw new Error("没有卡片成功导入")}catch(i){throw _e.error("Import cards failed:",i),i}}}),pa(e,k);var R=St(w);return s(),R}function rbe(e,t){var n;null==(n=t())||n()}ia(["click"]);var sbe=(e,t,n)=>t(bi(n).id),obe=la('<span class="anki-nav-badge svelte-ejsqc9"> </span>'),lbe=la('<button><div class="anki-nav-icon svelte-ejsqc9"><!> <!></div> <span class="anki-nav-label svelte-ejsqc9"> </span></button>'),cbe=(e,t)=>bi(t).onClick(e),dbe=la("<button><!></button>"),ube=la("<button><!></button>"),hbe=la('<nav><div class="anki-nav-container svelte-ejsqc9"><div class="nav-spacer"></div> <div class="anki-nav-menu svelte-ejsqc9"></div> <div class="anki-nav-actions svelte-ejsqc9"><!> <!></div></div></nav>');function pbe(e,t){if(new.target)return Er({component:pbe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"items",7),s=Ar(t,"currentPage",7),o=Ar(t,"responsive",7),l=Ar(t,"showSettingsButton",7,!1),c=Ar(t,"pageActions",23,()=>[]),d=Ar(t,"collapsed",7,!1),u=Ar(t,"onNavbarEnter",7),h=Ar(t,"onNavbarLeave",7),p=Ar(t,"onNavigate",7),g=Ar(t,"onSettings",7),v=In(n);function f(e){var t;null==(t=p())||t(e)}var m={get items(){return r()},set items(e){r(e),hn()},get currentPage(){return s()},set currentPage(e){s(e),hn()},get responsive(){return o()},set responsive(e){o(e),hn()},get showSettingsButton(){return l()},set showSettingsButton(e=!1){l(e),hn()},get pageActions(){return c()},set pageActions(e=[]){c(e),hn()},get collapsed(){return d()},set collapsed(e=!1){d(e),hn()},get onNavbarEnter(){return u()},set onNavbarEnter(e){u(e),hn()},get onNavbarLeave(){return h()},set onNavbarLeave(e){h(e),hn()},get onNavigate(){return p()},set onNavigate(e){p(e),hn()},get onSettings(){return g()},set onSettings(e){g(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=hbe();let b;var w=Gt(y),k=Kt(Gt(w),2);Ca(k,21,r,_a,(e,t)=>{var n=lbe();let i;n.__click=[sbe,f,t];var a=Gt(n),r=Gt(a);Ng(r,{get name(){return bi(t).icon}});var o=Kt(r,2),l=e=>{var n=obe(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t).badge)),pa(e,n)};xa(o,e=>{bi(t).badge&&e(l)}),zt(a);var c=Kt(a,2),d=Gt(c,!0);zt(c),zt(n),zi(e=>{i=Fa(n,1,"anki-nav-item svelte-ejsqc9",null,i,e),er(n,"aria-label",bi(t).description),va(d,bi(t).label)},[()=>({active:s()===bi(t).id})]),pa(e,n)}),zt(k);var S=Kt(k,2),x=Gt(S);Ca(x,17,c,_a,(e,t)=>{var n=dbe();let i;n.__click=[cbe,t],Ng(Gt(n),{get name(){return bi(t).icon}}),zt(n),zi(e=>{i=Fa(n,1,"anki-nav-action-item page-action svelte-ejsqc9",null,i,e),er(n,"aria-label",bi(t).label),er(n,"title",bi(t).label)},[()=>({primary:"primary"===bi(t).variant})]),pa(e,n)});var _=Kt(x,2),C=e=>{var t=ube();let n;t.__click=[rbe,g],Ng(Gt(t),{get name(){return mg}}),zt(t),zi((e,i,a)=>{n=Fa(t,1,"anki-nav-action-item svelte-ejsqc9",null,n,e),er(t,"aria-label",i),er(t,"title",a)},[()=>({active:"settings"===s()}),()=>bi(v)("navbar.openSettings"),()=>bi(v)("navbar.settings")]),pa(e,t)};xa(_,e=>{l()&&e(C)}),zt(S),zt(w),zt(y),zi(e=>b=Fa(y,1,"anki-navbar svelte-ejsqc9",null,b,e),[()=>({collapsed:d()})]),na("mouseenter",y,function(...e){var t;null==(t=u())||t.apply(this,e)}),na("mouseleave",y,function(...e){var t;null==(t=h())||t.apply(this,e)}),pa(e,y);var I=St(m);return a(),I}function gbe(e,t,n){var i;t(!t()),null==(i=n())||i(t())}ia(["click"]);var vbe=la('<div class="sensor-indicator svelte-16xakwx"><!> <span class="svelte-16xakwx"> </span></div>'),fbe=la('<div class="navbar-sensor-area svelte-16xakwx" role="button" tabindex="-1"><!></div>'),mbe=la("<button><!></button>");function ybe(e,t){if(new.target)return Er({component:ybe,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"collapsed",15,!1),s=Ar(t,"onToggle",7),o=Ar(t,"onSensorEnter",7),l=Ar(t,"responsive",7),c=In(()=>{var e,t;return null==(t=null==(e=l())?void 0:e.isDesktop)||t}),d=In(n);var u={get collapsed(){return r()},set collapsed(e=!1){r(e),hn()},get onToggle(){return s()},set onToggle(e){s(e),hn()},get onSensorEnter(){return o()},set onSensorEnter(e){o(e),hn()},get responsive(){return l()},set responsive(e){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},h=ha(),p=Qt(h),g=e=>{var t=fbe(),n=Gt(t),i=e=>{var t=vbe(),n=Gt(t);Ng(n,{name:"chevron-down",size:12});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(e=>va(a,e),[()=>bi(d)("navbar.collapseHint")]),pa(e,t)};xa(n,e=>{r()&&e(i)}),zt(t),zi(e=>er(t,"aria-label",e),[()=>bi(d)("navbar.expand")]),na("mouseenter",t,function(...e){var t;null==(t=o())||t.apply(this,e)}),pa(e,t)},v=e=>{var t=mbe();let n;t.__click=[gbe,r,s];var i=Gt(t);{let e=In(()=>r()?"chevron-down":"chevron-up");Ng(i,{get name(){return bi(e)},size:16})}zt(t),zi((e,i)=>{n=Fa(t,1,"navbar-corner-button svelte-16xakwx",null,n,e),er(t,"aria-label",i),er(t,"aria-pressed",!r())},[()=>({collapsed:r()}),()=>r()?bi(d)("navbar.expand"):bi(d)("navbar.collapse")]),pa(e,t)};xa(p,e=>{bi(c)?e(g):e(v,!1)}),pa(e,h);var f=St(u);return a(),f}ia(["click"]);const bbe={mobile:480,tablet:768,desktop:1024};function wbe(e,t=bbe){const n=e<t.mobile,i=e>=t.mobile&&e<t.tablet;let a;return a=n?"mobile":i?"tablet":"desktop",{isMobile:n,isTablet:i,isDesktop:e>=t.tablet,width:e,breakpoint:a}}function kbe(e=bbe){return function(t){let n={isMobile:!1,isTablet:!1,isDesktop:!0,width:0,breakpoint:"desktop"},i=null,a=[];function r(e){n=e,a.forEach(t=>t(e))}return{subscribe:function(e){return a.push(e),e(n),()=>{const t=a.indexOf(e);t>-1&&a.splice(t,1)}},init:function(){i&&(i(),i=null),t&&(i=function(e,t,n=bbe){if(!e)return _e.warn("[ResponsiveUtils] Element is null or undefined"),()=>{};const i=new ResizeObserver(e=>{for(const i of e){const e=wbe(i.contentRect.width,n);t(e)}});i.observe(e);const a=wbe(e.clientWidth,n);return t(a),()=>{i.disconnect()}}(t,r,e))},destroy:function(){i&&(i(),i=null),a=[]},get state(){return n},get isMobile(){return n.isMobile},get isTablet(){return n.isTablet},get isDesktop(){return n.isDesktop},get width(){return n.width},get breakpoint(){return n.breakpoint}}}}const Sbe={mobile:280,tablet:400,desktop:500};var xbe=la("<div><!></div>");function _be(e,t){if(new.target)return Er({component:_be,...e});kt(t,!0);let n=Ar(t,"breakpoints",7),i=Ar(t,"classPrefix",7,"responsive"),a=Ar(t,"autoDetectObsidian",7,!0),r=Ar(t,"class",7,""),s=Ar(t,"children",7),o=Pn(null),l=Pn(null),c=null,d=null;Ti(()=>{if(!bi(o))return $n(l,null),void(c&&(c.destroy(),c=null));const e=kbe(a()&&!n()?function(e){let t=e.parentElement;for(;t;){const e=t.classList;if(e.contains("mod-right-split")||e.contains("mod-left-split"))return!0;if(e.contains("workspace-leaf-content")&&!e.contains("mod-right-split")&&!e.contains("mod-left-split"))return!1;t=t.parentElement}return!1}(bi(o))?Sbe:bbe:n());c=e(bi(o));const t=c.subscribe(e=>{$n(l,e,!0)});return c.init(),d=Mne(bi(o)),()=>{t(),c&&(c.destroy(),c=null),d&&(d(),d=null)}});const u=In(()=>()=>bi(l)?function(e,t="responsive"){const n=[`${t}-${e.breakpoint}`,`${t}-width-${100*Math.floor(e.width/100)}`];return e.isMobile&&n.push(`${t}-mobile`),e.isTablet&&n.push(`${t}-tablet`),e.isDesktop&&n.push(`${t}-desktop`),n}(bi(l),i()).join(" "):""),h=In(()=>()=>{const e=["tuanki-responsive-container"],t=bi(u)();return t&&e.push(t),r()&&e.push(r()),e.join(" ")});var p={get breakpoints(){return n()},set breakpoints(e){n(e),hn()},get classPrefix(){return i()},set classPrefix(e="responsive"){i(e),hn()},get autoDetectObsidian(){return a()},set autoDetectObsidian(e=!0){a(e),hn()},get class(){return r()},set class(e=""){r(e),hn()},get children(){return s()},set children(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},g=xbe(),v=Gt(g),f=e=>{var t=ha();Ea(Qt(t),s,()=>bi(l)),pa(e,t)};return xa(v,e=>{s()&&e(f)}),zt(g),kr(g,e=>$n(o,e),()=>bi(o)),zi(()=>{var e,t;Fa(g,1,$a(bi(h)),"svelte-1sgkft8"),er(g,"data-responsive-width",(null==(e=bi(l))?void 0:e.width)||0),er(g,"data-responsive-breakpoint",(null==(t=bi(l))?void 0:t.breakpoint)||"desktop")}),pa(e,g),St(p)}const Cbe=[{id:"deck-study",label:"牌组学习",icon:ug,description:"浏览和学习您的Weave牌组",hidden:!1},{id:"tuanki-card-management",label:"卡片管理",icon:hg,description:"管理和编辑您的所有卡片",hidden:!1},{id:"ai-assistant",label:"AI制卡",icon:pg,description:"使用AI辅助创建和优化卡片",hidden:!1},{id:"statistics",label:"统计分析",icon:gg,description:"查看您的学习进度和记忆曲线",hidden:!1}];ia(["click"]);var Ibe=la('<div class="removed-feature-notice svelte-1ownscf"><div class="notice-icon svelte-1ownscf">📊</div> <h3 class="svelte-1ownscf">主界面统计分析功能已移除</h3> <p class="svelte-1ownscf">该功能已被优化。您仍然可以在各个牌组的"分析"按钮中查看详细的统计数据。</p></div>'),Dbe=la('<div role="application"><!> <!> <main class="tuanki-main-content svelte-1ownscf"><!></main> <!></div>');const Tbe=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);const i=()=>Ir(Vp,"$tr",a),[a,r]=Dr();let s,o=Ar(n,"plugin",7),l=Ar(n,"dataStorage",7),c=Ar(n,"fsrs",7),d=Pn("deck-study"),u=Pn(!1),h=null,p=Pn(!1),g=null,v=null,f=null,m=In(i),y=Pn(Ot(o().settings.navigationVisibility||{deckStudy:!0,cardManagement:!0,aiAssistant:!0,statistics:!0})),b=Pn(Ot([]));const w=Qh.getInstance();let k=Pn(!1),S=Pn(!1),x=Pn(Ot(Hh.ADVANCED_ANALYTICS));function _(e){$n(p,e,!0)}function C(){v&&(clearTimeout(v),v=null),f&&(clearTimeout(f),f=null)}function I(){C(),f=window.setTimeout(()=>{$n(p,!0),_e.debug("[TuankiApp] 导航栏已自动收起")},500)}function D(){C(),_e.debug("[TuankiApp] 鼠标进入导航栏，取消自动收起")}function T(){C(),v=window.setTimeout(()=>{$n(p,!1),_e.debug("[TuankiApp] 导航栏已自动展开")},100)}Ti(()=>{if(!bi(u))return;return w.isPremiumActive.subscribe(e=>{bi(u)&&$n(k,e,!0)})}),Pr(()=>{$n(u,!0);const e=e=>{if("statistics"===e.detail&&!w.canUseFeature(Hh.ADVANCED_ANALYTICS))return $n(x,Hh.ADVANCED_ANALYTICS,!0),void $n(S,!0);$n(d,e.detail,!0)},t=e=>{$n(y,{...e.detail},!0),_e.debug("[TuankiApp] 导航可见性已更新:",bi(y));const t={"deck-study":!1!==bi(y).deckStudy,"card-management":!1!==bi(y).cardManagement,"ai-assistant":!1!==bi(y).aiAssistant,statistics:!1!==bi(y).statistics};if(!1===t[bi(d)]){const e=Object.keys(t).find(e=>t[e]);e&&($n(d,e,!0),_e.info(`[TuankiApp] 当前页面已隐藏，自动切换到: ${e}`))}};window.addEventListener("tuanki:navigate",e),window.addEventListener("tuanki:navigation-visibility-update",t),(async()=>{try{$n(b,await l().getDecks(),!0)}catch(e){_e.error("加载牌组数据失败:",e),$n(b,[],!0)}})(),s&&(h=Mne(s),_e.debug("[TuankiApp] 主题类已应用到应用容器"));try{const e=localStorage.getItem("tuanki-navbar-collapsed");null!==e?($n(p,JSON.parse(e),!0),_e.debug("[TuankiApp] 已恢复导航栏折叠状态:",bi(p))):($n(p,!0),_e.debug("[TuankiApp] 首次使用，导航栏默认折叠"))}catch(n){_e.warn("[TuankiApp] 恢复导航栏折叠状态失败:",n),$n(p,!0)}return()=>{window.removeEventListener("tuanki:navigate",e),window.removeEventListener("tuanki:navigation-visibility-update",t),h&&(h(),h=null)}}),Rr(()=>{$n(u,!1),h&&(h(),h=null),C()}),Ti(()=>{try{localStorage.setItem("tuanki-navbar-collapsed",JSON.stringify(bi(p))),_e.debug("[TuankiApp] 导航栏折叠状态已保存:",bi(p))}catch(e){_e.warn("[TuankiApp] 保存导航栏折叠状态失败:",e)}});var M={get plugin(){return o()},set plugin(e){o(e),hn()},get dataStorage(){return l()},set dataStorage(e){l(e),hn()},get fsrs(){return c()},set fsrs(e){c(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)};{const e=(e,t=je)=>{var n=Dbe();let i;var a=Gt(n);kr(ybe(a,{onToggle:_,onSensorEnter:T,get responsive(){return t()},get collapsed(){return bi(p)},set collapsed(e){$n(p,e,!0)}}),e=>g=e,()=>g);var r=Kt(a,2);{let e=In(()=>function(e){return Cbe.filter(t=>{if(t.hidden||t.disabled)return!1;if(!e)return!0;const n={"deck-study":"deckStudy","tuanki-card-management":"cardManagement","ai-assistant":"aiAssistant",statistics:"statistics"}[t.id]||null;return!n||!e.hasOwnProperty(n)||!1!==e[n]})}(bi(y))),n=In(()=>!1!==o().settings.showSettingsButton),i=In(()=>"deck-study"===bi(d)?[{id:"view-switcher",label:bi(m)("navigation.switchView"),icon:"layout",onClick:e=>{window.dispatchEvent(new CustomEvent("show-view-menu",{detail:{event:e}}))}},{id:"create-deck",label:bi(m)("navigation.createDeck"),icon:"plus",onClick:e=>{const t=new CustomEvent("create-deck",{detail:{event:e}});document.dispatchEvent(t)},variant:"primary"},{id:"more-actions",label:bi(m)("navigation.moreActions"),icon:"more-horizontal",onClick:e=>{const t=new CustomEvent("more-actions",{detail:{event:e}});document.dispatchEvent(t)}}]:[]);pbe(r,{get items(){return bi(e)},get currentPage(){return bi(d)},get responsive(){return t()},get showSettingsButton(){return bi(n)},get collapsed(){return bi(p)},onNavbarEnter:D,onNavbarLeave:I,get pageActions(){return bi(i)},onNavigate:e=>{if("statistics"===e&&!w.canUseFeature(Hh.ADVANCED_ANALYTICS))return $n(x,Hh.ADVANCED_ANALYTICS,!0),void $n(S,!0);$n(d,e,!0)},onSettings:()=>$n(d,"settings")})}var u=Kt(r,2),h=Gt(u),v=e=>{Cse(e,{get dataStorage(){return l()},get fsrs(){return c()},get plugin(){return o()}})},f=e=>{var t=ha(),n=Qt(t),i=e=>{v5(e,{get dataStorage(){return l()},get fsrs(){return c()},get plugin(){return o()}})},a=e=>{var t=ha(),n=Qt(t),i=e=>{abe(e,{get plugin(){return o()},get dataStorage(){return l()},get fsrs(){return c()}})},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,Ibe())},a=e=>{var t=ha(),n=Qt(t),i=e=>{tme(e,{get plugin(){return o()}})};xa(n,e=>{"settings"===bi(d)&&e(i)},!0),pa(e,t)};xa(n,e=>{"statistics"===bi(d)?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{"ai-assistant"===bi(d)?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{"tuanki-card-management"===bi(d)?e(i):e(a,!1)},!0),pa(e,t)};xa(h,e=>{"deck-study"===bi(d)?e(v):e(f,!1)}),zt(u),s3(Kt(u,2),{get featureId(){return bi(x)},get visible(){return bi(S)},onClose:()=>$n(S,!1)}),zt(n),kr(n,e=>s=e,()=>s),zi(e=>i=Fa(n,1,"tuanki-app tuanki-app-inner svelte-1ownscf",null,i,e),[()=>({"navbar-collapsed":bi(p)})]),pa(e,n)};_be(t,{classPrefix:"tuanki",children:e,$$slots:{default:!0}})}var A=St(M);return r(),A}},Symbol.toStringTag,{value:"Module"}));function Mbe(e,t){t()()}var Abe=la('<div class="study-view-toolbar svelte-38yf2b"><div class="toolbar-left svelte-38yf2b"><span class="study-view-title svelte-38yf2b">📚 正在学习</span> <span class="study-stats svelte-38yf2b"> </span></div> <div class="toolbar-right svelte-38yf2b"><button class="toolbar-btn close-btn svelte-38yf2b">✕</button></div></div> <div class="study-view-content svelte-38yf2b"><div class="study-interface-embedded svelte-38yf2b"><!></div></div> <div class="study-view-statusbar svelte-38yf2b"><span class="status-text svelte-38yf2b"> </span></div>',1),Ebe=la('<div class="loading-container-fullscreen svelte-38yf2b"><div class="loading-spinner svelte-38yf2b"></div> <p class="svelte-38yf2b">加载学习卡片中...</p></div>'),zbe=la('<div class="tuanki-study-view-wrapper svelte-38yf2b"><!> <!></div>');ia(["click"]);const Pbe=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);const i=()=>Ir(Vp,"$tr",a),[a,r]=Dr();let s=Ar(n,"plugin",7),o=Ar(n,"viewInstance",7),l=Ar(n,"deckId",7),c=Ar(n,"mode",7),d=Ar(n,"cardIds",7),u=Ar(n,"resumeData",7),h=Ar(n,"onClose",7),p=In(i),g=Pn(!0),v=Pn(Ot([])),f=Pn(!1),m=Pn(!1),y=Pn(""),b=Pn(null),w=Pn(!1),k=Pn(Ot(l()||"")),S=Pn(Ot(c())),x=Pn(Ot(d())),_=Pn(Ot({completed:0,correct:0,incorrect:0})),C=Pn(0),I=Pn(Ot([])),D=Pn("mixed");async function T(e){$n(k,e.deckId||"",!0),$n(S,e.mode,!0),$n(x,e.cardIds,!0),$n(g,!0),$n(f,!1),await M()}async function M(){try{if($n(g,!0),u())$n(k,u().deckId,!0),$n(C,u().currentCardIndex,!0),$n(I,u().remainingCardIds,!0),$n(_,u().stats,!0),$n(D,u().sessionType,!0);else if(bi(x)&&bi(x).length>0){_e.debug("[StudyViewWrapper] 📥 模式1: 使用CardIds加载",{cardIdsCount:bi(x).length,cardIds:bi(x).map(e=>e.slice(0,8)),mode:bi(S)});const e=await die(()=>{var e;return null==(e=s())?void 0:e.dataStorage},"DataStorage",1e4);$n(v,await kie(e,bi(x),bi(k)),!0),_e.debug("[StudyViewWrapper] ✅ 卡片加载完成:",{requestedCount:bi(x).length,loadedCount:bi(v).length,cardIds:bi(v).map(e=>e.uuid.slice(0,8)),deckId:bi(k)})}else if("advance"===bi(S)){if(!bi(k))return _e.error("[StudyViewWrapper] 提前学习模式缺少 deckId"),new ge.Notice("⚠️ 提前学习需要选择牌组"),void h()();$n(v,await async function(e){try{const t=await die(()=>{var e;return null==(e=s())?void 0:e.dataStorage},"DataStorage",1e4),n=await t.getCards({deckId:e}),i=s().settings.maxAdvanceDays||7;return wie(n,20,i)}catch(t){return _e.error("[StudyViewWrapper] 加载提前学习卡片失败:",t),[]}}(bi(k)),!0)}else bi(k)?$n(v,await async function(e){try{const t=s().settings.newCardsPerDay||20,n=s().settings.reviewsPerDay||20,i=await die(()=>{var e;return null==(e=s())?void 0:e.dataStorage},"DataStorage",1e4);return await Sie(i,e,t,n)}catch(t){return _e.error("[StudyViewWrapper] 加载牌组卡片失败:",t),[]}}(bi(k)),!0):$n(v,await async function(){try{const e=s().settings.newCardsPerDay||20,t=s().settings.reviewsPerDay||20,n=await die(()=>{var e;return null==(e=s())?void 0:e.dataStorage},"DataStorage",1e4);return await xie(n,e,t)}catch(e){return _e.error("[StudyViewWrapper] 加载到期卡片失败:",e),[]}}(),!0);bi(v).length>0?$n(f,!0):(_e.warn("[StudyViewWrapper] ⚠️ 无可学卡片，关闭学习界面"),new ge.Notice("暂无可学习的卡片"),h()())}catch(e){_e.error("[StudyViewWrapper] 加载卡片失败:",e)}finally{$n(g,!1)}}function A(e){if($n(_,{completed:e.cardsReviewed||0,correct:e.correctAnswers||0,incorrect:(e.cardsReviewed||0)-(e.correctAnswers||0)},!0),e.cardsReviewed&&e.cardsReviewed>0){const t=e.cardsReviewed>0?(e.correctAnswers||0)/e.cardsReviewed:0;$n(y,"加载中..."),$n(b,{reviewed:e.cardsReviewed,studyTime:Math.floor(e.totalTime/1e3),memoryRate:t,newCards:e.newCardsLearned||0},!0),$n(m,!0),$n(w,!0),(async()=>{try{const t=await die(()=>{var e;return null==(e=s())?void 0:e.dataStorage},"DataStorage",1e4),n=await t.getDeck(e.deckId);$n(y,(null==n?void 0:n.name)||"未知牌组",!0)}catch(t){_e.error("[StudyViewWrapper] 加载牌组名称失败:",t),$n(y,"未知牌组")}})()}else h()()}function E(){bi(m)?$n(w,!0):h()()}function z(){$n(m,!1),$n(b,null),bi(w)&&setTimeout(()=>{h()()},100),$n(w,!1)}Ti(()=>{void 0!==l()&&$n(k,l(),!0),void 0!==c()&&$n(S,c(),!0),void 0!==d()&&$n(x,d(),!0)}),Pr(async()=>{await M()});var P={getSessionData:function(){return{deckId:bi(k),currentCardIndex:bi(C),remainingCardIds:bi(I),stats:bi(_),sessionType:bi(D)}},shouldPersist:function(){return bi(I).length>0&&bi(_).completed>0},updateStudyParams:T,updateDeckId:async function(e){await T({deckId:e})},get plugin(){return s()},set plugin(e){s(e),hn()},get viewInstance(){return o()},set viewInstance(e){o(e),hn()},get deckId(){return l()},set deckId(e){l(e),hn()},get mode(){return c()},set mode(e){c(e),hn()},get cardIds(){return d()},set cardIds(e){d(e),hn()},get resumeData(){return u()},set resumeData(e){u(e),hn()},get onClose(){return h()},set onClose(e){h(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)},R=zbe(),$=Gt(R),O=e=>{var t=Abe(),n=Qt(t),i=Gt(n),a=Kt(Gt(i),2),r=Gt(a);zt(a),zt(i);var o=Kt(i,2),l=Gt(o);l.__click=[Mbe,h],zt(o),zt(n);var c=Kt(n,2),d=Gt(c);Fte(Gt(d),{get cards(){return bi(v)},get fsrs(){return s().fsrs},get dataStorage(){return s().dataStorage},get plugin(){return s()},get mode(){return bi(S)},get queueOptimizationSystem(){return s().queueOptimizationSystem},onClose:E,onComplete:A}),zt(d),zt(c);var u=Kt(c,2),g=Gt(u),f=Gt(g);zt(g),zt(u),zi(e=>{var t,n,i;va(r,`完成: ${null!=(t=bi(_).completed)?t:""} | \n          正确: ${null!=(n=bi(_).correct)?n:""} | \n          错误: ${null!=(i=bi(_).incorrect)?i:""}`),er(l,"title",e),va(f,`学习中 | \n        进度: ${bi(C)+1} / ${bi(I).length+bi(C)+1}`)},[()=>bi(p)("studyInterface.closeStudy")]),pa(e,t)},L=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,Ebe())};xa(n,e=>{bi(g)&&e(i)},!0),pa(e,t)};xa($,e=>{!bi(g)&&bi(f)&&bi(v).length>0?e(O):e(L,!1)});var N=Kt($,2),F=e=>{Qre(e,{get deckName(){return bi(y)},get stats(){return bi(b)},soundEnabled:!0,soundVolume:.5,onClose:z})};xa(N,e=>{bi(m)&&bi(b)&&e(F)}),zt(R),pa(t,R);var B=St(P);return r(),B}},Symbol.toStringTag,{value:"Module"}));var Rbe=(e,t,n)=>t(bi(n).node),$be=(e,t,n)=>"Enter"===e.key&&t(bi(n).node),Obe=(e,t,n)=>{e.stopPropagation(),t(bi(n).node)},Lbe=la('<button class="expand-button svelte-1wwb6w7"><!></button>'),Nbe=la('<div class="expand-placeholder svelte-1wwb6w7"></div>'),Fbe=la('<span class="tag-count svelte-1wwb6w7"> </span>'),Bbe=la('<div class="tag-children svelte-1wwb6w7"></div>'),jbe=la('<div><div role="button" tabindex="0"><!> <div class="tag-color-dot svelte-1wwb6w7"></div> <span class="tag-name svelte-1wwb6w7"> </span> <!></div> <!></div>'),Ube=la('<div class="tag-tree svelte-1wwb6w7"></div>');function Vbe(e,t){if(new.target)return Er({component:Vbe,...e});kt(t,!0);const n=(e,t=je)=>{const i=In(()=>{const{node:e,hasChildren:n,isSelected:i,hasSelectedDesc:a}=t();return{node:e,hasChildren:n,isSelected:i,hasSelectedDesc:a}}),a=In(()=>h(bi(i).node.fullPath));var r=jbe();let s;var o=Gt(r);let l;o.__click=[Rbe,g,i],o.__keydown=[$be,g,i];var c=Gt(o),d=e=>{var t=Lbe();t.__click=[Obe,p,i];var n=Gt(t);{let e=In(()=>bi(a)?"chevronDown":"chevronRight");B6(n,{get name(){return bi(e)},size:"12"})}zt(t),zi(()=>er(t,"aria-label",bi(a)?"收起":"展开")),pa(e,t)},u=e=>{pa(e,Nbe())};xa(c,e=>{bi(i).hasChildren?e(d):e(u,!1)});var v=Kt(c,2),m=Kt(v,2),y=Gt(m);zt(m);var b=Kt(m,2),w=e=>{var t=Fbe(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(i).node.count)),pa(e,t)};xa(b,e=>{bi(i).node.count>0&&e(w)}),zt(o);var k=Kt(o,2),S=e=>{var t=Bbe();Ca(t,21,()=>bi(i).node.children,_a,(e,t)=>{{let i=In(()=>f(bi(t)));n(e,()=>bi(i))}}),zt(t),pa(e,t)};xa(k,e=>{bi(a)&&bi(i).hasChildren&&e(S)}),zt(r),zi((e,t,n)=>{var a,c;s=Fa(r,1,"tag-node svelte-1wwb6w7",null,s,e),l=Fa(o,1,"tag-item svelte-1wwb6w7",null,l,t),er(o,"title",`#${null!=(a=bi(i).node.fullPath)?a:""}`),er(v,"data-color",n),va(y,`#${null!=(c=bi(i).node.name)?c:""}`)},[()=>({"has-children":bi(i).hasChildren}),()=>({selected:bi(i).isSelected,"has-selected-descendants":bi(i).hasSelectedDesc}),()=>function(e){const t=["red","blue","green","purple","orange","pink","cyan","yellow"];let n=0;for(let i=0;i<e.length;i++)n=e.charCodeAt(i)+((n<<5)-n);return t[Math.abs(n)%t.length]}(bi(i).node.fullPath)]),pa(e,r)};let i=Ar(t,"tags",7),a=Ar(t,"selectedTags",7),r=Ar(t,"tagCounts",7),s=Ar(t,"onTagSelect",7);const o=$r();let l=Pn(Ot(new Map)),c=In(()=>function(e,t,n){const i=new Map,a=new Set,r=new Map;function s(e){return e.startsWith("#")?e.slice(1):e}const o=t.map(e=>s(e));n?Object.entries(n).forEach(([e,t])=>{const n=s(e);i.set(n,t),r.set(n,e);const o=n.split("/").filter(Boolean);for(let i=1;i<=o.length;i++){const e=o.slice(0,i).join("/");a.add(e)}}):e.forEach(e=>{const t=s(e);i.set(t,(i.get(t)||0)+1),r.set(t,e);const n=t.split("/").filter(Boolean);for(let i=1;i<=n.length;i++){const e=n.slice(0,i).join("/");a.add(e)}});const l=[],c=new Map;return Array.from(a).sort((e,t)=>e.split("/").length-t.split("/").length).forEach(e=>{const t=e.split("/"),n={name:t[t.length-1],fullPath:e,children:[],count:i.get(e)||0,selected:o.includes(e)};if(c.set(e,n),1===t.length)l.push(n);else{const e=t.slice(0,-1).join("/"),i=c.get(e);i&&i.children.push(n)}}),{tree:l,mapping:r}}(i(),a(),r())),d=In(()=>bi(c).tree),u=In(()=>bi(c).mapping);function h(e){var t;return null==(t=bi(l).get(e))||t}function p(e){const t=h(e.fullPath);bi(l).set(e.fullPath,!t)}function g(e){var t;const n=bi(u).get(e.fullPath)||e.fullPath;null==(t=s())||t(n),o("tagSelect",n)}function v(e){return!!e.selected||e.children.some(e=>v(e))}function f(e){return{node:e,hasChildren:e.children.length>0,isSelected:e.selected,hasSelectedDesc:v(e)}}var m={get tags(){return i()},set tags(e){i(e),hn()},get selectedTags(){return a()},set selectedTags(e){a(e),hn()},get tagCounts(){return r()},set tagCounts(e){r(e),hn()},get onTagSelect(){return s()},set onTagSelect(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=Ube();return Ca(y,21,()=>bi(d),_a,(e,t)=>{{let i=In(()=>f(bi(t)));n(e,()=>bi(i))}}),zt(y),pa(e,y),St(m)}ia(["click","keydown"]);const qbe=[{value:null,label:"全部",icon:"calendar",description:"显示所有卡片"},{value:"today",label:"今天",icon:"sun",description:"今天到期或需要复习的卡片"},{value:"due-today",label:"今天到期的",icon:"clock",description:"今天到期的卡片"},{value:"added-today",label:"今天添加的",icon:"plus-circle",description:"今天新添加的卡片"},{value:"edited-today",label:"今天编辑的",icon:"edit",description:"今天修改过的卡片"},{value:"reviewed-today",label:"今天复习的",icon:"check-circle",description:"今天已复习过的卡片"},{value:"first-review",label:"首次复习的",icon:"zap",description:"处于学习中状态的卡片"},{value:"retry-today",label:"今天重来的",icon:"rotate-cw",description:"今天重新学习的卡片"},{value:"never-reviewed",label:"从未复习",icon:"inbox",description:"从未复习过的新卡片"}];function Hbe(e,t,n,i,a,r,s,o,l){$n(t,null),$n(n,new Set,!0),$n(i,null),$n(a,new Set,!0),$n(r,null),$n(s,new Set,!0),$n(o,null),l.clearAll()}var Wbe=la('<div class="filter-loading svelte-10t6zc5"><div class="loading-spinner svelte-10t6zc5"></div> <p>加载筛选数据...</p></div>'),Gbe=(e,t)=>t("decks"),Qbe=(e,t)=>"Enter"===e.key&&t("decks"),Kbe=la('<span class="filter-badge svelte-10t6zc5">1</span>'),Zbe=(e,t)=>t(null),Ybe=(e,t)=>"Enter"===e.key&&t(null),Xbe=la('<div class="tree-item-flair svelte-10t6zc5"> </div>'),Jbe=(e,t,n)=>t(bi(n).id),ewe=(e,t,n)=>"Enter"===e.key&&t(bi(n).id),twe=la('<div class="tree-item-flair svelte-10t6zc5"> </div>'),nwe=la('<div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5"> </div> <!></div></div>'),iwe=la('<div class="filter-section-content svelte-10t6zc5"><div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-inner svelte-10t6zc5">全部牌组</div> <!></div></div> <!></div>'),awe=(e,t)=>t("types"),rwe=(e,t)=>"Enter"===e.key&&t("types"),swe=la('<span class="filter-badge svelte-10t6zc5"> </span>'),owe=(e,t,n)=>t(bi(n).id),lwe=(e,t,n)=>"Enter"===e.key&&t(bi(n).id),cwe=(e,t,n)=>t(bi(n).id),dwe=la('<div class="tree-item-flair svelte-10t6zc5"> </div>'),uwe=la('<div class="tree-item checkbox-item svelte-10t6zc5" role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><input type="checkbox" class="svelte-10t6zc5"/></div> <div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5"> </div> <!></div></div>'),hwe=la('<div class="filter-section-content svelte-10t6zc5"></div>'),pwe=(e,t)=>t("time"),gwe=(e,t)=>"Enter"===e.key&&t("time"),vwe=la('<span class="filter-active-badge"> </span>'),fwe=(e,t)=>t(null),mwe=(e,t)=>"Enter"===e.key&&t(null),ywe=(e,t)=>t("today"),bwe=(e,t)=>"Enter"===e.key&&t("today"),wwe=(e,t)=>t("due-today"),kwe=(e,t)=>"Enter"===e.key&&t("due-today"),Swe=(e,t)=>t("added-today"),xwe=(e,t)=>"Enter"===e.key&&t("added-today"),_we=(e,t)=>t("edited-today"),Cwe=(e,t)=>"Enter"===e.key&&t("edited-today"),Iwe=(e,t)=>t("reviewed-today"),Dwe=(e,t)=>"Enter"===e.key&&t("reviewed-today"),Twe=(e,t)=>t("first-review"),Mwe=(e,t)=>"Enter"===e.key&&t("first-review"),Awe=(e,t)=>t("retry-today"),Ewe=(e,t)=>"Enter"===e.key&&t("retry-today"),zwe=(e,t)=>t("never-reviewed"),Pwe=(e,t)=>"Enter"===e.key&&t("never-reviewed"),Rwe=la('<div class="filter-section-content svelte-10t6zc5"><div role="button" tabindex="0"><span class="time-filter-label svelte-10t6zc5">全部</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">今天</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">今天到期</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">今天添加</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">今天编辑</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">今天复习</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">首次复习</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">今天重来</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div> <div role="button" tabindex="0"><!> <span class="time-filter-label svelte-10t6zc5">从未复习</span> <span class="time-filter-count svelte-10t6zc5"> </span> <!></div></div>'),$we=la('<div class="filter-section svelte-10t6zc5"><div class="filter-section-header svelte-10t6zc5" role="button" tabindex="0"><!> <span class="filter-section-title svelte-10t6zc5">时间筛选</span> <!></div> <!></div>'),Owe=(e,t)=>t("errorBook"),Lwe=(e,t)=>"Enter"===e.key&&t("errorBook"),Nwe=la('<span class="filter-badge svelte-10t6zc5"> </span>'),Fwe=(e,t,n)=>t(n()),Bwe=(e,t,n)=>"Enter"===e.key&&t(n()),jwe=(e,t,n)=>t(n()),Uwe=la('<div class="tree-item checkbox-item svelte-10t6zc5" role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><input type="checkbox" class="svelte-10t6zc5"/></div> <div class="error-level-indicator svelte-10t6zc5"></div> <div class="tree-item-inner svelte-10t6zc5"> </div> <div class="tree-item-flair svelte-10t6zc5"> </div></div></div>'),Vwe=la('<div class="filter-section-content svelte-10t6zc5"></div>'),qwe=(e,t)=>t("accuracy"),Hwe=(e,t)=>"Enter"===e.key&&t("accuracy"),Wwe=la('<span class="filter-badge svelte-10t6zc5">1</span>'),Gwe=(e,t)=>t(null),Qwe=(e,t)=>"Enter"===e.key&&t(null),Kwe=(e,t)=>t("high"),Zwe=(e,t)=>"Enter"===e.key&&t("high"),Ywe=(e,t)=>t("medium"),Xwe=(e,t)=>"Enter"===e.key&&t("medium"),Jwe=(e,t)=>t("low"),eke=(e,t)=>"Enter"===e.key&&t("low"),tke=(e,t)=>t("poor"),nke=(e,t)=>"Enter"===e.key&&t("poor"),ike=(e,t)=>t("untested"),ake=(e,t)=>"Enter"===e.key&&t("untested"),rke=la('<div class="filter-section-content svelte-10t6zc5"><div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-inner svelte-10t6zc5">全部</div> <div class="tree-item-flair svelte-10t6zc5"> </div></div></div> <div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5">90% 以上</div> <div class="tree-item-flair svelte-10t6zc5"> </div></div></div> <div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5">70-89%</div> <div class="tree-item-flair svelte-10t6zc5"> </div></div></div> <div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5">50-69%</div> <div class="tree-item-flair svelte-10t6zc5"> </div></div></div> <div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5">50% 以下</div> <div class="tree-item-flair svelte-10t6zc5"> </div></div></div> <div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5">未测试</div> <div class="tree-item-flair svelte-10t6zc5"> </div></div></div></div>'),ske=la('<div class="filter-section svelte-10t6zc5"><div class="filter-section-header svelte-10t6zc5" role="button" tabindex="0"><!> <span class="filter-section-title svelte-10t6zc5">错题集</span> <!></div> <!></div> <div class="filter-section svelte-10t6zc5"><div class="filter-section-header svelte-10t6zc5" role="button" tabindex="0"><!> <span class="filter-section-title svelte-10t6zc5">正确率</span> <!></div> <!></div>',1),oke=(e,t)=>t("priority"),lke=(e,t)=>"Enter"===e.key&&t("priority"),cke=la('<span class="filter-badge svelte-10t6zc5">1</span>'),dke=(e,t,n)=>t(bi(n).value),uke=(e,t,n)=>"Enter"===e.key&&t(bi(n).value),hke=la('<span class="priority-stars svelte-10t6zc5"> </span>'),pke=la('<div class="tree-item-flair svelte-10t6zc5"> </div>'),gke=la('<div class="tree-item-flair svelte-10t6zc5"> </div>'),vke=la('<div role="button" tabindex="0"><div class="tree-item-self svelte-10t6zc5"><div class="tree-item-icon svelte-10t6zc5"><!></div> <div class="tree-item-inner svelte-10t6zc5"> <!></div> <!></div></div>'),fke=la('<div class="filter-section-content svelte-10t6zc5"></div>'),mke=(e,t)=>t("tags"),yke=(e,t)=>"Enter"===e.key&&t("tags"),bke=la('<span class="filter-badge svelte-10t6zc5"> </span>'),wke=la('<div class="empty-state svelte-10t6zc5"><p>暂无标签</p></div>'),kke=la('<div class="filter-section-content svelte-10t6zc5"><!></div>'),Ske=la('<div class="filter-actions svelte-10t6zc5"><button class="clear-filter-button svelte-10t6zc5"><!> <span>清除所有筛选</span></button></div>'),xke=la('<div class="filter-section svelte-10t6zc5"><div class="filter-section-header svelte-10t6zc5" role="button" tabindex="0"><!> <span class="filter-section-title svelte-10t6zc5">牌组筛选</span> <!></div> <!></div> <div class="filter-section svelte-10t6zc5"><div class="filter-section-header svelte-10t6zc5" role="button" tabindex="0"><!> <span class="filter-section-title svelte-10t6zc5">题型筛选</span> <!></div> <!></div> <!> <!> <div class="filter-section svelte-10t6zc5"><div class="filter-section-header svelte-10t6zc5" role="button" tabindex="0"><!> <span class="filter-section-title svelte-10t6zc5">优先级</span> <!></div> <!></div> <div class="filter-section svelte-10t6zc5"><div class="filter-section-header svelte-10t6zc5" role="button" tabindex="0"><!> <span class="filter-section-title svelte-10t6zc5">标签筛选</span> <!></div> <!></div> <!>',1),_ke=la('<div class="tuanki-global-filter-panel svelte-10t6zc5"><!></div>');ia(["click","keydown","change"]);const Cke=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);let i=Ar(n,"plugin",7),a=i().filterStateService,r=Pn(Ot([])),s=Pn(Ot([])),o=Pn(!0),l=Pn(null),c=Pn(Ot(new Set)),d=Pn(null),u=Pn(Ot(new Set)),h=Pn(null),p=Pn("memory"),g=Pn(Ot(new Set)),v=Pn(null),f=Pn(Ot({decks:!0,types:!0,priority:!0,tags:!0,time:!0,errorBook:!0,accuracy:!0}));const m=[{id:"qa",label:"问答题",icon:"message-circle"},{id:"choice",label:"选择题",icon:"check-square"},{id:"fill",label:"填空题",icon:"edit-3"},{id:"cloze",label:"挖空题",icon:"eye-off"}],y=[{value:null,label:"全部",stars:""},{value:3,label:"高优先级",stars:"⭐⭐⭐"},{value:2,label:"中优先级",stars:"⭐⭐"},{value:1,label:"低优先级",stars:"⭐"},{value:0,label:"无优先级",stars:"-"}];let b=In(()=>{const e={};return bi(s).forEach(t=>{const n=!t.cardPurpose||"memory"===t.cardPurpose,i="test"===t.cardPurpose;("memory"!==bi(p)||n)&&("questionBank"!==bi(p)||i)&&t.deckId&&(e[t.deckId]=(e[t.deckId]||0)+1)}),e}),w=In(()=>{const e={};return bi(s).forEach(t=>{const n=!t.cardPurpose||"memory"===t.cardPurpose,i="test"===t.cardPurpose;if("memory"===bi(p)&&!n)return;if("questionBank"===bi(p)&&!i)return;const a=TS(t);e[a]=(e[a]||0)+1}),e}),k=In(()=>{const e={};let t=0;return bi(s).forEach(n=>{var i;const a=!n.cardPurpose||"memory"===n.cardPurpose,r="test"===n.cardPurpose;if("memory"===bi(p)&&!a)return;if("questionBank"===bi(p)&&!r)return;const s=null!=(i=n.priority)?i:0;e[s]=(e[s]||0)+1,t++}),e[-1]=t,e}),S=In(()=>{if("memory"!==bi(p))return{};return function(e){const{start:t}=zS();return{today:e.filter(e=>{var n;return!!(null==(n=e.fsrs)?void 0:n.due)&&("number"==typeof e.fsrs.due?e.fsrs.due:Number(e.fsrs.due))<=t+864e5}).length,"due-today":e.filter(RS).length,"added-today":e.filter($S).length,"edited-today":e.filter(OS).length,"reviewed-today":e.filter(LS).length,"first-review":e.filter(NS).length,"retry-today":e.filter(FS).length,"never-reviewed":e.filter(BS).length,all:e.length}}(bi(s).filter(e=>!e.cardPurpose||"memory"===e.cardPurpose))}),x=In(()=>function(e){const t=new Map,n=new Set;e.forEach(e=>{e.tags&&Array.isArray(e.tags)&&e.tags.forEach(i=>{var a;const r=xS(i).split("/").filter(Boolean);for(let s=1;s<=r.length;s++){const i=r.slice(0,s).join("/");n.add(i),t.has(i)||t.set(i,new Set),null==(a=t.get(i))||a.add(e.uuid)}})});const i={};return n.forEach(e=>{var n;i[e]=(null==(n=t.get(e))?void 0:n.size)||0}),{aggregatedCounts:i,allTags:Array.from(n)}}(bi(s).filter(e=>{const t=!e.cardPurpose||"memory"===e.cardPurpose,n="test"===e.cardPurpose;return"memory"===bi(p)?t:"questionBank"===bi(p)&&n}))),_=In(()=>bi(r).filter(e=>bi(b)[e.id]>0)),C=In(()=>bi(s).filter(e=>{const t=!e.cardPurpose||"memory"===e.cardPurpose,n="test"===e.cardPurpose;return"memory"===bi(p)?t:"questionBank"===bi(p)&&n}).length),I=In(()=>{if("questionBank"!==bi(p))return{};const e={light:0,medium:0,severe:0};return bi(s).forEach(t=>{if("test"!==t.cardPurpose)return;const n=ES(t);n&&e[n]++}),e}),D=In(()=>{if("questionBank"!==bi(p))return{high:0,medium:0,low:0,poor:0,untested:0};const e={high:0,medium:0,low:0,poor:0,untested:0};return bi(s).forEach(t=>{var n,i;if("test"!==t.cardPurpose)return;const a=null==(i=null==(n=t.stats)?void 0:n.testStats)?void 0:i.accuracy;null==a?e.untested++:a>=.9?e.high++:a>=.7?e.medium++:a>=.5?e.low++:e.poor++}),e});function T(e){$n(l,e,!0),a.updateFilter({selectedDeckId:e})}function M(e){bi(c).has(e)?bi(c).delete(e):bi(c).add(e),$n(c,new Set(bi(c)),!0),a.updateFilter({selectedCardTypes:bi(c)})}function A(e){$n(d,e,!0),a.updateFilter({selectedPriority:e})}function E(e){bi(u).has(e)?bi(u).delete(e):bi(u).add(e),$n(u,new Set(bi(u)),!0),a.updateFilter({selectedTags:bi(u)})}function z(e){$n(h,e,!0),a.updateFilter({selectedTimeFilter:e})}function P(e){bi(g).has(e)?bi(g).delete(e):bi(g).add(e),$n(g,new Set(bi(g)),!0)}function R(e){$n(v,e,!0)}function $(e){bi(f)[e]=!bi(f)[e]}let O=null;Pr(()=>{O=a.subscribe(e=>{$n(l,e.selectedDeckId,!0),$n(c,new Set(e.selectedCardTypes),!0),$n(d,e.selectedPriority,!0),$n(u,new Set(e.selectedTags),!0),$n(h,e.selectedTimeFilter,!0),$n(p,e.dataSource,!0)})}),Rr(()=>{O&&O()}),Ti(()=>{bi(p),async function(){try{if($n(o,!0),"questionBank"===bi(p))if(i().questionBankStorage){const e=await i().questionBankStorage.loadBanks();$n(r,e,!0);const t=[];for(const n of e){const e=await i().questionBankStorage.loadBankQuestions(n.id);t.push(...e)}$n(s,t,!0),_e.debug(`[GlobalFilterPanel] 刷题模式：加载了${bi(r).length}个题库，${bi(s).length}张题目`)}else _e.warn("[GlobalFilterPanel] questionBankStorage 未初始化"),$n(r,[],!0),$n(s,[],!0);else $n(r,await i().dataStorage.getDecks(),!0),$n(s,await i().dataStorage.getCards(),!0),_e.debug(`[GlobalFilterPanel] 记忆模式：加载了${bi(r).length}个牌组，${bi(s).length}张卡片`)}catch(e){_e.error("[GlobalFilterPanel] Failed to load data:",e)}finally{$n(o,!1)}}()});var L={get plugin(){return i()},set plugin(e){i(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)},N=_ke(),F=Gt(N),B=e=>{pa(e,Wbe())},j=e=>{var t=xke(),n=Qt(t),i=Gt(n);i.__click=[Gbe,$],i.__keydown=[Qbe,$];var r=Gt(i);{let e=In(()=>bi(f).decks?"chevron-down":"chevron-right");Ng(r,{get name(){return bi(e)},size:14})}var s=Kt(r,4),o=e=>{pa(e,Kbe())};xa(s,e=>{bi(l)&&e(o)}),zt(i);var O=Kt(i,2),L=e=>{var t=iwe(),n=Gt(t);let i;n.__click=[Zbe,T],n.__keydown=[Ybe,T];var a=Gt(n),r=Kt(Gt(a),2),s=e=>{var t=Xbe(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(C))),pa(e,t)};xa(r,e=>{bi(C)>0&&e(s)}),zt(a),zt(n),Ca(Kt(n,2),17,()=>bi(_),_a,(e,t)=>{var n=nwe();let i;n.__click=[Jbe,T,t],n.__keydown=[ewe,T,t];var a=Gt(n),r=Gt(a);Ng(Gt(r),{name:"folder",size:14}),zt(r);var s=Kt(r,2),o=Gt(s,!0);zt(s);var c=Kt(s,2),d=e=>{var n=twe(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(b)[bi(t).id])),pa(e,n)};xa(c,e=>{void 0!==bi(b)[bi(t).id]&&e(d)}),zt(a),zt(n),zi(e=>{i=Fa(n,1,"tree-item nav-file svelte-10t6zc5",null,i,e),va(o,bi(t).name)},[()=>({"is-active":bi(l)===bi(t).id})]),pa(e,n)}),zt(t),zi(e=>i=Fa(n,1,"tree-item nav-file svelte-10t6zc5",null,i,e),[()=>({"is-active":null===bi(l)})]),pa(e,t)};xa(O,e=>{bi(f).decks&&e(L)}),zt(n);var N=Kt(n,2),F=Gt(N);F.__click=[awe,$],F.__keydown=[rwe,$];var B=Gt(F);{let e=In(()=>bi(f).types?"chevron-down":"chevron-right");Ng(B,{get name(){return bi(e)},size:14})}var j=Kt(B,4),U=e=>{var t=swe(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(c).size)),pa(e,t)};xa(j,e=>{bi(c).size>0&&e(U)}),zt(F);var V=Kt(F,2),q=e=>{var t=hwe();Ca(t,21,()=>m,_a,(e,t)=>{var n=uwe();n.__click=[owe,M,t],n.__keydown=[lwe,M,t];var i=Gt(n),a=Gt(i),r=Gt(a);Za(r),r.__change=[cwe,M,t],zt(a);var s=Kt(a,2);Ng(Gt(s),{get name(){return bi(t).icon},size:14}),zt(s);var o=Kt(s,2),l=Gt(o,!0);zt(o);var d=Kt(o,2),u=e=>{var n=dwe(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(w)[bi(t).id])),pa(e,n)};xa(d,e=>{void 0!==bi(w)[bi(t).id]&&e(u)}),zt(i),zt(n),zi(e=>{Xa(r,e),va(l,bi(t).label)},[()=>bi(c).has(bi(t).id)]),pa(e,n)}),zt(t),pa(e,t)};xa(V,e=>{bi(f).types&&e(q)}),zt(N);var H=Kt(N,2),W=e=>{var t=$we(),n=Gt(t);n.__click=[pwe,$],n.__keydown=[gwe,$];var i=Gt(n);{let e=In(()=>bi(f).time?"chevron-down":"chevron-right");Ng(i,{get name(){return bi(e)},size:14})}var a=Kt(i,4),r=e=>{var t=vwe(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>{var e;return null==(e=qbe.find(e=>e.value===bi(h)))?void 0:e.label}]),pa(e,t)};xa(a,e=>{bi(h)&&e(r)}),zt(n);var s=Kt(n,2),o=e=>{var t=Rwe(),n=Gt(t);let i;n.__click=[fwe,z],n.__keydown=[mwe,z];var a=Kt(Gt(n),2),r=Gt(a,!0);zt(a);var s=Kt(a,2),o=e=>{Ng(e,{name:"check",size:12})};xa(s,e=>{null===bi(h)&&e(o)}),zt(n);var l=Kt(n,2);let c;l.__click=[ywe,z],l.__keydown=[bwe,z];var d=Gt(l);Ng(d,{name:"calendar",size:12});var u=Kt(d,4),p=Gt(u,!0);zt(u);var g=Kt(u,2),v=e=>{Ng(e,{name:"check",size:12})};xa(g,e=>{"today"===bi(h)&&e(v)}),zt(l);var f=Kt(l,2);let m;f.__click=[wwe,z],f.__keydown=[kwe,z];var y=Gt(f);Ng(y,{name:"alert-circle",size:12});var b=Kt(y,4),w=Gt(b,!0);zt(b);var k=Kt(b,2),x=e=>{Ng(e,{name:"check",size:12})};xa(k,e=>{"due-today"===bi(h)&&e(x)}),zt(f);var _=Kt(f,2);let C;_.__click=[Swe,z],_.__keydown=[xwe,z];var I=Gt(_);Ng(I,{name:"plus-circle",size:12});var D=Kt(I,4),T=Gt(D,!0);zt(D);var M=Kt(D,2),A=e=>{Ng(e,{name:"check",size:12})};xa(M,e=>{"added-today"===bi(h)&&e(A)}),zt(_);var E=Kt(_,2);let P;E.__click=[_we,z],E.__keydown=[Cwe,z];var R=Gt(E);Ng(R,{name:"edit",size:12});var $=Kt(R,4),O=Gt($,!0);zt($);var L=Kt($,2),N=e=>{Ng(e,{name:"check",size:12})};xa(L,e=>{"edited-today"===bi(h)&&e(N)}),zt(E);var F=Kt(E,2);let B;F.__click=[Iwe,z],F.__keydown=[Dwe,z];var j=Gt(F);Ng(j,{name:"refresh-cw",size:12});var U=Kt(j,4),V=Gt(U,!0);zt(U);var q=Kt(U,2),H=e=>{Ng(e,{name:"check",size:12})};xa(q,e=>{"reviewed-today"===bi(h)&&e(H)}),zt(F);var W=Kt(F,2);let G;W.__click=[Twe,z],W.__keydown=[Mwe,z];var Q=Gt(W);Ng(Q,{name:"star",size:12});var K=Kt(Q,4),Z=Gt(K,!0);zt(K);var Y=Kt(K,2),X=e=>{Ng(e,{name:"check",size:12})};xa(Y,e=>{"first-review"===bi(h)&&e(X)}),zt(W);var J=Kt(W,2);let ee;J.__click=[Awe,z],J.__keydown=[Ewe,z];var te=Gt(J);Ng(te,{name:"rotate-ccw",size:12});var ne=Kt(te,4),ie=Gt(ne,!0);zt(ne);var ae=Kt(ne,2),re=e=>{Ng(e,{name:"check",size:12})};xa(ae,e=>{"retry-today"===bi(h)&&e(re)}),zt(J);var se=Kt(J,2);let oe;se.__click=[zwe,z],se.__keydown=[Pwe,z];var le=Gt(se);Ng(le,{name:"inbox",size:12});var ce=Kt(le,4),de=Gt(ce,!0);zt(ce);var ue=Kt(ce,2),he=e=>{Ng(e,{name:"check",size:12})};xa(ue,e=>{"never-reviewed"===bi(h)&&e(he)}),zt(se),zt(t),zi((e,t,a,s,o,d,u,h,g)=>{i=Fa(n,1,"time-filter-item svelte-10t6zc5",null,i,e),va(r,bi(S).all),c=Fa(l,1,"time-filter-item svelte-10t6zc5",null,c,t),va(p,bi(S).today),m=Fa(f,1,"time-filter-item svelte-10t6zc5",null,m,a),va(w,bi(S)["due-today"]),C=Fa(_,1,"time-filter-item svelte-10t6zc5",null,C,s),va(T,bi(S)["added-today"]),P=Fa(E,1,"time-filter-item svelte-10t6zc5",null,P,o),va(O,bi(S)["edited-today"]),B=Fa(F,1,"time-filter-item svelte-10t6zc5",null,B,d),va(V,bi(S)["reviewed-today"]),G=Fa(W,1,"time-filter-item svelte-10t6zc5",null,G,u),va(Z,bi(S)["first-review"]),ee=Fa(J,1,"time-filter-item svelte-10t6zc5",null,ee,h),va(ie,bi(S)["retry-today"]),oe=Fa(se,1,"time-filter-item svelte-10t6zc5",null,oe,g),va(de,bi(S)["never-reviewed"])},[()=>({"is-selected":null===bi(h)}),()=>({"is-selected":"today"===bi(h)}),()=>({"is-selected":"due-today"===bi(h)}),()=>({"is-selected":"added-today"===bi(h)}),()=>({"is-selected":"edited-today"===bi(h)}),()=>({"is-selected":"reviewed-today"===bi(h)}),()=>({"is-selected":"first-review"===bi(h)}),()=>({"is-selected":"retry-today"===bi(h)}),()=>({"is-selected":"never-reviewed"===bi(h)})]),pa(e,t)};xa(s,e=>{bi(f).time&&e(o)}),zt(t),pa(e,t)};xa(H,e=>{"memory"===bi(p)&&e(W)});var G=Kt(H,2),Q=e=>{var t=ske(),n=Qt(t),i=Gt(n);i.__click=[Owe,$],i.__keydown=[Lwe,$];var a=Gt(i);{let e=In(()=>bi(f).errorBook?"chevron-down":"chevron-right");Ng(a,{get name(){return bi(e)},size:14})}var r=Kt(a,4),s=e=>{var t=Nwe(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(g).size)),pa(e,t)};xa(r,e=>{bi(g).size>0&&e(s)}),zt(i);var o=Kt(i,2),l=e=>{var t=Vwe();Ca(t,21,()=>Object.entries(MS),_a,(e,t)=>{var n=In(()=>qe(bi(t),2));let i=()=>bi(n)[0],a=()=>bi(n)[1];const r=In(()=>bi(I)[i()]||0);var s=Uwe();s.__click=[Fwe,P,i],s.__keydown=[Bwe,P,i];var o=Gt(s),l=Gt(o),c=Gt(l);Za(c),c.__change=[jwe,P,i],zt(l);var d=Kt(l,2),u=Kt(d,2),h=Gt(u,!0);zt(u);var p=Kt(u,2),v=Gt(p,!0);zt(p),zt(o),zt(s),zi(e=>{var t,n;Xa(c,e),ja(d,`background: ${null!=(t=a().color)?t:""};`),va(h,a().label),ja(p,`color: ${null!=(n=a().color)?n:""};`),va(v,bi(r))},[()=>bi(g).has(i())]),pa(e,s)}),zt(t),pa(e,t)};xa(o,e=>{bi(f).errorBook&&e(l)}),zt(n);var c=Kt(n,2),d=Gt(c);d.__click=[qwe,$],d.__keydown=[Hwe,$];var u=Gt(d);{let e=In(()=>bi(f).accuracy?"chevron-down":"chevron-right");Ng(u,{get name(){return bi(e)},size:14})}var h=Kt(u,4),p=e=>{pa(e,Wwe())};xa(h,e=>{bi(v)&&e(p)}),zt(d);var m=Kt(d,2),y=e=>{var t=rke(),n=Gt(t);let i;n.__click=[Gwe,R],n.__keydown=[Qwe,R];var a=Gt(n),r=Kt(Gt(a),2),s=Gt(r,!0);zt(r),zt(a),zt(n);var o=Kt(n,2);let l;o.__click=[Kwe,R],o.__keydown=[Zwe,R];var c=Gt(o),d=Gt(c);Ng(Gt(d),{name:"trending-up",size:14}),zt(d);var u=Kt(d,4),h=Gt(u,!0);zt(u),zt(c),zt(o);var p=Kt(o,2);let g;p.__click=[Ywe,R],p.__keydown=[Xwe,R];var f=Gt(p),m=Gt(f);Ng(Gt(m),{name:"minus",size:14}),zt(m);var y=Kt(m,4),b=Gt(y,!0);zt(y),zt(f),zt(p);var w=Kt(p,2);let k;w.__click=[Jwe,R],w.__keydown=[eke,R];var S=Gt(w),x=Gt(S);Ng(Gt(x),{name:"trending-down",size:14}),zt(x);var _=Kt(x,4),C=Gt(_,!0);zt(_),zt(S),zt(w);var I=Kt(w,2);let T;I.__click=[tke,R],I.__keydown=[nke,R];var M=Gt(I),A=Gt(M);Ng(Gt(A),{name:"alert-triangle",size:14}),zt(A);var E=Kt(A,4),z=Gt(E,!0);zt(E),zt(M),zt(I);var P=Kt(I,2);let $;P.__click=[ike,R],P.__keydown=[ake,R];var O=Gt(P),L=Gt(O);Ng(Gt(L),{name:"circle",size:14}),zt(L);var N=Kt(L,4),F=Gt(N,!0);zt(N),zt(O),zt(P),zt(t),zi((e,t,a,r,c,d,u)=>{i=Fa(n,1,"tree-item nav-file svelte-10t6zc5",null,i,e),va(s,t),l=Fa(o,1,"tree-item nav-file svelte-10t6zc5",null,l,a),va(h,bi(D).high||0),g=Fa(p,1,"tree-item nav-file svelte-10t6zc5",null,g,r),va(b,bi(D).medium||0),k=Fa(w,1,"tree-item nav-file svelte-10t6zc5",null,k,c),va(C,bi(D).low||0),T=Fa(I,1,"tree-item nav-file svelte-10t6zc5",null,T,d),va(z,bi(D).poor||0),$=Fa(P,1,"tree-item nav-file svelte-10t6zc5",null,$,u),va(F,bi(D).untested||0)},[()=>({"is-active":null===bi(v)}),()=>Object.values(bi(D)).reduce((e,t)=>e+t,0),()=>({"is-active":"high"===bi(v)}),()=>({"is-active":"medium"===bi(v)}),()=>({"is-active":"low"===bi(v)}),()=>({"is-active":"poor"===bi(v)}),()=>({"is-active":"untested"===bi(v)})]),pa(e,t)};xa(m,e=>{bi(f).accuracy&&e(y)}),zt(c),pa(e,t)};xa(G,e=>{"questionBank"===bi(p)&&e(Q)});var K=Kt(G,2),Z=Gt(K);Z.__click=[oke,$],Z.__keydown=[lke,$];var Y=Gt(Z);{let e=In(()=>bi(f).priority?"chevron-down":"chevron-right");Ng(Y,{get name(){return bi(e)},size:14})}var X=Kt(Y,4),J=e=>{pa(e,cke())};xa(X,e=>{null!==bi(d)&&e(J)}),zt(Z);var ee=Kt(Z,2),te=e=>{var t=fke();Ca(t,21,()=>y,_a,(e,t)=>{var n=vke();let i;n.__click=[dke,A,t],n.__keydown=[uke,A,t];var a=Gt(n),r=Gt(a);Ng(Gt(r),{name:"star",size:14}),zt(r);var s=Kt(r,2),o=Gt(s),l=Kt(o),c=e=>{var n=hke(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t).stars)),pa(e,n)};xa(l,e=>{bi(t).stars&&e(c)}),zt(s);var u=Kt(s,2),h=e=>{var n=pke(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(k)[bi(t).value])),pa(e,n)},p=e=>{var n=ha(),i=Qt(n),a=e=>{var t=gke(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(k)[-1]||0)),pa(e,t)};xa(i,e=>{null===bi(t).value&&e(a)},!0),pa(e,n)};xa(u,e=>{null!==bi(t).value&&void 0!==bi(k)[bi(t).value]?e(h):e(p,!1)}),zt(a),zt(n),zi(e=>{var a;i=Fa(n,1,"tree-item nav-file svelte-10t6zc5",null,i,e),va(o,`${null!=(a=bi(t).label)?a:""} `)},[()=>({"is-active":bi(d)===bi(t).value})]),pa(e,n)}),zt(t),pa(e,t)};xa(ee,e=>{bi(f).priority&&e(te)}),zt(K);var ne=Kt(K,2),ie=Gt(ne);ie.__click=[mke,$],ie.__keydown=[yke,$];var ae=Gt(ie);{let e=In(()=>bi(f).tags?"chevron-down":"chevron-right");Ng(ae,{get name(){return bi(e)},size:14})}var re=Kt(ae,4),se=e=>{var t=bke(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(u).size)),pa(e,t)};xa(re,e=>{bi(u).size>0&&e(se)}),zt(ie);var oe=Kt(ie,2),le=e=>{var t=kke(),n=Gt(t),i=e=>{pa(e,wke())},a=e=>{{let t=In(()=>Array.from(bi(u)));Vbe(e,{get tags(){return bi(x).allTags},get tagCounts(){return bi(x).aggregatedCounts},get selectedTags(){return bi(t)},onTagSelect:E})}};xa(n,e=>{0===bi(x).allTags.length?e(i):e(a,!1)}),zt(t),pa(e,t)};xa(oe,e=>{bi(f).tags&&e(le)}),zt(ne);var ce=Kt(ne,2),de=e=>{var t=Ske(),n=Gt(t);n.__click=[Hbe,l,c,d,u,h,g,v,a],Ng(Gt(n),{name:"x-circle",size:14}),Pt(2),zt(n),zt(t),pa(e,t)};xa(ce,e=>{a.hasActiveFilters()&&e(de)}),pa(e,t)};return xa(F,e=>{bi(o)?e(B):e(j,!1)}),zt(N),pa(t,N),St(L)}},Symbol.toStringTag,{value:"Module"}));const Ike=new class{constructor(){oe(this,"BASE_ALPHA",.2),oe(this,"MODE_WEIGHTS",{exam:1.5,quiz:1.2,practice:1}),oe(this,"PRIOR_MASTERY",.5),oe(this,"CONFIDENCE_SCALE",20)}calculateMastery(e){if(!e||0===e.length)return this.getDefaultMetrics();const t=this.calculateEWMA(e),n=this.calculateSimpleAverage(e),i=this.calculateConfidence(e.length),a=this.getConsecutiveCorrect(e),r=this.determineStatus(t,i,a),s=this.analyzeTrend(e),o=Math.round(1/this.BASE_ALPHA),l=this.calculateRecentAccuracy(e,5);return{currentAccuracy:this.toPercentage(t),historicalAccuracy:this.toPercentage(n),confidence:i,status:r,trend:s,effectiveSampleSize:o,totalAttempts:e.length,consecutiveCorrect:a,recentAccuracy:this.toPercentage(l)}}calculateEWMA(e){let t=this.PRIOR_MASTERY;for(const n of e){const e=this.MODE_WEIGHTS[n.mode]||1,i=this.BASE_ALPHA*e;t=i*(n.isCorrect?1:0)+(1-i)*t}return t}calculateSimpleAverage(e){const t=e.filter(e=>e.isCorrect).length;return e.length>0?t/e.length:0}calculateConfidence(e){return 1-Math.exp(-e/this.CONFIDENCE_SCALE)}determineStatus(e,t,n){return t<.5?"insufficient_data":e>=.9&&n>=3?"mastered":e>=.75?"proficient":e>=.6?"learning":e>=.4?"struggling":"needs_review"}analyzeTrend(e){if(e.length<5)return{direction:"unknown",strength:0};const t=Math.floor(e.length/2),n=e.slice(0,t),i=e.slice(t),a=this.calculateSimpleAverage(n),r=this.calculateSimpleAverage(i)-a;return Math.abs(r)<.1?{direction:"stable",strength:0}:r>0?{direction:"improving",strength:r}:{direction:"declining",strength:Math.abs(r)}}getConsecutiveCorrect(e){let t=0;for(let n=e.length-1;n>=0&&e[n].isCorrect;n--)t++;return t}calculateRecentAccuracy(e,t){if(0===e.length)return 0;const n=e.slice(-t);return this.calculateSimpleAverage(n)}toPercentage(e){return Math.round(1e3*e)/10}getDefaultMetrics(){return{currentAccuracy:0,historicalAccuracy:0,confidence:0,status:"insufficient_data",trend:{direction:"unknown",strength:0},effectiveSampleSize:Math.round(1/this.BASE_ALPHA),totalAttempts:0,consecutiveCorrect:0,recentAccuracy:0}}};class Dke{constructor(e,t){oe(this,"storage"),oe(this,"bankService"),oe(this,"currentSession",null),oe(this,"sessionStartTime",0),oe(this,"questionStartTime",0),this.storage=e,this.bankService=t}async startSession(e,t){if(this.currentSession)throw new Error("已有进行中的测试会话，请先完成或取消当前会话");let n=[...t];e.questionCount&&e.questionCount<n.length&&(n=n.slice(0,e.questionCount)),e.shuffleQuestions&&(n=this.shuffleArray(n));let i="未知题库";if(this.bankService){const t=await this.bankService.getBankById(e.bankId);i=(null==t?void 0:t.name)||"未知题库"}const a={id:Gu(),bankId:e.bankId,bankName:i,mode:e.mode,startTime:(new Date).toISOString(),duration:0,status:"in_progress",questions:n.map(e=>{let t,n=null;try{n=this.extractCorrectAnswer(e)}catch(i){t=i instanceof Error?i.message:"未知错误",_e.warn(`[⚠️] 题目 ${e.uuid} 格式错误:`,t)}return{questionId:e.uuid,question:e,userAnswer:null,correctAnswer:n,isCorrect:null,timeSpent:0,submittedAt:null,errorMessage:t}}),currentQuestionIndex:0,score:0,totalQuestions:n.length,correctCount:0,wrongCount:0,skippedCount:0,completedQuestions:0,incorrectCount:0,accuracy:0,config:{timeLimit:e.timeLimit,shuffleOptions:e.shuffleOptions||!1}};return this.currentSession=a,this.sessionStartTime=Date.now(),this.questionStartTime=Date.now(),await this.saveSession(a),a}async submitAnswer(e){if(!this.currentSession)throw new Error("没有进行中的测试会话");const t=this.currentSession.currentQuestionIndex,n=this.currentSession.questions[t];if(!n)throw new Error("当前题目不存在");if(n.questionId!==e.questionId)throw new Error("提交的题目ID与当前题目不匹配");if(null!==n.isCorrect)throw new Error("该题目已经提交过答案");const i=e.timeSpent||(Date.now()-this.questionStartTime)/1e3,a=this.checkAnswer(e.answer,n.correctAnswer);n.userAnswer=e.answer,n.isCorrect=a,n.timeSpent=i,n.submittedAt=(new Date).toISOString(),a?this.currentSession.correctCount++:this.currentSession.wrongCount++,this.currentSession.completedQuestions++,this.currentSession.incorrectCount=this.currentSession.wrongCount;const r=this.currentSession.totalQuestions>0?100/this.currentSession.totalQuestions:0;this.currentSession.score=Math.round(this.currentSession.correctCount*r);const s=this.currentSession.correctCount+this.currentSession.wrongCount;return this.currentSession.accuracy=s>0?this.currentSession.correctCount/s:0,await this.saveSession(this.currentSession),{isCorrect:a,correctAnswer:n.correctAnswer,questionRecord:n}}async skipQuestion(){if(!this.currentSession)throw new Error("没有进行中的测试会话");const e=this.currentSession.currentQuestionIndex,t=this.currentSession.questions[e];t&&null===t.isCorrect&&this.currentSession.skippedCount++}async moveToNextQuestion(){if(!this.currentSession)throw new Error("没有进行中的测试会话");const e=this.currentSession.currentQuestionIndex+1;return!(e>=this.currentSession.totalQuestions)&&(this.currentSession.currentQuestionIndex=e,this.questionStartTime=Date.now(),await this.saveSession(this.currentSession),!0)}async moveToPreviousQuestion(){if(!this.currentSession)throw new Error("没有进行中的测试会话");const e=this.currentSession.currentQuestionIndex-1;return!(e<0)&&(this.currentSession.currentQuestionIndex=e,await this.saveSession(this.currentSession),!0)}async jumpToQuestion(e){if(!this.currentSession)throw new Error("没有进行中的测试会话");if(e<0||e>=this.currentSession.totalQuestions)return _e.warn(`[TestSessionManager] 无效的题目索引: ${e}`),!1;this.currentSession.currentQuestionIndex=e;const t=this.currentSession.questions[e];return t&&null===t.isCorrect&&(this.questionStartTime=Date.now()),await this.saveSession(this.currentSession),!0}async completeSession(){if(!this.currentSession)throw new Error("没有进行中的测试会话");const e=this.currentSession.questions.filter(e=>null===e.isCorrect&&null===e.userAnswer).length;e>0&&_e.warn(`[TestSessionManager] 还有 ${e} 道题未作答`);const t=(Date.now()-this.sessionStartTime)/1e3;this.currentSession.status="completed",this.currentSession.endTime=(new Date).toISOString(),this.currentSession.totalTimeSpent=t;const n=this.currentSession.totalQuestions>0?100/this.currentSession.totalQuestions:0;this.currentSession.score=Math.round(this.currentSession.correctCount*n),await this.saveSession(this.currentSession),await this.updateQuestionStats();const i={...this.currentSession};return this.currentSession=null,i}async cancelSession(){this.currentSession&&(this.currentSession.status="cancelled",this.currentSession.endTime=(new Date).toISOString(),await this.saveSession(this.currentSession),this.currentSession=null)}getCurrentSession(){return this.currentSession}async saveCurrentSession(){this.currentSession&&await this.saveSession(this.currentSession)}async getCurrentQuestionWithRefresh(){if(!this.currentSession)return null;const e=this.currentSession.currentQuestionIndex,t=this.currentSession.questions[e];if(!t)return null;if(!this.bankService)return t;try{const e=await this.bankService.getQuestionById(t.questionId);if(e){t.question=e;try{t.correctAnswer=this.extractCorrectAnswer(e),t.errorMessage=void 0}catch(n){t.correctAnswer=null,t.errorMessage=n instanceof Error?n.message:"未知错误"}}}catch(n){_e.error("[TestSessionManager] 刷新卡片失败:",n)}return t}getCurrentQuestion(){if(!this.currentSession)return null;const e=this.currentSession.currentQuestionIndex;return this.currentSession.questions[e]||null}getCurrentIndex(){return this.currentSession?this.currentSession.currentQuestionIndex:0}getProgress(){if(!this.currentSession)return null;const e=this.currentSession.correctCount+this.currentSession.wrongCount,t=this.currentSession.totalQuestions-e;return{current:this.currentSession.currentQuestionIndex+1,total:this.currentSession.totalQuestions,percentage:e/this.currentSession.totalQuestions*100,answered:e,unanswered:t}}async restoreSession(e){try{const t=await this.storage.loadSession(e);return t&&"in_progress"===t.status&&t?(this.currentSession=t,this.sessionStartTime=new Date(t.startTime).getTime(),this.questionStartTime=Date.now(),t):null}catch(t){return _e.error("[TestSessionManager] Restore session failed:",t),null}}async saveSession(e){try{await this.storage.saveSession(e)}catch(t){throw _e.error("[TestSessionManager] Save session failed:",t),t}}extractCorrectAnswer(e){const t=this.extractAvailableOptions(e.content);if(0===t.length)throw new Error("无法识别选项格式。请确保选项格式为：A) 选项内容\\nB) 选项内容\\n...");const n=this.parseAnswerFromContent(e.content),i=this.validateCorrectAnswer(n,t);if(!i.valid)throw new Error(`无法获取有效的正确答案。\\n错误原因: ${i.reason}\\n可用选项: [${t.join(", ")}]\\n请在选项中使用 {✓} 标记正确答案，例如：\\nA) 选项1\\nB) 选项2 {✓}\\nC) 选项3`);return n}extractAvailableOptions(e){const t=e.indexOf("---div---"),n=(t>-1?e.substring(0,t):e).split("\n"),i=[];for(const a of n){const e=a.match(/^\s*([A-Z])[.、)]/);if(e){const t=e[1];i.includes(t)||i.push(t)}}return i}validateCorrectAnswer(e,t){if(!e||Array.isArray(e)&&0===e.length)return{valid:!1,reason:"未找到{✓}标记。请在正确选项后添加 {✓}"};const n=Array.isArray(e)?e:[e];for(const i of n)if("string"!=typeof i||!/^[A-Z]$/.test(i.trim()))return{valid:!1,reason:`答案"${i}"格式错误（必须是A-Z的单个字母）`};for(const i of n)if(!t.includes(i.trim()))return{valid:!1,reason:`答案"${i}"不在可用选项[${t.join(", ")}]中`};return n.length!==new Set(n).size?{valid:!1,reason:"多选答案存在重复"}:{valid:!0}}parseAnswerFromContent(e){const t=e.indexOf("---div---"),n=(t>-1?e.substring(0,t):e).split("\n"),i=[];for(const a of n)if(a.includes("{✓}")){const e=a.match(/^\s*([A-Z])[.、)]/);if(e){const t=e[1];i.includes(t)||i.push(t)}}return 1===i.length?i[0]:i}checkAnswer(e,t){if(!e)return!1;if(!t)return!1;if("string"==typeof t&&"string"==typeof e)return e.trim().toUpperCase()===t.trim().toUpperCase();if(Array.isArray(t)&&Array.isArray(e)){if(e.length!==t.length)return!1;const n=[...e].map(e=>e.trim().toUpperCase()).sort(),i=[...t].map(e=>e.trim().toUpperCase()).sort();return n.every((e,t)=>e===i[t])}return!1}async updateQuestionStats(){if(this.currentSession)try{const e=await this.storage.loadBankQuestions(this.currentSession.bankId);for(const t of this.currentSession.questions){const n=e.find(e=>e.uuid===t.questionId);if(!n)continue;n.stats.testStats||(n.stats.testStats={totalAttempts:0,correctAttempts:0,incorrectAttempts:0,accuracy:0,bestScore:0,averageScore:0,lastScore:0,averageResponseTime:0,fastestTime:0,lastTestDate:(new Date).toISOString(),isInErrorBook:!1,consecutiveCorrect:0});const i=n.stats.testStats;if(i&&null!==t.isCorrect){i.totalAttempts++,t.isCorrect?(i.correctAttempts++,i.consecutiveCorrect++):(i.incorrectAttempts++,i.consecutiveCorrect=0);const e=this.buildTestHistory(n,t);if(i.masteryMetrics=Ike.calculateMastery(e),i.accuracy=i.masteryMetrics.historicalAccuracy/100,i.lastTestDate=t.submittedAt||(new Date).toISOString(),t.timeSpent>0){const e=i.averageResponseTime*(i.totalAttempts-1);i.averageResponseTime=(e+t.timeSpent)/i.totalAttempts,(0===i.fastestTime||t.timeSpent<i.fastestTime)&&(i.fastestTime=t.timeSpent)}}}await this.storage.saveBankQuestions(this.currentSession.bankId,e)}catch(e){_e.error("[TestSessionManager] Update question stats failed:",e)}}buildTestHistory(e,t){if(!this.currentSession)return[];const n=[];for(const i of this.currentSession.questions)i.questionId===e.uuid&&null!==i.isCorrect&&n.push({isCorrect:i.isCorrect,mode:this.currentSession.config.mode,timestamp:i.submittedAt||(new Date).toISOString(),score:i.isCorrect?100:0,timeSpent:1e3*i.timeSpent});return null===t.isCorrect||n.some(e=>e.timestamp===t.submittedAt)||n.push({isCorrect:t.isCorrect,mode:this.currentSession.config.mode,timestamp:t.submittedAt||(new Date).toISOString(),score:t.isCorrect?100:0,timeSpent:1e3*t.timeSpent}),n.sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime())}shuffleArray(e){const t=[...e];for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return t}}class Tke{static scoreQuestion(e){const t=e.questionId;let n=0,i=!1;return!0===e.isCorrect?(n=1,i=!0):(e.isCorrect,n=0,i=!1),{questionId:t,score:n,maxScore:1,isCorrect:i}}static scoreMultipleChoice(e,t){let n=0,i=!1;if(!e||0===e.length)return{questionId:"",score:0,maxScore:1,isCorrect:!1};if(e.length!==t.length)i=!1,n=0;else{const a=[...e].sort(),r=[...t].sort();i=a.every((e,t)=>e===r[t]),n=i?1:0}return{questionId:"",score:n,maxScore:1,isCorrect:i}}static scoreClozeQuestion(e,t){var n,i;let a=0,r=0;if(!e||0===e.length)return{questionId:"",score:0,maxScore:1,isCorrect:!1,partialCredit:0};const s=t.length,o=1/s;for(let l=0;l<s;l++){((null==(n=e[l])?void 0:n.trim().toLowerCase())||"")===((null==(i=t[l])?void 0:i.trim().toLowerCase())||"")&&(r++,a+=o)}return{questionId:"",score:a,maxScore:1,isCorrect:r===s,partialCredit:r/s*100}}static scoreSession(e){const t=[];let n=0,i=0,a=0,r=0;for(const c of e.questions){const e=this.scoreQuestion(c);t.push(e),n+=e.score,!0===c.isCorrect?i++:!1===c.isCorrect?a++:r++}const s=e.questions.length,o=n/s*100,l=i+a;return{totalScore:o,correctCount:i,wrongCount:a,skippedCount:r,totalQuestions:s,accuracy:l>0?i/l*100:0,grade:this.calculateGrade(o),questionScores:t}}static calculateGrade(e){return e>=this.GRADE_THRESHOLDS["A+"]?"A+":e>=this.GRADE_THRESHOLDS.A?"A":e>=this.GRADE_THRESHOLDS["B+"]?"B+":e>=this.GRADE_THRESHOLDS.B?"B":e>=this.GRADE_THRESHOLDS.C?"C":e>=this.GRADE_THRESHOLDS.D?"D":"F"}static getGradeDescription(e){return{"A+":"优秀+",A:"优秀","B+":"良好+",B:"良好",C:"中等",D:"及格",F:"不及格"}[e]||e}static getGradeColor(e){return{"A+":"#22c55e",A:"#10b981","B+":"#3b82f6",B:"#2563eb",C:"#f59e0b",D:"#ef4444",F:"#dc2626"}[e]||"#6b7280"}static calculatePercentile(e,t){if(0===t.length)return 0;const n=t.filter(t=>t<e).length/t.length*100;return Math.round(n)}static getImprovementSuggestions(e){const t=[],{accuracy:n,wrongCount:i,skippedCount:a}=e;return n<60?t.push("正确率较低，建议复习基础知识后再次测试"):n<80?t.push("正确率尚可，继续巩固薄弱知识点"):n<95?t.push("表现良好，继续保持！"):t.push("优秀！已完全掌握该题库内容"),i>0&&t.push(`有${i}道题答错，建议查看解析并记入错题本`),a>0&&t.push(`有${a}道题未作答，建议下次完整作答`),t}static generateReportSummary(e){const{totalScore:t,correctCount:n,totalQuestions:i,grade:a}=e,r=this.getGradeDescription(a);return`本次测试得分：${t.toFixed(1)}分（${r}），答对${n}/${i}题`}}oe(Tke,"GRADE_THRESHOLDS",{"A+":95,A:90,"B+":85,B:80,C:70,D:60,F:0});const Mke=Object.freeze(Object.defineProperty({__proto__:null,QuestionBankHierarchyService:class{constructor(e,t){if(oe(this,"dataStorage"),oe(this,"questionBankService"),!e)throw new Error("QuestionBankHierarchyService requires AnkiDataStorage instance");if(!t)throw new Error("QuestionBankHierarchyService requires QuestionBankService instance");this.dataStorage=e,this.questionBankService=t,_e.debug("[QuestionBankHierarchyService] Initialized")}async buildQuestionBankTree(e){const t=await this.questionBankService.getAllBanks();if(_e.debug("[QuestionBankHierarchyService] 当前刷题牌组数量:",t.length),0===t.length)return _e.debug("[QuestionBankHierarchyService] 没有刷题牌组数据，返回空树"),[];const n=new Set,i=[],a=async e=>{const i=[];for(const r of e){let e=await this.findQuestionBankByMemoryDeckId(r.deck.id);if(!e){const n=`${r.deck.name} - 刷题`;e=t.find(e=>e.name===n)||null}if(e&&t.some(t=>t.id===(null==e?void 0:e.id))&&!n.has(e.id)){n.add(e.id);const t=await a(r.children),s={deck:e,children:t};i.push(s),_e.debug(`[QuestionBankHierarchyService] 添加刷题牌组: ${e.name} (ID: ${e.id})`)}else await a(r.children)}return i};return i.push(...await a(e)),0===i.length&&t.length>0?(_e.debug("[QuestionBankHierarchyService] 未找到关联的刷题牌组，使用直接构建方式"),this.buildTreeFromBanks(t)):(_e.debug(`[QuestionBankHierarchyService] 构建完成，共 ${n.size} 个唯一刷题牌组`),i)}buildTreeFromBanks(e){const t=new Map,n=[];for(const a of e)t.set(a.id,{deck:a,children:[]});for(const a of e){const e=t.get(a.id);if(a.parentId){const i=t.get(a.parentId);i?i.children.push(e):n.push(e)}else n.push(e)}n.sort((e,t)=>(e.deck.order||0)-(t.deck.order||0));const i=e=>{e.children.sort((e,t)=>(e.deck.order||0)-(t.deck.order||0)),e.children.forEach(i)};return n.forEach(i),n}async findQuestionBankByMemoryDeckId(e){return await this.questionBankService.findBankByMemoryDeckId(e)}async ensureQuestionBankExists(e){const t=await this.findQuestionBankByMemoryDeckId(e);if(t)return t;const n=await this.dataStorage.getDeck(e);if(!n)throw new Error(`记忆牌组不存在: ${e}`);let i;if(n.parentId){i=(await this.ensureQuestionBankExists(n.parentId)).id}const a=`${n.name} - 刷题`,r=i?await this.getQuestionBankPath(i)+`::${a}`:a,s={id:Gu(),name:a,description:`从牌组"${n.name}"自动生成的刷题牌组`,category:n.category||"",categoryIds:n.categoryIds||[],parentId:i,path:r,level:n.level||0,order:0,inheritSettings:!1,deckType:"question-bank",settings:n.settings||this.getDefaultSettings(),stats:this.getDefaultStats(),includeSubdecks:!1,created:(new Date).toISOString(),modified:(new Date).toISOString(),tags:n.tags||[],metadata:{pairedMemoryDeckId:e}},o=await this.questionBankService.createBank(s);return _e.debug(`[QuestionBankHierarchyService] 创建空的刷题牌组: ${a}`),o}async getQuestionBankPath(e){const t=await this.questionBankService.getBankById(e);return(null==t?void 0:t.path)||""}async syncMove(e,t){const n=await this.findQuestionBankByMemoryDeckId(e);if(!n)return;let i;if(t){i=(await this.ensureQuestionBankExists(t)).id}const a=n.path;if(i){const e=await this.questionBankService.getBankById(i);e&&(n.parentId=i,n.path=`${e.path}::${n.name}`,n.level=(e.level||0)+1)}else n.parentId=void 0,n.path=n.name,n.level=0;n.modified=(new Date).toISOString(),await this.questionBankService.updateBank(n),await this.updateChildrenPaths(n.id,a,n.path),_e.debug(`[QuestionBankHierarchyService] 同步移动刷题牌组: ${a} -> ${n.path}`)}async syncRename(e,t){const n=await this.findQuestionBankByMemoryDeckId(e);if(!n)return;const i=n.name,a=n.path;if(n.name=`${t} - 刷题`,n.parentId){const e=await this.questionBankService.getBankById(n.parentId);e&&(n.path=`${e.path}::${n.name}`)}else n.path=n.name;n.modified=(new Date).toISOString(),await this.questionBankService.updateBank(n),await this.updateChildrenPaths(n.id,a,n.path),_e.debug(`[QuestionBankHierarchyService] 同步重命名刷题牌组: ${i} -> ${n.name}`)}async syncDelete(e){const t=await this.findQuestionBankByMemoryDeckId(e);if(!t)return;const n=(await this.getDescendants(t.id)).sort((e,t)=>(t.level||0)-(e.level||0));for(const i of n)await this.questionBankService.deleteBank(i.id);await this.questionBankService.deleteBank(t.id),_e.debug(`[QuestionBankHierarchyService] 同步删除刷题牌组: ${t.name}`)}async updateChildrenPaths(e,t,n){const i=(await this.questionBankService.getAllBanks()).filter(t=>t.parentId===e);for(const a of i){const e=a.path;a.path=a.path.replace(t,n),a.modified=(new Date).toISOString(),await this.questionBankService.updateBank(a),await this.updateChildrenPaths(a.id,e,a.path)}}async getDescendants(e){const t=await this.questionBankService.getAllBanks(),n=t.find(t=>t.id===e);if(!n)return[];const i=[],a=e=>{const n=t.filter(t=>t.parentId&&t.path.startsWith(`${e}::`));for(const t of n)i.push(t),a(t.path)};return a(n.path),i}getDefaultSettings(){return{newCardsPerDay:20,maxReviewsPerDay:200,enableAutoAdvance:!1,showAnswerTime:0,fsrsParams:{w:[.4,.6,2.4,5.8,4.93,.94,.86,.01,1.49,.14,.94,2.18,.05,.34,1.26,.29,2.61],requestRetention:.9,maximumInterval:36500,enableFuzz:!0},learningSteps:[1,10],relearningSteps:[10],graduatingInterval:1,easyInterval:4}}getDefaultStats(){return{totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:0,forecastDays:{}}}},QuestionBankService:class{constructor(e){if(oe(this,"storage"),oe(this,"banks",[]),oe(this,"questions",[]),!e)throw new Error("QuestionBankService requires a valid QuestionBankStorage instance");this.storage=e}async initialize(){await this.loadData()}async loadData(){this.banks=await this.storage.loadBanks(),Array.isArray(this.banks)||(_e.error("[QuestionBankService] ⚠️  banks 数据损坏，重置为空数组"),this.banks=[],await this.storage.saveBanks([])),this.questions=[];for(const t of this.banks)try{const e=await this.storage.loadBankQuestions(t.id);this.questions.push(...e)}catch(e){_e.error(`[QuestionBankService] 加载题库题目失败: ${t.id}`,e)}}async saveData(){await this.storage.saveBanks(this.banks);const e=[...new Set(this.questions.map(e=>e.deckId))];for(const t of e){const e=this.questions.filter(e=>e.deckId===t);await this.storage.saveBankQuestions(t,e)}}async createQuestionBank(e,t=""){const n=(new Date).toISOString(),i={id:Gu(),name:e,description:t,category:"",categoryIds:[],parentId:void 0,path:e,level:0,order:this.banks.length,inheritSettings:!1,deckType:"question-bank",settings:this.getDefaultSettings(),stats:this.getDefaultStats(),includeSubdecks:!1,created:n,modified:n,tags:[],metadata:{}};return this.banks.push(i),await this.storage.saveBanks(this.banks),i}getQuestionBank(e){return this.banks.find(t=>t.id===e)}getAllQuestionBanks(){return[...this.banks]}async getAllBanks(){return await this.loadData(),this.getAllQuestionBanks()}async getBankById(e){return this.getQuestionBank(e)||null}async findBankByMemoryDeckId(e){await this.loadData();return this.getAllQuestionBanks().find(t=>t.metadata&&t.metadata.pairedMemoryDeckId===e)||null}async createBank(e){const t=e.name||"未命名题库",n=e.description||"",i=await this.createQuestionBank(t,n),a={};return e.difficulty&&(a.difficulty=e.difficulty),e.tags&&(a.tags=e.tags),e.category&&(a.category=e.category),void 0!==e.parentId&&(a.parentId=e.parentId),e.path&&(a.path=e.path),void 0!==e.level&&(a.level=e.level),void 0!==e.order&&(a.order=e.order),e.metadata&&e.metadata.pairedMemoryDeckId&&(i.metadata||(i.metadata={}),i.metadata.pairedMemoryDeckId=e.metadata.pairedMemoryDeckId,a.metadata=i.metadata),Object.keys(a).length>0?(await this.updateQuestionBank(i.id,a),await this.loadData(),this.getQuestionBank(i.id)||i):i}async updateBank(e){await this.updateQuestionBank(e.id,e)}async updateQuestionBank(e,t){const n=this.banks.find(t=>t.id===e);if(!n)throw new Error(`题库不存在: ${e}`);Object.assign(n,t),n.modified=(new Date).toISOString(),await this.storage.saveBanks(this.banks)}async deleteBank(e){await this.deleteQuestionBank(e)}async updateBankConfig(e,t){const n=this.banks.find(t=>t.id===e);if(!n)throw new Error(`题库不存在: ${e}`);n.metadata||(n.metadata={}),n.metadata.config||(n.metadata.config={}),n.metadata.config.modeConfig=t,n.modified=(new Date).toISOString(),await this.storage.saveBanks(this.banks)}async deleteQuestionBank(e){const t=this.banks.findIndex(t=>t.id===e);if(-1===t)throw new Error(`题库不存在: ${e}`);this.banks[t],this.questions=this.questions.filter(t=>t.deckId!==e);try{await this.storage.deleteBankQuestions(e)}catch(n){_e.error(`[QuestionBankService] 删除题库题目文件失败: ${e}`,n)}try{await this.storage.deleteErrorBook(e)}catch(n){_e.error(`[QuestionBankService] 删除错题本失败: ${e}`,n)}this.banks.splice(t,1),await this.storage.saveBanks(this.banks)}async addQuestion(e,t){if(!this.getQuestionBank(e))throw new Error(`题库不存在: ${e}`);t.deckId=e,t.cardPurpose="test",this.questions.push(t);const n=this.questions.filter(t=>t.deckId===e);await this.storage.saveBankQuestions(e,n),await this.updateBankStats(e)}async addQuestions(e,t){if(!this.getQuestionBank(e))throw new Error(`题库不存在: ${e}`);for(const i of t)i.deckId=e,i.cardPurpose="test",this.questions.push(i);const n=this.questions.filter(t=>t.deckId===e);await this.storage.saveBankQuestions(e,n),await this.updateBankStats(e)}getQuestion(e){return this.questions.find(t=>t.uuid===e)}async getQuestionById(e){try{let t=this.questions.find(t=>t.uuid===e);return t||(await this.loadData(),t=this.questions.find(t=>t.uuid===e)),t||null}catch(t){return _e.error("[QuestionBankService] 获取题目失败:",e,t),null}}async updateQuestion(e,t){const n=this.questions.find(t=>t.uuid===e);if(!n)throw new Error(`题目不存在: ${e}`);const i=n.deckId;Object.assign(n,t),n.modified=(new Date).toISOString();const a=this.questions.filter(e=>e.deckId===i);await this.storage.saveBankQuestions(i,a)}async deleteQuestion(e,t){const n=t||e,i=this.questions.findIndex(e=>e.uuid===n);if(-1===i)throw new Error(`题目不存在: ${n}`);const a=this.questions[i].deckId;this.questions.splice(i,1);const r=this.questions.filter(e=>e.deckId===a);await this.storage.saveBankQuestions(a,r),await this.updateBankStats(a)}getQuestionsByBank(e,t){let n=this.questions.filter(t=>t.deckId===e);return t&&(n=this.applyFilter(n,t)),Promise.resolve(n)}getQuestionsByTag(e){return this.questions.filter(t=>{var n;return null==(n=t.tags)?void 0:n.includes(e)})}getQuestionsByDifficulty(e){return this.questions.filter(t=>t.difficulty===e)}getUntestedQuestions(e){return this.questions.filter(t=>t.deckId===e&&(!t.stats.testStats||0===t.stats.testStats.totalAttempts))}getErrorQuestions(e){return this.questions.filter(t=>{var n;return t.deckId===e&&(null==(n=t.stats.testStats)?void 0:n.isInErrorBook)})}applyFilter(e,t){let n=[...e];return t.tags&&t.tags.length>0&&(n=n.filter(e=>{var n;return null==(n=t.tags)?void 0:n.some(t=>{var n;return null==(n=e.tags)?void 0:n.includes(t)})})),t.difficulty&&(n=n.filter(e=>e.difficulty===t.difficulty)),t.cardType,t.untestedOnly&&(n=n.filter(e=>!e.stats.testStats||0===e.stats.testStats.totalAttempts)),t.errorOnly&&(n=n.filter(e=>{var t;return null==(t=e.stats.testStats)?void 0:t.isInErrorBook})),n}async updateBankStats(e){const t=this.getQuestionBank(e);if(!t)return;const n=await this.getQuestionsByBank(e),i=n.length,a=n.filter(e=>e.stats.testStats&&e.stats.testStats.totalAttempts>0).length,r=n.filter(e=>e.stats.testStats&&e.stats.testStats.totalAttempts>0),s=r.length>0?r.reduce((e,t)=>{var n,i,a;const r=null==(i=null==(n=t.stats.testStats)?void 0:n.masteryMetrics)?void 0:i.currentAccuracy;return e+(void 0!==r?r/100:(null==(a=t.stats.testStats)?void 0:a.accuracy)||0)},0)/r.length:0,o=r.length>0?r.reduce((e,t)=>{var n;return e+((null==(n=t.stats.testStats)?void 0:n.averageScore)||0)},0)/r.length:0,l=n.filter(e=>{var t;return null==(t=e.stats.testStats)?void 0:t.isInErrorBook}).length,c={easy:n.filter(e=>"easy"===e.difficulty).length,medium:n.filter(e=>"medium"===e.difficulty).length,hard:n.filter(e=>"hard"===e.difficulty).length};t.metadata||(t.metadata={}),t.metadata.questionBankStats={totalQuestions:i,testedQuestions:a,averageAccuracy:s,averageScore:o,averageCompletionTime:0,errorCount:l,totalTests:0,byDifficulty:c},t.modified=(new Date).toISOString(),await this.storage.saveBanks(this.banks)}async getBankStats(e){var t;const n=this.getQuestionBank(e);return n?(await this.updateBankStats(e),(null==(t=n.metadata)?void 0:t.questionBankStats)||null):null}getDefaultSettings(){return{newCardsPerDay:20,maxReviewsPerDay:200,enableAutoAdvance:!1,showAnswerTime:0,fsrsParams:{w:[.4,.6,2.4,5.8,4.93,.94,.86,.01,1.49,.14,.94,2.18,.05,.34,1.26,.29,2.61],requestRetention:.9,maximumInterval:36500,enableFuzz:!0},learningSteps:[1,10],relearningSteps:[10],graduatingInterval:1,easyInterval:4}}getDefaultStats(){return{totalCards:0,newCards:0,learningCards:0,reviewCards:0,todayNew:0,todayReview:0,todayTime:0,totalReviews:0,totalTime:0,memoryRate:0,averageEase:0,forecastDays:{}}}},QuestionBankStorage:u3,TestScoringEngine:Tke,TestSessionManager:Dke},Symbol.toStringTag,{value:"Module"}));var Ake=la('<div><div class="flip-digit svelte-b685jl" id="flip-min-tens"><div class="digit-card svelte-b685jl"><div class="digit-current svelte-b685jl" data-old-value="0"> </div></div></div> <div class="flip-digit svelte-b685jl" id="flip-min-ones"><div class="digit-card svelte-b685jl"><div class="digit-current svelte-b685jl" data-old-value="5"> </div></div></div> <div class="separator svelte-b685jl">:</div> <div class="flip-digit svelte-b685jl" id="flip-sec-tens"><div class="digit-card svelte-b685jl"><div class="digit-current svelte-b685jl" data-old-value="0"> </div></div></div> <div class="flip-digit svelte-b685jl" id="flip-sec-ones"><div class="digit-card svelte-b685jl"><div class="digit-current svelte-b685jl" data-old-value="0"> </div></div></div></div>');function Eke(e,t){if(new.target)return Er({component:Eke,...e});kt(t,!0);let n=Ar(t,"remainingTime",7),i=Ar(t,"isPaused",7,!1),a=Ar(t,"isTimeWarning",7,!1);const r=In(()=>()=>{const e=Math.floor(n()/60),t=n()%60;return{minTens:Math.floor(e/10),minOnes:e%10,secTens:Math.floor(t/10),secOnes:t%10}});let s={minTens:-1,minOnes:-1,secTens:-1,secOnes:-1},o=!0;Ti(()=>{const e=bi(r)();if(o)return s={...e},void(o=!1);const t={minTens:document.getElementById("flip-min-tens"),minOnes:document.getElementById("flip-min-ones"),secTens:document.getElementById("flip-sec-tens"),secOnes:document.getElementById("flip-sec-ones")};Object.keys(e).forEach(n=>{const i=e[n],a=s[n];if(i!==a){const e=t[n];if(e){const t=e.querySelector(".digit-current");t&&t.textContent!==String(i)&&(t.setAttribute("data-old-value",String(a)),t.textContent=String(i),function(e){e.querySelectorAll(".flip-top, .flip-bottom").forEach(e=>e.remove());const t=e.querySelector(".digit-card");if(!t)return;const n=t.querySelector(".digit-current");if(!n)return;const i=n.getAttribute("data-old-value")||n.textContent,a=n.textContent;if(i===a)return;const r=document.createElement("div");r.className="flip-top flipping",r.innerHTML=`<div class="flip-content">${i}</div>`;const s=document.createElement("div");s.className="flip-bottom flipping",s.innerHTML=`<div class="flip-content">${a}</div>`,t.appendChild(r),t.appendChild(s),setTimeout(()=>{r.remove(),s.remove(),n.setAttribute("data-old-value",a||"0")},650)}(e))}}}),s={...e}});var l={get remainingTime(){return n()},set remainingTime(e){n(e),hn()},get isPaused(){return i()},set isPaused(e=!1){i(e),hn()},get isTimeWarning(){return a()},set isTimeWarning(e=!1){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=Ake();let d;var u=Gt(c),h=Gt(u),p=Gt(h),g=Gt(p,!0);zt(p),zt(h),zt(u);var v=Kt(u,2),f=Gt(v),m=Gt(f),y=Gt(m,!0);zt(m),zt(f),zt(v);var b=Kt(v,4),w=Gt(b),k=Gt(w),S=Gt(k,!0);zt(k),zt(w),zt(b);var x=Kt(b,2),_=Gt(x),C=Gt(_),I=Gt(C,!0);return zt(C),zt(_),zt(x),zt(c),zi((e,t,n,i,a)=>{d=Fa(c,1,"flip-clock svelte-b685jl",null,d,e),va(g,t),va(y,n),va(S,i),va(I,a)},[()=>({warning:a(),paused:i()}),()=>bi(r)().minTens,()=>bi(r)().minOnes,()=>bi(r)().secTens,()=>bi(r)().secOnes]),pa(e,c),St(l)}var zke=la('<button class="pause-btn svelte-1emirt3"><!></button>'),Pke=la('<div class="clock-container svelte-1emirt3"><!> <!></div>'),Rke=la('<div class="study-header svelte-1emirt3"><div class="header-left svelte-1emirt3"><h2 class="study-title svelte-1emirt3"> </h2> <div class="study-progress svelte-1emirt3"><span class="progress-text svelte-1emirt3"> </span></div> <!></div> <div class="header-right svelte-1emirt3"><!> <!> <!></div></div>');function $ke(e,t){if(new.target)return Er({component:$ke,...e});kt(t,!0);let n=Ar(t,"bankName",7),i=Ar(t,"currentIndex",7),a=Ar(t,"totalQuestions",7),r=Ar(t,"statsCollapsed",7),s=Ar(t,"showSidebar",7),o=Ar(t,"showNavigator",7,!0),l=Ar(t,"onToggleStats",7),c=Ar(t,"onToggleSidebar",7),d=Ar(t,"onToggleNavigator",7),u=Ar(t,"onClose",7),h=Ar(t,"mode",7,"practice"),p=Ar(t,"remainingTime",7,0),g=Ar(t,"isPaused",7,!1),v=Ar(t,"isTimeWarning",7,!1),f=Ar(t,"onTogglePause",7);var m={get bankName(){return n()},set bankName(e){n(e),hn()},get currentIndex(){return i()},set currentIndex(e){i(e),hn()},get totalQuestions(){return a()},set totalQuestions(e){a(e),hn()},get statsCollapsed(){return r()},set statsCollapsed(e){r(e),hn()},get showSidebar(){return s()},set showSidebar(e){s(e),hn()},get showNavigator(){return o()},set showNavigator(e=!0){o(e),hn()},get onToggleStats(){return l()},set onToggleStats(e){l(e),hn()},get onToggleSidebar(){return c()},set onToggleSidebar(e){c(e),hn()},get onToggleNavigator(){return d()},set onToggleNavigator(e){d(e),hn()},get onClose(){return u()},set onClose(e){u(e),hn()},get mode(){return h()},set mode(e="practice"){h(e),hn()},get remainingTime(){return p()},set remainingTime(e=0){p(e),hn()},get isPaused(){return g()},set isPaused(e=!1){g(e),hn()},get isTimeWarning(){return v()},set isTimeWarning(e=!1){v(e),hn()},get onTogglePause(){return f()},set onTogglePause(e){f(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=Rke(),b=Gt(y),w=Gt(b),k=Gt(w,!0);zt(w);var S=Kt(w,2),x=Gt(S),_=Gt(x);zt(x),zt(S);var C=Kt(S,2),I=e=>{var t=Pke(),n=Gt(t);{let e=In(()=>Math.floor(p()/1e3));Eke(n,{get remainingTime(){return bi(e)},get isPaused(){return g()},get isTimeWarning(){return v()}})}var i=Kt(n,2),a=e=>{var t=zke();t.__click=function(...e){var t;null==(t=f())||t.apply(this,e)};var n=Gt(t);{let e=In(()=>g()?"play":"pause");Ng(n,{get name(){return bi(e)},size:14})}zt(t),zi(()=>er(t,"title",g()?"继续":"暂停")),pa(e,t)};xa(i,e=>{f()&&e(a)}),zt(t),pa(e,t)};xa(C,e=>{"exam"!==h()&&"quiz"!==h()||e(I)}),zt(b);var D=Kt(b,2),T=Gt(D);{let e=In(()=>r()?"展开统计":"收起统计");Hg(T,{variant:"ghost",get onclick(){return l()},get ariaLabel(){return bi(e)},children:(e,t)=>{{let t=In(()=>r()?"chevron-down":"chevron-up");Ng(e,{get name(){return bi(t)},size:"18"})}},$$slots:{default:!0}})}var M=Kt(T,2);{let e=In(()=>s()?"隐藏侧边栏":"显示侧边栏");Hg(M,{variant:"ghost",get onclick(){return c()},get ariaLabel(){return bi(e)},children:(e,t)=>{{let t=In(()=>s()?"sidebar-close":"sidebar-open");Ng(e,{get name(){return bi(t)},size:"18"})}},$$slots:{default:!0}})}return Hg(Kt(M,2),{variant:"ghost",get onclick(){return u()},ariaLabel:"关闭",children:(e,t)=>{Ng(e,{name:"times",size:"18"})},$$slots:{default:!0}}),zt(D),zt(y),zi(()=>{var e,t;va(k,n()||"刷题测试"),va(_,`${null!=(e=i())?e:""} / ${null!=(t=a())?t:""}`)}),pa(e,y),St(m)}ia(["click"]);var Oke=la('<div class="stats-cards svelte-j4pt7e"><div class="stat-card attempts-card svelte-j4pt7e"><div class="stat-header svelte-j4pt7e"><span class="stat-title svelte-j4pt7e">累计答题</span></div> <div class="stat-content svelte-j4pt7e"><div class="stat-value-row svelte-j4pt7e"><span class="stat-value svelte-j4pt7e"> </span> <span class="stat-unit svelte-j4pt7e">次</span></div></div></div> <div class="stat-card accuracy-card svelte-j4pt7e"><div class="stat-header svelte-j4pt7e"><span class="stat-title svelte-j4pt7e">平均正确率</span></div> <div class="stat-content svelte-j4pt7e"><div class="stat-value-row svelte-j4pt7e"><span class="stat-value svelte-j4pt7e"> </span></div></div></div> <div class="stat-card wrong-card svelte-j4pt7e"><div class="stat-header svelte-j4pt7e"><span class="stat-title svelte-j4pt7e">累计错误</span></div> <div class="stat-content svelte-j4pt7e"><div class="stat-value-row svelte-j4pt7e"><span class="stat-value svelte-j4pt7e"> </span> <span class="stat-unit svelte-j4pt7e">次</span></div></div></div> <div class="stat-card score-card svelte-j4pt7e"><div class="stat-header svelte-j4pt7e"><span class="stat-title svelte-j4pt7e">当前得分</span></div> <div class="stat-content svelte-j4pt7e"><div class="stat-value-row svelte-j4pt7e"><span class="stat-value svelte-j4pt7e"> </span> <span class="stat-unit svelte-j4pt7e">分</span></div></div></div></div>');function Lke(e,t){if(new.target)return Er({component:Lke,...e});kt(t,!0);let n=Ar(t,"session",7),i=Ar(t,"currentQuestion",7);const a=In(()=>()=>{var e,t,a;if(!n())return{totalAttempts:0,correctRate:0,wrongCount:0,progress:0,currentScore:0};const r=null==(a=null==(t=null==(e=i())?void 0:e.question)?void 0:t.stats)?void 0:a.testStats,s=n().totalQuestions>0?n().completedQuestions/n().totalQuestions*100:0,o=n().score||0;return r?{totalAttempts:r.totalAttempts||0,correctRate:100*r.accuracy||0,wrongCount:r.incorrectAttempts||0,progress:s,currentScore:o}:{totalAttempts:0,correctRate:0,wrongCount:0,progress:s,currentScore:o}});var r={get session(){return n()},set session(e){n(e),hn()},get currentQuestion(){return i()},set currentQuestion(e){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},s=Oke(),o=Gt(s),l=Kt(Gt(o),2),c=Gt(l),d=Gt(c),u=Gt(d,!0);zt(d),Pt(2),zt(c),zt(l),zt(o);var h=Kt(o,2),p=Kt(Gt(h),2),g=Gt(p),v=Gt(g),f=Gt(v);zt(v),zt(g),zt(p),zt(h);var m=Kt(h,2),y=Kt(Gt(m),2),b=Gt(y),w=Gt(b),k=Gt(w,!0);zt(w),Pt(2),zt(b),zt(y),zt(m);var S=Kt(m,2),x=Kt(Gt(S),2),_=Gt(x),C=Gt(_),I=Gt(C,!0);return zt(C),Pt(2),zt(_),zt(x),zt(S),zt(s),zi((e,t,n,i,a,r)=>{va(u,e),ja(v,`color: ${null!=t?t:""}`),va(f,`${null!=n?n:""}%`),va(k,i),ja(C,`color: ${null!=a?a:""}`),va(I,r)},[()=>bi(a)().totalAttempts,()=>{return(e=bi(a)().correctRate)>=80?"var(--tuanki-success)":e>=60?"var(--tuanki-warning)":"var(--tuanki-error)";var e},()=>bi(a)().correctRate.toFixed(1),()=>bi(a)().wrongCount,()=>{return(e=bi(a)().currentScore)>=90?"var(--tuanki-success)":e>=80?"var(--tuanki-info)":e>=70?"var(--tuanki-warning)":e>=60?"#ff9500":"var(--tuanki-error)";var e},()=>Math.round(bi(a)().currentScore)]),pa(e,s),St(r)}var Nke=la('<div class="submit-answer-area svelte-8sy5qd"><button class="submit-answer-btn svelte-8sy5qd"><!> <span>提交答案</span> <kbd class="svelte-8sy5qd">Enter</kbd></button></div>'),Fke=la("<!> <span>完成测试</span>",1),Bke=la("<!> <span>下一题</span>",1),jke=la('<div class="next-question-area svelte-8sy5qd"><button class="next-question-btn svelte-8sy5qd"><!></button></div>'),Uke=la('<div class="action-section svelte-8sy5qd"><!></div>');function Vke(e,t){if(new.target)return Er({component:Vke,...e});kt(t,!0);let n=Ar(t,"hasSubmitted",7),i=Ar(t,"hasAnswer",7),a=Ar(t,"isLastQuestion",7),r=Ar(t,"onSubmit",7),s=Ar(t,"onNext",7);var o={get hasSubmitted(){return n()},set hasSubmitted(e){n(e),hn()},get hasAnswer(){return i()},set hasAnswer(e){i(e),hn()},get isLastQuestion(){return a()},set isLastQuestion(e){a(e),hn()},get onSubmit(){return r()},set onSubmit(e){r(e),hn()},get onNext(){return s()},set onNext(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=Uke(),c=Gt(l),d=e=>{var t=Nke(),n=Gt(t);n.__click=function(...e){var t;null==(t=r())||t.apply(this,e)},Ng(Gt(n),{name:"send",size:"20"}),Pt(4),zt(n),zt(t),zi(()=>n.disabled=!i()),pa(e,t)},u=e=>{var t=jke(),n=Gt(t);n.__click=function(...e){var t;null==(t=s())||t.apply(this,e)};var i=Gt(n),r=e=>{var t=Fke();Ng(Qt(t),{name:"check",size:"20"}),Pt(2),pa(e,t)},o=e=>{var t=Bke();Ng(Qt(t),{name:"chevron-right",size:"20"}),Pt(2),pa(e,t)};xa(i,e=>{a()?e(r):e(o,!1)}),zt(n),zt(t),pa(e,t)};return xa(c,e=>{n()?e(u,!1):e(d)}),zt(l),pa(e,l),St(o)}function qke(e,t){$n(t,!bi(t))}function Hke(e,t){$n(t,!bi(t))}function Wke(e,t){$n(t,!bi(t))}function Gke(e,t,n){t()&&t()(n())}ia(["click"]);var Qke=la('<button class="toolbar-btn plain-editor-btn svelte-1rwdzgt" title="普通文本编辑器"><!> <span class="btn-label svelte-1rwdzgt">文本编辑</span></button>'),Kke=(e,t)=>$n(t,!1),Zke=la('<div class="info-item no-source svelte-1rwdzgt"><span class="info-label no-source-label svelte-1rwdzgt">无来源</span> <span class="info-value text-muted svelte-1rwdzgt"> </span></div>'),Yke=(e,t)=>("Enter"===e.key||" "===e.key)&&t(),Xke=la('<div class="info-item clickable svelte-1rwdzgt" role="button" tabindex="0"><span class="info-label svelte-1rwdzgt"> </span> <span class="info-value link-value svelte-1rwdzgt"> </span></div>'),Jke=(e,t)=>("Enter"===e.key||" "===e.key)&&t(),eSe=la('<div class="info-item clickable svelte-1rwdzgt" role="button" tabindex="0"><span class="info-label svelte-1rwdzgt">块引用</span> <span class="info-value link-value svelte-1rwdzgt"> </span></div>'),tSe=la('<div class="source-card-loading svelte-1rwdzgt"><!> <span>加载源卡片内容中...</span></div>'),nSe=la('<div class="source-card-content svelte-1rwdzgt"><div class="source-card-header svelte-1rwdzgt"><span>源记忆卡片内容</span></div> <div class="source-card-body svelte-1rwdzgt"><!></div></div>'),iSe=la('<div class="info-item source-card-item svelte-1rwdzgt"><span class="info-label svelte-1rwdzgt">源记忆卡片</span> <span class="info-value svelte-1rwdzgt"> </span></div> <!>',1),aSe=la("<!> <!> <!>",1),rSe=(e,t,n)=>{var i;$n(t,!1),null==(i=n())||i()},sSe=la('<div class="info-section detailed-view-section svelte-1rwdzgt"><button class="detailed-view-btn svelte-1rwdzgt" type="button"><!> <span>查看详细信息</span></button></div>'),oSe=(e,t,n)=>{var i;$n(t,!1),null==(i=n())||i()},lSe=la('<div class="info-section card-debug-section svelte-1rwdzgt"><button class="card-debug-btn svelte-1rwdzgt" type="button" title="查看完整的题目数据结构（JSON格式）"><!> <span>查看数据结构</span></button></div>'),cSe=la('<div class="multi-info-menu-header svelte-1rwdzgt"><span class="svelte-1rwdzgt">卡片信息与来源</span> <button class="close-btn svelte-1rwdzgt"><!></button></div> <div class="multi-info-menu-content svelte-1rwdzgt"><div class="info-section svelte-1rwdzgt"><div class="info-section-title svelte-1rwdzgt">基础信息</div> <div class="info-item svelte-1rwdzgt"><span class="info-label svelte-1rwdzgt">卡片ID</span> <span class="info-value svelte-1rwdzgt"> </span></div> <div class="info-item svelte-1rwdzgt"><span class="info-label svelte-1rwdzgt">卡片状态</span> <span class="info-value svelte-1rwdzgt"> </span></div></div> <div class="info-section svelte-1rwdzgt"><div class="info-section-title svelte-1rwdzgt">来源信息</div> <!></div> <!> <!></div>',1),dSe=(e,t)=>$n(t,!1),uSe=(e,t)=>{var n;return null==(n=t())?void 0:n("auto")},hSe=(e,t)=>{var n;return null==(n=t())?void 0:n("fixed")},pSe=(e,t)=>{var n;return null==(n=t())?void 0:n(parseInt(e.target.value))},gSe=(e,t)=>{var n;return null==(n=t())?void 0:n(e.target.value)},vSe=(e,t)=>{var n;return null==(n=t())?void 0:n(e.target.checked)},fSe=la('<div class="more-settings-menu-header svelte-1rwdzgt"><span class="svelte-1rwdzgt">更多设置</span> <button class="close-btn svelte-1rwdzgt"><!></button></div> <div class="more-settings-menu-content svelte-1rwdzgt"><div class="setting-section svelte-1rwdzgt"><div class="compact-mode-options svelte-1rwdzgt"><label><input type="radio" name="compactMode" value="auto" class="svelte-1rwdzgt"/> <div class="option-content svelte-1rwdzgt"><!> <span class="option-label svelte-1rwdzgt">自动调整</span></div></label> <label><input type="radio" name="compactMode" value="fixed" class="svelte-1rwdzgt"/> <div class="option-content svelte-1rwdzgt"><!> <span class="option-label svelte-1rwdzgt">仅显示图标</span></div></label></div></div> <div class="setting-section svelte-1rwdzgt"><div class="setting-item svelte-1rwdzgt"><div class="setting-label svelte-1rwdzgt">显示列数</div> <select class="setting-select svelte-1rwdzgt"><option>单列显示</option><option>三列显示</option></select></div></div> <div class="setting-section svelte-1rwdzgt"><div class="setting-item svelte-1rwdzgt"><div class="setting-label svelte-1rwdzgt">题目顺序</div> <select class="setting-select svelte-1rwdzgt"><option>正序学习</option><option>乱序学习</option></select></div></div> <div class="setting-section svelte-1rwdzgt"><div class="setting-item toggle-item svelte-1rwdzgt"><div class="setting-label svelte-1rwdzgt"><span>启用直接删除</span></div> <label class="toggle-switch svelte-1rwdzgt"><input type="checkbox" class="svelte-1rwdzgt"/> <span class="slider svelte-1rwdzgt"></span></label></div></div></div>',1),mSe=(e,t)=>$n(t,!1),ySe=(e,t)=>t("tutorial"),bSe=(e,t)=>t("algorithm"),wSe=la('<div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">选择题正确答案识别</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">使用 &#123;✓&#125; 标记正确选项</h4> <p class="svelte-1rwdzgt">在选项行内添加 <code class="svelte-1rwdzgt">&#123;✓&#125;</code> 标记：</p> <pre class="svelte-1rwdzgt">A. 错误选项\nB) 正确选项 &#123;✓&#125;\nC、另一个错误选项</pre> <p class="tutorial-note svelte-1rwdzgt"><strong class="svelte-1rwdzgt">重要：</strong>只有 <code class="svelte-1rwdzgt">&#123;✓&#125;</code> 标记会被识别，且必须在选项区域（<code class="svelte-1rwdzgt">---div---</code> 之前）</p> <h4 class="svelte-1rwdzgt">多选题示例</h4> <pre class="svelte-1rwdzgt">A. 选项1 &#123;✓&#125;\nB) 选项2\nC、选项3 &#123;✓&#125;\nD. 选项4</pre></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">Markdown编辑优势</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">为什么选择Markdown？</h4> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">内容为王</strong>：笔记即卡片，无需重复录入</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">动态解析</strong>：自动识别题型，无需手动选择</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">完整表达</strong>：支持代码块、表格、图片等所有Markdown元素</li></ul></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">题型自动识别</span></div> <div class="tutorial-text svelte-1rwdzgt"><table class="tutorial-table svelte-1rwdzgt"><thead><tr><th class="svelte-1rwdzgt">内容特征</th><th class="svelte-1rwdzgt">识别为</th></tr></thead><tbody><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">包含 <code class="svelte-1rwdzgt">==文本==</code></td><td class="svelte-1rwdzgt">挖空题</td></tr><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">包含 <code class="svelte-1rwdzgt">A./B.</code> 等选项格式</td><td class="svelte-1rwdzgt">选择题</td></tr><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">包含 <code class="svelte-1rwdzgt">---div---</code></td><td class="svelte-1rwdzgt">问答题</td></tr><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">无特殊标记</td><td class="svelte-1rwdzgt">单面卡片</td></tr></tbody></table></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">标准示例</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">单选题示例</h4> <pre class="svelte-1rwdzgt">Q: 以下哪个是TypeScript相比JavaScript的核心特性？ #TypeScript\n\nA) 支持异步编程\nB) 静态类型检查 &#123;✓&#125;\nC) 支持面向对象编程\nD) 支持函数式编程\n\n---div---\n\n正确答案是B。静态类型检查是TypeScript的核心特性，\n它在编译时进行类型检查，帮助开发者提前发现错误。\n而异步编程、面向对象和函数式编程JavaScript也支持。</pre> <h4 class="svelte-1rwdzgt">多选题示例</h4> <pre class="svelte-1rwdzgt">Q: 以下哪些方法可以提高代码可读性？ #编程规范\n\nA) 使用有意义的变量名 &#123;✓&#125;\nB) 添加适当的代码注释 &#123;✓&#125;\nC) 保持函数简短专注 &#123;✓&#125;\nD) 使用单字母变量名\nE) 定期重构代码 &#123;✓&#125;\n\n---div---\n\n正确答案是A、B、C、E。使用有意义的变量名(A)、\n添加适当注释(B)、保持函数简短(C)和定期重构(E)\n都能提高代码可读性。使用单字母变量名(D)会降低\n代码可读性，应该避免。</pre> <h4 class="svelte-1rwdzgt">挖空题示例</h4> <pre class="svelte-1rwdzgt">JavaScript中 ==var== 和 ==let== 的主要区别是 ==作用域== 。</pre> <h4 class="svelte-1rwdzgt">问答题示例</h4> <pre class="svelte-1rwdzgt">Q: 什么是闭包？ #JavaScript #进阶\n\n---div---\n\n闭包是函数和其词法环境的组合。闭包使得函数可以\n访问其外部作用域的变量，即使外部函数已经返回。\n\n**应用场景**：\n- 数据封装和私有变量\n- 创建工厂函数\n- 实现函数柯里化</pre></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">使用技巧</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">快捷键</h4> <ul class="shortcut-list svelte-1rwdzgt"><li class="svelte-1rwdzgt"><kbd class="svelte-1rwdzgt">Space/Enter</kbd> - 显示答案</li> <li class="svelte-1rwdzgt"><kbd class="svelte-1rwdzgt">← →</kbd> - 上/下一题</li> <li class="svelte-1rwdzgt"><kbd class="svelte-1rwdzgt">F</kbd> - 收藏当前题目</li></ul> <h4 class="svelte-1rwdzgt">学习模式</h4> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">正序学习</strong>：按题目顺序</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">乱序学习</strong>：随机打乱顺序</li></ul></div></div>',1),kSe=la('<div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">EWMA算法：科学评估掌握度</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">什么是EWMA？</h4> <p class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">EWMA</strong> = Exponentially Weighted Moving Average（指数加权移动平均）</p> <div class="highlight-box svelte-1rwdzgt"><p class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">核心思想</strong>：近期的测试表现比早期更能反映你的当前掌握水平</p></div> <h4 class="svelte-1rwdzgt">与记忆牌组的关系</h4> <p class="svelte-1rwdzgt">就像记忆牌组使用 <strong class="svelte-1rwdzgt">FSRS6算法</strong> 预测遗忘时间一样，刷题牌组使用 <strong class="svelte-1rwdzgt">EWMA算法</strong> 评估掌握程度。两者都是科学严谨的算法，只是应用场景不同。</p></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">核心公式</span></div> <div class="tutorial-text svelte-1rwdzgt"><pre class="algorithm-formula svelte-1rwdzgt"></pre> <h4 class="svelte-1rwdzgt">权重衰减示例</h4> <p class="svelte-1rwdzgt">假设你做了10次测试：</p> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">第10次（最近）</strong>：权重 20%</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">第9次</strong>：权重 16%</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">第8次</strong>：权重 12.8%</li> <li class="svelte-1rwdzgt">...</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">第1次（最早）</strong>：权重 &lt; 3%</li></ul> <div class="info-box svelte-1rwdzgt"><p class="svelte-1rwdzgt">早期的错误会随着时间自动"遗忘"，不会永久影响你的掌握度评分！</p></div></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">科学依据</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">学习曲线理论</h4> <p class="svelte-1rwdzgt">随着练习次数增加，你的能力在不断提升。正确率应该反映"当前位置"，而非整条曲线的平均值。</p> <h4 class="svelte-1rwdzgt">近因效应（Recency Effect）</h4> <p class="svelte-1rwdzgt">心理学研究证明：人们对近期发生的事件记忆更深刻。同样，近期的测试结果更能预测未来的表现。</p> <h4 class="svelte-1rwdzgt">形成性评估理论</h4> <p class="svelte-1rwdzgt">形成性评估关注"你现在是否已经掌握？"而非"你历史平均掌握多少？"EWMA算法完美体现这一理念。</p></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">EWMA vs 简单平均</span></div> <div class="tutorial-text svelte-1rwdzgt"><table class="tutorial-table comparison-table svelte-1rwdzgt"><thead><tr><th class="svelte-1rwdzgt">学习历史</th><th class="svelte-1rwdzgt">简单平均</th><th class="svelte-1rwdzgt">EWMA算法</th><th class="svelte-1rwdzgt">评价</th></tr></thead><tbody><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">前10次全错，后10次全对</td><td class="svelte-1rwdzgt">50%</td><td class="highlight-value svelte-1rwdzgt">96.8%</td><td class="status-good svelte-1rwdzgt">准确</td></tr><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">前10次全对，后10次全错</td><td class="svelte-1rwdzgt">50%</td><td class="highlight-value svelte-1rwdzgt">3.2%</td><td class="status-good svelte-1rwdzgt">准确</td></tr><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">稳定80%正确率</td><td class="svelte-1rwdzgt">80%</td><td class="svelte-1rwdzgt">80%</td><td class="status-good svelte-1rwdzgt">一致</td></tr><tr class="svelte-1rwdzgt"><td class="svelte-1rwdzgt">连续20次全对</td><td class="svelte-1rwdzgt">100%</td><td class="svelte-1rwdzgt">100%</td><td class="status-good svelte-1rwdzgt">一致</td></tr></tbody></table> <div class="highlight-box svelte-1rwdzgt"><p class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">结论</strong>：EWMA能准确反映学习进度，而简单平均会被早期错误永久拖累！</p></div></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">掌握状态评估</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">6个掌握级别</h4> <div class="mastery-levels svelte-1rwdzgt"><div class="mastery-level level-mastered svelte-1rwdzgt"><div class="level-badge svelte-1rwdzgt">已精通</div> <div class="level-desc svelte-1rwdzgt">正确率 ≥ 90% + 连续3次正确</div></div> <div class="mastery-level level-proficient svelte-1rwdzgt"><div class="level-badge svelte-1rwdzgt">熟练</div> <div class="level-desc svelte-1rwdzgt">正确率 ≥ 75%</div></div> <div class="mastery-level level-learning svelte-1rwdzgt"><div class="level-badge svelte-1rwdzgt">学习中</div> <div class="level-desc svelte-1rwdzgt">正确率 ≥ 60%</div></div> <div class="mastery-level level-struggling svelte-1rwdzgt"><div class="level-badge svelte-1rwdzgt">有困难</div> <div class="level-desc svelte-1rwdzgt">正确率 ≥ 40%</div></div> <div class="mastery-level level-review svelte-1rwdzgt"><div class="level-badge svelte-1rwdzgt">需复习</div> <div class="level-desc svelte-1rwdzgt">正确率 &lt; 40%</div></div> <div class="mastery-level level-insufficient svelte-1rwdzgt"><div class="level-badge svelte-1rwdzgt">数据不足</div> <div class="level-desc svelte-1rwdzgt">测试次数太少（置信度 &lt; 50%）</div></div></div> <h4 class="svelte-1rwdzgt">置信度机制</h4> <p class="svelte-1rwdzgt">系统会根据测试次数计算置信度：</p> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">5次测试</strong>：置信度 22%（低）</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">10次测试</strong>：置信度 39%（低）</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">20次测试</strong>：置信度 63%（中）</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">50次测试</strong>：置信度 92%（高）</li></ul> <div class="info-box svelte-1rwdzgt"><p class="svelte-1rwdzgt">测试次数越多，掌握度评估越准确！</p></div> <h4 class="svelte-1rwdzgt">趋势分析</h4> <p class="svelte-1rwdzgt">系统自动分析你的学习趋势：</p> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">进步中</strong>：近期表现比早期好</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">稳定</strong>：保持稳定的正确率</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">退步中</strong>：需要加强复习</li></ul></div></div> <div class="tutorial-section svelte-1rwdzgt"><div class="tutorial-section-title svelte-1rwdzgt"><!> <span class="svelte-1rwdzgt">如何使用掌握度</span></div> <div class="tutorial-text svelte-1rwdzgt"><h4 class="svelte-1rwdzgt">在哪里查看？</h4> <p class="svelte-1rwdzgt">掌握度指标会显示在：</p> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt">题库列表 - 每道题的统计卡片</li> <li class="svelte-1rwdzgt">测试结果页 - 详细分析报告</li> <li class="svelte-1rwdzgt">题目详情 - 完整的掌握度历史</li></ul> <h4 class="svelte-1rwdzgt">如何理解？</h4> <div class="example-box svelte-1rwdzgt"><p class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">示例显示</strong>：熟练 (78.5%) - 进步中 +12%</p> <p class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">解读</strong>：</p> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt">当前掌握度：78.5%（熟练级别）</li> <li class="svelte-1rwdzgt">学习趋势：进步中</li> <li class="svelte-1rwdzgt">进步幅度：+12%（相比早期提升了12%）</li></ul></div> <h4 class="svelte-1rwdzgt">学习建议</h4> <ul class="svelte-1rwdzgt"><li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">已精通</strong>：可以降低练习频率，定期复习即可</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">熟练/学习中</strong>：继续保持练习，巩固知识</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">有困难/需复习</strong>：增加练习次数，重点关注</li> <li class="svelte-1rwdzgt"><strong class="svelte-1rwdzgt">数据不足</strong>：多做几次测试，建立可靠的评估</li></ul></div></div>',1),SSe=la('<div class="question-bank-tutorial-wrapper svelte-1rwdzgt"><div class="question-bank-tutorial-header svelte-1rwdzgt"><span class="svelte-1rwdzgt">使用教程</span> <button class="close-btn svelte-1rwdzgt"><!></button></div> <div class="question-bank-tutorial-tabs svelte-1rwdzgt"><button>使用教程</button> <button>算法原理</button></div> <div class="question-bank-tutorial-scroll-container svelte-1rwdzgt"><div class="question-bank-tutorial-content svelte-1rwdzgt"><!></div></div></div>'),xSe=la('<div><div class="toolbar-section timer-section svelte-1rwdzgt"><div class="timer-display card-timer svelte-1rwdzgt"><span class="timer-text svelte-1rwdzgt"> </span> <div class="timer-label svelte-1rwdzgt"> </div></div> <div class="timer-display avg-timer svelte-1rwdzgt"><span class="timer-text svelte-1rwdzgt"> </span> <div class="timer-label svelte-1rwdzgt">平均用时</div></div></div> <div class="toolbar-section actions-section svelte-1rwdzgt"><button class="toolbar-btn edit-btn svelte-1rwdzgt"><!> <span class="btn-label svelte-1rwdzgt"> </span></button> <!> <button class="toolbar-btn delete-btn svelte-1rwdzgt"><!> <span class="btn-label svelte-1rwdzgt">删除</span></button> <button><!> <span class="btn-label svelte-1rwdzgt">收藏</span></button> <button class="toolbar-btn priority-btn svelte-1rwdzgt" title="设置重要程度"><div class="priority-indicator svelte-1rwdzgt"> </div> <span class="btn-label svelte-1rwdzgt">重要程度</span></button> <div class="multi-info-container svelte-1rwdzgt"><button title="查看卡片信息与来源"><!> <span class="btn-label svelte-1rwdzgt">查看</span></button> <!></div> <div class="more-settings-container svelte-1rwdzgt"><button title="更多设置"><!> <span class="btn-label svelte-1rwdzgt">更多</span></button> <!></div> <div class="tutorial-container svelte-1rwdzgt"><button title="查看使用教程"><!> <span class="btn-label svelte-1rwdzgt">教程</span></button> <!></div></div></div>');function _Se(e,t){if(new.target)return Er({component:_Se,...e});kt(t,!0);const n=()=>Ir(Vp,"$tr",i),[i,a]=Dr();let r=Ar(t,"card",7),s=Ar(t,"currentCardTime",7),o=Ar(t,"averageTime",7),l=Ar(t,"plugin",7),c=Ar(t,"isEditing",7,!1),d=Ar(t,"tempFileUnavailable",7,!1),u=Ar(t,"compactMode",7,!1),h=Ar(t,"compactModeSetting",7,"auto"),p=Ar(t,"onCompactModeSettingChange",7),g=Ar(t,"onToggleEdit",7),v=Ar(t,"onDelete",7),f=Ar(t,"onToggleFavorite",7),m=Ar(t,"onChangePriority",7),y=Ar(t,"onOpenPlainEditor",7),b=Ar(t,"onOpenDetailedView",7),w=Ar(t,"onOpenCardDebug",7),k=Ar(t,"enableDirectDelete",7,!1),S=Ar(t,"onDirectDeleteToggle",7),x=Ar(t,"questionOrder",7,"sequential"),_=Ar(t,"onQuestionOrderChange",7),C=Ar(t,"navColumnMode",7,3),I=Ar(t,"onNavColumnModeChange",7),D=In(n);function T(e){const t=Math.floor(e/1e3),n=t%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}let M=Pn(!1),A=Pn(null),E=Pn(null),z=Pn(!1),P=Pn(!1),R=Pn(null),$=Pn(!1),O=Pn(null),L=Pn("tutorial");function N(e){$n(L,e,!0)}function F(){var e,t,n,i;return{sourceFile:null==(e=r())?void 0:e.sourceFile,sourceBlock:null==(t=r())?void 0:t.sourceBlock,sourceCardId:null==(i=null==(n=r())?void 0:n.metadata)?void 0:i.sourceCardId}}function B(){var e;if(!(null==(e=r())?void 0:e.sourceFile)||!l())return void new window.Notice(bi(D)("toolbar.sourceNotFound"));l().app.vault.getAbstractFileByPath(r().sourceFile)?(l().app.workspace.openLinkText(r().sourceFile,"",!0),$n(M,!1)):new window.Notice(bi(D)("toolbar.sourceNotExist"))}async function j(){var e,t;if((null==(e=r())?void 0:e.sourceFile)&&l())try{const e=r().sourceFile,n=null==(t=r().sourceBlock)?void 0:t.replace(/^\^/,""),i=l().app.vault.getAbstractFileByPath(e);if(!i)return void new window.Notice(bi(D)("toolbar.sourceDeleted"));const a=l().app.workspace.getLeaf(!1);if(await a.openFile(i),n){await new Promise(e=>setTimeout(e,100));const e=l().app.workspace.getActiveViewOfType(ge.MarkdownView);if(e&&e.editor){const t=(await l().app.vault.read(i)).split("\n");let a=-1;for(let e=0;e<t.length;e++)if(t[e].includes(`^${n}`)){a=e;break}if(a>=0){e.editor.setCursor({line:a,ch:0}),e.editor.scrollIntoView({from:{line:a,ch:0},to:{line:a,ch:0}},!0);const n=t[a],i=n.match(/\s*\^\w+$/),r=i?n.length-i[0].length:n.length;e.editor.setSelection({line:a,ch:0},{line:a,ch:r}),new window.Notice("已跳转到源文档")}}}$n(M,!1)}catch(n){_e.error("[QuestionBankVerticalToolbar] 跳转失败:",n),new window.Notice("跳转失败")}else new window.Notice(bi(D)("toolbar.blockNotFound"))}Ti(()=>{var e,t;bi(M)&&(null==(t=null==(e=r())?void 0:e.metadata)?void 0:t.sourceCardId)&&!bi(E)&&!bi(z)&&async function(){var e,t;const n=null==(t=null==(e=r())?void 0:e.metadata)?void 0:t.sourceCardId;if(n&&l()){$n(z,!0);try{$n(E,await l().dataStorage.getCardByUUID(n),!0),bi(E)||_e.warn("[源卡片查询] 未找到源记忆卡片")}catch(i){_e.error("[源卡片查询] 错误:",i)}finally{$n(z,!1)}}}()});var U={get card(){return r()},set card(e){r(e),hn()},get currentCardTime(){return s()},set currentCardTime(e){s(e),hn()},get averageTime(){return o()},set averageTime(e){o(e),hn()},get plugin(){return l()},set plugin(e){l(e),hn()},get isEditing(){return c()},set isEditing(e=!1){c(e),hn()},get tempFileUnavailable(){return d()},set tempFileUnavailable(e=!1){d(e),hn()},get compactMode(){return u()},set compactMode(e=!1){u(e),hn()},get compactModeSetting(){return h()},set compactModeSetting(e="auto"){h(e),hn()},get onCompactModeSettingChange(){return p()},set onCompactModeSettingChange(e){p(e),hn()},get onToggleEdit(){return g()},set onToggleEdit(e){g(e),hn()},get onDelete(){return v()},set onDelete(e){v(e),hn()},get onToggleFavorite(){return f()},set onToggleFavorite(e){f(e),hn()},get onChangePriority(){return m()},set onChangePriority(e){m(e),hn()},get onOpenPlainEditor(){return y()},set onOpenPlainEditor(e){y(e),hn()},get onOpenDetailedView(){return b()},set onOpenDetailedView(e){b(e),hn()},get onOpenCardDebug(){return w()},set onOpenCardDebug(e){w(e),hn()},get enableDirectDelete(){return k()},set enableDirectDelete(e=!1){k(e),hn()},get onDirectDeleteToggle(){return S()},set onDirectDeleteToggle(e){S(e),hn()},get questionOrder(){return x()},set questionOrder(e="sequential"){x(e),hn()},get onQuestionOrderChange(){return _()},set onQuestionOrderChange(e){_(e),hn()},get navColumnMode(){return C()},set navColumnMode(e=3){C(e),hn()},get onNavColumnModeChange(){return I()},set onNavColumnModeChange(e){I(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},V=xSe();let q;var H=Gt(V),W=Gt(H),G=Gt(W),Q=Gt(G,!0);zt(G);var K=Kt(G,2),Z=Gt(K,!0);zt(K),zt(W);var Y=Kt(W,2),X=Gt(Y),J=Gt(X,!0);zt(X),Pt(2),zt(Y),zt(H);var ee=Kt(H,2),te=Gt(ee);te.__click=function(...e){var t;null==(t=g())||t.apply(this,e)};var ne=Gt(te);{let e=In(()=>c()?"eye":"edit");Ng(ne,{get name(){return bi(e)},size:"18"})}var ie=Kt(ne,2),ae=Gt(ie,!0);zt(ie),zt(te);var re=Kt(te,2),se=e=>{var t=Qke();t.__click=function(...e){var t;null==(t=y())||t.apply(this,e)},Ng(Gt(t),{name:"fileText",size:"18"}),Pt(2),zt(t),pa(e,t)};xa(re,e=>{d()&&e(se)});var oe=Kt(re,2);oe.__click=[Gke,v,k],Ng(Gt(oe),{name:"delete",size:"18"}),Pt(2),zt(oe);var le=Kt(oe,2);let ce;le.__click=function(...e){var t;null==(t=f())||t.apply(this,e)};var de=Gt(le);{let e=In(()=>{var e;return(null==(e=r().tags)?void 0:e.includes("#收藏"))?"starFilled":"star"});Ng(de,{get name(){return bi(e)},size:"18"})}Pt(2),zt(le);var ue=Kt(le,2);ue.__click=function(...e){var t;null==(t=m())||t.apply(this,e)};var he=Gt(ue),pe=Gt(he,!0);zt(he),Pt(2),zt(ue);var ve=Kt(ue,2),fe=Gt(ve);let me;fe.__click=[qke,M],Ng(Gt(fe),{name:"eye",size:"18"}),Pt(2),zt(fe),kr(fe,e=>$n(A,e),()=>bi(A));{const e=e=>{const t=In(F);var n=cSe(),i=Qt(n),a=Kt(Gt(i),2);a.__click=[Kke,M],Ng(Gt(a),{name:"times",size:"12"}),zt(a),zt(i);var s=Kt(i,2),o=Gt(s),l=Kt(Gt(o),2),c=Kt(Gt(l),2),d=Gt(c);zt(c),zt(l);var u=Kt(l,2),h=Kt(Gt(u),2),p=Gt(h,!0);zt(h),zt(u),zt(o);var g=Kt(o,2),v=Kt(Gt(g),2),f=e=>{var t=Zke(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n),zt(t),zi(e=>va(i,e),[()=>bi(D)("toolbar.noSourceLinked")]),pa(e,t)},m=e=>{var n=aSe(),i=Qt(n),a=e=>{var n=Xke();n.__click=B,n.__keydown=[Yke,B];var i=Gt(n),a=Gt(i,!0);zt(i);var r=Kt(i,2),s=Gt(r,!0);zt(r),zt(n),zi((e,n)=>{va(a,e),er(r,"title",bi(t).sourceFile),va(s,n)},[()=>bi(D)("toolbar.sourceDoc"),()=>bi(t).sourceFile.split("/").pop()||bi(t).sourceFile]),pa(e,n)};xa(i,e=>{bi(t).sourceFile&&e(a)});var r=Kt(i,2),s=e=>{var n=eSe();n.__click=j,n.__keydown=[Jke,j];var i=Kt(Gt(n),2),a=Gt(i,!0);zt(i),zt(n),zi(()=>va(a,bi(t).sourceBlock)),pa(e,n)};xa(r,e=>{bi(t).sourceBlock&&e(s)});var o=Kt(r,2),l=e=>{var n=iSe(),i=Qt(n),a=Kt(Gt(i),2),r=Gt(a);zt(a),zt(i);var s=Kt(i,2),o=e=>{var t=tSe();Ng(Gt(t),{name:"loader",size:"14"}),Pt(2),zt(t),pa(e,t)},l=e=>{var t=ha(),n=Qt(t),i=e=>{var t=nSe(),n=Kt(Gt(t),2);Aa(Gt(n),()=>bi(E).content||"（无内容）"),zt(n),zt(t),pa(e,t)};xa(n,e=>{bi(E)&&e(i)},!0),pa(e,t)};xa(s,e=>{bi(z)?e(o):e(l,!1)}),zi(e=>{er(a,"title",bi(t).sourceCardId),va(r,`${null!=e?e:""}...`)},[()=>bi(t).sourceCardId.slice(0,12)]),pa(e,n)};xa(o,e=>{bi(t).sourceCardId&&e(l)}),pa(e,n)};xa(v,e=>{bi(t).sourceFile||bi(t).sourceBlock||bi(t).sourceCardId?e(m,!1):e(f)}),zt(g);var y=Kt(g,2),k=e=>{var t=sSe(),n=Gt(t);n.__click=[rSe,M,b],Ng(Gt(n),{name:"maximize-2",size:"14"}),Pt(2),zt(n),zt(t),pa(e,t)};xa(y,e=>{b()&&e(k)});var S=Kt(y,2),x=e=>{var t=lSe(),n=Gt(t);n.__click=[oSe,M,w],Ng(Gt(n),{name:"code",size:"14"}),Pt(2),zt(n),zt(t),pa(e,t)};xa(S,e=>{w()&&e(x)}),zt(s),zi((e,t)=>{va(d,`${null!=e?e:""}...`),va(p,t)},[()=>r().uuid.slice(0,8),()=>r().fsrs?{0:"新卡片",1:"学习中",2:"复习中",3:"重学中"}[r().fsrs.state]||"未知":"未知"]),pa(e,n)};ff(Kt(fe,2),{get anchor(){return bi(A)},placement:"bottom-start",onClose:()=>$n(M,!1),class:"multi-info-menu-container",get show(){return bi(M)},set show(e){$n(M,e,!0)},children:e,$$slots:{default:!0}})}zt(ve);var ye=Kt(ve,2),be=Gt(ye);let we;be.__click=[Hke,P],Ng(Gt(be),{name:"settings",size:"18"}),Pt(2),zt(be),kr(be,e=>$n(R,e),()=>bi(R));{const e=e=>{var t=fSe(),n=Qt(t),i=Kt(Gt(n),2);i.__click=[dSe,P],Ng(Gt(i),{name:"times",size:"12"}),zt(i),zt(n);var a=Kt(n,2),r=Gt(a),s=Gt(r),o=Gt(s);let l;var c=Gt(o);Za(c),c.__change=[uSe,p];var d=Kt(c,2);Ng(Gt(d),{name:"sliders",size:"16"}),Pt(2),zt(d),zt(o);var u=Kt(o,2);let g;var v=Gt(u);Za(v),v.__change=[hSe,p];var f=Kt(v,2);Ng(Gt(f),{name:"thumbtack",size:"16"}),Pt(2),zt(f),zt(u),zt(s),zt(r);var m=Kt(r,2),y=Gt(m),b=Kt(Gt(y),2);b.__change=[pSe,I];var w=Gt(b);w.value=w.__value="1";var D,T=Kt(w);T.value=T.__value="3",zt(b),Va(b),zt(y),zt(m);var M=Kt(m,2),A=Gt(M),E=Kt(Gt(A),2);E.__change=[gSe,_];var z=Gt(E);z.value=z.__value="sequential";var R,$=Kt(z);$.value=$.__value="random",zt(E),Va(E),zt(A),zt(M);var O=Kt(M,2),L=Gt(O),N=Kt(Gt(L),2),F=Gt(N);Za(F),F.__change=[vSe,S],Pt(2),zt(N),zt(L),zt(O),zt(a),zi((e,t)=>{var n,i;l=Fa(o,1,"compact-mode-option svelte-1rwdzgt",null,l,e),Xa(c,"auto"===h()),g=Fa(u,1,"compact-mode-option svelte-1rwdzgt",null,g,t),Xa(v,"fixed"===h()),D!==(D=C())&&(b.value=null!=(n=b.__value=C())?n:"",Ua(b,C())),R!==(R=x())&&(E.value=null!=(i=E.__value=x())?i:"",Ua(E,x())),Xa(F,k())},[()=>({active:"auto"===h()}),()=>({active:"fixed"===h()})]),pa(e,t)};ff(Kt(be,2),{get anchor(){return bi(R)},placement:"bottom-start",onClose:()=>$n(P,!1),class:"more-settings-menu-container",get show(){return bi(P)},set show(e){$n(P,e,!0)},children:e,$$slots:{default:!0}})}zt(ye);var ke=Kt(ye,2),Se=Gt(ke);let xe;Se.__click=[Wke,$],Ng(Gt(Se),{name:"book-open",size:"18"}),Pt(2),zt(Se),kr(Se,e=>$n(O,e),()=>bi(O));{const e=e=>{var t=SSe(),n=Gt(t),i=Kt(Gt(n),2);i.__click=[mSe,$],Ng(Gt(i),{name:"times",size:"12"}),zt(i),zt(n);var a=Kt(n,2),r=Gt(a);let s;r.__click=[ySe,N];var o=Kt(r,2);let l;o.__click=[bSe,N],zt(a);var c=Kt(a,2),d=Gt(c),u=Gt(d),h=e=>{var t=wSe(),n=Qt(t),i=Gt(n);Ng(Gt(i),{name:"check-circle",size:"14"}),Pt(2),zt(i),Pt(2),zt(n);var a=Kt(n,2),r=Gt(a);Ng(Gt(r),{name:"file-text",size:"14"}),Pt(2),zt(r),Pt(2),zt(a);var s=Kt(a,2),o=Gt(s);Ng(Gt(o),{name:"layers",size:"14"}),Pt(2),zt(o),Pt(2),zt(s);var l=Kt(s,2),c=Gt(l);Ng(Gt(c),{name:"code",size:"14"}),Pt(2),zt(c),Pt(2),zt(l);var d=Kt(l,2),u=Gt(d);Ng(Gt(u),{name:"lightbulb",size:"14"}),Pt(2),zt(u),Pt(2),zt(d),pa(e,t)},p=e=>{var t=ha(),n=Qt(t),i=e=>{var t=kSe(),n=Qt(t),i=Gt(n);Ng(Gt(i),{name:"trending-up",size:"14"}),Pt(2),zt(i),Pt(2),zt(n);var a=Kt(n,2),r=Gt(a);Ng(Gt(r),{name:"function",size:"14"}),Pt(2),zt(r);var s=Kt(r,2);Gt(s).textContent="R_t = α × result_t + (1-α) × R_{t-1}\n\n\n其中：\n  R_t         当前掌握度\n  result_t    最新测试结果（正确=1，错误=0）\n  α           衰减因子（0.2，即近期占20%权重）\n  R_{t-1}     之前的掌握度",Pt(8),zt(s),zt(a);var o=Kt(a,2),l=Gt(o);Ng(Gt(l),{name:"award",size:"14"}),Pt(2),zt(l),Pt(2),zt(o);var c=Kt(o,2),d=Gt(c);Ng(Gt(d),{name:"bar-chart",size:"14"}),Pt(2),zt(d),Pt(2),zt(c);var u=Kt(c,2),h=Gt(u);Ng(Gt(h),{name:"layers",size:"14"}),Pt(2),zt(h),Pt(2),zt(u);var p=Kt(u,2),g=Gt(p);Ng(Gt(g),{name:"lightbulb",size:"14"}),Pt(2),zt(g),Pt(2),zt(p),pa(e,t)};xa(n,e=>{"algorithm"===bi(L)&&e(i)},!0),pa(e,t)};xa(u,e=>{"tutorial"===bi(L)?e(h):e(p,!1)}),zt(d),zt(c),zt(t),zi((e,t)=>{s=Fa(r,1,"svelte-1rwdzgt",null,s,e),l=Fa(o,1,"svelte-1rwdzgt",null,l,t)},[()=>({active:"tutorial"===bi(L)}),()=>({active:"algorithm"===bi(L)})]),pa(e,t)};ff(Kt(Se,2),{get anchor(){return bi(O)},placement:"left-start",onClose:()=>$n($,!1),class:"question-bank-tutorial-menu-container",get show(){return bi($)},set show(e){$n($,e,!0)},children:e,$$slots:{default:!0}})}zt(ke),zt(ee),zt(V),zi((e,t,n,i,a,r,s,o,l,d,u)=>{q=Fa(V,1,"vertical-toolbar svelte-1rwdzgt",null,q,e),va(Q,t),va(Z,n),va(J,i),er(te,"title",c()?"保存并预览":"编辑卡片"),va(ae,c()?"预览":"编辑"),er(oe,"title",k()?"直接删除卡片":"删除卡片（需确认）"),ce=Fa(le,1,"toolbar-btn favorite-btn svelte-1rwdzgt",null,ce,a),er(le,"title",r),ja(ue,`color: ${null!=s?s:""}`),va(pe,o),me=Fa(fe,1,"toolbar-btn multi-info-btn svelte-1rwdzgt",null,me,l),we=Fa(be,1,"toolbar-btn more-settings-btn svelte-1rwdzgt",null,we,d),xe=Fa(Se,1,"toolbar-btn tutorial-btn svelte-1rwdzgt",null,xe,u)},[()=>({compact:u()}),()=>T(s()),()=>bi(D)("toolbar.currentCard"),()=>T(o()),()=>{var e;return{favorited:null==(e=r().tags)?void 0:e.includes("#收藏")}},()=>{var e;return(null==(e=r().tags)?void 0:e.includes("#收藏"))?"取消收藏":"收藏卡片"},()=>function(e){switch(e){case 1:return"#fbbf24";case 2:default:return"#60a5fa";case 3:return"#f97316";case 4:return"#ef4444"}}(r().priority||2),()=>"!".repeat(Math.min(r().priority||2,3)),()=>({active:bi(M)}),()=>({active:bi(P)}),()=>({active:bi($)})]),pa(e,V);var Ce=St(U);return a(),Ce}ia(["click","keydown","change"]);var CSe=(e,t,n)=>t(bi(n)),ISe=la('<div class="nav-cell empty svelte-1qf252z"></div>'),DSe=(e,t,n)=>t(bi(n).index),TSe=la("<button> </button>"),MSe=la('<div class="grid-container svelte-1qf252z"></div>'),ASe=la('<div><button><div class="group-header-left svelte-1qf252z"><div class="group-title svelte-1qf252z"> </div></div> <span class="collapse-icon svelte-1qf252z">▼</span></button> <!></div>'),ESe=la('<div class="question-navigator svelte-1qf252z"></div>');function zSe(e,t){if(new.target)return Er({component:zSe,...e});kt(t,!0);let n=Ar(t,"questions",7),i=Ar(t,"currentIndex",7),a=Ar(t,"onJumpToQuestion",7),r=Ar(t,"columnMode",7,3),s=Pn(Ot([]));const o={choice:{label:"选择题"},cloze:{label:"填空题"},qa:{label:"问答题"}};function l(e,t){return e===i()?"current":void 0===t.isCorrect||null===t.isCorrect?"unanswered":t.isCorrect?"correct":"wrong"}function c(e){e.collapsed=!e.collapsed,$n(s,[...bi(s)],!0)}function d(e){a()(e)}Ti(()=>{const e=new Map;n().forEach((t,n)=>{const i=function(e){var t;const n=null==(t=e.metadata)?void 0:t.questionMetadata;if(!n)return"qa";const i=n.type;return"single_choice"===i||"multiple_choice"===i||"choice"===i?"choice":"cloze"===i?"cloze":"qa"}(t.question);e.has(i)||e.set(i,{type:i,label:o[i].label,questions:[],collapsed:!1}),e.get(i).questions.push({index:n,record:t,status:l(n,t)})}),$n(s,Array.from(e.values()),!0)});var u={get questions(){return n()},set questions(e){n(e),hn()},get currentIndex(){return i()},set currentIndex(e){i(e),hn()},get onJumpToQuestion(){return a()},set onJumpToQuestion(e){a(e),hn()},get columnMode(){return r()},set columnMode(e=3){r(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},h=ESe();return Ca(h,21,()=>bi(s),e=>e.type,(e,t)=>{var n=ASe();let i;var a=Gt(n);a.__click=[CSe,c,t];var s=Gt(a),o=Gt(s),l=Gt(o,!0);zt(o),zt(s),Pt(2),zt(a);var u=Kt(a,2),h=e=>{var n=MSe();Ca(n,21,()=>function(e){const t=[...e];if(1===r())return t;const n=t.length%3;if(n>0){const e=3-n;for(let n=0;n<e;n++)t.push({isEmpty:!0})}return t}(bi(t).questions),_a,(e,t)=>{var n=ha(),i=Qt(n),a=e=>{pa(e,ISe())},r=e=>{var n=TSe();n.__click=[DSe,d,t];var i=Gt(n,!0);zt(n),zi(()=>{var e;Fa(n,1,`nav-cell ${null!=(e=bi(t).status)?e:""}`,"svelte-1qf252z"),er(n,"title",`题目 ${bi(t).index+1}`),va(i,bi(t).index+1)}),pa(e,n)};xa(i,e=>{bi(t).isEmpty?e(a):e(r,!1)}),pa(e,n)}),zt(n),zi(()=>er(n,"data-columns",r())),pa(e,n)};xa(u,e=>{bi(t).collapsed||e(h)}),zt(n),zi(e=>{i=Fa(n,1,"nav-group svelte-1qf252z",null,i,e),Fa(a,1,"group-header "+("choice"===bi(t).type?"accent-blue":"cloze"===bi(t).type?"accent-purple":"accent-orange"),"svelte-1qf252z"),va(l,bi(t).label)},[()=>({collapsed:bi(t).collapsed})]),pa(e,n)}),zt(h),pa(e,h),St(u)}function PSe(e,t){navigator.clipboard.writeText(t().uuid),new ge.Notice("已复制UUID")}async function RSe(e,t,n){var i;try{let e,a;if(t().sourceFile&&(e=t().sourceFile,a=null==(i=t().sourceBlock)?void 0:i.replace(/^\^/,"")),!e)return void new ge.Notice("该卡片没有关联的源文档");const r=n().app.vault.getAbstractFileByPath(e);if(!r)return void new ge.Notice("源文档不存在或已删除");const s=n().app.workspace.getLeaf(!1);if(await s.openFile(r),a){const e=n().app.workspace.getActiveViewOfType(ge.MarkdownView);if(e&&e.editor){const t=(await n().app.vault.read(r)).split("\n");let i=-1;for(let e=0;e<t.length;e++)if(t[e].includes(`^${a}`)){i=e;break}if(i>=0){e.editor.setCursor({line:i,ch:0}),e.editor.scrollIntoView({from:{line:i,ch:0},to:{line:i,ch:0}},!0);const n=t[i],a=n.match(/\s*\^\w+$/),r=a?n.length-a[0].length:n.length;e.editor.setSelection({line:i,ch:0},{line:i,ch:r}),new ge.Notice("已跳转到源文档")}else new ge.Notice("无法找到源文本块")}}else new ge.Notice("已打开源文档")}catch(a){_e.error("[QuestionBankCardInfoTab] 跳转到源文档失败:",a),new ge.Notice("跳转失败")}}function $Se(e,t,n,i){bi(t)&&($n(n,bi(t),!0),$n(i,!0))}ia(["click"]);var OSe=la('<div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">题目类型</span> <span class="info-value svelte-xo6f9n"><span class="type-badge svelte-xo6f9n"> </span></span></div>'),LSe=la('<div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">难度等级</span> <span class="info-value svelte-xo6f9n"><span> </span></span></div>'),NSe=la('<div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">优先级</span> <span class="info-value svelte-xo6f9n"><span> </span></span></div>'),FSe=la('<span class="tag svelte-xo6f9n"> </span>'),BSe=la('<section class="info-section svelte-xo6f9n"><h3 class="section-title with-accent-bar accent-purple svelte-xo6f9n">标签</h3> <div class="tags-container svelte-xo6f9n"></div></section>'),jSe=la('<button class="link-button svelte-xo6f9n" title="点击跳转"><span class="button-text svelte-xo6f9n"> </span></button>'),USe=la('<span class="text-muted svelte-xo6f9n">无源文档</span>'),VSe=la('<span class="mono svelte-xo6f9n"> </span>'),qSe=la('<span class="text-muted svelte-xo6f9n">无块引用</span>'),HSe=la('<span class="status-indicator status-exists svelte-xo6f9n">存在</span>'),WSe=la('<span class="status-indicator status-missing svelte-xo6f9n">已删除</span>'),GSe=la('<span class="text-muted svelte-xo6f9n">未知</span>'),QSe=la('<span class="text-muted svelte-xo6f9n">加载中...</span>'),KSe=la('<div class="source-card-compact svelte-xo6f9n"><span class="source-card-id svelte-xo6f9n"> </span> <button class="view-source-btn svelte-xo6f9n" title="查看源记忆卡片详情">查看详情</button></div>'),ZSe=la('<span class="text-muted svelte-xo6f9n">不存在或已删除</span>'),YSe=la('<span class="text-muted svelte-xo6f9n">无</span>'),XSe=la('<div class="info-row source-memory-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">源记忆卡片</span> <span class="info-value svelte-xo6f9n"><!></span></div>'),JSe=la('<div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">生成方式</span> <span class="info-value svelte-xo6f9n"><span class="generation-badge svelte-xo6f9n">AI自动生成</span></span></div>'),exe=la('<div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">生成时间</span> <span class="info-value svelte-xo6f9n"> </span></div>'),txe=la('<div class="question-bank-info-tab svelte-xo6f9n" role="tabpanel" id="info-panel"><section class="info-section svelte-xo6f9n"><h3 class="section-title with-accent-bar accent-blue svelte-xo6f9n">基础信息</h3> <div class="info-grid svelte-xo6f9n"><div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">UUID</span> <span class="info-value svelte-xo6f9n"><button class="uuid-button svelte-xo6f9n" title="点击复制"><span class="button-text svelte-xo6f9n"> </span></button></span></div> <div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">卡片类型</span> <span class="info-value svelte-xo6f9n"> </span></div> <!> <div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">所属牌组</span> <span class="info-value svelte-xo6f9n"> </span></div> <!> <!> <div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">创建时间</span> <span class="info-value svelte-xo6f9n"> </span></div> <div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">最后编辑</span> <span class="info-value svelte-xo6f9n"> </span></div></div></section> <!> <section class="info-section svelte-xo6f9n"><h3 class="section-title with-accent-bar accent-orange svelte-xo6f9n">来源信息</h3> <div class="info-grid svelte-xo6f9n"><div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">源文档</span> <span class="info-value svelte-xo6f9n"><!></span></div> <div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">块引用</span> <span class="info-value svelte-xo6f9n"><!></span></div> <div class="info-row svelte-xo6f9n"><span class="info-label svelte-xo6f9n">文档状态</span> <span class="info-value svelte-xo6f9n"><!></span></div> <!> <!> <!></div></section></div> <!>',1);function nxe(e,t){if(new.target)return Er({component:nxe,...e});kt(t,!0);const[n,i]=Dr();let a=Ar(t,"card",7),r=Ar(t,"plugin",7),s=Ar(t,"deckName",7),o=Pn(null),l=Pn(!1),c=Pn(!1),d=Pn(null);const u=In(()=>{var e;return"test"===a().cardPurpose&&(null==(e=a().metadata)?void 0:e.sourceCardId)}),h=In(()=>{var e;return null==(e=a().metadata)?void 0:e.sourceCardId});function p(){$n(c,!1),$n(d,null)}Pr(()=>{bi(u)&&async function(){const e=bi(h);if(e&&!bi(l)){$n(l,!0);try{$n(o,await r().dataStorage.getCardByUUID(e),!0)}catch(t){_e.error("[QuestionBankCardInfoTab] 获取源记忆卡片失败:",t)}finally{$n(l,!1)}}}()});var g={get card(){return a()},set card(e){a(e),hn()},get plugin(){return r()},set plugin(e){r(e),hn()},get deckName(){return s()},set deckName(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},v=txe(),f=Qt(v),m=Gt(f),y=Kt(Gt(m),2),b=Gt(y),w=Kt(Gt(b),2),k=Gt(w);k.__click=[PSe,a];var S=Gt(k),x=Gt(S,!0);zt(S),zt(k),zt(w),zt(b);var _=Kt(b,2),C=Kt(Gt(_),2),I=Gt(C,!0);zt(C),zt(_);var D=Kt(_,2),T=e=>{var t=OSe(),n=Kt(Gt(t),2),i=Gt(n),r=Gt(i,!0);zt(i),zt(n),zt(t),zi(e=>va(r,e),[()=>function(e){if(!e)return"未知";switch(e){case"single_choice":return"单选题";case"multiple_choice":return"多选题";case"qa":return"问答题";case"cloze":return"挖空题";default:return e}}(a().metadata.questionType)]),pa(e,t)};xa(D,e=>{var t;(null==(t=a().metadata)?void 0:t.questionType)&&e(T)});var M=Kt(D,2),A=Kt(Gt(M),2),E=Gt(A,!0);zt(A),zt(M);var z=Kt(M,2),P=e=>{var t=LSe(),n=Kt(Gt(t),2),i=Gt(n),r=Gt(i,!0);zt(i),zt(n),zt(t),zi(()=>{var e;Fa(i,1,`difficulty-badge difficulty-${null!=(e=a().difficulty)?e:""}`,"svelte-xo6f9n"),va(r,"easy"===a().difficulty?"简单":"medium"===a().difficulty?"中等":"hard"===a().difficulty?"困难":a().difficulty)}),pa(e,t)};xa(z,e=>{a().difficulty&&e(P)});var R=Kt(z,2),$=e=>{var t=NSe(),n=Kt(Gt(t),2),i=Gt(n),r=Gt(i);zt(i),zt(n),zt(t),zi(()=>{var e,t;Fa(i,1,`priority-badge priority-${null!=(e=a().priority)?e:""}`,"svelte-xo6f9n"),va(r,`P${null!=(t=a().priority)?t:""}`)}),pa(e,t)};xa(R,e=>{a().priority&&e($)});var O=Kt(R,2),L=Kt(Gt(O),2),N=Gt(L,!0);zt(L),zt(O);var F=Kt(O,2),B=Kt(Gt(F),2),j=Gt(B,!0);zt(B),zt(F),zt(y),zt(m);var U=Kt(m,2),V=e=>{var t=BSe(),n=Kt(Gt(t),2);Ca(n,21,()=>a().tags,_a,(e,t)=>{var n=FSe(),i=Gt(n,!0);zt(n),zi(()=>va(i,bi(t))),pa(e,n)}),zt(n),zt(t),pa(e,t)};xa(U,e=>{a().tags&&a().tags.length>0&&e(V)});var q=Kt(U,2),H=Kt(Gt(q),2),W=Gt(H),G=Kt(Gt(W),2),Q=Gt(G),K=e=>{var t=jSe();t.__click=[RSe,a,r];var n=Gt(t),i=Gt(n,!0);zt(n),zt(t),zi(()=>va(i,a().sourceFile)),pa(e,t)},Z=e=>{pa(e,USe())};xa(Q,e=>{a().sourceFile?e(K):e(Z,!1)}),zt(G),zt(W);var Y=Kt(W,2),X=Kt(Gt(Y),2),J=Gt(X),ee=e=>{var t=VSe(),n=Gt(t,!0);zt(t),zi(e=>va(n,e),[()=>Lx(a().sourceBlock,30)]),pa(e,t)},te=e=>{pa(e,qSe())};xa(J,e=>{a().sourceBlock?e(ee):e(te,!1)}),zt(X),zt(Y);var ne=Kt(Y,2),ie=Kt(Gt(ne),2),ae=Gt(ie),re=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,HSe())},r=e=>{pa(e,WSe())};xa(n,e=>{a().sourceExists?e(i):e(r,!1)}),pa(e,t)},se=e=>{pa(e,GSe())};xa(ae,e=>{void 0!==a().sourceExists?e(re):e(se,!1)}),zt(ie),zt(ne);var oe=Kt(ne,2),le=e=>{var t=XSe(),n=Kt(Gt(t),2),i=Gt(n),a=e=>{pa(e,QSe())},r=e=>{var t=ha(),n=Qt(t),i=e=>{var t=KSe(),n=Gt(t),i=Gt(n,!0);zt(n),Kt(n,2).__click=[$Se,o,d,c],zt(t),zi(e=>{er(n,"title",bi(o).uuid),va(i,e)},[()=>Lx(bi(o).uuid,24)]),pa(e,t)},a=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,ZSe())},a=e=>{pa(e,YSe())};xa(n,e=>{bi(h)?e(i):e(a,!1)},!0),pa(e,t)};xa(n,e=>{bi(o)?e(i):e(a,!1)},!0),pa(e,t)};xa(i,e=>{bi(l)?e(a):e(r,!1)}),zt(n),zt(t),pa(e,t)};xa(oe,e=>{bi(u)&&e(le)});var ce=Kt(oe,2),de=e=>{pa(e,JSe())};xa(ce,e=>{var t;(null==(t=a().metadata)?void 0:t.generatedBy)&&e(de)});var ue=Kt(ce,2),he=e=>{var t=exe(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n),zt(t),zi(e=>va(i,e),[()=>Ku(a().metadata.generatedAt)]),pa(e,t)};xa(ue,e=>{var t;(null==(t=a().metadata)?void 0:t.generatedAt)&&e(he)}),zt(H),zt(q),zt(f);var pe=Kt(f,2),ge=e=>{X4(e,{get card(){return bi(d)},get plugin(){return r()},onClose:p,get open(){return bi(c)},set open(e){$n(c,e,!0)}})};xa(pe,e=>{bi(c)&&bi(d)&&e(ge)}),zi((e,t,n,i)=>{va(x,e),va(I,t),va(E,s()),va(N,n),va(j,i)},[()=>Lx(a().uuid,32),()=>function(e){switch(e.type){case"basic":return"基础问答";case"cloze":return"填空题";case"multiple":return"选择题";default:return e.type}}(a()),()=>Ku(a().created),()=>Ku(a().modified)]),pa(e,v);var ve=St(g);return i(),ve}ia(["click"]);var ixe=la('<span class="status-badge in-error-book svelte-p56mza">已加入</span>'),axe=la('<span class="status-badge not-in-error-book svelte-p56mza">未加入</span>'),rxe=la('<div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">最后测试</span> <span class="info-value svelte-p56mza"><span class="time-muted svelte-p56mza"> </span></span></div>'),sxe=la('<section class="info-section svelte-p56mza"><h3 class="section-title with-accent-bar accent-blue svelte-p56mza">核心指标</h3> <div class="stats-overview svelte-p56mza"><div class="stat-card svelte-p56mza"><div class="stat-label svelte-p56mza">总测试次数</div> <div class="stat-value svelte-p56mza"> </div></div> <div class="stat-card svelte-p56mza"><div class="stat-label svelte-p56mza">正确次数</div> <div class="stat-value success svelte-p56mza"> </div></div> <div class="stat-card svelte-p56mza"><div class="stat-label svelte-p56mza">错误次数</div> <div class="stat-value error svelte-p56mza"> </div></div> <div class="stat-card highlight svelte-p56mza"><div class="stat-label svelte-p56mza">正确率</div> <div> </div> <div class="stat-level svelte-p56mza"> </div></div></div></section> <section class="info-section svelte-p56mza"><h3 class="section-title with-accent-bar accent-purple svelte-p56mza">表现指标</h3> <div class="info-grid svelte-p56mza"><div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">平均响应时间</span> <span class="info-value svelte-p56mza"><span class="time-badge svelte-p56mza"> </span></span></div> <div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">最快响应时间</span> <span class="info-value svelte-p56mza"><span class="time-badge fastest svelte-p56mza"> </span></span></div> <div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">最佳得分</span> <span class="info-value svelte-p56mza"><span class="score-badge best svelte-p56mza"> </span></span></div> <div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">平均得分</span> <span class="info-value svelte-p56mza"><span class="score-badge avg svelte-p56mza"> </span></span></div> <div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">最近得分</span> <span class="info-value svelte-p56mza"><span class="score-badge recent svelte-p56mza"> </span></span></div> <div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">连续正确</span> <span class="info-value svelte-p56mza"><span class="streak-badge svelte-p56mza"> </span></span></div> <div class="info-row svelte-p56mza"><span class="info-label svelte-p56mza">错题本</span> <span class="info-value svelte-p56mza"><!></span></div> <!></div></section>',1),oxe=la('<section class="info-section svelte-p56mza"><div class="no-data svelte-p56mza"><div class="no-data-title svelte-p56mza">暂无测试数据</div> <div class="no-data-desc svelte-p56mza">开始答题后，这里将显示您的测试统计信息</div></div></section>'),lxe=la('<div class="test-stats-tab svelte-p56mza" role="tabpanel" id="stats-panel"><!></div>');function cxe(e,t){if(new.target)return Er({component:cxe,...e});kt(t,!0);let n=Ar(t,"card",7);const i=In(()=>{var e;return null==(e=n().stats)?void 0:e.testStats});Ti(()=>{_e.debug("[TestStatsTab] 卡片数据:",{cardPurpose:n().cardPurpose,hasStats:!!n().stats,hasTestStats:!!bi(i),testStats:bi(i)})});const a=In(()=>bi(i)&&0!==bi(i).totalAttempts?Math.round(bi(i).correctAttempts/bi(i).totalAttempts*100):0),r=In(()=>bi(i)&&0!==bi(i).averageResponseTime?(bi(i).averageResponseTime/1e3).toFixed(2):0);var s={get card(){return n()},set card(e){n(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},o=lxe(),l=Gt(o),c=e=>{var t=sxe(),n=Qt(t),s=Kt(Gt(n),2),o=Gt(s),l=Kt(Gt(o),2),c=Gt(l,!0);zt(l),zt(o);var d=Kt(o,2),u=Kt(Gt(d),2),h=Gt(u,!0);zt(u),zt(d);var p=Kt(d,2),g=Kt(Gt(p),2),v=Gt(g,!0);zt(g),zt(p);var f=Kt(p,2),m=Kt(Gt(f),2),y=Gt(m);zt(m);var b=Kt(m,2),w=Gt(b,!0);zt(b),zt(f),zt(s),zt(n);var k=Kt(n,2),S=Kt(Gt(k),2),x=Gt(S),_=Kt(Gt(x),2),C=Gt(_),I=Gt(C);zt(C),zt(_),zt(x);var D=Kt(x,2),T=Kt(Gt(D),2),M=Gt(T),A=Gt(M,!0);zt(M),zt(T),zt(D);var E=Kt(D,2),z=Kt(Gt(E),2),P=Gt(z),R=Gt(P,!0);zt(P),zt(z),zt(E);var $=Kt(E,2),O=Kt(Gt($),2),L=Gt(O),N=Gt(L,!0);zt(L),zt(O),zt($);var F=Kt($,2),B=Kt(Gt(F),2),j=Gt(B),U=Gt(j,!0);zt(j),zt(B),zt(F);var V=Kt(F,2),q=Kt(Gt(V),2),H=Gt(q),W=Gt(H);zt(H),zt(q),zt(V);var G=Kt(V,2),Q=Kt(Gt(G),2),K=Gt(Q),Z=e=>{pa(e,ixe())},Y=e=>{pa(e,axe())};xa(K,e=>{bi(i).isInErrorBook?e(Z):e(Y,!1)}),zt(Q),zt(G);var X=Kt(G,2),J=e=>{var t=rxe(),n=Kt(Gt(t),2),a=Gt(n),r=Gt(a,!0);zt(a),zt(n),zt(t),zi(e=>va(r,e),[()=>Ku(bi(i).lastTestDate)]),pa(e,t)};xa(X,e=>{bi(i).lastTestDate&&e(J)}),zt(S),zt(k),zi((e,t,n)=>{var s,o,l;va(c,bi(i).totalAttempts),va(h,bi(i).correctAttempts),va(v,bi(i).incorrectAttempts),Fa(m,1,`stat-value accuracy ${null!=e?e:""}`,"svelte-p56mza"),va(y,`${null!=(s=bi(a))?s:""}%`),va(w,t),va(I,`${null!=(o=bi(r))?o:""}秒`),va(A,n),va(R,bi(i).bestScore),va(N,bi(i).averageScore),va(U,bi(i).lastScore),va(W,`${null!=(l=bi(i).consecutiveCorrect)?l:""}次`)},[()=>{return(e=bi(a))>=90?"excellent":e>=75?"good":e>=60?"pass":"weak";var e},()=>{return(e=bi(a))>=90?"优秀":e>=75?"良好":e>=60?"及格":"需加强";var e},()=>{return 0===(e=bi(i).fastestTime)?"0秒":`${(e/1e3).toFixed(2)}秒`;var e}]),pa(e,t)},d=e=>{pa(e,oxe())};return xa(l,e=>{bi(i)&&bi(i).totalAttempts>0?e(c):e(d,!1)}),zt(o),pa(e,o),St(s)}var dxe=la('<div class="question-bank-detail-modal svelte-1rvaoyh"><div class="modal-tabs svelte-1rvaoyh"><!></div> <div class="modal-tab-content svelte-1rvaoyh"><!></div></div>');function uxe(e,t){if(new.target)return Er({component:uxe,...e});kt(t,!0);const[n,i]=Dr();let a=Ar(t,"open",15),r=Ar(t,"onClose",7),s=Ar(t,"card",7),o=Ar(t,"plugin",7),l=Ar(t,"allDecks",7),c=Pn(Ot(s())),d=Pn("info"),u=In(()=>[{id:"info",label:"卡片信息",icon:"info"},{id:"stats",label:"测试数据",icon:"bar-chart-2"}]),h=Pn("");function p(e){$n(d,e,!0)}function g(){"function"==typeof r()&&r()()}Ti(()=>{bi(h)||$n(h,"加载中...")}),Ti(()=>{a()&&s().uuid&&(async()=>{try{const e=await o().dataStorage.getCardByUUID(s().uuid);e&&($n(c,e,!0),_e.debug("[QuestionBankCardDetailModal] ✅ 刷新卡片数据:",{uuid:e.uuid,cardPurpose:e.cardPurpose}))}catch(e){_e.error("[QuestionBankCardDetailModal] 刷新卡片数据失败:",e),$n(c,s(),!0)}})()}),Ti(()=>{bi(c)&&(async()=>{try{if(bi(c).deckId)if(l()){const e=l().find(e=>e.id===bi(c).deckId);$n(h,(null==e?void 0:e.name)||bi(c).deckId,!0)}else{const e=(await o().dataStorage.getAllDecks()).find(e=>e.id===bi(c).deckId);$n(h,(null==e?void 0:e.name)||bi(c).deckId,!0)}else $n(h,"无牌组")}catch(e){_e.error("[QuestionBankCardDetailModal] 加载关联数据失败:",e)}})()});var v={get open(){return a()},set open(e){a(e),hn()},get onClose(){return r()},set onClose(e){r(e),hn()},get card(){return s()},set card(e){s(e),hn()},get plugin(){return o()},set plugin(e){o(e),hn()},get allDecks(){return l()},set allDecks(e){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},f=ha(),m=Qt(f),y=e=>{zx(e,{get plugin(){return o()},title:"测试卡片详情",onClose:g,enableTransparentMask:!1,enableWindowDrag:!1,accentColor:"blue",get open(){return a()},set open(e){a(e)},children:(e,t)=>{var n=dxe(),i=Gt(n);Ox(Gt(i),{get tabs(){return bi(u)},get activeTab(){return bi(d)},onTabChange:p}),zt(i);var a=Kt(i,2),r=Gt(a),s=e=>{nxe(e,{get card(){return bi(c)},get plugin(){return o()},get deckName(){return bi(h)}})},l=e=>{var t=ha(),n=Qt(t),i=e=>{cxe(e,{get card(){return bi(c)}})};xa(n,e=>{"stats"===bi(d)&&e(i)},!0),pa(e,t)};xa(r,e=>{"info"===bi(d)?e(s):e(l,!1)}),zt(a),zt(n),pa(e,n)},$$slots:{default:!0}})};xa(m,e=>{a()&&e(y)}),pa(e,f);var b=St(v);return i(),b}var hxe=la('<div class="tooltip-row highlight svelte-148d941"><span class="tooltip-label svelte-148d941">💡 提示</span> <span class="tooltip-value svelte-148d941">重点关注</span></div>'),pxe=la('<div class="sticky-tooltip svelte-148d941"><div class="tooltip-row svelte-148d941"><span class="tooltip-label svelte-148d941">重要程度</span> <span class="tooltip-value svelte-148d941"> </span></div> <div class="tooltip-row svelte-148d941"><span class="tooltip-label svelte-148d941">等级</span> <span class="tooltip-value svelte-148d941"> </span></div> <!></div>'),gxe=la('<div role="button" tabindex="0"><div class="sticky-number svelte-148d941"> </div> <div class="sticky-label svelte-148d941"> </div> <!></div>');function vxe(e,t){if(new.target)return Er({component:vxe,...e});kt(t,!0);let n=Ar(t,"importance",7),i=Ar(t,"sticky",7,!1);const a={1:{number:"1",label:"一般",color:"#10b981",bgGradient:"linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)",textColor:"#065f46",wiggle:!1},2:{number:"2",label:"重要",color:"#3b82f6",bgGradient:"linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)",textColor:"#1e40af",wiggle:!1},3:{number:"3",label:"很重要",color:"#f59e0b",bgGradient:"linear-gradient(135deg, #fed7aa 0%, #fdba74 100%)",textColor:"#7c2d12",wiggle:!1},4:{number:"4",label:"非常重要",color:"#ef4444",bgGradient:"linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)",textColor:"#991b1b",wiggle:!0}},r=In(()=>a[n()]||a[1]);let s=Pn(!1),o=Pn(!1);Ti(()=>{if(n()&&i()){$n(o,!1);const e=setTimeout(()=>{$n(o,!0)},150);return()=>clearTimeout(e)}$n(o,!1)});var l={get importance(){return n()},set importance(e){n(e),hn()},get sticky(){return i()},set sticky(e=!1){i(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},c=ha(),d=Qt(c),u=e=>{var t=gxe();let i;var a=Gt(t),o=Gt(a,!0);zt(a);var l=Kt(a,2),c=Gt(l,!0);zt(l);var d=Kt(l,2),u=e=>{var t=pxe(),i=Gt(t),a=Kt(Gt(i),2),s=Gt(a,!0);zt(a),zt(i);var o=Kt(i,2),l=Kt(Gt(o),2),c=Gt(l);zt(l),zt(o);var d=Kt(o,2),u=e=>{pa(e,hxe())};xa(d,e=>{n()>=3&&e(u)}),zt(t),zi(()=>{var e;va(s,bi(r).label),va(c,`${null!=(e=n())?e:""}/4`)}),pa(e,t)};xa(d,e=>{bi(s)&&e(u)}),zt(t),zi(e=>{var n,a;i=Fa(t,1,"importance-sticky-note svelte-148d941",null,i,e),ja(t,`background: ${null!=(n=bi(r).bgGradient)?n:""}; color: ${null!=(a=bi(r).textColor)?a:""};`),va(o,bi(r).number),va(c,bi(r).label)},[()=>({wiggle:bi(r).wiggle})]),na("mouseenter",t,()=>$n(s,!0)),na("mouseleave",t,()=>$n(s,!1)),pa(e,t)};return xa(d,e=>{i()&&bi(o)&&e(u)}),pa(e,c),St(l)}async function fxe(e,t,n,i,a,r){if(bi(t))try{const e={...bi(t).question,priority:bi(n),modified:(new Date).toISOString()};if((await i().dataStorage.saveCard(e)).success){bi(t).question.priority=bi(n),$n(t,{...bi(t)},!0);const e=["","低","中","高","极高"][bi(n)]||"中";new ge.Notice(`重要程度已设置为：${e}`),$n(a,!1)}}catch(s){r(s,"更新重要程度","更新失败")}}var mxe=la('<div class="loading-state svelte-1jb1ynk"><div class="spinner svelte-1jb1ynk"></div> <p class="svelte-1jb1ynk">正在准备测试...</p></div>'),yxe=la('<div class="navigator-sidebar svelte-1jb1ynk"><!></div>'),bxe=la("<span> </span>"),wxe=la('<span class="question-type svelte-1jb1ynk">多选题</span>'),kxe=la('<span class="question-type svelte-1jb1ynk">单选题</span>'),Sxe=(e,t,n,i,a)=>bi(t)?n(bi(i).id):a(bi(i).id),xxe=la('<span><!> <span class="badge-text svelte-1jb1ynk"> </span></span>'),_xe=la('<button><span class="option-label svelte-1jb1ynk"> </span> <span class="option-text svelte-1jb1ynk"> </span> <!></button>'),Cxe=la('<div class="explanation-area svelte-1jb1ynk"><div class="explanation-header svelte-1jb1ynk"><!> <span class="explanation-title svelte-1jb1ynk">答案解析</span></div> <div class="explanation-content svelte-1jb1ynk"><!></div></div>'),Ixe=la('<div class="question-area svelte-1jb1ynk"><div class="question-stem svelte-1jb1ynk"><div class="question-header svelte-1jb1ynk"><!> <!></div> <div class="question-content svelte-1jb1ynk"> </div></div> <div class="options-area svelte-1jb1ynk"><!></div> <!></div>'),Dxe=la('<div class="sidebar-content svelte-1jb1ynk"><!></div>'),Txe=(e,t)=>$n(t,!bi(t)),Mxe=la('<span class="undo-badge svelte-1jb1ynk"> </span>'),Axe=la('<!> <div><!> <div class="main-study-area svelte-1jb1ynk"><!> <div class="card-study-container svelte-1jb1ynk"><div class="card-container svelte-1jb1ynk"><!> <!></div></div></div> <!> <div class="study-footer svelte-1jb1ynk"><div class="footer-actions svelte-1jb1ynk"><div class="footer-left-actions svelte-1jb1ynk"><button class="nav-toggle-btn svelte-1jb1ynk"><!></button> <button class="undo-btn svelte-1jb1ynk"><!> <!></button></div> <div class="footer-center-actions svelte-1jb1ynk"><!></div></div></div></div>',1),Exe=(e,t)=>$n(t,!1),zxe=(e,t)=>"Escape"===e.key&&$n(t,!1),Pxe=e=>e.stopPropagation(),Rxe=(e,t)=>{"Escape"===e.key&&(e.stopPropagation(),$n(t,!1))},$xe=(e,t)=>$n(t,!1),Oxe=(e,t)=>$n(t,1),Lxe=(e,t)=>$n(t,2),Nxe=(e,t)=>$n(t,3),Fxe=(e,t)=>$n(t,4),Bxe=(e,t)=>$n(t,!1),jxe=la('<div class="modal-overlay svelte-1jb1ynk" role="dialog" aria-modal="true" tabindex="-1"><div class="priority-modal svelte-1jb1ynk" role="button" tabindex="0"><div class="modal-header svelte-1jb1ynk"><h3 class="svelte-1jb1ynk">设置重要程度</h3> <button class="modal-close svelte-1jb1ynk">×</button></div> <div class="modal-body svelte-1jb1ynk"><p class="modal-description svelte-1jb1ynk">选择当前题目的重要程度：</p> <div class="priority-buttons svelte-1jb1ynk"><button><div class="priority-btn-left svelte-1jb1ynk"><div class="priority-icon svelte-1jb1ynk">!</div> <div class="priority-label svelte-1jb1ynk">低</div></div> <div class="priority-radio svelte-1jb1ynk"></div></button> <button><div class="priority-btn-left svelte-1jb1ynk"><div class="priority-icon svelte-1jb1ynk">!!</div> <div class="priority-label svelte-1jb1ynk">中</div></div> <div class="priority-radio svelte-1jb1ynk"></div></button> <button><div class="priority-btn-left svelte-1jb1ynk"><div class="priority-icon svelte-1jb1ynk">!!!</div> <div class="priority-label svelte-1jb1ynk">高</div></div> <div class="priority-radio svelte-1jb1ynk"></div></button> <button><div class="priority-btn-left svelte-1jb1ynk"><div class="priority-icon svelte-1jb1ynk">!!!</div> <div class="priority-label svelte-1jb1ynk">极高</div></div> <div class="priority-radio svelte-1jb1ynk"></div></button></div></div> <div class="modal-footer svelte-1jb1ynk"><button class="btn-secondary svelte-1jb1ynk">取消</button> <button class="btn-primary svelte-1jb1ynk">确认设置</button></div></div></div>'),Uxe=la('<div class="question-bank-study-interface-overlay svelte-1jb1ynk"><div class="question-bank-study-interface-content svelte-1jb1ynk"><!></div></div> <!> <!> <!>',1);function Vxe(e,t){var n;if(new.target)return Er({component:Vxe,...e});kt(t,!0);let i=Ar(t,"bankId",7),a=Ar(t,"bankName",7,"题库测试"),r=Ar(t,"plugin",7),s=Ar(t,"questions",7),o=Ar(t,"mode",7,"practice"),l=Ar(t,"config",7),c=Ar(t,"onComplete",7),d=Ar(t,"onExit",7),u=Pn(null),h=Pn(null),p=Pn(null),g=Pn(!1),v=Pn(null),f=Pn(!1),m=Pn(!1),y=Pn(!0),b=Pn(!0),w=Pn(0);const k=In(()=>Math.ceil(.2*s().length)),S=In(()=>bi(w)<bi(k)&&bi(f));let x=Pn(!1),_=Pn(null),C=Pn(!1),I=Pn(!1),D=Pn(!1),T=Pn(""),M=Pn(Ot(null!=(n=r().settings.enableDirectDelete)&&n)),A=Pn(!1),E=Pn(2),z=Pn("sequential"),P=Pn(3),R=Pn(!1),$=Pn("auto"),O=Pn(!1),L=Pn(!1),N=Pn(0),F=null,B=Pn(36e5),j=Pn(0),U=Pn(0),V=Pn(!1),q=In(()=>bi(U)>0&&bi(U)<3e5);function H(e,t,n){const i=e instanceof Error?e.message:"未知错误";_e.error(`[QuestionBankStudyInterface] ${t} failed:`,e),new ge.Notice(n||`${t}失败: ${i}`)}let W=In(()=>{var e,t,n;if(null==(e=bi(p))?void 0:e.question.content)try{const e=q6(bi(p).question.content);return e&&_e.debug("[QuestionBankStudyInterface] 选择题解析成功:",{hasExplanation:!!e.explanation,explanationLength:(null==(t=e.explanation)?void 0:t.length)||0,explanationPreview:(null==(n=e.explanation)?void 0:n.substring(0,50))||"(无解析)"}),e}catch(i){return _e.debug("[QuestionBankStudyInterface] 选择题解析失败:",i),null}return null});async function G(){var e,t,n,a,c,d;$n(g,!0);try{if(!r().questionBankStorage)throw new Error("QuestionBankStorage not initialized");$n(u,new Dke(r().questionBankStorage),!0),$n(h,await bi(u).startSession({bankId:i(),mode:o(),shuffleQuestions:null!=(t=null==(e=l())?void 0:e.shuffleQuestions)&&t,shuffleOptions:null!=(a=null==(n=l())?void 0:n.shuffleOptions)&&a,questionCount:null==(c=l())?void 0:c.questionCount,timeLimit:null==(d=l())?void 0:d.timeLimit},s()),!0),$n(p,bi(u).getCurrentQuestion(),!0),F=window.setInterval(()=>{Ln(N)},1e3),function(){var e,t;"exam"!==(null==(e=bi(h))?void 0:e.mode)&&"quiz"!==(null==(t=bi(h))?void 0:t.mode)||($n(j,Date.now(),!0),$n(U,bi(B),!0))}()}catch(v){H(v,"初始化测试","启动测试失败")}finally{$n(g,!1)}}async function Q(){var e,t,n,i,a;if(bi(u)&&bi(p)&&!bi(f)&&bi(v))try{const r=await bi(u).submitAnswer({questionId:bi(p).questionId,answer:bi(v),timeSpent:bi(N)});$n(f,!0),bi(p)&&(bi(p).isCorrect=r.isCorrect,bi(p).userAnswer=bi(v),bi(p).submittedAt=(new Date).toISOString(),$n(p,{...bi(p)},!0)),$n(h,bi(u).getCurrentSession(),!0),_e.debug("[QuestionBankStudyInterface] 提交答案后:",{hasSubmitted:bi(f),hasExplanation:!!(null==(e=bi(W))?void 0:e.explanation),explanationLength:(null==(n=null==(t=bi(W))?void 0:t.explanation)?void 0:n.length)||0,isCorrect:null==(i=bi(p))?void 0:i.isCorrect,explanationContent:null==(a=bi(W))?void 0:a.explanation})}catch(r){H(r,"提交答案")}}async function K(){if(!bi(u))return;await bi(u).moveToNextQuestion()?($n(p,await bi(u).getCurrentQuestionWithRefresh(),!0),$n(v,null),$n(f,!1),$n(N,0),$n(h,bi(u).getCurrentSession(),!0)):await Z()}async function Z(){if(bi(u))try{const e=await bi(u).completeSession();pe(),c()&&c()(e)}catch(e){H(e,"完成测试")}}async function Y(){var e,t,n;if(!bi(S)||!bi(p)||!bi(u))return;Ln(w);const i=null!=(t=null==(e=bi(h))?void 0:e.currentQuestionIndex)?t:0,a=null==(n=bi(h))?void 0:n.questions[i];if(a&&bi(h)){const e=a.isCorrect;a.userAnswer=null,a.isCorrect=null,a.timeSpent=0,a.submittedAt=null,!0===e?bi(h).correctCount=Math.max(0,bi(h).correctCount-1):!1===e&&(bi(h).wrongCount=Math.max(0,bi(h).wrongCount-1)),bi(h).completedQuestions=Math.max(0,bi(h).completedQuestions-1),bi(h).incorrectCount=bi(h).wrongCount;const t=bi(h).correctCount+bi(h).wrongCount;bi(h).score=t>0?bi(h).correctCount/t*100:0,bi(h).accuracy=t>0?bi(h).correctCount/t:0}$n(v,null),$n(f,!1)}async function X(){if(!bi(p))return;const e="#收藏",t=bi(p).question.tags||[];t.includes(e)?(bi(p).question.tags=t.filter(t=>t!==e),new ge.Notice("已取消收藏")):(bi(p).question.tags=[...t,e],new ge.Notice("已收藏"));try{await r().dataStorage.saveCard(bi(p).question),$n(p,{...bi(p)},!0)}catch(n){H(n,"保存收藏状态","保存失败")}}async function J(){bi(p)?bi(x)?await ee():await async function(){$n(C,!1),$n(x,!0),await yi()}():_e.warn("[QuestionBankStudyInterface] No current question for editing")}async function ee(){if(!bi(_))return _e.error("[QuestionBankStudyInterface] Cannot save: editorPoolManager not available"),void $n(x,!1);try{const t=await async function(){if(!bi(_)||!bi(p))throw new Error("Editor or question not available");const e=bi(_).studySessionCardId,t=bi(p).question.uuid;return await bi(_).finishEditing(e,!0,{isStudySession:!0,targetCardId:t})}();t.success&&t.updatedCard?(new ge.Notice("卡片已保存"),await te(t.updatedCard)):H((e=t.error)||"未知错误","保存卡片（点击预览）","保存失败: "+(e||"未知错误"))}catch(e){!function(e){H(e,"保存卡片（点击预览）","保存失败")}(e)}var e}async function te(e){try{const n=await r().dataStorage.saveCard(e);if(!n.success)throw new Error(n.error||"保存失败");if(_e.debug("[QuestionBankStudyInterface] ✅ 卡片已保存到数据库:",e.uuid),bi(u)&&bi(h)){const t=bi(h).questions.findIndex(t=>t.questionId===e.uuid);-1!==t&&(bi(h).questions[t].question=e)}const i=s().findIndex(t=>t.uuid===e.uuid);if(-1!==i&&(s()[i]=e,s([...s()])),r().questionBankService)try{await r().questionBankService.updateQuestion(e.uuid,{content:e.content,modified:e.modified,metadata:e.metadata,tags:e.tags,priority:e.priority,stats:e.stats}),_e.debug("[QuestionBankStudyInterface] ✅ QuestionBankService 缓存已更新")}catch(t){_e.warn("[QuestionBankStudyInterface] 更新 QuestionBankService 缓存失败:",t)}bi(p)&&$n(p,{...bi(p),question:e},!0)}catch(t){return _e.error("[QuestionBankStudyInterface] ❌ 保存卡片到数据库失败:",t),void new ge.Notice("❌ 保存失败: "+(t instanceof Error?t.message:"未知错误"))}$n(x,!1),$n(C,!1),$n(I,!1)}function ne(){$n(x,!1),$n(C,!1),$n(I,!1)}function ie(){$n(I,!bi(I))}async function ae(e=!1){if(bi(p)){if(!e&&!bi(M)){const e=bi(p).question.content.slice(0,30)||`ID: ${bi(p).question.uuid}`;return $n(D,!0),void $n(T,e,!0)}try{const e=bi(p).question.uuid;if(!r().questionBankService)return void new ge.Notice("题库服务未初始化");if(await r().questionBankService.deleteQuestion(e),bi(x)&&($n(x,!1),$n(C,!1),$n(I,!1)),bi(u)&&bi(p)){if(s(s().filter(t=>t.uuid!==e)),0===s().length)return new ge.Notice("已删除所有题目，测试结束"),void(await Z());await K(),new ge.Notice("卡片已删除")}}catch(t){H(t,"删除卡片")}}}function re(){bi(p)&&($n(E,bi(p).question.priority||2,!0),$n(A,!0))}function se(){bi(p)&&$n(L,!0)}function oe(e){$n(z,e,!0),new ge.Notice(`题目学习顺序已切换为"${"sequential"===e?"顺序学习":"随机学习"}"，将在下次开始学习时生效`,3e3)}function le(e){$n(P,e,!0),new ge.Notice(`导航栏已切换为${1===e?"单列":"三列"}显示`)}function ce(e){$n($,e,!0),"fixed"===e?($n(R,!0),new ge.Notice("侧边栏已切换为固定紧凑模式（仅显示图标）")):($n(R,!1),new ge.Notice("侧边栏已切换为自动调整模式"))}async function de(){if(bi(x)&&bi(_)){if(!confirm("检测到正在编辑，是否保存并退出？"))return;try{await ee(),_e.debug("[QuestionBankStudyInterface] 已保存编辑内容")}catch(e){return _e.error("[QuestionBankStudyInterface] 保存编辑内容失败:",e),void new ge.Notice("保存失败，退出已取消")}}confirm("确定要退出测试吗？当前进度将被保存。")&&(bi(u)&&await bi(u).cancelSession(),pe(),d()&&d()())}async function ue(e){var t,n;if(bi(u))try{await bi(u).jumpToQuestion(e),$n(p,await bi(u).getCurrentQuestionWithRefresh(),!0),bi(p)?($n(v,bi(p).userAnswer||null,!0),$n(f,null!==bi(p).isCorrect&&void 0!==bi(p).isCorrect,!0)):($n(v,null),$n(f,!1)),$n(h,bi(u).getCurrentSession(),!0),_e.debug("[QuestionBankStudyInterface] 跳转到题目:",{index:e,hasSubmitted:bi(f),isCorrect:null==(t=bi(p))?void 0:t.isCorrect,userAnswer:null==(n=bi(p))?void 0:n.userAnswer})}catch(i){H(i,"跳转题目","跳转失败")}}function he(){$n(V,!bi(V))}function pe(){F&&(window.clearInterval(F),F=null)}function ve(e){var t,n,i;return void 0!==(null==(t=bi(W))?void 0:t.isMultipleChoice)?bi(W).isMultipleChoice:"multiple_choice"===(null==(i=null==(n=e.metadata)?void 0:n.questionMetadata)?void 0:i.type)}function fe(e){bi(f)||$n(v,e,!0)}function me(e){if(bi(f))return;Array.isArray(bi(v))||$n(v,[],!0);const t=bi(v).indexOf(e);$n(v,t>-1?bi(v).filter(t=>t!==e):[...bi(v),e],!0)}Ti(()=>{var e,t;if(("exam"===(null==(e=bi(h))?void 0:e.mode)||"quiz"===(null==(t=bi(h))?void 0:t.mode))&&bi(j)>0&&!bi(V)){const e=setInterval(()=>{const e=Date.now()-bi(j);$n(U,Math.max(0,bi(B)-e),!0),0===bi(U)&&Z()},100);return()=>clearInterval(e)}});const ye=In(()=>()=>{var e;return(null==(e=bi(u))?void 0:e.getProgress())||{current:1,total:s().length,percentage:0,answered:0,unanswered:s().length}}),be=In(()=>()=>bi(h)&&0!==bi(h).completedQuestions?bi(N)/bi(h).completedQuestions*1e3:0);function we(){bi(p)&&$n(O,!0)}Pr(async()=>{G();try{const{EmbeddableEditorManager:e}=await Promise.resolve().then(()=>Xk);$n(_,new e(r().app),!0)}catch(e){H(e,"初始化编辑器管理器"),$n(C,!0)}}),Rr(()=>{pe()});var ke={get bankId(){return i()},set bankId(e){i(e),hn()},get bankName(){return a()},set bankName(e="题库测试"){a(e),hn()},get plugin(){return r()},set plugin(e){r(e),hn()},get questions(){return s()},set questions(e){s(e),hn()},get mode(){return o()},set mode(e="practice"){o(e),hn()},get config(){return l()},set config(e){l(e),hn()},get onComplete(){return c()},set onComplete(e){c(e),hn()},get onExit(){return d()},set onExit(e){d(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},Se=Uxe(),xe=Qt(Se),Ce=Gt(xe),Ie=Gt(Ce),De=e=>{pa(e,mxe())},Te=e=>{var t=ha(),n=Qt(t),i=e=>{var t=Axe(),n=Qt(t);$ke(n,{get bankName(){return a()},get currentIndex(){return bi(ye)().current},get totalQuestions(){return bi(ye)().total},get statsCollapsed(){return bi(m)},get showSidebar(){return bi(y)},get showNavigator(){return bi(b)},onToggleStats:()=>$n(m,!bi(m)),onToggleSidebar:()=>$n(y,!bi(y)),onToggleNavigator:()=>$n(b,!bi(b)),onClose:de,get mode(){return bi(h).mode},get remainingTime(){return bi(U)},get isPaused(){return bi(V)},get isTimeWarning(){return bi(q)},onTogglePause:he});var i=Kt(n,2);let s;var o=Gt(i),l=e=>{var t=yxe(),n=Gt(t);{let e=In(()=>{var e;return(null==(e=bi(u))?void 0:e.getCurrentIndex())||0});zSe(n,{get questions(){return bi(h).questions},get currentIndex(){return bi(e)},onJumpToQuestion:ue,get columnMode(){return bi(P)}})}zt(t),pa(e,t)};xa(o,e=>{bi(b)&&bi(h)&&e(l)});var c=Kt(o,2),d=Gt(c),g=e=>{Lke(e,{get session(){return bi(h)},get currentQuestion(){return bi(p)}})};xa(d,e=>{bi(m)||e(g)});var D=Kt(d,2),T=Gt(D),A=Gt(T),E=e=>{vxe(e,{get importance(){return bi(p).question.priority},sticky:!0})};xa(A,e=>{var t,n;(null==(n=null==(t=bi(p))?void 0:t.question)?void 0:n.priority)&&e(E)});var O=Kt(A,2),L=e=>{I8(e,{get card(){return bi(p).question},get realCardId(){return bi(p).question.uuid},get showEditModal(){return bi(x)},get tempFileUnavailable(){return bi(C)},get isClozeMode(){return bi(I)},get editorPoolManager(){return bi(_)},get dataStorage(){return r().dataStorage},modalRef:null,statsCollapsed:!1,onEditComplete:te,onEditCancel:ne,onToggleCloze:ie})},F=e=>{var t=Ixe(),n=Gt(t),i=Gt(n),a=Gt(i),s=e=>{var t=bxe(),n=Gt(t,!0);zt(t),zi(()=>{var e;Fa(t,1,`difficulty-badge ${null!=(e=bi(p).question.difficulty)?e:""}`,"svelte-1jb1ynk"),va(n,"easy"===bi(p).question.difficulty?"简单":"medium"===bi(p).question.difficulty?"中等":"困难")}),pa(e,t)};xa(a,e=>{bi(p).question.difficulty&&e(s)});var o=Kt(a,2),l=e=>{pa(e,wxe())},c=e=>{pa(e,kxe())};xa(o,e=>{ve(bi(p).question)?e(l):e(c,!1)}),zt(i);var d=Kt(i,2),u=Gt(d,!0);zt(d),zt(n);var h=Kt(n,2),g=Gt(h),m=e=>{var t=ha();Ca(Qt(t),17,()=>bi(W).options,_a,(e,t)=>{const n=In(()=>ve(bi(p).question)),i=In(()=>bi(n)?Array.isArray(bi(v))&&bi(v).includes(bi(t).label):bi(v)===bi(t).label),a=In(()=>bi(t).isCorrect),s=In(()=>bi(f)&&bi(a)&&bi(i)),o=In(()=>bi(f)&&(bi(a)&&!bi(i)||!bi(a)&&bi(i))),l=In(()=>bi(f)?bi(a)&&bi(i)?"你选对了":!bi(a)&&bi(i)?"你选错了":bi(a)&&!bi(i)?"漏选":"":""),c=In(()=>bi(f)?bi(a)&&bi(i)?"check":!bi(a)&&bi(i)?"x":bi(a)&&!bi(i)?"alert-circle":"":"");{let a=In(()=>bi(p).question.sourceFile||"");L7(e,{get option(){return bi(t)},get isSelected(){return bi(i)},get isCorrect(){return bi(s)},get isWrong(){return bi(o)},get disabled(){return bi(f)},get badgeText(){return bi(l)},get badgeIcon(){return bi(c)},get plugin(){return r()},get sourcePath(){return bi(a)},onclick:()=>bi(n)?me(bi(t).label):fe(bi(t).label)})}}),pa(e,t)},y=e=>{var t=ha();Ca(Qt(t),17,()=>function(e){const t=e.split("\n"),n=[];for(const i of t){const e=i.match(/^([A-Z])[.、)]\s*(.+)$/);e&&n.push({id:e[1],text:e[2].trim()})}return n}(bi(p).question.content),_a,(e,t)=>{const n=In(()=>ve(bi(p).question)),i=In(()=>bi(n)?Array.isArray(bi(v))&&bi(v).includes(bi(t).id):bi(v)===bi(t).id),a=In(()=>bi(f)&&(Array.isArray(bi(p).correctAnswer)?bi(p).correctAnswer.includes(bi(t).id):bi(p).correctAnswer===bi(t).id)),r=In(()=>bi(a)&&bi(i)),s=In(()=>bi(f)&&(bi(a)&&!bi(i)||!bi(a)&&bi(i))),o=In(()=>bi(f)?bi(a)&&bi(i)?"你选对了":!bi(a)&&bi(i)?"你选错了":bi(a)&&!bi(i)?"漏选":"":""),l=In(()=>bi(f)?bi(a)&&bi(i)?"check":!bi(a)&&bi(i)?"x":bi(a)&&!bi(i)?"alert-circle":"":"");var c=_xe();let d;c.__click=[Sxe,n,me,t,fe];var u=Gt(c),h=Gt(u,!0);zt(u);var g=Kt(u,2),m=Gt(g,!0);zt(g);var y=Kt(g,2),b=e=>{var t=xxe();let n;var i=Gt(t),a=e=>{m5(e,{get name(){return bi(l)},size:16})};xa(i,e=>{bi(l)&&e(a)});var c=Kt(i,2),d=Gt(c,!0);zt(c),zt(t),zi(e=>{n=Fa(t,1,"option-badge svelte-1jb1ynk",null,n,e),va(d,bi(o))},[()=>({correct:bi(r),wrong:bi(s)})]),pa(e,t)};xa(y,e=>{bi(f)&&bi(o)&&e(b)}),zt(c),zi(e=>{d=Fa(c,1,"option-button svelte-1jb1ynk",null,d,e),c.disabled=bi(f),va(h,bi(t).id),va(m,bi(t).text)},[()=>({selected:bi(i),correct:bi(r)&&bi(f),wrong:bi(s),disabled:bi(f)})]),pa(e,c)}),pa(e,t)};xa(g,e=>{bi(W)?e(m):e(y,!1)}),zt(h);var b=Kt(h,2),w=e=>{var t=Cxe(),n=Gt(t);Ng(Gt(n),{name:"lightbulb",size:"18"}),Pt(2),zt(n);var i=Kt(n,2),a=Gt(i);{let e=In(()=>bi(p).question.sourceFile||"");N6(a,{get plugin(){return r()},get content(){return bi(W).explanation},get sourcePath(){return bi(e)}})}zt(i),zt(t),pa(e,t)};xa(b,e=>{var t;bi(f)&&(null==(t=bi(W))?void 0:t.explanation)&&e(w)}),zt(t),zi(e=>va(u,e),[()=>function(e){const t=e.split("\n"),n=[];for(const i of t){if(/^[A-Z][.、)]/.test(i))break;n.push(i)}return n.join("\n").trim()}(bi(p).question.content)]),pa(e,t)};xa(O,e=>{bi(x)?e(L):e(F,!1)}),zt(T),zt(D),zt(c);var B=Kt(c,2),j=e=>{var t=Dxe(),n=Gt(t);{let e=In(()=>1e3*bi(N)),t=In(()=>bi(be)());_Se(n,{get card(){return bi(p).question},get currentCardTime(){return bi(e)},get averageTime(){return bi(t)},get navColumnMode(){return bi(P)},onNavColumnModeChange:le,get questionOrder(){return bi(z)},onQuestionOrderChange:oe,get compactMode(){return bi(R)},get compactModeSetting(){return bi($)},onCompactModeSettingChange:ce,get plugin(){return r()},onToggleEdit:J,get isEditing(){return bi(x)},onDelete:ae,onToggleFavorite:X,onChangePriority:re,get enableDirectDelete(){return bi(M)},onDirectDeleteToggle:e=>$n(M,e,!0),onOpenPlainEditor:()=>{},onOpenDetailedView:se,onOpenCardDebug:we})}zt(t),pa(e,t)};xa(B,e=>{bi(y)&&e(j)});var H=Kt(B,2),G=Gt(H),Z=Gt(G),ee=Gt(Z);ee.__click=[Txe,b];var pe=Gt(ee);{let e=In(()=>bi(b)?"panel-left-close":"panel-left-open");Ng(pe,{get name(){return bi(e)},size:20})}zt(ee);var ge=Kt(ee,2);ge.__click=Y;var ke=Gt(ge);Ng(ke,{name:"undo",size:20});var Se=Kt(ke,2),xe=e=>{var t=Mxe(),n=Gt(t,!0);zt(t),zi(()=>va(n,bi(k)-bi(w))),pa(e,t)};xa(Se,e=>{bi(k)>0&&bi(k)-bi(w)>0&&e(xe)}),zt(ge),zt(Z);var _e=Kt(Z,2),Ce=Gt(_e);{let e=In(()=>!!bi(v)&&(!Array.isArray(bi(v))||bi(v).length>0)),t=In(()=>bi(ye)().current===bi(ye)().total);Vke(Ce,{get hasSubmitted(){return bi(f)},get hasAnswer(){return bi(e)},get isLastQuestion(){return bi(t)},onSubmit:Q,onNext:K})}zt(_e),zt(G),zt(H),zt(i),zi(e=>{s=Fa(i,1,"study-content svelte-1jb1ynk",null,s,e),er(ee,"title",bi(b)?"隐藏题目导航":"显示题目导航"),ge.disabled=!bi(S),er(ge,"title",bi(S)?`撤销答案 (剩余${bi(k)-bi(w)}次)`:"无法撤销")},[()=>({"with-navigator":bi(b),"with-sidebar":bi(y)})]),pa(e,t)};xa(n,e=>{bi(h)&&bi(p)&&e(i)},!0),pa(e,t)};xa(Ie,e=>{bi(g)?e(De):e(Te,!1)}),zt(Ce),zt(xe);var Me=Kt(xe,2),Ae=e=>{var t=jxe();t.__click=[Exe,A],t.__keydown=[zxe,A];var n=Gt(t);n.__click=[Pxe],n.__keydown=[Rxe,A];var i=Gt(n);Kt(Gt(i),2).__click=[$xe,A],zt(i);var a=Kt(i,2),s=Kt(Gt(a),2),o=Gt(s);let l;o.__click=[Oxe,E];var c=Kt(o,2);let d;c.__click=[Lxe,E];var u=Kt(c,2);let h;u.__click=[Nxe,E];var g=Kt(u,2);let v;g.__click=[Fxe,E],zt(s),zt(a);var f=Kt(a,2),m=Gt(f);m.__click=[Bxe,A],Kt(m,2).__click=[fxe,p,E,r,A,H],zt(f),zt(n),zt(t),zi((e,t,n,i)=>{l=Fa(o,1,"priority-btn-item priority-low svelte-1jb1ynk",null,l,e),d=Fa(c,1,"priority-btn-item priority-medium svelte-1jb1ynk",null,d,t),h=Fa(u,1,"priority-btn-item priority-high svelte-1jb1ynk",null,h,n),v=Fa(g,1,"priority-btn-item priority-urgent svelte-1jb1ynk",null,v,i)},[()=>({selected:1===bi(E)}),()=>({selected:2===bi(E)}),()=>({selected:3===bi(E)}),()=>({selected:4===bi(E)})]),pa(e,t)};xa(Me,e=>{bi(A)&&e(Ae)});var Ee=Kt(Me,2),ze=e=>{gee(e,{get card(){return bi(p).question},onClose:()=>$n(O,!1)})};xa(Ee,e=>{bi(p)&&bi(O)&&e(ze)});var Pe=Kt(Ee,2),Re=e=>{uxe(e,{get open(){return bi(L)},get card(){return bi(p).question},get plugin(){return r()},onClose:()=>$n(L,!1)})};return xa(Pe,e=>{bi(p)&&bi(L)&&e(Re)}),pa(e,Se),St(ke)}ia(["click","keydown"]);var qxe=la('<div class="trend-chart svelte-1cxvskp"></div>');function Hxe(e,t){if(new.target)return Er({component:Hxe,...e});kt(t,!0);let n,i=Ar(t,"history",7),a=Ar(t,"currentMetric",7),r=null;function s(){if(!r||0===i().length)return;const e=Kae(),t="accuracy"===a(),n=t?"#10b981":"#8b5cf6",s=t?"正确率":"测试分数",o={tooltip:{trigger:"axis",backgroundColor:e.background,borderColor:e.border,borderWidth:1,textStyle:{color:e.text},padding:[12,16],extraCssText:"box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px;",formatter:t=>{const n=i()[t[0].dataIndex];return`\n            <div style="font-weight: 600; margin-bottom: 8px;">\n              第${t[0].dataIndex+1}次测试 (${n.date})\n            </div>\n            <div style="margin: 4px 0;">\n              <span style="color: ${e.textMuted};">正确率:</span>\n              <span style="font-weight: 600; margin-left: 8px;">${n.accuracy.toFixed(1)}%</span>\n            </div>\n            <div style="margin: 4px 0;">\n              <span style="color: ${e.textMuted};">分数:</span>\n              <span style="font-weight: 600; margin-left: 8px;">${n.score.toFixed(1)}分</span>\n            </div>\n            <div style="margin: 4px 0;">\n              <span style="color: ${e.textMuted};">用时:</span>\n              <span style="font-weight: 600; margin-left: 8px;">${function(e){const t=Math.floor(e/60),n=e%60;return 0===t?`${n}秒`:`${t}分${n}秒`}(n.timeSpent)}</span>\n            </div>\n          `}},grid:{left:"3%",right:"4%",bottom:"3%",top:"10%",containLabel:!0},xAxis:{type:"category",data:i().map(e=>e.date),axisLine:{lineStyle:{color:e.border}},axisLabel:{color:e.textMuted,fontSize:11,interval:"auto"},splitLine:{show:!1}},yAxis:{type:"value",name:s,min:0,max:100,axisLine:{lineStyle:{color:e.border}},axisLabel:{color:e.textMuted,fontSize:11,formatter:"{value}"+(t?"%":"分")},splitLine:{lineStyle:{color:e.border,type:"dashed",opacity:.3}}},series:[{name:s,type:"line",data:i().map(e=>t?e.accuracy:e.score),smooth:!0,lineStyle:{color:n,width:2.5},itemStyle:{color:n,borderWidth:2,borderColor:e.background},symbolSize:6,areaStyle:Zae(n,.3,.05),emphasis:{itemStyle:{shadowBlur:10,shadowColor:n,shadowOffsetY:0,scale:1.5}}}]};try{r.setOption(o,!0)}catch(l){_e.error("[TestTrendChart] 更新配置失败:",l)}}Ti(()=>{a(),r&&s()}),Pr(()=>{!function(){if(n)try{r=EQ.init(n),s()}catch(e){_e.error("[TestTrendChart] 初始化失败:",e)}}();const e=()=>null==r?void 0:r.resize();return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}),Rr(()=>{r&&(r.dispose(),r=null)});var o={get history(){return i()},set history(e){i(e),hn()},get currentMetric(){return a()},set currentMetric(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},l=qxe();return kr(l,e=>n=e,()=>n),pa(e,l),St(o)}var Wxe=la('<div class="empty-state svelte-xoguof"><div class="empty-icon svelte-xoguof"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div> <div class="empty-title svelte-xoguof">暂无历史数据</div> <div class="empty-text svelte-xoguof">完成更多测试后，这里将显示你的学习趋势</div></div>');function Gxe(e,t){if(new.target)return Er({component:Gxe,...e});kt(t,!0);var n={$set:xr,$on:(e,n)=>Sr(t,e,n)};return pa(e,Wxe()),St(n)}var Qxe=(e,t)=>{var n;return null==(n=t())?void 0:n()},Kxe=(e,t)=>{var n;"Enter"!==e.key&&" "!==e.key||null==(n=t())||n()},Zxe=e=>e.stopPropagation(),Yxe=e=>e.stopPropagation(),Xxe=(e,t)=>$n(t,"accuracy"),Jxe=(e,t)=>$n(t,"score"),e_e=la('<div class="loading-chart svelte-43ryzu">加载中...</div>'),t_e=(e,t)=>{var n;return null==(n=t())?void 0:n()},n_e=la('<div class="test-result-backdrop svelte-43ryzu" role="button" tabindex="0" aria-label="关闭结果窗口"><!> <div role="dialog" tabindex="-1" aria-labelledby="result-title" aria-modal="true"><div class="score-header-compact svelte-43ryzu"><div class="score-header-left svelte-43ryzu"><div class="score-badge svelte-43ryzu"><div class="score-ring svelte-43ryzu"><svg viewBox="0 0 100 100" class="svelte-43ryzu"><circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" opacity="0.2"></circle><circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" stroke-dasharray="283" transform="rotate(-90 50 50)" class="progress-ring svelte-43ryzu"></circle></svg> <div class="score-text svelte-43ryzu"><div class="score-letter svelte-43ryzu"> </div></div></div></div> <div class="grade-desc-text svelte-43ryzu"> </div></div> <div class="score-header-middle svelte-43ryzu"><h2 id="result-title" class="result-title-inline svelte-43ryzu"> </h2> <div class="dots-container-inline svelte-43ryzu"><!></div> <p class="result-subtitle-inline svelte-43ryzu"> </p></div> <div class="score-header-right svelte-43ryzu"><div class="score-display-large svelte-43ryzu"><span class="score-value svelte-43ryzu"> </span> <span class="score-label svelte-43ryzu">分</span></div></div></div> <div class="stats-section svelte-43ryzu"><div class="stats-title svelte-43ryzu">测试统计</div> <div class="stats-grid svelte-43ryzu"><div class="stat-item svelte-43ryzu"><div class="stat-label svelte-43ryzu">答对</div> <div class="stat-value svelte-43ryzu"> </div></div> <div class="stat-item svelte-43ryzu"><div class="stat-label svelte-43ryzu">用时</div> <div class="stat-value svelte-43ryzu"> </div></div> <div class="stat-item svelte-43ryzu"><div class="stat-label svelte-43ryzu">正确率</div> <div class="stat-value svelte-43ryzu"> </div></div></div></div> <div class="trend-section svelte-43ryzu"><div class="trend-header svelte-43ryzu"><div class="trend-title svelte-43ryzu">历史趋势</div> <div class="metric-toggle svelte-43ryzu"><button>正确率</button> <button>测试分数</button></div></div> <!></div> <div class="result-footer svelte-43ryzu"><button class="btn-close svelte-43ryzu">关闭</button></div></div></div>');function i_e(e,t){if(new.target)return Er({component:i_e,...e});kt(t,!0);let n=Ar(t,"session",7),i=Ar(t,"plugin",7),a=Ar(t,"soundEnabled",7,!0),r=Ar(t,"soundVolume",7,.5),s=Ar(t,"onBackToBank",7),o=Pn(Ot([])),l=Pn("accuracy"),c=Pn(!1);const d=In(()=>()=>Tke.scoreSession(n()));let u=Pn(!1);Pr(()=>{if(a()){Bre().play(r()).catch(e=>{_e.error("[TestResultView] 音效播放失败:",e)})}setTimeout(()=>{$n(u,!0)},300),async function(){var e;if(null==(e=n())?void 0:e.bankId){$n(c,!0);try{const e=i().questionBankStorage;if(!e)return void _e.warn("[TestResultView] QuestionBankStorage not available");const t=(await e.loadAllSessions()).filter(e=>e.bankId===n().bankId).sort((e,t)=>new Date(e.startTime).getTime()-new Date(t.startTime).getTime()).slice(-10);$n(o,t.map(e=>{const t=Tke.scoreSession(e),n=new Date(e.startTime).getTime(),i=new Date(n);return{sessionId:e.id,date:`${i.getMonth()+1}-${i.getDate()}`,timestamp:n,accuracy:t.accuracy,score:t.totalScore,timeSpent:e.duration||0,correctCount:t.correctCount,totalQuestions:t.totalQuestions}}),!0),_e.debug("[TestResultView] 加载历史数据成功:",bi(o).length,"条")}catch(t){_e.error("[TestResultView] 加载历史数据失败:",t),$n(o,[],!0)}finally{$n(c,!1)}}}();const e=e=>{var t;"Escape"!==e.key&&"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),null==(t=s())||t())};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}});var h={get session(){return n()},set session(e){n(e),hn()},get plugin(){return i()},set plugin(e){i(e),hn()},get soundEnabled(){return a()},set soundEnabled(e=!0){a(e),hn()},get soundVolume(){return r()},set soundVolume(e=.5){r(e),hn()},get onBackToBank(){return s()},set onBackToBank(e){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},p=n_e();p.__click=[Qxe,s],p.__keydown=[Kxe,s];var g=Gt(p);Rre(g,{});var v=Kt(g,2);let f;v.__click=[Zxe],v.__keydown=[Yxe];var m=Gt(v),y=Gt(m),b=Gt(y),w=Gt(b),k=Gt(w),S=Kt(Gt(k));zt(k);var x=Kt(k,2),_=Gt(x),C=Gt(_,!0);zt(_),zt(x),zt(w),zt(b);var I=Kt(b,2),D=Gt(I,!0);zt(I),zt(y);var T=Kt(y,2),M=Gt(T),A=Gt(M,!0);zt(M);var E=Kt(M,2);Lre(Gt(E),{}),zt(E);var z=Kt(E,2),P=Gt(z,!0);zt(z),zt(T);var R=Kt(T,2),$=Gt(R),O=Gt($),L=Gt(O,!0);zt(O),Pt(2),zt($),zt(R),zt(m);var N=Kt(m,2),F=Kt(Gt(N),2),B=Gt(F),j=Kt(Gt(B),2),U=Gt(j,!0);zt(j),zt(B);var V=Kt(B,2),q=Kt(Gt(V),2),H=Gt(q,!0);zt(q),zt(V);var W=Kt(V,2),G=Kt(Gt(W),2),Q=Gt(G);zt(G),zt(W),zt(F),zt(N);var K=Kt(N,2),Z=Gt(K),Y=Kt(Gt(Z),2),X=Gt(Y);let J;X.__click=[Xxe,l];var ee=Kt(X,2);let te;ee.__click=[Jxe,l],zt(Y),zt(Z);var ne=Kt(Z,2),ie=e=>{pa(e,e_e())},ae=e=>{var t=ha(),n=Qt(t),i=e=>{Hxe(e,{get history(){return bi(o)},get currentMetric(){return bi(l)}})},a=e=>{Gxe(e,{})};xa(n,e=>{bi(o).length>0?e(i):e(a,!1)},!0),pa(e,t)};xa(ne,e=>{bi(c)?e(ie):e(ae,!1)}),zt(K);var re=Kt(K,2);return Gt(re).__click=[t_e,s],zt(re),zt(v),zt(p),zi((e,t,n,i,a,r,s,o,l,c,d,u,h)=>{f=Fa(v,1,"test-result-card svelte-43ryzu",null,f,e),ja(b,`color: ${null!=t?t:""}`),er(S,"stroke-dashoffset",n),va(C,i),va(D,a),va(A,r),va(P,s),va(L,o),va(U,l),va(H,c),va(Q,`${null!=d?d:""}%`),J=Fa(X,1,"metric-btn svelte-43ryzu",null,J,u),te=Fa(ee,1,"metric-btn svelte-43ryzu",null,te,h)},[()=>({show:bi(u)}),()=>Tke.getGradeColor(bi(d)().grade),()=>283-283*bi(d)().accuracy/100,()=>bi(d)().grade,()=>Tke.getGradeDescription(bi(d)().grade),()=>({S:"完美通过！",A:"表现优秀",B:"表现良好",C:"基本掌握",D:"仍需努力",F:"继续加油"}[bi(d)().grade]||"测试完成"),()=>{return(e=bi(d)().totalScore)>=95?"全部答对，非常棒！":e>=80?"继续保持这个状态":e>=60?"还有提升空间":"多加练习会更好";var e},()=>bi(d)().totalScore.toFixed(1),()=>bi(d)().correctCount,()=>function(e){const t=Math.floor(e/60),n=Math.floor(e%60);return 0===t?`${n}秒`:t<60?`${t}分钟`:`${Math.floor(t/60)}小时${t%60}分钟`}(n().totalTimeSpent||0),()=>bi(d)().accuracy.toFixed(0),()=>({active:"accuracy"===bi(l)}),()=>({active:"score"===bi(l)})]),pa(e,p),St(h)}function a_e(e){try{const t=new Date(e),n=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0");return`${n}-${i}-${a} ${r}:${String(t.getMinutes()).padStart(2,"0")}`}catch(t){return _e.error("[ReceiptFormatter] 日期格式化失败:",t),"N/A"}}function r_e(e){if(e<60)return`${e}秒`;const t=Math.floor(e/60),n=Math.floor(e%60);if(t<60)return`${t}分${n}秒`;return`${Math.floor(t/60)}小时${t%60}分`}function s_e(e,t){if(0===t)return"N/A";return`${(e/t).toFixed(1)} s/card`}function o_e(e){return e>=97?"A+":e>=93?"A":e>=90?"A-":e>=87?"B+":e>=83?"B":e>=80?"B-":e>=77?"C+":e>=73?"C":e>=70?"C-":e>=67?"D+":e>=63?"D":e>=60?"D-":"F"}function l_e(e,t){if(e&&e.startsWith("#"))return e;try{const e=new Date(t),n=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return`#TEST-${n}${i}${a}-${r}${s}${String(e.getSeconds()).padStart(2,"0")}`}catch(n){return`#TEST-${Date.now()}`}}ia(["click","keydown"]);var c_e=la('<button class="close-button svelte-18vne12"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-18vne12"><line x1="18" y1="6" x2="6" y2="18" class="svelte-18vne12"></line><line x1="6" y1="6" x2="18" y2="18" class="svelte-18vne12"></line></svg></button>'),d_e=(e,t)=>t(e),u_e=(e,t,n)=>bi(t)&&n(e),h_e=(e,t)=>{e.preventDefault(),t(e.touches[0])},p_e=(e,t,n)=>{e.preventDefault(),bi(t)&&n(e.touches[0])},g_e=la('<div class="action-buttons visible svelte-18vne12"><button class="action-button primary svelte-18vne12">返回题库</button></div>'),v_e=la('<div class="receipt-modal active svelte-18vne12"><div class="modal-background svelte-18vne12" role="button" tabindex="0"></div> <div class="modal-content svelte-18vne12"><!> <div class="printer-container svelte-18vne12"><div><div class="printer-top svelte-18vne12"></div> <div class="printer-slot svelte-18vne12"><div class="slot-opening svelte-18vne12"></div></div></div> <div><div class="paper-content svelte-18vne12"><div class="receipt-header svelte-18vne12"><h1>TEST REPORT</h1> <div></div></div> <div class="info-section svelte-18vne12"><div><span class="info-label svelte-18vne12">Deck Name</span> <span class="info-value svelte-18vne12"> </span></div> <div><span class="info-label svelte-18vne12">Test Date</span> <span class="info-value svelte-18vne12"> </span></div> <div><span class="info-label svelte-18vne12">Duration</span> <span class="info-value svelte-18vne12"> </span></div></div> <div></div> <div class="performance-section svelte-18vne12"><div><span class="svelte-18vne12">Performance</span> <span class="svelte-18vne12">Score</span></div> <div></div> <div><span class="row-label svelte-18vne12">Correct</span> <span class="row-value svelte-18vne12"> </span></div> <div><span class="row-label svelte-18vne12">Wrong</span> <span class="row-value wrong svelte-18vne12"> </span></div> <div><span class="row-label svelte-18vne12">Skipped</span> <span class="row-value svelte-18vne12"> </span></div> <div></div> <div><span class="row-label svelte-18vne12">Accuracy</span> <span class="row-value svelte-18vne12"> </span></div> <div><span class="row-label svelte-18vne12">Avg Speed</span> <span class="row-value svelte-18vne12"> </span></div></div> <div><div><span class="svelte-18vne12">← 刮开查看评分</span></div> <div class="scratch-card-container svelte-18vne12"><div class="scratch-card-content svelte-18vne12"><div class="letter-grade svelte-18vne12"> </div> <div class="grade-percentage svelte-18vne12"> </div></div> <canvas class="scratch-canvas svelte-18vne12"></canvas></div> <div class="test-id svelte-18vne12"> </div></div></div> <div class="paper-edge svelte-18vne12"></div></div></div> <!></div></div>');function f_e(e,t){if(new.target)return Er({component:f_e,...e});kt(t,!0);let n=Ar(t,"session",7),i=Ar(t,"plugin",7),a=Ar(t,"onBackToBank",7);const r=In(()=>function(e){return{deckName:e.bankName,testDate:a_e(e.startTime),duration:r_e(e.duration),correct:e.correctCount,wrong:e.wrongCount,skipped:e.skippedCount,accuracy:`${(100*e.accuracy).toFixed(1)}%`,avgSpeed:s_e(e.duration,e.totalQuestions),letterGrade:o_e(100*e.accuracy),percentage:`${Math.round(100*e.accuracy)}%`,testId:l_e(e.id,e.startTime)}}(n()));let s,o=Pn(!1),l=Pn("init"),c=Pn(0),d=Pn(!1),u=Pn(!1),h=null,p=Pn(!1),g=Pn(!1),v=null;function f(e){return new Promise(t=>setTimeout(t,e))}function m(){if(v)try{const e=v,t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="square",t.frequency.value=800,n.gain.setValueAtTime(.03,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.03),t.start(e.currentTime),t.stop(e.currentTime+.03)}catch(e){}}async function y(){$n(o,!0),$n(l,"init"),function(){if(v)try{const e=v,t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="sine",t.frequency.setValueAtTime(200,e.currentTime),t.frequency.exponentialRampToValueAtTime(400,e.currentTime+.3),n.gain.setValueAtTime(.2,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}catch(e){_e.error("[ReceiptResultView] 播放初始化音失败:",e)}}(),await f(500),$n(l,"paper"),await f(1500),$n(l,"content");for(let e=0;e<=15;e++)$n(c,e,!0),e<15&&(m(),await f(80));await f(300),function(){var e;if(!s)return;if(h=s.getContext("2d"),!h)return;const t=null==(e=s.parentElement)?void 0:e.getBoundingClientRect();t&&(s.width=t.width,s.height=t.height);!function(){if(!h||!s)return;const e=h,t=s.width,n=s.height;e.fillStyle="#d8d8d8",e.fillRect(0,0,t,n);const i=2,a=4;e.fillStyle="#a0a0a0";for(let r=0;r<n;r+=a)for(let n=0;n<t;n+=a)Math.random()>.3&&e.fillRect(n,r,i,i);e.globalAlpha=.4;for(let r=0;r<100;r++){e.fillStyle=Math.random()>.5?"#666":"#999";const i=2*Math.random()+1;e.fillRect(Math.random()*t,Math.random()*n,i,i)}e.globalAlpha=1,e.fillStyle="#666",e.font="bold 60px monospace",e.textAlign="center",e.textBaseline="middle",e.fillText("?",t/2,n/2),e.font="12px monospace",e.fillStyle="#888",e.fillText("SCRATCH",t/2,n/2+40)}()}(),await f(500),$n(l,"complete"),$n(d,!0),$n(u,!0),$n(o,!1)}function b(e){bi(g)||($n(p,!0),w(e))}function w(e){if(!bi(p)||bi(g)||!s||!h)return;const t=s.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;h.globalCompositeOperation="destination-out",h.beginPath(),h.arc(n,i,30,0,2*Math.PI),h.fill(),Math.random()>.9&&function(){if(!s||!h)return;const e=h.getImageData(0,0,s.width,s.height).data;let t=0;for(let i=3;i<e.length;i+=4)e[i]<128&&t++;const n=s.width*s.height;t/n>.4&&!bi(g)&&($n(g,!0),$n(p,!1),s&&(s.style.opacity="0",s.style.transition="opacity 0.3s ease",setTimeout(()=>{s&&(s.style.display="none")},300)))}()}function k(){$n(p,!1)}function S(){var e;null==(e=a())||e()}function x(e){"Escape"!==e.key&&"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),S())}Pr(()=>{!function(){try{const e=window.AudioContext||window.webkitAudioContext;e&&(v=new e)}catch(e){_e.warn("[ReceiptResultView] 音效初始化失败:",e)}}(),y(),document.addEventListener("keydown",x)}),Rr(()=>{document.removeEventListener("keydown",x),v&&v.close()});var _={get session(){return n()},set session(e){n(e),hn()},get plugin(){return i()},set plugin(e){i(e),hn()},get onBackToBank(){return a()},set onBackToBank(e){a(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},C=v_e(),I=Gt(C);I.__click=S;var D=Kt(I,2),T=Gt(D),M=e=>{var t=c_e();t.__click=S,pa(e,t)};xa(T,e=>{bi(u)&&e(M)});var A=Kt(T,2),E=Gt(A);let z;var P=Kt(E,2);let R;var $=Gt(P),O=Gt($),L=Gt(O);let N;var F=Kt(L,2);let B;zt(O);var j=Kt(O,2),U=Gt(j);let V;var q=Kt(Gt(U),2),H=Gt(q,!0);zt(q),zt(U);var W=Kt(U,2);let G;var Q=Kt(Gt(W),2),K=Gt(Q,!0);zt(Q),zt(W);var Z=Kt(W,2);let Y;var X=Kt(Gt(Z),2),J=Gt(X,!0);zt(X),zt(Z),zt(j);var ee=Kt(j,2);let te;var ne=Kt(ee,2),ie=Gt(ne);let ae;var re=Kt(ie,2);let se;var oe=Kt(re,2);let le;var ce=Kt(Gt(oe),2),de=Gt(ce,!0);zt(ce),zt(oe);var ue=Kt(oe,2);let he;var pe=Kt(Gt(ue),2),ge=Gt(pe,!0);zt(pe),zt(ue);var ve=Kt(ue,2);let fe;var me=Kt(Gt(ve),2),ye=Gt(me,!0);zt(me),zt(ve);var be=Kt(ve,2);let we;var ke=Kt(be,2);let Se;var xe=Kt(Gt(ke),2),Ce=Gt(xe,!0);zt(xe),zt(ke);var Ie=Kt(ke,2);let De;var Te=Kt(Gt(Ie),2),Me=Gt(Te,!0);zt(Te),zt(Ie),zt(ne);var Ae=Kt(ne,2);let Ee;var ze=Gt(Ae);let Pe;var Re=Kt(ze,2),$e=Gt(Re),Oe=Gt($e),Le=Gt(Oe,!0);zt(Oe);var Ne=Kt(Oe,2),Fe=Gt(Ne,!0);zt(Ne),zt($e);var Be=Kt($e,2);Be.__mousedown=[d_e,b],Be.__mousemove=[u_e,p,w],Be.__mouseup=k,Be.__touchstart=[h_e,b],Be.__touchmove=[p_e,p,w],Be.__touchend=k,kr(Be,e=>s=e,()=>s),zt(Re);var je=Kt(Re,2),Ue=Gt(je,!0);zt(je),zt(Ae),zt($),Pt(2),zt(P),zt(A);var Ve=Kt(A,2),qe=e=>{var t=g_e();Gt(t).__click=S,zt(t),pa(e,t)};return xa(Ve,e=>{bi(d)&&e(qe)}),zt(D),zt(C),zi((e,t,n,i,a,s,o,l,c,d,u,h,p,g,v,f,m,y)=>{z=Fa(E,1,"printer-device svelte-18vne12",null,z,e),R=Fa(P,1,"receipt-paper svelte-18vne12",null,R,t),N=Fa(L,1,"receipt-title svelte-18vne12",null,N,n),B=Fa(F,1,"title-line svelte-18vne12",null,B,i),V=Fa(U,1,"info-row svelte-18vne12",null,V,a),va(H,bi(r).deckName),G=Fa(W,1,"info-row svelte-18vne12",null,G,s),va(K,bi(r).testDate),Y=Fa(Z,1,"info-row svelte-18vne12",null,Y,o),va(J,bi(r).duration),te=Fa(ee,1,"section-divider svelte-18vne12",null,te,l),ae=Fa(ie,1,"table-header svelte-18vne12",null,ae,c),se=Fa(re,1,"table-divider svelte-18vne12",null,se,d),le=Fa(oe,1,"table-row svelte-18vne12",null,le,u),va(de,bi(r).correct),he=Fa(ue,1,"table-row svelte-18vne12",null,he,h),va(ge,bi(r).wrong),fe=Fa(ve,1,"table-row svelte-18vne12",null,fe,p),va(ye,bi(r).skipped),we=Fa(be,1,"table-divider svelte-18vne12",null,we,g),Se=Fa(ke,1,"table-row highlight svelte-18vne12",null,Se,v),va(Ce,bi(r).accuracy),De=Fa(Ie,1,"table-row svelte-18vne12",null,De,f),va(Me,bi(r).avgSpeed),Ee=Fa(Ae,1,"scratch-card-section svelte-18vne12",null,Ee,m),Pe=Fa(ze,1,"scratch-card-hint svelte-18vne12",null,Pe,y),va(Le,bi(r).letterGrade),va(Fe,bi(r).percentage),va(Ue,bi(r).testId)},[()=>({shaking:"init"===bi(l)}),()=>({printing:"init"!==bi(l)}),()=>({printed:bi(c)>=1}),()=>({printed:bi(c)>=2}),()=>({printed:bi(c)>=3}),()=>({printed:bi(c)>=4}),()=>({printed:bi(c)>=5}),()=>({printed:bi(c)>=6}),()=>({printed:bi(c)>=7}),()=>({printed:bi(c)>=8}),()=>({printed:bi(c)>=9}),()=>({printed:bi(c)>=10}),()=>({printed:bi(c)>=11}),()=>({printed:bi(c)>=12}),()=>({printed:bi(c)>=13}),()=>({printed:bi(c)>=14}),()=>({printed:bi(c)>=15}),()=>({hidden:bi(g)})]),na("mouseleave",Be,k),pa(e,C),St(_)}ia(["click","mousedown","mousemove","mouseup","touchstart","touchmove","touchend"]);var m_e=la('<div class="question-bank-study-container svelte-4jc4p0"><!></div>');const y_e=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);let i=Ar(n,"plugin",7),a=Ar(n,"bankId",7),r=Ar(n,"bankName",7,"题库测试"),s=Ar(n,"questions",23,()=>[]),o=Ar(n,"mode",7,"practice"),l=Ar(n,"config",7),c=Ar(n,"onBack",7,()=>{}),d=Pn("studying"),u=Pn(null);const h=In(()=>{var e;return"quiz"===(null==(e=bi(u))?void 0:e.mode)});function p(e){_e.debug("[StudyContainer] 测试完成:",e),_e.debug("[StudyContainer] 测试模式:",e.mode),_e.debug("[StudyContainer] 是否使用发票风格:","quiz"===e.mode),$n(u,e,!0),$n(d,"result")}function g(){_e.debug("[StudyContainer] 返回题库"),c()()}Pr(()=>{_e.debug("[StudyContainer] 初始化:",{bankId:a(),bankName:r(),questionCount:s().length,mode:o()})});var v={get plugin(){return i()},set plugin(e){i(e),hn()},get bankId(){return a()},set bankId(e){a(e),hn()},get bankName(){return r()},set bankName(e="题库测试"){r(e),hn()},get questions(){return s()},set questions(e=[]){s(e),hn()},get mode(){return o()},set mode(e="practice"){o(e),hn()},get config(){return l()},set config(e){l(e),hn()},get onBack(){return c()},set onBack(e=()=>{}){c(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)},f=m_e(),m=Gt(f),y=e=>{Vxe(e,{get plugin(){return i()},get bankId(){return a()},get bankName(){return r()},get questions(){return s()},get mode(){return o()},get config(){return l()},onComplete:p,onExit:g})},b=e=>{var t=ha(),n=Qt(t),a=e=>{var t=ha(),n=Qt(t),a=e=>{f_e(e,{get plugin(){return i()},get session(){return bi(u)},onBackToBank:g})},r=e=>{i_e(e,{get plugin(){return i()},get session(){return bi(u)},soundEnabled:!0,soundVolume:.5,onBackToBank:g})};xa(n,e=>{bi(h)?e(a):e(r,!1)}),pa(e,t)};xa(n,e=>{"result"===bi(d)&&bi(u)&&e(a)},!0),pa(e,t)};return xa(m,e=>{"studying"===bi(d)?e(y):e(b,!1)}),zt(f),pa(t,f),St(v)}},Symbol.toStringTag,{value:"Module"}));class b_e{constructor(){oe(this,"converter"),this.converter=new ah}async processNewCard(e){if(_e.debug(`[ProgressiveClozeGateway] 处理新卡片: ${e.uuid}, type=${e.type}`),!e.content||!e.content.trim())return _e.debug("[ProgressiveClozeGateway] 卡片内容为空，跳过处理"),{converted:!1,cards:[e],originalCardId:e.uuid,conversionType:"none"};const t=this.converter.parseClozes(e.content);if(!t.isProgressive)return _e.debug(`[ProgressiveClozeGateway] 挖空数量=${t.totalClozes}，不需要转换`),1===t.totalClozes&&e.type!==Kr.Cloze?e.type=Kr.Cloze:0===t.totalClozes&&e.type===Kr.Cloze&&(e.type=Kr.Basic),{converted:!1,cards:[e],originalCardId:e.uuid,conversionType:"none"};_e.info(`[ProgressiveClozeGateway] 检测到${t.totalClozes}个挖空，转换为渐进式挖空`);try{const{parent:t,children:n}=this.converter.convert(e,{inheritFsrs:!1,keepParent:!0,createdAt:(new Date).toISOString()});return _e.info(`[ProgressiveClozeGateway] ✅ 转换成功: 1父 + ${n.length}子`),{converted:!0,cards:[t,...n],originalCardId:t.uuid,conversionType:"to-progressive"}}catch(n){return _e.error("[ProgressiveClozeGateway] ❌ 转换失败:",n),e.type=Kr.Cloze,{converted:!1,cards:[e],originalCardId:e.uuid,conversionType:"none"}}}async processBatch(e){const t=[];for(const n of e){const e=await this.processNewCard(n);t.push(...e.cards)}return _e.info(`[ProgressiveClozeGateway] 批量处理完成: ${e.length}张 → ${t.length}张`),t}detectContentChange(e,t){const n=this.converter.parseClozes(e.content||""),i=n.totalClozes,a=n.isProgressive,r=this.converter.parseClozes(t),s=r.totalClozes,o=r.isProgressive;return _e.debug(`[ProgressiveClozeGateway] 内容变化检测: 旧=${i}个挖空(progressive=${a}), 新=${s}个挖空(progressive=${o})`),!a&&o?{needsProcessing:!0,changeType:"to-progressive",oldClozeCount:i,newClozeCount:s,recommendation:"需要将卡片转换为渐进式挖空（1父 + N子）"}:a&&!o?{needsProcessing:!0,changeType:"to-simple",oldClozeCount:i,newClozeCount:s,recommendation:"需要删除子卡片，保留父卡片并转为普通挖空"}:a&&o&&i!==s?{needsProcessing:!0,changeType:"cloze-count-changed",oldClozeCount:i,newClozeCount:s,recommendation:"需要重新生成子卡片（删除旧的，创建新的）"}:a&&o&&i===s&&e.content!==t?{needsProcessing:!0,changeType:"content-only",oldClozeCount:i,newClozeCount:s,recommendation:"仅同步内容到子卡片，无需重建"}:{needsProcessing:!1,changeType:"none",oldClozeCount:i,newClozeCount:s}}async processContentChange(e,t,n){const i=this.detectContentChange(e,t);if(!i.needsProcessing)return _e.debug("[ProgressiveClozeGateway] 内容无需处理，直接返回"),[{...e,content:t}];switch(_e.info(`[ProgressiveClozeGateway] 处理内容变化: ${i.changeType}, ${i.recommendation}`),i.changeType){case"to-progressive":return await this.handleConvertToProgressive(e,t);case"to-simple":return await this.handleConvertToSimple(e,t,n);case"cloze-count-changed":return await this.handleClozeCountChanged(e,t,n);case"content-only":return await this.handleContentOnlyChange(e,t,n);default:return[{...e,content:t}]}}async handleConvertToProgressive(e,t){const n={...e,content:t};return(await this.processNewCard(n)).cards}async handleConvertToSimple(e,t,n){if(e.type===Kr.ProgressiveParent){_e.info("[ProgressiveClozeGateway] 检测到父卡片，查找子卡片...");const t=(await n.getDeckCards(e.deckId)).filter(t=>t.type===Kr.ProgressiveChild&&t.parentCardId===e.uuid);_e.info(`[ProgressiveClozeGateway] 找到${t.length}个子卡片，开始删除`);for(const e of t)await n.deleteCard(e.uuid)}const i={...e,type:Kr.Cloze,content:t,modified:(new Date).toISOString()};return delete i.progressiveCloze,[i]}async handleClozeCountChanged(e,t,n){if(e.type===Kr.ProgressiveParent){_e.info("[ProgressiveClozeGateway] 挖空数量变化，查找旧子卡片...");const t=(await n.getDeckCards(e.deckId)).filter(t=>t.type===Kr.ProgressiveChild&&t.parentCardId===e.uuid);_e.info(`[ProgressiveClozeGateway] 找到${t.length}个旧子卡片，开始删除`);for(const e of t)await n.deleteCard(e.uuid)}const i={...e,content:t};return(await this.processNewCard(i)).cards}async handleContentOnlyChange(e,t,n){_e.info("[ProgressiveClozeGateway] 内容变化（挖空数量不变），同步到子卡片");const i={...e,content:t,modified:(new Date).toISOString()};if(e.type===Kr.ProgressiveParent){const a=(await n.getDeckCards(e.deckId)).filter(t=>t.type===Kr.ProgressiveChild&&t.parentCardId===e.uuid);_e.info(`[ProgressiveClozeGateway] 找到${a.length}个子卡片，开始同步内容`);const r=[];for(const e of a){const i={...e,content:t,modified:(new Date).toISOString()};await n.saveCard(i),r.push(i),_e.debug(`[ProgressiveClozeGateway] ✓ 已同步子卡片: ${e.uuid} (clozeOrd: ${e.clozeOrd})`)}return _e.info(`[ProgressiveClozeGateway] ✅ 内容同步完成: ${r.length}个子卡片`),[i,...r]}return[i]}isProgressiveCloze(e){return this.converter.parseClozes(e).isProgressive}getClozeCount(e){return this.converter.parseClozes(e).totalClozes}}let w_e=null;const k_e=Object.freeze(Object.defineProperty({__proto__:null,ProgressiveClozeGateway:b_e,getProgressiveClozeGateway:function(){return w_e||(w_e=new b_e),w_e}},Symbol.toStringTag,{value:"Module"})),S_e={enabled:!0,minSpacing:5,spacingPercentage:.05,filterInQueue:!0,autoAdjustAfterReview:!0,respectFuzzRange:!0};class x_e{constructor(e={}){oe(this,"config"),this.config={...S_e,...e}}updateConfig(e){this.config={...this.config,...e}}async adjustSiblingsAfterReview(e,t){if(!this.config.enabled||!this.config.autoAdjustAfterReview)return 0;if(e.type!==Kr.ProgressiveChild)return 0;const n=e;try{const e=await this.getSiblingCards(n,t);if(0===e.length)return 0;const i=this.calculateDisperseInterval(n);_e.debug(`[SiblingDispersion] 检查卡片 ${n.uuid.slice(0,8)} (cloze ${n.clozeOrd}) 的 ${e.length} 个兄弟卡片，分散间隔: ${i}天`);let a=0;const r=new Date(n.fsrs.due);for(const n of e){if(!n.fsrs)continue;const e=new Date(n.fsrs.due);if(Math.abs(this.daysBetween(r,e))<i){await this.adjustSiblingDue(n,r,i,t)&&a++}}return a>0&&_e.info(`[SiblingDispersion] ✅ 调整完成: ${a}/${e.length} 个兄弟卡片`),a}catch(i){return _e.error("[SiblingDispersion] 调整兄弟卡片失败:",i),0}}async getSiblingCards(e,t){if(e.type!==Kr.ProgressiveChild)return[];const n=e;return(await t.getAllCards()).filter(t=>t.type===Kr.ProgressiveChild&&t.parentCardId===n.parentCardId&&t.uuid!==e.uuid)}calculateDisperseInterval(e){if(!e.fsrs)return this.config.minSpacing;const t=Math.round(e.fsrs.scheduledDays*this.config.spacingPercentage);return Math.max(this.config.minSpacing,t)}async adjustSiblingDue(e,t,n,i){if(!e.fsrs)return!1;const a=new Date(e.fsrs.due),r=this.daysBetween(t,a);let s;if(!(Math.abs(r)<n))return!1;s=new Date(t),s.setDate(s.getDate()+n),_e.debug(`[SiblingDispersion] 调整卡片 ${e.uuid.slice(0,8)} (cloze ${e.clozeOrd}): ${a.toISOString().split("T")[0]} → ${s.toISOString().split("T")[0]} (+${n}天)`);const o={...e.fsrs,due:s.toISOString()},l={...e,fsrs:o,modified:(new Date).toISOString()};return await i.saveCard(l),!0}daysBetween(e,t){const n=t.getTime()-e.getTime();return Math.round(n/864e5)}async findDispersedDue(e,t,n){var i;if(!this.config.enabled||!this.config.respectFuzzRange)return t;if(!n||0===n.length)return t;if(e.type!==Kr.ProgressiveChild)return t;try{const a=this.calculateFuzzRange((null==(i=e.fsrs)?void 0:i.scheduledDays)||0),r=this.calculateDisperseInterval(e),s=n.filter(e=>!!e.fsrs).map(e=>new Date(e.fsrs.due));if(0===s.length)return t;const o=[],l=Math.min(...s.map(e=>Math.abs(this.daysBetween(t,e))));o.push({date:t,offset:0,minDistance:l});for(let e=1;e<=a;e++){const n=new Date(t);n.setDate(n.getDate()+e);const i=Math.min(...s.map(e=>Math.abs(this.daysBetween(n,e))));o.push({date:n,offset:e,minDistance:i});const a=new Date(t);a.setDate(a.getDate()-e);const r=Math.min(...s.map(e=>Math.abs(this.daysBetween(a,e))));o.push({date:a,offset:-e,minDistance:r})}const c=o.filter(e=>e.minDistance>=r);let d;return d=c.length>0?c.reduce((e,t)=>Math.abs(t.offset)<Math.abs(e.offset)?t:e):o.reduce((e,t)=>t.minDistance>e.minDistance?t:e),0!==d.offset&&_e.debug(`[SiblingDispersion P3] 调整due日期: ${t.toISOString().split("T")[0]} → ${d.date.toISOString().split("T")[0]} (偏移${d.offset}天, fuzz范围±${a}天, 最小间隔${d.minDistance}天)`),d.date}catch(a){return _e.error("[SiblingDispersion P3] 查找分散due失败:",a),t}}calculateFuzzRange(e){if(e<=0)return 1;const t=Math.max(1,Math.min(.05*e,.25*e));return Math.round(t)}}let __e=null;const C_e=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_SIBLING_DISPERSION_CONFIG:S_e,SiblingDispersionService:x_e,getSiblingDispersionService:function(){return __e||(__e=new x_e),__e}},Symbol.toStringTag,{value:"Module"})),I_e=class e{constructor(){oe(this,"uuidToCard",new Map),oe(this,"uuidToSources",new Map),oe(this,"plugin")}static getInstance(){return e.instance||(e.instance=new e),e.instance}injectDataStorage(e){}injectPlugin(e){this.plugin=e}async findCardByUUID(e){var t;if(this.uuidToCard.has(e))return this.uuidToCard.get(e);if(!(null==(t=this.plugin)?void 0:t.directFileReader))return _e.warn("DirectFileCardReader未初始化"),null;try{const t=await this.plugin.directFileReader.getCardByUUID(e);return t&&this.uuidToCard.set(e,t),t}catch(n){return _e.error("查询卡片失败:",n),null}}registerAnnotation(e,t){if(!e)return void _e.warn("尝试注册空UUID");this.uuidToSources.has(e)||this.uuidToSources.set(e,[]);const n=this.uuidToSources.get(e),i=n.findIndex(e=>e.filePath===t.filePath&&e.blockId===t.blockId);i>=0?n[i]=t:n.push(t)}findAnnotationsByUUID(e){return this.uuidToSources.get(e)||[]}unregisterAnnotation(e,t,n){const i=this.uuidToSources.get(e);if(!i)return;const a=i.filter(e=>!(e.filePath===t&&e.blockId===n));0===a.length?this.uuidToSources.delete(e):this.uuidToSources.set(e,a)}updateFilePath(e,t){for(const[n,i]of this.uuidToSources)for(const a of i)a.filePath===e&&(a.filePath=t)}updateCardCache(e){e.uuid&&this.uuidToCard.set(e.uuid,e)}removeCardFromCache(e){this.uuidToCard.has(e)&&this.uuidToCard.delete(e)}clearCache(){this.uuidToCard.clear(),this.uuidToSources.clear()}getStats(){const e=Array.from(this.uuidToSources.values()).reduce((e,t)=>e+t.length,0);return{cachedCards:this.uuidToCard.size,registeredUUIDs:this.uuidToSources.size,totalAnnotationSources:e}}};oe(I_e,"instance");let D_e=I_e;const T_e=Object.freeze(Object.defineProperty({__proto__:null,UUIDRegistry:D_e},Symbol.toStringTag,{value:"Module"})),M_e=class e{constructor(){oe(this,"dataStorage"),oe(this,"cardCreationBridge"),oe(this,"vault",null),oe(this,"plugin",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}initialize(e){this.dataStorage=e.dataStorage,this.cardCreationBridge=e.cardCreationBridge,this.vault=e.vault||null,this.plugin=e.plugin||null,_e.debug("✅ [SimpleSyncEngine] 初始化完成")}async smartSync(e){var t;if(!e.metadata.uuid)return void(await this.cardCreationBridge.createCardFromAnnotation(e));const n=await(null==(t=this.plugin)?void 0:t.directFileReader.getCardByUUID(e.metadata.uuid));if(!n)return _e.debug(`[SimpleSyncEngine] 检测到孤立标注块: ${e.metadata.uuid}`),void(await this.cleanupOrphanedAnnotation(e));await this.checkNeedsUpdate(e,n)&&await this.updateCard(n,e)}async checkNeedsUpdate(e,t){var n;if(e.cardContent!==t.content)return _e.debug("[SimpleSyncEngine] 内容已变化，需要更新"),!0;const i=null==(n=e.deckTemplate)?void 0:n.deckName;if(i){const e=await this.getDeckNameById(t.deckId);if(e!==i)return _e.debug(`[SimpleSyncEngine] 牌组变化: ${e} → ${i}`),!0}return!1}async updateCard(e,t){var n;e.deckId;let i=!1;e.content=t.cardContent,e.modified=(new Date).toISOString(),e.annotationSources||(e.annotationSources=[]);const a={filePath:t.position.filePath,blockId:t.metadata.blockId||"",lastSync:(new Date).toISOString(),lineRange:[t.position.startLine,t.position.endLine]},r=e.annotationSources.findIndex(e=>e.filePath===a.filePath&&e.blockId===a.blockId);r>=0?e.annotationSources[r]=a:e.annotationSources.push(a);const s=null==(n=t.deckTemplate)?void 0:n.deckName;if(s){const t=(await this.dataStorage.getAllDecks()).find(e=>e.name===s);if(t){if(t.id!==e.deckId){const n=await this.getDeckNameById(e.deckId);await this.dataStorage.deleteCard(e.uuid),e.deckId=t.id,i=!0,_e.debug(`[SimpleSyncEngine] 卡片已移动: ${n} → ${s}`),ih(`📦 卡片已移动到「${s}」`,"success")}}else _e.warn(`⚠️ [SimpleSyncEngine] 目标牌组不存在: ${s}`),ih(`⚠️ 牌组「${s}」不存在，请先创建`,"warning")}const o=await this.dataStorage.saveCard(e);o.success?(await this.updateOtherAnnotations(t),i||ih("✅ 卡片已同步","success")):(_e.error("[SimpleSyncEngine] 保存失败:",o.error),ih(`❌ 同步失败: ${o.error}`,"error"))}async updateOtherAnnotations(e){var t;if(!this.vault||!e.metadata.uuid)return;const n=await(null==(t=this.plugin)?void 0:t.directFileReader.getCardByUUID(e.metadata.uuid));if(n&&n.annotationSources&&!(n.annotationSources.length<=1))for(const a of n.annotationSources)if(a.filePath!==e.position.filePath||a.blockId!==e.metadata.blockId)try{await this.updateAnnotationBlock(a,e.cardContent)}catch(i){_e.error(`[SimpleSyncEngine] 更新标注块失败: ${a.filePath}`,i)}}async updateAnnotationBlock(e,t){if(!this.vault)throw new Error("Vault未初始化");const n=this.vault.getAbstractFileByPath(e.filePath);if(!(n&&n instanceof ge.TFile))return;const i=(await this.vault.read(n)).split("\n"),a=i.findIndex(t=>t.includes(`^${e.blockId}`));if(-1===a)return;let r=a;for(let c=a-1;c>=0;c--){if(i[c].match(/^>\s*\[!tuanki\]/)){r=c;break}if(!i[c].startsWith(">"))break}let s=a;for(let c=a-1;c>r;c--){const e=i[c].trim();if(">"!==e&&!e.match(/^>\s*(uuid|modified|created|version):/))break;s=c}const o=t.split("\n").map(e=>`> ${e}`),l=[...i.slice(0,r+1),...o,">",...i.slice(s,a+1),...i.slice(a+1)];await this.vault.modify(n,l.join("\n"))}async cleanupOrphanedAnnotation(e){try{_e.debug(`[SimpleSyncEngine] 清理孤立标注块: ${e.metadata.uuid}`),ih("🧹 已清理孤立标注块","info")}catch(t){_e.error("[SimpleSyncEngine] 清理孤立标注块失败",t),ih("❌ 清理标注块失败","error")}}async getDeckNameById(e){var t;try{const n=await this.dataStorage.getDeck(e);return null!=(t=null==n?void 0:n.name)?t:null}catch(n){return _e.error("❌ [SimpleSyncEngine] 获取牌组名失败:",n),null}}async findAnnotationBlockByUUID(e,t){try{if(!this.vault)return null;const n=this.vault.getAbstractFileByPath(e);if(!(n&&n instanceof ge.TFile))return null;const i=(await this.vault.read(n)).split("\n");for(let e=0;e<i.length;e++)if(i[e].includes(t)){const t=e;let n=e;for(let a=e+1;a<i.length;a++){if(""===i[a].trim()||i[a].startsWith("%%")){n=a;break}n=a}return{startLine:t,endLine:n,content:i.slice(t,n+1).join("\n")}}return null}catch(n){return _e.error("❌ [SimpleSyncEngine] 查找标注块失败:",n),null}}};oe(M_e,"instance");let A_e=M_e;const E_e=Object.freeze(Object.defineProperty({__proto__:null,SimpleSyncEngine:A_e},Symbol.toStringTag,{value:"Module"}));const z_e=Object.freeze(Object.defineProperty({__proto__:null,EnhancedDelimiterDetector:class{constructor(e="<->"){oe(this,"delimiter"),this.delimiter=e}isValidDelimiterLine(e,t,n){return e.trim()===this.delimiter&&(!this.isInCodeBlock(t,n)&&(!this.isInTable(t,n)&&(!this.isInMathBlock(t,n)&&!!this.hasContentAround(t,n))))}isInCodeBlock(e,t){let n=!1;for(let i=0;i<e;i++){const e=t[i].trim();(e.startsWith("```")||e.startsWith("~~~"))&&(n=!n)}return n}isInTable(e,t){const n=Math.max(0,e-3),i=Math.min(t.length-1,e+3);for(let a=n;a<=i;a++){const e=t[a].trim();if(e.includes("|")&&!e.startsWith("```")&&!e.startsWith("~~~"))return!0}return!1}isInMathBlock(e,t){let n=!1;for(let i=0;i<e;i++){const e=t[i].trim();(e.startsWith("$$")||e.startsWith("\\["))&&(n=!n),(e.endsWith("$$")||e.endsWith("\\]"))&&(n=!n)}return n}hasContentAround(e,t){let n=!1;for(let i=e-1;i>=0;i--){const e=t[i].trim();if(e.length>0&&e!==this.delimiter){n=!0;break}}return n}splitCardsRaw(e){_e.debug("[EnhancedDelimiterDetector] 🔍 开始分割卡片（Raw模式 - 保留所有块）"),_e.debug(`[EnhancedDelimiterDetector] 📄 输入内容长度: ${e.length} 字符`),_e.debug(`[EnhancedDelimiterDetector] 🔧 分隔符: "${this.delimiter}"`);const t=e.split("\n"),n=[];let i="",a=0;for(let r=0;r<t.length;r++){const e=t[r];if(this.isValidDelimiterLine(e,r,t)){if(a++,_e.debug(`[EnhancedDelimiterDetector] 🔶 发现第 ${a} 个分隔符（行 ${r+1}）`),i.trim().length>0){const e=i.endsWith("\n")?i.slice(0,-1):i;n.push(e),_e.debug(`[EnhancedDelimiterDetector]   ✅ 保存块 ${n.length}（${e.length} 字符）: ${e.substring(0,50).replace(/\n/g,"\\n")}...`)}else _e.debug("[EnhancedDelimiterDetector]   ⏭️  跳过空块");i=""}else i+=`${e}\n`}if(i.trim().length>0){const e=i.endsWith("\n")?i.slice(0,-1):i;n.push(e),_e.debug(`[EnhancedDelimiterDetector] ✅ 保存最后一个块 ${n.length}（${e.length} 字符）: ${e.substring(0,50).replace(/\n/g,"\\n")}...`)}return _e.debug(`[EnhancedDelimiterDetector] 📊 Raw模式统计：发现 ${a} 个分隔符，分割成 ${n.length} 个块（包括首尾）`),_e.debug(`[EnhancedDelimiterDetector] 📦 Raw模式结果：返回所有 ${n.length} 个块`),n}splitCardsEnhanced(e){var t,n;_e.debug("[EnhancedDelimiterDetector] 🔍 开始分割卡片（Enhanced模式 - 只返回有效卡片）");const i=this.splitCardsRaw(e);if(i.length<3)return _e.warn(`[EnhancedDelimiterDetector] ❌ 没有找到被完全包围的卡片（总块数: ${i.length}）`),_e.warn("[EnhancedDelimiterDetector] 💡 提示：卡片内容必须被两个 <-> 分隔符完全包围"),_e.warn("[EnhancedDelimiterDetector] 📝 正确格式示例："),_e.warn("[EnhancedDelimiterDetector]    <->"),_e.warn("[EnhancedDelimiterDetector]    卡片内容"),_e.warn("[EnhancedDelimiterDetector]    <->"),[];const a=i.slice(1,-1);return _e.debug(`[EnhancedDelimiterDetector] ✅ 应用"完全包围"规则：从 ${i.length} 个块中保留中间 ${a.length} 张卡片`),_e.debug(`[EnhancedDelimiterDetector] 🗑️  丢弃首块（长度: ${(null==(t=i[0])?void 0:t.length)||0}）和尾块（长度: ${(null==(n=i[i.length-1])?void 0:n.length)||0}）`),_e.debug(`[EnhancedDelimiterDetector] 📦 Enhanced模式最终结果：${a.length} 张有效卡片`),a}classifyBlocks(e){const t=[],n=[];if(0===e.length)return{cards:t,nonCards:n};if(1===e.length)n.push(e[0]);else if(2===e.length)n.push(e[0]),n.push(e[1]);else{n.push(e[0]);for(let n=1;n<e.length-1;n++)t.push(e[n]);n.push(e[e.length-1])}return _e.debug(`[EnhancedDelimiterDetector] 📊 块分类结果：总${e.length}块 → ${t.length}张卡片 + ${n.length}个非卡片块`),{cards:t,nonCards:n}}isValidCardContent(e,t=10){const n=e.trim();return n.length<t?(_e.warn(`[EnhancedDelimiterDetector] 卡片内容过短（${n.length}字符），建议至少${t}字符`),!1):!!/\S{5,}/.test(n)||(_e.warn("[EnhancedDelimiterDetector] 卡片缺少有效内容（非空白字符不足）"),!1)}static extractBatchRange(e,t,n){return e}}},Symbol.toStringTag,{value:"Module"}));class P_e{constructor(){oe(this,"categories",[]),oe(this,"storageKey","tuanki-deck-categories"),oe(this,"initialized",!1)}async initialize(){if(!this.initialized)try{const e=localStorage.getItem(this.storageKey);e?(this.categories=JSON.parse(e),_e.debug("[CategoryStorage] 已加载分类数据:",this.categories.length)):(this.categories=[...Zr],await this.save(),_e.debug("[CategoryStorage] 已初始化默认分类")),this.initialized=!0}catch(e){_e.error("[CategoryStorage] 初始化失败:",e),this.categories=[...Zr],this.initialized=!0}}async getCategories(){return this.initialized||await this.initialize(),[...this.categories].sort((e,t)=>e.order-t.order)}async getCategoryById(e){return this.initialized||await this.initialize(),this.categories.find(t=>t.id===e)||null}async createCategory(e){this.initialized||await this.initialize();const t={...e,id:`category_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,created:(new Date).toISOString(),modified:(new Date).toISOString()};return this.categories.push(t),await this.save(),_e.debug("[CategoryStorage] 已创建分类:",t.name),t}async updateCategory(e,t){this.initialized||await this.initialize();const n=this.categories.findIndex(t=>t.id===e);if(-1===n)throw new Error(`Category not found: ${e}`);this.categories[n]={...this.categories[n],...t,modified:(new Date).toISOString()},await this.save(),_e.debug("[CategoryStorage] 已更新分类:",this.categories[n].name)}async deleteCategory(e){this.initialized||await this.initialize();const t=this.categories.find(t=>t.id===e);if(!t)throw new Error(`Category not found: ${e}`);if(t.isDefault)throw new Error("Cannot delete default category");this.categories=this.categories.filter(t=>t.id!==e),await this.save(),_e.debug("[CategoryStorage] 已删除分类:",t.name)}async reorderCategories(e){this.initialized||await this.initialize(),e.forEach((e,t)=>{const n=this.categories.find(t=>t.id===e);n&&(n.order=t,n.modified=(new Date).toISOString())}),await this.save(),_e.debug("[CategoryStorage] 已重新排序分类")}async save(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.categories))}catch(e){throw _e.error("[CategoryStorage] 保存失败:",e),e}}async reset(){this.categories=[...Zr],await this.save(),_e.debug("[CategoryStorage] 已重置为默认分类")}}let R_e=null;const $_e=Object.freeze(Object.defineProperty({__proto__:null,CategoryStorage:P_e,getCategoryStorage:function(){return R_e||(R_e=new P_e),R_e}},Symbol.toStringTag,{value:"Module"}));const O_e=Object.freeze(Object.defineProperty({__proto__:null,DataMigrationService:class{constructor(e){oe(this,"app"),this.app=e}async migrate(){const e=Date.now();try{_e.info("🔄 [数据迁移] 开始检查是否需要迁移...");if(!(await this.checkMigrationNeeded()))return _e.info("✅ [数据迁移] 无需迁移，使用新数据路径"),{success:!0,migrated:!1,timestamp:(new Date).toISOString()};new ge.Notice("🔄 Tuanki: 正在迁移数据到新位置，请稍候...",5e3),_e.info("📍 [数据迁移] 开始迁移数据...");const t=await this.getLegacyDataPath();if(!t)throw new Error("未找到旧数据文件夹");_e.info(`ℹ️ [数据迁移] 源路径: ${t} → 目标路径: ${os}`);const n=await this.copyDataRecursively(t,os);await this.migrateMediaFolder(t);if(!(await this.validateMigration()))throw new Error("数据迁移验证失败");await this.recordMigration();const i=((Date.now()-e)/1e3).toFixed(2);return _e.info(`✅ [数据迁移] 迁移完成！共迁移 ${n} 个文件，耗时 ${i}s`),new ge.Notice(`✅ Tuanki: 数据迁移完成！已迁移 ${n} 个文件`,5e3),{success:!0,migrated:!0,filesCount:n,timestamp:(new Date).toISOString()}}catch(t){const e=t instanceof Error?t.message:String(t);return _e.error("❌ [数据迁移] 迁移失败:",t),new ge.Notice(`❌ Tuanki: 数据迁移失败 - ${e}`,8e3),{success:!1,migrated:!1,error:e,timestamp:(new Date).toISOString()}}}async getLegacyDataPath(){const e=this.app.vault.adapter;return await e.exists(cs)?(_e.info(`✅ [数据迁移] 检测到v0.9.x数据: ${cs}`),cs):await e.exists(ls)?(_e.info(`✅ [数据迁移] 检测到v0.8.x数据: ${ls}`),ls):(_e.debug("[数据迁移] 未检测到旧数据文件夹"),null)}async migrateMediaFolder(e){const t=this.app.vault.adapter;try{const e="tuanki/tuanki_media",n=`${os}/media`;if(!(await t.exists(e)))return void _e.debug("[数据迁移] 旧媒体文件夹不存在，跳过媒体迁移");_e.info(`📍 [数据迁移] 迁移媒体文件夹: ${e} → ${n}`);const i=await this.copyDataRecursively(e,n);_e.info(`✅ [数据迁移] 媒体文件夹迁移完成，共 ${i} 个文件`)}catch(n){_e.error("[数据迁移] 媒体文件夹迁移失败:",n)}}async checkMigrationNeeded(){const e=this.app.vault.adapter,t=await e.exists(os),n=`${os}/.migration-completed`,i=await e.exists(n),a=await this.getLegacyDataPath(),r=null!==a;return _e.debug("[数据迁移] 检查结果:",{legacyExists:r,legacyPath:a,newExists:t,alreadyMigrated:i}),r&&(!t||!i)}async copyDataRecursively(e,t){const n=this.app.vault.adapter;let i=0;await n.exists(t)||(await n.mkdir(t),_e.debug(`[数据迁移] 创建目录: ${t}`));const a=await n.list(e);for(const s of a.files){const e=`${t}/${s.split("/").pop()||""}`;try{const t=await n.read(s);await n.write(e,t),i++,_e.debug(`[数据迁移] 复制文件: ${s} → ${e}`)}catch(r){_e.warn(`[数据迁移] 复制文件失败: ${s}`,r)}}for(const s of a.folders){const e=`${t}/${s.split("/").pop()||""}`;i+=await this.copyDataRecursively(s,e)}return i}async validateMigration(){const e=this.app.vault.adapter;try{const t=[`${os}/decks/decks.json`,`${os}/profile/user-profile.json`];for(const n of t){await e.exists(n)||_e.warn(`[数据迁移] 关键文件缺失: ${n}`)}return await e.exists(os)}catch(t){return _e.error("[数据迁移] 验证失败:",t),!1}}async recordMigration(){const e=this.app.vault.adapter,t=`${os}/.migration-completed`,n=await this.getLegacyDataPath(),i=JSON.stringify({version:"1.0.0",migratedAt:(new Date).toISOString(),legacyPath:n||"unknown",newPath:os,unifiedArchitecture:!0},null,2);await e.write(t,i),_e.info(`[数据迁移] 迁移记录已保存: ${t}`)}async promptLegacyDataCleanup(){const e=this.app.vault.adapter;try{if(!(await e.exists(LEGACY_TUANKI_DATA)))return void _e.info("[数据迁移] 旧数据目录不存在，无需清理");new ge.Notice(`📦 Tuanki: 数据已迁移到新位置 "${os}"\n\n旧数据文件夹 "${LEGACY_TUANKI_DATA}" 已保留作为备份。\n确认新数据正常后，您可以手动删除旧文件夹。`,15e3),_e.info(`[数据迁移] 已提示用户清理旧数据: ${LEGACY_TUANKI_DATA}`)}catch(t){_e.error("[数据迁移] 检查旧数据失败:",t)}}}},Symbol.toStringTag,{value:"Module"}));const L_e=Object.freeze(Object.defineProperty({__proto__:null,DataFolderHiderService:class{constructor(){oe(this,"styleElement",null),oe(this,"monitorInterval",null),oe(this,"isEnabled",!1)}enable(e){if(this.isEnabled)return void _e.debug("[DataFolderHider] 已启用，跳过重复启用");const t=this.generateIsolatedCSS(e);this.styleElement=document.createElement("style"),this.styleElement.id="tuanki-data-folder-hider",this.styleElement.setAttribute("data-folder",e),this.styleElement.textContent=t,document.head.appendChild(this.styleElement),this.isEnabled=!0,_e.info(`[DataFolderHider] ✅ CSS隐藏已启用，文件夹: ${e}`),this.validateInjection(e)}disable(){this.isEnabled?(this.styleElement&&(this.styleElement.remove(),this.styleElement=null),this.stopLeakageMonitor(),this.isEnabled=!1,_e.info("[DataFolderHider] ✅ CSS隐藏已禁用")):_e.debug("[DataFolderHider] 未启用，跳过禁用")}generateIsolatedCSS(e){return`\n/* ========================================\n * Tuanki 数据文件夹CSS隐藏规则\n * \n * 仅影响: ${e}\n * 版本: v1.0.0\n * \n * 🔒 基于Obsidian社区验证的选择器\n * 参考: https://forum.obsidian.md/t/snippet-custom-css-to-hide-attachments-folder/49494\n * ======================================== */\n\n/* 核心规则：隐藏文件夹及其子内容 */\ndiv[data-path="${e}"],\ndiv[data-path="${e}"] + div.nav-folder-children {\n  display: none !important;\n}\n\n/* 辅助规则：隐藏文件夹标题 */\n.nav-folder-title[data-path="${e}"] {\n  display: none !important;\n}\n\n/* 书签面板支持 */\n.tree-item[data-path="${e}"] {\n  display: none !important;\n}\n`}validateInjection(e){const t=document.querySelectorAll("style#tuanki-data-folder-hider");if(0!==t.length){if(t.length>1){_e.warn("[DataFolderHider] ⚠️ 检测到重复的样式元素，正在清理...");for(let e=1;e<t.length;e++)t[e].remove()}this.styleElement&&this.styleElement.isConnected&&(_e.info("[DataFolderHider] ✅ CSS样式已成功注入"),setTimeout(()=>{this.quickValidation(e)},500))}else _e.error("[DataFolderHider] ❌ CSS注入失败，样式元素未找到")}quickValidation(e){const t=document.querySelector(`.nav-folder-title[data-path="${e}"]`);if(t){"none"===window.getComputedStyle(t).display?_e.info(`[DataFolderHider] ✅ 目标文件夹 "${e}" 已成功隐藏`):_e.warn(`[DataFolderHider] ⚠️ 目标文件夹 "${e}" 未被隐藏，CSS可能失效`)}else _e.debug(`[DataFolderHider] 目标文件夹 "${e}" 尚未渲染到DOM`)}startLeakageMonitor(e){this.monitorInterval||(_e.info("[DataFolderHider] 🔍 启动CSS泄漏监控（开发模式）"),this.monitorInterval=window.setInterval(()=>{this.detectLeakage(e)},3e4))}stopLeakageMonitor(){this.monitorInterval&&(window.clearInterval(this.monitorInterval),this.monitorInterval=null,_e.info("[DataFolderHider] 🔍 CSS泄漏监控已停止"))}detectLeakage(e){const t=document.querySelectorAll(".nav-folder-title"),n=[];let i=!1;t.forEach(t=>{const a=t.getAttribute("data-path");"none"===window.getComputedStyle(t).display&&a&&(n.push(a),a===e&&(i=!0))});const a=n.filter(t=>t!==e&&!t.startsWith(e+"/"));a.length>0?(_e.error("[DataFolderHider] 🚨 CSS泄漏检测：以下文件夹被意外隐藏",a),this.emergencyDisable()):i?_e.debug("[DataFolderHider] ✅ CSS隔离检查通过，无泄漏"):_e.warn(`[DataFolderHider] ⚠️ 目标文件夹 "${e}" 未被隐藏`)}emergencyDisable(){_e.error("[DataFolderHider] 🚨 检测到CSS泄漏，执行紧急禁用"),this.disable(),new ge.Notice("⚠️ Tuanki: 检测到数据文件夹CSS泄漏，已自动禁用隐藏功能\n请联系开发者报告此问题",1e4)}getStatus(){var e;return{enabled:this.isEnabled,folderName:(null==(e=this.styleElement)?void 0:e.getAttribute("data-folder"))||null}}destroy(){this.disable(),_e.info("[DataFolderHider] 服务已销毁")}}},Symbol.toStringTag,{value:"Module"})),N_e={learningSteps:{enabled:!0,steps:[1,10],maxFailures:5,showProgressIndicator:!0},interleaving:{enabled:!0,mode:"smart",respectPriority:!0,minGroupSize:3,maxConsecutiveSameTag:2},difficultyTracking:{enabled:!0,showIndicator:!0,autoTag:!0,interventionThreshold:2,trendAnalysisWindow:5},priority:{enableUserPriority:!0,enableDifficultyAdjustment:!0,enableLeechBoost:!0}};class F_e{constructor(e){oe(this,"config"),oe(this,"timers",new Map),oe(this,"eventListeners",new Map),this.config=e,_e.debug("[LearningSteps] Manager initialized",{config:e})}process(e,t,n){var i;return this.config.enabled?e.fsrs?(_e.debug("[LearningSteps] Processing card",{cardId:e.uuid,rating:t,prevState:n,currentState:e.fsrs.state}),n===Gr.New&&t<=Qr.Hard?this.enterLearning(e):(null==(i=e.metadata)?void 0:i.learningSteps)?this.handleLearningCard(e,t):{shouldStayInQueue:!1,insertPosition:null}):(_e.warn("[LearningSteps] Card missing fsrs data",{cardId:e.uuid}),{shouldStayInQueue:!1,insertPosition:null}):{shouldStayInQueue:!1,insertPosition:null}}enterLearning(e){_e.debug("[LearningSteps] Entering learning",{cardId:e.uuid}),e.fsrs.state=Gr.Learning,e.metadata||(e.metadata={}),e.metadata.learningSteps={currentStep:0,steps:this.config.steps,startedAt:(new Date).toISOString(),failureCount:1};const t=new Date;return t.setMinutes(t.getMinutes()+this.config.steps[0]),e.fsrs.due=t.toISOString(),this.scheduleReview(e),{shouldStayInQueue:!0,insertPosition:"short-term",nextDue:t.toISOString()}}handleLearningCard(e,t){const n=e.metadata.learningSteps;if(_e.debug("[LearningSteps] Handling learning card",{cardId:e.uuid,rating:t,currentStep:n.currentStep,failureCount:n.failureCount}),t===Qr.Again){n.currentStep=0,n.failureCount++,n.failureCount>=this.config.maxFailures&&(_e.warn("[LearningSteps] Max failures reached",{cardId:e.uuid,failureCount:n.failureCount}),this.emit("max-failures-reached",{cardId:e.uuid,failureCount:n.failureCount}));const t=new Date;return t.setMinutes(t.getMinutes()+n.steps[0]),e.fsrs.due=t.toISOString(),this.scheduleReview(e),{shouldStayInQueue:!0,insertPosition:"immediate",nextDue:t.toISOString()}}if(t===Qr.Hard&&n.currentStep<n.steps.length-1){n.currentStep++;const t=n.steps[n.currentStep],i=new Date;return i.setMinutes(i.getMinutes()+t),e.fsrs.due=i.toISOString(),this.scheduleReview(e),{shouldStayInQueue:!0,insertPosition:"short-term",nextDue:i.toISOString()}}return t>=Qr.Good?this.graduate(e):{shouldStayInQueue:!1,insertPosition:null}}graduate(e){return _e.debug("[LearningSteps] Graduating card",{cardId:e.uuid}),e.fsrs.state=Gr.Review,e.metadata&&delete e.metadata.learningSteps,this.clearTimer(e.uuid),{shouldStayInQueue:!1,insertPosition:null}}scheduleReview(e){const t=new Date(e.fsrs.due).getTime(),n=Date.now(),i=Math.max(0,t-n);this.clearTimer(e.uuid);const a=setTimeout(()=>{_e.debug("[LearningSteps] Card is due",{cardId:e.uuid}),this.emit("card-due",e.uuid),this.timers.delete(e.uuid)},i);this.timers.set(e.uuid,a)}clearTimer(e){const t=this.timers.get(e);t&&(clearTimeout(t),this.timers.delete(e))}initializeSession(e){_e.debug("[LearningSteps] Initializing session",{cardCount:e.length}),e.forEach(e=>{var t;(null==(t=e.metadata)?void 0:t.learningSteps)&&this.scheduleReview(e)})}cleanup(){_e.debug("[LearningSteps] Cleaning up",{timerCount:this.timers.size}),this.timers.forEach(e=>clearTimeout(e)),this.timers.clear()}updateConfig(e){this.config={...this.config,...e},_e.debug("[LearningSteps] Config updated",{config:this.config})}getConfig(){return{...this.config}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}emit(e,t){const n=this.eventListeners.get(e);n&&n.forEach(n=>{try{n(t)}catch(i){_e.error("[LearningSteps] Event listener error",{event:e,error:i})}})}}class B_e{constructor(e){oe(this,"config"),oe(this,"cache",new WeakMap),this.config=e,_e.debug("[PriorityCalculator] Initialized",{config:e})}calculate(e){const t=this.cache.get(e);if(void 0!==t)return t;const n=this.doCalculate(e);return this.cache.set(e,n),_e.debug("[PriorityCalculator] Calculated priority",{cardId:e.uuid,priority:n,breakdown:this.getBreakdown(e)}),n}doCalculate(e){if(!e.fsrs)return _e.warn("[PriorityCalculator] Card missing fsrs data",{cardId:e.uuid}),400;return this.getStatePriority(e.fsrs.state)+(this.config.enableUserPriority?this.getUserPriority(e):20)+(this.config.enableDifficultyAdjustment?this.getDifficultyAdjustment(e):0)+(this.config.enableLeechBoost?this.getLeechBoost(e):0)}getStatePriority(e){return{[Gr.Learning]:100,[Gr.Relearning]:200,[Gr.Review]:300,[Gr.New]:400}[e]}getUserPriority(e){return 10*(e.priority||2)}getDifficultyAdjustment(e){var t,n;return{easy:0,medium:1,hard:3,very_hard:5}[(null==(n=null==(t=e.metadata)?void 0:t.difficultyTracking)?void 0:n.currentLevel)||"medium"]}getLeechBoost(e){var t;let n=0;const i=e.fsrs.difficulty||0;i>=9.5?n+=3:i>=9?n+=2:i>=8&&(n+=1);const a=e.fsrs.lapses||0;if(a>=8?n+=3:a>=5?n+=2:a>=3&&(n+=1),null==(t=e.metadata)?void 0:t.difficultyTracking){const t=e.metadata.difficultyTracking;"very_hard"===t.currentLevel&&(n+=1),"rising"===t.trend&&(n+=1),t.consecutiveHard>=3&&(n+=1)}return n>=6?-20:n>=4?-10:n>=2?-5:0}detectLeech(e){var t;if(!e.fsrs)return{severity:0,level:"none",shouldRecycle:!1,reasons:["Card missing fsrs data"]};let n=0;const i=[],a=e.fsrs.difficulty||0;a>=9.5?(n+=3,i.push(`FSRS难度极高(${a.toFixed(1)})`)):a>=9&&(n+=2,i.push(`FSRS难度很高(${a.toFixed(1)})`));const r=e.fsrs.lapses||0;if(r>=8?(n+=3,i.push(`遗忘次数过多(${r}次)`)):r>=5&&(n+=2,i.push(`遗忘次数较多(${r}次)`)),null==(t=e.metadata)?void 0:t.difficultyTracking){const t=e.metadata.difficultyTracking;"very_hard"===t.currentLevel&&(n+=1,i.push("标记为非常困难")),"rising"===t.trend&&(n+=1,i.push("难度持续上升")),t.consecutiveHard>=3&&(n+=1,i.push(`连续${t.consecutiveHard}次评Hard`))}let s,o;return n>=6?(s="severe",o=!0):n>=4?(s="moderate",o=!1):n>=2?(s="mild",o=!1):(s="none",o=!1),_e.debug("[PriorityCalculator] Leech detection",{cardId:e.uuid,severity:n,level:s,shouldRecycle:o,reasons:i}),{severity:n,level:s,shouldRecycle:o,reasons:i}}getBreakdown(e){if(!e.fsrs)return{statePriority:400,userPriority:20,difficultyAdjustment:0,leechBoost:0,total:420};const t=this.getStatePriority(e.fsrs.state),n=this.getUserPriority(e),i=this.getDifficultyAdjustment(e),a=this.getLeechBoost(e);return{statePriority:t,userPriority:n,difficultyAdjustment:i,leechBoost:a,total:t+n+i+a}}clearCache(){this.cache=new WeakMap,_e.debug("[PriorityCalculator] Cache cleared")}invalidateCache(e){this.cache.delete(e),_e.debug("[PriorityCalculator] Cache invalidated",{cardId:e.uuid})}updateConfig(e){this.config={...this.config,...e},this.clearCache(),_e.debug("[PriorityCalculator] Config updated",{config:this.config})}getConfig(){return{...this.config}}}class j_e{constructor(e){oe(this,"config"),oe(this,"eventListeners",new Map),this.config=e,_e.debug("[DifficultyTracker] Initialized",{config:e})}update(e,t){if(!this.config.enabled)return;if(!e.fsrs)return void _e.warn("[DifficultyTracker] Card missing fsrs data",{cardId:e.uuid});e.metadata||(e.metadata={}),e.metadata.difficultyTracking||(e.metadata.difficultyTracking=this.initializeTracking(e));const n=e.metadata.difficultyTracking;this.recordHistory(n,e.fsrs.difficulty,t),n.currentLevel=this.calculateLevel(e.fsrs.difficulty),n.trend=this.analyzeTrend(n.difficultyHistory),this.updateConsecutiveHard(n,t),n.interventionLevel=this.calculateInterventionLevel(n),_e.debug("[DifficultyTracker] Updated",{cardId:e.uuid,level:n.currentLevel,trend:n.trend,interventionLevel:n.interventionLevel}),n.interventionLevel>=this.config.interventionThreshold&&this.applyIntervention(e,n.interventionLevel)}initializeTracking(e){return{currentLevel:this.calculateLevel(e.fsrs.difficulty),difficultyHistory:[],trend:"stable",consecutiveHard:0,interventionLevel:0}}recordHistory(e,t,n){e.difficultyHistory.push({timestamp:(new Date).toISOString(),difficulty:t,rating:n}),e.difficultyHistory.length>20&&e.difficultyHistory.shift()}calculateLevel(e){return e<6?"easy":e<8?"medium":e<9?"hard":"very_hard"}analyzeTrend(e){if(e.length<3)return"stable";const t=Math.min(this.config.trendAnalysisWindow,e.length),n=e.slice(-t),i=n.length;let a=0,r=0,s=0,o=0;n.forEach((e,t)=>{a+=t,r+=e.difficulty,s+=t*e.difficulty,o+=t*t});const l=i*o-a*a;if(0===l)return"stable";const c=(i*s-a*r)/l;return c>.3?"rising":c<-.3?"falling":"stable"}updateConsecutiveHard(e,t){t===Qr.Hard?e.consecutiveHard++:t>=Qr.Good&&(e.consecutiveHard=0)}calculateInterventionLevel(e){let t=0;return"hard"===e.currentLevel?t+=1:"very_hard"===e.currentLevel&&(t+=2),"rising"===e.trend&&(t+=1),e.consecutiveHard>=3&&(t+=1),Math.min(t,3)}applyIntervention(e,t){switch(_e.debug("[DifficultyTracker] Applying intervention",{cardId:e.uuid,level:t}),t){case 1:this.config.autoTag&&this.addTag(e,"#需关注");break;case 2:this.config.autoTag&&this.addTag(e,"#困难");break;case 3:this.config.autoTag&&this.addTag(e,"#困难"),this.emitImprovementNeeded(e)}}addTag(e,t){e.tags||(e.tags=[]),e.tags.includes(t)||(e.tags.push(t),_e.debug("[DifficultyTracker] Tag added",{cardId:e.uuid,tag:t}))}emitImprovementNeeded(e){this.emit("improvement-needed",{cardId:e.uuid,suggestions:["拆分为多张简单卡片","添加助记提示或图片","检查是否缺少背景知识"]})}getStatistics(e){const t={easy:0,medium:0,hard:0,veryHard:0,total:e.length};return e.forEach(e=>{var n,i;switch(null==(i=null==(n=e.metadata)?void 0:n.difficultyTracking)?void 0:i.currentLevel){case"easy":t.easy++;break;case"medium":t.medium++;break;case"hard":t.hard++;break;case"very_hard":t.veryHard++}}),t}updateConfig(e){this.config={...this.config,...e},_e.debug("[DifficultyTracker] Config updated",{config:this.config})}getConfig(){return{...this.config}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}emit(e,t){const n=this.eventListeners.get(e);n&&n.forEach(n=>{try{n(t)}catch(i){_e.error("[DifficultyTracker] Event listener error",{event:e,error:i})}})}}class U_e{constructor(e){oe(this,"config"),this.config=e,_e.debug("[InterleavingEngine] Initialized",{config:e})}interleave(e){if(!this.config.enabled)return _e.debug("[InterleavingEngine] Interleaving disabled, returning original order"),e;if(e.length<this.config.minGroupSize)return _e.debug("[InterleavingEngine] Too few cards, skipping interleaving",{cardCount:e.length,minGroupSize:this.config.minGroupSize}),e;switch(_e.debug("[InterleavingEngine] Starting interleaving",{cardCount:e.length,mode:this.config.mode}),this.config.mode){case"tag":return this.interleaveByTag(e);case"smart":return this.smartInterleave(e);case"random":return this.randomShuffle(e);default:return _e.warn("[InterleavingEngine] Unknown mode, using tag mode",{mode:this.config.mode}),this.interleaveByTag(e)}}interleaveByTag(e){const t=this.groupByTag(e);return t.size<2?(_e.debug("[InterleavingEngine] Only one tag group, no interleaving needed"),e):(_e.debug("[InterleavingEngine] Grouped by tags",{groupCount:t.size,groups:Array.from(t.entries()).map(([e,t])=>({tag:e,count:t.length}))}),this.config.respectPriority&&t.forEach(e=>{e.sort((e,t)=>this.compareCards(e,t))}),this.roundRobinInterleave(Array.from(t.values())))}smartInterleave(e){const t=this.groupByState(e);_e.debug("[InterleavingEngine] Smart interleaving",{layerCount:t.size});const n=[];return[1,3,2,0].forEach(e=>{const i=t.get(e);if(i&&i.length>0){const e=this.interleaveByTag(i);n.push(...e)}}),n}randomShuffle(e){const t=[...e];for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return _e.debug("[InterleavingEngine] Random shuffle completed"),t}groupByTag(e){const t=new Map;return e.forEach(e=>{const n=this.getPrimaryTag(e);t.has(n)||t.set(n,[]),t.get(n).push(e)}),t}groupByState(e){const t=new Map;return e.forEach(e=>{if(!e.fsrs)return void _e.warn("[InterleavingEngine] Card missing fsrs data",{cardId:e.uuid});const n=e.fsrs.state;t.has(n)||t.set(n,[]),t.get(n).push(e)}),t}getPrimaryTag(e){if(!e.tags||0===e.tags.length)return"__untagged__";const t=["#困难","#需关注","#回收","#已改进"],n=e.tags.filter(e=>!t.includes(e));if(0===n.length)return"__untagged__";return n[0].split("/")[0].replace("#","").trim()||"__untagged__"}roundRobinInterleave(e){const t=[],n=Math.max(...e.map(e=>e.length));for(let i=0;i<n;i++)for(const n of e)n[i]&&t.push(n[i]);return _e.debug("[InterleavingEngine] Round robin interleaving completed",{resultCount:t.length}),t}compareCards(e,t){const n=e.priority||2,i=t.priority||2;if(n!==i)return n-i;if(!e.fsrs||!t.fsrs)return 0;return new Date(e.fsrs.due).getTime()-new Date(t.fsrs.due).getTime()}validateInterleaving(e){if(e.length<2)return{valid:!0,maxConsecutive:0,violations:0};let t=1,n=1,i=0,a=this.getPrimaryTag(e[0]);for(let s=1;s<e.length;s++){const r=this.getPrimaryTag(e[s]);r===a&&"__untagged__"!==r?(n++,t=Math.max(t,n),n>this.config.maxConsecutiveSameTag&&i++):n=1,a=r}const r=0===i;return _e.debug("[InterleavingEngine] Validation result",{valid:r,maxConsecutive:t,violations:i,threshold:this.config.maxConsecutiveSameTag}),{valid:r,maxConsecutive:t,violations:i}}updateConfig(e){this.config={...this.config,...e},_e.debug("[InterleavingEngine] Config updated",{config:this.config})}getConfig(){return{...this.config}}}class V_e{constructor(e,t,n){oe(this,"interleavingEngine"),oe(this,"priorityCalculator"),oe(this,"settings"),oe(this,"priorityCache",new WeakMap),this.interleavingEngine=e,this.priorityCalculator=t,this.settings=n,_e.debug("[QueueCoordinator] Initialized",{settings:n})}async optimizeQueue(e){if(0===e.length)return _e.debug("[QueueCoordinator] Empty queue, nothing to optimize"),[];_e.debug("[QueueCoordinator] Starting queue optimization",{cardCount:e.length});const t=performance.now();try{const n=this.calculatePriorities(e),i=this.groupByPriorityLayer(n);_e.debug("[QueueCoordinator] Priority layers",{layerCount:i.length,distribution:i.map(e=>e.length)});const a=i.map(e=>this.optimizeLayer(e)).flat(),r=performance.now()-t;return _e.debug("[QueueCoordinator] Queue optimization completed",{cardCount:a.length,duration:`${r.toFixed(2)}ms`}),a}catch(n){return _e.error("[QueueCoordinator] Queue optimization failed",{error:n}),e}}calculatePriorities(e){return e.map(e=>({card:e,priority:this.getPriority(e)}))}getPriority(e){const t=this.priorityCache.get(e);if(void 0!==t)return t;const n=this.priorityCalculator.calculate(e);return this.priorityCache.set(e,n),n}groupByPriorityLayer(e){const t=new Map;return e.forEach(e=>{const n=Math.floor(e.priority/100);t.has(n)||t.set(n,[]),t.get(n).push(e)}),Array.from(t.entries()).sort(([e],[t])=>e-t).map(([e,t])=>t)}optimizeLayer(e){if(0===e.length)return[];const t=e.map(e=>e.card);return this.settings.interleaving.enabled?this.interleavingEngine.interleave(t):e.sort((e,t)=>e.priority-t.priority).map(e=>e.card)}async refreshQueue(e,t){return t&&this.priorityCache.delete(t),this.optimizeQueue(e)}clearCache(){this.priorityCache=new WeakMap,this.priorityCalculator.clearCache(),_e.debug("[QueueCoordinator] All caches cleared")}invalidateCache(e){this.priorityCache.delete(e),this.priorityCalculator.invalidateCache(e),_e.debug("[QueueCoordinator] Cache invalidated",{cardId:e.uuid})}getQueueStatistics(e){const t={total:e.length,byState:{},byPriority:{},avgPriority:0};let n=0;return e.forEach(e=>{const i=e.fsrs.state;t.byState[i]=(t.byState[i]||0)+1;const a=e.priority||2;t.byPriority[a]=(t.byPriority[a]||0)+1,n+=this.getPriority(e)}),t.avgPriority=e.length>0?n/e.length:0,t}validateQueue(e){const t=[];if(0===e.length&&t.push("队列为空"),this.settings.interleaving.enabled){const n=this.interleavingEngine.validateInterleaving(e);n.valid||t.push(`交错质量不佳：最大连续${n.maxConsecutive}张相同标签，违规${n.violations}次`)}let n=-1/0;for(const a of e){const e=this.getPriority(a);if(e<n){t.push("优先级顺序不正确");break}n=e}const i=0===t.length;return _e.debug("[QueueCoordinator] Queue validation",{valid:i,issues:t}),{valid:i,issues:t}}updateSettings(e){this.settings={...this.settings,...e},e.interleaving&&this.interleavingEngine.updateConfig(e.interleaving),e.priority&&this.priorityCalculator.updateConfig(e.priority),this.clearCache(),_e.debug("[QueueCoordinator] Settings updated",{settings:this.settings})}getSettings(){return{...this.settings}}getInterleavingEngine(){return this.interleavingEngine}getPriorityCalculator(){return this.priorityCalculator}}const q_e=Object.freeze(Object.defineProperty({__proto__:null,QueueOptimizationFactory:class{static create(e){_e.debug("[QueueFactory] Creating queue optimization system");const t={...N_e,...e,learningSteps:{...N_e.learningSteps,...null==e?void 0:e.learningSteps},interleaving:{...N_e.interleaving,...null==e?void 0:e.interleaving},difficultyTracking:{...N_e.difficultyTracking,...null==e?void 0:e.difficultyTracking},priority:{...N_e.priority,...null==e?void 0:e.priority}};_e.debug("[QueueFactory] Final settings",{settings:t});const n=new F_e(t.learningSteps),i=new B_e(t.priority),a=new j_e(t.difficultyTracking),r=new U_e(t.interleaving),s=new V_e(r,i,t);return _e.debug("[QueueFactory] Queue optimization system created successfully"),{learningStepsManager:n,priorityCalculator:i,difficultyTracker:a,interleavingEngine:r,coordinator:s}}static createDefault(){return this.create()}static createFromPluginSettings(e){const t=null==e?void 0:e.queueOptimization;return this.create(t)}}},Symbol.toStringTag,{value:"Module"}));class H_e{constructor(e){var t;oe(this,"app"),oe(this,"plugin"),oe(this,"oldBasePath",".obsidian/plugins/tuanki/question-bank"),oe(this,"newBasePath"),this.plugin=e,this.app=e.app;const n=(null==(t=e.settings)?void 0:t.dataFolder)||"tuanki";this.newBasePath=`${n}/question-bank`}async needsMigration(){const e=this.app.vault.adapter;if(!(await e.exists(this.oldBasePath)))return!1;return(await this.getFilesToMigrate()).length>0}async getFilesToMigrate(){try{const t=this.app.vault.adapter,n=[];if(await t.exists(this.oldBasePath)){const i=["banks.json","questions.json"];for(const e of i){const i=`${this.oldBasePath}/${e}`;await t.exists(i)&&n.push(e)}const a=["test-sessions","error-book"];for(const r of a){const i=`${this.oldBasePath}/${r}`;if(await t.exists(i))try{const e=await t.stat(i);if("folder"===(null==e?void 0:e.type)){const e=await this.getFilesInDirectory(i);n.push(...e.map(e=>`${r}/${e}`))}}catch(e){_e.warn(`[Migration] 无法访问目录 ${i}:`,e)}}}return n}catch(e){return _e.error("[Migration] 获取迁移文件列表失败:",e),[]}}async getFilesInDirectory(e){try{const t=this.app.vault.adapter;return(await t.list(e)).files.map(t=>t.replace(`${e}/`,""))}catch(t){return _e.warn(`[Migration] 无法列出目录 ${e}:`,t),[]}}async migrate(){const e={success:!1,migratedFiles:[],errors:[],skippedFiles:[]};try{_e.debug("[Migration] 开始题库数据迁移..."),_e.debug(`[Migration] 源路径: ${this.oldBasePath}`),_e.debug(`[Migration] 目标路径: ${this.newBasePath}`);const n=await this.getFilesToMigrate();if(_e.debug(`[Migration] 发现 ${n.length} 个文件需要迁移`),0===n.length)return e.success=!0,_e.debug("[Migration] 没有文件需要迁移"),e;await this.ensureTargetDirectories();for(const i of n)try{await this.migrateFile(i),e.migratedFiles.push(i),_e.debug(`[Migration] ✅ 迁移成功: ${i}`)}catch(t){const n=`迁移文件 ${i} 失败: ${t instanceof Error?t.message:String(t)}`;e.errors.push(n),_e.error(`[Migration] ❌ ${n}`)}0===e.errors.length?(await this.cleanupOldDirectory(),e.success=!0,_e.debug("[Migration] ✅ 题库数据迁移完成"),new ge.Notice("题库数据迁移完成")):(_e.error("[Migration] ❌ 迁移过程中发生错误，请检查日志"),new ge.Notice("题库数据迁移失败，请查看控制台"))}catch(t){const n=`迁移过程失败: ${t instanceof Error?t.message:String(t)}`;e.errors.push(n),_e.error("[Migration]",n),new ge.Notice("题库数据迁移失败")}return e}async ensureTargetDirectories(){const e=this.app.vault.adapter;await e.exists(this.newBasePath)||(await e.mkdir(this.newBasePath),_e.debug(`[Migration] 创建目录: ${this.newBasePath}`));const t=["test-sessions","error-book"];for(const n of t){const t=`${this.newBasePath}/${n}`;await e.exists(t)||(await e.mkdir(t),_e.debug(`[Migration] 创建目录: ${t}`))}}async migrateFile(e){const t=this.app.vault.adapter,n=`${this.oldBasePath}/${e}`,i=`${this.newBasePath}/${e}`,a=await t.read(n);await t.write(i,a),_e.debug(`[Migration] 文件迁移: ${n} -> ${i}`)}async cleanupOldDirectory(){try{const e=this.app.vault.adapter;await e.exists(this.oldBasePath)&&(await e.rmdir(this.oldBasePath,!0),_e.debug(`[Migration] 清理旧目录: ${this.oldBasePath}`))}catch(e){_e.warn("[Migration] 清理旧目录失败:",e)}}async updateStorageConfig(){try{_e.debug("[Migration] 更新QuestionBankStorage配置...");const e=this.plugin.questionBankStorage;e&&(e.basePath=this.newBasePath,_e.debug(`[Migration] ✅ QuestionBankStorage basePath updated to: ${this.newBasePath}`))}catch(e){_e.error("[Migration] 更新存储配置失败:",e)}}static async autoMigrate(e){const t=new H_e(e);if(await t.needsMigration()){_e.debug("[Migration] 检测到题库数据需要迁移");(await t.migrate()).success&&await t.updateStorageConfig()}}}const W_e=Object.freeze(Object.defineProperty({__proto__:null,QuestionBankMigration:H_e},Symbol.toStringTag,{value:"Module"})),G_e=Object.freeze(Object.defineProperty({__proto__:null,CardRelationService:nee,DerivationMethod:Nx},Symbol.toStringTag,{value:"Module"}));function Q_e(e){const t=e;if("progressive"===t.type)return'V1.5类型: type="progressive"';if(t.progressiveCloze)return"V1.5字段: progressiveCloze (单卡片多FSRS方案)";if(e.metadata){if(t.metadata.clozeMap)return"V1.5元数据: metadata.clozeMap";if(t.metadata.childClozeMetadata)return"V1.5元数据: metadata.childClozeMetadata"}return null}const K_e=Object.freeze(Object.defineProperty({__proto__:null,registerProgressiveCleanupTool:function(e){window.tuankiDevTools=window.tuankiDevTools||{},window.tuankiDevTools.checkV15Cards=async()=>{_e.info("[开发工具] 检查 V1.5 卡片...");try{return await async function(e){try{const t=await e.getAllCards();for(const e of t)if(Q_e(e))return!0;return!1}catch(t){return _e.error("[V1.5清理] 快速检查失败:",t),!1}}(e.dataStorage)?(_e.warn("[开发工具] ⚠️ 发现 V1.5 格式卡片"),_e.info("[开发工具] 运行清理命令: window.tuankiDevTools.cleanV15Cards(true)"),!0):(_e.info("[开发工具] ✅ 未发现 V1.5 格式卡片"),!1)}catch(t){throw _e.error("[开发工具] 检查失败:",t),t}},window.tuankiDevTools.cleanV15Cards=async(t=!0)=>{const n=t?"模拟":"实际";_e.info(`[开发工具] 开始清理 V1.5 卡片（${n}模式）...`),t||(_e.warn("[开发工具] ⚠️ 即将实际删除卡片，3秒后开始..."),await new Promise(e=>setTimeout(e,3e3)));try{const n=await async function(e,t=!1){_e.info("[V1.5清理] 开始扫描数据库...");const n={totalScanned:0,deletedCount:0,deletedCards:[],errors:[]};try{const a=await e.getAllCards();n.totalScanned=a.length,_e.info(`[V1.5清理] 扫描到 ${a.length} 张卡片`);for(const r of a)try{const i=Q_e(r);i&&(_e.warn(`[V1.5清理] 发现V1.5卡片: ${r.uuid} - ${i}`),t?_e.info(`[V1.5清理] [模拟] 将删除: ${r.uuid}`):(await e.deleteCard(r.uuid),_e.info(`[V1.5清理] 已删除: ${r.uuid}`)),n.deletedCards.push({uuid:r.uuid,reason:i}),n.deletedCount++)}catch(i){const e=i instanceof Error?i.message:String(i);_e.error(`[V1.5清理] 处理卡片失败: ${r.uuid}`,i),n.errors.push({uuid:r.uuid,error:e})}_e.info("[V1.5清理] 完成！统计：",{totalScanned:n.totalScanned,deletedCount:n.deletedCount,errorCount:n.errors.length,dryRun:t}),t&&_e.info("[V1.5清理] 这是模拟运行，未实际删除卡片")}catch(i){throw _e.error("[V1.5清理] 扫描失败:",i),i}return n}(e.dataStorage,t);return n.deletedCards.length>0&&n.deletedCards.forEach(({uuid:e,reason:t})=>{}),n.errors.length>0&&n.errors.forEach(({uuid:e,error:t})=>{}),t&&n.deletedCount>0&&_e.info("[开发工具] 要实际执行删除，运行: window.tuankiDevTools.cleanV15Cards(false)"),n}catch(i){throw _e.error("[开发工具] 清理失败:",i),i}},e.checkV15Cards=window.tuankiDevTools.checkV15Cards,e.cleanV15Cards=window.tuankiDevTools.cleanV15Cards,_e.debug("[开发工具] V1.5 清理工具已注册"),_e.debug("[开发工具] 可用命令:"),_e.debug("  - window.tuankiDevTools.checkV15Cards()"),_e.debug("  - window.tuankiDevTools.cleanV15Cards(true)  // 模拟运行"),_e.debug("  - window.tuankiDevTools.cleanV15Cards(false) // 实际删除")}},Symbol.toStringTag,{value:"Module"}));const Z_e=Object.freeze(Object.defineProperty({__proto__:null,registerProgressiveDebugTool:function(e){window.tuankiDevTools=window.tuankiDevTools||{},window.tuankiDevTools.diagnoseProgressiveCard=async t=>{var n;_e.info("[调试工具] 开始诊断渐进式挖空卡片...");try{let i;if(t){if(i=await e.dataStorage.getCardByUUID(t),!i)return _e.error(`[调试工具] 未找到卡片: ${t}`),null}else{const t=e.app.workspace.getLeavesOfType("study-view")[0];if(!t)return _e.error("[调试工具] 未找到学习界面"),null;const a=null==(n=t.view)?void 0:n.currentCard;if(!a)return _e.error("[调试工具] 学习界面未加载卡片"),null;i=a}const a=function(e){var t,n;const i={cardId:e.uuid,cardType:e.type,isV2Format:!1,isParent:!1,isChild:!1,content:e.content||"",clozeMatches:[],issues:[],suggestions:[]};i.isParent=r8(e),i.isChild=s8(e),i.isV2Format=i.isParent||i.isChild,i.isParent&&(i.childCardIds=(null==(t=e.progressiveCloze)?void 0:t.childCardIds)||[],i.totalClozes=(null==(n=e.progressiveCloze)?void 0:n.totalClozes)||0);if(i.isChild){const t=e;i.parentCardId=t.parentCardId,i.clozeOrd=t.clozeOrd,i.activeClozeOrdinal=t.clozeOrd+1}e.progressiveCloze&&!i.isV2Format&&(i.hasV15ProgressiveCloze=!0,i.v15Data=e.progressiveCloze,i.issues.push("检测到V1.5格式的progressiveCloze字段"),i.suggestions.push("使用 window.tuankiDevTools.cleanV15Cards() 清理V1.5数据"));const a=/\{\{c(\d+)::([^:}]+)(?:::([^}]+))?\}\}/g;let r;for(;null!==(r=a.exec(i.content));){const e=parseInt(r[1]),t=r[2],n=r[3];i.clozeMatches.push({match:r[0],ordinal:e,text:t,hint:n})}"progressive"===e.type&&(i.issues.push('卡片类型为已废弃的"progressive"（V1.5）'),i.suggestions.push("需要转换为V2格式（progressive-parent + progressive-child）"));i.isChild&&!i.content&&i.issues.push("⚠️ 子卡片content为空（可能是V1遗留数据，建议运行迁移工具）");i.isChild&&0===i.clozeMatches.length&&(i.issues.push("子卡片没有检测到挖空标记"),i.suggestions.push("检查父卡片的content是否包含挖空标记"));if(i.isChild&&void 0!==i.clozeOrd){i.clozeMatches.find(e=>e.ordinal===i.activeClozeOrdinal)||i.issues.push(`子卡片的clozeOrd(${i.clozeOrd})对应的挖空c${i.activeClozeOrdinal}在内容中不存在`)}return i}(i);return a.isParent||a.isChild,a.hasV15ProgressiveCloze,a.clozeMatches.length,a.issues.length>0&&a.issues.forEach(e=>{}),a.suggestions.length>0&&a.suggestions.forEach(e=>{}),a}catch(i){throw _e.error("[调试工具] 诊断失败:",i),i}},_e.debug("[调试工具] 渐进式挖空诊断工具已注册")}},Symbol.toStringTag,{value:"Module"}));const Y_e=Object.freeze(Object.defineProperty({__proto__:null,AutoBackupScheduler:class{constructor(e,t,n){oe(this,"engine"),oe(this,"timerId",null),oe(this,"isRunning",!1),oe(this,"lastCardCount",0),this.plugin=e,this.getConfig=t,this.saveConfig=n,this.engine=new sle(e)}start(){if(this.isRunning)return void _e.debug("⏰ 自动备份调度器已在运行");const e=this.getConfig();if(!e.enabled)return void _e.debug("⏰ 自动备份已禁用");this.isRunning=!0,_e.debug(`⏰ 启动自动备份调度器，间隔: ${e.intervalHours} 小时`);const t=60*e.intervalHours*60*1e3;this.timerId=window.setInterval(()=>{this.checkAndBackup("scheduled")},t),this.updateCardCount()}stop(){this.isRunning&&(null!==this.timerId&&(window.clearInterval(this.timerId),this.timerId=null),this.isRunning=!1,_e.debug("⏰ 自动备份调度器已停止"))}restart(){_e.debug("⏰ 重启自动备份调度器..."),this.stop(),this.start()}async checkAndCreateStartupBackup(){const e=this.getConfig();e.enabled&&e.triggers.onStartup?this.shouldCreateStartupBackup()?(_e.debug("⏰ 执行启动备份..."),await this.createAutoBackup("startup")):_e.debug("⏰ 跳过启动备份（时间间隔未到）"):_e.debug("⏰ 启动备份已禁用")}async checkCardCountThreshold(){const e=this.getConfig();if(!e.enabled||!e.triggers.onCardThreshold)return;const t=await this.getCardCount(),n=Math.abs(t-this.lastCardCount);n>=e.triggers.cardThresholdCount&&(_e.debug(`⏰ 卡片数量变化达到阈值: ${n} (阈值: ${e.triggers.cardThresholdCount})`),await this.createAutoBackup("card_threshold"),this.lastCardCount=t)}async triggerManualAutoBackup(){return _e.debug("⏰ 手动触发自动备份"),await this.createAutoBackup("manual_trigger")}async checkAndBackup(e){this.getConfig().enabled?this.shouldCreateTimedBackup()?(_e.debug(`⏰ 执行自动备份 (原因: ${e})`),await this.createAutoBackup(e)):_e.debug("⏰ 时间间隔未到，跳过自动备份"):_e.debug("⏰ 自动备份已禁用，跳过")}async createAutoBackup(e){const t=this.getConfig();try{_e.debug(`⏰ 开始创建自动备份 (触发: ${e})`);const n=await this.engine.createBackup({description:`自动备份 (${e})`,autoCleanup:!0,type:"auto"});return await this.saveConfig({lastAutoBackupTime:(new Date).toISOString(),autoBackupCount:(t.autoBackupCount||0)+1}),t.notifications.onSuccess&&new ge.Notice(`✅ 自动备份完成 (${this.formatFileSize(n.size)})`),_e.debug(`⏰ 自动备份完成: ${n.id}`),!0}catch(n){return _e.error("⏰ 自动备份失败:",n),t.notifications.onFailure&&new ge.Notice(`❌ 自动备份失败: ${n instanceof Error?n.message:"未知错误"}`,5e3),!1}}shouldCreateStartupBackup(){const e=this.getConfig();if(!e.lastAutoBackupTime)return!0;const t=new Date(e.lastAutoBackupTime).getTime();return Date.now()-t>=60*e.intervalHours*60*1e3}shouldCreateTimedBackup(){const e=this.getConfig();if(!e.lastAutoBackupTime)return!0;const t=new Date(e.lastAutoBackupTime).getTime();return Date.now()-t>=60*e.intervalHours*60*1e3}async getCardCount(){try{const e=this.plugin.dataStorage;if(!e)return 0;const t=await e.getCards();return Array.isArray(t)?t.length:0}catch(e){return _e.error("获取卡片数量失败:",e),0}}async updateCardCount(){this.lastCardCount=await this.getCardCount()}formatFileSize(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(2)} KB`:`${(e/1024/1024).toFixed(2)} MB`}getNextBackupTime(){const e=this.getConfig();if(!e.enabled||!e.lastAutoBackupTime)return null;const t=new Date(e.lastAutoBackupTime),n=60*e.intervalHours*60*1e3;return new Date(t.getTime()+n)}getStatus(){const e=this.getConfig();return{isRunning:this.isRunning,nextBackupTime:this.getNextBackupTime(),lastBackupTime:e.lastAutoBackupTime||null,totalAutoBackups:e.autoBackupCount||0}}}},Symbol.toStringTag,{value:"Module"}));const X_e=Object.freeze(Object.defineProperty({__proto__:null,BlockLinkManager:class{constructor(e){this.app=e}async createBlockLinkForSelection(e,t){try{_e.debug("🔗 [BlockLinkManager] 开始创建块链接");let n=this.app.workspace.getActiveFile();if(t&&(!n||n.basename!==t)){const e=this.app.vault.getMarkdownFiles().find(e=>e.basename===t||e.path===t);e&&(n=e,_e.debug("🔗 [BlockLinkManager] 使用提示的源文件:",e.path))}if(!n){_e.warn("⚠️ [BlockLinkManager] 没有找到源文件，生成基础来源信息");const n=this.generateUniqueIdentifier(e,"unknown");return{success:!1,blockLinkInfo:{blockId:Hu(),blockLink:"",sourceFile:"",sourceDocument:t||"unknown",uniqueIdentifier:n,content:e},error:"没有找到活动的源文件，无法创建块链接"}}const i=this.generateUniqueIdentifier(e,n.basename),a=Hu();_e.debug("🔗 [BlockLinkManager] 生成标识符:",{uniqueIdentifier:i,blockId:a,file:n.basename});const r=await this.findExistingBlockLink(e,n);if(r)return _e.debug("✅ [BlockLinkManager] 找到现有块链接:",r.blockLink),{success:!0,blockLinkInfo:r};_e.debug("🔗 [BlockLinkManager] 开始在源文档中创建块链接:",{file:n.path,blockId:a,contentLength:e.length});const s=await this.createBlockLinkInDocument(n,e,a,i);return s?(_e.debug("✅ [BlockLinkManager] 块链接创建成功:",{blockLink:s.blockLink,lineNumber:s.lineNumber,sourceFile:s.sourceFile}),{success:!0,blockLinkInfo:s}):(_e.error("❌ [BlockLinkManager] 块链接创建失败，返回基础信息"),{success:!1,blockLinkInfo:{blockId:a,blockLink:`[[${n.basename}]]`,sourceFile:n.path,sourceDocument:n.basename,uniqueIdentifier:i,content:e},error:"无法在源文档中创建块链接，可能是权限问题或文档格式问题"})}catch(n){_e.error("❌ [BlockLinkManager] 创建块链接失败:",n);const t=this.generateUniqueIdentifier(e,"error");return{success:!0,blockLinkInfo:{blockId:Hu(),blockLink:"",sourceFile:"",sourceDocument:"unknown",uniqueIdentifier:t,content:e}}}}generateUniqueIdentifier(e,t){return`tuanki-${t}-${e.substring(0,50).replace(/\s+/g,"-").replace(/[^\w\-]/g,"")}-${Date.now().toString(36)}`}async findExistingBlockLink(e,t){try{const n=(await this.app.vault.read(t)).split("\n");for(let i=0;i<n.length;i++){const a=n[i];if(a.includes(e.substring(0,30))){const e=a.match(/\^([a-zA-Z0-9-]+)$/);if(e){const n=e[1];return{blockId:n,blockLink:`[[${t.basename}#^${n}]]`,sourceFile:t.path,sourceDocument:t.basename,lineNumber:i+1,uniqueIdentifier:`existing-${n}`,content:a.replace(/\s*\^[a-zA-Z0-9-]+$/,"").trim()}}}}return null}catch(n){return _e.error("❌ [BlockLinkManager] 查找现有块链接失败:",n),null}}async createBlockLinkInDocument(e,t,n,i){try{_e.debug("🔗 [BlockLinkManager] 开始在文档中创建块链接:",{fileName:e.basename,filePath:e.path,blockId:n,selectedTextLength:t.length,selectedTextPreview:`${t.substring(0,100)}...`});const a=await this.app.vault.read(e),r=a.split("\n");_e.debug("🔗 [BlockLinkManager] 文件内容读取成功:",{totalLines:r.length,fileSize:a.length});let s=-1,o=0;const l=t.trim(),c=l.includes("\n");let d;if(c){const e=l.split("\n")[0].trim();d=e.substring(0,Math.min(50,e.length)),_e.debug("🔗 [BlockLinkManager] 检测到多行文本，使用第一行作为搜索依据")}else d=l.substring(0,Math.min(50,l.length));_e.debug("🔗 [BlockLinkManager] 开始搜索匹配行:",{isMultiline:c,searchPreview:d,searchTextLength:l.length});for(let e=0;e<r.length;e++){const t=r[e],n=t.trim(),i=d.trim();if(n.includes(i)||i.length>10&&n.includes(i.substring(0,20))){const n=this.calculateMatchLength(t,l);_e.debug(`🔗 [BlockLinkManager] 找到潜在匹配行 ${e+1}:`,{lineContent:`${t.substring(0,50)}...`,matchLength:n,currentBestMatch:o}),n>o&&(o=n,s=e,_e.debug(`🔗 [BlockLinkManager] 更新最佳匹配行: ${e+1}, 匹配度: ${n}`))}}if(-1===s){_e.debug("🔗 [BlockLinkManager] 未找到匹配行，不修改源文档，返回文档链接");return{blockId:n,blockLink:`[[${e.basename}]]`,sourceFile:e.path,sourceDocument:e.basename,lineNumber:void 0,uniqueIdentifier:i,content:t}}{const t=r[s];if(_e.debug("🔗 [BlockLinkManager] 找到目标行:",{lineIndex:s,lineNumber:s+1,lineContent:t,hasExistingBlockId:t.includes("^")}),t.includes("^")){const e=t.match(/\^([a-zA-Z0-9-]+)$/);e?(n=e[1],_e.debug("🔗 [BlockLinkManager] 使用现有块ID:",n)):_e.warn("⚠️ [BlockLinkManager] 检测到^符号但无法提取块ID，行内容:",t)}else{const i=`${t} ^${n}`;r[s]=i;const a=r.join("\n");_e.debug("🔗 [BlockLinkManager] 准备修改现有行:",{originalLine:t,newLine:i,fileName:e.basename}),await this.app.vault.modify(e,a),_e.debug("✅ [BlockLinkManager] 现有行修改成功，块ID已添加")}}const u=`[[${e.basename}#^${n}]]`,h={blockId:n,blockLink:u,sourceFile:e.path,sourceDocument:e.basename,lineNumber:s+1,uniqueIdentifier:i,content:t};return _e.debug("✅ [BlockLinkManager] 块链接信息生成完成:",{blockLink:u,sourceDocument:e.basename,lineNumber:s+1,uniqueIdentifier:i}),h}catch(a){return _e.error("❌ [BlockLinkManager] 创建块链接失败:",{fileName:e.basename,filePath:e.path,error:a instanceof Error?a.message:String(a),errorStack:a instanceof Error?a.stack:void 0,blockId:n,selectedTextLength:t.length}),null}}calculateMatchLength(e,t){const n=e.toLowerCase().split(/\s+/),i=t.toLowerCase().split(/\s+/);let a=0;for(const r of i)n.some(e=>e.includes(r)||r.includes(e))&&a++;return a}generateSourceInfo(e){return`\n\n---\n\n### 📎 来源信息\n\n${[`**来源文档**: ${e.blockLink}`,`**唯一标识**: \`${e.uniqueIdentifier}\``,`**创建时间**: ${(new Date).toLocaleString()}`].join("\n")}`}async checkUniqueIdentifierExists(e){try{return!1}catch(t){return _e.error("❌ [BlockLinkManager] 检查唯一标识符失败:",t),!1}}}},Symbol.toStringTag,{value:"Module"})),J_e=class e{constructor(e,t={}){oe(this,"plugin"),oe(this,"app"),oe(this,"config"),oe(this,"components",new Map),this.plugin=e,this.app=e.app,this.config={debug:!1,maxModals:3,...t}}static getInstance(t,n){if(!e.instance&&t&&(e.instance=new e(t,n)),!e.instance)throw new Error("UIManager not initialized");return e.instance}register(e,t,n,i,a){this.components.has(e)&&(this.log(`Component ${e} already exists, destroying old instance`),this.destroy(e)),this.components.set(e,{type:t,instance:n,container:i,created:Date.now(),metadata:a}),this.log(`Registered ${t}: ${e}`)}get(e){return this.components.get(e)}has(e){return this.components.has(e)}getByType(e){return Array.from(this.components.values()).filter(t=>t.type===e)}destroy(e){var t;const n=this.components.get(e);if(!n)return!1;try{return(null==(t=n.instance)?void 0:t.$destroy)&&n.instance.$destroy(),n.container&&n.container.remove(),this.components.delete(e),this.log(`Destroyed ${n.type}: ${e}`),!0}catch(i){return _e.error(`Failed to destroy ${e}:`,i),!1}}destroyByType(e){const t=this.getByType(e);let n=0;for(const i of t){const e=this.findComponentId(i);e&&this.destroy(e)&&n++}return n}destroyAll(){this.log("Destroying all components...");const e=Array.from(this.components.keys());for(const t of e)this.destroy(t);this.log("All components destroyed")}focus(e){const t=this.components.get(e);return!!(null==t?void 0:t.container)&&(t.container.scrollIntoView({behavior:"smooth",block:"center"}),t.container.style.animation="pulse 0.5s ease-in-out",setTimeout(()=>{t.container&&(t.container.style.animation="")},500),!0)}getStats(){const e={total:this.components.size,byType:{}};for(const t of this.components.values())e.byType[t.type]=(e.byType[t.type]||0)+1;return e}cleanupStale(e=3e5){const t=Date.now();let n=0;for(const[i,a]of this.components.entries())t-a.created>e&&(this.log(`Cleaning up stale component: ${i}`),this.destroy(i)&&n++);return n}findComponentId(e){for(const[t,n]of this.components.entries())if(n===e)return t}log(...e){this.config.debug&&_e.debug("[UIManager]",...e)}static reset(){e.instance&&(e.instance.destroyAll(),e.instance=null)}};oe(J_e,"instance",null);let eCe=J_e;const tCe=Object.freeze(Object.defineProperty({__proto__:null,UIManager:eCe},Symbol.toStringTag,{value:"Module"}));function nCe(e,t,n,i,a,r,s){e.stopPropagation(),$n(t,!bi(t)),bi(t)&&($n(n,i().findIndex(e=>e.id===a()),!0),-1===bi(n)&&$n(n,0),r(),requestAnimationFrame(()=>{var e;null==(e=bi(s))||e.focus()}))}function iCe(e,t,n,i,a,r,s){var o;switch(e.key){case"ArrowDown":e.preventDefault(),$n(t,Math.min(bi(t)+1,n().length-1),!0),i();break;case"ArrowUp":e.preventDefault(),$n(t,Math.max(bi(t)-1,0),!0),i();break;case"Enter":e.preventDefault(),n()[bi(t)]&&a(n()[bi(t)]);break;case"Escape":e.preventDefault(),$n(r,!1),null==(o=bi(s))||o.focus()}}var aCe=la('<span class="dropdown-label svelte-y6pmo1"> </span>'),rCe=e=>{e.stopPropagation()},sCe=e=>{e.stopPropagation(),e.preventDefault()},oCe=(e,t,n)=>{e.stopPropagation(),t(bi(n))},lCe=(e,t,n)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t(bi(n)))},cCe=la('<span class="dropdown-item-check svelte-y6pmo1">✓</span>'),dCe=la('<div role="option" tabindex="-1"> <!></div>'),uCe=la('<div class="dropdown-panel svelte-y6pmo1" role="listbox" tabindex="-1"></div>'),hCe=la('<div><!> <button type="button" aria-haspopup="listbox"><span class="dropdown-button-text svelte-y6pmo1"> </span> <span>▼</span></button> <!></div>');function pCe(e,t){if(new.target)return Er({component:pCe,...e});kt(t,!0);let n=Ar(t,"label",7),i=Ar(t,"value",15),a=Ar(t,"options",7),r=Ar(t,"onchange",7),s=Ar(t,"className",7,""),o=Pn(!1),l=Pn(null),c=Pn(null),d=Pn(0),u=Pn(Ot({top:0,left:0,width:0})),h=In(()=>a().find(e=>e.id===i())||a()[0]);function p(e){var t;i(e.id),r()(e.id),$n(o,!1),null==(t=bi(l))||t.focus()}function g(){if(!bi(c))return;const e=bi(c).querySelectorAll(".dropdown-item")[bi(d)];e&&e.scrollIntoView({block:"nearest"})}function v(){bi(o)&&(_e.debug("[CustomDropdown] 检测到模态窗拖拽，关闭下拉面板"),$n(o,!1))}function f(e){if(!bi(o))return;const t=e.target;bi(l)&&bi(l).contains(t)||bi(c)&&bi(c).contains(t)||$n(o,!1)}Ti(()=>{const e=a().findIndex(e=>e.id===i());-1!==e&&$n(d,e,!0)}),Pr(()=>(document.addEventListener("click",f),document.addEventListener("modal-drag-start",v),()=>{document.removeEventListener("click",f),document.removeEventListener("modal-drag-start",v)}));var m={get label(){return n()},set label(e){n(e),hn()},get value(){return i()},set value(e){i(e),hn()},get options(){return a()},set options(e){a(e),hn()},get onchange(){return r()},set onchange(e){r(e),hn()},get className(){return s()},set className(e=""){s(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},y=hCe(),b=Gt(y),w=e=>{var t=aCe(),i=Gt(t,!0);zt(t),zi(()=>va(i,n())),pa(e,t)};xa(b,e=>{n()&&e(w)});var k=Kt(b,2);let S;k.__click=[nCe,o,d,a,i,function(){if(!bi(l))return;const e=bi(l).getBoundingClientRect();$n(u,{top:e.bottom+4,left:e.left,width:e.width},!0)},c];var x=Gt(k),_=Gt(x,!0);zt(x);var C=Kt(x,2);let I;zt(k),kr(k,e=>$n(l,e),()=>bi(l));var D=Kt(k,2),T=e=>{var t=uCe();let n;t.__keydown=[iCe,d,a,g,p,o,l],t.__mousedown=[rCe],Ca(t,21,a,_a,(e,t,n)=>{var a=dCe();let r;a.__mousedown=[sCe],a.__click=[oCe,p,t],a.__keydown=[lCe,p,t];var s=Gt(a),o=Kt(s),l=e=>{pa(e,cCe())};xa(o,e=>{bi(t).id===i()&&e(l)}),zt(a),zi(e=>{var n;r=Fa(a,1,"dropdown-item svelte-y6pmo1",null,r,e),er(a,"aria-selected",bi(t).id===i()),va(s,`${null!=(n=bi(t).name)?n:""} `)},[()=>({selected:bi(t).id===i(),highlighted:n===bi(d)})]),na("mouseenter",a,()=>{$n(d,n,!0)}),pa(e,a)}),zt(t),kr(t,e=>$n(c,e),()=>bi(c)),zi(e=>n=ja(t,"",n,e),[()=>{var e,t,n;return{top:`${null!=(e=bi(u).top)?e:""}px`,left:`${null!=(t=bi(u).left)?t:""}px`,"min-width":`${null!=(n=bi(u).width)?n:""}px`}}]),pa(e,t)};return xa(D,e=>{bi(o)&&e(T)}),zt(y),zi((e,t)=>{var i,a;Fa(y,1,`custom-dropdown ${null!=(i=s())?i:""}`,"svelte-y6pmo1"),S=Fa(k,1,"dropdown-button svelte-y6pmo1",null,S,e),er(k,"aria-label",n()),er(k,"aria-expanded",bi(o)),va(_,(null==(a=bi(h))?void 0:a.name)||"请选择"),I=Fa(C,1,"dropdown-button-arrow svelte-y6pmo1",null,I,t)},[()=>({open:bi(o)}),()=>({open:bi(o)})]),pa(e,y),St(m)}ia(["click","keydown","mousedown"]),ia(["click"]);var gCe=la('<div class="loading-indicator svelte-dhoqys"><!> </div>'),vCe=la('<button class="close-btn svelte-dhoqys" aria-label="关闭" title="关闭"><!></button>'),fCe=la('<div class="editor-header svelte-dhoqys"><div class="header-left svelte-dhoqys"><h3 class="svelte-dhoqys"> </h3> <!></div> <div class="header-right svelte-dhoqys"><!> <!></div></div>'),mCe=la('<div class="editor-placeholder svelte-dhoqys"><!> <p class="svelte-dhoqys">点击这里开始编辑卡片内容</p> <small class="svelte-dhoqys">支持Markdown语法，会自动解析为不同题型</small></div>'),yCe=la('<div class="editor-loading svelte-dhoqys"><!> <p class="svelte-dhoqys">正在初始化编辑器...</p></div>'),bCe=la('<div class="error-message svelte-dhoqys"><!> <span> </span></div>'),wCe=la("<!> 取消",1),kCe=la("<!> ",1),SCe=la('<div class="editor-footer svelte-dhoqys"><!> <!></div>'),xCe=la('<div class="inline-card-editor svelte-dhoqys"><!> <div class="editor-content svelte-dhoqys"><div class="editor-container-wrapper svelte-dhoqys"><div class="obsidian-editor-container svelte-dhoqys"><!> <!></div></div> <!></div> <!></div>');function _Ce(e,t){if(new.target)return Er({component:_Ce,...e});kt(t,!0);let n=Ar(t,"card",15),i=Ar(t,"plugin",7),a=Ar(t,"editorPoolManager",7),r=Ar(t,"mode",7),s=Ar(t,"isNew",7,!1),o=Ar(t,"displayMode",7,"inline"),l=Ar(t,"selectedDeck",7,null),c=Ar(t,"selectedDeckId",31,()=>{var e;return Ot(n().deckId||(null==(e=l())?void 0:e.id)||"")}),d=Ar(t,"showHeader",7,!0),u=Ar(t,"showFooter",7,!0),h=Ar(t,"isPinned",7,!1),p=Ar(t,"onSave",7),g=Ar(t,"onCancel",7),v=Ar(t,"onClose",7),f=Ar(t,"decks",23,()=>[]),m=Ar(t,"propsDecks",23,()=>[]),y=Ar(t,"propsFieldTemplates",23,()=>[]),b=Pn(null),w=Pn(!1),k=Pn(null),S=Pn(null),x=Pn(!1),_=Pn(null);function C(e){_e.debug("[InlineCardEditor] 编辑器保存回调触发"),D()}function I(){_e.debug("[InlineCardEditor] 编辑器取消回调触发"),T()}async function D(){var e,t;if(!bi(x)&&a()&&bi(S))try{$n(x,!0),_e.debug("[InlineCardEditor] 🔄 开始保存卡片, sessionId:",bi(S));const r=await a().finishEditing(bi(S),!1,{isStudySession:h(),targetCardId:n().uuid});if(!r.success||!r.updatedCard)throw new Error(r.error||"获取编辑器内容失败");const s={...r.updatedCard,deckId:c(),modified:(new Date).toISOString()};if(_e.debug("[InlineCardEditor] ✅ 获取到编辑器内容, 长度:",(null==(e=s.content)?void 0:e.length)||0),i().dataStorage){_e.debug("[InlineCardEditor] 💾 开始保存到数据库...");const e=await i().dataStorage.saveCard(s);if(!e.success)throw new Error(e.error||"数据库保存失败");_e.debug("[InlineCardEditor] ✅ 数据库保存成功, UUID:",null==(t=e.data)?void 0:t.uuid)}else _e.warn("[InlineCardEditor] ⚠️ dataStorage未初始化，跳过数据库保存");p()&&p()(s)}catch(r){_e.error("[InlineCardEditor] ❌ 保存失败:",r),new ge.Notice("⚠️ 保存失败: "+(r instanceof Error?r.message:"未知错误"))}finally{$n(x,!1)}}function T(){var e;bi(k)&&(bi(k)(),$n(k,null),$n(w,!1)),null==(e=g())||e()}Ti(()=>{bi(b)&&!bi(w)&&async function(){if(n()&&a()&&bi(b))if(bi(w))_e.debug("[InlineCardEditor] 编辑器已初始化，跳过");else try{$n(x,!0),bi(b).innerHTML="";const e=n().uuid,t=await a().createEditorSession(n());if(!t.success)throw new Error(t.error||"文件池文件创建失败");_e.debug("[InlineCardEditor] 文件池文件创建成功:",t.filePath);const i=await a().createEmbeddedEditor(bi(b),e,C,I);if(!i.success)throw new Error(i.error||"编辑器创建失败");$n(k,i.cleanup||null,!0),$n(S,e,!0),$n(w,!0),_e.debug("[InlineCardEditor] 编辑器初始化成功")}catch(e){_e.error("[InlineCardEditor] 编辑器初始化失败:",e),$n(_,{message:e instanceof Error?e.message:"编辑器初始化失败",timestamp:Date.now()},!0),new ge.Notice("编辑器初始化失败: "+(e instanceof Error?e.message:"未知错误"))}finally{$n(x,!1)}else _e.error("[InlineCardEditor] 编辑器初始化失败：缺少必要参数")}()}),Ti(()=>()=>{bi(k)&&bi(k)()});var M={updateEditorContent:async function(e){try{if(_e.debug("[InlineCardEditor] 📝 快捷键填充内容:",{contentLength:(null==e?void 0:e.length)||0,contentPreview:null==e?void 0:e.substring(0,50)}),!a()||!bi(S))return void _e.error("[InlineCardEditor] ❌ 编辑器未初始化，无法更新内容");const t=await a().updateSessionContent(bi(S),e);t.success?(_e.debug("[InlineCardEditor] ✅ 编辑器内容已更新（快捷键填充）"),n(n().content=e,!0)):_e.error("[InlineCardEditor] ❌ 更新编辑器内容失败:",t.error)}catch(t){_e.error("[InlineCardEditor] ❌ updateEditorContent执行失败:",t)}},resetForNewCard:async function(e){if(_e.debug("[InlineCardEditor] 🔄 钉住模式：准备下一张卡片",{hasNewCard:!!e,newCardUuid:null==e?void 0:e.uuid}),a()&&bi(w)&&bi(S))try{if(e){const t=await a().updateSessionCard(bi(S),e);t.success?_e.debug("[InlineCardEditor] ✅ 会话卡片对象已更新，编辑器已清空"):_e.error("[InlineCardEditor] ❌ 更新会话卡片对象失败:",t.error)}else{const e=await a().updateSessionContent(bi(S),"");e.success?_e.debug("[InlineCardEditor] ✅ 编辑器内容已清空"):_e.error("[InlineCardEditor] ❌ 清空编辑器内容失败:",e.error)}}catch(t){_e.error("[InlineCardEditor] ❌ 重置编辑器失败:",t)}else _e.warn("[InlineCardEditor] ⚠️ 编辑器未初始化，需要重新初始化")},get card(){return n()},set card(e){n(e),hn()},get plugin(){return i()},set plugin(e){i(e),hn()},get editorPoolManager(){return a()},set editorPoolManager(e){a(e),hn()},get mode(){return r()},set mode(e){r(e),hn()},get isNew(){return s()},set isNew(e=!1){s(e),hn()},get displayMode(){return o()},set displayMode(e="inline"){o(e),hn()},get selectedDeck(){return l()},set selectedDeck(e=null){l(e),hn()},get selectedDeckId(){return c()},set selectedDeckId(e=n.deckId||(null==l?void 0:l.id)||""){c(e),hn()},get showHeader(){return d()},set showHeader(e=!0){d(e),hn()},get showFooter(){return u()},set showFooter(e=!0){u(e),hn()},get isPinned(){return h()},set isPinned(e=!1){h(e),hn()},get onSave(){return p()},set onSave(e){p(e),hn()},get onCancel(){return g()},set onCancel(e){g(e),hn()},get onClose(){return v()},set onClose(e){v(e),hn()},get decks(){return f()},set decks(e=[]){f(e),hn()},get propsDecks(){return m()},set propsDecks(e=[]){m(e),hn()},get propsFieldTemplates(){return y()},set propsFieldTemplates(e=[]){y(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},A=xCe(),E=Gt(A),z=e=>{var t=fCe(),n=Gt(t),i=Gt(n),a=Gt(i,!0);zt(i);var s=Kt(i,2),o=e=>{var t=gCe(),n=Gt(t);Ng(n,{name:"loader",size:16});var i=Kt(n);zt(t),zi(()=>va(i," "+(bi(w)?"保存中...":"初始化编辑器..."))),pa(e,t)};xa(s,e=>{bi(x)&&e(o)}),zt(n);var l=Kt(n,2),d=Gt(l),u=e=>{pCe(e,{label:"牌组:",get options(){return f()},onchange:e=>{c(e),_e.debug("[InlineCardEditor] 牌组选择变更:",c())},get value(){return c()},set value(e){c(e)}})};xa(d,e=>{f()&&f().length>0&&e(u)});var h=Kt(d,2),p=e=>{var t=vCe();t.__click=function(...e){var t;null==(t=v())||t.apply(this,e)},Ng(Gt(t),{name:"x",size:16}),zt(t),pa(e,t)};xa(h,e=>{v()&&e(p)}),zt(l),zt(t),zi(()=>va(a,"create"===r()?"创建卡片":"编辑卡片")),pa(e,t)};xa(E,e=>{d()&&e(z)});var P=Kt(E,2),R=Gt(P),$=Gt(R),O=Gt($),L=e=>{var t=mCe();Ng(Gt(t),{name:"edit",size:24}),Pt(4),zt(t),pa(e,t)};xa(O,e=>{bi(w)||bi(x)||e(L)});var N=Kt(O,2),F=e=>{var t=yCe();Ng(Gt(t),{name:"loader",size:24}),Pt(2),zt(t),pa(e,t)};xa(N,e=>{bi(x)&&!bi(w)&&e(F)}),zt($),kr($,e=>$n(b,e),()=>bi(b)),zt(R);var B=Kt(R,2),j=e=>{var t=bCe(),n=Gt(t);Ng(n,{name:"alert-circle",size:16});var i=Kt(n,2),a=Gt(i,!0);zt(i),zt(t),zi(()=>va(a,bi(_).message)),pa(e,t)};xa(B,e=>{bi(_)&&e(j)}),zt(P);var U=Kt(P,2),V=e=>{var t=SCe(),n=Gt(t);Hg(n,{variant:"secondary",onclick:T,get disabled(){return bi(x)},children:(e,t)=>{var n=wCe();Ng(Qt(n),{name:"x",size:16}),Pt(),pa(e,n)},$$slots:{default:!0}});var i=Kt(n,2);{let e=In(()=>bi(x)||!bi(w));Hg(i,{variant:"primary",onclick:D,get disabled(){return bi(e)},get loading(){return bi(x)},children:(e,t)=>{var n=kCe(),i=Qt(n);{let e=In(()=>"create"===r()?"plus":"save");Ng(i,{get name(){return bi(e)},size:16})}var a=Kt(i);zi(()=>va(a," "+("create"===r()?"创建":"保存"))),pa(e,n)},$$slots:{default:!0}})}zt(t),pa(e,t)};return xa(U,e=>{u()&&e(V)}),zt(A),pa(e,A),St(M)}function CCe(e,t){$n(t,!bi(t)),_e.debug("[CreateCardModal] 🔄 钉住状态切换:",{isPinned:bi(t),type:typeof bi(t)}),new ge.Notice(bi(t)?"📍 已钉住：可连续添加卡片":"📌 已取消钉住")}ia(["click"]);var ICe=la("<button> </button> <!>",1);ia(["click"]);const DCe=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);let i=Ar(n,"open",15),a=Ar(n,"onModalClose",7),r=Ar(n,"card",7),s=Ar(n,"plugin",7),o=Ar(n,"editorPoolManager",7),l=Ar(n,"decks",7),c=Ar(n,"templates",7),d=Ar(n,"onSave",7),u=Ar(n,"onCancel",7),h=Pn(void 0),p=Pn(Ot(l())),g=Pn(Ot(c())),v=Pn(Ot(r().deckId)),f=Pn("official-qa"),m=Pn(!1),y=null;function b(){_e.debug("[CreateCardModal] 关闭"),"function"==typeof u()&&u()(),"function"==typeof a()&&a()()}async function w(e){var t,n;_e.debug("[CreateCardModal] 🔍 保存卡片回调触发",{uuid:e.uuid,deckId:e.deckId,templateId:e.templateId,contentLength:(null==(t=e.content)?void 0:t.length)||0,fieldsKeys:Object.keys(e.fields||{}),isPinned:bi(m),isPinnedType:typeof bi(m)});try{if(!(e.content&&e.content.trim().length>0))return _e.warn("[CreateCardModal] ❌ 卡片内容为空，拒绝保存",{content:null==(n=e.content)?void 0:n.substring(0,200)}),void new ge.Notice("❌ 卡片内容不能为空，请添加内容后再保存",4e3);if(_e.debug("[CreateCardModal] ✅ 内容验证通过（content 长度:",e.content.length,"）"),s().app.workspace.trigger("tuanki:card-created",e),_e.debug("[CreateCardModal] 新卡片已创建:",e),"function"==typeof d()&&d()(e),!0===bi(m)){_e.debug("[CreateCardModal] 📍 钉住模式激活：准备下一张卡片",{isPinned:bi(m),willClose:!1});const{generateUUID:e}=await Promise.resolve().then(()=>Xu),t={uuid:e(),deckId:bi(v)||r().deckId,templateId:bi(f),type:Kr.Basic,content:"",tags:[],fsrs:{state:0,difficulty:0,stability:0,due:(new Date).toISOString(),scheduledDays:0,lapses:0,reps:0,lastReview:void 0,elapsedDays:0,retrievability:.9},stats:{totalReviews:0,totalTime:0,averageTime:0,memoryRate:0},created:(new Date).toISOString(),modified:(new Date).toISOString()};r(t),bi(h)&&"function"==typeof bi(h).resetForNewCard&&(await bi(h).resetForNewCard(t),_e.debug("[CreateCardModal] ✅ 编辑器已重置，新卡片对象已同步")),new ge.Notice("✅ 卡片已保存，可以继续添加")}else _e.debug("[CreateCardModal] ⚠️ 普通模式激活：关闭模态窗",{isPinned:bi(m),willClose:!0}),"function"==typeof a()&&a()()}catch(i){_e.error("[CreateCardModal] 处理卡片保存回调失败:",i),new ge.Notice("处理卡片保存时发生错误")}}Pr(()=>{_e.debug("[CreateCardModal] 组件挂载，数据已预加载:",{decksCount:bi(p).length,templatesCount:bi(g).length,isPinned:bi(m),isPinnedType:typeof bi(m)}),y=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e instanceof HTMLElement){[".menu",".suggestion-container",".modal",".popover"].forEach(t=>{var n,i,a;if((null==(n=e.matches)?void 0:n.call(e,t))||(null==(i=e.querySelector)?void 0:i.call(e,t))){((null==(a=e.matches)?void 0:a.call(e,t))?[e]:Array.from(e.querySelectorAll(t))).forEach(e=>{e.style.zIndex="99999999",_e.debug("[CreateCardModal] 修复菜单 z-index:",t)})}})}})})}),y.observe(document.body,{childList:!0,subtree:!0}),_e.debug("[CreateCardModal] 全局菜单观察器已启动")}),Rr(()=>{y&&(y.disconnect(),y=null,_e.debug("[CreateCardModal] 全局菜单观察器已清理"))});var k={updateContent:async function(e,t){try{_e.debug("[CreateCardModal] 📝 快捷键填充内容:",{content:e.substring(0,50)+"...",isPinned:bi(m),hasMetadata:!!t}),bi(h)&&bi(h).updateEditorContent?(await bi(h).updateEditorContent(e),_e.debug("[CreateCardModal] ✅ 编辑器内容已填充")):_e.warn("[CreateCardModal] ⚠️ InlineCardEditor 实例未就绪"),t&&(r().sourceFile=t.sourceFile,r().sourceBlock=t.sourceBlock,_e.debug("[CreateCardModal] ✅ 溯源信息已更新")),_e.debug("[CreateCardModal] ✅ 内容填充完成，模态窗保持打开")}catch(n){_e.error("[CreateCardModal] 更新内容失败:",n),new ge.Notice("❌ 更新内容失败，请重试")}},get open(){return i()},set open(e){i(e),hn()},get onModalClose(){return a()},set onModalClose(e){a(e),hn()},get card(){return r()},set card(e){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},get editorPoolManager(){return o()},set editorPoolManager(e){o(e),hn()},get decks(){return l()},set decks(e){l(e),hn()},get templates(){return c()},set templates(e){c(e),hn()},get onSave(){return d()},set onSave(e){d(e),hn()},get onCancel(){return u()},set onCancel(e){u(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)};{const e=e=>{var t=ICe(),n=Qt(t);let i;n.__click=[CCe,m];var a=Gt(n,!0);zt(n);var r=Kt(n,2),s=e=>{pCe(e,{label:"牌组:",get options(){return bi(p)},onchange:e=>{$n(v,e,!0)},get value(){return bi(v)},set value(e){$n(v,e,!0)}})};xa(r,e=>{bi(p)&&bi(p).length>0&&e(s)}),zi(e=>{i=Fa(n,1,"pin-button svelte-q60c82",null,i,e),er(n,"title",bi(m)?"点击取消钉住":"点击钉住（可连续添加卡片）"),er(n,"aria-label",bi(m)?"取消钉住":"钉住"),va(a,bi(m)?"📍":"📌")},[()=>({pinned:bi(m)})]),pa(e,t)},n=e=>{kr(_Ce(e,{get card(){return r()},get plugin(){return s()},get editorPoolManager(){return o()},mode:"create",isNew:!0,displayMode:"inline",showHeader:!1,showFooter:!0,get isPinned(){return bi(m)},get decks(){return bi(p)},onSave:w,onCancel:b,onClose:b,get selectedDeckId(){return bi(v)},set selectedDeckId(e){$n(v,e,!0)}}),e=>$n(h,e,!0),()=>bi(h))};zx(t,{get plugin(){return s()},title:"创建卡片",closable:!1,maskClosable:!1,keyboard:!0,enableTransparentMask:!0,enableWindowDrag:!0,onClose:b,get open(){return i()},set open(e){i(e)},headerActions:e,children:n,$$slots:{headerActions:!0,default:!0}})}return St(k)}},Symbol.toStringTag,{value:"Module"}));const TCe=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);let i=Ar(n,"open",15),a=Ar(n,"onModalClose",7),r=Ar(n,"card",7),s=Ar(n,"plugin",7),o=Ar(n,"editorPoolManager",7),l=Ar(n,"decks",7),c=Ar(n,"onSave",7),d=Ar(n,"onCancel",7),u=Pn(Ot(l())),h=Pn(Ot(r().deckId)),p=null;function g(){_e.debug("[EditCardModal] 关闭"),"function"==typeof d()&&d()(),"function"==typeof a()&&a()()}async function v(e){var t;_e.debug("[EditCardModal] 🔍 保存卡片回调触发",{uuid:e.uuid,deckId:e.deckId,templateId:e.templateId,contentLength:(null==(t=e.content)?void 0:t.length)||0});try{if(!(e.content&&e.content.trim().length>0))return _e.warn("[EditCardModal] ❌ 卡片内容为空，拒绝保存"),void new ge.Notice("❌ 卡片内容不能为空",4e3);_e.debug("[EditCardModal] ✅ 内容验证通过（content 长度:",e.content.length,"）"),"function"==typeof c()&&c()(e),_e.debug("[EditCardModal] 保存完成，等待 main.ts 关闭模态窗")}catch(n){_e.error("[EditCardModal] 保存卡片失败:",n),new ge.Notice("保存卡片失败")}}function f(e){$n(h,e,!0),_e.debug("[EditCardModal] 牌组变更:",bi(h))}Pr(()=>{_e.debug("[EditCardModal] 组件挂载，数据已预加载:",{decksCount:bi(u).length,cardId:r().uuid}),p=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e instanceof HTMLElement){[".menu",".suggestion-container",".modal",".popover"].forEach(t=>{var n,i,a;if((null==(n=e.matches)?void 0:n.call(e,t))||(null==(i=e.querySelector)?void 0:i.call(e,t))){((null==(a=e.matches)?void 0:a.call(e,t))?[e]:Array.from(e.querySelectorAll(t))).forEach(e=>{e.style.zIndex="99999999",_e.debug("[EditCardModal] 修复菜单 z-index:",t)})}})}})})}),p.observe(document.body,{childList:!0,subtree:!0}),_e.debug("[EditCardModal] 全局菜单观察器已启动")}),Rr(()=>{p&&(p.disconnect(),p=null,_e.debug("[EditCardModal] 全局菜单观察器已清理"))});var m={get open(){return i()},set open(e){i(e),hn()},get onModalClose(){return a()},set onModalClose(e){a(e),hn()},get card(){return r()},set card(e){r(e),hn()},get plugin(){return s()},set plugin(e){s(e),hn()},get editorPoolManager(){return o()},set editorPoolManager(e){o(e),hn()},get decks(){return l()},set decks(e){l(e),hn()},get onSave(){return c()},set onSave(e){c(e),hn()},get onCancel(){return d()},set onCancel(e){d(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)};{const e=e=>{var t=ha(),n=Qt(t),i=e=>{pCe(e,{label:"牌组:",get options(){return bi(u)},onchange:f,get value(){return bi(h)},set value(e){$n(h,e,!0)}})};xa(n,e=>{bi(u)&&bi(u).length>0&&e(i)}),pa(e,t)},n=e=>{_Ce(e,{get card(){return r()},get plugin(){return s()},get editorPoolManager(){return o()},mode:"edit",isNew:!1,displayMode:"inline",showHeader:!1,showFooter:!0,get decks(){return bi(u)},get selectedDeckId(){return bi(h)},onSave:v,onCancel:g,onClose:g})};zx(t,{get plugin(){return s()},title:"编辑卡片",closable:!1,maskClosable:!1,keyboard:!0,enableTransparentMask:!0,enableWindowDrag:!0,onClose:g,get open(){return i()},set open(e){i(e)},headerActions:e,children:n,$$slots:{headerActions:!0,default:!0}})}return St(m)}},Symbol.toStringTag,{value:"Module"}));function MCe(e,t,n,i,a,r,s,o){var l;if(0!==e.button)return;$n(t,Date.now(),!0),$n(n,{x:e.clientX,y:e.clientY},!0),$n(i,!1);const c=null==(l=bi(a))?void 0:l.getBoundingClientRect();c&&$n(r,{x:e.clientX-c.left,y:e.clientY-c.top},!0),document.addEventListener("mousemove",s,{passive:!1}),document.addEventListener("mouseup",o,{passive:!1}),e.preventDefault(),e.stopPropagation()}var ACe=la('<div class="drag-hint svelte-nluh5r">拖拽移动</div>'),ECe=la("<button><!> <!></button>");ia(["mousedown"]);const zCe=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);const i=()=>Ir(Vp,"$tr",a),[a,r]=Dr();let s=Ar(n,"plugin",7),o=Ar(n,"onCreateCard",7),l=In(i),c=Pn(!1),d=Pn(!1),u=Pn(!0),h=Pn(!0),p=Pn(Ot({x:"undefined"!=typeof window?window.innerWidth-80:0,y:"undefined"!=typeof window?window.innerHeight-80:0})),g=Pn(Ot({x:0,y:0})),v=Pn(void 0),f=Pn(0),m=Pn(Ot({x:0,y:0})),y=Pn(!1);const b="tuanki-floating-button-position";let w;function k(){const e=document.body.classList;$n(h,e.contains("theme-dark"),!0)}function S(e){const t=e.clientX-bi(m).x,n=e.clientY-bi(m).y,i=Math.sqrt(t*t+n*n);if(!bi(y)&&i>5&&($n(y,!0),$n(c,!0),document.body.style.userSelect="none",document.body.style.overflow="hidden"),!bi(c))return;e.preventDefault(),e.stopPropagation();const a=e.clientX-bi(g).x,r=e.clientY-bi(g).y,s=window.innerWidth-60-10,o=window.innerHeight-60-10;requestAnimationFrame(()=>{$n(p,{x:Math.max(10,Math.min(a,s)),y:Math.max(10,Math.min(r,o))},!0)})}function x(){const e=!bi(y);bi(c)&&($n(c,!1),function(){w&&clearTimeout(w);try{localStorage.setItem(b,JSON.stringify(bi(p)))}catch(e){_e.warn("Failed to save floating button position:",e)}}(),document.body.style.userSelect="",document.body.style.overflow=""),document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",x),e&&(o()?o()():s().openCreateCardModal({initialContent:"\n\n---div---\n\n"})),$n(c,!1),$n(y,!1),$n(f,0),$n(d,!1)}function _(){const e=window.innerWidth-60-10,t=window.innerHeight-60-10;$n(p,{x:Math.max(10,Math.min(bi(p).x,e)),y:Math.max(10,Math.min(bi(p).y,t))},!0),w&&clearTimeout(w),w=setTimeout(()=>{try{localStorage.setItem(b,JSON.stringify(bi(p)))}catch(e){_e.warn("Failed to save floating button position:",e)}},100)}Pr(()=>{!function(){try{const e=localStorage.getItem(b);if(e){const t=JSON.parse(e);t.x&&t.y&&$n(p,{x:t.x,y:t.y},!0)}}catch(e){_e.warn("Failed to load floating button position:",e)}}(),localStorage.getItem(b)||$n(p,{x:window.innerWidth-80,y:window.innerHeight-80},!0),k();const e=function(){const e=new MutationObserver(()=>{k()});return e.observe(document.body,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()}();return _(),e}),Pr(()=>(window.addEventListener("resize",_),()=>{window.removeEventListener("resize",_)})),Rr(()=>{document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",x),window.removeEventListener("resize",_),w&&clearTimeout(w),document.body.style.overflow="",document.body.style.userSelect="",document.body.style.cursor=""});let C=In(()=>()=>{const e=bi(c)?"scale(1.1)":bi(d)?"scale(1.05)":"scale(1)";return`\n      transform: ${`translate3d(${bi(p).x}px, ${bi(p).y}px, 0)`} ${e};\n      z-index: ${bi(c)?"10001":"10000"};\n      transition: ${bi(c)?"none":"all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)"};\n      will-change: ${bi(c)?"transform":"auto"};\n    `});var I={get plugin(){return s()},set plugin(e){s(e),hn()},get onCreateCard(){return o()},set onCreateCard(e){o(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)},D=ha(),T=Qt(D),M=e=>{var t=ECe();let n;t.__mousedown=[MCe,f,m,y,v,g,S,x];var i=Gt(t);Ng(i,{get name(){return vg},size:24,variant:"primary"});var a=Kt(i,2),r=e=>{pa(e,ACe())};xa(a,e=>{bi(c)&&e(r)}),zt(t),kr(t,e=>$n(v,e),()=>bi(v)),zi((e,i,a,r)=>{n=Fa(t,1,"floating-create-card-button svelte-nluh5r",null,n,e),ja(t,i),er(t,"title",a),er(t,"aria-label",r)},[()=>({dragging:bi(c),hovered:bi(d)}),()=>bi(C)(),()=>bi(l)("ui.newCard"),()=>bi(l)("ui.newCard")]),na("mouseenter",t,()=>$n(d,!0)),na("mouseleave",t,()=>$n(d,!1)),pa(e,t)};xa(T,e=>{bi(u)&&e(M)}),pa(t,D);var A=St(I);return r(),A}},Symbol.toStringTag,{value:"Module"}));class PCe extends ge.Modal{constructor(e,t){super(e),oe(this,"modalComponent",null),oe(this,"maskEditorRef",null),oe(this,"eventCleanup",null),oe(this,"options"),this.options=t,_e.debug("[ImageMaskEditorModal] 初始化",{imageFile:t.imageFile.path,hasMaskData:!!t.initialMaskData})}async onOpen(){_e.debug("[ImageMaskEditorModal] 打开模态窗"),this.modalEl.addClass("tuanki-image-mask-editor-modal"),this.modalEl.style.width="90vw",this.modalEl.style.maxWidth="1200px",this.modalEl.style.height="80vh",this.contentEl.empty(),this.contentEl.addClass("tuanki-image-mask-editor-content");const e=e=>{e.stopPropagation(),e.stopImmediatePropagation()},t=["mousedown","mousemove","mouseup","click","dblclick"];t.forEach(t=>{this.modalEl.addEventListener(t,e,!1)}),this.eventCleanup=()=>{t.forEach(t=>{this.modalEl.removeEventListener(t,e,!1)})};try{const{mount:e}=await Promise.resolve().then(()=>Or),{default:t}=await Promise.resolve().then(()=>pIe);this.modalComponent=e(t,{target:this.contentEl,props:{app:this.app,imageFile:this.options.imageFile,initialMaskData:this.options.initialMaskData,onSave:this.handleSave.bind(this),onCancel:this.handleCancel.bind(this)}}),_e.debug("[ImageMaskEditorModal] Svelte 组件已挂载")}catch(n){_e.error("[ImageMaskEditorModal] 创建组件失败:",n),new ge.Notice("创建图片遮罩编辑器失败"),this.close()}}async onClose(){if(_e.debug("[ImageMaskEditorModal] 关闭模态窗"),this.eventCleanup&&(this.eventCleanup(),this.eventCleanup=null),this.modalComponent)try{const{unmount:e}=await Promise.resolve().then(()=>Or);e(this.modalComponent),this.modalComponent=null,_e.debug("[ImageMaskEditorModal] Svelte 组件已销毁")}catch(e){_e.error("[ImageMaskEditorModal] 销毁组件失败:",e)}this.contentEl.empty()}handleSave(e){_e.debug("[ImageMaskEditorModal] 处理保存",{masksCount:e.masks.length});try{this.options.onSave(e),new ge.Notice(`✅ 遮罩已保存（${e.masks.length} 个遮罩区域）`),this.close()}catch(t){_e.error("[ImageMaskEditorModal] 保存失败:",t),new ge.Notice("❌ 保存遮罩失败")}}handleCancel(){_e.debug("[ImageMaskEditorModal] 处理取消"),this.options.onCancel&&this.options.onCancel(),this.close()}}const RCe=Object.freeze(Object.defineProperty({__proto__:null,ImageMaskEditorModal:PCe},Symbol.toStringTag,{value:"Module"}));function $Ce(e,t,n){var i;t()&&(e.stopPropagation(),e.preventDefault(),confirm("确定要删除这个遮罩吗？")&&(null==(i=n())||i()))}var OCe=da('<rect role="button" tabindex="0" aria-label="遮罩区域"></rect>'),LCe=da('<circle role="button" tabindex="0" aria-label="遮罩区域"></circle>'),NCe=(e,t,n)=>t(e,bi(n).type),FCe=da('<circle r="1.5" class="resize-handle svelte-pjna5y" role="button" tabindex="0" aria-label="调整大小控制点"></circle>'),BCe=da('<g class="resize-handles"></g>'),jCe=da("<!><!>",1);function UCe(e,t){if(new.target)return Er({component:UCe,...e});kt(t,!0);let n=Ar(t,"mask",7),i=Ar(t,"editable",7,!1),a=Ar(t,"selected",7,!1),r=Ar(t,"onUpdate",7),s=Ar(t,"onSelect",7),o=Ar(t,"onDelete",7),l=Pn(!1),c=Pn(!1),d=Pn(null),u=Pn(null),h=null,p=null,g=In(()=>()=>{const{rgb:e,opacity:t}=X7(n().fill||"rgba(0, 0, 0, 0.7)");return{fill:e,"fill-opacity":t.toString(),stroke:a()?"var(--interactive-accent)":"transparent","stroke-width":a()?"0.5":"0"}}),v=In(()=>()=>a()&&i()?"rect"===n().type?function(e){if("rect"!==e.type)throw new Error("getRectResizeHandles只能用于矩形遮罩");const t=e.width||0,n=e.height||0;return[{type:"top-left",x:e.x,y:e.y},{type:"top-center",x:e.x+t/2,y:e.y},{type:"top-right",x:e.x+t,y:e.y},{type:"middle-left",x:e.x,y:e.y+n/2},{type:"middle-right",x:e.x+t,y:e.y+n/2},{type:"bottom-left",x:e.x,y:e.y+n},{type:"bottom-center",x:e.x+t/2,y:e.y+n},{type:"bottom-right",x:e.x+t,y:e.y+n}]}(n()):"circle"===n().type?function(e){if("circle"!==e.type)throw new Error("getCircleResizeHandles只能用于圆形遮罩");const t=e.radius||0;return[{type:"top",x:e.x,y:e.y-t},{type:"right",x:e.x+t,y:e.y},{type:"bottom",x:e.x,y:e.y+t},{type:"left",x:e.x-t,y:e.y}]}(n()):[]:[]);function f(e){if(!h)return{x:0,y:0};const t=h.ownerSVGElement;if(!t)return{x:0,y:0};try{const n=t.getScreenCTM();if(!n)return{x:0,y:0};const i=t.createSVGPoint();i.x=e.clientX,i.y=e.clientY;const a=i.matrixTransform(n.inverse());return{x:a.x/100,y:a.y/100}}catch(n){return{x:0,y:0}}}function m(e){var t;if(!i())return;if(e.stopPropagation(),e.preventDefault(),null==(t=s())||t(),h=e.currentTarget,!h)return;p=e.pointerId,h.setPointerCapture(e.pointerId);const a=f(e);$n(l,!0),$n(u,{x:a.x,y:a.y,maskX:n().x,maskY:n().y},!0)}function y(e,t){var a;if(!i())return;e.stopPropagation(),e.preventDefault(),null==(a=s())||a();const r=e.currentTarget;if(!r)return;p=e.pointerId,r.setPointerCapture(e.pointerId);const o=f(e);$n(c,!0),$n(d,t,!0),$n(u,{x:o.x,y:o.y,maskX:n().x,maskY:n().y,maskRadius:n().radius},!0)}function b(e){if(e.pointerId!==p)return;if(!bi(l)&&!bi(c))return;e.stopPropagation(),e.preventDefault();const t=f(e);bi(l)?function(e){var t;if(!bi(u))return;const i=e.x-bi(u).x,a=e.y-bi(u).y;let s=bi(u).maskX+i,o=bi(u).maskY+a,l=0,c=0,d=1,h=1;if("rect"===n().type)d=1-(n().width||0),h=1-(n().height||0);else if("circle"===n().type){const e=n().radius||0;l=e,c=e,d=1-e,h=1-e}s=Math.max(l,Math.min(d,s)),o=Math.max(c,Math.min(h,o)),null==(t=r())||t({x:s,y:o})}(t):bi(c)&&("rect"===n().type?function(e){var t;if(!bi(u))return;const{maskX:i,maskY:a}=bi(u),s=n().width||0,o=n().height||0,l=window.__maskEditorSensitivity||.08,c=(e.x-bi(u).x)*l,h=(e.y-bi(u).y)*l;let p=i,g=a,v=s,f=o;switch(bi(d)){case"top-left":p=i+c,g=a+h,v=s-c,f=o-h;break;case"top-center":g=a+h,f=o-h;break;case"top-right":g=a+h,v=s+c,f=o-h;break;case"middle-left":p=i+c,v=s-c;break;case"middle-right":v=s+c;break;case"bottom-left":p=i+c,v=s-c,f=o+h;break;case"bottom-center":f=o+h;break;case"bottom-right":v=s+c,f=o+h}const m=.01;if(p=Math.max(0,Math.min(1-m,p)),g=Math.max(0,Math.min(1-m,g)),v=Math.max(m,Math.min(1-p,v)),f=Math.max(m,Math.min(1-g,f)),v<m||f<m)return;null==(t=r())||t({x:p,y:g,width:v,height:f})}(t):"circle"===n().type&&function(e){var t;if(!bi(u))return;const i=bi(u).maskRadius||n().radius||0,a=e.x-bi(u).x,s=e.y-bi(u).y,o=Math.sqrt(a*a+s*s),l=a+s>0?1:-1,c=window.__maskEditorSensitivity||.08,d=i+o*l*c,h=.01,p=Math.min(n().x,n().y,1-n().x,1-n().y),g=Math.max(h,Math.min(p,d));g>=h&&(null==(t=r())||t({radius:g}))}(t))}function w(e){if(e.pointerId===p){if(e.stopPropagation(),e.preventDefault(),e.currentTarget){const n=e.currentTarget;try{n.releasePointerCapture(e.pointerId)}catch(t){}}$n(l,!1),$n(c,!1),$n(d,null),$n(u,null),p=null}}function k(e){w(e)}var S={get mask(){return n()},set mask(e){n(e),hn()},get editable(){return i()},set editable(e=!1){i(e),hn()},get selected(){return a()},set selected(e=!1){a(e),hn()},get onUpdate(){return r()},set onUpdate(e){r(e),hn()},get onSelect(){return s()},set onSelect(e){s(e),hn()},get onDelete(){return o()},set onDelete(e){o(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},x=jCe(),_=Qt(x),C=e=>{var t=OCe();let r,s;t.__pointerdown=m,t.__pointermove=b,t.__pointerup=w,t.__dblclick=[$Ce,i,o],kr(t,e=>h=e,()=>h),zi((e,i,a,o,l,c)=>{er(t,"x",100*n().x),er(t,"y",100*n().y),er(t,"width",100*(n().width||0)),er(t,"height",100*(n().height||0)),er(t,"fill",e),er(t,"fill-opacity",i),er(t,"stroke",a),er(t,"stroke-width",o),r=Fa(t,0,"mask-shape svelte-pjna5y",null,r,l),s=ja(t,"",s,c)},[()=>bi(g)().fill,()=>bi(g)()["fill-opacity"],()=>bi(g)().stroke,()=>bi(g)()["stroke-width"],()=>({editable:i(),selected:a(),dragging:bi(l)}),()=>({cursor:i()?bi(l)?"move":"pointer":"default","touch-action":"none"})]),na("pointercancel",t,k),pa(e,t)},I=e=>{var t=ha(),r=Qt(t),s=e=>{var t=LCe();let r,s;t.__pointerdown=m,t.__pointermove=b,t.__pointerup=w,t.__dblclick=[$Ce,i,o],kr(t,e=>h=e,()=>h),zi((e,i,a,o,l,c)=>{er(t,"cx",100*n().x),er(t,"cy",100*n().y),er(t,"r",100*(n().radius||0)),er(t,"fill",e),er(t,"fill-opacity",i),er(t,"stroke",a),er(t,"stroke-width",o),r=Fa(t,0,"mask-shape svelte-pjna5y",null,r,l),s=ja(t,"",s,c)},[()=>bi(g)().fill,()=>bi(g)()["fill-opacity"],()=>bi(g)().stroke,()=>bi(g)()["stroke-width"],()=>({editable:i(),selected:a(),dragging:bi(l)}),()=>({cursor:i()?bi(l)?"move":"pointer":"default","touch-action":"none"})]),na("pointercancel",t,k),pa(e,t)};xa(r,e=>{"circle"===n().type&&e(s)},!0),pa(e,t)};xa(_,e=>{"rect"===n().type?e(C):e(I,!1)});var D=Kt(_),T=e=>{var t=BCe();Ca(t,21,()=>bi(v)(),_a,(e,t)=>{var n=FCe();let i;n.__pointerdown=[NCe,y,t],n.__pointermove=b,n.__pointerup=w,zi(e=>{er(n,"cx",100*bi(t).x),er(n,"cy",100*bi(t).y),i=ja(n,"",i,e)},[()=>{return{cursor:(e=bi(t).type,{"top-left":"nwse-resize","top-center":"ns-resize","top-right":"nesw-resize","middle-left":"ew-resize","middle-right":"ew-resize","bottom-left":"nesw-resize","bottom-center":"ns-resize","bottom-right":"nwse-resize",top:"ns-resize",right:"ew-resize",bottom:"ns-resize",left:"ew-resize"}[e]||"default"),"touch-action":"none"};var e}]),na("pointercancel",n,k),pa(e,n)}),zt(t),pa(e,t)};return xa(D,e=>{a()&&i()&&e(T)}),pa(e,x),St(S)}ia(["pointerdown","pointermove","pointerup","dblclick"]);class VCe{constructor(e=[]){oe(this,"masks",[]),oe(this,"selectedId",null),oe(this,"activeDrawing",null),oe(this,"history",{past:[],future:[]}),this.masks=[...e],this.history={past:[],future:[]}}get selectedMask(){var e;return null!=(e=this.masks.find(e=>e.id===this.selectedId))?e:null}get maskCount(){return this.masks.length}get hasSelection(){return null!==this.selectedId}get canUndo(){return this.history.past.length>0}get canRedo(){return this.history.future.length>0}addMask(e){this.saveHistory(),this.masks=[...this.masks,e],this.selectedId=e.id,_e.debug("[MaskStore] 添加遮罩:",e.id)}addMasks(e){0!==e.length&&(this.saveHistory(),this.masks=[...this.masks,...e],_e.debug("[MaskStore] 批量添加遮罩:",e.length))}updateMask(e,t){const n=this.masks.findIndex(t=>t.id===e);if(-1===n)return void _e.warn("[MaskStore] 未找到遮罩:",e);this.saveHistory();const i=[...this.masks];i[n]={...i[n],...t},this.masks=i,_e.debug("[MaskStore] 更新遮罩:",e)}deleteMask(e){-1!==this.masks.findIndex(t=>t.id===e)?(this.saveHistory(),this.masks=this.masks.filter(t=>t.id!==e),this.selectedId===e&&(this.selectedId=null),_e.debug("[MaskStore] 删除遮罩:",e)):_e.warn("[MaskStore] 未找到遮罩:",e)}clearAll(){0!==this.masks.length&&(this.saveHistory(),this.masks=[],this.selectedId=null,_e.debug("[MaskStore] 清空所有遮罩"))}getMask(e){var t;return null!=(t=this.masks.find(t=>t.id===e))?t:null}setMasks(e){this.masks=[...e],this.selectedId=null}selectMask(e){this.selectedId=e,_e.debug("[MaskStore] 选中遮罩:",e)}clearSelection(){this.selectedId=null,_e.debug("[MaskStore] 取消选中")}selectNext(){if(0===this.masks.length)return;const e=(this.masks.findIndex(e=>e.id===this.selectedId)+1)%this.masks.length;this.selectedId=this.masks[e].id}selectPrevious(){if(0===this.masks.length)return;const e=this.masks.findIndex(e=>e.id===this.selectedId),t=e<=0?this.masks.length-1:e-1;this.selectedId=this.masks[t].id}saveHistory(){this.history||(this.history={past:[],future:[]});const e=[...this.history.past,[...this.masks]],t=e.length>50?e.slice(-50):e;this.history={past:t,future:[]}}undo(){if(!this.canUndo)return;if(!this.history||!this.history.past||0===this.history.past.length)return void _e.warn("[MaskStore] 撤销失败：历史记录为空");this.history={...this.history,future:[[...this.masks],...this.history.future]};const e=[...this.history.past],t=e.pop();t&&(this.history={...this.history,past:e},this.masks=[...t],this.selectedId=null,_e.debug("[MaskStore] 撤销操作"))}redo(){if(!this.canRedo)return;if(!this.history||!this.history.future||0===this.history.future.length)return void _e.warn("[MaskStore] 重做失败：未来记录为空");this.history={...this.history,past:[...this.history.past,[...this.masks]]};const e=[...this.history.future],t=e.shift();t&&(this.history={...this.history,future:e},this.masks=[...t],this.selectedId=null,_e.debug("[MaskStore] 重做操作"))}clearHistory(){this.history={past:[],future:[]}}duplicateSelected(){if(!this.selectedMask)return null;const e={...this.selectedMask,id:K7(),x:Math.min(this.selectedMask.x+.02,.98),y:Math.min(this.selectedMask.y+.02,.98)};return this.addMask(e),e}moveMask(e,t){const n=this.masks.findIndex(t=>t.id===e);if(-1===n)return;this.saveHistory();const i=this.masks[n],a=this.masks.filter(t=>t.id!==e);a.splice(t,0,i),this.masks=a}getMaskIndex(e){return this.masks.findIndex(t=>t.id===e)}toJSON(){return[...this.masks]}fromJSON(e){this.setMasks(e),this.clearHistory()}}var qCe=la('<div class="loading-overlay svelte-1tk2m4m"><div class="spinner svelte-1tk2m4m"></div> <p>加载图片中...</p></div>'),HCe=la('<div class="error-overlay svelte-1tk2m4m"><div class="error-icon svelte-1tk2m4m">❌</div> <p class="svelte-1tk2m4m"> </p></div>'),WCe=e=>{e.stopPropagation()},GCe=la('<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" tabindex="0"><image x="0" y="0" width="100" height="100" preserveAspectRatio="xMidYMid meet" pointer-events="none" style="image-rendering: crisp-edges;"></image><!><!></svg> <div class="hint svelte-1tk2m4m"><!></div>',1),QCe=la('<div class="mask-editor-svg-container svelte-1tk2m4m"><!></div>');function KCe(e,t){var n;if(new.target)return Er({component:KCe,...e});kt(t,!0);let i=Ar(t,"app",7),a=Ar(t,"imageFile",7),r=Ar(t,"initialMaskData",7,null),s=Ar(t,"currentColor",7,"rgba(0, 0, 0, 0.7)"),o=Ar(t,"onMaskDataChange",7),l=Ar(t,"onEditorReady",7,()=>{});const c=function(e=[]){return new VCe(e)}((null==(n=r())?void 0:n.masks)||[]);let d=Pn(Ot([])),u=Pn(null),h=Pn(null);function p(){$n(d,[...c.masks],!0),$n(u,c.activeDrawing?{...c.activeDrawing}:null,!0),$n(h,c.selectedId,!0)}p();let g=Pn(null),v=Pn(""),f=Pn(0),m=Pn(0),y=Pn(!0),b=Pn(null),w=Pn(null),k=Pn(null),S=0;function x(){const e=Date.now();e-S>=16&&(p(),S=e)}function _(e){if(e.stopPropagation(),!bi(w))return;if(!bi(g))return;c.clearSelection(),p();const t=J7(e,bi(g));$n(k,t,!0),c.activeDrawing={id:K7(),type:bi(w),x:t.x,y:t.y,width:0,height:0,radius:0,fill:s(),style:"solid"},p(),_e.debug("[MaskEditorSVG] 开始绘制:",bi(w))}function C(e){if(e.stopPropagation(),!bi(g))return;const t=J7(e,bi(g));c.activeDrawing&&bi(k)&&function(e){if(!c.activeDrawing||!bi(k))return;if("rect"===c.activeDrawing.type){const t=Math.min(e.x,bi(k).x),n=Math.min(e.y,bi(k).y),i=Math.abs(e.x-bi(k).x),a=Math.abs(e.y-bi(k).y);c.activeDrawing.x=t,c.activeDrawing.y=n,c.activeDrawing.width=i,c.activeDrawing.height=a,x()}else if("circle"===c.activeDrawing.type){const t=e.x-bi(k).x,n=e.y-bi(k).y,i=Math.sqrt(t*t+n*n);c.activeDrawing.x=bi(k).x,c.activeDrawing.y=bi(k).y,c.activeDrawing.radius=i,x()}}(t)}function I(e){e.stopPropagation(),c.activeDrawing&&function(){if(!c.activeDrawing)return;if(!function(e){if(!e.type||!["rect","circle"].includes(e.type))return!1;if("number"!=typeof e.x||"number"!=typeof e.y)return!1;if("rect"===e.type){if("number"!=typeof e.width||"number"!=typeof e.height)return!1;if(e.width<=0||e.height<=0)return!1}if("circle"===e.type){if("number"!=typeof e.radius)return!1;if(e.radius<=0)return!1}return!0}(c.activeDrawing))return _e.warn("[MaskEditorSVG] 无效的遮罩，取消绘制"),c.activeDrawing=null,p(),void $n(k,null);if(t8(c.activeDrawing,.01))return _e.warn("[MaskEditorSVG] 遮罩太小，取消绘制"),c.activeDrawing=null,p(),void $n(k,null);const e=function(e){if("rect"===e.type)return{...e,x:e8(e.x),y:e8(e.y),width:Math.min(e.width,1-e.x),height:Math.min(e.height,1-e.y)};if("circle"===e.type){const t=Math.min(e.x,e.y,1-e.x,1-e.y);return{...e,x:e8(e.x),y:e8(e.y),radius:Math.min(e.radius,t)}}return e}(c.activeDrawing);c.addMask(e),c.activeDrawing=null,p(),$n(k,null),_e.debug("[MaskEditorSVG] 绘制完成")}()}function D(e){e.stopPropagation(),c.activeDrawing||bi(k)||e.target!==bi(g)&&"image"!==e.target.tagName||(c.clearSelection(),p())}Pr(async()=>{try{$n(v,i().vault.adapter.getResourcePath(a().path),!0);const e=new Image;e.onload=()=>{$n(f,e.width,!0),$n(m,e.height,!0),$n(y,!1),l()(!0)},e.onerror=()=>{$n(b,"图片加载失败"),$n(y,!1)},e.src=bi(v)}catch(e){_e.error("[MaskEditorSVG] 初始化失败:",e),$n(b,e instanceof Error?e.message:"初始化失败",!0),$n(y,!1)}}),Ti(()=>{const e=bi(d);o()({version:q7,masks:e})}),Ti(()=>{}),Ti(()=>{});var T={enableRectDrawing:function(){$n(w,"rect"),c.clearSelection(),p(),_e.debug("[MaskEditorSVG] 启用矩形绘制模式")},enableCircleDrawing:function(){$n(w,"circle"),c.clearSelection(),p(),_e.debug("[MaskEditorSVG] 启用圆形绘制模式")},deleteSelectedMask:function(){c.selectedId&&(c.deleteMask(c.selectedId),p(),_e.debug("[MaskEditorSVG] 删除选中遮罩"))},updateSelectedMaskColor:function(e){c.selectedId&&(c.updateMask(c.selectedId,{fill:e}),p(),_e.debug("[MaskEditorSVG] 更新遮罩颜色:",e))},getMaskData:function(){return{version:q7,masks:c.masks}},undo:function(){c.undo()},redo:function(){c.redo()},updateSensitivity:function(e){window.__maskEditorSensitivity=e,_e.debug("[MaskEditorSVG] 更新灵敏度:",e)},updateImageDisplayMode:function(e){const t=bi(g);if(t){let n;n="fit"===e?"xMidYMid meet":"fill"===e?"xMidYMid slice":"original"===e?"none":"xMidYMid meet",t.setAttribute("preserveAspectRatio",n);const i=t.querySelector("image");i&&i.setAttribute("preserveAspectRatio",n)}_e.debug("[MaskEditorSVG] 更新图片显示模式:",e)},updateGridVisibility:function(e){_e.debug("[MaskEditorSVG] 更新网格可见性:",e)},updateGridSize:function(e){_e.debug("[MaskEditorSVG] 更新网格大小:",e)},updateSnapToGrid:function(e){_e.debug("[MaskEditorSVG] 更新网格吸附:",e)},get app(){return i()},set app(e){i(e),hn()},get imageFile(){return a()},set imageFile(e){a(e),hn()},get initialMaskData(){return r()},set initialMaskData(e=null){r(e),hn()},get currentColor(){return s()},set currentColor(e="rgba(0, 0, 0, 0.7)"){s(e),hn()},get onMaskDataChange(){return o()},set onMaskDataChange(e){o(e),hn()},get onEditorReady(){return l()},set onEditorReady(e=()=>{}){l(e),hn()},$set:xr,$on:(e,n)=>Sr(t,e,n)},M=QCe(),A=Gt(M),E=e=>{pa(e,qCe())},z=e=>{var t=ha(),n=Qt(t),i=e=>{var t=HCe(),n=Kt(Gt(t),2),i=Gt(n,!0);zt(n),zt(t),zi(()=>va(i,bi(b))),pa(e,t)},a=e=>{var t=GCe(),n=Qt(t);let i;n.__mousedown=_,n.__mousemove=C,n.__mouseup=I,n.__click=D,n.__keydown=e=>{e.stopPropagation(),"Escape"===e.key&&(c.clearSelection(),p(),$n(w,null))},n.__contextmenu=[WCe];var a=Gt(n),r=Kt(a);Ca(r,17,()=>bi(d),e=>e.id,(e,t)=>{{let n=In(()=>bi(t).id===bi(h));UCe(e,{get mask(){return bi(t)},editable:!0,get selected(){return bi(n)},onUpdate:e=>function(e,t){c.updateMask(e,t),p()}(bi(t).id,e),onSelect:()=>{return e=bi(t).id,c.selectMask(e),p(),void $n(w,null);var e},onDelete:()=>{return e=bi(t).id,c.deleteMask(e),void p();var e}})}});var s=Kt(r),o=e=>{UCe(e,{get mask(){return bi(u)},editable:!1,selected:!1})};xa(s,e=>{bi(u)&&t8(bi(u))&&e(o)}),zt(n),kr(n,e=>$n(g,e),()=>bi(g));var l=Kt(n,2),f=Gt(l),m=e=>{var t=ua();zi(()=>va(t,`💡 在图片上拖拽绘制${"rect"===bi(w)?"矩形":"圆形"}遮罩`)),pa(e,t)},y=e=>{var t=ha(),n=Qt(t),i=e=>{pa(e,ua("💡 拖拽移动遮罩，拖拽控制点调整大小，双击删除"))},a=e=>{pa(e,ua("💡 选择工具开始绘制，或点击遮罩进行编辑"))};xa(n,e=>{c.selectedId?e(i):e(a,!1)},!0),pa(e,t)};xa(f,e=>{bi(w)?e(m):e(y,!1)}),zt(l),zi(e=>{i=Fa(n,0,"mask-editor-svg svelte-1tk2m4m",null,i,e),er(a,"href",bi(v))},[()=>({drawing:!!bi(w),"has-active":!!bi(u)})]),na("dragstart",n,e=>{e.preventDefault(),e.stopPropagation()}),pa(e,t)};xa(n,e=>{bi(b)?e(i):e(a,!1)},!0),pa(e,t)};return xa(A,e=>{bi(y)?e(E):e(z,!1)}),zt(M),pa(e,M),St(T)}function ZCe(e,t,n,i){bi(t)&&bi(n)&&($n(i,"rect"),bi(t).enableRectDrawing())}function YCe(e,t,n,i){bi(t)&&bi(n)&&($n(i,"circle"),bi(t).enableCircleDrawing())}function XCe(e,t,n){bi(t)&&bi(n)&&bi(t).deleteSelectedMask()}function JCe(e,t,n){bi(t)?n()(bi(t)):_e.warn("[ImageMaskModal] 没有遮罩数据可保存")}ia(["mousedown","mousemove","mouseup","click","keydown","contextmenu"]);var eIe=(e,t)=>$n(t,!bi(t)),tIe=(e,t)=>$n(t,!1),nIe=(e,t,n,i)=>{const a=Number(e.target.value);$n(t,a,!0),bi(n)&&bi(n).updateSensitivity(a/100),i()},iIe=(e,t,n,i)=>{const a=e.target.value;$n(t,a,!0),bi(n)&&bi(n).updateImageDisplayMode(a),i()},aIe=(e,t,n,i)=>{bi(t)&&bi(t).updateGridVisibility(bi(n)),i()},rIe=(e,t,n,i)=>{const a=Number(e.target.value);$n(t,a,!0),bi(n)&&bi(n).updateGridSize(a),i()},sIe=(e,t,n,i)=>{bi(t)&&bi(t).updateSnapToGrid(bi(n)),i()},oIe=la('<div class="setting-item sub-item svelte-1jrdsjv"><label class="setting-label svelte-1jrdsjv"><span>网格大小</span></label> <div class="setting-control svelte-1jrdsjv"><input type="range" class="setting-slider svelte-1jrdsjv" min="5" max="20" step="5"/> <span class="setting-value svelte-1jrdsjv"> </span></div></div> <div class="setting-item sub-item svelte-1jrdsjv"><label class="checkbox-label svelte-1jrdsjv"><input type="checkbox" class="svelte-1jrdsjv"/> <span>吸附到网格</span></label></div>',1),lIe=la('<div class="settings-dropdown svelte-1jrdsjv"><div class="settings-header svelte-1jrdsjv"><span>编辑器设置</span> <button class="close-settings-btn svelte-1jrdsjv" title="关闭设置"><!></button></div> <div class="settings-body svelte-1jrdsjv"><div class="setting-item svelte-1jrdsjv"><label class="setting-label svelte-1jrdsjv"><span>调整灵敏度</span></label> <div class="setting-control svelte-1jrdsjv"><input type="range" class="setting-slider svelte-1jrdsjv" min="3" max="30" step="1"/> <span class="setting-value svelte-1jrdsjv"> </span></div></div> <div class="setting-item svelte-1jrdsjv"><label class="setting-label svelte-1jrdsjv"><span>图片显示</span></label> <div class="setting-control svelte-1jrdsjv"><select class="setting-select svelte-1jrdsjv"><option>适应窗口（保持比例）</option><option>填充窗口（可能裁剪）</option><option>原始尺寸</option></select></div></div> <div class="setting-item svelte-1jrdsjv"><label class="setting-label svelte-1jrdsjv"><span>辅助网格</span></label> <div class="setting-control svelte-1jrdsjv"><label class="checkbox-label svelte-1jrdsjv"><input type="checkbox" class="svelte-1jrdsjv"/> <span>显示网格</span></label></div></div> <!></div></div>'),cIe=(e,t,n)=>t(bi(n).name),dIe=la('<button><span class="color-dot svelte-1jrdsjv"></span></button>'),uIe=(e,t)=>t(Number(e.target.value)),hIe=la('<div class="image-mask-modal svelte-1jrdsjv"><div class="modal-header svelte-1jrdsjv"><div class="header-left svelte-1jrdsjv"><!> <span class="header-title svelte-1jrdsjv">编辑图片遮罩</span> <span class="header-divider svelte-1jrdsjv">-</span> <span class="header-filename svelte-1jrdsjv"> </span></div> <div class="header-right svelte-1jrdsjv"><div class="settings-container svelte-1jrdsjv"><button title="编辑器设置">设置</button> <!></div></div></div> <div class="modal-body svelte-1jrdsjv"><!></div> <div class="modal-footer svelte-1jrdsjv"><div class="toolbar-section svelte-1jrdsjv"><div class="tool-group svelte-1jrdsjv"><button title="矩形工具 - 在图片上拖拽绘制矩形遮罩"><!> <span>矩形</span></button> <button title="圆形工具 - 在图片上拖拽绘制圆形遮罩"><!> <span>圆形</span></button> <button class="tool-btn delete-btn svelte-1jrdsjv" title="删除选中遮罩（或双击遮罩删除）"><!> <span>删除</span></button></div> <div class="divider svelte-1jrdsjv"></div> <div class="color-picker svelte-1jrdsjv"><span class="picker-label svelte-1jrdsjv">颜色:</span> <!></div> <div class="divider svelte-1jrdsjv"></div> <div class="opacity-control svelte-1jrdsjv"><span class="picker-label svelte-1jrdsjv">透明度:</span> <input type="range" class="opacity-slider svelte-1jrdsjv" min="0" max="100" step="5" title="调整遮罩透明度"/> <span class="opacity-value svelte-1jrdsjv"> </span></div> <div class="divider svelte-1jrdsjv"></div> <div class="mask-count svelte-1jrdsjv"><!> <span> </span></div></div> <div class="action-section svelte-1jrdsjv"><button class="btn btn-primary svelte-1jrdsjv"><!> <span>保存遮罩</span></button></div></div></div>');ia(["click","input","change"]);const pIe=Object.freeze(Object.defineProperty({__proto__:null,default:function e(t,n){if(new.target)return Er({component:e,...t});kt(n,!0);let i=Ar(n,"app",7),a=Ar(n,"imageFile",7),r=Ar(n,"initialMaskData",7,null),s=Ar(n,"onSave",7),o=Ar(n,"onCancel",7),l=Pn(null),c=Pn(Ot(r())),d=Pn(!1),u=Pn(null),h=Pn(0),p=Pn(!1),g=Pn("red"),v=Pn(70),f=Pn(!1),m=Pn(8),y=Pn("fit"),b=Pn(!1),w=Pn(10),k=Pn(!1);const S=[{name:"red",value:"rgb(255, 0, 0)",label:"红色"},{name:"yellow",value:"rgb(255, 255, 0)",label:"黄色"},{name:"blue",value:"rgb(0, 0, 255)",label:"蓝色"},{name:"green",value:"rgb(0, 255, 0)",label:"绿色"}];let x=In(()=>()=>{const e=S.find(e=>e.name===bi(g));if(!e)return`rgba(0, 0, 0, ${bi(v)/100})`;const t=e.value.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return t?`rgba(${t[1]}, ${t[2]}, ${t[3]}, ${bi(v)/100})`:`rgba(0, 0, 0, ${bi(v)/100})`});function _(e){$n(g,e,!0),bi(l)&&bi(p)&&bi(l).updateSelectedMaskColor(bi(x)())}function C(){try{const e={sensitivity:bi(m),imageDisplayMode:bi(y),showGrid:bi(b),gridSize:bi(w),snapToGrid:bi(k)};localStorage.setItem("tuanki-mask-editor-settings",JSON.stringify(e))}catch(e){_e.warn("[保存设置失败]",e)}}Pr(()=>{!function(){var e,t,n,i,a;try{const r=localStorage.getItem("tuanki-mask-editor-settings");if(r){const s=JSON.parse(r);$n(m,null!=(e=s.sensitivity)?e:8,!0),$n(y,null!=(t=s.imageDisplayMode)?t:"fit",!0),$n(b,null!=(n=s.showGrid)&&n,!0),$n(w,null!=(i=s.gridSize)?i:10,!0),$n(k,null!=(a=s.snapToGrid)&&a,!0)}}catch(r){_e.warn("[加载设置失败]",r)}}(),window.__maskEditorSensitivity=bi(m)/100});var I={get app(){return i()},set app(e){i(e),hn()},get imageFile(){return a()},set imageFile(e){a(e),hn()},get initialMaskData(){return r()},set initialMaskData(e=null){r(e),hn()},get onSave(){return s()},set onSave(e){s(e),hn()},get onCancel(){return o()},set onCancel(e){o(e),hn()},$set:xr,$on:(e,t)=>Sr(n,e,t)},D=hIe(),T=Gt(D),M=Gt(T),A=Gt(M);Ng(A,{name:"image",size:"lg"});var E=Kt(A,6),z=Gt(E,!0);zt(E),zt(M);var P=Kt(M,2),R=Gt(P),$=Gt(R);let O;$.__click=[eIe,f];var L=Kt($,2),N=e=>{var t=lIe(),n=Gt(t),i=Kt(Gt(n),2);i.__click=[tIe,f],Ng(Gt(i),{name:"times",size:"sm"}),zt(i),zt(n);var a=Kt(n,2),r=Gt(a),s=Kt(Gt(r),2),o=Gt(s);Za(o),o.__input=[nIe,m,l,C];var c=Kt(o,2),d=Gt(c);zt(c),zt(s),zt(r);var u=Kt(r,2),h=Kt(Gt(u),2),p=Gt(h);p.__change=[iIe,y,l,C];var g=Gt(p);g.value=g.__value="fit";var v=Kt(g);v.value=v.__value="fill";var S=Kt(v);S.value=S.__value="original",zt(p),zt(h),zt(u);var x=Kt(u,2),_=Kt(Gt(x),2),I=Gt(_),D=Gt(I);Za(D),D.__change=[aIe,l,b,C],Pt(2),zt(I),zt(_),zt(x);var T=Kt(x,2),M=e=>{var t=oIe(),n=Qt(t),i=Kt(Gt(n),2),a=Gt(i);Za(a),a.__input=[rIe,w,l,C];var r=Kt(a,2),s=Gt(r,!0);zt(r),zt(i),zt(n);var o=Kt(n,2),c=Gt(o),d=Gt(c);Za(d),d.__change=[sIe,l,k,C],Pt(2),zt(c),zt(o),zi(()=>va(s,bi(w))),pr(a,()=>bi(w),e=>$n(w,e)),fr(d,()=>bi(k),e=>$n(k,e)),pa(e,t)};xa(T,e=>{bi(b)&&e(M)}),zt(a),zt(t),zi(()=>{var e;return va(d,`${null!=(e=bi(m))?e:""}%`)}),pr(o,()=>bi(m),e=>$n(m,e)),qa(p,()=>bi(y),e=>$n(y,e)),fr(D,()=>bi(b),e=>$n(b,e)),pa(e,t)};xa(L,e=>{bi(f)&&e(N)}),zt(R),zt(P),zt(T);var F=Kt(T,2),B=Gt(F);{let e=In(()=>bi(x)());kr(KCe(B,{get app(){return i()},get imageFile(){return a()},get initialMaskData(){return r()},get currentColor(){return bi(e)},onMaskDataChange:function(e){$n(c,e,!0),$n(h,e.masks.length,!0),$n(d,!0)},onEditorReady:function(e){$n(p,e,!0),e&&bi(l)&&setTimeout(()=>{bi(l)&&(bi(l).updateImageDisplayMode(bi(y)),_e.debug("[ImageMaskModal] 应用保存的图片显示模式:",bi(y)))},100)}}),e=>$n(l,e,!0),()=>bi(l))}zt(F);var j=Kt(F,2),U=Gt(j),V=Gt(U),q=Gt(V);let H;q.__click=[ZCe,l,p,u],Ng(Gt(q),{name:"square",size:"md"}),Pt(2),zt(q);var W=Kt(q,2);let G;W.__click=[YCe,l,p,u],Ng(Gt(W),{name:"circle",size:"md"}),Pt(2),zt(W);var Q=Kt(W,2);Q.__click=[XCe,l,p],Ng(Gt(Q),{name:"trash",size:"md"}),Pt(2),zt(Q),zt(V);var K=Kt(V,4);Ca(Kt(Gt(K),2),17,()=>S,_a,(e,t)=>{var n=dIe();let i;n.__click=[cIe,_,t];var a=Gt(n);zt(n),zi(e=>{var r,s;i=Fa(n,1,"color-button svelte-1jrdsjv",null,i,e),ja(n,`--color: ${null!=(r=bi(t).value)?r:""}`),er(n,"title",bi(t).label),er(n,"aria-label",bi(t).label),ja(a,`background-color: ${null!=(s=bi(t).value)?s:""}`)},[()=>({active:bi(g)===bi(t).name})]),pa(e,n)}),zt(K);var Z=Kt(K,4),Y=Kt(Gt(Z),2);Za(Y),Y.__input=[uIe,function(e){$n(v,e,!0),bi(l)&&bi(p)&&bi(l).updateSelectedMaskColor(bi(x)())}];var X=Kt(Y,2),J=Gt(X);zt(X),zt(Z);var ee=Kt(Z,4),te=Gt(ee);Ng(te,{name:"layers",size:"sm"});var ne=Kt(te,2),ie=Gt(ne);zt(ne),zt(ee),zt(U);var ae=Kt(U,2),re=Gt(ae);return re.__click=[JCe,c,s],Ng(Gt(re),{name:"check",size:"sm"}),Pt(2),zt(re),zt(ae),zt(j),zt(D),zi((e,t,n)=>{var i,r,s;va(z,a().basename),O=Fa($,1,"settings-text-btn svelte-1jrdsjv",null,O,e),H=Fa(q,1,"tool-btn svelte-1jrdsjv",null,H,t),q.disabled=!bi(p),G=Fa(W,1,"tool-btn svelte-1jrdsjv",null,G,n),W.disabled=!bi(p),Q.disabled=!bi(p),va(J,`${null!=(i=bi(v))?i:""}%`),va(ie,`遮罩: ${null!=(r=bi(h))?r:""}`),re.disabled=!bi(c)||0===bi(c).masks.length,er(re,"title",`保存所有遮罩（共 ${null!=(s=bi(h))?s:""} 个）`)},[()=>({active:bi(f)}),()=>({active:"rect"===bi(u)}),()=>({active:"circle"===bi(u)})]),pr(Y,()=>bi(v),e=>$n(v,e)),pa(t,D),St(I)}},Symbol.toStringTag,{value:"Module"}));exports.WeavePlugin=ig,exports.default=ig;
