# Tuanki Obsidian 插件构建教程

## 目录
- [项目概述](#项目概述)
- [环境准备](#环境准备)
- [开发构建](#开发构建)
- [生产构建](#生产构建)
- [构建配置说明](#构建配置说明)
- [常见问题解决](#常见问题解决)
- [发布流程](#发布流程)

## 项目概述

Tuanki 是一个功能强大的 Obsidian 插件，基于 Svelte 5 + TypeScript + Vite 构建，支持 FSRS 算法和现代化 UI。

### 技术栈
- **前端框架**: Svelte 5 (使用 runes 语法)
- **构建工具**: Vite 5
- **语言**: TypeScript
- **样式**: UnoCSS
- **测试**: Vitest
- **代码质量**: Biome

## 环境准备

### 1. 系统要求
- Node.js 18+ 
- npm 或 yarn
- Windows 10/11 (当前项目路径包含中文字符)

### 2. 项目结构
```
D:\桌面\obsidian tuanki (3) (2) (5) (9) (1)\
└── 10-Project-Tuanki\
    └── anki-obsidian-plugin\  ← 主项目目录
        ├── src\              ← 源代码
        ├── dist\             ← 生产构建输出
        ├── package.json      ← 项目配置
        ├── vite.config.ts    ← Vite 配置
        └── manifest.json     ← Obsidian 插件清单
```

### 3. 安装依赖
```bash
# 切换到项目目录
cd "D:\桌面\obsidian tuanki (3) (2) (5) (9) (1)\10-Project-Tuanki\anki-obsidian-plugin"

# 安装依赖
npm install
```

## 开发构建

### 1. 启动开发服务器
```bash
npm run dev
```

### 2. 开发构建特点
- **命令**: `vite build --mode development --watch`
- **监听模式**: 自动监听文件变化并重新构建
- **输出位置**: 直接输出到 Obsidian 插件目录
- **源码映射**: 包含完整的源码映射，便于调试
- **代码压缩**: 不压缩，保持可读性
- **文件大小**: 较大，包含调试信息

### 3. 开发构建输出
```
D:\桌面\obsidian luman\.obsidian/plugins/tuanki\
├── main.js          # 主插件文件 (12.5MB)
├── styles.css       # 样式文件 (684KB)
├── manifest.json    # 插件清单
└── sql-wasm.wasm    # SQL.js WebAssembly 文件
```

### 4. 开发工作流程
1. **修改代码**: 在 `src/` 目录下编辑文件
2. **自动构建**: Vite 检测变化并自动重新构建
3. **刷新插件**: 在 Obsidian 中重新加载插件
4. **测试功能**: 验证修改效果

### 5. 开发构建优势
- ✅ 实时监听文件变化
- ✅ 快速重新构建
- ✅ 完整的调试信息
- ✅ 直接输出到 Obsidian
- ✅ 支持热重载

## 生产构建

### 1. 执行生产构建
```bash
npm run build
```

### 2. 生产构建特点
- **命令**: `vite build --mode production`
- **代码压缩**: 使用 Terser 压缩 JavaScript
- **CSS 优化**: 压缩样式文件
- **Tree Shaking**: 移除未使用的代码
- **输出位置**: `dist/` 目录
- **文件大小**: 显著减小

### 3. 生产构建输出
```
dist/
├── main.js          # 压缩后的主文件
├── styles.css       # 压缩后的样式文件
├── manifest.json    # 插件清单
└── sql-wasm.wasm    # SQL.js WebAssembly 文件
```

### 4. 构建优化特性
- **代码压缩**: JavaScript 和 CSS 文件压缩
- **资源内联**: 小于 4MB 的资源自动内联
- **依赖优化**: 优化第三方库打包
- **目标环境**: ES2018 兼容性
- **移除调试**: 清理开发时的调试代码

### 5. 生产构建优势
- ✅ 文件体积最小化
- ✅ 加载性能优化
- ✅ 适合发布分发
- ✅ 生产环境稳定
- ✅ 代码安全性提升

## 构建配置说明

### 1. Vite 配置要点
```typescript
// vite.config.ts 关键配置
export default defineConfig(({ mode }) => {
  const isDev = mode === "development";
  
  return {
    build: {
      lib: {
        entry: "src/main",
        formats: ["cjs"],
      },
      outDir: isDev ? PLUGIN_DIR : "dist",
      sourcemap: isDev ? "inline" : false,
      minify: isDev ? false : "terser",
      target: ["es2018"],
    }
  };
});
```

### 2. 环境变量配置
- **开发模式**: 输出到 Obsidian 插件目录
- **生产模式**: 输出到 `dist/` 目录
- **源码映射**: 开发模式包含，生产模式移除

### 3. 插件配置
```json
// manifest.json
{
  "id": "tuanki",
  "name": "Tuanki",
  "version": "0.5.1",
  "minAppVersion": "1.4.11",
  "description": "A powerful spaced repetition learning plugin"
}
```

## 常用构建命令

### 开发相关
```bash
# 开发构建（监听模式）
npm run dev

# 代码格式化
npm run format

# 代码检查
npm run lint

# 类型检查
npm run check
```

### 生产相关
```bash
# 生产构建
npm run build

# 清理构建文件
npm run clean

# 重新安装依赖
npm run reinstall
```

### 测试相关
```bash
# 运行测试
npm run test

# 监听模式测试
npm run test:watch
```

## 常见问题解决

### 1. 目录切换问题
**问题**: `cd` 命令无法切换到项目目录
**解决方案**:
```bash
# 方法1: 使用引号包围路径
cd "D:\桌面\obsidian tuanki (3) (2) (5) (9) (1)\10-Project-Tuanki\anki-obsidian-plugin"

# 方法2: 使用文件资源管理器
# 在项目目录地址栏输入 cmd 并按回车

# 方法3: 使用 PowerShell
Set-Location "D:\桌面\obsidian tuanki (3) (2) (5) (9) (1)\10-Project-Tuanki\anki-obsidian-plugin"
```

### 2. npm 命令找不到 package.json
**问题**: `npm ERR! Could not read package.json`
**解决方案**:
- 确认在正确的项目目录中
- 检查 `package.json` 文件是否存在
- 使用 `pwd` 或 `dir` 确认当前目录

### 3. 构建失败
**问题**: 构建过程中出现错误
**解决方案**:
```bash
# 清理并重新安装依赖
npm run clean
npm install

# 检查 Node.js 版本
node --version

# 检查 npm 版本
npm --version
```

### 4. 文件权限问题
**问题**: 无法写入输出目录
**解决方案**:
- 以管理员身份运行命令提示符
- 检查输出目录的写入权限
- 确保 Obsidian 插件目录存在

## 发布流程

### 1. 版本管理
```bash
# 更新版本号
npm version patch  # 0.5.1 -> 0.5.2
npm version minor  # 0.5.1 -> 0.6.0
npm version major  # 0.5.1 -> 1.0.0
```

### 2. 生产构建
```bash
# 清理之前的构建
npm run clean

# 执行生产构建
npm run build

# 验证构建结果
dir dist
```

### 3. 打包发布
```bash
# 创建发布包
cd dist
zip -r tuanki-v0.5.1.zip .

# 或使用 PowerShell
Compress-Archive -Path * -DestinationPath tuanki-v0.5.1.zip
```

### 4. 发布检查清单
- [ ] 版本号已更新
- [ ] 生产构建成功
- [ ] 文件大小合理
- [ ] 功能测试通过
- [ ] 文档已更新
- [ ] 发布包已创建

## 性能优化建议

### 1. 构建性能
- 使用 SSD 存储项目文件
- 关闭不必要的防病毒软件实时扫描
- 使用 npm 缓存加速依赖安装

### 2. 运行时性能
- 生产构建移除源码映射
- 启用代码压缩和优化
- 使用 Tree Shaking 移除未使用代码

### 3. 开发体验
- 使用开发模式进行日常开发
- 定期清理 `node_modules` 和构建缓存
- 使用代码格式化工具保持代码质量

## 总结

### 开发构建 vs 生产构建对比

| 特性 | 开发构建 | 生产构建 |
|------|----------|----------|
| 命令 | `npm run dev` | `npm run build` |
| 监听 | ✅ 自动监听 | ❌ 单次构建 |
| 压缩 | ❌ 不压缩 | ✅ 压缩优化 |
| 源码映射 | ✅ 包含 | ❌ 移除 |
| 输出位置 | Obsidian 插件目录 | `dist/` 目录 |
| 文件大小 | 较大 (12.5MB) | 较小 (压缩后) |
| 调试 | ✅ 便于调试 | ❌ 难以调试 |
| 发布 | ❌ 不适合 | ✅ 适合发布 |

### 最佳实践
1. **开发阶段**: 使用 `npm run dev` 进行实时开发
2. **测试阶段**: 定期使用 `npm run build` 验证生产构建
3. **发布阶段**: 使用生产构建创建发布包
4. **维护阶段**: 定期清理和更新依赖

---

**创建时间**: 2025-01-15  
**版本**: 1.0  
**适用项目**: Tuanki Obsidian Plugin v0.5.1+
