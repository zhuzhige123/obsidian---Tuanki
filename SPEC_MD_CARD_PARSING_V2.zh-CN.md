# Tuanki Markdown 卡片解析规范（本地方案）

版本: v1.0 (正式版本)
状态: 已实施并投入使用

## 1. 目标与范围
- 提供简化的基于可自定义符号的 Markdown 解析方案，支持灵活的卡片创建。
- 支持题型：
  - 问答题（Q/A）
  - 选择题（单选/多选）
  - 挖空题（Cloze，使用 ==高亮文本== 标记）
- 内容保真：代码块、列表、引用、图片、内联数学等原样保留，渲染交由 Obsidian 引擎完成。

## 2. 解析触发与输入来源
- 卡片识别触发（可配置开关）：
  - 若启用标签触发：仅当卡片内容中存在指定的触发标签时，才会被解析为卡片
  - 触发标签可自定义（如 `#tuanki`、`#flashcard` 等）
  - 若禁用标签触发：所有符合格式的内容都会被解析为卡片
- 输入来源分两类：
  1) 单卡解析：新建卡片模态窗的输入内容（不需要卡片范围分隔线）
  2) 批量解析：笔记文件中指定范围内的多卡扫描

## 3. 可自定义符号配置（默认值）
- 批量扫描范围起止：
  - rangeStart: `---start---`
  - rangeEnd: `---end---`
- 单卡卡片范围：
  - cardDelimiter: `---卡片---`（在批量范围内分隔多张卡片）
- 卡片正反面分隔：
  - faceDelimiter: `---div---`（若存在，前为正面，后为背面）
- 挖空隐藏符号：
  - clozeMarker: `==高亮文本==`（替代传统 {{cN::...}} 格式）

## 4. 简化解析逻辑
### 4.1 单卡解析流程
1. 检查触发条件：
   - 若启用标签触发：检查是否含指定触发标签（如 `#tuanki`），若无则跳过
   - 若禁用标签触发：直接进入解析流程
2. 若含 `---div---`：其前为正面（Front），其后为背面（Back）
3. **若无 `---div---`：整个卡片内容直接显示在正面（Front），背面为空**
4. 提取标签和元数据

### 4.2 批量解析流程
1. 在文档中找到 `---start---` 与 `---end---` 的成对范围
2. 在范围内以 `---卡片---` 切分为多张卡片
3. 对每张卡重复单卡解析流程
4. 卡片级异常仅跳过该卡，其余继续（容错）

## 5. 题型判定与结构
### 5.1 问答题（默认）
- 按第4节流程得到 Front/Back
- 若未检测到选择题或挖空题特征，则为问答题

### 5.2 选择题（MCQ）判定
- 规则：正面区域出现选项列表即判定为选择题
- 选项匹配（任一匹配即认为是选项行）：
  - GFM 复选框风格：`- [ ] 文本` 或 `- [x] 文本`（`[x]`表示正确选项）
  - 字母序标识：`A. 文本`、`B) 文本`、`C、文本` 等（正确项可在行尾添加 `✓` 或 `(正确)`）
  - 数字序标识：`1. 文本`、`2) 文本`（正确项同上标注）
- 正确答案提取：
  - `- [x]` 视为正确
  - 或在该行末尾存在 `✓`、`(正确)`、`(对)`、`(√)` 任一标记视为正确
- 字段映射：
  - Front：题干 + 选项（渲染时显示选项）
  - Back：正确答案与解析理由（若 `---div---` 存在，则为其后的内容）

### 5.3 挖空题（Cloze）判定
- 规则：卡片正文中存在 `==高亮文本==` 模式，即认为是 Cloze 类型
- 行为：
  - NoteType 设置为 `Cloze`
  - Front：原文中 `==文本==` 会在渲染时隐藏文本，显示空格/序号
  - Back：可为 `---div---` 之后的内容（若存在）或自动生成的"还原文本汇总"
  - 支持多个挖空，按顺序生成对应的多张卡

## 6. 模板系统（新增）
### 6.1 模板类型
支持两种模板模式：
1. **单字段单正则解析**：为每个字段定义独立的正则表达式
2. **完整正则表达式解析**：使用一个完整的正则表达式解析整段卡片内容

### 6.2 单字段单正则模式
```yaml
template:
  name: "基础问答"
  fields:
    - name: "Front"
      regex: "^(.+?)(?=---div---|$)"
      flags: "ms"
    - name: "Back"
      regex: "(?<=---div---)(.+)$"
      flags: "ms"
    - name: "Tags"
      regex: "#([A-Za-z0-9_\\-/]+)"
      flags: "g"
```

### 6.3 完整正则表达式模式
```yaml
template:
  name: "完整解析"
  regex: "^(?<front>.+?)(?:---div---(?<back>.+?))?(?<tags>#[A-Za-z0-9_\\-/]+.*)?$"
  flags: "ms"
  fields:
    - name: "Front"
      source: "front"
    - name: "Back"
      source: "back"
    - name: "Tags"
      source: "tags"
      transform: "extractTags"
```

## 7. 标签与元数据
- 标签：扫描全卡中所有以 `#` 开头且符合 `[A-Za-z0-9_\-/]+` 的 token，去重后作为 Tags 字段
- Deck/NoteType：
  - NoteType：`Basic`（问答题）、`Basic-MCQ`（选择题）、`Cloze`（挖空题）
  - Deck：优先从 Frontmatter/路径/设置默认值中获得

## 8. 内容保真与渲染
- 保留原 Markdown 结构（列表、代码块、数学、图片、引用、表格、链接等）
- 解析后的 Front/Back 内容，不做语义重写，交由 Obsidian 渲染引擎渲染

## 9. 错误处理与容错
- 卡片级异常（缺少 #标签、解析失败等）：跳过该卡，记录日志
- 批量范围缺失或不成对：跳过该范围解析，不影响文档其他部分
- 任意异常不影响其他卡继续解析

## 10. 可配置项（设置页）
- enableTagTrigger (默认 `true`) - 是否启用标签触发
- triggerTag (默认 `#tuanki`) - 触发解析的指定标签
- rangeStart (默认 `---start---`)
- rangeEnd (默认 `---end---`)
- cardDelimiter (默认 `---卡片---`)
- faceDelimiter (默认 `---div---`)
- clozeMarker (默认 `==高亮文本==`)
- tagPattern (默认 `#[A-Za-z0-9_\-/]+`)
- mcqCorrectMarkers (默认 `["[x]", "✓", "(正确)", "(对)", "(√)"]`)
- customTemplates (自定义模板配置)

## 11. 解析算法（伪代码概览）
1. 输入文本 → 若为批量模式：定位所有 [rangeStart, rangeEnd] → 对每个范围内用 cardDelimiter 切片
2. 对每张卡：
   - 检查触发条件：若启用标签触发且无指定触发标签：skip
   - 若含 Cloze 标记：类型=cloze；构建 Front/Back
   - 否则若含 MCQ 选项：类型=mcq；识别正确项
   - 否则：问答题：若有 `---div---` 分割，则前=Front、后=Back；否则整个内容=Front，Back=空
   - 提取 Tags 与 Deck/NoteType 映射

## 12. 示例
### 12.1 批量解析示例
```markdown
---start---

## 问题一
这是问题一的内容 #tag1
---div---
这是答案一

---卡片---

## 问题二
这是问题二的内容，没有分隔符 #tag2

---卡片---

## 选择题示例 #quiz
Java 中基本类型不包括哪一个？
- [ ] int
- [ ] boolean
- [x] string
- [ ] double
---div---
string 不是 Java 基本类型；对应引用类型为 String。

---end---
```

### 12.2 挖空题示例
```markdown
艾宾浩斯遗忘曲线提出者是 ==艾宾浩斯==。首次系统研究记忆规律的著作是 ==记忆：实验心理学的研究==。 #记忆 #cloze
```

### 12.3 无分隔符问答题示例
```markdown
什么是递归？递归是一种编程技巧，函数调用自身来解决问题。 #编程 #递归
```
（整个内容显示在正面，背面为空）

## 13. 测试用例（验收）
- 单卡无标签：不生成卡
- 单卡有标签但无 `---div---`：整个内容作为正面，背面为空
- 单卡含 `---div---`：正确切分 Front/Back
- Cloze 多个挖空：生成多张卡，Front 隐藏不同部分
- MCQ 多种选项风格：皆识别为选项；正确标注识别
- 批量范围内多卡：正确切分和解析

## 14. 与 Anki 字段映射
- Basic：Front, Back, Tags, Deck
- Basic-MCQ：Front(含选项), Back(答案/解析), Tags, Deck
- Cloze：Text(含挖空标记), Back(解析，若有), Tags, Deck, NoteType=Cloze

## 15. 兼容性与迁移
- 本方案为当前主要的卡片解析系统
- 支持多种Markdown格式的灵活解析
- 提供完整的配置选项以适应不同用户需求
